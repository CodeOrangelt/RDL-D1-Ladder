const a30_0x397844=(function(){let _0x522e7e=!![];return function(_0x1346c3,_0x3677bc){const _0x1ff25c=_0x522e7e?function(){const _0x43a204=a30_0x4ac1;if(_0x3677bc){const _0xcd4fb5=_0x3677bc[_0x43a204(0xd7)](_0x1346c3,arguments);return _0x3677bc=null,_0xcd4fb5;}}:function(){};return _0x522e7e=![],_0x1ff25c;};}()),a30_0x1550fd=a30_0x397844(this,function(){const _0x4172e9=a30_0x4ac1;let _0x17336e;try{const _0x316d08=Function(_0x4172e9(0xc5)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x17336e=_0x316d08();}catch(_0x30616d){_0x17336e=window;}const _0x38cbfd=_0x17336e[_0x4172e9(0xcc)]=_0x17336e[_0x4172e9(0xcc)]||{},_0x5ecadc=['log',_0x4172e9(0xbf),'info','error',_0x4172e9(0xbe),'table','trace'];for(let _0x3c5e5f=0x0;_0x3c5e5f<_0x5ecadc['length'];_0x3c5e5f++){const _0x23eb2a=a30_0x397844['constructor']['prototype']['bind'](a30_0x397844),_0x2852c8=_0x5ecadc[_0x3c5e5f],_0x1e1fef=_0x38cbfd[_0x2852c8]||_0x23eb2a;_0x23eb2a['__proto__']=a30_0x397844['bind'](a30_0x397844),_0x23eb2a[_0x4172e9(0xdb)]=_0x1e1fef['toString']['bind'](_0x1e1fef),_0x38cbfd[_0x2852c8]=_0x23eb2a;}});a30_0x1550fd();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';function a30_0x4856(){const _0x44b4f9=['One\x20or\x20both\x20players\x20not\x20found','exception','warn','position','checkAndRecordPromotion','totalKills','Error\x20approving\x20report:','error','return\x20(function()\x20','eloRating','doc','players','loserScore','data','all','console','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','round','username','empty','match','update','toISOString','currentUser','winnerScore','subgameType','apply','log','pow','exists','toString','totalDeaths','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','lastUpdated','toFixed'];a30_0x4856=function(){return _0x44b4f9;};return a30_0x4856();}export function calculateElo(_0x2b85f,_0x11453a,_0x1ee417=0x20){const _0x119ad9=a30_0x4ac1,_0x4da069=0x1/(0x1+Math['pow'](0xa,(_0x11453a-_0x2b85f)/0x190)),_0x3113e4=0x1/(0x1+Math[_0x119ad9(0xd9)](0xa,(_0x2b85f-_0x11453a)/0x190)),_0x5f40b3=_0x2b85f+_0x1ee417*(0x1-_0x4da069),_0x38837c=_0x11453a+_0x1ee417*(0x0-_0x3113e4);return{'newWinnerRating':Math['round'](_0x5f40b3),'newLoserRating':Math[_0x119ad9(0xce)](_0x38837c)};}export function assignDefaultEloRating(_0x4a6b07,_0x30d476){const _0x44515c=a30_0x4ac1,_0x5a4f31=0x4b0;!_0x30d476[_0x44515c(0xc6)]&&db['collection']('players')[_0x44515c(0xc7)](_0x4a6b07)['update']({'eloRating':_0x5a4f31})['then'](()=>{const _0x55aa31=_0x44515c;console[_0x55aa31(0xd8)]('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x30d476['username']);})['catch'](_0x439706=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x439706);});}export async function updateEloRatings(_0x219d8a,_0x1d2097,_0x16b768){const _0x26aaa6=a30_0x4ac1;try{const _0x2b7897=writeBatch(db),_0x202ecf=doc(db,_0x26aaa6(0xc8),_0x219d8a),_0xf7cfef=doc(db,_0x26aaa6(0xc8),_0x1d2097),[_0x5df325,_0x1c1516]=await Promise[_0x26aaa6(0xcb)]([getDoc(_0x202ecf),getDoc(_0xf7cfef)]);if(!_0x5df325['exists']()||!_0x1c1516[_0x26aaa6(0xda)]())throw new Error(_0x26aaa6(0xbd));const _0x524b20=_0x5df325['data'](),_0x23dce7=_0x1c1516['data'](),_0x3e7737=_0x524b20[_0x26aaa6(0xc0)]||Number['MAX_SAFE_INTEGER'],_0x410323=_0x23dce7['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x342629,newLoserRating:_0x2cd4cb}=calculateElo(_0x524b20['eloRating']||0x4b0,_0x23dce7['eloRating']||0x4b0);let _0x59d541=_0x3e7737,_0x377cc1=_0x410323;if(_0x3e7737>_0x410323){console[_0x26aaa6(0xd8)](_0x26aaa6(0xdd)),_0x59d541=_0x410323,_0x377cc1=_0x410323+0x1;const _0x392ca4=query(collection(db,_0x26aaa6(0xc8)),where('position','>',_0x410323),where('position','<',_0x3e7737)),_0x5c8c01=await getDocs(_0x392ca4);for(const _0x43d1d3 of _0x5c8c01['docs']){_0x43d1d3['id']!==_0x219d8a&&_0x43d1d3['id']!==_0x1d2097&&_0x2b7897[_0x26aaa6(0xd2)](doc(db,_0x26aaa6(0xc8),_0x43d1d3['id']),{'position':_0x43d1d3['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x21891e={'eloRating':_0x342629,'lastMatchDate':serverTimestamp(),'position':_0x59d541,'lastMatchId':_0x16b768},_0x6622f3={'eloRating':_0x2cd4cb,'lastMatchDate':serverTimestamp(),'position':_0x377cc1,'lastMatchId':_0x16b768};return _0x2b7897['update'](_0x202ecf,_0x21891e),_0x2b7897['update'](_0xf7cfef,_0x6622f3),await _0x2b7897['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x219d8a,'previousElo':_0x524b20['eloRating']||0x4b0,'newElo':_0x342629,'opponentId':_0x1d2097,'matchResult':'win','previousPosition':_0x3e7737,'newPosition':_0x59d541,'isPromotion':_0x59d541<_0x3e7737,'matchId':_0x16b768,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x1d2097,'previousElo':_0x23dce7[_0x26aaa6(0xc6)]||0x4b0,'newElo':_0x2cd4cb,'opponentId':_0x219d8a,'matchResult':'loss','previousPosition':_0x410323,'newPosition':_0x377cc1,'isDemotion':_0x377cc1>_0x410323,'matchId':_0x16b768,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x219d8a,_0x342629,_0x524b20['eloRating'],{'source':_0x26aaa6(0xd1),'matchId':_0x16b768}),await promotionManager[_0x26aaa6(0xc1)](_0x1d2097,_0x2cd4cb,_0x23dce7['eloRating'],{'source':'match','matchId':_0x16b768}),console['log'](_0x26aaa6(0xcd)),!![];}catch(_0x4bd7c5){console[_0x26aaa6(0xc4)]('Error\x20in\x20updateEloRatings:',_0x4bd7c5);throw _0x4bd7c5;}}function a30_0x4ac1(_0xbd8a0f,_0x2c8bec){const _0x1550fd=a30_0x4856();return a30_0x4ac1=function(_0x397844,_0x693e5e){_0x397844=_0x397844-0xbd;let _0x4856ce=_0x1550fd[_0x397844];return _0x4856ce;},a30_0x4ac1(_0xbd8a0f,_0x2c8bec);}export async function approveReport(_0x23363e,_0x258276,_0x590aa7,_0x514143,_0x576b47){const _0x4a4894=a30_0x4ac1;try{const _0x127341=doc(db,'pendingMatches',_0x23363e),_0xe092b8=await getDoc(_0x127341);if(!_0xe092b8[_0x4a4894(0xda)]())throw new Error('Report\x20not\x20found');const _0x20264c=_0xe092b8['data'](),_0x34c146={..._0x20264c,'winnerScore':_0x258276,'winnerSuicides':_0x590aa7,'winnerComment':_0x514143,'winnerDemoLink':_0x576b47,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth[_0x4a4894(0xd4)]['uid']};await setDoc(doc(db,'approvedMatches',_0x23363e),_0x34c146),await deleteDoc(_0x127341),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x219fb9,_0x1f45cd]=await Promise['all']([getDocs(query(collection(db,_0x4a4894(0xc8)),where(_0x4a4894(0xcf),'==',_0x20264c['winnerUsername']))),getDocs(query(collection(db,_0x4a4894(0xc8)),where('username','==',_0x20264c['loserUsername'])))]);if(_0x219fb9['empty']||_0x1f45cd[_0x4a4894(0xd0)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x440036=_0x219fb9['docs'][0x0]['id'],_0x59888f=_0x1f45cd['docs'][0x0]['id'];await updateEloRatings(_0x440036,_0x59888f,_0x23363e);try{await awardMatchPoints(_0x440036,_0x59888f,_0x20264c[_0x4a4894(0xd6)]);}catch(_0x2d1911){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x2d1911);}return console[_0x4a4894(0xd8)]('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x214eb4){console['error'](_0x4a4894(0xc3),_0x214eb4);throw _0x214eb4;}}async function updatePlayerElo(_0x5137d7,_0x4b1ed7,_0x1710f7){const _0x31d54d=a30_0x4ac1;await setDoc(doc(db,_0x31d54d(0xc8),_0x5137d7),{...playerData,'eloRating':_0x1710f7}),await checkAndRecordPromotion(_0x5137d7,_0x1710f7,_0x4b1ed7);}async function updatePlayerStats(_0x3319e8,_0x5f69b6,_0x2f7863){const _0x2d7b48=a30_0x4ac1,_0x30e741=doc(db,'playerStats',_0x3319e8),_0xb1fda6=await getDoc(_0x30e741);let _0x5dcab0=_0xb1fda6['exists']()?_0xb1fda6[_0x2d7b48(0xca)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x2f7863?(_0x5dcab0['wins']++,_0x5dcab0[_0x2d7b48(0xc2)]+=parseInt(_0x5f69b6[_0x2d7b48(0xd5)]||0x0),_0x5dcab0[_0x2d7b48(0xdc)]+=parseInt(_0x5f69b6['loserScore']||0x0)):(_0x5dcab0['losses']++,_0x5dcab0[_0x2d7b48(0xc2)]+=parseInt(_0x5f69b6[_0x2d7b48(0xc9)]||0x0),_0x5dcab0[_0x2d7b48(0xdc)]+=parseInt(_0x5f69b6['winnerScore']||0x0));const _0x5f2800=_0x5dcab0['wins']+_0x5dcab0['losses'];_0x5dcab0['winRate']=_0x5f2800>0x0?(_0x5dcab0['wins']/_0x5f2800*0x64)[_0x2d7b48(0xdf)](0x1):0x0,_0x5dcab0[_0x2d7b48(0xde)]=new Date()[_0x2d7b48(0xd3)](),await setDoc(_0x30e741,_0x5dcab0,{'merge':!![]});}