const a28_0xd35ed8=(function(){let _0x135d0c=!![];return function(_0x48fdf4,_0x523781){const _0x18bb59=_0x135d0c?function(){const _0xf40b1b=a28_0x5ac1;if(_0x523781){const _0x15caf1=_0x523781[_0xf40b1b(0x130)](_0x48fdf4,arguments);return _0x523781=null,_0x15caf1;}}:function(){};return _0x135d0c=![],_0x18bb59;};}()),a28_0x2c1623=a28_0xd35ed8(this,function(){const _0x5a21b9=a28_0x5ac1;let _0x251836;try{const _0x2fb767=Function(_0x5a21b9(0x128)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x251836=_0x2fb767();}catch(_0x4e2508){_0x251836=window;}const _0x48a5c2=_0x251836['console']=_0x251836['console']||{},_0x8ab802=['log','warn','info','error','exception','table','trace'];for(let _0x49d6a4=0x0;_0x49d6a4<_0x8ab802[_0x5a21b9(0x132)];_0x49d6a4++){const _0x311f4=a28_0xd35ed8['constructor']['prototype']['bind'](a28_0xd35ed8),_0x255fa3=_0x8ab802[_0x49d6a4],_0x5a7e64=_0x48a5c2[_0x255fa3]||_0x311f4;_0x311f4['__proto__']=a28_0xd35ed8[_0x5a21b9(0x120)](a28_0xd35ed8),_0x311f4['toString']=_0x5a7e64['toString'][_0x5a21b9(0x120)](_0x5a7e64),_0x48a5c2[_0x255fa3]=_0x311f4;}});a28_0x2c1623();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x55c9(){const _0x16a784=['pow','totalMatches','winRate','Awarded\x20','eloRating','winnerScore','loserUsername','round','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','userProfiles','min','match','all','loserScore','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','win','bind','data','displayName','Could\x20not\x20find\x20player\x20documents','losses','players','Match\x20moved\x20to\x20approved\x20collection','\x20match\x20(Participant)','return\x20(function()\x20','color','Error\x20in\x20updateEloRatings:','position','docs','toISOString','totalDeaths','exists','apply','Unknown\x20User','length','catch','log','totalKills','Match\x20points:\x20','pointsHistory','error'];a28_0x55c9=function(){return _0x16a784;};return a28_0x55c9();}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{RANKS,getRankStyle}from'./ranks.js';export function calculateElo(_0x268dc8,_0x27a107,_0x435939=0x20){const _0x19aac3=a28_0x5ac1;_0x268dc8=_0x268dc8>0x3e8?0xc8:_0x268dc8,_0x27a107=_0x27a107>0x3e8?0xc8:_0x27a107;const _0x1ce291=0x1/(0x1+Math['pow'](0xa,(_0x27a107-_0x268dc8)/0x190)),_0x5e347d=0x1/(0x1+Math[_0x19aac3(0x110)](0xa,(_0x268dc8-_0x27a107)/0x190)),_0x1eec97=_0x268dc8+_0x435939*(0x1-_0x1ce291),_0x16bd93=_0x27a107+_0x435939*(0x0-_0x5e347d);return{'newWinnerRating':Math[_0x19aac3(0x117)](Math[_0x19aac3(0x11a)](_0x1eec97)),'newLoserRating':Math['round'](Math['max'](_0x16bd93,0x0))};}export function assignDefaultEloRating(_0x280959,_0x364b43){const _0xa8791c=a28_0x5ac1,_0x187809=0xc8;!_0x364b43['eloRating']&&db['collection']('players')['doc'](_0x280959)['update']({'eloRating':_0x187809})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x364b43['username']);})[_0xa8791c(0x133)](_0x360352=>{const _0x1dd0e0=_0xa8791c;console[_0x1dd0e0(0x138)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x360352);});}export async function updateEloRatings(_0x54e1ec,_0x25cd54,_0x309b16){const _0x12d300=a28_0x5ac1;try{const _0x145e24=writeBatch(db),_0x20b6fa=doc(db,'players',_0x54e1ec),_0x5ea98b=doc(db,'players',_0x25cd54),[_0x3da910,_0x444892]=await Promise[_0x12d300(0x11c)]([getDoc(_0x20b6fa),getDoc(_0x5ea98b)]);if(!_0x3da910['exists']()||!_0x444892['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x4ec9ac=_0x3da910['data'](),_0x54d1c3=_0x444892['data'](),_0x27ccf9=_0x4ec9ac[_0x12d300(0x12b)]||Number['MAX_SAFE_INTEGER'],_0x17bb20=_0x54d1c3['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x586c7e,newLoserRating:_0x32d2c5}=calculateElo(_0x4ec9ac[_0x12d300(0x114)]||0x4b0,_0x54d1c3[_0x12d300(0x114)]||0x4b0);let _0x4b7268=_0x27ccf9,_0x408529=_0x17bb20;if(_0x27ccf9>_0x17bb20){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4b7268=_0x17bb20,_0x408529=_0x17bb20+0x1;const _0x16a2ce=query(collection(db,_0x12d300(0x125)),where(_0x12d300(0x12b),'>',_0x17bb20),where(_0x12d300(0x12b),'<',_0x27ccf9)),_0x39ac9d=await getDocs(_0x16a2ce);for(const _0x2a0d34 of _0x39ac9d[_0x12d300(0x12c)]){_0x2a0d34['id']!==_0x54e1ec&&_0x2a0d34['id']!==_0x25cd54&&_0x145e24['update'](doc(db,'players',_0x2a0d34['id']),{'position':_0x2a0d34[_0x12d300(0x121)]()['position']+0x1});}}else console['log'](_0x12d300(0x118));const _0x4f4e4b={'eloRating':_0x586c7e,'lastMatchDate':serverTimestamp(),'position':_0x4b7268,'lastMatchId':_0x309b16},_0x2590e8={'eloRating':_0x32d2c5,'lastMatchDate':serverTimestamp(),'position':_0x408529,'lastMatchId':_0x309b16};return _0x145e24['update'](_0x20b6fa,_0x4f4e4b),_0x145e24['update'](_0x5ea98b,_0x2590e8),await _0x145e24['commit'](),console[_0x12d300(0x134)]('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x54e1ec,'previousElo':_0x4ec9ac['eloRating']||0x4b0,'newElo':_0x586c7e,'opponentId':_0x25cd54,'matchResult':_0x12d300(0x11f),'previousPosition':_0x27ccf9,'newPosition':_0x4b7268,'isPromotion':_0x4b7268<_0x27ccf9,'matchId':_0x309b16,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x25cd54,'previousElo':_0x54d1c3[_0x12d300(0x114)]||0x4b0,'newElo':_0x32d2c5,'opponentId':_0x54e1ec,'matchResult':'loss','previousPosition':_0x17bb20,'newPosition':_0x408529,'isDemotion':_0x408529>_0x17bb20,'matchId':_0x309b16,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x54e1ec,_0x586c7e,_0x4ec9ac[_0x12d300(0x114)],{'source':_0x12d300(0x11b),'matchId':_0x309b16}),await promotionManager['checkAndRecordPromotion'](_0x25cd54,_0x32d2c5,_0x54d1c3['eloRating'],{'source':_0x12d300(0x11b),'matchId':_0x309b16}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x3f1c2b){console['error'](_0x12d300(0x12a),_0x3f1c2b);throw _0x3f1c2b;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x4367b8,_0x3ab361,_0x3adc21,_0x1095e4,_0x4e1839){const _0x194726=a28_0x5ac1;try{const _0x513450=doc(db,'pendingMatches',_0x4367b8),_0x1154c2=await getDoc(_0x513450);if(!_0x1154c2['exists']())throw new Error('Report\x20not\x20found');const _0x4dd7b4=_0x1154c2['data'](),_0x538ca4={..._0x4dd7b4,'winnerScore':_0x3ab361,'winnerSuicides':_0x3adc21,'winnerComment':_0x1095e4,'winnerDemoLink':_0x4e1839,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x4367b8),_0x538ca4),await deleteDoc(_0x513450),console['log'](_0x194726(0x126));const [_0x3e4d7f,_0x17d892]=await Promise[_0x194726(0x11c)]([getDocs(query(collection(db,_0x194726(0x125)),where('username','==',_0x4dd7b4['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x4dd7b4[_0x194726(0x116)])))]);if(_0x3e4d7f['empty']||_0x17d892['empty'])throw new Error(_0x194726(0x123));const _0x24052c=_0x3e4d7f['docs'][0x0]['id'],_0x1f4461=_0x17d892['docs'][0x0]['id'];await updateEloRatings(_0x24052c,_0x1f4461,_0x4367b8);try{const _0x4b4f5d=_0x4dd7b4['subgameType']||'Standard',_0x312cb8=POINTS_CHART[_0x4b4f5d]||0xa,_0x5cf97f=doc(db,'userProfiles',_0x24052c),_0x30b425=doc(db,_0x194726(0x119),_0x1f4461),[_0x2d657c,_0x31fa41]=await Promise[_0x194726(0x11c)]([getDoc(_0x5cf97f),getDoc(_0x30b425)]);if(_0x2d657c[_0x194726(0x12f)]()&&_0x31fa41['exists']()){const _0x4f0764=_0x2d657c['data'](),_0x419ed5=_0x31fa41['data'](),_0x2e6a83=_0x4f0764['points']||0x0,_0x4d9aa2=_0x419ed5['points']||0x0,_0x5c8949=_0x2e6a83+_0x312cb8,_0x1fbaa1=_0x4d9aa2+_0x312cb8;await Promise['all']([updateDoc(_0x5cf97f,{'points':_0x5c8949,'lastPointsModified':serverTimestamp()}),updateDoc(_0x30b425,{'points':_0x1fbaa1,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,_0x194726(0x137)),{'userId':_0x24052c,'userEmail':_0x4f0764['email']||'unknown','displayName':_0x4f0764[_0x194726(0x122)]||_0x4f0764['username']||'Unknown\x20User','action':'add','amount':_0x312cb8,'previousPoints':_0x2e6a83,'newPoints':_0x5c8949,'reason':'Match\x20points:\x20'+_0x4b4f5d+'\x20match\x20(Winner)','adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x1f4461,'userEmail':_0x419ed5['email']||'unknown','displayName':_0x419ed5[_0x194726(0x122)]||_0x419ed5['username']||_0x194726(0x131),'action':'add','amount':_0x312cb8,'previousPoints':_0x4d9aa2,'newPoints':_0x1fbaa1,'reason':_0x194726(0x136)+_0x4b4f5d+_0x194726(0x127),'adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console[_0x194726(0x134)](_0x194726(0x113)+_0x312cb8+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x4b4f5d+'\x20match');}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x176f67){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x176f67);}return console['log'](_0x194726(0x11e)),!![];}catch(_0x2b6e68){console[_0x194726(0x138)]('Error\x20approving\x20report:',_0x2b6e68);throw _0x2b6e68;}}async function updatePlayerElo(_0x69e5d1,_0x10a4ad,_0x3c288f){const _0x46b0c2=a28_0x5ac1,_0x2bbd65=doc(db,_0x46b0c2(0x125),_0x69e5d1),_0x37ded7=await getDoc(_0x2bbd65),_0x46c001=_0x37ded7['data'](),_0x474eb7=doc(db,'playerStats',_0x69e5d1),_0x16a95b=await getDoc(_0x474eb7),_0x21e812=_0x16a95b[_0x46b0c2(0x121)]()||{'totalMatches':0x0,'winRate':0x0},_0x28bae4=getRankStyle(_0x3c288f,_0x21e812[_0x46b0c2(0x111)],_0x21e812[_0x46b0c2(0x112)]);await updateDoc(_0x2bbd65,{'eloRating':_0x3c288f,'rank':_0x28bae4['name'],'rankColor':_0x28bae4[_0x46b0c2(0x129)]}),await checkAndRecordPromotion(_0x69e5d1,_0x3c288f,_0x10a4ad,{'matchCount':_0x21e812[_0x46b0c2(0x111)],'winRate':_0x21e812['winRate']});}function a28_0x5ac1(_0x4bc52b,_0x293237){const _0x2c1623=a28_0x55c9();return a28_0x5ac1=function(_0xd35ed8,_0xafaffc){_0xd35ed8=_0xd35ed8-0x110;let _0x55c94f=_0x2c1623[_0xd35ed8];return _0x55c94f;},a28_0x5ac1(_0x4bc52b,_0x293237);}async function updatePlayerStats(_0x58aab5,_0x12312b,_0x44daa4){const _0x4d7236=a28_0x5ac1,_0x2ae370=doc(db,'playerStats',_0x58aab5),_0x5cb285=await getDoc(_0x2ae370);let _0x5222be=_0x5cb285['exists']()?_0x5cb285['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x44daa4?(_0x5222be['wins']++,_0x5222be[_0x4d7236(0x135)]+=parseInt(_0x12312b['winnerScore']||0x0),_0x5222be['totalDeaths']+=parseInt(_0x12312b['loserScore']||0x0)):(_0x5222be[_0x4d7236(0x124)]++,_0x5222be[_0x4d7236(0x135)]+=parseInt(_0x12312b[_0x4d7236(0x11d)]||0x0),_0x5222be[_0x4d7236(0x12e)]+=parseInt(_0x12312b[_0x4d7236(0x115)]||0x0));const _0x479a60=_0x5222be['wins']+_0x5222be['losses'];_0x5222be[_0x4d7236(0x112)]=_0x479a60>0x0?(_0x5222be['wins']/_0x479a60*0x64)['toFixed'](0x1):0x0,_0x5222be['lastUpdated']=new Date()[_0x4d7236(0x12d)](),await setDoc(_0x2ae370,_0x5222be,{'merge':!![]});}