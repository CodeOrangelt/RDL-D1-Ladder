const a30_0x2155a1=(function(){let _0x5a89de=!![];return function(_0x897a72,_0x1e161d){const _0x57393b=_0x5a89de?function(){const _0x5b74c3=a30_0x5751;if(_0x1e161d){const _0x477b9b=_0x1e161d[_0x5b74c3(0xbf)](_0x897a72,arguments);return _0x1e161d=null,_0x477b9b;}}:function(){};return _0x5a89de=![],_0x57393b;};}()),a30_0x2d168f=a30_0x2155a1(this,function(){const _0x31a869=a30_0x5751;let _0x32f4e9;try{const _0x443049=Function(_0x31a869(0x96)+_0x31a869(0xa4)+');');_0x32f4e9=_0x443049();}catch(_0xb46f3){_0x32f4e9=window;}const _0x3f8ad4=_0x32f4e9['console']=_0x32f4e9['console']||{},_0x4927a3=['log','warn','info','error','exception',_0x31a869(0xa3),'trace'];for(let _0x1c2785=0x0;_0x1c2785<_0x4927a3[_0x31a869(0xa6)];_0x1c2785++){const _0x3fea0e=a30_0x2155a1['constructor'][_0x31a869(0xa9)]['bind'](a30_0x2155a1),_0x1cb9fa=_0x4927a3[_0x1c2785],_0x53cc92=_0x3f8ad4[_0x1cb9fa]||_0x3fea0e;_0x3fea0e['__proto__']=a30_0x2155a1['bind'](a30_0x2155a1),_0x3fea0e['toString']=_0x53cc92['toString']['bind'](_0x53cc92),_0x3f8ad4[_0x1cb9fa]=_0x3fea0e;}});function a30_0x5751(_0x5987cd,_0x2b1ad7){const _0x2d168f=a30_0x4e5b();return a30_0x5751=function(_0x2155a1,_0xa7a8b8){_0x2155a1=_0x2155a1-0x96;let _0x4e5b88=_0x2d168f[_0x2155a1];return _0x4e5b88;},a30_0x5751(_0x5987cd,_0x2b1ad7);}a30_0x2d168f();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0xb10944,_0x1b6e42,_0x3c99aa=0x20){const _0x16dbd1=a30_0x5751,_0x1804fc=0x1/(0x1+Math['pow'](0xa,(_0x1b6e42-_0xb10944)/0x190)),_0x4ef1e0=0x1/(0x1+Math['pow'](0xa,(_0xb10944-_0x1b6e42)/0x190)),_0x3ff0d3=_0xb10944+_0x3c99aa*(0x1-_0x1804fc),_0x3d9c19=_0x1b6e42+_0x3c99aa*(0x0-_0x4ef1e0);return{'newWinnerRating':Math['round'](_0x3ff0d3),'newLoserRating':Math[_0x16dbd1(0xa7)](_0x3d9c19)};}export function assignDefaultEloRating(_0x14ebfb,_0x5bcecf){const _0x497758=a30_0x5751,_0x1fcde5=0x4b0;!_0x5bcecf['eloRating']&&db[_0x497758(0xc0)]('players')['doc'](_0x14ebfb)['update']({'eloRating':_0x1fcde5})[_0x497758(0xc1)](()=>{const _0x2931fb=_0x497758;console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x5bcecf[_0x2931fb(0x9d)]);})[_0x497758(0xb5)](_0x7b913d=>{const _0x3f28b0=_0x497758;console[_0x3f28b0(0xab)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x7b913d);});}export async function updateEloRatings(_0x1e6998,_0xab7e29,_0x5b0d90){const _0x206e41=a30_0x5751;try{const _0x50496e=writeBatch(db),_0x113e82=doc(db,_0x206e41(0xb7),_0x1e6998),_0x24436b=doc(db,_0x206e41(0xb7),_0xab7e29),[_0x624473,_0x4710b1]=await Promise[_0x206e41(0xbb)]([getDoc(_0x113e82),getDoc(_0x24436b)]);if(!_0x624473[_0x206e41(0xaa)]()||!_0x4710b1[_0x206e41(0xaa)]())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0xce8eaa=_0x624473[_0x206e41(0xaf)](),_0x37c9ce=_0x4710b1['data'](),_0x4bfea7=_0xce8eaa['position']||Number['MAX_SAFE_INTEGER'],_0x4641e9=_0x37c9ce['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x2a933e,newLoserRating:_0x2e919a}=calculateElo(_0xce8eaa['eloRating']||0x4b0,_0x37c9ce['eloRating']||0x4b0);let _0x5d82d5=_0x4bfea7,_0x5b5be0=_0x4641e9;if(_0x4bfea7>_0x4641e9){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x5d82d5=_0x4641e9,_0x5b5be0=_0x4641e9+0x1;const _0x12855d=query(collection(db,_0x206e41(0xb7)),where('position','>',_0x4641e9),where(_0x206e41(0xb3),'<',_0x4bfea7)),_0x2626cb=await getDocs(_0x12855d);for(const _0x17117f of _0x2626cb[_0x206e41(0xa8)]){_0x17117f['id']!==_0x1e6998&&_0x17117f['id']!==_0xab7e29&&_0x50496e['update'](doc(db,_0x206e41(0xb7),_0x17117f['id']),{'position':_0x17117f['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x273aa2={'eloRating':_0x2a933e,'lastMatchDate':serverTimestamp(),'position':_0x5d82d5,'lastMatchId':_0x5b0d90},_0x1f41ce={'eloRating':_0x2e919a,'lastMatchDate':serverTimestamp(),'position':_0x5b5be0,'lastMatchId':_0x5b0d90};return _0x50496e[_0x206e41(0xae)](_0x113e82,_0x273aa2),_0x50496e[_0x206e41(0xae)](_0x24436b,_0x1f41ce),await _0x50496e[_0x206e41(0xa0)](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x1e6998,'previousElo':_0xce8eaa[_0x206e41(0x9c)]||0x4b0,'newElo':_0x2a933e,'opponentId':_0xab7e29,'matchResult':_0x206e41(0x98),'previousPosition':_0x4bfea7,'newPosition':_0x5d82d5,'isPromotion':_0x5d82d5<_0x4bfea7,'matchId':_0x5b0d90,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0xab7e29,'previousElo':_0x37c9ce['eloRating']||0x4b0,'newElo':_0x2e919a,'opponentId':_0x1e6998,'matchResult':'loss','previousPosition':_0x4641e9,'newPosition':_0x5b5be0,'isDemotion':_0x5b5be0>_0x4641e9,'matchId':_0x5b0d90,'timestamp':serverTimestamp()})]),await promotionManager[_0x206e41(0xbd)](_0x1e6998,_0x2a933e,_0xce8eaa[_0x206e41(0x9c)],{'source':_0x206e41(0x9e),'matchId':_0x5b0d90}),await promotionManager[_0x206e41(0xbd)](_0xab7e29,_0x2e919a,_0x37c9ce['eloRating'],{'source':'match','matchId':_0x5b0d90}),console['log'](_0x206e41(0x9a)),!![];}catch(_0x7143bc){console['error'](_0x206e41(0xa2),_0x7143bc);throw _0x7143bc;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x31d665,_0x4e9d44,_0x4b4424,_0x3ce9e3,_0x529bb0){const _0x378050=a30_0x5751;try{const _0x5575b5=doc(db,_0x378050(0xb6),_0x31d665),_0x96d799=await getDoc(_0x5575b5);if(!_0x96d799['exists']())throw new Error('Report\x20not\x20found');const _0x39a36a=_0x96d799['data'](),_0x569ab3={..._0x39a36a,'winnerScore':_0x4e9d44,'winnerSuicides':_0x4b4424,'winnerComment':_0x3ce9e3,'winnerDemoLink':_0x529bb0,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth[_0x378050(0x9b)][_0x378050(0xc2)]};await setDoc(doc(db,_0x378050(0xbe),_0x31d665),_0x569ab3),await deleteDoc(_0x5575b5),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x3a3479,_0x380f86]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x39a36a['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x39a36a['loserUsername'])))]);if(_0x3a3479['empty']||_0x380f86[_0x378050(0xb2)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x234cb3=_0x3a3479['docs'][0x0]['id'],_0x5d000d=_0x380f86['docs'][0x0]['id'];await updateEloRatings(_0x234cb3,_0x5d000d,_0x31d665);try{await awardMatchPoints(_0x234cb3,_0x5d000d,_0x39a36a['subgameType']);const _0x39df96=_0x39a36a['subgameType']||'Standard',_0x42531e=POINTS_CHART[_0x39df96]||0xa,_0x363a65=doc(db,'userProfiles',_0x234cb3),_0x49d69c=doc(db,'userProfiles',_0x5d000d),[_0x43d8b6,_0x162931]=await Promise[_0x378050(0xbb)]([getDoc(_0x363a65),getDoc(_0x49d69c)]);if(_0x43d8b6['exists']()&&_0x162931['exists']()){const _0x1967c0=_0x43d8b6['data'](),_0x29b1c4=_0x162931['data'](),_0x5d2926=_0x1967c0[_0x378050(0xbc)]||0x0,_0xb650d2=_0x29b1c4[_0x378050(0xbc)]||0x0,_0x39d57b=_0x5d2926+_0x42531e,_0x1fa836=_0xb650d2+_0x42531e;await Promise['all']([updateDoc(_0x363a65,{'points':_0x39d57b,'lastPointsModified':serverTimestamp()}),updateDoc(_0x49d69c,{'points':_0x1fa836,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,_0x378050(0xb4)),{'userId':_0x234cb3,'userEmail':_0x1967c0['email']||'unknown','displayName':_0x1967c0[_0x378050(0xa5)]||_0x1967c0['username']||_0x378050(0xad),'action':_0x378050(0xb0),'amount':_0x42531e,'previousPoints':_0x5d2926,'newPoints':_0x39d57b,'reason':'Match\x20points:\x20'+_0x39df96+'\x20match\x20(Winner)','adminEmail':_0x378050(0xac),'timestamp':serverTimestamp()}),addDoc(collection(db,_0x378050(0xb4)),{'userId':_0x5d000d,'userEmail':_0x29b1c4[_0x378050(0xb1)]||_0x378050(0xba),'displayName':_0x29b1c4['displayName']||_0x29b1c4['username']||'Unknown\x20User','action':_0x378050(0xb0),'amount':_0x42531e,'previousPoints':_0xb650d2,'newPoints':_0x1fa836,'reason':'Match\x20points:\x20'+_0x39df96+'\x20match\x20(Participant)','adminEmail':_0x378050(0xac),'timestamp':serverTimestamp()})]),console[_0x378050(0x97)]('Awarded\x20'+_0x42531e+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x39df96+'\x20match');}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x4c2855){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x4c2855);}return console[_0x378050(0x97)](_0x378050(0xa1)),!![];}catch(_0x3f6814){console['error']('Error\x20approving\x20report:',_0x3f6814);throw _0x3f6814;}}async function updatePlayerElo(_0x1d8355,_0x46a1b3,_0x36c070){const _0x1485f1=a30_0x5751;await setDoc(doc(db,_0x1485f1(0xb7),_0x1d8355),{...playerData,'eloRating':_0x36c070}),await checkAndRecordPromotion(_0x1d8355,_0x36c070,_0x46a1b3);}function a30_0x4e5b(){const _0x439788=['return\x20(function()\x20','log','win','totalDeaths','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','currentUser','eloRating','username','match','playerStats','commit','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','Error\x20in\x20updateEloRatings:','table','{}.constructor(\x22return\x20this\x22)(\x20)','displayName','length','round','docs','prototype','exists','error','system-match-award','Unknown\x20User','update','data','add','email','empty','position','pointsHistory','catch','pendingMatches','players','totalKills','wins','unknown','all','points','checkAndRecordPromotion','approvedMatches','apply','collection','then','uid'];a30_0x4e5b=function(){return _0x439788;};return a30_0x4e5b();}async function updatePlayerStats(_0x34ef2f,_0x340edc,_0x414f1b){const _0x5ab59b=a30_0x5751,_0x423a31=doc(db,_0x5ab59b(0x9f),_0x34ef2f),_0x2777e1=await getDoc(_0x423a31);let _0x4558ab=_0x2777e1['exists']()?_0x2777e1['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x414f1b?(_0x4558ab['wins']++,_0x4558ab['totalKills']+=parseInt(_0x340edc['winnerScore']||0x0),_0x4558ab[_0x5ab59b(0x99)]+=parseInt(_0x340edc['loserScore']||0x0)):(_0x4558ab['losses']++,_0x4558ab[_0x5ab59b(0xb8)]+=parseInt(_0x340edc['loserScore']||0x0),_0x4558ab['totalDeaths']+=parseInt(_0x340edc['winnerScore']||0x0));const _0x418de7=_0x4558ab[_0x5ab59b(0xb9)]+_0x4558ab['losses'];_0x4558ab['winRate']=_0x418de7>0x0?(_0x4558ab[_0x5ab59b(0xb9)]/_0x418de7*0x64)['toFixed'](0x1):0x0,_0x4558ab['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x423a31,_0x4558ab,{'merge':!![]});}