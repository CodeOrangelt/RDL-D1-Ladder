const a26_0x3b72ca=(function(){let _0x1cbe79=!![];return function(_0x14e764,_0x477b2b){const _0x36fddb=_0x1cbe79?function(){const _0x2cdc9e=a26_0x2f0c;if(_0x477b2b){const _0x2af1ea=_0x477b2b[_0x2cdc9e(0x1f6)](_0x14e764,arguments);return _0x477b2b=null,_0x2af1ea;}}:function(){};return _0x1cbe79=![],_0x36fddb;};}()),a26_0x5d846e=a26_0x3b72ca(this,function(){const _0x4cdf6c=a26_0x2f0c;let _0x1c955b;try{const _0x35ea9f=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x1c955b=_0x35ea9f();}catch(_0x2536a8){_0x1c955b=window;}const _0x48cc92=_0x1c955b[_0x4cdf6c(0x1f8)]=_0x1c955b['console']||{},_0x40f718=['log',_0x4cdf6c(0x20a),'info','error',_0x4cdf6c(0x1fb),_0x4cdf6c(0x1fe),_0x4cdf6c(0x203)];for(let _0x410f18=0x0;_0x410f18<_0x40f718[_0x4cdf6c(0x1f5)];_0x410f18++){const _0x2a4bf3=a26_0x3b72ca['constructor']['prototype'][_0x4cdf6c(0x1fd)](a26_0x3b72ca),_0x9143fa=_0x40f718[_0x410f18],_0x1df4c0=_0x48cc92[_0x9143fa]||_0x2a4bf3;_0x2a4bf3['__proto__']=a26_0x3b72ca['bind'](a26_0x3b72ca),_0x2a4bf3['toString']=_0x1df4c0[_0x4cdf6c(0x1f7)]['bind'](_0x1df4c0),_0x48cc92[_0x9143fa]=_0x2a4bf3;}});a26_0x5d846e();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x23c0ce from'./firebase-idle-wrapper.js';function a26_0x2f0c(_0x4d9ba3,_0x4ff450){const _0x5d846e=a26_0x3b7c();return a26_0x2f0c=function(_0x3b72ca,_0xcf01a3){_0x3b72ca=_0x3b72ca-0x1f2;let _0x3b7c3b=_0x5d846e[_0x3b72ca];return _0x3b7c3b;},a26_0x2f0c(_0x4d9ba3,_0x4ff450);}export function calculateEloD2(_0x363fe2,_0x100683,_0x3893fe=0x20){const _0x4df65d=a26_0x2f0c,_0x357eee=0x1/(0x1+Math['pow'](0xa,(_0x100683-_0x363fe2)/0x190)),_0x45ff82=0x1/(0x1+Math['pow'](0xa,(_0x363fe2-_0x100683)/0x190)),_0x389bdb=_0x363fe2+_0x3893fe*(0x1-_0x357eee),_0x1271ab=_0x100683+_0x3893fe*(0x0-_0x45ff82);return{'newWinnerRating':Math[_0x4df65d(0x1f9)](_0x389bdb),'newLoserRating':Math['round'](_0x1271ab)};}function a26_0x3b7c(){const _0x41a037=['loss','data','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','length','apply','toString','console','round','empty','exception','log','bind','table','Current\x20user:','eloRating','username','all','trace','Current\x20username:','currentUser','exists','checkAndRecordPromotion','email','error','warn','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','playersD2','createdAt','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','position','D2\x20match\x20report\x20not\x20found'];a26_0x3b7c=function(){return _0x41a037;};return a26_0x3b7c();}export async function updateEloRatingsD2(_0x25d022,_0x50d134,_0x24f9f2){const _0x3c8c97=a26_0x2f0c;try{const _0x1f645d=writeBatch(db),_0x263da0=doc(db,'playersD2',_0x25d022),_0x565130=doc(db,_0x3c8c97(0x20c),_0x50d134),[_0x2dfcd8,_0x30d336]=await Promise[_0x3c8c97(0x202)]([getDoc(_0x263da0),getDoc(_0x565130)]);if(!_0x2dfcd8['exists']()||!_0x30d336[_0x3c8c97(0x206)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x4bcd9d=_0x2dfcd8['data'](),_0x5ac0a5=_0x30d336['data'](),_0xd7dc6=_0x4bcd9d['position']||Number['MAX_SAFE_INTEGER'],_0x260980=_0x5ac0a5[_0x3c8c97(0x20f)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x2e69e0,newLoserRating:_0x1c9f19}=calculateEloD2(_0x4bcd9d['eloRating']||0x4b0,_0x5ac0a5['eloRating']||0x4b0);let _0x19c5c8=_0xd7dc6,_0x26a0c1=_0x260980;if(_0xd7dc6>_0x260980){console[_0x3c8c97(0x1fc)](_0x3c8c97(0x1f4)),_0x19c5c8=_0x260980,_0x26a0c1=_0x260980+0x1;const _0x30133b=query(collection(db,'playersD2'),where('position','>',_0x260980),where(_0x3c8c97(0x20f),'<',_0xd7dc6)),_0x32f151=await getDocs(_0x30133b);for(const _0x3e59ce of _0x32f151['docs']){_0x3e59ce['id']!==_0x25d022&&_0x3e59ce['id']!==_0x50d134&&_0x1f645d['update'](doc(db,'playersD2',_0x3e59ce['id']),{'position':_0x3e59ce[_0x3c8c97(0x1f3)]()[_0x3c8c97(0x20f)]+0x1});}}else console[_0x3c8c97(0x1fc)](_0x3c8c97(0x20b));return _0x1f645d['update'](_0x263da0,{'eloRating':_0x2e69e0,'lastMatchDate':serverTimestamp(),'position':_0x19c5c8,'lastMatchId':_0x24f9f2}),_0x1f645d['update'](_0x565130,{'eloRating':_0x1c9f19,'lastMatchDate':serverTimestamp(),'position':_0x26a0c1,'lastMatchId':_0x24f9f2}),await _0x1f645d['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x25d022,'previousElo':_0x4bcd9d[_0x3c8c97(0x200)]||0x4b0,'newElo':_0x2e69e0,'opponentId':_0x50d134,'matchResult':'win','previousPosition':_0xd7dc6,'newPosition':_0x19c5c8,'isPromotion':_0x19c5c8<_0xd7dc6,'matchId':_0x24f9f2,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x50d134,'previousElo':_0x5ac0a5[_0x3c8c97(0x200)]||0x4b0,'newElo':_0x1c9f19,'opponentId':_0x25d022,'matchResult':_0x3c8c97(0x1f2),'previousPosition':_0x260980,'newPosition':_0x26a0c1,'isDemotion':_0x26a0c1>_0x260980,'matchId':_0x24f9f2,'timestamp':serverTimestamp()})]),await promotionManager[_0x3c8c97(0x207)](_0x25d022,_0x2e69e0,_0x4bcd9d[_0x3c8c97(0x200)],{'source':'match-d2','matchId':_0x24f9f2}),await promotionManager['checkAndRecordPromotion'](_0x50d134,_0x1c9f19,_0x5ac0a5['eloRating'],{'source':'match-d2','matchId':_0x24f9f2}),!![];}catch(_0x113188){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x113188);throw _0x113188;}}export async function approveReportD2(_0x9ecf07,_0x3f55cb,_0x1e03a4,_0x8f3569){const _0x43e83e=a26_0x2f0c;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x9ecf07,'winnerScore':_0x3f55cb,'winnerSuicides':_0x1e03a4,'winnerComment':_0x8f3569});const _0x5bbf70=auth[_0x43e83e(0x205)];if(!_0x5bbf70){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log'](_0x43e83e(0x1ff),_0x5bbf70[_0x43e83e(0x208)]);const _0xcc2769=await getDoc(doc(db,_0x43e83e(0x20c),_0x5bbf70['uid'])),_0x53f4f8=_0xcc2769['exists']()?_0xcc2769['data']()[_0x43e83e(0x201)]:null;console['log'](_0x43e83e(0x204),_0x53f4f8);const _0x35b663=doc(db,'pendingMatchesD2',_0x9ecf07),_0xcea314=await getDoc(_0x35b663);if(!_0xcea314['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x9ecf07);throw new Error(_0x43e83e(0x210));}const _0x2b3b0d=_0xcea314['data']();console['log']('D2\x20Report\x20data:',_0x2b3b0d);if(_0x53f4f8!==_0x2b3b0d['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x1c6c14={..._0x2b3b0d,'winnerScore':_0x3f55cb,'winnerSuicides':_0x1e03a4,'winnerComment':_0x8f3569,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x53f4f8,'createdAt':_0x2b3b0d[_0x43e83e(0x20d)]||serverTimestamp(),'winnerUsername':_0x2b3b0d['winnerUsername'],'loserUsername':_0x2b3b0d['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x9ecf07),_0x1c6c14),await deleteDoc(_0x35b663),console[_0x43e83e(0x1fc)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x5284dc,_0x44aa27]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x2b3b0d['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x2b3b0d['loserUsername'])))]);if(_0x5284dc['empty']||_0x44aa27[_0x43e83e(0x1fa)])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x101847=_0x5284dc['docs'][0x0]['id'],_0x4bfc8d=_0x44aa27['docs'][0x0]['id'];return await updateEloRatingsD2(_0x101847,_0x4bfc8d,_0x9ecf07),console[_0x43e83e(0x1fc)](_0x43e83e(0x20e)),!![];}catch(_0x23f29a){console[_0x43e83e(0x209)]('Error\x20in\x20approveReportD2:',_0x23f29a);throw _0x23f29a;}}