const a28_0x221548=(function(){let _0xf5f5e2=!![];return function(_0x4473e6,_0x311a91){const _0x2e26f1=_0xf5f5e2?function(){if(_0x311a91){const _0x3ff8ea=_0x311a91['apply'](_0x4473e6,arguments);return _0x311a91=null,_0x3ff8ea;}}:function(){};return _0xf5f5e2=![],_0x2e26f1;};}()),a28_0x39b75a=a28_0x221548(this,function(){const _0x13c09d=a28_0x2908,_0x579e93=function(){let _0x3bc447;try{_0x3bc447=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x2dc5d4){_0x3bc447=window;}return _0x3bc447;},_0x305ed0=_0x579e93(),_0x2e48c7=_0x305ed0['console']=_0x305ed0['console']||{},_0x170d32=[_0x13c09d(0xf5),'warn','info',_0x13c09d(0x100),_0x13c09d(0x102),'table',_0x13c09d(0xf8)];for(let _0x392ef0=0x0;_0x392ef0<_0x170d32[_0x13c09d(0xf7)];_0x392ef0++){const _0x5a61ac=a28_0x221548['constructor']['prototype']['bind'](a28_0x221548),_0x13a959=_0x170d32[_0x392ef0],_0x2e75cd=_0x2e48c7[_0x13a959]||_0x5a61ac;_0x5a61ac['__proto__']=a28_0x221548['bind'](a28_0x221548),_0x5a61ac['toString']=_0x2e75cd['toString']['bind'](_0x2e75cd),_0x2e48c7[_0x13a959]=_0x5a61ac;}});a28_0x39b75a();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x113601 from'./firebase-idle-wrapper.js';function a28_0x2908(_0x4186a5,_0x2018fd){const _0x39b75a=a28_0x48aa();return a28_0x2908=function(_0x221548,_0x4c1e65){_0x221548=_0x221548-0xf3;let _0x48aa98=_0x39b75a[_0x221548];return _0x48aa98;},a28_0x2908(_0x4186a5,_0x2018fd);}function a28_0x48aa(){const _0x5c9841=['position','winnerUsername','log','eloRating','length','trace','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','update','empty','loserUsername','MAX_SAFE_INTEGER','approvedMatchesD2','playersD2','error','data','exception','email','pow'];a28_0x48aa=function(){return _0x5c9841;};return a28_0x48aa();}export function calculateEloD2(_0x4f3d67,_0x7eda89,_0x1cadf1=0x20){const _0x2d5650=a28_0x2908,_0x32a948=0x1/(0x1+Math[_0x2d5650(0x104)](0xa,(_0x7eda89-_0x4f3d67)/0x190)),_0x1bb775=0x1/(0x1+Math['pow'](0xa,(_0x4f3d67-_0x7eda89)/0x190)),_0x3f06db=_0x4f3d67+_0x1cadf1*(0x1-_0x32a948),_0x8c39d6=_0x7eda89+_0x1cadf1*(0x0-_0x1bb775);return{'newWinnerRating':Math['round'](_0x3f06db),'newLoserRating':Math['round'](_0x8c39d6)};}export async function updateEloRatingsD2(_0x32d858,_0x3d322a,_0x6173ee){const _0x252d3f=a28_0x2908;try{const _0x1f27ca=writeBatch(db),_0x19a654=doc(db,'playersD2',_0x32d858),_0xb38546=doc(db,'playersD2',_0x3d322a),[_0x27ca86,_0x16d86d]=await Promise['all']([getDoc(_0x19a654),getDoc(_0xb38546)]);if(!_0x27ca86['exists']()||!_0x16d86d['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x1172a7=_0x27ca86['data'](),_0x5e1980=_0x16d86d['data'](),_0x4e9126=_0x1172a7[_0x252d3f(0xf3)]||Number[_0x252d3f(0xfd)],_0x2a4b8e=_0x5e1980['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x247717,newLoserRating:_0x22b4c7}=calculateEloD2(_0x1172a7['eloRating']||0x4b0,_0x5e1980[_0x252d3f(0xf6)]||0x4b0);let _0x579f0a=_0x4e9126,_0x7a1ac5=_0x2a4b8e;if(_0x4e9126>_0x2a4b8e){console['log'](_0x252d3f(0xf9)),_0x579f0a=_0x2a4b8e,_0x7a1ac5=_0x2a4b8e+0x1;const _0x52f6a3=query(collection(db,_0x252d3f(0xff)),where(_0x252d3f(0xf3),'>',_0x2a4b8e),where('position','<',_0x4e9126)),_0x437f16=await getDocs(_0x52f6a3);for(const _0x2f24d8 of _0x437f16['docs']){_0x2f24d8['id']!==_0x32d858&&_0x2f24d8['id']!==_0x3d322a&&_0x1f27ca[_0x252d3f(0xfa)](doc(db,'playersD2',_0x2f24d8['id']),{'position':_0x2f24d8['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x1f27ca['update'](_0x19a654,{'eloRating':_0x247717,'lastMatchDate':serverTimestamp(),'position':_0x579f0a,'lastMatchId':_0x6173ee}),_0x1f27ca['update'](_0xb38546,{'eloRating':_0x22b4c7,'lastMatchDate':serverTimestamp(),'position':_0x7a1ac5,'lastMatchId':_0x6173ee}),await _0x1f27ca['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x32d858,'previousElo':_0x1172a7['eloRating']||0x4b0,'newElo':_0x247717,'opponentId':_0x3d322a,'matchResult':'win','previousPosition':_0x4e9126,'newPosition':_0x579f0a,'isPromotion':_0x579f0a<_0x4e9126,'matchId':_0x6173ee,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x3d322a,'previousElo':_0x5e1980[_0x252d3f(0xf6)]||0x4b0,'newElo':_0x22b4c7,'opponentId':_0x32d858,'matchResult':'loss','previousPosition':_0x2a4b8e,'newPosition':_0x7a1ac5,'isDemotion':_0x7a1ac5>_0x2a4b8e,'matchId':_0x6173ee,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x32d858,_0x247717,_0x1172a7['eloRating'],{'source':'match-d2','matchId':_0x6173ee}),await promotionManager['checkAndRecordPromotion'](_0x3d322a,_0x22b4c7,_0x5e1980['eloRating'],{'source':'match-d2','matchId':_0x6173ee}),!![];}catch(_0x459413){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x459413);throw _0x459413;}}export async function approveReportD2(_0x3a3e8a,_0x5d295b,_0x4f3928,_0x4277eb){const _0x5af150=a28_0x2908;try{console[_0x5af150(0xf5)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x3a3e8a,'winnerScore':_0x5d295b,'winnerSuicides':_0x4f3928,'winnerComment':_0x4277eb});const _0xb5af05=auth['currentUser'];if(!_0xb5af05){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0xb5af05[_0x5af150(0x103)]);const _0x1419c3=await getDoc(doc(db,_0x5af150(0xff),_0xb5af05['uid'])),_0x760878=_0x1419c3['exists']()?_0x1419c3[_0x5af150(0x101)]()['username']:null;console['log']('Current\x20username:',_0x760878);const _0xdb2d94=doc(db,'pendingMatchesD2',_0x3a3e8a),_0x4cb637=await getDoc(_0xdb2d94);if(!_0x4cb637['exists']()){console[_0x5af150(0xf5)]('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x3a3e8a);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x2bbeff=_0x4cb637[_0x5af150(0x101)]();console['log']('D2\x20Report\x20data:',_0x2bbeff);if(_0x760878!==_0x2bbeff['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x22cb58={..._0x2bbeff,'winnerScore':_0x5d295b,'winnerSuicides':_0x4f3928,'winnerComment':_0x4277eb,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x760878,'createdAt':_0x2bbeff['createdAt']||serverTimestamp(),'winnerUsername':_0x2bbeff[_0x5af150(0xf4)],'loserUsername':_0x2bbeff[_0x5af150(0xfc)]};await setDoc(doc(db,_0x5af150(0xfe),_0x3a3e8a),_0x22cb58),await deleteDoc(_0xdb2d94),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x31e5c3,_0x5492dc]=await Promise['all']([getDocs(query(collection(db,_0x5af150(0xff)),where('username','==',_0x2bbeff['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x2bbeff['loserUsername'])))]);if(_0x31e5c3['empty']||_0x5492dc[_0x5af150(0xfb)])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x1f6675=_0x31e5c3['docs'][0x0]['id'],_0x8d8ff9=_0x5492dc['docs'][0x0]['id'];return await updateEloRatingsD2(_0x1f6675,_0x8d8ff9,_0x3a3e8a),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x1e6203){console[_0x5af150(0x100)]('Error\x20in\x20approveReportD2:',_0x1e6203);throw _0x1e6203;}}