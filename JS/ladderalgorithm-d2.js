const a26_0x50017f=(function(){let _0x2b51c3=!![];return function(_0x4e6639,_0x36fc11){const _0x5674eb=_0x2b51c3?function(){const _0x3e099a=a26_0x312c;if(_0x36fc11){const _0x253342=_0x36fc11[_0x3e099a(0x180)](_0x4e6639,arguments);return _0x36fc11=null,_0x253342;}}:function(){};return _0x2b51c3=![],_0x5674eb;};}()),a26_0x228a01=a26_0x50017f(this,function(){const _0x2d92c4=a26_0x312c,_0x51acb6=function(){let _0x378b5b;try{_0x378b5b=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x59d026){_0x378b5b=window;}return _0x378b5b;},_0x2350a4=_0x51acb6(),_0x38458c=_0x2350a4[_0x2d92c4(0x185)]=_0x2350a4['console']||{},_0x53735c=['log','warn','info','error',_0x2d92c4(0x193),'table',_0x2d92c4(0x18d)];for(let _0x4166d8=0x0;_0x4166d8<_0x53735c[_0x2d92c4(0x17f)];_0x4166d8++){const _0x36c37a=a26_0x50017f['constructor'][_0x2d92c4(0x198)][_0x2d92c4(0x18c)](a26_0x50017f),_0xcc082e=_0x53735c[_0x4166d8],_0x482266=_0x38458c[_0xcc082e]||_0x36c37a;_0x36c37a[_0x2d92c4(0x196)]=a26_0x50017f[_0x2d92c4(0x18c)](a26_0x50017f),_0x36c37a['toString']=_0x482266['toString']['bind'](_0x482266),_0x38458c[_0xcc082e]=_0x36c37a;}});a26_0x228a01();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x1dac63 from'./firebase-idle-wrapper.js';function a26_0xe259(){const _0x560d87=['You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','currentUser','length','apply','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','Error\x20in\x20approveReportD2:','error','playersD2','console','loserUsername','match-d2','log','winnerUsername','uid','pow','bind','trace','eloRating','data','empty','checkAndRecordPromotion','Current\x20username:','exception','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','position','__proto__','exists','prototype','docs'];a26_0xe259=function(){return _0x560d87;};return a26_0xe259();}export function calculateEloD2(_0x995e41,_0x114db7,_0x3a4d67=0x20){const _0x49062e=a26_0x312c,_0x5100de=0x1/(0x1+Math[_0x49062e(0x18b)](0xa,(_0x114db7-_0x995e41)/0x190)),_0x3f0512=0x1/(0x1+Math['pow'](0xa,(_0x995e41-_0x114db7)/0x190)),_0x857624=_0x995e41+_0x3a4d67*(0x1-_0x5100de),_0x33d01d=_0x114db7+_0x3a4d67*(0x0-_0x3f0512);return{'newWinnerRating':Math['round'](_0x857624),'newLoserRating':Math['round'](_0x33d01d)};}function a26_0x312c(_0x2e642d,_0x165b87){const _0x228a01=a26_0xe259();return a26_0x312c=function(_0x50017f,_0x3ab3b1){_0x50017f=_0x50017f-0x17d;let _0xe2593d=_0x228a01[_0x50017f];return _0xe2593d;},a26_0x312c(_0x2e642d,_0x165b87);}export async function updateEloRatingsD2(_0x68da8c,_0x4580e8,_0x4af3fb){const _0x326f7b=a26_0x312c;try{const _0x1fd187=writeBatch(db),_0x38e9bc=doc(db,'playersD2',_0x68da8c),_0x3f1022=doc(db,_0x326f7b(0x184),_0x4580e8),[_0x23b175,_0x2dbb78]=await Promise['all']([getDoc(_0x38e9bc),getDoc(_0x3f1022)]);if(!_0x23b175[_0x326f7b(0x197)]()||!_0x2dbb78['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x3cc9d6=_0x23b175[_0x326f7b(0x18f)](),_0x20f1b9=_0x2dbb78['data'](),_0x529906=_0x3cc9d6[_0x326f7b(0x195)]||Number['MAX_SAFE_INTEGER'],_0x45b94f=_0x20f1b9[_0x326f7b(0x195)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x5b70d0,newLoserRating:_0x56c573}=calculateEloD2(_0x3cc9d6['eloRating']||0x4b0,_0x20f1b9[_0x326f7b(0x18e)]||0x4b0);let _0x26c8b0=_0x529906,_0x2e5122=_0x45b94f;if(_0x529906>_0x45b94f){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x26c8b0=_0x45b94f,_0x2e5122=_0x45b94f+0x1;const _0x4d5407=query(collection(db,'playersD2'),where('position','>',_0x45b94f),where('position','<',_0x529906)),_0x52d6ce=await getDocs(_0x4d5407);for(const _0x3f2704 of _0x52d6ce['docs']){_0x3f2704['id']!==_0x68da8c&&_0x3f2704['id']!==_0x4580e8&&_0x1fd187['update'](doc(db,'playersD2',_0x3f2704['id']),{'position':_0x3f2704['data']()[_0x326f7b(0x195)]+0x1});}}else console[_0x326f7b(0x188)](_0x326f7b(0x181));return _0x1fd187['update'](_0x38e9bc,{'eloRating':_0x5b70d0,'lastMatchDate':serverTimestamp(),'position':_0x26c8b0,'lastMatchId':_0x4af3fb}),_0x1fd187['update'](_0x3f1022,{'eloRating':_0x56c573,'lastMatchDate':serverTimestamp(),'position':_0x2e5122,'lastMatchId':_0x4af3fb}),await _0x1fd187['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x68da8c,'previousElo':_0x3cc9d6['eloRating']||0x4b0,'newElo':_0x5b70d0,'opponentId':_0x4580e8,'matchResult':'win','previousPosition':_0x529906,'newPosition':_0x26c8b0,'isPromotion':_0x26c8b0<_0x529906,'matchId':_0x4af3fb,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x4580e8,'previousElo':_0x20f1b9['eloRating']||0x4b0,'newElo':_0x56c573,'opponentId':_0x68da8c,'matchResult':'loss','previousPosition':_0x45b94f,'newPosition':_0x2e5122,'isDemotion':_0x2e5122>_0x45b94f,'matchId':_0x4af3fb,'timestamp':serverTimestamp()})]),await promotionManager[_0x326f7b(0x191)](_0x68da8c,_0x5b70d0,_0x3cc9d6['eloRating'],{'source':_0x326f7b(0x187),'matchId':_0x4af3fb}),await promotionManager[_0x326f7b(0x191)](_0x4580e8,_0x56c573,_0x20f1b9['eloRating'],{'source':_0x326f7b(0x187),'matchId':_0x4af3fb}),!![];}catch(_0x52d3b8){console[_0x326f7b(0x183)]('Error\x20in\x20updateEloRatingsD2:',_0x52d3b8);throw _0x52d3b8;}}export async function approveReportD2(_0x4b33e7,_0x312fc,_0xd08a9,_0x1c59a7){const _0x478e9c=a26_0x312c;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x4b33e7,'winnerScore':_0x312fc,'winnerSuicides':_0xd08a9,'winnerComment':_0x1c59a7});const _0x2b0fd8=auth[_0x478e9c(0x17e)];if(!_0x2b0fd8){console[_0x478e9c(0x188)]('No\x20user\x20logged\x20in');throw new Error(_0x478e9c(0x17d));}console['log']('Current\x20user:',_0x2b0fd8['email']);const _0x14ab75=await getDoc(doc(db,'playersD2',_0x2b0fd8[_0x478e9c(0x18a)])),_0x1a50b7=_0x14ab75[_0x478e9c(0x197)]()?_0x14ab75['data']()['username']:null;console['log'](_0x478e9c(0x192),_0x1a50b7);const _0x1b3cba=doc(db,'pendingMatchesD2',_0x4b33e7),_0x258857=await getDoc(_0x1b3cba);if(!_0x258857['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x4b33e7);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x37a71a=_0x258857['data']();console['log']('D2\x20Report\x20data:',_0x37a71a);if(_0x1a50b7!==_0x37a71a[_0x478e9c(0x189)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x3ca7b8={..._0x37a71a,'winnerScore':_0x312fc,'winnerSuicides':_0xd08a9,'winnerComment':_0x1c59a7,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1a50b7,'createdAt':_0x37a71a['createdAt']||serverTimestamp(),'winnerUsername':_0x37a71a[_0x478e9c(0x189)],'loserUsername':_0x37a71a['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x4b33e7),_0x3ca7b8),await deleteDoc(_0x1b3cba),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x5d6d03,_0x40a113]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x37a71a['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x37a71a[_0x478e9c(0x186)])))]);if(_0x5d6d03['empty']||_0x40a113[_0x478e9c(0x190)])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x12cc84=_0x5d6d03[_0x478e9c(0x199)][0x0]['id'],_0x2eed96=_0x40a113[_0x478e9c(0x199)][0x0]['id'];return await updateEloRatingsD2(_0x12cc84,_0x2eed96,_0x4b33e7),console[_0x478e9c(0x188)](_0x478e9c(0x194)),!![];}catch(_0x475f1f){console['error'](_0x478e9c(0x182),_0x475f1f);throw _0x475f1f;}}