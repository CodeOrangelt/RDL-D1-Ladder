const a29_0x5895b4=(function(){let _0x473395=!![];return function(_0x1a1a8a,_0x430730){const _0x4e8b38=_0x473395?function(){if(_0x430730){const _0x2d4333=_0x430730['apply'](_0x1a1a8a,arguments);return _0x430730=null,_0x2d4333;}}:function(){};return _0x473395=![],_0x4e8b38;};}()),a29_0x46c976=a29_0x5895b4(this,function(){const _0x279166=a29_0x3f14,_0x14cbbf=function(){let _0x56f6ce;try{_0x56f6ce=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x352719){_0x56f6ce=window;}return _0x56f6ce;},_0x2531b2=_0x14cbbf(),_0x42c903=_0x2531b2['console']=_0x2531b2['console']||{},_0x40e08a=['log',_0x279166(0x1b9),_0x279166(0x1b6),_0x279166(0x1ba),'exception',_0x279166(0x1b1),'trace'];for(let _0x4112ca=0x0;_0x4112ca<_0x40e08a['length'];_0x4112ca++){const _0x484717=a29_0x5895b4['constructor']['prototype']['bind'](a29_0x5895b4),_0x39d95b=_0x40e08a[_0x4112ca],_0x598d5e=_0x42c903[_0x39d95b]||_0x484717;_0x484717['__proto__']=a29_0x5895b4['bind'](a29_0x5895b4),_0x484717['toString']=_0x598d5e['toString']['bind'](_0x598d5e),_0x42c903[_0x39d95b]=_0x484717;}});a29_0x46c976();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a29_0x2935(){const _0x4dba47=['Error\x20in\x20approveReportD3:','data','win','Starting\x20approveReportD3\x20function\x20with:','empty','winnerUsername','log','D3\x20ELO\x20ratings\x20updated\x20successfully','username','round','table','position','eloRating','currentUser','D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','info','MAX_SAFE_INTEGER','playersD3','warn','error','docs','pow','update','D3\x20Report\x20not\x20found\x20with\x20ID:'];a29_0x2935=function(){return _0x4dba47;};return a29_0x2935();}function a29_0x3f14(_0x373882,_0x1b9716){const _0x46c976=a29_0x2935();return a29_0x3f14=function(_0x5895b4,_0x46f117){_0x5895b4=_0x5895b4-0x1a7;let _0x29354c=_0x46c976[_0x5895b4];return _0x29354c;},a29_0x3f14(_0x373882,_0x1b9716);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x4a8e29,_0x33ec2a,_0x4a1c91=0x20){const _0x2d78f2=a29_0x3f14,_0x12b609=0x1/(0x1+Math['pow'](0xa,(_0x33ec2a-_0x4a8e29)/0x190)),_0x4131ef=0x1/(0x1+Math[_0x2d78f2(0x1bc)](0xa,(_0x4a8e29-_0x33ec2a)/0x190)),_0x4de276=_0x4a8e29+_0x4a1c91*(0x1-_0x12b609),_0x59d20a=_0x33ec2a+_0x4a1c91*(0x0-_0x4131ef);return{'newWinnerRating':Math[_0x2d78f2(0x1b0)](_0x4de276),'newLoserRating':Math[_0x2d78f2(0x1b0)](_0x59d20a)};}export async function updateEloRatingsD3(_0x5dc50d,_0x4b2ee4,_0x21337c){const _0x4f9baa=a29_0x3f14;try{const _0x7efb5=writeBatch(db),_0x15f714=doc(db,'playersD3',_0x5dc50d),_0x1aa9df=doc(db,_0x4f9baa(0x1b8),_0x4b2ee4),[_0x1514ca,_0x3962f9]=await Promise['all']([getDoc(_0x15f714),getDoc(_0x1aa9df)]);if(!_0x1514ca['exists']()||!_0x3962f9['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x50280f=_0x1514ca['data'](),_0x3d5885=_0x3962f9['data'](),_0x2e32f0=_0x50280f['position']||Number[_0x4f9baa(0x1b7)],_0x519f5e=_0x3d5885['position']||Number[_0x4f9baa(0x1b7)],{newWinnerRating:_0x28e39b,newLoserRating:_0x5857fc}=calculateEloD3(_0x50280f['eloRating']||0x4b0,_0x3d5885[_0x4f9baa(0x1b3)]||0x4b0);let _0xf7e943=_0x2e32f0,_0x118daa=_0x519f5e;if(_0x2e32f0>_0x519f5e){console[_0x4f9baa(0x1ad)]('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0xf7e943=_0x519f5e,_0x118daa=_0x519f5e+0x1;const _0x148b0c=query(collection(db,'playersD3'),where('position','>',_0x519f5e),where('position','<',_0x2e32f0)),_0x5212a4=await getDocs(_0x148b0c);for(const _0x34d5cf of _0x5212a4[_0x4f9baa(0x1bb)]){_0x34d5cf['id']!==_0x5dc50d&&_0x34d5cf['id']!==_0x4b2ee4&&_0x7efb5['update'](doc(db,'playersD3',_0x34d5cf['id']),{'position':_0x34d5cf['data']()[_0x4f9baa(0x1b2)]+0x1});}}else console['log'](_0x4f9baa(0x1b5));return _0x7efb5['update'](_0x15f714,{'eloRating':_0x28e39b,'lastMatchDate':serverTimestamp(),'position':_0xf7e943,'lastMatchId':_0x21337c}),_0x7efb5[_0x4f9baa(0x1bd)](_0x1aa9df,{'eloRating':_0x5857fc,'lastMatchDate':serverTimestamp(),'position':_0x118daa,'lastMatchId':_0x21337c}),await _0x7efb5['commit'](),console['log'](_0x4f9baa(0x1ae)),await Promise['all']([recordEloChangeD3({'playerId':_0x5dc50d,'previousElo':_0x50280f[_0x4f9baa(0x1b3)]||0x4b0,'newElo':_0x28e39b,'opponentId':_0x4b2ee4,'matchResult':_0x4f9baa(0x1a9),'previousPosition':_0x2e32f0,'newPosition':_0xf7e943,'isPromotion':_0xf7e943<_0x2e32f0,'matchId':_0x21337c,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x4b2ee4,'previousElo':_0x3d5885['eloRating']||0x4b0,'newElo':_0x5857fc,'opponentId':_0x5dc50d,'matchResult':'loss','previousPosition':_0x519f5e,'newPosition':_0x118daa,'isDemotion':_0x118daa>_0x519f5e,'matchId':_0x21337c,'timestamp':serverTimestamp()})]),!![];}catch(_0x4355d6){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x4355d6);throw _0x4355d6;}}export async function approveReportD3(_0x3ed626,_0x5ab022,_0x3a4164,_0x5a54ac){const _0x477297=a29_0x3f14;try{console['log'](_0x477297(0x1aa),{'reportId':_0x3ed626,'winnerScore':_0x5ab022,'winnerSuicides':_0x3a4164,'winnerComment':_0x5a54ac});const _0x56cbfa=auth[_0x477297(0x1b4)];if(!_0x56cbfa){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x56cbfa['email']);const _0x5a5570=await getDoc(doc(db,'playersD3',_0x56cbfa['uid'])),_0x184ab1=_0x5a5570['exists']()?_0x5a5570['data']()['username']:null;console['log']('Current\x20username:',_0x184ab1);const _0x4b3a2a=doc(db,'pendingMatchesD3',_0x3ed626),_0x38b2e0=await getDoc(_0x4b3a2a);if(!_0x38b2e0['exists']()){console[_0x477297(0x1ad)](_0x477297(0x1be),_0x3ed626);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x51323c=_0x38b2e0[_0x477297(0x1a8)]();console['log']('D3\x20Report\x20data:',_0x51323c);if(_0x184ab1!==_0x51323c['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x1ac208={..._0x51323c,'winnerScore':_0x5ab022,'winnerSuicides':_0x3a4164,'winnerComment':_0x5a54ac,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x184ab1,'createdAt':_0x51323c['createdAt']||serverTimestamp(),'winnerUsername':_0x51323c[_0x477297(0x1ac)],'loserUsername':_0x51323c['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x3ed626),_0x1ac208),await deleteDoc(_0x4b3a2a),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x1030a9,_0x32bd1e]=await Promise['all']([getDocs(query(collection(db,_0x477297(0x1b8)),where('username','==',_0x51323c['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x477297(0x1af),'==',_0x51323c['loserUsername'])))]);if(_0x1030a9['empty']||_0x32bd1e[_0x477297(0x1ab)])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x5c9fed=_0x1030a9['docs'][0x0]['id'],_0x277e75=_0x32bd1e[_0x477297(0x1bb)][0x0]['id'];return await updateEloRatingsD3(_0x5c9fed,_0x277e75,_0x3ed626),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x4858fc){console['error'](_0x477297(0x1a7),_0x4858fc);throw _0x4858fc;}}