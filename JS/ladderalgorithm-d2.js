const a26_0x51f22f=(function(){let _0xb5880e=!![];return function(_0x523d31,_0xbfc0d0){const _0x5417bb=_0xb5880e?function(){const _0x87c8a2=a26_0x33f0;if(_0xbfc0d0){const _0x46245c=_0xbfc0d0[_0x87c8a2(0x10b)](_0x523d31,arguments);return _0xbfc0d0=null,_0x46245c;}}:function(){};return _0xb5880e=![],_0x5417bb;};}()),a26_0x48563e=a26_0x51f22f(this,function(){const _0x2ee691=a26_0x33f0;let _0x43f2be;try{const _0x40aec8=Function(_0x2ee691(0x106)+_0x2ee691(0xf7)+');');_0x43f2be=_0x40aec8();}catch(_0x36f3d8){_0x43f2be=window;}const _0x1abbac=_0x43f2be[_0x2ee691(0x109)]=_0x43f2be['console']||{},_0x115bb2=[_0x2ee691(0xfb),'warn','info',_0x2ee691(0x10d),'exception','table','trace'];for(let _0x194897=0x0;_0x194897<_0x115bb2['length'];_0x194897++){const _0x4cd1fb=a26_0x51f22f[_0x2ee691(0xf5)][_0x2ee691(0xf4)][_0x2ee691(0x104)](a26_0x51f22f),_0x4833a8=_0x115bb2[_0x194897],_0x530930=_0x1abbac[_0x4833a8]||_0x4cd1fb;_0x4cd1fb['__proto__']=a26_0x51f22f['bind'](a26_0x51f22f),_0x4cd1fb['toString']=_0x530930[_0x2ee691(0xf1)]['bind'](_0x530930),_0x1abbac[_0x4833a8]=_0x4cd1fb;}});a26_0x48563e();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a26_0x21cb(){const _0x5b1051=['eloRating','empty','Could\x20not\x20find\x20D2\x20player\x20documents','toString','Error\x20in\x20updateEloRatingsD2:','all','prototype','constructor','D2\x20Match\x20moved\x20to\x20approved\x20collection','{}.constructor(\x22return\x20this\x22)(\x20)','playersD2','D2\x20match\x20report\x20not\x20found','position','log','pow','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','pendingMatchesD2','email','createdAt','No\x20user\x20logged\x20in','update','username','bind','match-d2','return\x20(function()\x20','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','currentUser','console','data','apply','exists','error','docs'];a26_0x21cb=function(){return _0x5b1051;};return a26_0x21cb();}function a26_0x33f0(_0x150db8,_0x4047cf){const _0x48563e=a26_0x21cb();return a26_0x33f0=function(_0x51f22f,_0x2b79f2){_0x51f22f=_0x51f22f-0xee;let _0x21cb7c=_0x48563e[_0x51f22f];return _0x21cb7c;},a26_0x33f0(_0x150db8,_0x4047cf);}import a26_0xdbed08 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x5c27dd,_0x11dbf9,_0x1d5065=0x20){const _0x28daab=a26_0x33f0,_0x3dd308=0x1/(0x1+Math[_0x28daab(0xfc)](0xa,(_0x11dbf9-_0x5c27dd)/0x190)),_0x7b36b7=0x1/(0x1+Math[_0x28daab(0xfc)](0xa,(_0x5c27dd-_0x11dbf9)/0x190)),_0xbf7e1b=_0x5c27dd+_0x1d5065*(0x1-_0x3dd308),_0x3d5915=_0x11dbf9+_0x1d5065*(0x0-_0x7b36b7);return{'newWinnerRating':Math['round'](_0xbf7e1b),'newLoserRating':Math['round'](_0x3d5915)};}export async function updateEloRatingsD2(_0x2bd4b0,_0x5f2066,_0x1f4867){const _0x187d95=a26_0x33f0;try{const _0x3ef79f=writeBatch(db),_0x39ae97=doc(db,'playersD2',_0x2bd4b0),_0x2c8c32=doc(db,'playersD2',_0x5f2066),[_0x1e6c00,_0x267b01]=await Promise['all']([getDoc(_0x39ae97),getDoc(_0x2c8c32)]);if(!_0x1e6c00[_0x187d95(0x10c)]()||!_0x267b01[_0x187d95(0x10c)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0xa867a2=_0x1e6c00['data'](),_0x1585ed=_0x267b01['data'](),_0x3a269b=_0xa867a2['position']||Number['MAX_SAFE_INTEGER'],_0x45d633=_0x1585ed[_0x187d95(0xfa)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0xb5b18f,newLoserRating:_0x27c0da}=calculateEloD2(_0xa867a2[_0x187d95(0xee)]||0x4b0,_0x1585ed['eloRating']||0x4b0);let _0x29b60e=_0x3a269b,_0xf101a0=_0x45d633;if(_0x3a269b>_0x45d633){console[_0x187d95(0xfb)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x29b60e=_0x45d633,_0xf101a0=_0x45d633+0x1;const _0xa13613=query(collection(db,'playersD2'),where('position','>',_0x45d633),where('position','<',_0x3a269b)),_0x572301=await getDocs(_0xa13613);for(const _0x57ba94 of _0x572301[_0x187d95(0x10e)]){_0x57ba94['id']!==_0x2bd4b0&&_0x57ba94['id']!==_0x5f2066&&_0x3ef79f[_0x187d95(0x102)](doc(db,_0x187d95(0xf8),_0x57ba94['id']),{'position':_0x57ba94['data']()['position']+0x1});}}else console['log'](_0x187d95(0xfd));return _0x3ef79f['update'](_0x39ae97,{'eloRating':_0xb5b18f,'lastMatchDate':serverTimestamp(),'position':_0x29b60e,'lastMatchId':_0x1f4867}),_0x3ef79f[_0x187d95(0x102)](_0x2c8c32,{'eloRating':_0x27c0da,'lastMatchDate':serverTimestamp(),'position':_0xf101a0,'lastMatchId':_0x1f4867}),await _0x3ef79f['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x2bd4b0,'previousElo':_0xa867a2['eloRating']||0x4b0,'newElo':_0xb5b18f,'opponentId':_0x5f2066,'matchResult':'win','previousPosition':_0x3a269b,'newPosition':_0x29b60e,'isPromotion':_0x29b60e<_0x3a269b,'matchId':_0x1f4867,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x5f2066,'previousElo':_0x1585ed['eloRating']||0x4b0,'newElo':_0x27c0da,'opponentId':_0x2bd4b0,'matchResult':'loss','previousPosition':_0x45d633,'newPosition':_0xf101a0,'isDemotion':_0xf101a0>_0x45d633,'matchId':_0x1f4867,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x2bd4b0,_0xb5b18f,_0xa867a2['eloRating'],{'source':_0x187d95(0x105),'matchId':_0x1f4867}),await promotionManager['checkAndRecordPromotion'](_0x5f2066,_0x27c0da,_0x1585ed['eloRating'],{'source':_0x187d95(0x105),'matchId':_0x1f4867}),!![];}catch(_0x83226){console['error'](_0x187d95(0xf2),_0x83226);throw _0x83226;}}export async function approveReportD2(_0x4becf8,_0x3e9d80,_0x4df121,_0x513471){const _0x182882=a26_0x33f0;try{console[_0x182882(0xfb)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x4becf8,'winnerScore':_0x3e9d80,'winnerSuicides':_0x4df121,'winnerComment':_0x513471});const _0x3d50c3=auth[_0x182882(0x108)];if(!_0x3d50c3){console['log'](_0x182882(0x101));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x3d50c3[_0x182882(0xff)]);const _0x50627b=await getDoc(doc(db,'playersD2',_0x3d50c3['uid'])),_0x528878=_0x50627b[_0x182882(0x10c)]()?_0x50627b[_0x182882(0x10a)]()[_0x182882(0x103)]:null;console['log']('Current\x20username:',_0x528878);const _0x52c0a6=doc(db,_0x182882(0xfe),_0x4becf8),_0x5446ca=await getDoc(_0x52c0a6);if(!_0x5446ca[_0x182882(0x10c)]()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x4becf8);throw new Error(_0x182882(0xf9));}const _0x2beda1=_0x5446ca['data']();console['log']('D2\x20Report\x20data:',_0x2beda1);if(_0x528878!==_0x2beda1['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x335ff3={..._0x2beda1,'winnerScore':_0x3e9d80,'winnerSuicides':_0x4df121,'winnerComment':_0x513471,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x528878,'createdAt':_0x2beda1[_0x182882(0x100)]||serverTimestamp(),'winnerUsername':_0x2beda1['winnerUsername'],'loserUsername':_0x2beda1['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x4becf8),_0x335ff3),await deleteDoc(_0x52c0a6),console[_0x182882(0xfb)](_0x182882(0xf6));const [_0x2104b4,_0xd268e9]=await Promise[_0x182882(0xf3)]([getDocs(query(collection(db,'playersD2'),where(_0x182882(0x103),'==',_0x2beda1['winnerUsername']))),getDocs(query(collection(db,_0x182882(0xf8)),where('username','==',_0x2beda1['loserUsername'])))]);if(_0x2104b4[_0x182882(0xef)]||_0xd268e9[_0x182882(0xef)])throw new Error(_0x182882(0xf0));const _0x3923e2=_0x2104b4[_0x182882(0x10e)][0x0]['id'],_0x4942fc=_0xd268e9[_0x182882(0x10e)][0x0]['id'];return await updateEloRatingsD2(_0x3923e2,_0x4942fc,_0x4becf8),console[_0x182882(0xfb)](_0x182882(0x107)),!![];}catch(_0x329954){console['error']('Error\x20in\x20approveReportD2:',_0x329954);throw _0x329954;}}