const a27_0x294569=(function(){let _0xccc233=!![];return function(_0x2bbb09,_0x22f0dc){const _0xf37bfa=_0xccc233?function(){if(_0x22f0dc){const _0x4d8c5f=_0x22f0dc['apply'](_0x2bbb09,arguments);return _0x22f0dc=null,_0x4d8c5f;}}:function(){};return _0xccc233=![],_0xf37bfa;};}()),a27_0x424774=a27_0x294569(this,function(){const _0x46c5bd=a27_0xa01a;let _0x488849;try{const _0x3d1def=Function('return\x20(function()\x20'+_0x46c5bd(0x143)+');');_0x488849=_0x3d1def();}catch(_0x8742e){_0x488849=window;}const _0x1359be=_0x488849['console']=_0x488849['console']||{},_0x2ef954=[_0x46c5bd(0x14e),'warn','info','error','exception','table','trace'];for(let _0x1d9fc3=0x0;_0x1d9fc3<_0x2ef954[_0x46c5bd(0x154)];_0x1d9fc3++){const _0x3ab668=a27_0x294569['constructor']['prototype']['bind'](a27_0x294569),_0x3022e2=_0x2ef954[_0x1d9fc3],_0x443da9=_0x1359be[_0x3022e2]||_0x3ab668;_0x3ab668['__proto__']=a27_0x294569[_0x46c5bd(0x148)](a27_0x294569),_0x3ab668[_0x46c5bd(0x14c)]=_0x443da9['toString']['bind'](_0x443da9),_0x1359be[_0x3022e2]=_0x3ab668;}});function a27_0x39c0(){const _0x347f92=['loserUsername','{}.constructor(\x22return\x20this\x22)(\x20)','Error\x20in\x20updateEloRatingsD3:','Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches','D3\x20match\x20report\x20not\x20found','D3\x20Report\x20data:','bind','error','playersD3','One\x20or\x20both\x20D3\x20players\x20not\x20found','toString','eloRating','log','username','createdAt','position','empty','D3\x20ELO\x20ratings\x20updated\x20successfully','length','data','winnerUsername','round'];a27_0x39c0=function(){return _0x347f92;};return a27_0x39c0();}a27_0x424774();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a27_0xa01a(_0x4860f8,_0x13ccda){const _0x424774=a27_0x39c0();return a27_0xa01a=function(_0x294569,_0x21beca){_0x294569=_0x294569-0x142;let _0x39c018=_0x424774[_0x294569];return _0x39c018;},a27_0xa01a(_0x4860f8,_0x13ccda);}import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x5663fc,_0x256553,_0x577790=0x20){const _0x6686ed=a27_0xa01a,_0x5ea762=0x1/(0x1+Math['pow'](0xa,(_0x256553-_0x5663fc)/0x190)),_0x52eae7=0x1/(0x1+Math['pow'](0xa,(_0x5663fc-_0x256553)/0x190)),_0x8423da=_0x5663fc+_0x577790*(0x1-_0x5ea762),_0x491bf2=_0x256553+_0x577790*(0x0-_0x52eae7);return{'newWinnerRating':Math['round'](_0x8423da),'newLoserRating':Math[_0x6686ed(0x157)](_0x491bf2)};}export async function updateEloRatingsD3(_0x309145,_0x52152c,_0x4f90d4){const _0x2ad563=a27_0xa01a;try{const _0x4bbc0d=writeBatch(db),_0x2f04d6=doc(db,'playersD3',_0x309145),_0x1efcb9=doc(db,_0x2ad563(0x14a),_0x52152c),[_0x9fc349,_0xb12878]=await Promise['all']([getDoc(_0x2f04d6),getDoc(_0x1efcb9)]);if(!_0x9fc349['exists']()||!_0xb12878['exists']())throw new Error(_0x2ad563(0x14b));const _0x457683=_0x9fc349[_0x2ad563(0x155)](),_0x357acb=_0xb12878['data'](),_0x59d718=_0x457683[_0x2ad563(0x151)]||Number['MAX_SAFE_INTEGER'],_0x5d2bc0=_0x357acb[_0x2ad563(0x151)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x31fc5a,newLoserRating:_0x36b569}=calculateEloD3(_0x457683['eloRating']||0x4b0,_0x357acb['eloRating']||0x4b0);let _0x3a8f70=_0x59d718,_0xda6ba7=_0x5d2bc0;if(_0x59d718>_0x5d2bc0){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x3a8f70=_0x5d2bc0,_0xda6ba7=_0x5d2bc0+0x1;const _0x5d7767=query(collection(db,_0x2ad563(0x14a)),where('position','>',_0x5d2bc0),where('position','<',_0x59d718)),_0x2b5fb9=await getDocs(_0x5d7767);for(const _0x1f8bba of _0x2b5fb9['docs']){_0x1f8bba['id']!==_0x309145&&_0x1f8bba['id']!==_0x52152c&&_0x4bbc0d['update'](doc(db,_0x2ad563(0x14a),_0x1f8bba['id']),{'position':_0x1f8bba['data']()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x4bbc0d['update'](_0x2f04d6,{'eloRating':_0x31fc5a,'lastMatchDate':serverTimestamp(),'position':_0x3a8f70,'lastMatchId':_0x4f90d4}),_0x4bbc0d['update'](_0x1efcb9,{'eloRating':_0x36b569,'lastMatchDate':serverTimestamp(),'position':_0xda6ba7,'lastMatchId':_0x4f90d4}),await _0x4bbc0d['commit'](),console['log'](_0x2ad563(0x153)),await Promise['all']([recordEloChangeD3({'playerId':_0x309145,'previousElo':_0x457683[_0x2ad563(0x14d)]||0x4b0,'newElo':_0x31fc5a,'opponentId':_0x52152c,'matchResult':'win','previousPosition':_0x59d718,'newPosition':_0x3a8f70,'isPromotion':_0x3a8f70<_0x59d718,'matchId':_0x4f90d4,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x52152c,'previousElo':_0x357acb[_0x2ad563(0x14d)]||0x4b0,'newElo':_0x36b569,'opponentId':_0x309145,'matchResult':'loss','previousPosition':_0x5d2bc0,'newPosition':_0xda6ba7,'isDemotion':_0xda6ba7>_0x5d2bc0,'matchId':_0x4f90d4,'timestamp':serverTimestamp()})]),!![];}catch(_0x48833e){console[_0x2ad563(0x149)](_0x2ad563(0x144),_0x48833e);throw _0x48833e;}}export async function approveReportD3(_0x3a791e,_0x4088f3,_0x149da8,_0x1cd887){const _0x2634fd=a27_0xa01a;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x3a791e,'winnerScore':_0x4088f3,'winnerSuicides':_0x149da8,'winnerComment':_0x1cd887});const _0x2e544b=auth['currentUser'];if(!_0x2e544b){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x2e544b['email']);const _0x46120e=await getDoc(doc(db,_0x2634fd(0x14a),_0x2e544b['uid'])),_0x36b9c8=_0x46120e['exists']()?_0x46120e[_0x2634fd(0x155)]()['username']:null;console['log']('Current\x20username:',_0x36b9c8);const _0x11e71e=doc(db,'pendingMatchesD3',_0x3a791e),_0xf01a02=await getDoc(_0x11e71e);if(!_0xf01a02['exists']()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x3a791e);throw new Error(_0x2634fd(0x146));}const _0x32b880=_0xf01a02['data']();console['log'](_0x2634fd(0x147),_0x32b880);if(_0x36b9c8!==_0x32b880[_0x2634fd(0x156)])throw new Error(_0x2634fd(0x145));const _0x151d58={..._0x32b880,'winnerScore':_0x4088f3,'winnerSuicides':_0x149da8,'winnerComment':_0x1cd887,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x36b9c8,'createdAt':_0x32b880[_0x2634fd(0x150)]||serverTimestamp(),'winnerUsername':_0x32b880['winnerUsername'],'loserUsername':_0x32b880['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x3a791e),_0x151d58),await deleteDoc(_0x11e71e),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x220589,_0x1fe344]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x32b880[_0x2634fd(0x156)]))),getDocs(query(collection(db,_0x2634fd(0x14a)),where(_0x2634fd(0x14f),'==',_0x32b880[_0x2634fd(0x142)])))]);if(_0x220589['empty']||_0x1fe344[_0x2634fd(0x152)])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x2bc7fa=_0x220589['docs'][0x0]['id'],_0x426efb=_0x1fe344['docs'][0x0]['id'];return await updateEloRatingsD3(_0x2bc7fa,_0x426efb,_0x3a791e),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x488519){console['error']('Error\x20in\x20approveReportD3:',_0x488519);throw _0x488519;}}