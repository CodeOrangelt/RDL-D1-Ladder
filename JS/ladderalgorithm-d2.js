const a26_0x932b54=(function(){let _0x5e1e6e=!![];return function(_0x42467e,_0x537161){const _0x940f3=_0x5e1e6e?function(){const _0x1ccadd=a26_0x2e38;if(_0x537161){const _0x33fbe7=_0x537161[_0x1ccadd(0x16a)](_0x42467e,arguments);return _0x537161=null,_0x33fbe7;}}:function(){};return _0x5e1e6e=![],_0x940f3;};}()),a26_0x241147=a26_0x932b54(this,function(){const _0x146368=a26_0x2e38,_0xdbdf31=function(){let _0x289b54;try{_0x289b54=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x58703c){_0x289b54=window;}return _0x289b54;},_0x9607f7=_0xdbdf31(),_0x416c1f=_0x9607f7[_0x146368(0x161)]=_0x9607f7['console']||{},_0x1f62a1=['log',_0x146368(0x166),'info','error',_0x146368(0x16e),_0x146368(0x15d),'trace'];for(let _0x2fac92=0x0;_0x2fac92<_0x1f62a1['length'];_0x2fac92++){const _0x183b82=a26_0x932b54['constructor']['prototype'][_0x146368(0x158)](a26_0x932b54),_0x1993d2=_0x1f62a1[_0x2fac92],_0x58a583=_0x416c1f[_0x1993d2]||_0x183b82;_0x183b82['__proto__']=a26_0x932b54['bind'](a26_0x932b54),_0x183b82['toString']=_0x58a583['toString'][_0x146368(0x158)](_0x58a583),_0x416c1f[_0x1993d2]=_0x183b82;}});a26_0x241147();function a26_0x2761(){const _0x422264=['update','bind','eloRating','data','round','docs','table','all','email','Current\x20user:','console','position','currentUser','match-d2','winnerUsername','warn','username','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','apply','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','checkAndRecordPromotion','exists','exception','Could\x20not\x20find\x20D2\x20player\x20documents','log'];a26_0x2761=function(){return _0x422264;};return a26_0x2761();}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a26_0x2e38(_0x45b8ae,_0x51750f){const _0x241147=a26_0x2761();return a26_0x2e38=function(_0x932b54,_0x416dbc){_0x932b54=_0x932b54-0x157;let _0x27614a=_0x241147[_0x932b54];return _0x27614a;},a26_0x2e38(_0x45b8ae,_0x51750f);}import a26_0x49fc77 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x208bfa,_0x5bb002,_0x28678e=0x20){const _0x2074f6=a26_0x2e38,_0x537ab9=0x1/(0x1+Math['pow'](0xa,(_0x5bb002-_0x208bfa)/0x190)),_0x505143=0x1/(0x1+Math['pow'](0xa,(_0x208bfa-_0x5bb002)/0x190)),_0x5bfdd9=_0x208bfa+_0x28678e*(0x1-_0x537ab9),_0x3a5b9a=_0x5bb002+_0x28678e*(0x0-_0x505143);return{'newWinnerRating':Math['round'](_0x5bfdd9),'newLoserRating':Math[_0x2074f6(0x15b)](_0x3a5b9a)};}export async function updateEloRatingsD2(_0x3ff1fd,_0x53f5d4,_0x108547){const _0x3ec910=a26_0x2e38;try{const _0x305a3a=writeBatch(db),_0xd3e641=doc(db,'playersD2',_0x3ff1fd),_0x323bbc=doc(db,'playersD2',_0x53f5d4),[_0x44730e,_0x38d863]=await Promise['all']([getDoc(_0xd3e641),getDoc(_0x323bbc)]);if(!_0x44730e['exists']()||!_0x38d863[_0x3ec910(0x16d)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x7b58e4=_0x44730e[_0x3ec910(0x15a)](),_0x22f691=_0x38d863['data'](),_0x1fe19d=_0x7b58e4['position']||Number['MAX_SAFE_INTEGER'],_0x32f9be=_0x22f691['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x2044dd,newLoserRating:_0x4a8164}=calculateEloD2(_0x7b58e4['eloRating']||0x4b0,_0x22f691[_0x3ec910(0x159)]||0x4b0);let _0x3c7c88=_0x1fe19d,_0x4e3419=_0x32f9be;if(_0x1fe19d>_0x32f9be){console['log'](_0x3ec910(0x16b)),_0x3c7c88=_0x32f9be,_0x4e3419=_0x32f9be+0x1;const _0x5326d4=query(collection(db,'playersD2'),where(_0x3ec910(0x162),'>',_0x32f9be),where('position','<',_0x1fe19d)),_0x242023=await getDocs(_0x5326d4);for(const _0x4397a8 of _0x242023['docs']){_0x4397a8['id']!==_0x3ff1fd&&_0x4397a8['id']!==_0x53f5d4&&_0x305a3a['update'](doc(db,'playersD2',_0x4397a8['id']),{'position':_0x4397a8[_0x3ec910(0x15a)]()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x305a3a[_0x3ec910(0x157)](_0xd3e641,{'eloRating':_0x2044dd,'lastMatchDate':serverTimestamp(),'position':_0x3c7c88,'lastMatchId':_0x108547}),_0x305a3a['update'](_0x323bbc,{'eloRating':_0x4a8164,'lastMatchDate':serverTimestamp(),'position':_0x4e3419,'lastMatchId':_0x108547}),await _0x305a3a['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x3ff1fd,'previousElo':_0x7b58e4['eloRating']||0x4b0,'newElo':_0x2044dd,'opponentId':_0x53f5d4,'matchResult':'win','previousPosition':_0x1fe19d,'newPosition':_0x3c7c88,'isPromotion':_0x3c7c88<_0x1fe19d,'matchId':_0x108547,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x53f5d4,'previousElo':_0x22f691['eloRating']||0x4b0,'newElo':_0x4a8164,'opponentId':_0x3ff1fd,'matchResult':'loss','previousPosition':_0x32f9be,'newPosition':_0x4e3419,'isDemotion':_0x4e3419>_0x32f9be,'matchId':_0x108547,'timestamp':serverTimestamp()})]),await promotionManager[_0x3ec910(0x16c)](_0x3ff1fd,_0x2044dd,_0x7b58e4[_0x3ec910(0x159)],{'source':'match-d2','matchId':_0x108547}),await promotionManager[_0x3ec910(0x16c)](_0x53f5d4,_0x4a8164,_0x22f691['eloRating'],{'source':_0x3ec910(0x164),'matchId':_0x108547}),!![];}catch(_0x9d7e17){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x9d7e17);throw _0x9d7e17;}}export async function approveReportD2(_0x16c500,_0xc1c673,_0x8fdf47,_0x4544ce){const _0x18968c=a26_0x2e38;try{console[_0x18968c(0x170)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x16c500,'winnerScore':_0xc1c673,'winnerSuicides':_0x8fdf47,'winnerComment':_0x4544ce});const _0x24eb63=auth[_0x18968c(0x163)];if(!_0x24eb63){console[_0x18968c(0x170)]('No\x20user\x20logged\x20in');throw new Error(_0x18968c(0x168));}console['log'](_0x18968c(0x160),_0x24eb63[_0x18968c(0x15f)]);const _0x47fa5d=await getDoc(doc(db,'playersD2',_0x24eb63['uid'])),_0xc55317=_0x47fa5d[_0x18968c(0x16d)]()?_0x47fa5d[_0x18968c(0x15a)]()[_0x18968c(0x167)]:null;console['log']('Current\x20username:',_0xc55317);const _0x2a0f4a=doc(db,'pendingMatchesD2',_0x16c500),_0x3f5fdd=await getDoc(_0x2a0f4a);if(!_0x3f5fdd['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x16c500);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x472095=_0x3f5fdd['data']();console['log']('D2\x20Report\x20data:',_0x472095);if(_0xc55317!==_0x472095[_0x18968c(0x165)])throw new Error(_0x18968c(0x169));const _0x43c356={..._0x472095,'winnerScore':_0xc1c673,'winnerSuicides':_0x8fdf47,'winnerComment':_0x4544ce,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0xc55317,'createdAt':_0x472095['createdAt']||serverTimestamp(),'winnerUsername':_0x472095[_0x18968c(0x165)],'loserUsername':_0x472095['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x16c500),_0x43c356),await deleteDoc(_0x2a0f4a),console[_0x18968c(0x170)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x85c5cc,_0x232095]=await Promise[_0x18968c(0x15e)]([getDocs(query(collection(db,'playersD2'),where('username','==',_0x472095[_0x18968c(0x165)]))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x472095['loserUsername'])))]);if(_0x85c5cc['empty']||_0x232095['empty'])throw new Error(_0x18968c(0x16f));const _0x29bc52=_0x85c5cc['docs'][0x0]['id'],_0x4b401a=_0x232095[_0x18968c(0x15c)][0x0]['id'];return await updateEloRatingsD2(_0x29bc52,_0x4b401a,_0x16c500),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x26f2d7){console['error']('Error\x20in\x20approveReportD2:',_0x26f2d7);throw _0x26f2d7;}}