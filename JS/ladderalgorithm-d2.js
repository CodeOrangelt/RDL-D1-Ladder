const a26_0x5d3636=(function(){let _0x160a9a=!![];return function(_0x58bf92,_0x2b3fc8){const _0x119ba2=_0x160a9a?function(){const _0x36cc13=a26_0x2a46;if(_0x2b3fc8){const _0x2af58b=_0x2b3fc8[_0x36cc13(0xb9)](_0x58bf92,arguments);return _0x2b3fc8=null,_0x2af58b;}}:function(){};return _0x160a9a=![],_0x119ba2;};}()),a26_0x5af4bc=a26_0x5d3636(this,function(){const _0x536540=a26_0x2a46;let _0x36be59;try{const _0x3976e2=Function(_0x536540(0xbb)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x36be59=_0x3976e2();}catch(_0x556477){_0x36be59=window;}const _0x9c51d5=_0x36be59[_0x536540(0xc0)]=_0x36be59[_0x536540(0xc0)]||{},_0xfa795a=['log','warn','info',_0x536540(0xb6),'exception','table','trace'];for(let _0x5add3b=0x0;_0x5add3b<_0xfa795a[_0x536540(0xb3)];_0x5add3b++){const _0xc8e82e=a26_0x5d3636['constructor']['prototype']['bind'](a26_0x5d3636),_0x1d01fd=_0xfa795a[_0x5add3b],_0x5432b9=_0x9c51d5[_0x1d01fd]||_0xc8e82e;_0xc8e82e['__proto__']=a26_0x5d3636['bind'](a26_0x5d3636),_0xc8e82e['toString']=_0x5432b9['toString']['bind'](_0x5432b9),_0x9c51d5[_0x1d01fd]=_0xc8e82e;}});a26_0x5af4bc();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a26_0x2a46(_0x2ec7c6,_0x1d28ae){const _0x5af4bc=a26_0x5502();return a26_0x2a46=function(_0x5d3636,_0x204b83){_0x5d3636=_0x5d3636-0xae;let _0x550272=_0x5af4bc[_0x5d3636];return _0x550272;},a26_0x2a46(_0x2ec7c6,_0x1d28ae);}import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x4d35ff from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x57845b,_0x50068e,_0x74b3ac=0x20){const _0x2e4f5f=a26_0x2a46,_0x4b41f9=0x1/(0x1+Math[_0x2e4f5f(0xb2)](0xa,(_0x50068e-_0x57845b)/0x190)),_0x4e300e=0x1/(0x1+Math['pow'](0xa,(_0x57845b-_0x50068e)/0x190)),_0x53555d=_0x57845b+_0x74b3ac*(0x1-_0x4b41f9),_0x4e136b=_0x50068e+_0x74b3ac*(0x0-_0x4e300e);return{'newWinnerRating':Math['round'](_0x53555d),'newLoserRating':Math[_0x2e4f5f(0xb0)](_0x4e136b)};}function a26_0x5502(){const _0xc94a89=['username','currentUser','round','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','pow','length','playersD2','docs','error','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','commit','apply','email','return\x20(function()\x20','loserUsername','exists','checkAndRecordPromotion','Error\x20in\x20updateEloRatingsD2:','console','winnerUsername','update','log','pendingMatchesD2','position','eloRating','MAX_SAFE_INTEGER'];a26_0x5502=function(){return _0xc94a89;};return a26_0x5502();}export async function updateEloRatingsD2(_0x1dcb92,_0x48849a,_0x4b6851){const _0x2040ae=a26_0x2a46;try{const _0x341ab1=writeBatch(db),_0xe7995c=doc(db,'playersD2',_0x1dcb92),_0x264691=doc(db,'playersD2',_0x48849a),[_0x81edde,_0x4fbd90]=await Promise['all']([getDoc(_0xe7995c),getDoc(_0x264691)]);if(!_0x81edde['exists']()||!_0x4fbd90['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x5ae134=_0x81edde['data'](),_0x4aff9c=_0x4fbd90['data'](),_0x286edd=_0x5ae134[_0x2040ae(0xc5)]||Number[_0x2040ae(0xc7)],_0x25b192=_0x4aff9c['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x2cc8b3,newLoserRating:_0x4e2307}=calculateEloD2(_0x5ae134['eloRating']||0x4b0,_0x4aff9c[_0x2040ae(0xc6)]||0x4b0);let _0x4360d9=_0x286edd,_0x1ad8aa=_0x25b192;if(_0x286edd>_0x25b192){console['log'](_0x2040ae(0xb7)),_0x4360d9=_0x25b192,_0x1ad8aa=_0x25b192+0x1;const _0x61b71e=query(collection(db,'playersD2'),where('position','>',_0x25b192),where(_0x2040ae(0xc5),'<',_0x286edd)),_0x21e6a4=await getDocs(_0x61b71e);for(const _0x15482a of _0x21e6a4['docs']){_0x15482a['id']!==_0x1dcb92&&_0x15482a['id']!==_0x48849a&&_0x341ab1['update'](doc(db,'playersD2',_0x15482a['id']),{'position':_0x15482a['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x341ab1[_0x2040ae(0xc2)](_0xe7995c,{'eloRating':_0x2cc8b3,'lastMatchDate':serverTimestamp(),'position':_0x4360d9,'lastMatchId':_0x4b6851}),_0x341ab1[_0x2040ae(0xc2)](_0x264691,{'eloRating':_0x4e2307,'lastMatchDate':serverTimestamp(),'position':_0x1ad8aa,'lastMatchId':_0x4b6851}),await _0x341ab1[_0x2040ae(0xb8)](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x1dcb92,'previousElo':_0x5ae134[_0x2040ae(0xc6)]||0x4b0,'newElo':_0x2cc8b3,'opponentId':_0x48849a,'matchResult':'win','previousPosition':_0x286edd,'newPosition':_0x4360d9,'isPromotion':_0x4360d9<_0x286edd,'matchId':_0x4b6851,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x48849a,'previousElo':_0x4aff9c['eloRating']||0x4b0,'newElo':_0x4e2307,'opponentId':_0x1dcb92,'matchResult':'loss','previousPosition':_0x25b192,'newPosition':_0x1ad8aa,'isDemotion':_0x1ad8aa>_0x25b192,'matchId':_0x4b6851,'timestamp':serverTimestamp()})]),await promotionManager[_0x2040ae(0xbe)](_0x1dcb92,_0x2cc8b3,_0x5ae134['eloRating'],{'source':'match-d2','matchId':_0x4b6851}),await promotionManager['checkAndRecordPromotion'](_0x48849a,_0x4e2307,_0x4aff9c['eloRating'],{'source':'match-d2','matchId':_0x4b6851}),!![];}catch(_0x3069d4){console[_0x2040ae(0xb6)](_0x2040ae(0xbf),_0x3069d4);throw _0x3069d4;}}export async function approveReportD2(_0x58f28e,_0x3c9647,_0x1809c5,_0x51aefc){const _0x195082=a26_0x2a46;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x58f28e,'winnerScore':_0x3c9647,'winnerSuicides':_0x1809c5,'winnerComment':_0x51aefc});const _0x3a367f=auth[_0x195082(0xaf)];if(!_0x3a367f){console[_0x195082(0xc3)]('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x3a367f[_0x195082(0xba)]);const _0x16f6bc=await getDoc(doc(db,'playersD2',_0x3a367f['uid'])),_0x31af45=_0x16f6bc[_0x195082(0xbd)]()?_0x16f6bc['data']()[_0x195082(0xae)]:null;console['log']('Current\x20username:',_0x31af45);const _0xcec9f4=doc(db,_0x195082(0xc4),_0x58f28e),_0x20747f=await getDoc(_0xcec9f4);if(!_0x20747f['exists']()){console[_0x195082(0xc3)]('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x58f28e);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x2d8cba=_0x20747f['data']();console['log']('D2\x20Report\x20data:',_0x2d8cba);if(_0x31af45!==_0x2d8cba['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x4c86b9={..._0x2d8cba,'winnerScore':_0x3c9647,'winnerSuicides':_0x1809c5,'winnerComment':_0x51aefc,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x31af45,'createdAt':_0x2d8cba['createdAt']||serverTimestamp(),'winnerUsername':_0x2d8cba[_0x195082(0xc1)],'loserUsername':_0x2d8cba[_0x195082(0xbc)]};await setDoc(doc(db,'approvedMatchesD2',_0x58f28e),_0x4c86b9),await deleteDoc(_0xcec9f4),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x300caf,_0x362d3a]=await Promise['all']([getDocs(query(collection(db,_0x195082(0xb4)),where(_0x195082(0xae),'==',_0x2d8cba['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x2d8cba['loserUsername'])))]);if(_0x300caf['empty']||_0x362d3a['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x172ba2=_0x300caf[_0x195082(0xb5)][0x0]['id'],_0x3da7e5=_0x362d3a[_0x195082(0xb5)][0x0]['id'];return await updateEloRatingsD2(_0x172ba2,_0x3da7e5,_0x58f28e),console[_0x195082(0xc3)](_0x195082(0xb1)),!![];}catch(_0x4df584){console['error']('Error\x20in\x20approveReportD2:',_0x4df584);throw _0x4df584;}}