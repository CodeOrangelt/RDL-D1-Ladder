const a28_0x3b19d8=(function(){let _0x1fdf36=!![];return function(_0x2251a0,_0x2b2623){const _0x58dfa0=_0x1fdf36?function(){if(_0x2b2623){const _0x220337=_0x2b2623['apply'](_0x2251a0,arguments);return _0x2b2623=null,_0x220337;}}:function(){};return _0x1fdf36=![],_0x58dfa0;};}()),a28_0x3f34a1=a28_0x3b19d8(this,function(){const _0x57cbb3=a28_0x97bb,_0x466184=function(){let _0x35ae42;try{_0x35ae42=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x3d1fe8){_0x35ae42=window;}return _0x35ae42;},_0x25ce28=_0x466184(),_0x29a1a5=_0x25ce28['console']=_0x25ce28[_0x57cbb3(0x1ca)]||{},_0x51a7a9=[_0x57cbb3(0x1d2),'warn',_0x57cbb3(0x1d4),'error',_0x57cbb3(0x1d5),'table','trace'];for(let _0x1d8cce=0x0;_0x1d8cce<_0x51a7a9['length'];_0x1d8cce++){const _0x1bc4e9=a28_0x3b19d8[_0x57cbb3(0x1d6)][_0x57cbb3(0x1d0)]['bind'](a28_0x3b19d8),_0x4a2550=_0x51a7a9[_0x1d8cce],_0x474444=_0x29a1a5[_0x4a2550]||_0x1bc4e9;_0x1bc4e9['__proto__']=a28_0x3b19d8['bind'](a28_0x3b19d8),_0x1bc4e9['toString']=_0x474444['toString']['bind'](_0x474444),_0x29a1a5[_0x4a2550]=_0x1bc4e9;}});function a28_0x5143(){const _0x1274d2=['eloRating','position','pow','winnerUsername','data','pendingMatchesD2','uid','checkAndRecordPromotion','Could\x20not\x20find\x20D2\x20player\x20documents','playersD2','loss','win','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','approvedMatchesD2','No\x20user\x20logged\x20in','round','error','console','loserUsername','D2\x20Report\x20not\x20found\x20with\x20ID:','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','Current\x20username:','empty','prototype','D2\x20ELO\x20ratings\x20updated\x20successfully','log','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','info','exception','constructor'];a28_0x5143=function(){return _0x1274d2;};return a28_0x5143();}a28_0x3f34a1();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a28_0x97bb(_0x9a84dc,_0xabbfef){const _0x3f34a1=a28_0x5143();return a28_0x97bb=function(_0x3b19d8,_0x43be6d){_0x3b19d8=_0x3b19d8-0x1b9;let _0x5143f7=_0x3f34a1[_0x3b19d8];return _0x5143f7;},a28_0x97bb(_0x9a84dc,_0xabbfef);}import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x52b4b0 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x51b304,_0x65acad,_0x5d3240=0x20){const _0x1e05d6=a28_0x97bb,_0x58ac96=0x1/(0x1+Math[_0x1e05d6(0x1bb)](0xa,(_0x65acad-_0x51b304)/0x190)),_0x38bb7e=0x1/(0x1+Math[_0x1e05d6(0x1bb)](0xa,(_0x51b304-_0x65acad)/0x190)),_0x385aa1=_0x51b304+_0x5d3240*(0x1-_0x58ac96),_0x2a37f3=_0x65acad+_0x5d3240*(0x0-_0x38bb7e);return{'newWinnerRating':Math['round'](_0x385aa1),'newLoserRating':Math[_0x1e05d6(0x1c8)](_0x2a37f3)};}export async function updateEloRatingsD2(_0x220bd8,_0x278aea,_0x3eb05f){const _0xbdb997=a28_0x97bb;try{const _0x3e2bd7=writeBatch(db),_0xbd45c7=doc(db,'playersD2',_0x220bd8),_0x21e41f=doc(db,'playersD2',_0x278aea),[_0x94d093,_0xeb972b]=await Promise['all']([getDoc(_0xbd45c7),getDoc(_0x21e41f)]);if(!_0x94d093['exists']()||!_0xeb972b['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x2c289d=_0x94d093[_0xbdb997(0x1bd)](),_0x52139b=_0xeb972b['data'](),_0x3d2376=_0x2c289d['position']||Number['MAX_SAFE_INTEGER'],_0x193319=_0x52139b['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x1a9072,newLoserRating:_0x1e3ebc}=calculateEloD2(_0x2c289d['eloRating']||0x4b0,_0x52139b['eloRating']||0x4b0);let _0xf99f58=_0x3d2376,_0x31f129=_0x193319;if(_0x3d2376>_0x193319){console[_0xbdb997(0x1d2)](_0xbdb997(0x1d3)),_0xf99f58=_0x193319,_0x31f129=_0x193319+0x1;const _0x4db88b=query(collection(db,'playersD2'),where('position','>',_0x193319),where('position','<',_0x3d2376)),_0x524464=await getDocs(_0x4db88b);for(const _0x391ef1 of _0x524464['docs']){_0x391ef1['id']!==_0x220bd8&&_0x391ef1['id']!==_0x278aea&&_0x3e2bd7['update'](doc(db,'playersD2',_0x391ef1['id']),{'position':_0x391ef1['data']()[_0xbdb997(0x1ba)]+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x3e2bd7['update'](_0xbd45c7,{'eloRating':_0x1a9072,'lastMatchDate':serverTimestamp(),'position':_0xf99f58,'lastMatchId':_0x3eb05f}),_0x3e2bd7['update'](_0x21e41f,{'eloRating':_0x1e3ebc,'lastMatchDate':serverTimestamp(),'position':_0x31f129,'lastMatchId':_0x3eb05f}),await _0x3e2bd7['commit'](),console['log'](_0xbdb997(0x1d1)),await Promise['all']([recordEloChangeD2({'playerId':_0x220bd8,'previousElo':_0x2c289d['eloRating']||0x4b0,'newElo':_0x1a9072,'opponentId':_0x278aea,'matchResult':_0xbdb997(0x1c4),'previousPosition':_0x3d2376,'newPosition':_0xf99f58,'isPromotion':_0xf99f58<_0x3d2376,'matchId':_0x3eb05f,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x278aea,'previousElo':_0x52139b[_0xbdb997(0x1b9)]||0x4b0,'newElo':_0x1e3ebc,'opponentId':_0x220bd8,'matchResult':_0xbdb997(0x1c3),'previousPosition':_0x193319,'newPosition':_0x31f129,'isDemotion':_0x31f129>_0x193319,'matchId':_0x3eb05f,'timestamp':serverTimestamp()})]),await promotionManager[_0xbdb997(0x1c0)](_0x220bd8,_0x1a9072,_0x2c289d['eloRating'],{'source':'match-d2','matchId':_0x3eb05f}),await promotionManager[_0xbdb997(0x1c0)](_0x278aea,_0x1e3ebc,_0x52139b[_0xbdb997(0x1b9)],{'source':'match-d2','matchId':_0x3eb05f}),!![];}catch(_0xcfbb77){console[_0xbdb997(0x1c9)]('Error\x20in\x20updateEloRatingsD2:',_0xcfbb77);throw _0xcfbb77;}}export async function approveReportD2(_0x50c2a0,_0x4f3753,_0x493796,_0x433bff){const _0x29880f=a28_0x97bb;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x50c2a0,'winnerScore':_0x4f3753,'winnerSuicides':_0x493796,'winnerComment':_0x433bff});const _0x595bd7=auth['currentUser'];if(!_0x595bd7){console['log'](_0x29880f(0x1c7));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x595bd7['email']);const _0x3db669=await getDoc(doc(db,'playersD2',_0x595bd7[_0x29880f(0x1bf)])),_0x3377cd=_0x3db669['exists']()?_0x3db669['data']()['username']:null;console['log'](_0x29880f(0x1ce),_0x3377cd);const _0x262df8=doc(db,_0x29880f(0x1be),_0x50c2a0),_0x5877b5=await getDoc(_0x262df8);if(!_0x5877b5['exists']()){console['log'](_0x29880f(0x1cc),_0x50c2a0);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x5093bd=_0x5877b5[_0x29880f(0x1bd)]();console[_0x29880f(0x1d2)]('D2\x20Report\x20data:',_0x5093bd);if(_0x3377cd!==_0x5093bd[_0x29880f(0x1bc)])throw new Error(_0x29880f(0x1cd));const _0x12fdf9={..._0x5093bd,'winnerScore':_0x4f3753,'winnerSuicides':_0x493796,'winnerComment':_0x433bff,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x3377cd,'createdAt':_0x5093bd['createdAt']||serverTimestamp(),'winnerUsername':_0x5093bd[_0x29880f(0x1bc)],'loserUsername':_0x5093bd[_0x29880f(0x1cb)]};await setDoc(doc(db,_0x29880f(0x1c6),_0x50c2a0),_0x12fdf9),await deleteDoc(_0x262df8),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x4324aa,_0x49e90a]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x5093bd[_0x29880f(0x1bc)]))),getDocs(query(collection(db,_0x29880f(0x1c2)),where('username','==',_0x5093bd['loserUsername'])))]);if(_0x4324aa[_0x29880f(0x1cf)]||_0x49e90a['empty'])throw new Error(_0x29880f(0x1c1));const _0x3a872f=_0x4324aa['docs'][0x0]['id'],_0x4819bb=_0x49e90a['docs'][0x0]['id'];return await updateEloRatingsD2(_0x3a872f,_0x4819bb,_0x50c2a0),console['log'](_0x29880f(0x1c5)),!![];}catch(_0x3ee203){console['error']('Error\x20in\x20approveReportD2:',_0x3ee203);throw _0x3ee203;}}