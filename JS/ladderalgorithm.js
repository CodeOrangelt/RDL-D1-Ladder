const a30_0x6d4e97=(function(){let _0x3fb570=!![];return function(_0x38dc81,_0x2c0c18){const _0x105aaf=_0x3fb570?function(){const _0x241f92=a30_0x3499;if(_0x2c0c18){const _0x47d4c3=_0x2c0c18[_0x241f92(0x170)](_0x38dc81,arguments);return _0x2c0c18=null,_0x47d4c3;}}:function(){};return _0x3fb570=![],_0x105aaf;};}()),a30_0xe591d9=a30_0x6d4e97(this,function(){const _0xdf73ec=a30_0x3499;let _0x2b2954;try{const _0x25d702=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x2b2954=_0x25d702();}catch(_0x29e9f5){_0x2b2954=window;}const _0xedb427=_0x2b2954['console']=_0x2b2954[_0xdf73ec(0x167)]||{},_0x3ba95a=['log','warn','info','error','exception','table','trace'];for(let _0x40146d=0x0;_0x40146d<_0x3ba95a['length'];_0x40146d++){const _0x35adde=a30_0x6d4e97['constructor'][_0xdf73ec(0x172)][_0xdf73ec(0x176)](a30_0x6d4e97),_0x428e95=_0x3ba95a[_0x40146d],_0xf2a0fa=_0xedb427[_0x428e95]||_0x35adde;_0x35adde[_0xdf73ec(0x16c)]=a30_0x6d4e97['bind'](a30_0x6d4e97),_0x35adde['toString']=_0xf2a0fa[_0xdf73ec(0x17d)]['bind'](_0xf2a0fa),_0xedb427[_0x428e95]=_0x35adde;}});function a30_0x5a7f(){const _0x58fbf9=['losses','error','collection','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','players','eloRating','then','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','log','console','wins','doc','Match\x20moved\x20to\x20approved\x20collection','loserScore','__proto__','playerStats','position','checkAndRecordPromotion','apply','Could\x20not\x20find\x20player\x20documents','prototype','loserUsername','uid','commit','bind','ELO\x20ratings\x20updated\x20successfully','winRate','docs','update','match','toISOString','toString','pow','winnerUsername','totalDeaths'];a30_0x5a7f=function(){return _0x58fbf9;};return a30_0x5a7f();}a30_0xe591d9();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x251290,_0x542cc4,_0xdbfee3=0x20){const _0x3d4522=a30_0x3499,_0xb428a7=0x1/(0x1+Math[_0x3d4522(0x17e)](0xa,(_0x542cc4-_0x251290)/0x190)),_0x28ba5b=0x1/(0x1+Math['pow'](0xa,(_0x251290-_0x542cc4)/0x190)),_0xe4508e=_0x251290+_0xdbfee3*(0x1-_0xb428a7),_0x164215=_0x542cc4+_0xdbfee3*(0x0-_0x28ba5b);return{'newWinnerRating':Math['round'](_0xe4508e),'newLoserRating':Math['round'](_0x164215)};}export function assignDefaultEloRating(_0x396f78,_0x6b2190){const _0xdd58b4=a30_0x3499,_0x59dbcb=0x4b0;!_0x6b2190['eloRating']&&db[_0xdd58b4(0x160)]('players')[_0xdd58b4(0x169)](_0x396f78)['update']({'eloRating':_0x59dbcb})[_0xdd58b4(0x164)](()=>{const _0x188838=_0xdd58b4;console['log'](_0x188838(0x165)+_0x6b2190['username']);})['catch'](_0x4ac9a3=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x4ac9a3);});}function a30_0x3499(_0x1fe849,_0x100fb2){const _0xe591d9=a30_0x5a7f();return a30_0x3499=function(_0x6d4e97,_0x191159){_0x6d4e97=_0x6d4e97-0x15e;let _0x5a7fad=_0xe591d9[_0x6d4e97];return _0x5a7fad;},a30_0x3499(_0x1fe849,_0x100fb2);}export async function updateEloRatings(_0x581b3f,_0x2de252,_0x114ac5){const _0x488e07=a30_0x3499;try{const _0x18452d=writeBatch(db),_0x5c510e=doc(db,'players',_0x581b3f),_0x45cf75=doc(db,'players',_0x2de252),[_0x49b403,_0x48ebe0]=await Promise['all']([getDoc(_0x5c510e),getDoc(_0x45cf75)]);if(!_0x49b403['exists']()||!_0x48ebe0['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x1c10b5=_0x49b403['data'](),_0x3d8fa5=_0x48ebe0['data'](),_0xd49181=_0x1c10b5[_0x488e07(0x16e)]||Number['MAX_SAFE_INTEGER'],_0x402aba=_0x3d8fa5['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x1bff51,newLoserRating:_0x1e0999}=calculateElo(_0x1c10b5[_0x488e07(0x163)]||0x4b0,_0x3d8fa5['eloRating']||0x4b0);let _0x22082f=_0xd49181,_0x5cf872=_0x402aba;if(_0xd49181>_0x402aba){console['log'](_0x488e07(0x161)),_0x22082f=_0x402aba,_0x5cf872=_0x402aba+0x1;const _0x33beb4=query(collection(db,'players'),where('position','>',_0x402aba),where('position','<',_0xd49181)),_0x594792=await getDocs(_0x33beb4);for(const _0x3e7427 of _0x594792['docs']){_0x3e7427['id']!==_0x581b3f&&_0x3e7427['id']!==_0x2de252&&_0x18452d[_0x488e07(0x17a)](doc(db,_0x488e07(0x162),_0x3e7427['id']),{'position':_0x3e7427['data']()['position']+0x1});}}else console[_0x488e07(0x166)]('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x1f8053={'eloRating':_0x1bff51,'lastMatchDate':serverTimestamp(),'position':_0x22082f,'lastMatchId':_0x114ac5},_0x1209bc={'eloRating':_0x1e0999,'lastMatchDate':serverTimestamp(),'position':_0x5cf872,'lastMatchId':_0x114ac5};return _0x18452d[_0x488e07(0x17a)](_0x5c510e,_0x1f8053),_0x18452d['update'](_0x45cf75,_0x1209bc),await _0x18452d[_0x488e07(0x175)](),console['log'](_0x488e07(0x177)),await Promise['all']([recordEloChange({'playerId':_0x581b3f,'previousElo':_0x1c10b5[_0x488e07(0x163)]||0x4b0,'newElo':_0x1bff51,'opponentId':_0x2de252,'matchResult':'win','previousPosition':_0xd49181,'newPosition':_0x22082f,'isPromotion':_0x22082f<_0xd49181,'matchId':_0x114ac5,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x2de252,'previousElo':_0x3d8fa5['eloRating']||0x4b0,'newElo':_0x1e0999,'opponentId':_0x581b3f,'matchResult':'loss','previousPosition':_0x402aba,'newPosition':_0x5cf872,'isDemotion':_0x5cf872>_0x402aba,'matchId':_0x114ac5,'timestamp':serverTimestamp()})]),await promotionManager[_0x488e07(0x16f)](_0x581b3f,_0x1bff51,_0x1c10b5['eloRating'],{'source':'match','matchId':_0x114ac5}),await promotionManager['checkAndRecordPromotion'](_0x2de252,_0x1e0999,_0x3d8fa5['eloRating'],{'source':_0x488e07(0x17b),'matchId':_0x114ac5}),console[_0x488e07(0x166)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x4eab6c){console[_0x488e07(0x15f)]('Error\x20in\x20updateEloRatings:',_0x4eab6c);throw _0x4eab6c;}}export async function approveReport(_0x3b6a91,_0xa94d75,_0x380dc3,_0x48d1ac,_0xc167e6){const _0x318cb4=a30_0x3499;try{const _0x14ce6d=doc(db,'pendingMatches',_0x3b6a91),_0x53989c=await getDoc(_0x14ce6d);if(!_0x53989c['exists']())throw new Error('Report\x20not\x20found');const _0x3a885c=_0x53989c['data'](),_0x4ad2bf={..._0x3a885c,'winnerScore':_0xa94d75,'winnerSuicides':_0x380dc3,'winnerComment':_0x48d1ac,'winnerDemoLink':_0xc167e6,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x318cb4(0x174)]};await setDoc(doc(db,'approvedMatches',_0x3b6a91),_0x4ad2bf),await deleteDoc(_0x14ce6d),console['log'](_0x318cb4(0x16a));const [_0x236a27,_0xbb18b7]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x3a885c[_0x318cb4(0x17f)]))),getDocs(query(collection(db,'players'),where('username','==',_0x3a885c[_0x318cb4(0x173)])))]);if(_0x236a27['empty']||_0xbb18b7['empty'])throw new Error(_0x318cb4(0x171));const _0xc472ef=_0x236a27['docs'][0x0]['id'],_0x390820=_0xbb18b7[_0x318cb4(0x179)][0x0]['id'];await updateEloRatings(_0xc472ef,_0x390820,_0x3b6a91);try{await awardMatchPoints(_0xc472ef,_0x390820,_0x3a885c['subgameType']);}catch(_0x5e8b5b){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x5e8b5b);}return console[_0x318cb4(0x166)]('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x372a20){console['error']('Error\x20approving\x20report:',_0x372a20);throw _0x372a20;}}async function updatePlayerElo(_0x30d6cb,_0x5de7f5,_0x342ca2){const _0x2abeaa=a30_0x3499;await setDoc(doc(db,_0x2abeaa(0x162),_0x30d6cb),{...playerData,'eloRating':_0x342ca2}),await checkAndRecordPromotion(_0x30d6cb,_0x342ca2,_0x5de7f5);}async function updatePlayerStats(_0x52be73,_0x23f3a3,_0x41e33d){const _0x23c388=a30_0x3499,_0x7ea328=doc(db,_0x23c388(0x16d),_0x52be73),_0x1a7554=await getDoc(_0x7ea328);let _0x177f7b=_0x1a7554['exists']()?_0x1a7554['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x41e33d?(_0x177f7b[_0x23c388(0x168)]++,_0x177f7b['totalKills']+=parseInt(_0x23f3a3['winnerScore']||0x0),_0x177f7b[_0x23c388(0x180)]+=parseInt(_0x23f3a3[_0x23c388(0x16b)]||0x0)):(_0x177f7b['losses']++,_0x177f7b['totalKills']+=parseInt(_0x23f3a3[_0x23c388(0x16b)]||0x0),_0x177f7b['totalDeaths']+=parseInt(_0x23f3a3['winnerScore']||0x0));const _0x3d67cd=_0x177f7b['wins']+_0x177f7b[_0x23c388(0x15e)];_0x177f7b[_0x23c388(0x178)]=_0x3d67cd>0x0?(_0x177f7b['wins']/_0x3d67cd*0x64)['toFixed'](0x1):0x0,_0x177f7b['lastUpdated']=new Date()[_0x23c388(0x17c)](),await setDoc(_0x7ea328,_0x177f7b,{'merge':!![]});}