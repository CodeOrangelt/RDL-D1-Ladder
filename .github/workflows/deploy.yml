name: Build and Deploy
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Upload files to VPS
        uses: appleboy/scp-action@v0.1.4
        with:
          host: 192.210.140.94
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "./*"
          target: "/var/www/html/"
          strip_components: 0

      - name: Configure web server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 192.210.140.94
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            # Install nginx if not present
            apt update && apt install -y nginx
            
            # Configure nginx to serve from HTML directory but allow access to root assets
            cat > /etc/nginx/sites-available/default << 'EOF'
            server {
                listen 80 default_server;
                root /var/www/html;
                index index.html;
                server_name _;
                
                # Serve HTML files from /HTML/ directory as if they're at root
                location / {
                    try_files /HTML$uri /HTML$uri/ /HTML$uri.html =404;
                }
                
                # Serve CSS, JS, images directly from root
                location ~ ^/(CSS|JS|images)/ {
                    try_files $uri =404;
                }
            }
            EOF
            
            # Set permissions and start nginx
            chown -R www-data:www-data /var/www/html
            chmod -R 755 /var/www/html
            systemctl enable nginx
            systemctl restart nginx
            
            # Debug: Show what files are actually there
            echo "=== Files on VPS ==="
            ls -la /var/www/html/
            echo "=== CSS directory ==="
            ls -la /var/www/html/CSS/ || echo "No CSS directory"
            echo "=== HTML directory ==="
            ls -la /var/www/html/HTML/ || echo "No HTML directory"