function a30_0x317b(_0x5dd695,_0x265ebf){const _0x41852d=a30_0x20b8();return a30_0x317b=function(_0x271fce,_0x354e12){_0x271fce=_0x271fce-0x184;let _0x20b8a7=_0x41852d[_0x271fce];return _0x20b8a7;},a30_0x317b(_0x5dd695,_0x265ebf);}const a30_0x271fce=(function(){let _0x4fd95d=!![];return function(_0xa37db7,_0x1c1646){const _0xda1814=_0x4fd95d?function(){const _0x2dfa10=a30_0x317b;if(_0x1c1646){const _0x38c032=_0x1c1646[_0x2dfa10(0x1a2)](_0xa37db7,arguments);return _0x1c1646=null,_0x38c032;}}:function(){};return _0x4fd95d=![],_0xda1814;};}()),a30_0x41852d=a30_0x271fce(this,function(){const _0x262e15=a30_0x317b;let _0x242efe;try{const _0x91abe5=Function(_0x262e15(0x1a6)+_0x262e15(0x19b)+');');_0x242efe=_0x91abe5();}catch(_0x38cc1c){_0x242efe=window;}const _0xd64c16=_0x242efe['console']=_0x242efe['console']||{},_0x1664c4=['log','warn','info','error','exception','table',_0x262e15(0x184)];for(let _0x1f2e38=0x0;_0x1f2e38<_0x1664c4['length'];_0x1f2e38++){const _0x1a3ef3=a30_0x271fce[_0x262e15(0x18c)]['prototype']['bind'](a30_0x271fce),_0xd6e77e=_0x1664c4[_0x1f2e38],_0x162317=_0xd64c16[_0xd6e77e]||_0x1a3ef3;_0x1a3ef3['__proto__']=a30_0x271fce[_0x262e15(0x18e)](a30_0x271fce),_0x1a3ef3['toString']=_0x162317['toString']['bind'](_0x162317),_0xd64c16[_0xd6e77e]=_0x1a3ef3;}});a30_0x41852d();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x3e6fe8,_0x58b803,_0x329c44=0x20){const _0x3f08c6=a30_0x317b,_0x598377=0x1/(0x1+Math[_0x3f08c6(0x197)](0xa,(_0x58b803-_0x3e6fe8)/0x190)),_0x26016f=0x1/(0x1+Math[_0x3f08c6(0x197)](0xa,(_0x3e6fe8-_0x58b803)/0x190)),_0x7a3b45=_0x3e6fe8+_0x329c44*(0x1-_0x598377),_0x4bf192=_0x58b803+_0x329c44*(0x0-_0x26016f);return{'newWinnerRating':Math[_0x3f08c6(0x194)](_0x7a3b45),'newLoserRating':Math[_0x3f08c6(0x194)](_0x4bf192)};}export function assignDefaultEloRating(_0x14029e,_0x5190bf){const _0x5dde17=a30_0x317b,_0x1398c7=0x4b0;!_0x5190bf['eloRating']&&db[_0x5dde17(0x18f)]('players')['doc'](_0x14029e)['update']({'eloRating':_0x1398c7})[_0x5dde17(0x19f)](()=>{const _0x37f28e=_0x5dde17;console['log'](_0x37f28e(0x195)+_0x5190bf[_0x37f28e(0x18b)]);})['catch'](_0x5bb569=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x5bb569);});}export async function updateEloRatings(_0x501779,_0x47dcce,_0x2b2ff3){const _0x133dce=a30_0x317b;try{const _0x4720b5=writeBatch(db),_0x159323=doc(db,'players',_0x501779),_0x2fbba2=doc(db,'players',_0x47dcce),[_0x345378,_0x454f2a]=await Promise['all']([getDoc(_0x159323),getDoc(_0x2fbba2)]);if(!_0x345378['exists']()||!_0x454f2a[_0x133dce(0x190)]())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x39970b=_0x345378['data'](),_0x190f2f=_0x454f2a['data'](),_0x5dac08=_0x39970b['position']||Number['MAX_SAFE_INTEGER'],_0x450088=_0x190f2f[_0x133dce(0x199)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x3f3173,newLoserRating:_0x2b1910}=calculateElo(_0x39970b['eloRating']||0x4b0,_0x190f2f['eloRating']||0x4b0);let _0x3b3690=_0x5dac08,_0x380c3e=_0x450088;if(_0x5dac08>_0x450088){console[_0x133dce(0x1a8)]('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x3b3690=_0x450088,_0x380c3e=_0x450088+0x1;const _0x134f48=query(collection(db,_0x133dce(0x19e)),where(_0x133dce(0x199),'>',_0x450088),where('position','<',_0x5dac08)),_0x8d206f=await getDocs(_0x134f48);for(const _0x57fe2b of _0x8d206f['docs']){_0x57fe2b['id']!==_0x501779&&_0x57fe2b['id']!==_0x47dcce&&_0x4720b5['update'](doc(db,'players',_0x57fe2b['id']),{'position':_0x57fe2b['data']()[_0x133dce(0x199)]+0x1});}}else console[_0x133dce(0x1a8)]('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x261c8f={'eloRating':_0x3f3173,'lastMatchDate':serverTimestamp(),'position':_0x3b3690,'lastMatchId':_0x2b2ff3},_0x1d0d65={'eloRating':_0x2b1910,'lastMatchDate':serverTimestamp(),'position':_0x380c3e,'lastMatchId':_0x2b2ff3};return _0x4720b5['update'](_0x159323,_0x261c8f),_0x4720b5[_0x133dce(0x18d)](_0x2fbba2,_0x1d0d65),await _0x4720b5['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x133dce(0x19d)]([recordEloChange({'playerId':_0x501779,'previousElo':_0x39970b[_0x133dce(0x187)]||0x4b0,'newElo':_0x3f3173,'opponentId':_0x47dcce,'matchResult':_0x133dce(0x19a),'previousPosition':_0x5dac08,'newPosition':_0x3b3690,'isPromotion':_0x3b3690<_0x5dac08,'matchId':_0x2b2ff3,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x47dcce,'previousElo':_0x190f2f['eloRating']||0x4b0,'newElo':_0x2b1910,'opponentId':_0x501779,'matchResult':'loss','previousPosition':_0x450088,'newPosition':_0x380c3e,'isDemotion':_0x380c3e>_0x450088,'matchId':_0x2b2ff3,'timestamp':serverTimestamp()})]),await promotionManager[_0x133dce(0x1a4)](_0x501779,_0x3f3173,_0x39970b[_0x133dce(0x187)],{'source':'match','matchId':_0x2b2ff3}),await promotionManager['checkAndRecordPromotion'](_0x47dcce,_0x2b1910,_0x190f2f[_0x133dce(0x187)],{'source':'match','matchId':_0x2b2ff3}),console[_0x133dce(0x1a8)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x39455b){console['error']('Error\x20in\x20updateEloRatings:',_0x39455b);throw _0x39455b;}}function a30_0x20b8(){const _0x196b60=['trace','winnerUsername','empty','eloRating','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','\x20match\x20(Participant)','Unknown\x20User','username','constructor','update','bind','collection','exists','winnerScore','totalDeaths','wins','round','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','pendingMatches','pow','system-match-award','position','win','{}.constructor(\x22return\x20this\x22)(\x20)','losses','all','players','then','\x20match','Report\x20not\x20found','apply','warn','checkAndRecordPromotion','unknown','return\x20(function()\x20','totalKills','log'];a30_0x20b8=function(){return _0x196b60;};return a30_0x20b8();}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x4da0c5,_0x2faffb,_0x5631e5,_0xdd1741,_0x50cab8){const _0x3454b6=a30_0x317b;try{const _0x501272=doc(db,_0x3454b6(0x196),_0x4da0c5),_0x417739=await getDoc(_0x501272);if(!_0x417739['exists']())throw new Error(_0x3454b6(0x1a1));const _0x51dbe9=_0x417739['data'](),_0x5d50b8={..._0x51dbe9,'winnerScore':_0x2faffb,'winnerSuicides':_0x5631e5,'winnerComment':_0xdd1741,'winnerDemoLink':_0x50cab8,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x4da0c5),_0x5d50b8),await deleteDoc(_0x501272),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x35da57,_0x717dc6]=await Promise['all']([getDocs(query(collection(db,_0x3454b6(0x19e)),where('username','==',_0x51dbe9[_0x3454b6(0x185)]))),getDocs(query(collection(db,_0x3454b6(0x19e)),where('username','==',_0x51dbe9['loserUsername'])))]);if(_0x35da57[_0x3454b6(0x186)]||_0x717dc6['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x5b389c=_0x35da57['docs'][0x0]['id'],_0x4da626=_0x717dc6['docs'][0x0]['id'];await updateEloRatings(_0x5b389c,_0x4da626,_0x4da0c5);try{const _0x36b5af=_0x51dbe9['subgameType']||'Standard',_0x190501=POINTS_CHART[_0x36b5af]||0xa,_0x58bba7=doc(db,'userProfiles',_0x5b389c),_0x4d26f7=doc(db,'userProfiles',_0x4da626),[_0x2e7dbb,_0x2f376f]=await Promise[_0x3454b6(0x19d)]([getDoc(_0x58bba7),getDoc(_0x4d26f7)]);if(_0x2e7dbb['exists']()&&_0x2f376f[_0x3454b6(0x190)]()){const _0xf397b5=_0x2e7dbb['data'](),_0x49e659=_0x2f376f['data'](),_0x17d710=_0xf397b5['points']||0x0,_0x498544=_0x49e659['points']||0x0,_0x20d466=_0x17d710+_0x190501,_0x37b5fb=_0x498544+_0x190501;await Promise['all']([updateDoc(_0x58bba7,{'points':_0x20d466,'lastPointsModified':serverTimestamp()}),updateDoc(_0x4d26f7,{'points':_0x37b5fb,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,'pointsHistory'),{'userId':_0x5b389c,'userEmail':_0xf397b5['email']||_0x3454b6(0x1a5),'displayName':_0xf397b5['displayName']||_0xf397b5['username']||'Unknown\x20User','action':'add','amount':_0x190501,'previousPoints':_0x17d710,'newPoints':_0x20d466,'reason':'Match\x20points:\x20'+_0x36b5af+'\x20match\x20(Winner)','adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x4da626,'userEmail':_0x49e659['email']||'unknown','displayName':_0x49e659['displayName']||_0x49e659[_0x3454b6(0x18b)]||_0x3454b6(0x18a),'action':'add','amount':_0x190501,'previousPoints':_0x498544,'newPoints':_0x37b5fb,'reason':'Match\x20points:\x20'+_0x36b5af+_0x3454b6(0x189),'adminEmail':_0x3454b6(0x198),'timestamp':serverTimestamp()})]),console[_0x3454b6(0x1a8)]('Awarded\x20'+_0x190501+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x36b5af+_0x3454b6(0x1a0));}else console[_0x3454b6(0x1a3)]('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x26c334){console['warn'](_0x3454b6(0x188),_0x26c334);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x335512){console['error']('Error\x20approving\x20report:',_0x335512);throw _0x335512;}}async function updatePlayerElo(_0x4cb3cd,_0x119c36,_0x557e1){const _0x46f9b2=a30_0x317b;await setDoc(doc(db,_0x46f9b2(0x19e),_0x4cb3cd),{...playerData,'eloRating':_0x557e1}),await checkAndRecordPromotion(_0x4cb3cd,_0x557e1,_0x119c36);}async function updatePlayerStats(_0x399ef6,_0x2de1de,_0x5751aa){const _0x1a83b3=a30_0x317b,_0x5160a1=doc(db,'playerStats',_0x399ef6),_0x26fac3=await getDoc(_0x5160a1);let _0x1168a7=_0x26fac3['exists']()?_0x26fac3['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x5751aa?(_0x1168a7['wins']++,_0x1168a7[_0x1a83b3(0x1a7)]+=parseInt(_0x2de1de[_0x1a83b3(0x191)]||0x0),_0x1168a7[_0x1a83b3(0x192)]+=parseInt(_0x2de1de['loserScore']||0x0)):(_0x1168a7[_0x1a83b3(0x19c)]++,_0x1168a7['totalKills']+=parseInt(_0x2de1de['loserScore']||0x0),_0x1168a7[_0x1a83b3(0x192)]+=parseInt(_0x2de1de[_0x1a83b3(0x191)]||0x0));const _0x3522b4=_0x1168a7[_0x1a83b3(0x193)]+_0x1168a7[_0x1a83b3(0x19c)];_0x1168a7['winRate']=_0x3522b4>0x0?(_0x1168a7[_0x1a83b3(0x193)]/_0x3522b4*0x64)['toFixed'](0x1):0x0,_0x1168a7['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x5160a1,_0x1168a7,{'merge':!![]});}