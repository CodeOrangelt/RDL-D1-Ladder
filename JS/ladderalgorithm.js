const a28_0x558131=(function(){let _0x100ad7=!![];return function(_0x40cc99,_0x62c1aa){const _0x2c5969=_0x100ad7?function(){if(_0x62c1aa){const _0x99fa83=_0x62c1aa['apply'](_0x40cc99,arguments);return _0x62c1aa=null,_0x99fa83;}}:function(){};return _0x100ad7=![],_0x2c5969;};}()),a28_0x4e8bf9=a28_0x558131(this,function(){const _0x4fb9f4=a28_0x2661,_0x5962ab=function(){let _0x46cc04;try{_0x46cc04=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x48b20a){_0x46cc04=window;}return _0x46cc04;},_0x452131=_0x5962ab(),_0x13952d=_0x452131['console']=_0x452131['console']||{},_0x2f0ca4=['log','warn','info','error',_0x4fb9f4(0x92),'table','trace'];for(let _0x57dbe4=0x0;_0x57dbe4<_0x2f0ca4[_0x4fb9f4(0x98)];_0x57dbe4++){const _0x2b424d=a28_0x558131['constructor']['prototype']['bind'](a28_0x558131),_0x37af06=_0x2f0ca4[_0x57dbe4],_0x239002=_0x13952d[_0x37af06]||_0x2b424d;_0x2b424d['__proto__']=a28_0x558131[_0x4fb9f4(0x9e)](a28_0x558131),_0x2b424d[_0x4fb9f4(0x91)]=_0x239002['toString']['bind'](_0x239002),_0x13952d[_0x37af06]=_0x2b424d;}});function a28_0x2661(_0x3fb290,_0x56b1cd){const _0x4e8bf9=a28_0x18e1();return a28_0x2661=function(_0x558131,_0x4263a6){_0x558131=_0x558131-0x7e;let _0x18e1e2=_0x4e8bf9[_0x558131];return _0x18e1e2;},a28_0x2661(_0x3fb290,_0x56b1cd);}a28_0x4e8bf9();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{RANKS,getRankStyle}from'./ranks.js';export function calculateElo(_0x1fb2c9,_0x32f638,_0x39db8f=0x20){const _0x3fc0b3=a28_0x2661;_0x1fb2c9=_0x1fb2c9>0x3e8?0xc8:_0x1fb2c9,_0x32f638=_0x32f638>0x3e8?0xc8:_0x32f638;const _0xd20f04=0x1/(0x1+Math['pow'](0xa,(_0x32f638-_0x1fb2c9)/0x190)),_0x258716=0x1/(0x1+Math[_0x3fc0b3(0x9a)](0xa,(_0x1fb2c9-_0x32f638)/0x190)),_0x124f58=_0x1fb2c9+_0x39db8f*(0x1-_0xd20f04),_0x46f840=_0x32f638+_0x39db8f*(0x0-_0x258716);return{'newWinnerRating':Math['round'](Math['min'](_0x124f58)),'newLoserRating':Math[_0x3fc0b3(0x8b)](Math['max'](_0x46f840,0x0))};}export function assignDefaultEloRating(_0x84f4db,_0x40bcb0){const _0x834c9=a28_0x2661,_0x2f9a1e=0xc8;!_0x40bcb0[_0x834c9(0x94)]&&db['collection']('players')['doc'](_0x84f4db)['update']({'eloRating':_0x2f9a1e})['then'](()=>{const _0x10ee43=_0x834c9;console[_0x10ee43(0x81)]('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x40bcb0[_0x10ee43(0xa1)]);})[_0x834c9(0xa2)](_0x2cc0e2=>{const _0xf036d1=_0x834c9;console['error'](_0xf036d1(0x89),_0x2cc0e2);});}export async function updateEloRatings(_0x380bda,_0x52f4b0,_0x4762a5){const _0x3ac9be=a28_0x2661;try{const _0x1b0ef8=writeBatch(db),_0x103932=doc(db,_0x3ac9be(0x7f),_0x380bda),_0x3431b2=doc(db,'players',_0x52f4b0),[_0x19cc3c,_0x59ecd2]=await Promise['all']([getDoc(_0x103932),getDoc(_0x3431b2)]);if(!_0x19cc3c['exists']()||!_0x59ecd2['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0xd511db=_0x19cc3c['data'](),_0x4488e1=_0x59ecd2[_0x3ac9be(0xa4)](),_0x120a92=_0xd511db['position']||Number['MAX_SAFE_INTEGER'],_0x4c120a=_0x4488e1[_0x3ac9be(0x9d)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x298345,newLoserRating:_0xaff5b2}=calculateElo(_0xd511db['eloRating']||0x4b0,_0x4488e1[_0x3ac9be(0x94)]||0x4b0);let _0x3ba735=_0x120a92,_0x16bca4=_0x4c120a;if(_0x120a92>_0x4c120a){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x3ba735=_0x4c120a,_0x16bca4=_0x4c120a+0x1;const _0x587848=query(collection(db,'players'),where('position','>',_0x4c120a),where('position','<',_0x120a92)),_0x587c06=await getDocs(_0x587848);for(const _0x4a2008 of _0x587c06[_0x3ac9be(0xa7)]){_0x4a2008['id']!==_0x380bda&&_0x4a2008['id']!==_0x52f4b0&&_0x1b0ef8['update'](doc(db,'players',_0x4a2008['id']),{'position':_0x4a2008['data']()[_0x3ac9be(0x9d)]+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x5e52b2={'eloRating':_0x298345,'lastMatchDate':serverTimestamp(),'position':_0x3ba735,'lastMatchId':_0x4762a5},_0x5068fd={'eloRating':_0xaff5b2,'lastMatchDate':serverTimestamp(),'position':_0x16bca4,'lastMatchId':_0x4762a5};return _0x1b0ef8[_0x3ac9be(0x88)](_0x103932,_0x5e52b2),_0x1b0ef8[_0x3ac9be(0x88)](_0x3431b2,_0x5068fd),await _0x1b0ef8[_0x3ac9be(0x93)](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x380bda,'previousElo':_0xd511db['eloRating']||0x4b0,'newElo':_0x298345,'opponentId':_0x52f4b0,'matchResult':'win','previousPosition':_0x120a92,'newPosition':_0x3ba735,'isPromotion':_0x3ba735<_0x120a92,'matchId':_0x4762a5,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x52f4b0,'previousElo':_0x4488e1[_0x3ac9be(0x94)]||0x4b0,'newElo':_0xaff5b2,'opponentId':_0x380bda,'matchResult':_0x3ac9be(0x87),'previousPosition':_0x4c120a,'newPosition':_0x16bca4,'isDemotion':_0x16bca4>_0x4c120a,'matchId':_0x4762a5,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x380bda,_0x298345,_0xd511db['eloRating'],{'source':_0x3ac9be(0xa6),'matchId':_0x4762a5}),await promotionManager['checkAndRecordPromotion'](_0x52f4b0,_0xaff5b2,_0x4488e1['eloRating'],{'source':_0x3ac9be(0xa6),'matchId':_0x4762a5}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0xe5d70d){console['error']('Error\x20in\x20updateEloRatings:',_0xe5d70d);throw _0xe5d70d;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x4959ed,_0x177152,_0x5d067c,_0x27320d,_0x3c7e01){const _0x5bef0d=a28_0x2661;try{const _0x52cb23=doc(db,_0x5bef0d(0xa5),_0x4959ed),_0x2dd0b9=await getDoc(_0x52cb23);if(!_0x2dd0b9['exists']())throw new Error(_0x5bef0d(0x85));const _0x480f45=_0x2dd0b9['data'](),_0x34b3e2={..._0x480f45,'winnerScore':_0x177152,'winnerSuicides':_0x5d067c,'winnerComment':_0x27320d,'winnerDemoLink':_0x3c7e01,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth[_0x5bef0d(0x82)][_0x5bef0d(0x9b)]};await setDoc(doc(db,'approvedMatches',_0x4959ed),_0x34b3e2),await deleteDoc(_0x52cb23),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x86cdc4,_0x2a304d]=await Promise[_0x5bef0d(0xa3)]([getDocs(query(collection(db,'players'),where(_0x5bef0d(0xa1),'==',_0x480f45['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x480f45['loserUsername'])))]);if(_0x86cdc4[_0x5bef0d(0x9c)]||_0x2a304d['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x4a1aa7=_0x86cdc4['docs'][0x0]['id'],_0x1888d4=_0x2a304d['docs'][0x0]['id'];await updateEloRatings(_0x4a1aa7,_0x1888d4,_0x4959ed);try{const _0x520f2f=_0x480f45[_0x5bef0d(0x90)]||'Standard',_0x2cdd27=POINTS_CHART[_0x520f2f]||0xa,_0x513d00=doc(db,'userProfiles',_0x4a1aa7),_0x234460=doc(db,_0x5bef0d(0x8e),_0x1888d4),[_0x2a157d,_0x48ce14]=await Promise['all']([getDoc(_0x513d00),getDoc(_0x234460)]);if(_0x2a157d['exists']()&&_0x48ce14['exists']()){const _0x2c9878=_0x2a157d['data'](),_0x252f51=_0x48ce14['data'](),_0xb16367=_0x2c9878['points']||0x0,_0x2a0bee=_0x252f51[_0x5bef0d(0x84)]||0x0,_0x26bedd=_0xb16367+_0x2cdd27,_0xda93f4=_0x2a0bee+_0x2cdd27;await Promise[_0x5bef0d(0xa3)]([updateDoc(_0x513d00,{'points':_0x26bedd,'lastPointsModified':serverTimestamp()}),updateDoc(_0x234460,{'points':_0xda93f4,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,'pointsHistory'),{'userId':_0x4a1aa7,'userEmail':_0x2c9878[_0x5bef0d(0x96)]||_0x5bef0d(0x8f),'displayName':_0x2c9878['displayName']||_0x2c9878[_0x5bef0d(0xa1)]||'Unknown\x20User','action':_0x5bef0d(0xa8),'amount':_0x2cdd27,'previousPoints':_0xb16367,'newPoints':_0x26bedd,'reason':'Match\x20points:\x20'+_0x520f2f+_0x5bef0d(0xa0),'adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x1888d4,'userEmail':_0x252f51['email']||'unknown','displayName':_0x252f51['displayName']||_0x252f51['username']||_0x5bef0d(0x83),'action':_0x5bef0d(0xa8),'amount':_0x2cdd27,'previousPoints':_0x2a0bee,'newPoints':_0xda93f4,'reason':_0x5bef0d(0x8d)+_0x520f2f+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log'](_0x5bef0d(0x8a)+_0x2cdd27+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x520f2f+_0x5bef0d(0x9f));}else console[_0x5bef0d(0x97)]('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x118b4b){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x118b4b);}return console['log'](_0x5bef0d(0x80)),!![];}catch(_0x2c1944){console['error']('Error\x20approving\x20report:',_0x2c1944);throw _0x2c1944;}}async function updatePlayerElo(_0x193ce3,_0x5800d9,_0x570f59){const _0x587157=a28_0x2661,_0x48dc60=doc(db,'players',_0x193ce3),_0x2dbbae=await getDoc(_0x48dc60),_0x42203c=_0x2dbbae['data'](),_0x4b16ca=doc(db,_0x587157(0x99),_0x193ce3),_0x263b89=await getDoc(_0x4b16ca),_0x4fd299=_0x263b89['data']()||{'totalMatches':0x0,'winRate':0x0},_0x1dc91e=getRankStyle(_0x570f59,_0x4fd299['totalMatches'],_0x4fd299[_0x587157(0x7e)]);await updateDoc(_0x48dc60,{'eloRating':_0x570f59,'rank':_0x1dc91e['name'],'rankColor':_0x1dc91e['color']}),await checkAndRecordPromotion(_0x193ce3,_0x570f59,_0x5800d9,{'matchCount':_0x4fd299['totalMatches'],'winRate':_0x4fd299[_0x587157(0x7e)]});}async function updatePlayerStats(_0x2f51b5,_0x472a90,_0x586b4e){const _0x27da31=a28_0x2661,_0x560f2b=doc(db,'playerStats',_0x2f51b5),_0x1ef6a0=await getDoc(_0x560f2b);let _0x312ab6=_0x1ef6a0['exists']()?_0x1ef6a0['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x586b4e?(_0x312ab6['wins']++,_0x312ab6['totalKills']+=parseInt(_0x472a90['winnerScore']||0x0),_0x312ab6['totalDeaths']+=parseInt(_0x472a90['loserScore']||0x0)):(_0x312ab6[_0x27da31(0x86)]++,_0x312ab6[_0x27da31(0x8c)]+=parseInt(_0x472a90[_0x27da31(0x95)]||0x0),_0x312ab6['totalDeaths']+=parseInt(_0x472a90['winnerScore']||0x0));const _0xa798cd=_0x312ab6['wins']+_0x312ab6['losses'];_0x312ab6['winRate']=_0xa798cd>0x0?(_0x312ab6['wins']/_0xa798cd*0x64)['toFixed'](0x1):0x0,_0x312ab6['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x560f2b,_0x312ab6,{'merge':!![]});}function a28_0x18e1(){const _0x492cb5=['winRate','players','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','log','currentUser','Unknown\x20User','points','Report\x20not\x20found','losses','loss','update','Error\x20assigning\x20default\x20ELO\x20rating:','Awarded\x20','round','totalKills','Match\x20points:\x20','userProfiles','unknown','subgameType','toString','exception','commit','eloRating','loserScore','email','warn','length','playerStats','pow','uid','empty','position','bind','\x20match','\x20match\x20(Winner)','username','catch','all','data','pendingMatches','match','docs','add'];a28_0x18e1=function(){return _0x492cb5;};return a28_0x18e1();}