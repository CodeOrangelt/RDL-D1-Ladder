const a28_0x261573=(function(){let _0x343ec3=!![];return function(_0x13cda5,_0x3aba33){const _0x4bc100=_0x343ec3?function(){if(_0x3aba33){const _0x130787=_0x3aba33['apply'](_0x13cda5,arguments);return _0x3aba33=null,_0x130787;}}:function(){};return _0x343ec3=![],_0x4bc100;};}()),a28_0x6ad188=a28_0x261573(this,function(){const _0x14252a=a28_0x3634;let _0x26d1f2;try{const _0x3967eb=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x26d1f2=_0x3967eb();}catch(_0x5308a7){_0x26d1f2=window;}const _0x4e55f6=_0x26d1f2['console']=_0x26d1f2[_0x14252a(0x1b3)]||{},_0x2b18fd=[_0x14252a(0x1c2),'warn','info','error',_0x14252a(0x1a9),'table',_0x14252a(0x1ae)];for(let _0x38eee4=0x0;_0x38eee4<_0x2b18fd[_0x14252a(0x1b4)];_0x38eee4++){const _0x45d856=a28_0x261573['constructor']['prototype'][_0x14252a(0x1a5)](a28_0x261573),_0x4c5f81=_0x2b18fd[_0x38eee4],_0xf36b41=_0x4e55f6[_0x4c5f81]||_0x45d856;_0x45d856[_0x14252a(0x1b7)]=a28_0x261573[_0x14252a(0x1a5)](a28_0x261573),_0x45d856['toString']=_0xf36b41[_0x14252a(0x1aa)]['bind'](_0xf36b41),_0x4e55f6[_0x4c5f81]=_0x45d856;}});a28_0x6ad188();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a28_0x3634(_0x5d9bd2,_0x1e4f60){const _0x6ad188=a28_0x5f59();return a28_0x3634=function(_0x261573,_0x27b721){_0x261573=_0x261573-0x1a5;let _0x5f59f6=_0x6ad188[_0x261573];return _0x5f59f6;},a28_0x3634(_0x5d9bd2,_0x1e4f60);}function a28_0x5f59(){const _0x228385=['bind','D2\x20ELO\x20ratings\x20updated\x20successfully','empty','MAX_SAFE_INTEGER','exception','toString','position','update','data','trace','D2\x20Match\x20moved\x20to\x20approved\x20collection','uid','username','commit','console','length','pendingMatchesD2','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','__proto__','docs','D2\x20match\x20report\x20not\x20found','Error\x20in\x20approveReportD2:','exists','D2\x20Report\x20data:','loserUsername','winnerUsername','email','playersD2','eloRating','log','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','all'];a28_0x5f59=function(){return _0x228385;};return a28_0x5f59();}import a28_0x1919c7 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x4f9135,_0x3714b7,_0x1e7bce=0x20){const _0x1f78f3=0x1/(0x1+Math['pow'](0xa,(_0x3714b7-_0x4f9135)/0x190)),_0x5801e0=0x1/(0x1+Math['pow'](0xa,(_0x4f9135-_0x3714b7)/0x190)),_0x253975=_0x4f9135+_0x1e7bce*(0x1-_0x1f78f3),_0x5f0f66=_0x3714b7+_0x1e7bce*(0x0-_0x5801e0);return{'newWinnerRating':Math['round'](_0x253975),'newLoserRating':Math['round'](_0x5f0f66)};}export async function updateEloRatingsD2(_0x51ca94,_0xe1a3a3,_0x5ddac9){const _0x18d55b=a28_0x3634;try{const _0x8b8cac=writeBatch(db),_0xd6738d=doc(db,'playersD2',_0x51ca94),_0x5e2021=doc(db,'playersD2',_0xe1a3a3),[_0x3b6520,_0x44e717]=await Promise['all']([getDoc(_0xd6738d),getDoc(_0x5e2021)]);if(!_0x3b6520['exists']()||!_0x44e717[_0x18d55b(0x1bb)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x1a40af=_0x3b6520['data'](),_0xce96c9=_0x44e717['data'](),_0x189901=_0x1a40af[_0x18d55b(0x1ab)]||Number['MAX_SAFE_INTEGER'],_0x50788a=_0xce96c9[_0x18d55b(0x1ab)]||Number[_0x18d55b(0x1a8)],{newWinnerRating:_0x1023ff,newLoserRating:_0x1665b5}=calculateEloD2(_0x1a40af[_0x18d55b(0x1c1)]||0x4b0,_0xce96c9[_0x18d55b(0x1c1)]||0x4b0);let _0x351153=_0x189901,_0x5f3e4b=_0x50788a;if(_0x189901>_0x50788a){console['log'](_0x18d55b(0x1c3)),_0x351153=_0x50788a,_0x5f3e4b=_0x50788a+0x1;const _0x6693e5=query(collection(db,_0x18d55b(0x1c0)),where('position','>',_0x50788a),where('position','<',_0x189901)),_0x5bac0f=await getDocs(_0x6693e5);for(const _0x41444b of _0x5bac0f['docs']){_0x41444b['id']!==_0x51ca94&&_0x41444b['id']!==_0xe1a3a3&&_0x8b8cac[_0x18d55b(0x1ac)](doc(db,'playersD2',_0x41444b['id']),{'position':_0x41444b[_0x18d55b(0x1ad)]()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x8b8cac['update'](_0xd6738d,{'eloRating':_0x1023ff,'lastMatchDate':serverTimestamp(),'position':_0x351153,'lastMatchId':_0x5ddac9}),_0x8b8cac['update'](_0x5e2021,{'eloRating':_0x1665b5,'lastMatchDate':serverTimestamp(),'position':_0x5f3e4b,'lastMatchId':_0x5ddac9}),await _0x8b8cac[_0x18d55b(0x1b2)](),console['log'](_0x18d55b(0x1a6)),await Promise['all']([recordEloChangeD2({'playerId':_0x51ca94,'previousElo':_0x1a40af['eloRating']||0x4b0,'newElo':_0x1023ff,'opponentId':_0xe1a3a3,'matchResult':'win','previousPosition':_0x189901,'newPosition':_0x351153,'isPromotion':_0x351153<_0x189901,'matchId':_0x5ddac9,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0xe1a3a3,'previousElo':_0xce96c9[_0x18d55b(0x1c1)]||0x4b0,'newElo':_0x1665b5,'opponentId':_0x51ca94,'matchResult':'loss','previousPosition':_0x50788a,'newPosition':_0x5f3e4b,'isDemotion':_0x5f3e4b>_0x50788a,'matchId':_0x5ddac9,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x51ca94,_0x1023ff,_0x1a40af['eloRating'],{'source':'match-d2','matchId':_0x5ddac9}),await promotionManager['checkAndRecordPromotion'](_0xe1a3a3,_0x1665b5,_0xce96c9['eloRating'],{'source':'match-d2','matchId':_0x5ddac9}),!![];}catch(_0x4ab6eb){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x4ab6eb);throw _0x4ab6eb;}}export async function approveReportD2(_0x3bc347,_0x551c45,_0x4a9a17,_0x1d8028){const _0x158547=a28_0x3634;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x3bc347,'winnerScore':_0x551c45,'winnerSuicides':_0x4a9a17,'winnerComment':_0x1d8028});const _0x5b2a2b=auth['currentUser'];if(!_0x5b2a2b){console[_0x158547(0x1c2)]('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console[_0x158547(0x1c2)]('Current\x20user:',_0x5b2a2b[_0x158547(0x1bf)]);const _0x58f947=await getDoc(doc(db,_0x158547(0x1c0),_0x5b2a2b[_0x158547(0x1b0)])),_0x44763d=_0x58f947['exists']()?_0x58f947[_0x158547(0x1ad)]()['username']:null;console['log']('Current\x20username:',_0x44763d);const _0x25bc90=doc(db,_0x158547(0x1b5),_0x3bc347),_0xd278cc=await getDoc(_0x25bc90);if(!_0xd278cc['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x3bc347);throw new Error(_0x158547(0x1b9));}const _0x4e8335=_0xd278cc['data']();console['log'](_0x158547(0x1bc),_0x4e8335);if(_0x44763d!==_0x4e8335['winnerUsername'])throw new Error(_0x158547(0x1b6));const _0x256951={..._0x4e8335,'winnerScore':_0x551c45,'winnerSuicides':_0x4a9a17,'winnerComment':_0x1d8028,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x44763d,'createdAt':_0x4e8335['createdAt']||serverTimestamp(),'winnerUsername':_0x4e8335['winnerUsername'],'loserUsername':_0x4e8335['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x3bc347),_0x256951),await deleteDoc(_0x25bc90),console['log'](_0x158547(0x1af));const [_0x2c2b98,_0x4db135]=await Promise[_0x158547(0x1c4)]([getDocs(query(collection(db,_0x158547(0x1c0)),where('username','==',_0x4e8335[_0x158547(0x1be)]))),getDocs(query(collection(db,_0x158547(0x1c0)),where(_0x158547(0x1b1),'==',_0x4e8335[_0x158547(0x1bd)])))]);if(_0x2c2b98[_0x158547(0x1a7)]||_0x4db135['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x3a1cc5=_0x2c2b98[_0x158547(0x1b8)][0x0]['id'],_0x2acc55=_0x4db135['docs'][0x0]['id'];return await updateEloRatingsD2(_0x3a1cc5,_0x2acc55,_0x3bc347),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x196ae6){console['error'](_0x158547(0x1ba),_0x196ae6);throw _0x196ae6;}}