const a29_0x71164=(function(){let _0x17cc09=!![];return function(_0x575864,_0x4872a8){const _0x2ed807=_0x17cc09?function(){if(_0x4872a8){const _0x465e72=_0x4872a8['apply'](_0x575864,arguments);return _0x4872a8=null,_0x465e72;}}:function(){};return _0x17cc09=![],_0x2ed807;};}()),a29_0x8efb4d=a29_0x71164(this,function(){const _0x29fb78=a29_0x422f,_0x5aff6c=function(){let _0x2eb63d;try{_0x2eb63d=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x2dbed6){_0x2eb63d=window;}return _0x2eb63d;},_0x2ea9cc=_0x5aff6c(),_0x2bb504=_0x2ea9cc['console']=_0x2ea9cc['console']||{},_0x16b3bc=['log','warn',_0x29fb78(0x9c),_0x29fb78(0x9f),'exception','table','trace'];for(let _0x2ee20b=0x0;_0x2ee20b<_0x16b3bc[_0x29fb78(0xa5)];_0x2ee20b++){const _0x95cb7f=a29_0x71164['constructor']['prototype'][_0x29fb78(0xa4)](a29_0x71164),_0x57b4b8=_0x16b3bc[_0x2ee20b],_0x15d3c6=_0x2bb504[_0x57b4b8]||_0x95cb7f;_0x95cb7f['__proto__']=a29_0x71164['bind'](a29_0x71164),_0x95cb7f[_0x29fb78(0x91)]=_0x15d3c6[_0x29fb78(0x91)]['bind'](_0x15d3c6),_0x2bb504[_0x57b4b8]=_0x95cb7f;}});a29_0x8efb4d();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x40871f,_0x7a14b,_0x2e9421=0x20){const _0x10bc19=a29_0x422f,_0x4d0265=0x1/(0x1+Math[_0x10bc19(0x96)](0xa,(_0x7a14b-_0x40871f)/0x190)),_0x31d34b=0x1/(0x1+Math[_0x10bc19(0x96)](0xa,(_0x40871f-_0x7a14b)/0x190)),_0x24c952=_0x40871f+_0x2e9421*(0x1-_0x4d0265),_0x409b7c=_0x7a14b+_0x2e9421*(0x0-_0x31d34b);return{'newWinnerRating':Math['round'](_0x24c952),'newLoserRating':Math[_0x10bc19(0x97)](_0x409b7c)};}function a29_0x1a16(){const _0x51f264=['toString','D3\x20Report\x20not\x20found\x20with\x20ID:','docs','Current\x20username:','MAX_SAFE_INTEGER','pow','round','D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','pendingMatchesD3','No\x20user\x20logged\x20in','Could\x20not\x20find\x20D3\x20player\x20documents','info','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','currentUser','error','loserUsername','winnerUsername','approvedMatchesD3','playersD3','bind','length','log'];a29_0x1a16=function(){return _0x51f264;};return a29_0x1a16();}function a29_0x422f(_0x1e24a1,_0x518beb){const _0x8efb4d=a29_0x1a16();return a29_0x422f=function(_0x71164,_0x5da12e){_0x71164=_0x71164-0x91;let _0x1a16bc=_0x8efb4d[_0x71164];return _0x1a16bc;},a29_0x422f(_0x1e24a1,_0x518beb);}export async function updateEloRatingsD3(_0x24c9d1,_0x48dae8,_0x18caf7){const _0x1d3667=a29_0x422f;try{const _0x6dccd8=writeBatch(db),_0x20aea3=doc(db,_0x1d3667(0xa3),_0x24c9d1),_0x5eca87=doc(db,'playersD3',_0x48dae8),[_0x2c1256,_0x23b797]=await Promise['all']([getDoc(_0x20aea3),getDoc(_0x5eca87)]);if(!_0x2c1256['exists']()||!_0x23b797['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x4b84bc=_0x2c1256['data'](),_0x5bbf7b=_0x23b797['data'](),_0x2fee95=_0x4b84bc['position']||Number[_0x1d3667(0x95)],_0x190566=_0x5bbf7b['position']||Number[_0x1d3667(0x95)],{newWinnerRating:_0x3931b4,newLoserRating:_0x5227dc}=calculateEloD3(_0x4b84bc['eloRating']||0x4b0,_0x5bbf7b['eloRating']||0x4b0);let _0x1f8712=_0x2fee95,_0x1e1353=_0x190566;if(_0x2fee95>_0x190566){console['log'](_0x1d3667(0x9d)),_0x1f8712=_0x190566,_0x1e1353=_0x190566+0x1;const _0x1a010d=query(collection(db,'playersD3'),where('position','>',_0x190566),where('position','<',_0x2fee95)),_0x1f5efe=await getDocs(_0x1a010d);for(const _0x5857c8 of _0x1f5efe[_0x1d3667(0x93)]){_0x5857c8['id']!==_0x24c9d1&&_0x5857c8['id']!==_0x48dae8&&_0x6dccd8['update'](doc(db,'playersD3',_0x5857c8['id']),{'position':_0x5857c8['data']()['position']+0x1});}}else console['log'](_0x1d3667(0x98));return _0x6dccd8['update'](_0x20aea3,{'eloRating':_0x3931b4,'lastMatchDate':serverTimestamp(),'position':_0x1f8712,'lastMatchId':_0x18caf7}),_0x6dccd8['update'](_0x5eca87,{'eloRating':_0x5227dc,'lastMatchDate':serverTimestamp(),'position':_0x1e1353,'lastMatchId':_0x18caf7}),await _0x6dccd8['commit'](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD3({'playerId':_0x24c9d1,'previousElo':_0x4b84bc['eloRating']||0x4b0,'newElo':_0x3931b4,'opponentId':_0x48dae8,'matchResult':'win','previousPosition':_0x2fee95,'newPosition':_0x1f8712,'isPromotion':_0x1f8712<_0x2fee95,'matchId':_0x18caf7,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x48dae8,'previousElo':_0x5bbf7b['eloRating']||0x4b0,'newElo':_0x5227dc,'opponentId':_0x24c9d1,'matchResult':'loss','previousPosition':_0x190566,'newPosition':_0x1e1353,'isDemotion':_0x1e1353>_0x190566,'matchId':_0x18caf7,'timestamp':serverTimestamp()})]),!![];}catch(_0x3b2062){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x3b2062);throw _0x3b2062;}}export async function approveReportD3(_0x57d524,_0x57eda9,_0x4431bb,_0x39a5db){const _0x43343a=a29_0x422f;try{console[_0x43343a(0xa6)]('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x57d524,'winnerScore':_0x57eda9,'winnerSuicides':_0x4431bb,'winnerComment':_0x39a5db});const _0x134799=auth[_0x43343a(0x9e)];if(!_0x134799){console['log'](_0x43343a(0x9a));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x134799['email']);const _0x3a3d0b=await getDoc(doc(db,'playersD3',_0x134799['uid'])),_0x3f4fc9=_0x3a3d0b['exists']()?_0x3a3d0b['data']()['username']:null;console['log'](_0x43343a(0x94),_0x3f4fc9);const _0x69517d=doc(db,_0x43343a(0x99),_0x57d524),_0x4dda48=await getDoc(_0x69517d);if(!_0x4dda48['exists']()){console['log'](_0x43343a(0x92),_0x57d524);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x1f0b11=_0x4dda48['data']();console['log']('D3\x20Report\x20data:',_0x1f0b11);if(_0x3f4fc9!==_0x1f0b11[_0x43343a(0xa1)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x3d3270={..._0x1f0b11,'winnerScore':_0x57eda9,'winnerSuicides':_0x4431bb,'winnerComment':_0x39a5db,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x3f4fc9,'createdAt':_0x1f0b11['createdAt']||serverTimestamp(),'winnerUsername':_0x1f0b11['winnerUsername'],'loserUsername':_0x1f0b11['loserUsername']};await setDoc(doc(db,_0x43343a(0xa2),_0x57d524),_0x3d3270),await deleteDoc(_0x69517d),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x39b7b8,_0x414cd1]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x1f0b11['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x1f0b11[_0x43343a(0xa0)])))]);if(_0x39b7b8['empty']||_0x414cd1['empty'])throw new Error(_0x43343a(0x9b));const _0x417b11=_0x39b7b8['docs'][0x0]['id'],_0x8f3260=_0x414cd1['docs'][0x0]['id'];return await updateEloRatingsD3(_0x417b11,_0x8f3260,_0x57d524),console[_0x43343a(0xa6)]('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3cc8aa){console['error']('Error\x20in\x20approveReportD3:',_0x3cc8aa);throw _0x3cc8aa;}}