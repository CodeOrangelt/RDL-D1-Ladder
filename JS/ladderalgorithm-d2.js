function a28_0x3797(_0x5ba3fa,_0xf2b5d4){const _0x64c658=a28_0x4937();return a28_0x3797=function(_0x4b9fdd,_0x58eb29){_0x4b9fdd=_0x4b9fdd-0xb3;let _0x4937d6=_0x64c658[_0x4b9fdd];return _0x4937d6;},a28_0x3797(_0x5ba3fa,_0xf2b5d4);}const a28_0x4b9fdd=(function(){let _0x1146e2=!![];return function(_0x3c1b1b,_0x1157f0){const _0x3aa679=_0x1146e2?function(){if(_0x1157f0){const _0x1eb4bf=_0x1157f0['apply'](_0x3c1b1b,arguments);return _0x1157f0=null,_0x1eb4bf;}}:function(){};return _0x1146e2=![],_0x3aa679;};}()),a28_0x64c658=a28_0x4b9fdd(this,function(){const _0x2f79c8=a28_0x3797,_0x3f93d7=function(){const _0x10704d=a28_0x3797;let _0x3a1dda;try{_0x3a1dda=Function(_0x10704d(0xc8)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x270c6b){_0x3a1dda=window;}return _0x3a1dda;},_0x4ba1e9=_0x3f93d7(),_0x9fdbde=_0x4ba1e9['console']=_0x4ba1e9[_0x2f79c8(0xbd)]||{},_0x36ed77=[_0x2f79c8(0xbb),_0x2f79c8(0xc6),_0x2f79c8(0xbc),'error','exception','table','trace'];for(let _0x5177b4=0x0;_0x5177b4<_0x36ed77['length'];_0x5177b4++){const _0x3c4f33=a28_0x4b9fdd['constructor']['prototype'][_0x2f79c8(0xc3)](a28_0x4b9fdd),_0x7f5872=_0x36ed77[_0x5177b4],_0x16e986=_0x9fdbde[_0x7f5872]||_0x3c4f33;_0x3c4f33['__proto__']=a28_0x4b9fdd['bind'](a28_0x4b9fdd),_0x3c4f33['toString']=_0x16e986['toString']['bind'](_0x16e986),_0x9fdbde[_0x7f5872]=_0x3c4f33;}});a28_0x64c658();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x2aa36c from'./firebase-idle-wrapper.js';function a28_0x4937(){const _0x5df049=['empty','username','playersD2','position','all','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','commit','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','log','info','console','currentUser','docs','exists','One\x20or\x20both\x20D2\x20players\x20not\x20found','eloRating','bind','D2\x20Match\x20moved\x20to\x20approved\x20collection','MAX_SAFE_INTEGER','warn','pow','return\x20(function()\x20','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','data'];a28_0x4937=function(){return _0x5df049;};return a28_0x4937();}export function calculateEloD2(_0x5c4ed1,_0x158607,_0x2ac498=0x20){const _0xac3b4b=a28_0x3797,_0x35ca1f=0x1/(0x1+Math[_0xac3b4b(0xc7)](0xa,(_0x158607-_0x5c4ed1)/0x190)),_0x4dc4e2=0x1/(0x1+Math['pow'](0xa,(_0x5c4ed1-_0x158607)/0x190)),_0x4df6c3=_0x5c4ed1+_0x2ac498*(0x1-_0x35ca1f),_0x194a31=_0x158607+_0x2ac498*(0x0-_0x4dc4e2);return{'newWinnerRating':Math['round'](_0x4df6c3),'newLoserRating':Math['round'](_0x194a31)};}export async function updateEloRatingsD2(_0x3c0a58,_0x2d5843,_0x595312){const _0x2e76cb=a28_0x3797;try{const _0x179254=writeBatch(db),_0x1ab40c=doc(db,'playersD2',_0x3c0a58),_0x1e2c9a=doc(db,'playersD2',_0x2d5843),[_0x18adb0,_0x68a519]=await Promise[_0x2e76cb(0xb7)]([getDoc(_0x1ab40c),getDoc(_0x1e2c9a)]);if(!_0x18adb0[_0x2e76cb(0xc0)]()||!_0x68a519['exists']())throw new Error(_0x2e76cb(0xc1));const _0x3ea14c=_0x18adb0['data'](),_0x2813c0=_0x68a519['data'](),_0x54aab6=_0x3ea14c[_0x2e76cb(0xb6)]||Number['MAX_SAFE_INTEGER'],_0x9d515d=_0x2813c0['position']||Number[_0x2e76cb(0xc5)],{newWinnerRating:_0x330616,newLoserRating:_0x3aa2fa}=calculateEloD2(_0x3ea14c['eloRating']||0x4b0,_0x2813c0[_0x2e76cb(0xc2)]||0x4b0);let _0x10b34b=_0x54aab6,_0x4b0e64=_0x9d515d;if(_0x54aab6>_0x9d515d){console['log'](_0x2e76cb(0xc9)),_0x10b34b=_0x9d515d,_0x4b0e64=_0x9d515d+0x1;const _0x46a2d4=query(collection(db,'playersD2'),where('position','>',_0x9d515d),where('position','<',_0x54aab6)),_0x4b0b72=await getDocs(_0x46a2d4);for(const _0x2f5d69 of _0x4b0b72['docs']){_0x2f5d69['id']!==_0x3c0a58&&_0x2f5d69['id']!==_0x2d5843&&_0x179254['update'](doc(db,'playersD2',_0x2f5d69['id']),{'position':_0x2f5d69['data']()['position']+0x1});}}else console['log'](_0x2e76cb(0xb8));return _0x179254['update'](_0x1ab40c,{'eloRating':_0x330616,'lastMatchDate':serverTimestamp(),'position':_0x10b34b,'lastMatchId':_0x595312}),_0x179254['update'](_0x1e2c9a,{'eloRating':_0x3aa2fa,'lastMatchDate':serverTimestamp(),'position':_0x4b0e64,'lastMatchId':_0x595312}),await _0x179254[_0x2e76cb(0xb9)](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x3c0a58,'previousElo':_0x3ea14c['eloRating']||0x4b0,'newElo':_0x330616,'opponentId':_0x2d5843,'matchResult':'win','previousPosition':_0x54aab6,'newPosition':_0x10b34b,'isPromotion':_0x10b34b<_0x54aab6,'matchId':_0x595312,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x2d5843,'previousElo':_0x2813c0['eloRating']||0x4b0,'newElo':_0x3aa2fa,'opponentId':_0x3c0a58,'matchResult':'loss','previousPosition':_0x9d515d,'newPosition':_0x4b0e64,'isDemotion':_0x4b0e64>_0x9d515d,'matchId':_0x595312,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x3c0a58,_0x330616,_0x3ea14c['eloRating'],{'source':'match-d2','matchId':_0x595312}),await promotionManager['checkAndRecordPromotion'](_0x2d5843,_0x3aa2fa,_0x2813c0['eloRating'],{'source':'match-d2','matchId':_0x595312}),!![];}catch(_0x2b75ef){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x2b75ef);throw _0x2b75ef;}}export async function approveReportD2(_0x303b65,_0x5c4ed4,_0x684d11,_0x2407bb){const _0xa91d0c=a28_0x3797;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x303b65,'winnerScore':_0x5c4ed4,'winnerSuicides':_0x684d11,'winnerComment':_0x2407bb});const _0x390297=auth[_0xa91d0c(0xbe)];if(!_0x390297){console['log']('No\x20user\x20logged\x20in');throw new Error(_0xa91d0c(0xba));}console[_0xa91d0c(0xbb)]('Current\x20user:',_0x390297['email']);const _0xb5dcbf=await getDoc(doc(db,'playersD2',_0x390297['uid'])),_0x28841a=_0xb5dcbf['exists']()?_0xb5dcbf[_0xa91d0c(0xca)]()['username']:null;console['log']('Current\x20username:',_0x28841a);const _0x1a2d1e=doc(db,'pendingMatchesD2',_0x303b65),_0x374ab7=await getDoc(_0x1a2d1e);if(!_0x374ab7['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x303b65);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x520ede=_0x374ab7['data']();console['log']('D2\x20Report\x20data:',_0x520ede);if(_0x28841a!==_0x520ede['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x29f52d={..._0x520ede,'winnerScore':_0x5c4ed4,'winnerSuicides':_0x684d11,'winnerComment':_0x2407bb,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x28841a,'createdAt':_0x520ede['createdAt']||serverTimestamp(),'winnerUsername':_0x520ede['winnerUsername'],'loserUsername':_0x520ede['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x303b65),_0x29f52d),await deleteDoc(_0x1a2d1e),console[_0xa91d0c(0xbb)](_0xa91d0c(0xc4));const [_0x52e28b,_0x4e8fc6]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x520ede['winnerUsername']))),getDocs(query(collection(db,_0xa91d0c(0xb5)),where(_0xa91d0c(0xb4),'==',_0x520ede['loserUsername'])))]);if(_0x52e28b[_0xa91d0c(0xb3)]||_0x4e8fc6['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x24e14f=_0x52e28b[_0xa91d0c(0xbf)][0x0]['id'],_0x54bae1=_0x4e8fc6['docs'][0x0]['id'];return await updateEloRatingsD2(_0x24e14f,_0x54bae1,_0x303b65),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x2831fd){console['error']('Error\x20in\x20approveReportD2:',_0x2831fd);throw _0x2831fd;}}