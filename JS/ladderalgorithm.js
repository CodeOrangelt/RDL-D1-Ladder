const a28_0x3e5f43=(function(){let _0x3a1b72=!![];return function(_0x51ff4b,_0x505587){const _0x1e3dfb=_0x3a1b72?function(){if(_0x505587){const _0x12ee3a=_0x505587['apply'](_0x51ff4b,arguments);return _0x505587=null,_0x12ee3a;}}:function(){};return _0x3a1b72=![],_0x1e3dfb;};}()),a28_0x3b1f91=a28_0x3e5f43(this,function(){const _0x1b5c16=a28_0x36e8,_0x9ab359=function(){const _0x2f866d=a28_0x36e8;let _0x287945;try{_0x287945=Function('return\x20(function()\x20'+_0x2f866d(0x150)+');')();}catch(_0x54c8b3){_0x287945=window;}return _0x287945;},_0x4bbd25=_0x9ab359(),_0x351df2=_0x4bbd25['console']=_0x4bbd25['console']||{},_0x21e43f=['log','warn',_0x1b5c16(0x14e),'error','exception','table','trace'];for(let _0x48b9a1=0x0;_0x48b9a1<_0x21e43f['length'];_0x48b9a1++){const _0x1258be=a28_0x3e5f43['constructor']['prototype']['bind'](a28_0x3e5f43),_0x12370d=_0x21e43f[_0x48b9a1],_0x16032c=_0x351df2[_0x12370d]||_0x1258be;_0x1258be[_0x1b5c16(0x14f)]=a28_0x3e5f43['bind'](a28_0x3e5f43),_0x1258be['toString']=_0x16032c[_0x1b5c16(0x15d)][_0x1b5c16(0x167)](_0x16032c),_0x351df2[_0x12370d]=_0x1258be;}});a28_0x3b1f91();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x24a6e1,_0xf62961,_0x457c18=0x20){const _0x9a9999=0x1/(0x1+Math['pow'](0xa,(_0xf62961-_0x24a6e1)/0x190)),_0x3decd8=0x1/(0x1+Math['pow'](0xa,(_0x24a6e1-_0xf62961)/0x190)),_0x2ea576=_0x24a6e1+_0x457c18*(0x1-_0x9a9999),_0x226bd1=_0xf62961+_0x457c18*(0x0-_0x3decd8);return{'newWinnerRating':Math['round'](_0x2ea576),'newLoserRating':Math['round'](_0x226bd1)};}function a28_0x36e8(_0x765551,_0x7104fa){const _0x3b1f91=a28_0x96f9();return a28_0x36e8=function(_0x3e5f43,_0x41a114){_0x3e5f43=_0x3e5f43-0x14d;let _0x96f999=_0x3b1f91[_0x3e5f43];return _0x96f999;},a28_0x36e8(_0x765551,_0x7104fa);}export function assignDefaultEloRating(_0x42862d,_0x28db57){const _0x4446b7=a28_0x36e8,_0x3bf516=0x4b0;!_0x28db57[_0x4446b7(0x16b)]&&db['collection']('players')[_0x4446b7(0x153)](_0x42862d)['update']({'eloRating':_0x3bf516})[_0x4446b7(0x164)](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x28db57['username']);})['catch'](_0x4ae5c6=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x4ae5c6);});}export async function updateEloRatings(_0x32e954,_0x46fdc1,_0x19abb1){const _0x2376a2=a28_0x36e8;try{const _0x5956b0=writeBatch(db),_0x62869d=doc(db,'players',_0x32e954),_0x21fc6e=doc(db,'players',_0x46fdc1),[_0x475c67,_0x4b1c9e]=await Promise['all']([getDoc(_0x62869d),getDoc(_0x21fc6e)]);if(!_0x475c67['exists']()||!_0x4b1c9e[_0x2376a2(0x154)]())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x158648=_0x475c67['data'](),_0x3309e0=_0x4b1c9e['data'](),_0x1aabae=_0x158648[_0x2376a2(0x15f)]||Number['MAX_SAFE_INTEGER'],_0x1099b5=_0x3309e0['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x1f2d39,newLoserRating:_0x3fb944}=calculateElo(_0x158648[_0x2376a2(0x16b)]||0x4b0,_0x3309e0[_0x2376a2(0x16b)]||0x4b0);let _0x2a1595=_0x1aabae,_0x1b2623=_0x1099b5;if(_0x1aabae>_0x1099b5){console['log'](_0x2376a2(0x159)),_0x2a1595=_0x1099b5,_0x1b2623=_0x1099b5+0x1;const _0xc81921=query(collection(db,'players'),where(_0x2376a2(0x15f),'>',_0x1099b5),where('position','<',_0x1aabae)),_0x4080d7=await getDocs(_0xc81921);for(const _0xbf66c2 of _0x4080d7['docs']){_0xbf66c2['id']!==_0x32e954&&_0xbf66c2['id']!==_0x46fdc1&&_0x5956b0['update'](doc(db,'players',_0xbf66c2['id']),{'position':_0xbf66c2['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x5bc215={'eloRating':_0x1f2d39,'lastMatchDate':serverTimestamp(),'position':_0x2a1595,'lastMatchId':_0x19abb1},_0x4e393f={'eloRating':_0x3fb944,'lastMatchDate':serverTimestamp(),'position':_0x1b2623,'lastMatchId':_0x19abb1};return _0x5956b0['update'](_0x62869d,_0x5bc215),_0x5956b0[_0x2376a2(0x168)](_0x21fc6e,_0x4e393f),await _0x5956b0['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x32e954,'previousElo':_0x158648['eloRating']||0x4b0,'newElo':_0x1f2d39,'opponentId':_0x46fdc1,'matchResult':'win','previousPosition':_0x1aabae,'newPosition':_0x2a1595,'isPromotion':_0x2a1595<_0x1aabae,'matchId':_0x19abb1,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x46fdc1,'previousElo':_0x3309e0[_0x2376a2(0x16b)]||0x4b0,'newElo':_0x3fb944,'opponentId':_0x32e954,'matchResult':'loss','previousPosition':_0x1099b5,'newPosition':_0x1b2623,'isDemotion':_0x1b2623>_0x1099b5,'matchId':_0x19abb1,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x32e954,_0x1f2d39,_0x158648[_0x2376a2(0x16b)],{'source':'match','matchId':_0x19abb1}),await promotionManager['checkAndRecordPromotion'](_0x46fdc1,_0x3fb944,_0x3309e0['eloRating'],{'source':'match','matchId':_0x19abb1}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x2c93e5){console['error'](_0x2376a2(0x165),_0x2c93e5);throw _0x2c93e5;}}function a28_0x96f9(){const _0x3218be=['playerStats','info','__proto__','{}.constructor(\x22return\x20this\x22)(\x20)','wins','losses','doc','exists','all','loserScore','players','log','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','uid','totalDeaths','displayName','toString','data','position','email','\x20match','system-match-award','loserUsername','then','Error\x20in\x20updateEloRatings:','unknown','bind','update','error','empty','eloRating'];a28_0x96f9=function(){return _0x3218be;};return a28_0x96f9();}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x424507,_0x431fee,_0x19143a,_0x30e021,_0x479ac9){const _0x3d5c0b=a28_0x36e8;try{const _0x29be08=doc(db,'pendingMatches',_0x424507),_0x12f119=await getDoc(_0x29be08);if(!_0x12f119[_0x3d5c0b(0x154)]())throw new Error('Report\x20not\x20found');const _0x44e9c4=_0x12f119['data'](),_0x502123={..._0x44e9c4,'winnerScore':_0x431fee,'winnerSuicides':_0x19143a,'winnerComment':_0x30e021,'winnerDemoLink':_0x479ac9,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x3d5c0b(0x15a)]};await setDoc(doc(db,'approvedMatches',_0x424507),_0x502123),await deleteDoc(_0x29be08),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x5e7c18,_0x7611c4]=await Promise[_0x3d5c0b(0x155)]([getDocs(query(collection(db,'players'),where('username','==',_0x44e9c4['winnerUsername']))),getDocs(query(collection(db,_0x3d5c0b(0x157)),where('username','==',_0x44e9c4[_0x3d5c0b(0x163)])))]);if(_0x5e7c18['empty']||_0x7611c4[_0x3d5c0b(0x16a)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x442977=_0x5e7c18['docs'][0x0]['id'],_0x585c4c=_0x7611c4['docs'][0x0]['id'];await updateEloRatings(_0x442977,_0x585c4c,_0x424507);try{const _0x4fbd8b=_0x44e9c4['subgameType']||'Standard',_0x74ad9=POINTS_CHART[_0x4fbd8b]||0xa,_0x30b64f=doc(db,'userProfiles',_0x442977),_0x180493=doc(db,'userProfiles',_0x585c4c),[_0x13c690,_0x36c8f8]=await Promise[_0x3d5c0b(0x155)]([getDoc(_0x30b64f),getDoc(_0x180493)]);if(_0x13c690['exists']()&&_0x36c8f8[_0x3d5c0b(0x154)]()){const _0x3c4942=_0x13c690[_0x3d5c0b(0x15e)](),_0x1065d6=_0x36c8f8['data'](),_0x325763=_0x3c4942['points']||0x0,_0x1b333c=_0x1065d6['points']||0x0,_0x5db622=_0x325763+_0x74ad9,_0x28eab5=_0x1b333c+_0x74ad9;await Promise['all']([updateDoc(_0x30b64f,{'points':_0x5db622,'lastPointsModified':serverTimestamp()}),updateDoc(_0x180493,{'points':_0x28eab5,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,'pointsHistory'),{'userId':_0x442977,'userEmail':_0x3c4942[_0x3d5c0b(0x160)]||'unknown','displayName':_0x3c4942[_0x3d5c0b(0x15c)]||_0x3c4942['username']||'Unknown\x20User','action':'add','amount':_0x74ad9,'previousPoints':_0x325763,'newPoints':_0x5db622,'reason':'Match\x20points:\x20'+_0x4fbd8b+'\x20match\x20(Winner)','adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x585c4c,'userEmail':_0x1065d6['email']||_0x3d5c0b(0x166),'displayName':_0x1065d6['displayName']||_0x1065d6['username']||'Unknown\x20User','action':'add','amount':_0x74ad9,'previousPoints':_0x1b333c,'newPoints':_0x28eab5,'reason':'Match\x20points:\x20'+_0x4fbd8b+'\x20match\x20(Participant)','adminEmail':_0x3d5c0b(0x162),'timestamp':serverTimestamp()})]),console[_0x3d5c0b(0x158)]('Awarded\x20'+_0x74ad9+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x4fbd8b+_0x3d5c0b(0x161));}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x488be7){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x488be7);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x5af177){console[_0x3d5c0b(0x169)]('Error\x20approving\x20report:',_0x5af177);throw _0x5af177;}}async function updatePlayerElo(_0x5a9d74,_0x30b21f,_0x427514){const _0x532dc5=a28_0x36e8;await setDoc(doc(db,_0x532dc5(0x157),_0x5a9d74),{...playerData,'eloRating':_0x427514}),await checkAndRecordPromotion(_0x5a9d74,_0x427514,_0x30b21f);}async function updatePlayerStats(_0x4aeae8,_0x1d0bf6,_0x36ee72){const _0x240c6f=a28_0x36e8,_0x32f442=doc(db,_0x240c6f(0x14d),_0x4aeae8),_0x4a50e6=await getDoc(_0x32f442);let _0x49dc0c=_0x4a50e6['exists']()?_0x4a50e6['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x36ee72?(_0x49dc0c['wins']++,_0x49dc0c['totalKills']+=parseInt(_0x1d0bf6['winnerScore']||0x0),_0x49dc0c['totalDeaths']+=parseInt(_0x1d0bf6['loserScore']||0x0)):(_0x49dc0c[_0x240c6f(0x152)]++,_0x49dc0c['totalKills']+=parseInt(_0x1d0bf6[_0x240c6f(0x156)]||0x0),_0x49dc0c[_0x240c6f(0x15b)]+=parseInt(_0x1d0bf6['winnerScore']||0x0));const _0x3daa16=_0x49dc0c[_0x240c6f(0x151)]+_0x49dc0c['losses'];_0x49dc0c['winRate']=_0x3daa16>0x0?(_0x49dc0c['wins']/_0x3daa16*0x64)['toFixed'](0x1):0x0,_0x49dc0c['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x32f442,_0x49dc0c,{'merge':!![]});}