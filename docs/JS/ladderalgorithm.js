(function(_0x166fa3,_0x54d73d){const _0x1fc040=a0_0x5bef,_0x3453d1=_0x166fa3();while(!![]){try{const _0x3590b3=parseInt(_0x1fc040(0xaf))/0x1*(-parseInt(_0x1fc040(0xa2))/0x2)+parseInt(_0x1fc040(0x9e))/0x3*(-parseInt(_0x1fc040(0xaa))/0x4)+-parseInt(_0x1fc040(0x97))/0x5*(-parseInt(_0x1fc040(0x9c))/0x6)+-parseInt(_0x1fc040(0x94))/0x7+-parseInt(_0x1fc040(0x93))/0x8+parseInt(_0x1fc040(0xb8))/0x9*(parseInt(_0x1fc040(0x9a))/0xa)+parseInt(_0x1fc040(0x8d))/0xb;if(_0x3590b3===_0x54d73d)break;else _0x3453d1['push'](_0x3453d1['shift']());}catch(_0x4fad9f){_0x3453d1['push'](_0x3453d1['shift']());}}}(a0_0x854a,0x89983));const a0_0x464b6=(function(){let _0xd189b0=!![];return function(_0x196bca,_0x3d37fd){const _0x250b86=_0xd189b0?function(){if(_0x3d37fd){const _0x4ee17c=_0x3d37fd['apply'](_0x196bca,arguments);return _0x3d37fd=null,_0x4ee17c;}}:function(){};return _0xd189b0=![],_0x250b86;};}()),a0_0x3e178f=a0_0x464b6(this,function(){const _0x5b39e2=a0_0x5bef;let _0x118138;try{const _0x3c9456=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x118138=_0x3c9456();}catch(_0x4ea0aa){_0x118138=window;}const _0x33432f=_0x118138[_0x5b39e2(0xa8)]=_0x118138[_0x5b39e2(0xa8)]||{},_0x447ebe=['log','warn',_0x5b39e2(0xae),'error','exception','table','trace'];for(let _0x17aaab=0x0;_0x17aaab<_0x447ebe['length'];_0x17aaab++){const _0x5de315=a0_0x464b6[_0x5b39e2(0xa9)]['prototype'][_0x5b39e2(0xb0)](a0_0x464b6),_0x873f76=_0x447ebe[_0x17aaab],_0x8fd062=_0x33432f[_0x873f76]||_0x5de315;_0x5de315[_0x5b39e2(0x95)]=a0_0x464b6[_0x5b39e2(0xb0)](a0_0x464b6),_0x5de315['toString']=_0x8fd062['toString']['bind'](_0x8fd062),_0x33432f[_0x873f76]=_0x5de315;}});a0_0x3e178f();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a0_0x854a(){const _0x56c25f=['Awarded\x20','18gtgHVl','unknown','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','empty','winnerScore','approvedMatches','26865267wBXPyL','eloRating','username','totalMatches','\x20match\x20(Participant)','pointsHistory','997032IWToKN','7056154LhKJTd','__proto__','all','5txMhgV','data','wins','1663180gleoZi','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','3210084hZAzDK','points','332751IUoYzF','winRate','MAX_SAFE_INTEGER','then','96284qnirjf','error','position','email','Could\x20not\x20find\x20player\x20documents','players','console','constructor','20yIRvyJ','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','exists','doc','info','22JsGPMI','bind','log','\x20points\x20to\x20both\x20players\x20for\x20','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','system-match-award','pendingMatches','totalKills'];a0_0x854a=function(){return _0x56c25f;};return a0_0x854a();}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{RANKS,getRankStyle}from'./ranks.js';export function calculateElo(_0x23ad12,_0x42450f,_0x15d77a=0x20){_0x23ad12=_0x23ad12>0x3e8?0xc8:_0x23ad12,_0x42450f=_0x42450f>0x3e8?0xc8:_0x42450f;const _0x176f3a=0x1/(0x1+Math['pow'](0xa,(_0x42450f-_0x23ad12)/0x190)),_0x454fa3=0x1/(0x1+Math['pow'](0xa,(_0x23ad12-_0x42450f)/0x190)),_0x4a4094=_0x23ad12+_0x15d77a*(0x1-_0x176f3a),_0x10dd77=_0x42450f+_0x15d77a*(0x0-_0x454fa3);return{'newWinnerRating':Math['round'](Math['min'](_0x4a4094)),'newLoserRating':Math['round'](Math['max'](_0x10dd77,0x0))};}export function assignDefaultEloRating(_0xb9eb05,_0x72cd55){const _0x3ba221=a0_0x5bef,_0xe34903=0xc8;!_0x72cd55[_0x3ba221(0x8e)]&&db['collection']('players')[_0x3ba221(0xad)](_0xb9eb05)['update']({'eloRating':_0xe34903})[_0x3ba221(0xa1)](()=>{const _0x2a012f=_0x3ba221;console['log'](_0x2a012f(0x9b)+_0x72cd55['username']);})['catch'](_0x16222c=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x16222c);});}export async function updateEloRatings(_0x4adae0,_0x62a0f4,_0x487830){const _0x5df1a9=a0_0x5bef;try{const _0x255a76=writeBatch(db),_0x3ebf9e=doc(db,'players',_0x4adae0),_0x6d20b5=doc(db,_0x5df1a9(0xa7),_0x62a0f4),[_0x3c5f93,_0x53111c]=await Promise[_0x5df1a9(0x96)]([getDoc(_0x3ebf9e),getDoc(_0x6d20b5)]);if(!_0x3c5f93['exists']()||!_0x53111c['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x423f1d=_0x3c5f93[_0x5df1a9(0x98)](),_0x196a1b=_0x53111c['data'](),_0x107cef=_0x423f1d[_0x5df1a9(0xa4)]||Number['MAX_SAFE_INTEGER'],_0x34d3c8=_0x196a1b[_0x5df1a9(0xa4)]||Number[_0x5df1a9(0xa0)],{newWinnerRating:_0x1f9dd9,newLoserRating:_0x42f113}=calculateElo(_0x423f1d[_0x5df1a9(0x8e)]||0x4b0,_0x196a1b['eloRating']||0x4b0);let _0x35b154=_0x107cef,_0x78c9da=_0x34d3c8;if(_0x107cef>_0x34d3c8){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x35b154=_0x34d3c8,_0x78c9da=_0x34d3c8+0x1;const _0x11f708=query(collection(db,'players'),where('position','>',_0x34d3c8),where('position','<',_0x107cef)),_0x29831a=await getDocs(_0x11f708);for(const _0xe7582a of _0x29831a['docs']){_0xe7582a['id']!==_0x4adae0&&_0xe7582a['id']!==_0x62a0f4&&_0x255a76['update'](doc(db,'players',_0xe7582a['id']),{'position':_0xe7582a['data']()[_0x5df1a9(0xa4)]+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0xa8c89e={'eloRating':_0x1f9dd9,'lastMatchDate':serverTimestamp(),'position':_0x35b154,'lastMatchId':_0x487830},_0x3c06af={'eloRating':_0x42f113,'lastMatchDate':serverTimestamp(),'position':_0x78c9da,'lastMatchId':_0x487830};return _0x255a76['update'](_0x3ebf9e,_0xa8c89e),_0x255a76['update'](_0x6d20b5,_0x3c06af),await _0x255a76['commit'](),console[_0x5df1a9(0xb1)]('ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x5df1a9(0x96)]([recordEloChange({'playerId':_0x4adae0,'previousElo':_0x423f1d[_0x5df1a9(0x8e)]||0x4b0,'newElo':_0x1f9dd9,'opponentId':_0x62a0f4,'matchResult':'win','previousPosition':_0x107cef,'newPosition':_0x35b154,'isPromotion':_0x35b154<_0x107cef,'matchId':_0x487830,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x62a0f4,'previousElo':_0x196a1b[_0x5df1a9(0x8e)]||0x4b0,'newElo':_0x42f113,'opponentId':_0x4adae0,'matchResult':'loss','previousPosition':_0x34d3c8,'newPosition':_0x78c9da,'isDemotion':_0x78c9da>_0x34d3c8,'matchId':_0x487830,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x4adae0,_0x1f9dd9,_0x423f1d['eloRating'],{'source':'match','matchId':_0x487830}),await promotionManager['checkAndRecordPromotion'](_0x62a0f4,_0x42f113,_0x196a1b[_0x5df1a9(0x8e)],{'source':'match','matchId':_0x487830}),console['log'](_0x5df1a9(0xb3)),!![];}catch(_0x50e563){console['error']('Error\x20in\x20updateEloRatings:',_0x50e563);throw _0x50e563;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x36b1de,_0x37d124,_0x35305f,_0x35739c,_0x1b73c9){const _0x4c161f=a0_0x5bef;try{const _0x1d67b8=doc(db,_0x4c161f(0xb5),_0x36b1de),_0x3f24d4=await getDoc(_0x1d67b8);if(!_0x3f24d4[_0x4c161f(0xac)]())throw new Error('Report\x20not\x20found');const _0xc401e5=_0x3f24d4['data'](),_0x5111fe={..._0xc401e5,'winnerScore':_0x37d124,'winnerSuicides':_0x35305f,'winnerComment':_0x35739c,'winnerDemoLink':_0x1b73c9,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,_0x4c161f(0x8c),_0x36b1de),_0x5111fe),await deleteDoc(_0x1d67b8),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0xad23c1,_0x1f8f9b]=await Promise['all']([getDocs(query(collection(db,'players'),where(_0x4c161f(0x8f),'==',_0xc401e5['winnerUsername']))),getDocs(query(collection(db,_0x4c161f(0xa7)),where(_0x4c161f(0x8f),'==',_0xc401e5['loserUsername'])))]);if(_0xad23c1[_0x4c161f(0x8a)]||_0x1f8f9b['empty'])throw new Error(_0x4c161f(0xa6));const _0x4fec8c=_0xad23c1['docs'][0x0]['id'],_0xf5c85=_0x1f8f9b['docs'][0x0]['id'];await updateEloRatings(_0x4fec8c,_0xf5c85,_0x36b1de);try{const _0x1106d2=_0xc401e5['subgameType']||'Standard',_0x35385f=POINTS_CHART[_0x1106d2]||0xa,_0xce1934=doc(db,'userProfiles',_0x4fec8c),_0x14731b=doc(db,'userProfiles',_0xf5c85),[_0x595ba9,_0x31ed69]=await Promise['all']([getDoc(_0xce1934),getDoc(_0x14731b)]);if(_0x595ba9['exists']()&&_0x31ed69[_0x4c161f(0xac)]()){const _0x323128=_0x595ba9['data'](),_0xd7d755=_0x31ed69['data'](),_0x3e0963=_0x323128[_0x4c161f(0x9d)]||0x0,_0x2fd702=_0xd7d755[_0x4c161f(0x9d)]||0x0,_0x210bcf=_0x3e0963+_0x35385f,_0x4c9f81=_0x2fd702+_0x35385f;await Promise['all']([updateDoc(_0xce1934,{'points':_0x210bcf,'lastPointsModified':serverTimestamp()}),updateDoc(_0x14731b,{'points':_0x4c9f81,'lastPointsModified':serverTimestamp()})]),await Promise[_0x4c161f(0x96)]([addDoc(collection(db,_0x4c161f(0x92)),{'userId':_0x4fec8c,'userEmail':_0x323128['email']||'unknown','displayName':_0x323128['displayName']||_0x323128['username']||'Unknown\x20User','action':'add','amount':_0x35385f,'previousPoints':_0x3e0963,'newPoints':_0x210bcf,'reason':'Match\x20points:\x20'+_0x1106d2+'\x20match\x20(Winner)','adminEmail':_0x4c161f(0xb4),'timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0xf5c85,'userEmail':_0xd7d755[_0x4c161f(0xa5)]||_0x4c161f(0xb9),'displayName':_0xd7d755['displayName']||_0xd7d755['username']||'Unknown\x20User','action':'add','amount':_0x35385f,'previousPoints':_0x2fd702,'newPoints':_0x4c9f81,'reason':'Match\x20points:\x20'+_0x1106d2+_0x4c161f(0x91),'adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log'](_0x4c161f(0xb7)+_0x35385f+_0x4c161f(0xb2)+_0x1106d2+'\x20match');}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x5646be){console['warn'](_0x4c161f(0xab),_0x5646be);}return console[_0x4c161f(0xb1)](_0x4c161f(0xba)),!![];}catch(_0x438b8a){console[_0x4c161f(0xa3)]('Error\x20approving\x20report:',_0x438b8a);throw _0x438b8a;}}function a0_0x5bef(_0x9aa3c,_0x23ac71){const _0x51026e=a0_0x854a();return a0_0x5bef=function(_0x3e178f,_0x464b6){_0x3e178f=_0x3e178f-0x8a;let _0x2793c3=_0x51026e[_0x3e178f];return _0x2793c3;},a0_0x5bef(_0x9aa3c,_0x23ac71);}async function updatePlayerElo(_0x3e7b36,_0x1f9891,_0x5731ee){const _0x1f4e27=a0_0x5bef,_0x366b71=doc(db,'players',_0x3e7b36),_0x3dd6dc=await getDoc(_0x366b71),_0x13db49=_0x3dd6dc['data'](),_0x3e870f=doc(db,'playerStats',_0x3e7b36),_0x1c108b=await getDoc(_0x3e870f),_0x472288=_0x1c108b['data']()||{'totalMatches':0x0,'winRate':0x0},_0x1eb85f=getRankStyle(_0x5731ee,_0x472288['totalMatches'],_0x472288[_0x1f4e27(0x9f)]);await updateDoc(_0x366b71,{'eloRating':_0x5731ee,'rank':_0x1eb85f['name'],'rankColor':_0x1eb85f['color']}),await checkAndRecordPromotion(_0x3e7b36,_0x5731ee,_0x1f9891,{'matchCount':_0x472288[_0x1f4e27(0x90)],'winRate':_0x472288['winRate']});}async function updatePlayerStats(_0xe41b37,_0x13b2ec,_0x1092dd){const _0x35b7ba=a0_0x5bef,_0x2510c8=doc(db,'playerStats',_0xe41b37),_0x5ee4ee=await getDoc(_0x2510c8);let _0x54cf3b=_0x5ee4ee['exists']()?_0x5ee4ee['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x1092dd?(_0x54cf3b[_0x35b7ba(0x99)]++,_0x54cf3b['totalKills']+=parseInt(_0x13b2ec[_0x35b7ba(0x8b)]||0x0),_0x54cf3b['totalDeaths']+=parseInt(_0x13b2ec['loserScore']||0x0)):(_0x54cf3b['losses']++,_0x54cf3b[_0x35b7ba(0xb6)]+=parseInt(_0x13b2ec['loserScore']||0x0),_0x54cf3b['totalDeaths']+=parseInt(_0x13b2ec['winnerScore']||0x0));const _0x309cec=_0x54cf3b['wins']+_0x54cf3b['losses'];_0x54cf3b[_0x35b7ba(0x9f)]=_0x309cec>0x0?(_0x54cf3b['wins']/_0x309cec*0x64)['toFixed'](0x1):0x0,_0x54cf3b['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x2510c8,_0x54cf3b,{'merge':!![]});}