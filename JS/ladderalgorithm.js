const a30_0x42d62f=(function(){let _0x440d7f=!![];return function(_0xcbb631,_0x1368a0){const _0x56c0fe=_0x440d7f?function(){if(_0x1368a0){const _0x1873b4=_0x1368a0['apply'](_0xcbb631,arguments);return _0x1368a0=null,_0x1873b4;}}:function(){};return _0x440d7f=![],_0x56c0fe;};}()),a30_0x415f80=a30_0x42d62f(this,function(){const _0x4f7acb=a30_0x5b98,_0x56e942=function(){const _0x5b97b=a30_0x5b98;let _0x455324;try{_0x455324=Function(_0x5b97b(0x73)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x58a96f){_0x455324=window;}return _0x455324;},_0x296adb=_0x56e942(),_0x348e23=_0x296adb['console']=_0x296adb['console']||{},_0x4ac068=['log','warn','info','error',_0x4f7acb(0x6a),'table','trace'];for(let _0x56fda7=0x0;_0x56fda7<_0x4ac068[_0x4f7acb(0x8a)];_0x56fda7++){const _0x4ba633=a30_0x42d62f['constructor']['prototype'][_0x4f7acb(0x86)](a30_0x42d62f),_0x23e2cd=_0x4ac068[_0x56fda7],_0x2348b5=_0x348e23[_0x23e2cd]||_0x4ba633;_0x4ba633[_0x4f7acb(0x7f)]=a30_0x42d62f['bind'](a30_0x42d62f),_0x4ba633['toString']=_0x2348b5['toString'][_0x4f7acb(0x86)](_0x2348b5),_0x348e23[_0x23e2cd]=_0x4ba633;}});a30_0x415f80();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a30_0x6eae(){const _0x28ceb0=['loserScore','exception','log','system-match-award','checkAndRecordPromotion','Unknown\x20User','pendingMatches','\x20match\x20(Winner)','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','position','return\x20(function()\x20','uid','losses','eloRating','update','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','MAX_SAFE_INTEGER','pointsHistory','all','wins','points','add','__proto__','totalKills','winnerUsername','Match\x20points:\x20','displayName','docs','toFixed','bind','userProfiles','players','empty','length','catch','exists','loserUsername','toISOString','username','Error\x20in\x20updateEloRatings:','data','error'];a30_0x6eae=function(){return _0x28ceb0;};return a30_0x6eae();}function a30_0x5b98(_0x10e30e,_0x265013){const _0x415f80=a30_0x6eae();return a30_0x5b98=function(_0x42d62f,_0x55d760){_0x42d62f=_0x42d62f-0x69;let _0x6eae9c=_0x415f80[_0x42d62f];return _0x6eae9c;},a30_0x5b98(_0x10e30e,_0x265013);}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x51908f,_0x3f4963,_0x2c64c7=0x20){const _0x211857=0x1/(0x1+Math['pow'](0xa,(_0x3f4963-_0x51908f)/0x190)),_0x59fefb=0x1/(0x1+Math['pow'](0xa,(_0x51908f-_0x3f4963)/0x190)),_0x10d30d=_0x51908f+_0x2c64c7*(0x1-_0x211857),_0x47b54d=_0x3f4963+_0x2c64c7*(0x0-_0x59fefb);return{'newWinnerRating':Math['round'](_0x10d30d),'newLoserRating':Math['round'](_0x47b54d)};}export function assignDefaultEloRating(_0x3695a8,_0x2f4bef){const _0x264d0e=a30_0x5b98,_0x175b1d=0x4b0;!_0x2f4bef['eloRating']&&db['collection']('players')['doc'](_0x3695a8)['update']({'eloRating':_0x175b1d})['then'](()=>{const _0xfef0c1=a30_0x5b98;console[_0xfef0c1(0x6b)]('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x2f4bef[_0xfef0c1(0x8f)]);})[_0x264d0e(0x8b)](_0x59ead=>{const _0x1895be=_0x264d0e;console[_0x1895be(0x92)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x59ead);});}export async function updateEloRatings(_0x57bc23,_0x94d01,_0x4e69ff){const _0x505ec3=a30_0x5b98;try{const _0x2aa9ac=writeBatch(db),_0x4c8bb6=doc(db,'players',_0x57bc23),_0x1c89f1=doc(db,'players',_0x94d01),[_0x5539d7,_0x2de439]=await Promise['all']([getDoc(_0x4c8bb6),getDoc(_0x1c89f1)]);if(!_0x5539d7['exists']()||!_0x2de439['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x51c1ea=_0x5539d7['data'](),_0x323f40=_0x2de439[_0x505ec3(0x91)](),_0x3bae3d=_0x51c1ea['position']||Number[_0x505ec3(0x79)],_0x770196=_0x323f40['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x569993,newLoserRating:_0x1760c5}=calculateElo(_0x51c1ea['eloRating']||0x4b0,_0x323f40[_0x505ec3(0x76)]||0x4b0);let _0x391dbd=_0x3bae3d,_0x260847=_0x770196;if(_0x3bae3d>_0x770196){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x391dbd=_0x770196,_0x260847=_0x770196+0x1;const _0x2989bb=query(collection(db,'players'),where('position','>',_0x770196),where('position','<',_0x3bae3d)),_0x51716c=await getDocs(_0x2989bb);for(const _0x445003 of _0x51716c['docs']){_0x445003['id']!==_0x57bc23&&_0x445003['id']!==_0x94d01&&_0x2aa9ac['update'](doc(db,'players',_0x445003['id']),{'position':_0x445003[_0x505ec3(0x91)]()[_0x505ec3(0x72)]+0x1});}}else console['log'](_0x505ec3(0x78));const _0x54b22b={'eloRating':_0x569993,'lastMatchDate':serverTimestamp(),'position':_0x391dbd,'lastMatchId':_0x4e69ff},_0x59dbc3={'eloRating':_0x1760c5,'lastMatchDate':serverTimestamp(),'position':_0x260847,'lastMatchId':_0x4e69ff};return _0x2aa9ac[_0x505ec3(0x77)](_0x4c8bb6,_0x54b22b),_0x2aa9ac['update'](_0x1c89f1,_0x59dbc3),await _0x2aa9ac['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x505ec3(0x7b)]([recordEloChange({'playerId':_0x57bc23,'previousElo':_0x51c1ea['eloRating']||0x4b0,'newElo':_0x569993,'opponentId':_0x94d01,'matchResult':'win','previousPosition':_0x3bae3d,'newPosition':_0x391dbd,'isPromotion':_0x391dbd<_0x3bae3d,'matchId':_0x4e69ff,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x94d01,'previousElo':_0x323f40[_0x505ec3(0x76)]||0x4b0,'newElo':_0x1760c5,'opponentId':_0x57bc23,'matchResult':'loss','previousPosition':_0x770196,'newPosition':_0x260847,'isDemotion':_0x260847>_0x770196,'matchId':_0x4e69ff,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x57bc23,_0x569993,_0x51c1ea['eloRating'],{'source':'match','matchId':_0x4e69ff}),await promotionManager[_0x505ec3(0x6d)](_0x94d01,_0x1760c5,_0x323f40['eloRating'],{'source':'match','matchId':_0x4e69ff}),console[_0x505ec3(0x6b)](_0x505ec3(0x71)),!![];}catch(_0x50acc1){console['error'](_0x505ec3(0x90),_0x50acc1);throw _0x50acc1;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x3e5fd4,_0x52ce8c,_0x38aeef,_0xbd2c7d,_0x414b50){const _0x216484=a30_0x5b98;try{const _0x50458b=doc(db,_0x216484(0x6f),_0x3e5fd4),_0x2b26e0=await getDoc(_0x50458b);if(!_0x2b26e0['exists']())throw new Error('Report\x20not\x20found');const _0x3f03ad=_0x2b26e0['data'](),_0x5ab4eb={..._0x3f03ad,'winnerScore':_0x52ce8c,'winnerSuicides':_0x38aeef,'winnerComment':_0xbd2c7d,'winnerDemoLink':_0x414b50,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x216484(0x74)]};await setDoc(doc(db,'approvedMatches',_0x3e5fd4),_0x5ab4eb),await deleteDoc(_0x50458b),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x2a19e4,_0x4e090a]=await Promise['all']([getDocs(query(collection(db,_0x216484(0x88)),where(_0x216484(0x8f),'==',_0x3f03ad[_0x216484(0x81)]))),getDocs(query(collection(db,'players'),where('username','==',_0x3f03ad[_0x216484(0x8d)])))]);if(_0x2a19e4[_0x216484(0x89)]||_0x4e090a[_0x216484(0x89)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x553e61=_0x2a19e4[_0x216484(0x84)][0x0]['id'],_0x319c1c=_0x4e090a['docs'][0x0]['id'];await updateEloRatings(_0x553e61,_0x319c1c,_0x3e5fd4);try{const _0x5ce160=_0x3f03ad['subgameType']||'Standard',_0x4f2aa6=POINTS_CHART[_0x5ce160]||0xa,_0xb028b4=doc(db,_0x216484(0x87),_0x553e61),_0x333702=doc(db,'userProfiles',_0x319c1c),[_0x1787a3,_0x4e1298]=await Promise['all']([getDoc(_0xb028b4),getDoc(_0x333702)]);if(_0x1787a3['exists']()&&_0x4e1298['exists']()){const _0x127f24=_0x1787a3['data'](),_0x5d4be0=_0x4e1298['data'](),_0x1c910f=_0x127f24['points']||0x0,_0x333df0=_0x5d4be0[_0x216484(0x7d)]||0x0,_0x1d1859=_0x1c910f+_0x4f2aa6,_0x5310e9=_0x333df0+_0x4f2aa6;await Promise['all']([updateDoc(_0xb028b4,{'points':_0x1d1859,'lastPointsModified':serverTimestamp()}),updateDoc(_0x333702,{'points':_0x5310e9,'lastPointsModified':serverTimestamp()})]),await Promise[_0x216484(0x7b)]([addDoc(collection(db,_0x216484(0x7a)),{'userId':_0x553e61,'userEmail':_0x127f24['email']||'unknown','displayName':_0x127f24[_0x216484(0x83)]||_0x127f24['username']||_0x216484(0x6e),'action':'add','amount':_0x4f2aa6,'previousPoints':_0x1c910f,'newPoints':_0x1d1859,'reason':'Match\x20points:\x20'+_0x5ce160+_0x216484(0x70),'adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,_0x216484(0x7a)),{'userId':_0x319c1c,'userEmail':_0x5d4be0['email']||'unknown','displayName':_0x5d4be0['displayName']||_0x5d4be0[_0x216484(0x8f)]||'Unknown\x20User','action':_0x216484(0x7e),'amount':_0x4f2aa6,'previousPoints':_0x333df0,'newPoints':_0x5310e9,'reason':_0x216484(0x82)+_0x5ce160+'\x20match\x20(Participant)','adminEmail':_0x216484(0x6c),'timestamp':serverTimestamp()})]),console[_0x216484(0x6b)]('Awarded\x20'+_0x4f2aa6+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x5ce160+'\x20match');}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x395a76){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x395a76);}return console[_0x216484(0x6b)]('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x266eb4){console[_0x216484(0x92)]('Error\x20approving\x20report:',_0x266eb4);throw _0x266eb4;}}async function updatePlayerElo(_0x244b4e,_0x2b0711,_0x3e8284){await setDoc(doc(db,'players',_0x244b4e),{...playerData,'eloRating':_0x3e8284}),await checkAndRecordPromotion(_0x244b4e,_0x3e8284,_0x2b0711);}async function updatePlayerStats(_0x24d1d7,_0x46e6e2,_0x501d44){const _0x19d7af=a30_0x5b98,_0x268689=doc(db,'playerStats',_0x24d1d7),_0x2d1665=await getDoc(_0x268689);let _0x38efbf=_0x2d1665[_0x19d7af(0x8c)]()?_0x2d1665[_0x19d7af(0x91)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x501d44?(_0x38efbf[_0x19d7af(0x7c)]++,_0x38efbf['totalKills']+=parseInt(_0x46e6e2['winnerScore']||0x0),_0x38efbf['totalDeaths']+=parseInt(_0x46e6e2['loserScore']||0x0)):(_0x38efbf['losses']++,_0x38efbf[_0x19d7af(0x80)]+=parseInt(_0x46e6e2[_0x19d7af(0x69)]||0x0),_0x38efbf['totalDeaths']+=parseInt(_0x46e6e2['winnerScore']||0x0));const _0x3f51ed=_0x38efbf[_0x19d7af(0x7c)]+_0x38efbf[_0x19d7af(0x75)];_0x38efbf['winRate']=_0x3f51ed>0x0?(_0x38efbf[_0x19d7af(0x7c)]/_0x3f51ed*0x64)[_0x19d7af(0x85)](0x1):0x0,_0x38efbf['lastUpdated']=new Date()[_0x19d7af(0x8e)](),await setDoc(_0x268689,_0x38efbf,{'merge':!![]});}