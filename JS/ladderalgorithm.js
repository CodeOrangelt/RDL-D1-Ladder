const a30_0x17021f=(function(){let _0x2ef42c=!![];return function(_0x4f175b,_0x5adeff){const _0x3fe875=_0x2ef42c?function(){const _0x3c2545=a30_0x4f7e;if(_0x5adeff){const _0x3dad6e=_0x5adeff[_0x3c2545(0x1e5)](_0x4f175b,arguments);return _0x5adeff=null,_0x3dad6e;}}:function(){};return _0x2ef42c=![],_0x3fe875;};}()),a30_0x455b16=a30_0x17021f(this,function(){const _0x1e5b60=a30_0x4f7e,_0x2840a0=function(){const _0x3734f9=a30_0x4f7e;let _0x10639d;try{_0x10639d=Function('return\x20(function()\x20'+_0x3734f9(0x1cc)+');')();}catch(_0x329943){_0x10639d=window;}return _0x10639d;},_0x227cdb=_0x2840a0(),_0xa006a8=_0x227cdb['console']=_0x227cdb['console']||{},_0x29e85f=['log',_0x1e5b60(0x1ce),'info',_0x1e5b60(0x1c8),'exception','table',_0x1e5b60(0x1df)];for(let _0x28784f=0x0;_0x28784f<_0x29e85f['length'];_0x28784f++){const _0x42d5d6=a30_0x17021f[_0x1e5b60(0x1d5)]['prototype']['bind'](a30_0x17021f),_0x2008a5=_0x29e85f[_0x28784f],_0x14a375=_0xa006a8[_0x2008a5]||_0x42d5d6;_0x42d5d6[_0x1e5b60(0x1cd)]=a30_0x17021f[_0x1e5b60(0x1cf)](a30_0x17021f),_0x42d5d6[_0x1e5b60(0x1d9)]=_0x14a375['toString']['bind'](_0x14a375),_0xa006a8[_0x2008a5]=_0x42d5d6;}});a30_0x455b16();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';function a30_0x4f7e(_0x154727,_0x3016de){const _0x455b16=a30_0x3525();return a30_0x4f7e=function(_0x17021f,_0x3bbcf2){_0x17021f=_0x17021f-0x1c8;let _0x35251c=_0x455b16[_0x17021f];return _0x35251c;},a30_0x4f7e(_0x154727,_0x3016de);}import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x211eb9,_0x365707,_0x5d98a9=0x20){const _0xf4d20e=a30_0x4f7e,_0x1d535e=0x1/(0x1+Math[_0xf4d20e(0x1e3)](0xa,(_0x365707-_0x211eb9)/0x190)),_0x3e627a=0x1/(0x1+Math['pow'](0xa,(_0x211eb9-_0x365707)/0x190)),_0x33bf13=_0x211eb9+_0x5d98a9*(0x1-_0x1d535e),_0x8dbd9c=_0x365707+_0x5d98a9*(0x0-_0x3e627a);return{'newWinnerRating':Math['round'](_0x33bf13),'newLoserRating':Math['round'](_0x8dbd9c)};}export function assignDefaultEloRating(_0x565d12,_0x2ab291){const _0x34203c=a30_0x4f7e,_0x1044ea=0x4b0;!_0x2ab291['eloRating']&&db[_0x34203c(0x1dd)]('players')['doc'](_0x565d12)['update']({'eloRating':_0x1044ea})['then'](()=>{const _0x51359c=_0x34203c;console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x2ab291[_0x51359c(0x1d6)]);})['catch'](_0x3a72c6=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x3a72c6);});}export async function updateEloRatings(_0x1664c1,_0x306f82,_0x177e0f){const _0x30fd5f=a30_0x4f7e;try{const _0x527aea=writeBatch(db),_0x33cb52=doc(db,_0x30fd5f(0x1e1),_0x1664c1),_0x456d91=doc(db,'players',_0x306f82),[_0xc205e8,_0x5c18b7]=await Promise[_0x30fd5f(0x1d7)]([getDoc(_0x33cb52),getDoc(_0x456d91)]);if(!_0xc205e8['exists']()||!_0x5c18b7['exists']())throw new Error(_0x30fd5f(0x1ca));const _0x7561c5=_0xc205e8['data'](),_0x422064=_0x5c18b7['data'](),_0x4a8218=_0x7561c5['position']||Number['MAX_SAFE_INTEGER'],_0x363de9=_0x422064['position']||Number[_0x30fd5f(0x1cb)],{newWinnerRating:_0x184e12,newLoserRating:_0x5ad9c5}=calculateElo(_0x7561c5[_0x30fd5f(0x1e0)]||0x4b0,_0x422064['eloRating']||0x4b0);let _0x4d04df=_0x4a8218,_0x5134d1=_0x363de9;if(_0x4a8218>_0x363de9){console['log'](_0x30fd5f(0x1e2)),_0x4d04df=_0x363de9,_0x5134d1=_0x363de9+0x1;const _0x336add=query(collection(db,'players'),where(_0x30fd5f(0x1e4),'>',_0x363de9),where('position','<',_0x4a8218)),_0x4aa050=await getDocs(_0x336add);for(const _0x491f00 of _0x4aa050[_0x30fd5f(0x1da)]){_0x491f00['id']!==_0x1664c1&&_0x491f00['id']!==_0x306f82&&_0x527aea['update'](doc(db,_0x30fd5f(0x1e1),_0x491f00['id']),{'position':_0x491f00['data']()[_0x30fd5f(0x1e4)]+0x1});}}else console[_0x30fd5f(0x1d0)](_0x30fd5f(0x1c9));const _0x5b113d={'eloRating':_0x184e12,'lastMatchDate':serverTimestamp(),'position':_0x4d04df,'lastMatchId':_0x177e0f},_0x20f8ce={'eloRating':_0x5ad9c5,'lastMatchDate':serverTimestamp(),'position':_0x5134d1,'lastMatchId':_0x177e0f};return _0x527aea['update'](_0x33cb52,_0x5b113d),_0x527aea['update'](_0x456d91,_0x20f8ce),await _0x527aea['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x1664c1,'previousElo':_0x7561c5['eloRating']||0x4b0,'newElo':_0x184e12,'opponentId':_0x306f82,'matchResult':'win','previousPosition':_0x4a8218,'newPosition':_0x4d04df,'isPromotion':_0x4d04df<_0x4a8218,'matchId':_0x177e0f,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x306f82,'previousElo':_0x422064['eloRating']||0x4b0,'newElo':_0x5ad9c5,'opponentId':_0x1664c1,'matchResult':'loss','previousPosition':_0x363de9,'newPosition':_0x5134d1,'isDemotion':_0x5134d1>_0x363de9,'matchId':_0x177e0f,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x1664c1,_0x184e12,_0x7561c5['eloRating'],{'source':_0x30fd5f(0x1d4),'matchId':_0x177e0f}),await promotionManager['checkAndRecordPromotion'](_0x306f82,_0x5ad9c5,_0x422064['eloRating'],{'source':_0x30fd5f(0x1d4),'matchId':_0x177e0f}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x119203){console[_0x30fd5f(0x1c8)]('Error\x20in\x20updateEloRatings:',_0x119203);throw _0x119203;}}export async function approveReport(_0xdd9ae4,_0x8e25f,_0x162fbb,_0x6cad30,_0x5ab0d5){const _0x4564ed=a30_0x4f7e;try{const _0x277ec8=doc(db,_0x4564ed(0x1d3),_0xdd9ae4),_0x320b06=await getDoc(_0x277ec8);if(!_0x320b06['exists']())throw new Error('Report\x20not\x20found');const _0x1b142c=_0x320b06['data'](),_0x263db1={..._0x1b142c,'winnerScore':_0x8e25f,'winnerSuicides':_0x162fbb,'winnerComment':_0x6cad30,'winnerDemoLink':_0x5ab0d5,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x4564ed(0x1de)]};await setDoc(doc(db,'approvedMatches',_0xdd9ae4),_0x263db1),await deleteDoc(_0x277ec8),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x2a6e0b,_0x3ceedb]=await Promise['all']([getDocs(query(collection(db,'players'),where(_0x4564ed(0x1d6),'==',_0x1b142c['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x1b142c['loserUsername'])))]);if(_0x2a6e0b[_0x4564ed(0x1d8)]||_0x3ceedb['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x1a3996=_0x2a6e0b['docs'][0x0]['id'],_0x1f62a9=_0x3ceedb[_0x4564ed(0x1da)][0x0]['id'];await updateEloRatings(_0x1a3996,_0x1f62a9,_0xdd9ae4);try{await awardMatchPoints(_0x1a3996,_0x1f62a9,_0x1b142c['subgameType']);}catch(_0x54c447){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x54c447);}return console[_0x4564ed(0x1d0)]('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x204af7){console['error'](_0x4564ed(0x1d2),_0x204af7);throw _0x204af7;}}async function updatePlayerElo(_0xffdfbb,_0x4b3419,_0x494710){await setDoc(doc(db,'players',_0xffdfbb),{...playerData,'eloRating':_0x494710}),await checkAndRecordPromotion(_0xffdfbb,_0x494710,_0x4b3419);}async function updatePlayerStats(_0x1d55d0,_0x4c22ae,_0x3cda76){const _0x209b68=a30_0x4f7e,_0x39f31b=doc(db,'playerStats',_0x1d55d0),_0x181c7f=await getDoc(_0x39f31b);let _0x40b202=_0x181c7f['exists']()?_0x181c7f['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x3cda76?(_0x40b202[_0x209b68(0x1d1)]++,_0x40b202['totalKills']+=parseInt(_0x4c22ae['winnerScore']||0x0),_0x40b202['totalDeaths']+=parseInt(_0x4c22ae['loserScore']||0x0)):(_0x40b202['losses']++,_0x40b202['totalKills']+=parseInt(_0x4c22ae['loserScore']||0x0),_0x40b202[_0x209b68(0x1db)]+=parseInt(_0x4c22ae[_0x209b68(0x1e7)]||0x0));const _0x15ab1f=_0x40b202['wins']+_0x40b202['losses'];_0x40b202[_0x209b68(0x1dc)]=_0x15ab1f>0x0?(_0x40b202[_0x209b68(0x1d1)]/_0x15ab1f*0x64)['toFixed'](0x1):0x0,_0x40b202[_0x209b68(0x1e6)]=new Date()['toISOString'](),await setDoc(_0x39f31b,_0x40b202,{'merge':!![]});}function a30_0x3525(){const _0x2f07a8=['error','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','One\x20or\x20both\x20players\x20not\x20found','MAX_SAFE_INTEGER','{}.constructor(\x22return\x20this\x22)(\x20)','__proto__','warn','bind','log','wins','Error\x20approving\x20report:','pendingMatches','match','constructor','username','all','empty','toString','docs','totalDeaths','winRate','collection','uid','trace','eloRating','players','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','pow','position','apply','lastUpdated','winnerScore'];a30_0x3525=function(){return _0x2f07a8;};return a30_0x3525();}