const a30_0x49973a=(function(){let _0x5bfe56=!![];return function(_0xf697ad,_0x404e0d){const _0x49d630=_0x5bfe56?function(){if(_0x404e0d){const _0x1d3005=_0x404e0d['apply'](_0xf697ad,arguments);return _0x404e0d=null,_0x1d3005;}}:function(){};return _0x5bfe56=![],_0x49d630;};}()),a30_0x551ebb=a30_0x49973a(this,function(){const _0x5bf8e7=a30_0x441b;let _0x1e7edf;try{const _0x3b38c9=Function(_0x5bf8e7(0x1ac)+_0x5bf8e7(0x1b9)+');');_0x1e7edf=_0x3b38c9();}catch(_0x1280c5){_0x1e7edf=window;}const _0xefb059=_0x1e7edf['console']=_0x1e7edf['console']||{},_0x32a2ca=['log','warn','info','error','exception','table','trace'];for(let _0x4cf9e0=0x0;_0x4cf9e0<_0x32a2ca[_0x5bf8e7(0x1b1)];_0x4cf9e0++){const _0x48602a=a30_0x49973a['constructor']['prototype'][_0x5bf8e7(0x1b7)](a30_0x49973a),_0x5bea0d=_0x32a2ca[_0x4cf9e0],_0x40a8ff=_0xefb059[_0x5bea0d]||_0x48602a;_0x48602a[_0x5bf8e7(0x1b2)]=a30_0x49973a['bind'](a30_0x49973a),_0x48602a['toString']=_0x40a8ff['toString'][_0x5bf8e7(0x1b7)](_0x40a8ff),_0xefb059[_0x5bea0d]=_0x48602a;}});a30_0x551ebb();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x5b2b2e,_0x5ab331,_0xd2dcac=0x20){const _0x427348=a30_0x441b,_0x44d012=0x1/(0x1+Math['pow'](0xa,(_0x5ab331-_0x5b2b2e)/0x190)),_0x1fd0b4=0x1/(0x1+Math['pow'](0xa,(_0x5b2b2e-_0x5ab331)/0x190)),_0x2d3ac2=_0x5b2b2e+_0xd2dcac*(0x1-_0x44d012),_0x2c1db4=_0x5ab331+_0xd2dcac*(0x0-_0x1fd0b4);return{'newWinnerRating':Math['round'](_0x2d3ac2),'newLoserRating':Math[_0x427348(0x1ba)](_0x2c1db4)};}export function assignDefaultEloRating(_0x4c07ee,_0x15d760){const _0xc16749=a30_0x441b,_0x3c0458=0x4b0;!_0x15d760['eloRating']&&db[_0xc16749(0x1a7)]('players')['doc'](_0x4c07ee)[_0xc16749(0x1c1)]({'eloRating':_0x3c0458})['then'](()=>{const _0x4b57ff=_0xc16749;console['log'](_0x4b57ff(0x1ae)+_0x15d760['username']);})['catch'](_0x3cbed2=>{const _0x258193=_0xc16749;console['error'](_0x258193(0x1c2),_0x3cbed2);});}function a30_0x220d(){const _0x2f38e1=['totalDeaths','ELO\x20ratings\x20updated\x20successfully','collection','eloRating','pendingMatches','docs','losses','return\x20(function()\x20','username','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','subgameType','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','length','__proto__','lastUpdated','all','MAX_SAFE_INTEGER','exists','bind','players','{}.constructor(\x22return\x20this\x22)(\x20)','round','position','data','wins','winnerScore','log','One\x20or\x20both\x20players\x20not\x20found','update','Error\x20assigning\x20default\x20ELO\x20rating:','totalKills'];a30_0x220d=function(){return _0x2f38e1;};return a30_0x220d();}export async function updateEloRatings(_0x4339ee,_0x3d17a7,_0x59c786){const _0x5490b7=a30_0x441b;try{const _0x2b4a7a=writeBatch(db),_0x1ffae2=doc(db,'players',_0x4339ee),_0x5b5f3c=doc(db,'players',_0x3d17a7),[_0x442d32,_0x4ace81]=await Promise['all']([getDoc(_0x1ffae2),getDoc(_0x5b5f3c)]);if(!_0x442d32[_0x5490b7(0x1b6)]()||!_0x4ace81[_0x5490b7(0x1b6)]())throw new Error(_0x5490b7(0x1c0));const _0x13cc12=_0x442d32['data'](),_0x7e3ce=_0x4ace81[_0x5490b7(0x1bc)](),_0x381cdd=_0x13cc12[_0x5490b7(0x1bb)]||Number['MAX_SAFE_INTEGER'],_0x31c1d5=_0x7e3ce['position']||Number[_0x5490b7(0x1b5)],{newWinnerRating:_0x21238f,newLoserRating:_0x4c499d}=calculateElo(_0x13cc12['eloRating']||0x4b0,_0x7e3ce[_0x5490b7(0x1a8)]||0x4b0);let _0x1f1df3=_0x381cdd,_0xa6a8de=_0x31c1d5;if(_0x381cdd>_0x31c1d5){console[_0x5490b7(0x1bf)]('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x1f1df3=_0x31c1d5,_0xa6a8de=_0x31c1d5+0x1;const _0x4a76f7=query(collection(db,_0x5490b7(0x1b8)),where(_0x5490b7(0x1bb),'>',_0x31c1d5),where('position','<',_0x381cdd)),_0xc5110c=await getDocs(_0x4a76f7);for(const _0x1cfd69 of _0xc5110c[_0x5490b7(0x1aa)]){_0x1cfd69['id']!==_0x4339ee&&_0x1cfd69['id']!==_0x3d17a7&&_0x2b4a7a['update'](doc(db,'players',_0x1cfd69['id']),{'position':_0x1cfd69['data']()[_0x5490b7(0x1bb)]+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x4486f3={'eloRating':_0x21238f,'lastMatchDate':serverTimestamp(),'position':_0x1f1df3,'lastMatchId':_0x59c786},_0x29bab4={'eloRating':_0x4c499d,'lastMatchDate':serverTimestamp(),'position':_0xa6a8de,'lastMatchId':_0x59c786};return _0x2b4a7a[_0x5490b7(0x1c1)](_0x1ffae2,_0x4486f3),_0x2b4a7a[_0x5490b7(0x1c1)](_0x5b5f3c,_0x29bab4),await _0x2b4a7a['commit'](),console['log'](_0x5490b7(0x1a6)),await Promise[_0x5490b7(0x1b4)]([recordEloChange({'playerId':_0x4339ee,'previousElo':_0x13cc12[_0x5490b7(0x1a8)]||0x4b0,'newElo':_0x21238f,'opponentId':_0x3d17a7,'matchResult':'win','previousPosition':_0x381cdd,'newPosition':_0x1f1df3,'isPromotion':_0x1f1df3<_0x381cdd,'matchId':_0x59c786,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x3d17a7,'previousElo':_0x7e3ce['eloRating']||0x4b0,'newElo':_0x4c499d,'opponentId':_0x4339ee,'matchResult':'loss','previousPosition':_0x31c1d5,'newPosition':_0xa6a8de,'isDemotion':_0xa6a8de>_0x31c1d5,'matchId':_0x59c786,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x4339ee,_0x21238f,_0x13cc12['eloRating'],{'source':'match','matchId':_0x59c786}),await promotionManager['checkAndRecordPromotion'](_0x3d17a7,_0x4c499d,_0x7e3ce['eloRating'],{'source':'match','matchId':_0x59c786}),console['log'](_0x5490b7(0x1b0)),!![];}catch(_0x5aac04){console['error']('Error\x20in\x20updateEloRatings:',_0x5aac04);throw _0x5aac04;}}function a30_0x441b(_0x1ecf86,_0x8f2a83){const _0x551ebb=a30_0x220d();return a30_0x441b=function(_0x49973a,_0xa84b4f){_0x49973a=_0x49973a-0x1a5;let _0x220df5=_0x551ebb[_0x49973a];return _0x220df5;},a30_0x441b(_0x1ecf86,_0x8f2a83);}export async function approveReport(_0x5b18b9,_0x3871e4,_0x1c5cba,_0x4265d7,_0x21dea5){const _0x518926=a30_0x441b;try{const _0x5c1a7f=doc(db,_0x518926(0x1a9),_0x5b18b9),_0x60cbff=await getDoc(_0x5c1a7f);if(!_0x60cbff[_0x518926(0x1b6)]())throw new Error('Report\x20not\x20found');const _0x3b5f8d=_0x60cbff[_0x518926(0x1bc)](),_0x530103={..._0x3b5f8d,'winnerScore':_0x3871e4,'winnerSuicides':_0x1c5cba,'winnerComment':_0x4265d7,'winnerDemoLink':_0x21dea5,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x5b18b9),_0x530103),await deleteDoc(_0x5c1a7f),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x4a49e4,_0x1b4462]=await Promise[_0x518926(0x1b4)]([getDocs(query(collection(db,'players'),where(_0x518926(0x1ad),'==',_0x3b5f8d['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x3b5f8d['loserUsername'])))]);if(_0x4a49e4['empty']||_0x1b4462['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x2bc61d=_0x4a49e4['docs'][0x0]['id'],_0x45f5e8=_0x1b4462['docs'][0x0]['id'];await updateEloRatings(_0x2bc61d,_0x45f5e8,_0x5b18b9);try{await awardMatchPoints(_0x2bc61d,_0x45f5e8,_0x3b5f8d[_0x518926(0x1af)]);}catch(_0x5d9ae5){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x5d9ae5);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x549100){console['error']('Error\x20approving\x20report:',_0x549100);throw _0x549100;}}async function updatePlayerElo(_0x36a954,_0x49d5c1,_0x54c4c1){await setDoc(doc(db,'players',_0x36a954),{...playerData,'eloRating':_0x54c4c1}),await checkAndRecordPromotion(_0x36a954,_0x54c4c1,_0x49d5c1);}async function updatePlayerStats(_0x2f4909,_0x434177,_0x2224da){const _0x10b7d5=a30_0x441b,_0xd7db02=doc(db,'playerStats',_0x2f4909),_0xb3fa02=await getDoc(_0xd7db02);let _0x469750=_0xb3fa02['exists']()?_0xb3fa02['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x2224da?(_0x469750['wins']++,_0x469750[_0x10b7d5(0x1c3)]+=parseInt(_0x434177['winnerScore']||0x0),_0x469750['totalDeaths']+=parseInt(_0x434177['loserScore']||0x0)):(_0x469750['losses']++,_0x469750['totalKills']+=parseInt(_0x434177['loserScore']||0x0),_0x469750[_0x10b7d5(0x1a5)]+=parseInt(_0x434177[_0x10b7d5(0x1be)]||0x0));const _0x1d309f=_0x469750['wins']+_0x469750[_0x10b7d5(0x1ab)];_0x469750['winRate']=_0x1d309f>0x0?(_0x469750[_0x10b7d5(0x1bd)]/_0x1d309f*0x64)['toFixed'](0x1):0x0,_0x469750[_0x10b7d5(0x1b3)]=new Date()['toISOString'](),await setDoc(_0xd7db02,_0x469750,{'merge':!![]});}