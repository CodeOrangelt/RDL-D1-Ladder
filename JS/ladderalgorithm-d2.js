const a26_0x1605c1=(function(){let _0x54ad94=!![];return function(_0x36a31e,_0x148c23){const _0x116eca=_0x54ad94?function(){if(_0x148c23){const _0x5f4923=_0x148c23['apply'](_0x36a31e,arguments);return _0x148c23=null,_0x5f4923;}}:function(){};return _0x54ad94=![],_0x116eca;};}()),a26_0x565134=a26_0x1605c1(this,function(){const _0x25eb4d=a26_0xcbc8,_0x5e1ccb=function(){let _0x398e77;try{_0x398e77=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x4f368f){_0x398e77=window;}return _0x398e77;},_0x1aed1b=_0x5e1ccb(),_0x19a9a5=_0x1aed1b['console']=_0x1aed1b['console']||{},_0xeaf4b=[_0x25eb4d(0x193),_0x25eb4d(0x197),'info','error',_0x25eb4d(0x199),'table',_0x25eb4d(0x186)];for(let _0x396b5f=0x0;_0x396b5f<_0xeaf4b['length'];_0x396b5f++){const _0xb21e9f=a26_0x1605c1['constructor']['prototype']['bind'](a26_0x1605c1),_0x3af58c=_0xeaf4b[_0x396b5f],_0x3bc15a=_0x19a9a5[_0x3af58c]||_0xb21e9f;_0xb21e9f['__proto__']=a26_0x1605c1['bind'](a26_0x1605c1),_0xb21e9f[_0x25eb4d(0x189)]=_0x3bc15a['toString']['bind'](_0x3bc15a),_0x19a9a5[_0x3af58c]=_0xb21e9f;}});function a26_0xcbc8(_0x91a872,_0x42e2d9){const _0x565134=a26_0x13c1();return a26_0xcbc8=function(_0x1605c1,_0x55669c){_0x1605c1=_0x1605c1-0x180;let _0x13c111=_0x565134[_0x1605c1];return _0x13c111;},a26_0xcbc8(_0x91a872,_0x42e2d9);}a26_0x565134();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x434f84 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x2c6ffa,_0x1931f3,_0x2c7256=0x20){const _0x4548ac=a26_0xcbc8,_0x2ab081=0x1/(0x1+Math['pow'](0xa,(_0x1931f3-_0x2c6ffa)/0x190)),_0x46b6e2=0x1/(0x1+Math[_0x4548ac(0x180)](0xa,(_0x2c6ffa-_0x1931f3)/0x190)),_0x99a98a=_0x2c6ffa+_0x2c7256*(0x1-_0x2ab081),_0x31850f=_0x1931f3+_0x2c7256*(0x0-_0x46b6e2);return{'newWinnerRating':Math['round'](_0x99a98a),'newLoserRating':Math['round'](_0x31850f)};}export async function updateEloRatingsD2(_0x4cd634,_0x5d5cca,_0x4eef1d){const _0x132040=a26_0xcbc8;try{const _0x159443=writeBatch(db),_0x317cea=doc(db,_0x132040(0x190),_0x4cd634),_0x3245c7=doc(db,'playersD2',_0x5d5cca),[_0x5a5f60,_0x6cb86b]=await Promise['all']([getDoc(_0x317cea),getDoc(_0x3245c7)]);if(!_0x5a5f60[_0x132040(0x198)]()||!_0x6cb86b[_0x132040(0x198)]())throw new Error(_0x132040(0x194));const _0xc03f91=_0x5a5f60[_0x132040(0x187)](),_0x4b6aa5=_0x6cb86b['data'](),_0x3d4dab=_0xc03f91['position']||Number[_0x132040(0x184)],_0x3b6eee=_0x4b6aa5['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x1abd67,newLoserRating:_0xda9e15}=calculateEloD2(_0xc03f91[_0x132040(0x18a)]||0x4b0,_0x4b6aa5['eloRating']||0x4b0);let _0x2324a9=_0x3d4dab,_0x5c763e=_0x3b6eee;if(_0x3d4dab>_0x3b6eee){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x2324a9=_0x3b6eee,_0x5c763e=_0x3b6eee+0x1;const _0x2b2c7b=query(collection(db,'playersD2'),where(_0x132040(0x18b),'>',_0x3b6eee),where(_0x132040(0x18b),'<',_0x3d4dab)),_0x449f35=await getDocs(_0x2b2c7b);for(const _0x50c9dd of _0x449f35['docs']){_0x50c9dd['id']!==_0x4cd634&&_0x50c9dd['id']!==_0x5d5cca&&_0x159443['update'](doc(db,_0x132040(0x190),_0x50c9dd['id']),{'position':_0x50c9dd['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x159443['update'](_0x317cea,{'eloRating':_0x1abd67,'lastMatchDate':serverTimestamp(),'position':_0x2324a9,'lastMatchId':_0x4eef1d}),_0x159443['update'](_0x3245c7,{'eloRating':_0xda9e15,'lastMatchDate':serverTimestamp(),'position':_0x5c763e,'lastMatchId':_0x4eef1d}),await _0x159443[_0x132040(0x195)](),console[_0x132040(0x193)](_0x132040(0x18e)),await Promise['all']([recordEloChangeD2({'playerId':_0x4cd634,'previousElo':_0xc03f91[_0x132040(0x18a)]||0x4b0,'newElo':_0x1abd67,'opponentId':_0x5d5cca,'matchResult':'win','previousPosition':_0x3d4dab,'newPosition':_0x2324a9,'isPromotion':_0x2324a9<_0x3d4dab,'matchId':_0x4eef1d,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x5d5cca,'previousElo':_0x4b6aa5[_0x132040(0x18a)]||0x4b0,'newElo':_0xda9e15,'opponentId':_0x4cd634,'matchResult':'loss','previousPosition':_0x3b6eee,'newPosition':_0x5c763e,'isDemotion':_0x5c763e>_0x3b6eee,'matchId':_0x4eef1d,'timestamp':serverTimestamp()})]),await promotionManager[_0x132040(0x18f)](_0x4cd634,_0x1abd67,_0xc03f91['eloRating'],{'source':'match-d2','matchId':_0x4eef1d}),await promotionManager[_0x132040(0x18f)](_0x5d5cca,_0xda9e15,_0x4b6aa5['eloRating'],{'source':'match-d2','matchId':_0x4eef1d}),!![];}catch(_0x42a5ff){console[_0x132040(0x188)]('Error\x20in\x20updateEloRatingsD2:',_0x42a5ff);throw _0x42a5ff;}}function a26_0x13c1(){const _0x13abca=['pow','empty','docs','email','MAX_SAFE_INTEGER','pendingMatchesD2','trace','data','error','toString','eloRating','position','winnerUsername','approvedMatchesD2','D2\x20ELO\x20ratings\x20updated\x20successfully','checkAndRecordPromotion','playersD2','Error\x20in\x20approveReportD2:','username','log','One\x20or\x20both\x20D2\x20players\x20not\x20found','commit','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','warn','exists','exception'];a26_0x13c1=function(){return _0x13abca;};return a26_0x13c1();}export async function approveReportD2(_0x518e0d,_0x496a9e,_0x27649e,_0x29f6ea){const _0x443ff8=a26_0xcbc8;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x518e0d,'winnerScore':_0x496a9e,'winnerSuicides':_0x27649e,'winnerComment':_0x29f6ea});const _0x9980e8=auth['currentUser'];if(!_0x9980e8){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console[_0x443ff8(0x193)]('Current\x20user:',_0x9980e8[_0x443ff8(0x183)]);const _0x48a54c=await getDoc(doc(db,_0x443ff8(0x190),_0x9980e8['uid'])),_0x1f2fee=_0x48a54c[_0x443ff8(0x198)]()?_0x48a54c['data']()[_0x443ff8(0x192)]:null;console[_0x443ff8(0x193)]('Current\x20username:',_0x1f2fee);const _0x1116b6=doc(db,_0x443ff8(0x185),_0x518e0d),_0x440d6c=await getDoc(_0x1116b6);if(!_0x440d6c['exists']()){console[_0x443ff8(0x193)]('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x518e0d);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x33c309=_0x440d6c[_0x443ff8(0x187)]();console['log']('D2\x20Report\x20data:',_0x33c309);if(_0x1f2fee!==_0x33c309[_0x443ff8(0x18c)])throw new Error(_0x443ff8(0x196));const _0x4aa57f={..._0x33c309,'winnerScore':_0x496a9e,'winnerSuicides':_0x27649e,'winnerComment':_0x29f6ea,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1f2fee,'createdAt':_0x33c309['createdAt']||serverTimestamp(),'winnerUsername':_0x33c309[_0x443ff8(0x18c)],'loserUsername':_0x33c309['loserUsername']};await setDoc(doc(db,_0x443ff8(0x18d),_0x518e0d),_0x4aa57f),await deleteDoc(_0x1116b6),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x199d13,_0x2c647d]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where(_0x443ff8(0x192),'==',_0x33c309['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x33c309['loserUsername'])))]);if(_0x199d13[_0x443ff8(0x181)]||_0x2c647d['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x42eb5d=_0x199d13[_0x443ff8(0x182)][0x0]['id'],_0x51536e=_0x2c647d['docs'][0x0]['id'];return await updateEloRatingsD2(_0x42eb5d,_0x51536e,_0x518e0d),console[_0x443ff8(0x193)]('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x387b0f){console['error'](_0x443ff8(0x191),_0x387b0f);throw _0x387b0f;}}