const a28_0x2a8a05=(function(){let _0x737c0=!![];return function(_0x71db52,_0x2e8b4c){const _0x4650e2=_0x737c0?function(){if(_0x2e8b4c){const _0xd79292=_0x2e8b4c['apply'](_0x71db52,arguments);return _0x2e8b4c=null,_0xd79292;}}:function(){};return _0x737c0=![],_0x4650e2;};}()),a28_0x208ea5=a28_0x2a8a05(this,function(){const _0x494ae3=a28_0x52bc;let _0x4ea9cf;try{const _0x4ee11a=Function(_0x494ae3(0x172)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x4ea9cf=_0x4ee11a();}catch(_0x363528){_0x4ea9cf=window;}const _0x4ca157=_0x4ea9cf['console']=_0x4ea9cf['console']||{},_0x359cb2=['log','warn',_0x494ae3(0x161),'error','exception','table','trace'];for(let _0x1bcef7=0x0;_0x1bcef7<_0x359cb2['length'];_0x1bcef7++){const _0xd032d3=a28_0x2a8a05['constructor']['prototype']['bind'](a28_0x2a8a05),_0x4e8a69=_0x359cb2[_0x1bcef7],_0x5d374e=_0x4ca157[_0x4e8a69]||_0xd032d3;_0xd032d3[_0x494ae3(0x16d)]=a28_0x2a8a05['bind'](a28_0x2a8a05),_0xd032d3['toString']=_0x5d374e['toString']['bind'](_0x5d374e),_0x4ca157[_0x4e8a69]=_0xd032d3;}});a28_0x208ea5();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x52bc(_0x1745d7,_0x5cf66b){const _0x208ea5=a28_0x59c3();return a28_0x52bc=function(_0x2a8a05,_0x24f545){_0x2a8a05=_0x2a8a05-0x15e;let _0x59c39d=_0x208ea5[_0x2a8a05];return _0x59c39d;},a28_0x52bc(_0x1745d7,_0x5cf66b);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x3cf5e1 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x53aeb0,_0x4e191b,_0x25dc29=0x20){const _0x463d56=a28_0x52bc,_0x9ff513=0x1/(0x1+Math['pow'](0xa,(_0x4e191b-_0x53aeb0)/0x190)),_0x3436fe=0x1/(0x1+Math[_0x463d56(0x16f)](0xa,(_0x53aeb0-_0x4e191b)/0x190)),_0x51052a=_0x53aeb0+_0x25dc29*(0x1-_0x9ff513),_0x5738d1=_0x4e191b+_0x25dc29*(0x0-_0x3436fe);return{'newWinnerRating':Math['round'](_0x51052a),'newLoserRating':Math['round'](_0x5738d1)};}function a28_0x59c3(){const _0x2a2581=['error','Error\x20in\x20approveReportD2:','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','info','data','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','MAX_SAFE_INTEGER','email','win','Error\x20in\x20updateEloRatingsD2:','match-d2','commit','username','log','eloRating','__proto__','checkAndRecordPromotion','pow','playersD2','position','return\x20(function()\x20','all','exists','update'];a28_0x59c3=function(){return _0x2a2581;};return a28_0x59c3();}export async function updateEloRatingsD2(_0x19f647,_0x2ac547,_0x3d011d){const _0x53918c=a28_0x52bc;try{const _0x525f97=writeBatch(db),_0xb6a855=doc(db,'playersD2',_0x19f647),_0x2f96a8=doc(db,_0x53918c(0x170),_0x2ac547),[_0x37070f,_0x339e67]=await Promise['all']([getDoc(_0xb6a855),getDoc(_0x2f96a8)]);if(!_0x37070f[_0x53918c(0x174)]()||!_0x339e67['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x51e35c=_0x37070f['data'](),_0x1a2cf8=_0x339e67[_0x53918c(0x162)](),_0x4ef52c=_0x51e35c['position']||Number['MAX_SAFE_INTEGER'],_0x451200=_0x1a2cf8[_0x53918c(0x171)]||Number[_0x53918c(0x164)],{newWinnerRating:_0x31e656,newLoserRating:_0x162376}=calculateEloD2(_0x51e35c['eloRating']||0x4b0,_0x1a2cf8[_0x53918c(0x16c)]||0x4b0);let _0x123d05=_0x4ef52c,_0x366f65=_0x451200;if(_0x4ef52c>_0x451200){console[_0x53918c(0x16b)](_0x53918c(0x163)),_0x123d05=_0x451200,_0x366f65=_0x451200+0x1;const _0x1c4969=query(collection(db,'playersD2'),where(_0x53918c(0x171),'>',_0x451200),where('position','<',_0x4ef52c)),_0xea2939=await getDocs(_0x1c4969);for(const _0x2f9435 of _0xea2939['docs']){_0x2f9435['id']!==_0x19f647&&_0x2f9435['id']!==_0x2ac547&&_0x525f97[_0x53918c(0x175)](doc(db,_0x53918c(0x170),_0x2f9435['id']),{'position':_0x2f9435['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x525f97['update'](_0xb6a855,{'eloRating':_0x31e656,'lastMatchDate':serverTimestamp(),'position':_0x123d05,'lastMatchId':_0x3d011d}),_0x525f97['update'](_0x2f96a8,{'eloRating':_0x162376,'lastMatchDate':serverTimestamp(),'position':_0x366f65,'lastMatchId':_0x3d011d}),await _0x525f97[_0x53918c(0x169)](),console[_0x53918c(0x16b)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x19f647,'previousElo':_0x51e35c['eloRating']||0x4b0,'newElo':_0x31e656,'opponentId':_0x2ac547,'matchResult':_0x53918c(0x166),'previousPosition':_0x4ef52c,'newPosition':_0x123d05,'isPromotion':_0x123d05<_0x4ef52c,'matchId':_0x3d011d,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x2ac547,'previousElo':_0x1a2cf8['eloRating']||0x4b0,'newElo':_0x162376,'opponentId':_0x19f647,'matchResult':'loss','previousPosition':_0x451200,'newPosition':_0x366f65,'isDemotion':_0x366f65>_0x451200,'matchId':_0x3d011d,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x19f647,_0x31e656,_0x51e35c[_0x53918c(0x16c)],{'source':'match-d2','matchId':_0x3d011d}),await promotionManager[_0x53918c(0x16e)](_0x2ac547,_0x162376,_0x1a2cf8['eloRating'],{'source':_0x53918c(0x168),'matchId':_0x3d011d}),!![];}catch(_0x2c20f4){console[_0x53918c(0x15e)](_0x53918c(0x167),_0x2c20f4);throw _0x2c20f4;}}export async function approveReportD2(_0x5cfe61,_0x17839f,_0x4ac714,_0x2b35c9){const _0x3c61fa=a28_0x52bc;try{console[_0x3c61fa(0x16b)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x5cfe61,'winnerScore':_0x17839f,'winnerSuicides':_0x4ac714,'winnerComment':_0x2b35c9});const _0x2bfcde=auth['currentUser'];if(!_0x2bfcde){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x2bfcde[_0x3c61fa(0x165)]);const _0x3c333f=await getDoc(doc(db,_0x3c61fa(0x170),_0x2bfcde['uid'])),_0x23f8c3=_0x3c333f['exists']()?_0x3c333f[_0x3c61fa(0x162)]()[_0x3c61fa(0x16a)]:null;console['log']('Current\x20username:',_0x23f8c3);const _0x3fa131=doc(db,'pendingMatchesD2',_0x5cfe61),_0xb64fe1=await getDoc(_0x3fa131);if(!_0xb64fe1[_0x3c61fa(0x174)]()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x5cfe61);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x5a952a=_0xb64fe1['data']();console['log']('D2\x20Report\x20data:',_0x5a952a);if(_0x23f8c3!==_0x5a952a['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x37d4d5={..._0x5a952a,'winnerScore':_0x17839f,'winnerSuicides':_0x4ac714,'winnerComment':_0x2b35c9,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x23f8c3,'createdAt':_0x5a952a['createdAt']||serverTimestamp(),'winnerUsername':_0x5a952a['winnerUsername'],'loserUsername':_0x5a952a['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x5cfe61),_0x37d4d5),await deleteDoc(_0x3fa131),console[_0x3c61fa(0x16b)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x304a53,_0x268c20]=await Promise[_0x3c61fa(0x173)]([getDocs(query(collection(db,'playersD2'),where(_0x3c61fa(0x16a),'==',_0x5a952a['winnerUsername']))),getDocs(query(collection(db,_0x3c61fa(0x170)),where(_0x3c61fa(0x16a),'==',_0x5a952a['loserUsername'])))]);if(_0x304a53['empty']||_0x268c20['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x53eb7c=_0x304a53['docs'][0x0]['id'],_0x5ed8d1=_0x268c20['docs'][0x0]['id'];return await updateEloRatingsD2(_0x53eb7c,_0x5ed8d1,_0x5cfe61),console['log'](_0x3c61fa(0x160)),!![];}catch(_0x4b997f){console['error'](_0x3c61fa(0x15f),_0x4b997f);throw _0x4b997f;}}