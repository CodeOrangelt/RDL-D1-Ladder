function a29_0x4a19(){const _0x3fc46e=['D3\x20Report\x20not\x20found\x20with\x20ID:','trace','pendingMatchesD3','Current\x20username:','prototype','docs','winnerUsername','Error\x20in\x20approveReportD3:','exception','error','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','console','commit','eloRating','win','exists','One\x20or\x20both\x20D3\x20players\x20not\x20found','username','warn','update','empty','MAX_SAFE_INTEGER','length','playersD3','round','loserUsername','D3\x20Report\x20data:','loss','all','position','data','log'];a29_0x4a19=function(){return _0x3fc46e;};return a29_0x4a19();}const a29_0x5d1cf6=(function(){let _0x325eb4=!![];return function(_0x27163b,_0x4c54d0){const _0x30b64b=_0x325eb4?function(){if(_0x4c54d0){const _0x5d50d9=_0x4c54d0['apply'](_0x27163b,arguments);return _0x4c54d0=null,_0x5d50d9;}}:function(){};return _0x325eb4=![],_0x30b64b;};}()),a29_0x12819d=a29_0x5d1cf6(this,function(){const _0x804962=a29_0x32af,_0x5a3db5=function(){let _0x49a105;try{_0x49a105=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x2ad046){_0x49a105=window;}return _0x49a105;},_0x4c3bac=_0x5a3db5(),_0x37c436=_0x4c3bac[_0x804962(0xf0)]=_0x4c3bac[_0x804962(0xf0)]||{},_0x59f3af=[_0x804962(0x104),_0x804962(0xf7),'info',_0x804962(0xee),_0x804962(0xed),'table',_0x804962(0xe6)];for(let _0x25cfa3=0x0;_0x25cfa3<_0x59f3af[_0x804962(0xfb)];_0x25cfa3++){const _0x3887b9=a29_0x5d1cf6['constructor'][_0x804962(0xe9)]['bind'](a29_0x5d1cf6),_0x131394=_0x59f3af[_0x25cfa3],_0x24de3d=_0x37c436[_0x131394]||_0x3887b9;_0x3887b9['__proto__']=a29_0x5d1cf6['bind'](a29_0x5d1cf6),_0x3887b9['toString']=_0x24de3d['toString']['bind'](_0x24de3d),_0x37c436[_0x131394]=_0x3887b9;}});a29_0x12819d();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x4f1320,_0x2cd2c6,_0x2fc4f0=0x20){const _0x1cc20e=a29_0x32af,_0x563241=0x1/(0x1+Math['pow'](0xa,(_0x2cd2c6-_0x4f1320)/0x190)),_0x41b018=0x1/(0x1+Math['pow'](0xa,(_0x4f1320-_0x2cd2c6)/0x190)),_0x1f3027=_0x4f1320+_0x2fc4f0*(0x1-_0x563241),_0x21fd26=_0x2cd2c6+_0x2fc4f0*(0x0-_0x41b018);return{'newWinnerRating':Math['round'](_0x1f3027),'newLoserRating':Math[_0x1cc20e(0xfd)](_0x21fd26)};}function a29_0x32af(_0x580c7c,_0x4f64e3){const _0x12819d=a29_0x4a19();return a29_0x32af=function(_0x5d1cf6,_0x3eaddd){_0x5d1cf6=_0x5d1cf6-0xe5;let _0x4a1910=_0x12819d[_0x5d1cf6];return _0x4a1910;},a29_0x32af(_0x580c7c,_0x4f64e3);}export async function updateEloRatingsD3(_0x2d96db,_0x3a27a4,_0x1b2f6e){const _0x1d7155=a29_0x32af;try{const _0x12ccad=writeBatch(db),_0x4ecf1c=doc(db,'playersD3',_0x2d96db),_0x461b0c=doc(db,'playersD3',_0x3a27a4),[_0x390fdd,_0x436eda]=await Promise['all']([getDoc(_0x4ecf1c),getDoc(_0x461b0c)]);if(!_0x390fdd['exists']()||!_0x436eda[_0x1d7155(0xf4)]())throw new Error(_0x1d7155(0xf5));const _0xff0262=_0x390fdd['data'](),_0x144e30=_0x436eda['data'](),_0x399279=_0xff0262[_0x1d7155(0x102)]||Number[_0x1d7155(0xfa)],_0x1e6919=_0x144e30[_0x1d7155(0x102)]||Number[_0x1d7155(0xfa)],{newWinnerRating:_0x326af9,newLoserRating:_0xe15c0d}=calculateEloD3(_0xff0262[_0x1d7155(0xf2)]||0x4b0,_0x144e30[_0x1d7155(0xf2)]||0x4b0);let _0x163efe=_0x399279,_0x3173a3=_0x1e6919;if(_0x399279>_0x1e6919){console['log'](_0x1d7155(0xef)),_0x163efe=_0x1e6919,_0x3173a3=_0x1e6919+0x1;const _0x414513=query(collection(db,'playersD3'),where('position','>',_0x1e6919),where(_0x1d7155(0x102),'<',_0x399279)),_0x34e190=await getDocs(_0x414513);for(const _0x3ab7b8 of _0x34e190['docs']){_0x3ab7b8['id']!==_0x2d96db&&_0x3ab7b8['id']!==_0x3a27a4&&_0x12ccad[_0x1d7155(0xf8)](doc(db,_0x1d7155(0xfc),_0x3ab7b8['id']),{'position':_0x3ab7b8[_0x1d7155(0x103)]()[_0x1d7155(0x102)]+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x12ccad['update'](_0x4ecf1c,{'eloRating':_0x326af9,'lastMatchDate':serverTimestamp(),'position':_0x163efe,'lastMatchId':_0x1b2f6e}),_0x12ccad['update'](_0x461b0c,{'eloRating':_0xe15c0d,'lastMatchDate':serverTimestamp(),'position':_0x3173a3,'lastMatchId':_0x1b2f6e}),await _0x12ccad[_0x1d7155(0xf1)](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x1d7155(0x101)]([recordEloChangeD3({'playerId':_0x2d96db,'previousElo':_0xff0262[_0x1d7155(0xf2)]||0x4b0,'newElo':_0x326af9,'opponentId':_0x3a27a4,'matchResult':_0x1d7155(0xf3),'previousPosition':_0x399279,'newPosition':_0x163efe,'isPromotion':_0x163efe<_0x399279,'matchId':_0x1b2f6e,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x3a27a4,'previousElo':_0x144e30['eloRating']||0x4b0,'newElo':_0xe15c0d,'opponentId':_0x2d96db,'matchResult':_0x1d7155(0x100),'previousPosition':_0x1e6919,'newPosition':_0x3173a3,'isDemotion':_0x3173a3>_0x1e6919,'matchId':_0x1b2f6e,'timestamp':serverTimestamp()})]),!![];}catch(_0x293011){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x293011);throw _0x293011;}}export async function approveReportD3(_0x431453,_0xda9478,_0x3f7815,_0x3d91b7){const _0x510469=a29_0x32af;try{console[_0x510469(0x104)]('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x431453,'winnerScore':_0xda9478,'winnerSuicides':_0x3f7815,'winnerComment':_0x3d91b7});const _0x1e7354=auth['currentUser'];if(!_0x1e7354){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console[_0x510469(0x104)]('Current\x20user:',_0x1e7354['email']);const _0x4f1f1a=await getDoc(doc(db,'playersD3',_0x1e7354['uid'])),_0x2b7c4f=_0x4f1f1a['exists']()?_0x4f1f1a['data']()['username']:null;console['log'](_0x510469(0xe8),_0x2b7c4f);const _0x33370d=doc(db,_0x510469(0xe7),_0x431453),_0x13e71f=await getDoc(_0x33370d);if(!_0x13e71f['exists']()){console['log'](_0x510469(0xe5),_0x431453);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x285eee=_0x13e71f[_0x510469(0x103)]();console[_0x510469(0x104)](_0x510469(0xff),_0x285eee);if(_0x2b7c4f!==_0x285eee[_0x510469(0xeb)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x2a23c6={..._0x285eee,'winnerScore':_0xda9478,'winnerSuicides':_0x3f7815,'winnerComment':_0x3d91b7,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x2b7c4f,'createdAt':_0x285eee['createdAt']||serverTimestamp(),'winnerUsername':_0x285eee['winnerUsername'],'loserUsername':_0x285eee['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x431453),_0x2a23c6),await deleteDoc(_0x33370d),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x210749,_0x4e89a5]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x285eee['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x510469(0xf6),'==',_0x285eee[_0x510469(0xfe)])))]);if(_0x210749[_0x510469(0xf9)]||_0x4e89a5['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x52f4c3=_0x210749[_0x510469(0xea)][0x0]['id'],_0x1ea792=_0x4e89a5['docs'][0x0]['id'];return await updateEloRatingsD3(_0x52f4c3,_0x1ea792,_0x431453),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x81af98){console['error'](_0x510469(0xec),_0x81af98);throw _0x81af98;}}