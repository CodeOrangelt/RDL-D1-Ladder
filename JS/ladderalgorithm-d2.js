function a28_0x5bb7(){const _0x24a02b=['trace','constructor','bind','round','Current\x20username:','username','match-d2','docs','exists','error','No\x20user\x20logged\x20in','apply','MAX_SAFE_INTEGER','data','D2\x20Match\x20moved\x20to\x20approved\x20collection','pendingMatchesD2','position','all','exception','D2\x20Report\x20not\x20found\x20with\x20ID:','empty','log','toString','eloRating','update','return\x20(function()\x20','playersD2','One\x20or\x20both\x20D2\x20players\x20not\x20found'];a28_0x5bb7=function(){return _0x24a02b;};return a28_0x5bb7();}const a28_0x5c91fa=(function(){let _0x5d5833=!![];return function(_0x234f50,_0x2a45ee){const _0x4e3088=_0x5d5833?function(){const _0x25794e=a28_0x3c4b;if(_0x2a45ee){const _0x5ebdb0=_0x2a45ee[_0x25794e(0xb0)](_0x234f50,arguments);return _0x2a45ee=null,_0x5ebdb0;}}:function(){};return _0x5d5833=![],_0x4e3088;};}()),a28_0x27bb32=a28_0x5c91fa(this,function(){const _0x2396b0=a28_0x3c4b;let _0x5f70ec;try{const _0x343020=Function(_0x2396b0(0xbe)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x5f70ec=_0x343020();}catch(_0x45dacb){_0x5f70ec=window;}const _0x6dfbc6=_0x5f70ec['console']=_0x5f70ec['console']||{},_0x3b4fa5=['log','warn','info',_0x2396b0(0xae),_0x2396b0(0xb7),'table',_0x2396b0(0xa5)];for(let _0x2da8c3=0x0;_0x2da8c3<_0x3b4fa5['length'];_0x2da8c3++){const _0x576270=a28_0x5c91fa[_0x2396b0(0xa6)]['prototype'][_0x2396b0(0xa7)](a28_0x5c91fa),_0x4dde03=_0x3b4fa5[_0x2da8c3],_0x1b9166=_0x6dfbc6[_0x4dde03]||_0x576270;_0x576270['__proto__']=a28_0x5c91fa['bind'](a28_0x5c91fa),_0x576270['toString']=_0x1b9166[_0x2396b0(0xbb)]['bind'](_0x1b9166),_0x6dfbc6[_0x4dde03]=_0x576270;}});a28_0x27bb32();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';function a28_0x3c4b(_0x14970d,_0x130a83){const _0x27bb32=a28_0x5bb7();return a28_0x3c4b=function(_0x5c91fa,_0x16e8b6){_0x5c91fa=_0x5c91fa-0xa5;let _0x5bb74f=_0x27bb32[_0x5c91fa];return _0x5bb74f;},a28_0x3c4b(_0x14970d,_0x130a83);}import{promotionManager}from'./promotions.js';import a28_0x7d794c from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x113b8c,_0x2f86b9,_0x453ff4=0x20){const _0x611b54=a28_0x3c4b,_0x4b0da9=0x1/(0x1+Math['pow'](0xa,(_0x2f86b9-_0x113b8c)/0x190)),_0x2e82f8=0x1/(0x1+Math['pow'](0xa,(_0x113b8c-_0x2f86b9)/0x190)),_0xdaa58c=_0x113b8c+_0x453ff4*(0x1-_0x4b0da9),_0x3a2b6f=_0x2f86b9+_0x453ff4*(0x0-_0x2e82f8);return{'newWinnerRating':Math['round'](_0xdaa58c),'newLoserRating':Math[_0x611b54(0xa8)](_0x3a2b6f)};}export async function updateEloRatingsD2(_0x514f10,_0x4bca9e,_0x3a5fe4){const _0x2d87e7=a28_0x3c4b;try{const _0x2d232e=writeBatch(db),_0x42cbf3=doc(db,_0x2d87e7(0xbf),_0x514f10),_0x46cebd=doc(db,_0x2d87e7(0xbf),_0x4bca9e),[_0x3dd066,_0x5947f7]=await Promise['all']([getDoc(_0x42cbf3),getDoc(_0x46cebd)]);if(!_0x3dd066['exists']()||!_0x5947f7[_0x2d87e7(0xad)]())throw new Error(_0x2d87e7(0xc0));const _0x1632be=_0x3dd066[_0x2d87e7(0xb2)](),_0x41af2c=_0x5947f7[_0x2d87e7(0xb2)](),_0x27dbcf=_0x1632be['position']||Number[_0x2d87e7(0xb1)],_0x50827b=_0x41af2c[_0x2d87e7(0xb5)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x11c14c,newLoserRating:_0x2a6fd7}=calculateEloD2(_0x1632be['eloRating']||0x4b0,_0x41af2c[_0x2d87e7(0xbc)]||0x4b0);let _0x5a683b=_0x27dbcf,_0x1148ca=_0x50827b;if(_0x27dbcf>_0x50827b){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x5a683b=_0x50827b,_0x1148ca=_0x50827b+0x1;const _0x412ff2=query(collection(db,'playersD2'),where('position','>',_0x50827b),where('position','<',_0x27dbcf)),_0xad2289=await getDocs(_0x412ff2);for(const _0x240093 of _0xad2289['docs']){_0x240093['id']!==_0x514f10&&_0x240093['id']!==_0x4bca9e&&_0x2d232e['update'](doc(db,'playersD2',_0x240093['id']),{'position':_0x240093[_0x2d87e7(0xb2)]()[_0x2d87e7(0xb5)]+0x1});}}else console[_0x2d87e7(0xba)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x2d232e[_0x2d87e7(0xbd)](_0x42cbf3,{'eloRating':_0x11c14c,'lastMatchDate':serverTimestamp(),'position':_0x5a683b,'lastMatchId':_0x3a5fe4}),_0x2d232e['update'](_0x46cebd,{'eloRating':_0x2a6fd7,'lastMatchDate':serverTimestamp(),'position':_0x1148ca,'lastMatchId':_0x3a5fe4}),await _0x2d232e['commit'](),console[_0x2d87e7(0xba)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x2d87e7(0xb6)]([recordEloChangeD2({'playerId':_0x514f10,'previousElo':_0x1632be['eloRating']||0x4b0,'newElo':_0x11c14c,'opponentId':_0x4bca9e,'matchResult':'win','previousPosition':_0x27dbcf,'newPosition':_0x5a683b,'isPromotion':_0x5a683b<_0x27dbcf,'matchId':_0x3a5fe4,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x4bca9e,'previousElo':_0x41af2c['eloRating']||0x4b0,'newElo':_0x2a6fd7,'opponentId':_0x514f10,'matchResult':'loss','previousPosition':_0x50827b,'newPosition':_0x1148ca,'isDemotion':_0x1148ca>_0x50827b,'matchId':_0x3a5fe4,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x514f10,_0x11c14c,_0x1632be['eloRating'],{'source':_0x2d87e7(0xab),'matchId':_0x3a5fe4}),await promotionManager['checkAndRecordPromotion'](_0x4bca9e,_0x2a6fd7,_0x41af2c[_0x2d87e7(0xbc)],{'source':_0x2d87e7(0xab),'matchId':_0x3a5fe4}),!![];}catch(_0x42f5bb){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x42f5bb);throw _0x42f5bb;}}export async function approveReportD2(_0x524b9a,_0xd1eec7,_0x4fe48d,_0x4377a2){const _0x3b56ac=a28_0x3c4b;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x524b9a,'winnerScore':_0xd1eec7,'winnerSuicides':_0x4fe48d,'winnerComment':_0x4377a2});const _0x4ab93a=auth['currentUser'];if(!_0x4ab93a){console['log'](_0x3b56ac(0xaf));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console[_0x3b56ac(0xba)]('Current\x20user:',_0x4ab93a['email']);const _0x25469e=await getDoc(doc(db,_0x3b56ac(0xbf),_0x4ab93a['uid'])),_0x25689f=_0x25469e['exists']()?_0x25469e['data']()[_0x3b56ac(0xaa)]:null;console['log'](_0x3b56ac(0xa9),_0x25689f);const _0x4ea839=doc(db,_0x3b56ac(0xb4),_0x524b9a),_0x1509ab=await getDoc(_0x4ea839);if(!_0x1509ab['exists']()){console['log'](_0x3b56ac(0xb8),_0x524b9a);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0xba7695=_0x1509ab['data']();console['log']('D2\x20Report\x20data:',_0xba7695);if(_0x25689f!==_0xba7695['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x2aaf6c={..._0xba7695,'winnerScore':_0xd1eec7,'winnerSuicides':_0x4fe48d,'winnerComment':_0x4377a2,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x25689f,'createdAt':_0xba7695['createdAt']||serverTimestamp(),'winnerUsername':_0xba7695['winnerUsername'],'loserUsername':_0xba7695['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x524b9a),_0x2aaf6c),await deleteDoc(_0x4ea839),console['log'](_0x3b56ac(0xb3));const [_0x4813b3,_0xdaa28]=await Promise[_0x3b56ac(0xb6)]([getDocs(query(collection(db,'playersD2'),where('username','==',_0xba7695['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0xba7695['loserUsername'])))]);if(_0x4813b3[_0x3b56ac(0xb9)]||_0xdaa28['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x4b7abd=_0x4813b3[_0x3b56ac(0xac)][0x0]['id'],_0x57f788=_0xdaa28['docs'][0x0]['id'];return await updateEloRatingsD2(_0x4b7abd,_0x57f788,_0x524b9a),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0xd44a11){console[_0x3b56ac(0xae)]('Error\x20in\x20approveReportD2:',_0xd44a11);throw _0xd44a11;}}