const a27_0x499ab3=(function(){let _0x19020e=!![];return function(_0x4c1993,_0xa21f60){const _0x53f3b3=_0x19020e?function(){if(_0xa21f60){const _0x317c8e=_0xa21f60['apply'](_0x4c1993,arguments);return _0xa21f60=null,_0x317c8e;}}:function(){};return _0x19020e=![],_0x53f3b3;};}()),a27_0x4c9471=a27_0x499ab3(this,function(){const _0x6b2880=a27_0x5bfd,_0x4b004d=function(){let _0x2f633b;try{_0x2f633b=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x515da7){_0x2f633b=window;}return _0x2f633b;},_0x4638ed=_0x4b004d(),_0x175af0=_0x4638ed[_0x6b2880(0x1a4)]=_0x4638ed['console']||{},_0xb45977=[_0x6b2880(0x19b),'warn',_0x6b2880(0x19e),'error','exception',_0x6b2880(0x1ad),'trace'];for(let _0x378bd9=0x0;_0x378bd9<_0xb45977[_0x6b2880(0x197)];_0x378bd9++){const _0x53f307=a27_0x499ab3['constructor']['prototype']['bind'](a27_0x499ab3),_0x5d1e7d=_0xb45977[_0x378bd9],_0xc9aaec=_0x175af0[_0x5d1e7d]||_0x53f307;_0x53f307['__proto__']=a27_0x499ab3['bind'](a27_0x499ab3),_0x53f307['toString']=_0xc9aaec[_0x6b2880(0x19a)]['bind'](_0xc9aaec),_0x175af0[_0x5d1e7d]=_0x53f307;}});a27_0x4c9471();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';function a27_0x1436(){const _0x1e1158=['D3\x20Report\x20not\x20found\x20with\x20ID:','approvedMatchesD3','username','round','length','error','MAX_SAFE_INTEGER','toString','log','update','currentUser','info','position','Starting\x20approveReportD3\x20function\x20with:','email','exists','eloRating','console','pendingMatchesD3','winnerUsername','pow','Error\x20in\x20approveReportD3:','all','docs','loss','loserUsername','table','No\x20user\x20logged\x20in'];a27_0x1436=function(){return _0x1e1158;};return a27_0x1436();}export function calculateEloD3(_0x136d48,_0x321822,_0x2bc93d=0x20){const _0x34b903=a27_0x5bfd,_0x3fbb0b=0x1/(0x1+Math[_0x34b903(0x1a7)](0xa,(_0x321822-_0x136d48)/0x190)),_0x54bddd=0x1/(0x1+Math['pow'](0xa,(_0x136d48-_0x321822)/0x190)),_0x20b42f=_0x136d48+_0x2bc93d*(0x1-_0x3fbb0b),_0x18b609=_0x321822+_0x2bc93d*(0x0-_0x54bddd);return{'newWinnerRating':Math[_0x34b903(0x196)](_0x20b42f),'newLoserRating':Math['round'](_0x18b609)};}function a27_0x5bfd(_0x446e00,_0x4d74d3){const _0x4c9471=a27_0x1436();return a27_0x5bfd=function(_0x499ab3,_0x31f1d2){_0x499ab3=_0x499ab3-0x193;let _0x1436c6=_0x4c9471[_0x499ab3];return _0x1436c6;},a27_0x5bfd(_0x446e00,_0x4d74d3);}export async function updateEloRatingsD3(_0x2815d2,_0x5b072b,_0x4c8725){const _0x4b44cc=a27_0x5bfd;try{const _0x693bc8=writeBatch(db),_0x419cbc=doc(db,'playersD3',_0x2815d2),_0x5d9e0e=doc(db,'playersD3',_0x5b072b),[_0x4cad9e,_0x5f389f]=await Promise['all']([getDoc(_0x419cbc),getDoc(_0x5d9e0e)]);if(!_0x4cad9e['exists']()||!_0x5f389f[_0x4b44cc(0x1a2)]())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x5d2077=_0x4cad9e['data'](),_0x1b38ef=_0x5f389f['data'](),_0x26dc38=_0x5d2077['position']||Number['MAX_SAFE_INTEGER'],_0x16fb2e=_0x1b38ef[_0x4b44cc(0x19f)]||Number[_0x4b44cc(0x199)],{newWinnerRating:_0x5b97a4,newLoserRating:_0x1161fe}=calculateEloD3(_0x5d2077['eloRating']||0x4b0,_0x1b38ef['eloRating']||0x4b0);let _0x6739a4=_0x26dc38,_0x4e0754=_0x16fb2e;if(_0x26dc38>_0x16fb2e){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x6739a4=_0x16fb2e,_0x4e0754=_0x16fb2e+0x1;const _0x45bcec=query(collection(db,'playersD3'),where(_0x4b44cc(0x19f),'>',_0x16fb2e),where('position','<',_0x26dc38)),_0x2c7fde=await getDocs(_0x45bcec);for(const _0x82d380 of _0x2c7fde['docs']){_0x82d380['id']!==_0x2815d2&&_0x82d380['id']!==_0x5b072b&&_0x693bc8['update'](doc(db,'playersD3',_0x82d380['id']),{'position':_0x82d380['data']()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x693bc8['update'](_0x419cbc,{'eloRating':_0x5b97a4,'lastMatchDate':serverTimestamp(),'position':_0x6739a4,'lastMatchId':_0x4c8725}),_0x693bc8[_0x4b44cc(0x19c)](_0x5d9e0e,{'eloRating':_0x1161fe,'lastMatchDate':serverTimestamp(),'position':_0x4e0754,'lastMatchId':_0x4c8725}),await _0x693bc8['commit'](),console[_0x4b44cc(0x19b)]('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x4b44cc(0x1a9)]([recordEloChangeD3({'playerId':_0x2815d2,'previousElo':_0x5d2077[_0x4b44cc(0x1a3)]||0x4b0,'newElo':_0x5b97a4,'opponentId':_0x5b072b,'matchResult':'win','previousPosition':_0x26dc38,'newPosition':_0x6739a4,'isPromotion':_0x6739a4<_0x26dc38,'matchId':_0x4c8725,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x5b072b,'previousElo':_0x1b38ef['eloRating']||0x4b0,'newElo':_0x1161fe,'opponentId':_0x2815d2,'matchResult':_0x4b44cc(0x1ab),'previousPosition':_0x16fb2e,'newPosition':_0x4e0754,'isDemotion':_0x4e0754>_0x16fb2e,'matchId':_0x4c8725,'timestamp':serverTimestamp()})]),!![];}catch(_0x20df3a){console[_0x4b44cc(0x198)]('Error\x20in\x20updateEloRatingsD3:',_0x20df3a);throw _0x20df3a;}}export async function approveReportD3(_0x444ddf,_0x2ba618,_0x348f08,_0x3cc964){const _0x297d33=a27_0x5bfd;try{console[_0x297d33(0x19b)](_0x297d33(0x1a0),{'reportId':_0x444ddf,'winnerScore':_0x2ba618,'winnerSuicides':_0x348f08,'winnerComment':_0x3cc964});const _0x3067df=auth[_0x297d33(0x19d)];if(!_0x3067df){console['log'](_0x297d33(0x1ae));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console[_0x297d33(0x19b)]('Current\x20user:',_0x3067df[_0x297d33(0x1a1)]);const _0x212244=await getDoc(doc(db,'playersD3',_0x3067df['uid'])),_0x26e32a=_0x212244['exists']()?_0x212244['data']()['username']:null;console['log']('Current\x20username:',_0x26e32a);const _0x58be18=doc(db,_0x297d33(0x1a5),_0x444ddf),_0x36f40f=await getDoc(_0x58be18);if(!_0x36f40f['exists']()){console['log'](_0x297d33(0x193),_0x444ddf);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x3ae065=_0x36f40f['data']();console[_0x297d33(0x19b)]('D3\x20Report\x20data:',_0x3ae065);if(_0x26e32a!==_0x3ae065['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x43732b={..._0x3ae065,'winnerScore':_0x2ba618,'winnerSuicides':_0x348f08,'winnerComment':_0x3cc964,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x26e32a,'createdAt':_0x3ae065['createdAt']||serverTimestamp(),'winnerUsername':_0x3ae065[_0x297d33(0x1a6)],'loserUsername':_0x3ae065['loserUsername']};await setDoc(doc(db,_0x297d33(0x194),_0x444ddf),_0x43732b),await deleteDoc(_0x58be18),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0xea0d09,_0x27b45d]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where(_0x297d33(0x195),'==',_0x3ae065['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x3ae065[_0x297d33(0x1ac)])))]);if(_0xea0d09['empty']||_0x27b45d['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x431b5a=_0xea0d09[_0x297d33(0x1aa)][0x0]['id'],_0x21bee0=_0x27b45d['docs'][0x0]['id'];return await updateEloRatingsD3(_0x431b5a,_0x21bee0,_0x444ddf),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x43d184){console['error'](_0x297d33(0x1a8),_0x43d184);throw _0x43d184;}}