const a27_0x1b279e=(function(){let _0x53506b=!![];return function(_0x32263d,_0x21703d){const _0xb23c05=_0x53506b?function(){if(_0x21703d){const _0x4611df=_0x21703d['apply'](_0x32263d,arguments);return _0x21703d=null,_0x4611df;}}:function(){};return _0x53506b=![],_0xb23c05;};}()),a27_0x4b4ca3=a27_0x1b279e(this,function(){const _0x40211b=a27_0x1166;let _0x322bfd;try{const _0x12e70b=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x322bfd=_0x12e70b();}catch(_0x18cbe2){_0x322bfd=window;}const _0x3bcc63=_0x322bfd['console']=_0x322bfd[_0x40211b(0x88)]||{},_0x596eb2=['log','warn','info',_0x40211b(0x8f),'exception',_0x40211b(0x92),'trace'];for(let _0x374248=0x0;_0x374248<_0x596eb2[_0x40211b(0x94)];_0x374248++){const _0x52c32c=a27_0x1b279e['constructor']['prototype']['bind'](a27_0x1b279e),_0x164cdf=_0x596eb2[_0x374248],_0x5327b0=_0x3bcc63[_0x164cdf]||_0x52c32c;_0x52c32c['__proto__']=a27_0x1b279e['bind'](a27_0x1b279e),_0x52c32c['toString']=_0x5327b0[_0x40211b(0x87)][_0x40211b(0x98)](_0x5327b0),_0x3bcc63[_0x164cdf]=_0x52c32c;}});function a27_0x1166(_0x39fe9f,_0x3c03eb){const _0x4b4ca3=a27_0x4d29();return a27_0x1166=function(_0x1b279e,_0x16f6fe){_0x1b279e=_0x1b279e-0x87;let _0x4d29c9=_0x4b4ca3[_0x1b279e];return _0x4d29c9;},a27_0x1166(_0x39fe9f,_0x3c03eb);}a27_0x4b4ca3();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x486ed6,_0x460e89,_0x296d16=0x20){const _0x29ef66=0x1/(0x1+Math['pow'](0xa,(_0x460e89-_0x486ed6)/0x190)),_0x272b3=0x1/(0x1+Math['pow'](0xa,(_0x486ed6-_0x460e89)/0x190)),_0x4ded41=_0x486ed6+_0x296d16*(0x1-_0x29ef66),_0x9aaa17=_0x460e89+_0x296d16*(0x0-_0x272b3);return{'newWinnerRating':Math['round'](_0x4ded41),'newLoserRating':Math['round'](_0x9aaa17)};}export async function updateEloRatingsD3(_0x329747,_0x21500c,_0x2224c2){const _0x2c8f6f=a27_0x1166;try{const _0x427fd4=writeBatch(db),_0x3712e6=doc(db,'playersD3',_0x329747),_0x4af3e7=doc(db,'playersD3',_0x21500c),[_0x529db9,_0x5abbdb]=await Promise['all']([getDoc(_0x3712e6),getDoc(_0x4af3e7)]);if(!_0x529db9['exists']()||!_0x5abbdb['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x5b58a6=_0x529db9['data'](),_0x2fa552=_0x5abbdb['data'](),_0x5b8c1f=_0x5b58a6[_0x2c8f6f(0x89)]||Number['MAX_SAFE_INTEGER'],_0x2b6fb9=_0x2fa552['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x4653e3,newLoserRating:_0x58c71f}=calculateEloD3(_0x5b58a6['eloRating']||0x4b0,_0x2fa552['eloRating']||0x4b0);let _0x30c7a8=_0x5b8c1f,_0x42c4f9=_0x2b6fb9;if(_0x5b8c1f>_0x2b6fb9){console[_0x2c8f6f(0x97)]('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x30c7a8=_0x2b6fb9,_0x42c4f9=_0x2b6fb9+0x1;const _0x11ea9d=query(collection(db,'playersD3'),where('position','>',_0x2b6fb9),where(_0x2c8f6f(0x89),'<',_0x5b8c1f)),_0x9ff19=await getDocs(_0x11ea9d);for(const _0x3079cf of _0x9ff19['docs']){_0x3079cf['id']!==_0x329747&&_0x3079cf['id']!==_0x21500c&&_0x427fd4[_0x2c8f6f(0x91)](doc(db,'playersD3',_0x3079cf['id']),{'position':_0x3079cf['data']()[_0x2c8f6f(0x89)]+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x427fd4['update'](_0x3712e6,{'eloRating':_0x4653e3,'lastMatchDate':serverTimestamp(),'position':_0x30c7a8,'lastMatchId':_0x2224c2}),_0x427fd4[_0x2c8f6f(0x91)](_0x4af3e7,{'eloRating':_0x58c71f,'lastMatchDate':serverTimestamp(),'position':_0x42c4f9,'lastMatchId':_0x2224c2}),await _0x427fd4['commit'](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x2c8f6f(0x99)]([recordEloChangeD3({'playerId':_0x329747,'previousElo':_0x5b58a6['eloRating']||0x4b0,'newElo':_0x4653e3,'opponentId':_0x21500c,'matchResult':'win','previousPosition':_0x5b8c1f,'newPosition':_0x30c7a8,'isPromotion':_0x30c7a8<_0x5b8c1f,'matchId':_0x2224c2,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x21500c,'previousElo':_0x2fa552['eloRating']||0x4b0,'newElo':_0x58c71f,'opponentId':_0x329747,'matchResult':'loss','previousPosition':_0x2b6fb9,'newPosition':_0x42c4f9,'isDemotion':_0x42c4f9>_0x2b6fb9,'matchId':_0x2224c2,'timestamp':serverTimestamp()})]),!![];}catch(_0xd79609){console[_0x2c8f6f(0x8f)]('Error\x20in\x20updateEloRatingsD3:',_0xd79609);throw _0xd79609;}}export async function approveReportD3(_0x452671,_0x3eb27b,_0xd6abcd,_0x3f552a){const _0x38c8af=a27_0x1166;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x452671,'winnerScore':_0x3eb27b,'winnerSuicides':_0xd6abcd,'winnerComment':_0x3f552a});const _0x3e271c=auth['currentUser'];if(!_0x3e271c){console['log'](_0x38c8af(0x8a));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x3e271c['email']);const _0x39dbbb=await getDoc(doc(db,'playersD3',_0x3e271c['uid'])),_0x20f829=_0x39dbbb['exists']()?_0x39dbbb[_0x38c8af(0x8b)]()['username']:null;console[_0x38c8af(0x97)](_0x38c8af(0x8d),_0x20f829);const _0x5166e6=doc(db,_0x38c8af(0x8e),_0x452671),_0x19aa99=await getDoc(_0x5166e6);if(!_0x19aa99['exists']()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x452671);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x176ae7=_0x19aa99['data']();console['log']('D3\x20Report\x20data:',_0x176ae7);if(_0x20f829!==_0x176ae7['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x330966={..._0x176ae7,'winnerScore':_0x3eb27b,'winnerSuicides':_0xd6abcd,'winnerComment':_0x3f552a,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x20f829,'createdAt':_0x176ae7['createdAt']||serverTimestamp(),'winnerUsername':_0x176ae7['winnerUsername'],'loserUsername':_0x176ae7['loserUsername']};await setDoc(doc(db,_0x38c8af(0x95),_0x452671),_0x330966),await deleteDoc(_0x5166e6),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x1d08bc,_0x5550a9]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where(_0x38c8af(0x96),'==',_0x176ae7['winnerUsername']))),getDocs(query(collection(db,_0x38c8af(0x90)),where('username','==',_0x176ae7['loserUsername'])))]);if(_0x1d08bc[_0x38c8af(0x93)]||_0x5550a9['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x5798e9=_0x1d08bc['docs'][0x0]['id'],_0x4008e6=_0x5550a9[_0x38c8af(0x8c)][0x0]['id'];return await updateEloRatingsD3(_0x5798e9,_0x4008e6,_0x452671),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0xa402be){console[_0x38c8af(0x8f)]('Error\x20in\x20approveReportD3:',_0xa402be);throw _0xa402be;}}function a27_0x4d29(){const _0x3a0102=['toString','console','position','No\x20user\x20logged\x20in','data','docs','Current\x20username:','pendingMatchesD3','error','playersD3','update','table','empty','length','approvedMatchesD3','username','log','bind','all'];a27_0x4d29=function(){return _0x3a0102;};return a27_0x4d29();}