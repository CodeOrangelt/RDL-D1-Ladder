const a30_0x2fd9b6=(function(){let _0x1f7875=!![];return function(_0x17731b,_0x4a4e45){const _0x19b661=_0x1f7875?function(){const _0xac8471=a30_0x207f;if(_0x4a4e45){const _0x432608=_0x4a4e45[_0xac8471(0x1e4)](_0x17731b,arguments);return _0x4a4e45=null,_0x432608;}}:function(){};return _0x1f7875=![],_0x19b661;};}()),a30_0x4eca5f=a30_0x2fd9b6(this,function(){const _0x3d0a59=a30_0x207f,_0x4a4fde=function(){let _0xdf020c;try{_0xdf020c=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x12efe0){_0xdf020c=window;}return _0xdf020c;},_0x24152c=_0x4a4fde(),_0x554fe2=_0x24152c[_0x3d0a59(0x1e2)]=_0x24152c['console']||{},_0x393f10=['log','warn','info','error',_0x3d0a59(0x1f3),'table','trace'];for(let _0x12e59d=0x0;_0x12e59d<_0x393f10['length'];_0x12e59d++){const _0x102aef=a30_0x2fd9b6[_0x3d0a59(0x1ea)][_0x3d0a59(0x1f1)]['bind'](a30_0x2fd9b6),_0x229155=_0x393f10[_0x12e59d],_0x2370bd=_0x554fe2[_0x229155]||_0x102aef;_0x102aef['__proto__']=a30_0x2fd9b6['bind'](a30_0x2fd9b6),_0x102aef['toString']=_0x2370bd[_0x3d0a59(0x1f2)]['bind'](_0x2370bd),_0x554fe2[_0x229155]=_0x102aef;}});a30_0x4eca5f();function a30_0x207f(_0x1b4006,_0x5e29a3){const _0x4eca5f=a30_0x2578();return a30_0x207f=function(_0x2fd9b6,_0x56f617){_0x2fd9b6=_0x2fd9b6-0x1e0;let _0x2578c6=_0x4eca5f[_0x2fd9b6];return _0x2578c6;},a30_0x207f(_0x1b4006,_0x5e29a3);}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';function a30_0x2578(){const _0x3db1a8=['log','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','console','docs','apply','winnerScore','doc','username','update','lastUpdated','constructor','wins','match','pow','exists','error','eloRating','prototype','toString','exception','Error\x20in\x20updateEloRatings:','data'];a30_0x2578=function(){return _0x3db1a8;};return a30_0x2578();}import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x595a62,_0x334db3,_0x52e972=0x20){const _0x58d289=a30_0x207f,_0xbad12a=0x1/(0x1+Math[_0x58d289(0x1ed)](0xa,(_0x334db3-_0x595a62)/0x190)),_0x5ce454=0x1/(0x1+Math['pow'](0xa,(_0x595a62-_0x334db3)/0x190)),_0x1e23c8=_0x595a62+_0x52e972*(0x1-_0xbad12a),_0x5c0601=_0x334db3+_0x52e972*(0x0-_0x5ce454);return{'newWinnerRating':Math['round'](_0x1e23c8),'newLoserRating':Math['round'](_0x5c0601)};}export function assignDefaultEloRating(_0x26959d,_0x54b016){const _0x45fa32=a30_0x207f,_0x1385e7=0x4b0;!_0x54b016['eloRating']&&db['collection']('players')[_0x45fa32(0x1e6)](_0x26959d)['update']({'eloRating':_0x1385e7})['then'](()=>{const _0x4e2c65=_0x45fa32;console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x54b016[_0x4e2c65(0x1e7)]);})['catch'](_0xd9799e=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0xd9799e);});}export async function updateEloRatings(_0x50bda6,_0x3c623b,_0x488d2d){const _0x29295a=a30_0x207f;try{const _0x6f4d29=writeBatch(db),_0x1afb23=doc(db,'players',_0x50bda6),_0x5eac4=doc(db,'players',_0x3c623b),[_0x280205,_0x414a17]=await Promise['all']([getDoc(_0x1afb23),getDoc(_0x5eac4)]);if(!_0x280205['exists']()||!_0x414a17[_0x29295a(0x1ee)]())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x41aef0=_0x280205['data'](),_0x585922=_0x414a17[_0x29295a(0x1f5)](),_0x2d0a56=_0x41aef0['position']||Number['MAX_SAFE_INTEGER'],_0x399cb7=_0x585922['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x3d0121,newLoserRating:_0x18f010}=calculateElo(_0x41aef0[_0x29295a(0x1f0)]||0x4b0,_0x585922[_0x29295a(0x1f0)]||0x4b0);let _0x33e1db=_0x2d0a56,_0x57fd25=_0x399cb7;if(_0x2d0a56>_0x399cb7){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x33e1db=_0x399cb7,_0x57fd25=_0x399cb7+0x1;const _0x5a8281=query(collection(db,'players'),where('position','>',_0x399cb7),where('position','<',_0x2d0a56)),_0x163600=await getDocs(_0x5a8281);for(const _0x135c3e of _0x163600['docs']){_0x135c3e['id']!==_0x50bda6&&_0x135c3e['id']!==_0x3c623b&&_0x6f4d29['update'](doc(db,'players',_0x135c3e['id']),{'position':_0x135c3e['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x41182d={'eloRating':_0x3d0121,'lastMatchDate':serverTimestamp(),'position':_0x33e1db,'lastMatchId':_0x488d2d},_0x510ec0={'eloRating':_0x18f010,'lastMatchDate':serverTimestamp(),'position':_0x57fd25,'lastMatchId':_0x488d2d};return _0x6f4d29['update'](_0x1afb23,_0x41182d),_0x6f4d29[_0x29295a(0x1e8)](_0x5eac4,_0x510ec0),await _0x6f4d29['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x50bda6,'previousElo':_0x41aef0['eloRating']||0x4b0,'newElo':_0x3d0121,'opponentId':_0x3c623b,'matchResult':'win','previousPosition':_0x2d0a56,'newPosition':_0x33e1db,'isPromotion':_0x33e1db<_0x2d0a56,'matchId':_0x488d2d,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x3c623b,'previousElo':_0x585922['eloRating']||0x4b0,'newElo':_0x18f010,'opponentId':_0x50bda6,'matchResult':'loss','previousPosition':_0x399cb7,'newPosition':_0x57fd25,'isDemotion':_0x57fd25>_0x399cb7,'matchId':_0x488d2d,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x50bda6,_0x3d0121,_0x41aef0[_0x29295a(0x1f0)],{'source':_0x29295a(0x1ec),'matchId':_0x488d2d}),await promotionManager['checkAndRecordPromotion'](_0x3c623b,_0x18f010,_0x585922[_0x29295a(0x1f0)],{'source':'match','matchId':_0x488d2d}),console[_0x29295a(0x1e0)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x56cd4b){console[_0x29295a(0x1ef)](_0x29295a(0x1f4),_0x56cd4b);throw _0x56cd4b;}}export async function approveReport(_0x1fbc10,_0x4b460f,_0x1e40a6,_0xb90c69,_0x2c7faa){const _0xcdfcbe=a30_0x207f;try{const _0x1e600a=doc(db,'pendingMatches',_0x1fbc10),_0x237186=await getDoc(_0x1e600a);if(!_0x237186['exists']())throw new Error('Report\x20not\x20found');const _0x3447fb=_0x237186['data'](),_0x37c38f={..._0x3447fb,'winnerScore':_0x4b460f,'winnerSuicides':_0x1e40a6,'winnerComment':_0xb90c69,'winnerDemoLink':_0x2c7faa,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x1fbc10),_0x37c38f),await deleteDoc(_0x1e600a),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0xa9d91a,_0x1285e1]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x3447fb['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x3447fb['loserUsername'])))]);if(_0xa9d91a['empty']||_0x1285e1['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x27c05d=_0xa9d91a['docs'][0x0]['id'],_0xcfe3fc=_0x1285e1[_0xcdfcbe(0x1e3)][0x0]['id'];return await updateEloRatings(_0x27c05d,_0xcfe3fc,_0x1fbc10),console['log'](_0xcdfcbe(0x1e1)),!![];}catch(_0x1d4227){console[_0xcdfcbe(0x1ef)]('Error\x20approving\x20report:',_0x1d4227);throw _0x1d4227;}}async function updatePlayerElo(_0x2a98f1,_0x4d4196,_0x276b00){await setDoc(doc(db,'players',_0x2a98f1),{...playerData,'eloRating':_0x276b00}),await checkAndRecordPromotion(_0x2a98f1,_0x276b00,_0x4d4196);}async function updatePlayerStats(_0x4819f5,_0x3163ff,_0x37549a){const _0x3747a7=a30_0x207f,_0x492606=doc(db,'playerStats',_0x4819f5),_0x1e9ac6=await getDoc(_0x492606);let _0x2eb0d5=_0x1e9ac6['exists']()?_0x1e9ac6[_0x3747a7(0x1f5)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x37549a?(_0x2eb0d5[_0x3747a7(0x1eb)]++,_0x2eb0d5['totalKills']+=parseInt(_0x3163ff[_0x3747a7(0x1e5)]||0x0),_0x2eb0d5['totalDeaths']+=parseInt(_0x3163ff['loserScore']||0x0)):(_0x2eb0d5['losses']++,_0x2eb0d5['totalKills']+=parseInt(_0x3163ff['loserScore']||0x0),_0x2eb0d5['totalDeaths']+=parseInt(_0x3163ff['winnerScore']||0x0));const _0x2112d8=_0x2eb0d5[_0x3747a7(0x1eb)]+_0x2eb0d5['losses'];_0x2eb0d5['winRate']=_0x2112d8>0x0?(_0x2eb0d5['wins']/_0x2112d8*0x64)['toFixed'](0x1):0x0,_0x2eb0d5[_0x3747a7(0x1e9)]=new Date()['toISOString'](),await setDoc(_0x492606,_0x2eb0d5,{'merge':!![]});}