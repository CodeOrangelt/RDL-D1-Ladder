const a26_0x566e68=(function(){let _0x5d7826=!![];return function(_0x56f62b,_0x278646){const _0x3fcdcc=_0x5d7826?function(){if(_0x278646){const _0x575e5b=_0x278646['apply'](_0x56f62b,arguments);return _0x278646=null,_0x575e5b;}}:function(){};return _0x5d7826=![],_0x3fcdcc;};}()),a26_0x346ad0=a26_0x566e68(this,function(){const _0x2362da=a26_0x8432;let _0xa2ffc7;try{const _0x403921=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0xa2ffc7=_0x403921();}catch(_0x1e64f2){_0xa2ffc7=window;}const _0x3bf28e=_0xa2ffc7['console']=_0xa2ffc7['console']||{},_0x3d17fd=['log','warn','info','error','exception','table','trace'];for(let _0x2f2f9a=0x0;_0x2f2f9a<_0x3d17fd[_0x2362da(0x10b)];_0x2f2f9a++){const _0x3c9eee=a26_0x566e68['constructor']['prototype'][_0x2362da(0x109)](a26_0x566e68),_0x49b7cd=_0x3d17fd[_0x2f2f9a],_0x2ce127=_0x3bf28e[_0x49b7cd]||_0x3c9eee;_0x3c9eee['__proto__']=a26_0x566e68[_0x2362da(0x109)](a26_0x566e68),_0x3c9eee['toString']=_0x2ce127['toString'][_0x2362da(0x109)](_0x2ce127),_0x3bf28e[_0x49b7cd]=_0x3c9eee;}});a26_0x346ad0();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a26_0x154b(){const _0x56d090=['round','bind','data','length','One\x20or\x20both\x20D2\x20players\x20not\x20found','checkAndRecordPromotion','Could\x20not\x20find\x20D2\x20player\x20documents','winnerUsername','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','playersD2','log','eloRating','error','update','Starting\x20approveReportD2\x20function\x20with:','Error\x20in\x20approveReportD2:','position','D2\x20ELO\x20ratings\x20updated\x20successfully','pendingMatchesD2'];a26_0x154b=function(){return _0x56d090;};return a26_0x154b();}import a26_0x31c5a7 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x513b34,_0x52c9b5,_0x3827c2=0x20){const _0x110fbe=a26_0x8432,_0x23b5e9=0x1/(0x1+Math['pow'](0xa,(_0x52c9b5-_0x513b34)/0x190)),_0x340614=0x1/(0x1+Math['pow'](0xa,(_0x513b34-_0x52c9b5)/0x190)),_0x32d29e=_0x513b34+_0x3827c2*(0x1-_0x23b5e9),_0x385d82=_0x52c9b5+_0x3827c2*(0x0-_0x340614);return{'newWinnerRating':Math['round'](_0x32d29e),'newLoserRating':Math[_0x110fbe(0x108)](_0x385d82)};}function a26_0x8432(_0x3477b2,_0x4851b9){const _0x346ad0=a26_0x154b();return a26_0x8432=function(_0x566e68,_0xf9794c){_0x566e68=_0x566e68-0x108;let _0x154b3e=_0x346ad0[_0x566e68];return _0x154b3e;},a26_0x8432(_0x3477b2,_0x4851b9);}export async function updateEloRatingsD2(_0x267017,_0x1c52d8,_0x317320){const _0x5ccdc3=a26_0x8432;try{const _0x170801=writeBatch(db),_0x31e371=doc(db,'playersD2',_0x267017),_0x50f983=doc(db,_0x5ccdc3(0x111),_0x1c52d8),[_0x2a09bb,_0x55097]=await Promise['all']([getDoc(_0x31e371),getDoc(_0x50f983)]);if(!_0x2a09bb['exists']()||!_0x55097['exists']())throw new Error(_0x5ccdc3(0x10c));const _0x7ec662=_0x2a09bb['data'](),_0x408942=_0x55097[_0x5ccdc3(0x10a)](),_0x11e4fc=_0x7ec662[_0x5ccdc3(0x118)]||Number['MAX_SAFE_INTEGER'],_0x4b296c=_0x408942['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x357cd6,newLoserRating:_0x384ecf}=calculateEloD2(_0x7ec662['eloRating']||0x4b0,_0x408942['eloRating']||0x4b0);let _0x26d020=_0x11e4fc,_0x41dd30=_0x4b296c;if(_0x11e4fc>_0x4b296c){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x26d020=_0x4b296c,_0x41dd30=_0x4b296c+0x1;const _0x4c5b8e=query(collection(db,_0x5ccdc3(0x111)),where('position','>',_0x4b296c),where(_0x5ccdc3(0x118),'<',_0x11e4fc)),_0x13bec0=await getDocs(_0x4c5b8e);for(const _0x1d58bd of _0x13bec0['docs']){_0x1d58bd['id']!==_0x267017&&_0x1d58bd['id']!==_0x1c52d8&&_0x170801['update'](doc(db,'playersD2',_0x1d58bd['id']),{'position':_0x1d58bd[_0x5ccdc3(0x10a)]()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x170801[_0x5ccdc3(0x115)](_0x31e371,{'eloRating':_0x357cd6,'lastMatchDate':serverTimestamp(),'position':_0x26d020,'lastMatchId':_0x317320}),_0x170801[_0x5ccdc3(0x115)](_0x50f983,{'eloRating':_0x384ecf,'lastMatchDate':serverTimestamp(),'position':_0x41dd30,'lastMatchId':_0x317320}),await _0x170801['commit'](),console[_0x5ccdc3(0x112)](_0x5ccdc3(0x119)),await Promise['all']([recordEloChangeD2({'playerId':_0x267017,'previousElo':_0x7ec662['eloRating']||0x4b0,'newElo':_0x357cd6,'opponentId':_0x1c52d8,'matchResult':'win','previousPosition':_0x11e4fc,'newPosition':_0x26d020,'isPromotion':_0x26d020<_0x11e4fc,'matchId':_0x317320,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x1c52d8,'previousElo':_0x408942['eloRating']||0x4b0,'newElo':_0x384ecf,'opponentId':_0x267017,'matchResult':'loss','previousPosition':_0x4b296c,'newPosition':_0x41dd30,'isDemotion':_0x41dd30>_0x4b296c,'matchId':_0x317320,'timestamp':serverTimestamp()})]),await promotionManager[_0x5ccdc3(0x10d)](_0x267017,_0x357cd6,_0x7ec662[_0x5ccdc3(0x113)],{'source':'match-d2','matchId':_0x317320}),await promotionManager['checkAndRecordPromotion'](_0x1c52d8,_0x384ecf,_0x408942[_0x5ccdc3(0x113)],{'source':'match-d2','matchId':_0x317320}),!![];}catch(_0x345f40){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x345f40);throw _0x345f40;}}export async function approveReportD2(_0x308868,_0x1972c3,_0x2abef5,_0x327249){const _0x3b9556=a26_0x8432;try{console['log'](_0x3b9556(0x116),{'reportId':_0x308868,'winnerScore':_0x1972c3,'winnerSuicides':_0x2abef5,'winnerComment':_0x327249});const _0x36d18f=auth['currentUser'];if(!_0x36d18f){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console[_0x3b9556(0x112)]('Current\x20user:',_0x36d18f['email']);const _0x5c6434=await getDoc(doc(db,'playersD2',_0x36d18f['uid'])),_0x58d160=_0x5c6434['exists']()?_0x5c6434[_0x3b9556(0x10a)]()['username']:null;console['log']('Current\x20username:',_0x58d160);const _0x33170b=doc(db,_0x3b9556(0x11a),_0x308868),_0x3d4a2e=await getDoc(_0x33170b);if(!_0x3d4a2e['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x308868);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x1bebce=_0x3d4a2e['data']();console['log']('D2\x20Report\x20data:',_0x1bebce);if(_0x58d160!==_0x1bebce[_0x3b9556(0x10f)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x320634={..._0x1bebce,'winnerScore':_0x1972c3,'winnerSuicides':_0x2abef5,'winnerComment':_0x327249,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x58d160,'createdAt':_0x1bebce['createdAt']||serverTimestamp(),'winnerUsername':_0x1bebce['winnerUsername'],'loserUsername':_0x1bebce['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x308868),_0x320634),await deleteDoc(_0x33170b),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x444a2b,_0x40f497]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x1bebce['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x1bebce['loserUsername'])))]);if(_0x444a2b['empty']||_0x40f497['empty'])throw new Error(_0x3b9556(0x10e));const _0x245a32=_0x444a2b['docs'][0x0]['id'],_0x5aab87=_0x40f497['docs'][0x0]['id'];return await updateEloRatingsD2(_0x245a32,_0x5aab87,_0x308868),console['log'](_0x3b9556(0x110)),!![];}catch(_0x5a83b1){console[_0x3b9556(0x114)](_0x3b9556(0x117),_0x5a83b1);throw _0x5a83b1;}}