const a28_0x46d277=(function(){let _0x31a5cb=!![];return function(_0x52dffc,_0xa7f1a3){const _0x3532f8=_0x31a5cb?function(){const _0x411bbd=a28_0x399e;if(_0xa7f1a3){const _0x35d227=_0xa7f1a3[_0x411bbd(0x109)](_0x52dffc,arguments);return _0xa7f1a3=null,_0x35d227;}}:function(){};return _0x31a5cb=![],_0x3532f8;};}()),a28_0x1ee081=a28_0x46d277(this,function(){const _0xb54b58=a28_0x399e;let _0x4ee9e6;try{const _0x47abc7=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x4ee9e6=_0x47abc7();}catch(_0x3402dd){_0x4ee9e6=window;}const _0x9596b6=_0x4ee9e6['console']=_0x4ee9e6['console']||{},_0x559319=[_0xb54b58(0x10b),_0xb54b58(0x100),_0xb54b58(0x11a),'error','exception','table','trace'];for(let _0x46171b=0x0;_0x46171b<_0x559319[_0xb54b58(0x104)];_0x46171b++){const _0x2ec4ff=a28_0x46d277['constructor']['prototype']['bind'](a28_0x46d277),_0x10b291=_0x559319[_0x46171b],_0x32aff2=_0x9596b6[_0x10b291]||_0x2ec4ff;_0x2ec4ff['__proto__']=a28_0x46d277['bind'](a28_0x46d277),_0x2ec4ff[_0xb54b58(0x108)]=_0x32aff2['toString'][_0xb54b58(0x10c)](_0x32aff2),_0x9596b6[_0x10b291]=_0x2ec4ff;}});a28_0x1ee081();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x594393,_0x47d100,_0x4b5358=0x20){const _0x397c79=a28_0x399e,_0x36e079=0x1/(0x1+Math[_0x397c79(0x112)](0xa,(_0x47d100-_0x594393)/0x190)),_0x48840b=0x1/(0x1+Math['pow'](0xa,(_0x594393-_0x47d100)/0x190)),_0x30a35b=_0x594393+_0x4b5358*(0x1-_0x36e079),_0x5926da=_0x47d100+_0x4b5358*(0x0-_0x48840b);return{'newWinnerRating':Math['round'](_0x30a35b),'newLoserRating':Math['round'](_0x5926da)};}function a28_0x399e(_0x29fc86,_0x2cc90f){const _0x1ee081=a28_0x5c2e();return a28_0x399e=function(_0x46d277,_0x1c0189){_0x46d277=_0x46d277-0xf7;let _0x5c2ebe=_0x1ee081[_0x46d277];return _0x5c2ebe;},a28_0x399e(_0x29fc86,_0x2cc90f);}export function assignDefaultEloRating(_0x116ade,_0x1fd693){const _0x4cec39=a28_0x399e,_0x297a2f=0x4b0;!_0x1fd693['eloRating']&&db[_0x4cec39(0x11c)]('players')['doc'](_0x116ade)['update']({'eloRating':_0x297a2f})['then'](()=>{const _0x4f0d61=_0x4cec39;console['log'](_0x4f0d61(0xfd)+_0x1fd693['username']);})[_0x4cec39(0x117)](_0x1885fd=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x1885fd);});}export async function updateEloRatings(_0x1e0f07,_0x1cc4b1,_0x174f38){const _0x3acbe2=a28_0x399e;try{const _0x37780d=writeBatch(db),_0x40114c=doc(db,'players',_0x1e0f07),_0x3733d4=doc(db,_0x3acbe2(0xf9),_0x1cc4b1),[_0x2b073,_0x15b480]=await Promise['all']([getDoc(_0x40114c),getDoc(_0x3733d4)]);if(!_0x2b073['exists']()||!_0x15b480[_0x3acbe2(0x102)]())throw new Error(_0x3acbe2(0x11f));const _0x160606=_0x2b073['data'](),_0x2e7c3a=_0x15b480[_0x3acbe2(0x10e)](),_0x58a5ee=_0x160606['position']||Number[_0x3acbe2(0x118)],_0x1e29c3=_0x2e7c3a[_0x3acbe2(0xfb)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x2a4662,newLoserRating:_0x51ff7a}=calculateElo(_0x160606['eloRating']||0x4b0,_0x2e7c3a['eloRating']||0x4b0);let _0x1cc9e3=_0x58a5ee,_0x2de966=_0x1e29c3;if(_0x58a5ee>_0x1e29c3){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x1cc9e3=_0x1e29c3,_0x2de966=_0x1e29c3+0x1;const _0x593ef9=query(collection(db,_0x3acbe2(0xf9)),where('position','>',_0x1e29c3),where('position','<',_0x58a5ee)),_0x1b105f=await getDocs(_0x593ef9);for(const _0x58b96f of _0x1b105f['docs']){_0x58b96f['id']!==_0x1e0f07&&_0x58b96f['id']!==_0x1cc4b1&&_0x37780d['update'](doc(db,'players',_0x58b96f['id']),{'position':_0x58b96f['data']()[_0x3acbe2(0xfb)]+0x1});}}else console[_0x3acbe2(0x10b)]('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x3d23e3={'eloRating':_0x2a4662,'lastMatchDate':serverTimestamp(),'position':_0x1cc9e3,'lastMatchId':_0x174f38},_0x4b3e61={'eloRating':_0x51ff7a,'lastMatchDate':serverTimestamp(),'position':_0x2de966,'lastMatchId':_0x174f38};return _0x37780d[_0x3acbe2(0x120)](_0x40114c,_0x3d23e3),_0x37780d[_0x3acbe2(0x120)](_0x3733d4,_0x4b3e61),await _0x37780d['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x1e0f07,'previousElo':_0x160606['eloRating']||0x4b0,'newElo':_0x2a4662,'opponentId':_0x1cc4b1,'matchResult':'win','previousPosition':_0x58a5ee,'newPosition':_0x1cc9e3,'isPromotion':_0x1cc9e3<_0x58a5ee,'matchId':_0x174f38,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x1cc4b1,'previousElo':_0x2e7c3a['eloRating']||0x4b0,'newElo':_0x51ff7a,'opponentId':_0x1e0f07,'matchResult':'loss','previousPosition':_0x1e29c3,'newPosition':_0x2de966,'isDemotion':_0x2de966>_0x1e29c3,'matchId':_0x174f38,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x1e0f07,_0x2a4662,_0x160606[_0x3acbe2(0x114)],{'source':'match','matchId':_0x174f38}),await promotionManager[_0x3acbe2(0x113)](_0x1cc4b1,_0x51ff7a,_0x2e7c3a['eloRating'],{'source':'match','matchId':_0x174f38}),console[_0x3acbe2(0x10b)](_0x3acbe2(0x111)),!![];}catch(_0x41f3fd){console[_0x3acbe2(0x116)]('Error\x20in\x20updateEloRatings:',_0x41f3fd);throw _0x41f3fd;}}function a28_0x5c2e(){const _0x10bbb0=['\x20match','uid','players','Error\x20approving\x20report:','position','docs','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found','displayName','warn','winRate','exists','loserScore','length','unknown','Unknown\x20User','wins','toString','apply','winnerUsername','log','bind','toISOString','data','totalDeaths','points','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','pow','checkAndRecordPromotion','eloRating','lastUpdated','error','catch','MAX_SAFE_INTEGER','approvedMatches','info','system-match-award','collection','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','all','One\x20or\x20both\x20players\x20not\x20found','update'];a28_0x5c2e=function(){return _0x10bbb0;};return a28_0x5c2e();}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x19a9e1,_0x1f7f61,_0x29d801,_0x12e7c5,_0x1bcafb){const _0x3ec1a9=a28_0x399e;try{const _0x353ed1=doc(db,'pendingMatches',_0x19a9e1),_0x3c9c50=await getDoc(_0x353ed1);if(!_0x3c9c50['exists']())throw new Error('Report\x20not\x20found');const _0x403b64=_0x3c9c50[_0x3ec1a9(0x10e)](),_0x3a5e82={..._0x403b64,'winnerScore':_0x1f7f61,'winnerSuicides':_0x29d801,'winnerComment':_0x12e7c5,'winnerDemoLink':_0x1bcafb,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x3ec1a9(0xf8)]};await setDoc(doc(db,_0x3ec1a9(0x119),_0x19a9e1),_0x3a5e82),await deleteDoc(_0x353ed1),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x127330,_0x3e6e8e]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x403b64[_0x3ec1a9(0x10a)]))),getDocs(query(collection(db,'players'),where('username','==',_0x403b64['loserUsername'])))]);if(_0x127330['empty']||_0x3e6e8e['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x1bfc4e=_0x127330[_0x3ec1a9(0xfc)][0x0]['id'],_0x19b8d8=_0x3e6e8e['docs'][0x0]['id'];await updateEloRatings(_0x1bfc4e,_0x19b8d8,_0x19a9e1);try{const _0x25c2c2=_0x403b64['subgameType']||'Standard',_0x4fd6bd=POINTS_CHART[_0x25c2c2]||0xa,_0x2936e5=doc(db,'userProfiles',_0x1bfc4e),_0x24feab=doc(db,'userProfiles',_0x19b8d8),[_0x187cbe,_0x22c83c]=await Promise[_0x3ec1a9(0x11e)]([getDoc(_0x2936e5),getDoc(_0x24feab)]);if(_0x187cbe[_0x3ec1a9(0x102)]()&&_0x22c83c['exists']()){const _0x10162d=_0x187cbe['data'](),_0x351bcf=_0x22c83c['data'](),_0x5f096d=_0x10162d[_0x3ec1a9(0x110)]||0x0,_0x4de06d=_0x351bcf['points']||0x0,_0x1f514c=_0x5f096d+_0x4fd6bd,_0xdb2fd8=_0x4de06d+_0x4fd6bd;await Promise['all']([updateDoc(_0x2936e5,{'points':_0x1f514c,'lastPointsModified':serverTimestamp()}),updateDoc(_0x24feab,{'points':_0xdb2fd8,'lastPointsModified':serverTimestamp()})]),await Promise[_0x3ec1a9(0x11e)]([addDoc(collection(db,'pointsHistory'),{'userId':_0x1bfc4e,'userEmail':_0x10162d['email']||'unknown','displayName':_0x10162d[_0x3ec1a9(0xff)]||_0x10162d['username']||'Unknown\x20User','action':'add','amount':_0x4fd6bd,'previousPoints':_0x5f096d,'newPoints':_0x1f514c,'reason':'Match\x20points:\x20'+_0x25c2c2+'\x20match\x20(Winner)','adminEmail':_0x3ec1a9(0x11b),'timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x19b8d8,'userEmail':_0x351bcf['email']||_0x3ec1a9(0x105),'displayName':_0x351bcf[_0x3ec1a9(0xff)]||_0x351bcf['username']||_0x3ec1a9(0x106),'action':'add','amount':_0x4fd6bd,'previousPoints':_0x4de06d,'newPoints':_0xdb2fd8,'reason':'Match\x20points:\x20'+_0x25c2c2+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console[_0x3ec1a9(0x10b)]('Awarded\x20'+_0x4fd6bd+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x25c2c2+_0x3ec1a9(0xf7));}else console['warn'](_0x3ec1a9(0xfe));}catch(_0x1d7c4e){console['warn'](_0x3ec1a9(0x11d),_0x1d7c4e);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x5dc742){console['error'](_0x3ec1a9(0xfa),_0x5dc742);throw _0x5dc742;}}async function updatePlayerElo(_0x2592a5,_0x4b7e37,_0xa0339d){const _0x56c761=a28_0x399e;await setDoc(doc(db,_0x56c761(0xf9),_0x2592a5),{...playerData,'eloRating':_0xa0339d}),await checkAndRecordPromotion(_0x2592a5,_0xa0339d,_0x4b7e37);}async function updatePlayerStats(_0x507cca,_0x4d64a2,_0x25792c){const _0xda252=a28_0x399e,_0x2348c0=doc(db,'playerStats',_0x507cca),_0x5b8e1c=await getDoc(_0x2348c0);let _0x41ae43=_0x5b8e1c[_0xda252(0x102)]()?_0x5b8e1c['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x25792c?(_0x41ae43[_0xda252(0x107)]++,_0x41ae43['totalKills']+=parseInt(_0x4d64a2['winnerScore']||0x0),_0x41ae43['totalDeaths']+=parseInt(_0x4d64a2['loserScore']||0x0)):(_0x41ae43['losses']++,_0x41ae43['totalKills']+=parseInt(_0x4d64a2[_0xda252(0x103)]||0x0),_0x41ae43[_0xda252(0x10f)]+=parseInt(_0x4d64a2['winnerScore']||0x0));const _0x536c39=_0x41ae43[_0xda252(0x107)]+_0x41ae43['losses'];_0x41ae43[_0xda252(0x101)]=_0x536c39>0x0?(_0x41ae43['wins']/_0x536c39*0x64)['toFixed'](0x1):0x0,_0x41ae43[_0xda252(0x115)]=new Date()[_0xda252(0x10d)](),await setDoc(_0x2348c0,_0x41ae43,{'merge':!![]});}