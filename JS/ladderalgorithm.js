const a28_0x394789=(function(){let _0x591dbf=!![];return function(_0x377b2,_0x2c7d12){const _0x5dbaf5=_0x591dbf?function(){if(_0x2c7d12){const _0x22ff54=_0x2c7d12['apply'](_0x377b2,arguments);return _0x2c7d12=null,_0x22ff54;}}:function(){};return _0x591dbf=![],_0x5dbaf5;};}()),a28_0x2e9f1f=a28_0x394789(this,function(){const _0x208e4f=a28_0x15e0;let _0x446ffa;try{const _0x5c590c=Function(_0x208e4f(0x1cf)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x446ffa=_0x5c590c();}catch(_0x2de595){_0x446ffa=window;}const _0x1e8f57=_0x446ffa['console']=_0x446ffa[_0x208e4f(0x1da)]||{},_0x30097f=[_0x208e4f(0x1e9),'warn','info','error','exception',_0x208e4f(0x1d8),'trace'];for(let _0x27f1c5=0x0;_0x27f1c5<_0x30097f[_0x208e4f(0x1d6)];_0x27f1c5++){const _0x589dfc=a28_0x394789['constructor']['prototype'][_0x208e4f(0x1fa)](a28_0x394789),_0x536a4d=_0x30097f[_0x27f1c5],_0x2feaf0=_0x1e8f57[_0x536a4d]||_0x589dfc;_0x589dfc[_0x208e4f(0x1e3)]=a28_0x394789['bind'](a28_0x394789),_0x589dfc['toString']=_0x2feaf0[_0x208e4f(0x1f2)]['bind'](_0x2feaf0),_0x1e8f57[_0x536a4d]=_0x589dfc;}});function a28_0x15e0(_0x1200d8,_0x43d664){const _0x2e9f1f=a28_0x29d2();return a28_0x15e0=function(_0x394789,_0x279367){_0x394789=_0x394789-0x1cb;let _0x29d275=_0x2e9f1f[_0x394789];return _0x29d275;},a28_0x15e0(_0x1200d8,_0x43d664);}a28_0x2e9f1f();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a28_0x29d2(){const _0x2ca31f=['totalKills','\x20match\x20(Winner)','lastUpdated','One\x20or\x20both\x20players\x20not\x20found','return\x20(function()\x20','totalDeaths','winRate','update','loserUsername','toFixed','pointsHistory','length','exists','table','pow','console','add','loss','all','subgameType','collection','warn','userProfiles','winnerScore','__proto__','win','Unknown\x20User','totalMatches','email','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','log','players','wins','Could\x20not\x20find\x20player\x20documents','position','data','\x20points\x20to\x20both\x20players\x20for\x20','empty','match','toString','Report\x20not\x20found','\x20match\x20(Participant)','unknown','Match\x20points:\x20','displayName','color','eloRating','bind'];a28_0x29d2=function(){return _0x2ca31f;};return a28_0x29d2();}import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{RANKS,getRankStyle}from'./ranks.js';export function calculateElo(_0x2959a8,_0x5b21fc,_0x44e572=0x20){const _0x5175c7=a28_0x15e0;_0x2959a8=_0x2959a8>0x3e8?0xc8:_0x2959a8,_0x5b21fc=_0x5b21fc>0x3e8?0xc8:_0x5b21fc;const _0x2d4a2e=0x1/(0x1+Math[_0x5175c7(0x1d9)](0xa,(_0x5b21fc-_0x2959a8)/0x190)),_0x18e519=0x1/(0x1+Math[_0x5175c7(0x1d9)](0xa,(_0x2959a8-_0x5b21fc)/0x190)),_0x46e6e2=_0x2959a8+_0x44e572*(0x1-_0x2d4a2e),_0x2835f7=_0x5b21fc+_0x44e572*(0x0-_0x18e519);return{'newWinnerRating':Math['round'](Math['min'](_0x46e6e2)),'newLoserRating':Math['round'](Math['max'](_0x2835f7,0x0))};}export function assignDefaultEloRating(_0x3e4e24,_0x41f458){const _0x3bd4e5=a28_0x15e0,_0x10afac=0xc8;!_0x41f458['eloRating']&&db[_0x3bd4e5(0x1df)]('players')['doc'](_0x3e4e24)[_0x3bd4e5(0x1d2)]({'eloRating':_0x10afac})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x41f458['username']);})['catch'](_0x15a8c4=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x15a8c4);});}export async function updateEloRatings(_0x4ed25e,_0x144fde,_0x398bab){const _0x1479fd=a28_0x15e0;try{const _0x56b870=writeBatch(db),_0x4a3756=doc(db,_0x1479fd(0x1ea),_0x4ed25e),_0x1835a0=doc(db,_0x1479fd(0x1ea),_0x144fde),[_0x35d7d6,_0x12ff58]=await Promise['all']([getDoc(_0x4a3756),getDoc(_0x1835a0)]);if(!_0x35d7d6['exists']()||!_0x12ff58['exists']())throw new Error(_0x1479fd(0x1ce));const _0x50e51e=_0x35d7d6[_0x1479fd(0x1ee)](),_0x5981c8=_0x12ff58['data'](),_0x2b25b0=_0x50e51e[_0x1479fd(0x1ed)]||Number['MAX_SAFE_INTEGER'],_0x272264=_0x5981c8[_0x1479fd(0x1ed)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0xec7114,newLoserRating:_0x32689e}=calculateElo(_0x50e51e['eloRating']||0x4b0,_0x5981c8['eloRating']||0x4b0);let _0x465966=_0x2b25b0,_0x3d68b4=_0x272264;if(_0x2b25b0>_0x272264){console[_0x1479fd(0x1e9)]('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x465966=_0x272264,_0x3d68b4=_0x272264+0x1;const _0x1b2b5b=query(collection(db,'players'),where('position','>',_0x272264),where(_0x1479fd(0x1ed),'<',_0x2b25b0)),_0x37c914=await getDocs(_0x1b2b5b);for(const _0x58f904 of _0x37c914['docs']){_0x58f904['id']!==_0x4ed25e&&_0x58f904['id']!==_0x144fde&&_0x56b870['update'](doc(db,_0x1479fd(0x1ea),_0x58f904['id']),{'position':_0x58f904['data']()[_0x1479fd(0x1ed)]+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x30c896={'eloRating':_0xec7114,'lastMatchDate':serverTimestamp(),'position':_0x465966,'lastMatchId':_0x398bab},_0x4edaf2={'eloRating':_0x32689e,'lastMatchDate':serverTimestamp(),'position':_0x3d68b4,'lastMatchId':_0x398bab};return _0x56b870[_0x1479fd(0x1d2)](_0x4a3756,_0x30c896),_0x56b870['update'](_0x1835a0,_0x4edaf2),await _0x56b870['commit'](),console[_0x1479fd(0x1e9)]('ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x1479fd(0x1dd)]([recordEloChange({'playerId':_0x4ed25e,'previousElo':_0x50e51e[_0x1479fd(0x1f9)]||0x4b0,'newElo':_0xec7114,'opponentId':_0x144fde,'matchResult':_0x1479fd(0x1e4),'previousPosition':_0x2b25b0,'newPosition':_0x465966,'isPromotion':_0x465966<_0x2b25b0,'matchId':_0x398bab,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x144fde,'previousElo':_0x5981c8['eloRating']||0x4b0,'newElo':_0x32689e,'opponentId':_0x4ed25e,'matchResult':_0x1479fd(0x1dc),'previousPosition':_0x272264,'newPosition':_0x3d68b4,'isDemotion':_0x3d68b4>_0x272264,'matchId':_0x398bab,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x4ed25e,_0xec7114,_0x50e51e[_0x1479fd(0x1f9)],{'source':_0x1479fd(0x1f1),'matchId':_0x398bab}),await promotionManager['checkAndRecordPromotion'](_0x144fde,_0x32689e,_0x5981c8['eloRating'],{'source':'match','matchId':_0x398bab}),console[_0x1479fd(0x1e9)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x5f4cda){console['error']('Error\x20in\x20updateEloRatings:',_0x5f4cda);throw _0x5f4cda;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x43c2d9,_0x28520e,_0x2df494,_0x1d45f5,_0xd1027a){const _0x33ecb9=a28_0x15e0;try{const _0x53d162=doc(db,'pendingMatches',_0x43c2d9),_0x343b27=await getDoc(_0x53d162);if(!_0x343b27['exists']())throw new Error(_0x33ecb9(0x1f3));const _0x2c3856=_0x343b27['data'](),_0x29c308={..._0x2c3856,'winnerScore':_0x28520e,'winnerSuicides':_0x2df494,'winnerComment':_0x1d45f5,'winnerDemoLink':_0xd1027a,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x43c2d9),_0x29c308),await deleteDoc(_0x53d162),console[_0x33ecb9(0x1e9)]('Match\x20moved\x20to\x20approved\x20collection');const [_0x44e711,_0x179b29]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x2c3856['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x2c3856[_0x33ecb9(0x1d3)])))]);if(_0x44e711['empty']||_0x179b29[_0x33ecb9(0x1f0)])throw new Error(_0x33ecb9(0x1ec));const _0x2315d3=_0x44e711['docs'][0x0]['id'],_0xbac7e9=_0x179b29['docs'][0x0]['id'];await updateEloRatings(_0x2315d3,_0xbac7e9,_0x43c2d9);try{const _0x2ec95d=_0x2c3856[_0x33ecb9(0x1de)]||'Standard',_0x286efc=POINTS_CHART[_0x2ec95d]||0xa,_0x4edabb=doc(db,_0x33ecb9(0x1e1),_0x2315d3),_0x50a9e1=doc(db,'userProfiles',_0xbac7e9),[_0x3f4945,_0x19e65a]=await Promise['all']([getDoc(_0x4edabb),getDoc(_0x50a9e1)]);if(_0x3f4945[_0x33ecb9(0x1d7)]()&&_0x19e65a['exists']()){const _0x191b37=_0x3f4945['data'](),_0x3498ed=_0x19e65a['data'](),_0x988e35=_0x191b37['points']||0x0,_0x1ebeac=_0x3498ed['points']||0x0,_0x46fd24=_0x988e35+_0x286efc,_0x1a0fb3=_0x1ebeac+_0x286efc;await Promise['all']([updateDoc(_0x4edabb,{'points':_0x46fd24,'lastPointsModified':serverTimestamp()}),updateDoc(_0x50a9e1,{'points':_0x1a0fb3,'lastPointsModified':serverTimestamp()})]),await Promise[_0x33ecb9(0x1dd)]([addDoc(collection(db,_0x33ecb9(0x1d5)),{'userId':_0x2315d3,'userEmail':_0x191b37[_0x33ecb9(0x1e7)]||_0x33ecb9(0x1f5),'displayName':_0x191b37['displayName']||_0x191b37['username']||_0x33ecb9(0x1e5),'action':_0x33ecb9(0x1db),'amount':_0x286efc,'previousPoints':_0x988e35,'newPoints':_0x46fd24,'reason':'Match\x20points:\x20'+_0x2ec95d+_0x33ecb9(0x1cc),'adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0xbac7e9,'userEmail':_0x3498ed['email']||'unknown','displayName':_0x3498ed[_0x33ecb9(0x1f7)]||_0x3498ed['username']||'Unknown\x20User','action':'add','amount':_0x286efc,'previousPoints':_0x1ebeac,'newPoints':_0x1a0fb3,'reason':_0x33ecb9(0x1f6)+_0x2ec95d+_0x33ecb9(0x1f4),'adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log']('Awarded\x20'+_0x286efc+_0x33ecb9(0x1ef)+_0x2ec95d+'\x20match');}else console[_0x33ecb9(0x1e0)]('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x3112af){console['warn'](_0x33ecb9(0x1e8),_0x3112af);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x4037bb){console['error']('Error\x20approving\x20report:',_0x4037bb);throw _0x4037bb;}}async function updatePlayerElo(_0x39ff34,_0x274ed1,_0x4ef01c){const _0x455e1d=a28_0x15e0,_0x480b5f=doc(db,_0x455e1d(0x1ea),_0x39ff34),_0x5e7126=await getDoc(_0x480b5f),_0x2709f8=_0x5e7126['data'](),_0x222997=doc(db,'playerStats',_0x39ff34),_0x5259cf=await getDoc(_0x222997),_0x48b3bf=_0x5259cf['data']()||{'totalMatches':0x0,'winRate':0x0},_0x4a2293=getRankStyle(_0x4ef01c,_0x48b3bf[_0x455e1d(0x1e6)],_0x48b3bf['winRate']);await updateDoc(_0x480b5f,{'eloRating':_0x4ef01c,'rank':_0x4a2293['name'],'rankColor':_0x4a2293[_0x455e1d(0x1f8)]}),await checkAndRecordPromotion(_0x39ff34,_0x4ef01c,_0x274ed1,{'matchCount':_0x48b3bf[_0x455e1d(0x1e6)],'winRate':_0x48b3bf[_0x455e1d(0x1d1)]});}async function updatePlayerStats(_0x20a8f4,_0x38ded3,_0x4f6f17){const _0x558d73=a28_0x15e0,_0x1cf78e=doc(db,'playerStats',_0x20a8f4),_0xf04c50=await getDoc(_0x1cf78e);let _0x29dc4b=_0xf04c50['exists']()?_0xf04c50['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x4f6f17?(_0x29dc4b['wins']++,_0x29dc4b['totalKills']+=parseInt(_0x38ded3[_0x558d73(0x1e2)]||0x0),_0x29dc4b['totalDeaths']+=parseInt(_0x38ded3['loserScore']||0x0)):(_0x29dc4b['losses']++,_0x29dc4b[_0x558d73(0x1cb)]+=parseInt(_0x38ded3['loserScore']||0x0),_0x29dc4b[_0x558d73(0x1d0)]+=parseInt(_0x38ded3['winnerScore']||0x0));const _0xd2831=_0x29dc4b[_0x558d73(0x1eb)]+_0x29dc4b['losses'];_0x29dc4b[_0x558d73(0x1d1)]=_0xd2831>0x0?(_0x29dc4b['wins']/_0xd2831*0x64)[_0x558d73(0x1d4)](0x1):0x0,_0x29dc4b[_0x558d73(0x1cd)]=new Date()['toISOString'](),await setDoc(_0x1cf78e,_0x29dc4b,{'merge':!![]});}