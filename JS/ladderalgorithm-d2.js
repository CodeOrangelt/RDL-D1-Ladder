const a26_0x1282a0=(function(){let _0x41cdff=!![];return function(_0x2bc8a8,_0x29ee63){const _0xd0818f=_0x41cdff?function(){if(_0x29ee63){const _0x1984ae=_0x29ee63['apply'](_0x2bc8a8,arguments);return _0x29ee63=null,_0x1984ae;}}:function(){};return _0x41cdff=![],_0xd0818f;};}()),a26_0x2ff628=a26_0x1282a0(this,function(){const _0x1d3cb8=a26_0x5023,_0x113363=function(){let _0x1f32be;try{_0x1f32be=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x102df1){_0x1f32be=window;}return _0x1f32be;},_0x1c0579=_0x113363(),_0x442c80=_0x1c0579[_0x1d3cb8(0x1aa)]=_0x1c0579[_0x1d3cb8(0x1aa)]||{},_0x47be29=['log','warn','info','error','exception','table','trace'];for(let _0x18739f=0x0;_0x18739f<_0x47be29[_0x1d3cb8(0x1ab)];_0x18739f++){const _0x224e29=a26_0x1282a0[_0x1d3cb8(0x1ae)]['prototype']['bind'](a26_0x1282a0),_0x25d5f3=_0x47be29[_0x18739f],_0x1ec0f7=_0x442c80[_0x25d5f3]||_0x224e29;_0x224e29[_0x1d3cb8(0x1a5)]=a26_0x1282a0[_0x1d3cb8(0x1b6)](a26_0x1282a0),_0x224e29['toString']=_0x1ec0f7['toString']['bind'](_0x1ec0f7),_0x442c80[_0x25d5f3]=_0x224e29;}});a26_0x2ff628();function a26_0xbb9a(){const _0x20f6eb=['position','pow','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','__proto__','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','username','update','winnerUsername','console','length','log','eloRating','constructor','playersD2','exists','commit','round','Starting\x20approveReportD2\x20function\x20with:','checkAndRecordPromotion','Error\x20in\x20updateEloRatingsD2:','bind'];a26_0xbb9a=function(){return _0x20f6eb;};return a26_0xbb9a();}function a26_0x5023(_0x23e8b5,_0x27943b){const _0x2ff628=a26_0xbb9a();return a26_0x5023=function(_0x1282a0,_0x5de6ab){_0x1282a0=_0x1282a0-0x1a2;let _0xbb9a00=_0x2ff628[_0x1282a0];return _0xbb9a00;},a26_0x5023(_0x23e8b5,_0x27943b);}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x4a5be0 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x5c9c5d,_0x1b3704,_0x55b1a3=0x20){const _0x205251=a26_0x5023,_0x228014=0x1/(0x1+Math[_0x205251(0x1a3)](0xa,(_0x1b3704-_0x5c9c5d)/0x190)),_0x1ac726=0x1/(0x1+Math['pow'](0xa,(_0x5c9c5d-_0x1b3704)/0x190)),_0x59c2ac=_0x5c9c5d+_0x55b1a3*(0x1-_0x228014),_0x4dfd59=_0x1b3704+_0x55b1a3*(0x0-_0x1ac726);return{'newWinnerRating':Math['round'](_0x59c2ac),'newLoserRating':Math[_0x205251(0x1b2)](_0x4dfd59)};}export async function updateEloRatingsD2(_0x41b663,_0x5e4c67,_0x5268d4){const _0x392ca4=a26_0x5023;try{const _0x45d6a9=writeBatch(db),_0x5ef3dd=doc(db,_0x392ca4(0x1af),_0x41b663),_0x291d1c=doc(db,'playersD2',_0x5e4c67),[_0x1f60f4,_0x2cef6b]=await Promise['all']([getDoc(_0x5ef3dd),getDoc(_0x291d1c)]);if(!_0x1f60f4[_0x392ca4(0x1b0)]()||!_0x2cef6b[_0x392ca4(0x1b0)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x31f504=_0x1f60f4['data'](),_0x4b1a9f=_0x2cef6b['data'](),_0x301381=_0x31f504['position']||Number['MAX_SAFE_INTEGER'],_0x5d4c0b=_0x4b1a9f['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x39cb10,newLoserRating:_0x24ad7d}=calculateEloD2(_0x31f504[_0x392ca4(0x1ad)]||0x4b0,_0x4b1a9f['eloRating']||0x4b0);let _0x277885=_0x301381,_0x28dbdc=_0x5d4c0b;if(_0x301381>_0x5d4c0b){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x277885=_0x5d4c0b,_0x28dbdc=_0x5d4c0b+0x1;const _0x549e6f=query(collection(db,'playersD2'),where('position','>',_0x5d4c0b),where('position','<',_0x301381)),_0x451b6c=await getDocs(_0x549e6f);for(const _0x2d536d of _0x451b6c['docs']){_0x2d536d['id']!==_0x41b663&&_0x2d536d['id']!==_0x5e4c67&&_0x45d6a9['update'](doc(db,'playersD2',_0x2d536d['id']),{'position':_0x2d536d['data']()[_0x392ca4(0x1a2)]+0x1});}}else console[_0x392ca4(0x1ac)](_0x392ca4(0x1a4));return _0x45d6a9[_0x392ca4(0x1a8)](_0x5ef3dd,{'eloRating':_0x39cb10,'lastMatchDate':serverTimestamp(),'position':_0x277885,'lastMatchId':_0x5268d4}),_0x45d6a9['update'](_0x291d1c,{'eloRating':_0x24ad7d,'lastMatchDate':serverTimestamp(),'position':_0x28dbdc,'lastMatchId':_0x5268d4}),await _0x45d6a9[_0x392ca4(0x1b1)](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x41b663,'previousElo':_0x31f504['eloRating']||0x4b0,'newElo':_0x39cb10,'opponentId':_0x5e4c67,'matchResult':'win','previousPosition':_0x301381,'newPosition':_0x277885,'isPromotion':_0x277885<_0x301381,'matchId':_0x5268d4,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x5e4c67,'previousElo':_0x4b1a9f['eloRating']||0x4b0,'newElo':_0x24ad7d,'opponentId':_0x41b663,'matchResult':'loss','previousPosition':_0x5d4c0b,'newPosition':_0x28dbdc,'isDemotion':_0x28dbdc>_0x5d4c0b,'matchId':_0x5268d4,'timestamp':serverTimestamp()})]),await promotionManager[_0x392ca4(0x1b4)](_0x41b663,_0x39cb10,_0x31f504['eloRating'],{'source':'match-d2','matchId':_0x5268d4}),await promotionManager[_0x392ca4(0x1b4)](_0x5e4c67,_0x24ad7d,_0x4b1a9f[_0x392ca4(0x1ad)],{'source':'match-d2','matchId':_0x5268d4}),!![];}catch(_0x5393ca){console['error'](_0x392ca4(0x1b5),_0x5393ca);throw _0x5393ca;}}export async function approveReportD2(_0x40a28e,_0x3c4710,_0x18c0a1,_0x135319){const _0x4a8630=a26_0x5023;try{console['log'](_0x4a8630(0x1b3),{'reportId':_0x40a28e,'winnerScore':_0x3c4710,'winnerSuicides':_0x18c0a1,'winnerComment':_0x135319});const _0x1d776c=auth['currentUser'];if(!_0x1d776c){console[_0x4a8630(0x1ac)]('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console[_0x4a8630(0x1ac)]('Current\x20user:',_0x1d776c['email']);const _0x4e9a91=await getDoc(doc(db,'playersD2',_0x1d776c['uid'])),_0x4cbad5=_0x4e9a91['exists']()?_0x4e9a91['data']()['username']:null;console['log']('Current\x20username:',_0x4cbad5);const _0x41e12f=doc(db,'pendingMatchesD2',_0x40a28e),_0x4ee1bf=await getDoc(_0x41e12f);if(!_0x4ee1bf['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x40a28e);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x61ae6c=_0x4ee1bf['data']();console['log']('D2\x20Report\x20data:',_0x61ae6c);if(_0x4cbad5!==_0x61ae6c['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x5d23f6={..._0x61ae6c,'winnerScore':_0x3c4710,'winnerSuicides':_0x18c0a1,'winnerComment':_0x135319,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x4cbad5,'createdAt':_0x61ae6c['createdAt']||serverTimestamp(),'winnerUsername':_0x61ae6c[_0x4a8630(0x1a9)],'loserUsername':_0x61ae6c['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x40a28e),_0x5d23f6),await deleteDoc(_0x41e12f),console[_0x4a8630(0x1ac)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0xc34242,_0x3c8385]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where(_0x4a8630(0x1a7),'==',_0x61ae6c['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x61ae6c['loserUsername'])))]);if(_0xc34242['empty']||_0x3c8385['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x1e1f14=_0xc34242['docs'][0x0]['id'],_0x2660b9=_0x3c8385['docs'][0x0]['id'];return await updateEloRatingsD2(_0x1e1f14,_0x2660b9,_0x40a28e),console[_0x4a8630(0x1ac)](_0x4a8630(0x1a6)),!![];}catch(_0x503ca4){console['error']('Error\x20in\x20approveReportD2:',_0x503ca4);throw _0x503ca4;}}