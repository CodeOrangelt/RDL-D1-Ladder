const a28_0x380cf1=(function(){let _0x42a26e=!![];return function(_0x5a0325,_0x21158c){const _0x432c63=_0x42a26e?function(){const _0x1ae7db=a28_0x14bb;if(_0x21158c){const _0x5b1567=_0x21158c[_0x1ae7db(0x1a2)](_0x5a0325,arguments);return _0x21158c=null,_0x5b1567;}}:function(){};return _0x42a26e=![],_0x432c63;};}()),a28_0x121787=a28_0x380cf1(this,function(){const _0x486582=a28_0x14bb,_0x6bb02=function(){let _0x1f9a5a;try{_0x1f9a5a=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x380efb){_0x1f9a5a=window;}return _0x1f9a5a;},_0x4d0612=_0x6bb02(),_0x2e38fe=_0x4d0612[_0x486582(0x1ae)]=_0x4d0612['console']||{},_0x2e0fad=['log','warn',_0x486582(0x1ac),'error',_0x486582(0x1a7),'table','trace'];for(let _0x182ae8=0x0;_0x182ae8<_0x2e0fad['length'];_0x182ae8++){const _0x4a85fc=a28_0x380cf1['constructor'][_0x486582(0x1b1)]['bind'](a28_0x380cf1),_0x5700d3=_0x2e0fad[_0x182ae8],_0x4f1810=_0x2e38fe[_0x5700d3]||_0x4a85fc;_0x4a85fc[_0x486582(0x1b4)]=a28_0x380cf1['bind'](a28_0x380cf1),_0x4a85fc['toString']=_0x4f1810[_0x486582(0x1a4)]['bind'](_0x4f1810),_0x2e38fe[_0x5700d3]=_0x4a85fc;}});a28_0x121787();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x1fb8(){const _0x9d6c2c=['loserUsername','apply','match-d2','toString','docs','uid','exception','Starting\x20approveReportD2\x20function\x20with:','update','playersD2','D2\x20match\x20report\x20not\x20found','info','data','console','One\x20or\x20both\x20D2\x20players\x20not\x20found','log','prototype','D2\x20Report\x20not\x20found\x20with\x20ID:','eloRating','__proto__','checkAndRecordPromotion','empty','Could\x20not\x20find\x20D2\x20player\x20documents','Current\x20user:','round','pendingMatchesD2','position','exists'];a28_0x1fb8=function(){return _0x9d6c2c;};return a28_0x1fb8();}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a28_0x14bb(_0x1b3049,_0x3ff5c3){const _0x121787=a28_0x1fb8();return a28_0x14bb=function(_0x380cf1,_0x4c46b5){_0x380cf1=_0x380cf1-0x1a1;let _0x1fb8eb=_0x121787[_0x380cf1];return _0x1fb8eb;},a28_0x14bb(_0x1b3049,_0x3ff5c3);}import a28_0x5c5f19 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x4b5e59,_0x414b82,_0x532a71=0x20){const _0x5d1c19=a28_0x14bb,_0x25942a=0x1/(0x1+Math['pow'](0xa,(_0x414b82-_0x4b5e59)/0x190)),_0x22b31a=0x1/(0x1+Math['pow'](0xa,(_0x4b5e59-_0x414b82)/0x190)),_0x49bc62=_0x4b5e59+_0x532a71*(0x1-_0x25942a),_0x4612cc=_0x414b82+_0x532a71*(0x0-_0x22b31a);return{'newWinnerRating':Math[_0x5d1c19(0x1b9)](_0x49bc62),'newLoserRating':Math[_0x5d1c19(0x1b9)](_0x4612cc)};}export async function updateEloRatingsD2(_0x9c6eb8,_0x1f6faf,_0x455b92){const _0xfd8ee2=a28_0x14bb;try{const _0x18a0b0=writeBatch(db),_0xb4d569=doc(db,'playersD2',_0x9c6eb8),_0x17f20f=doc(db,'playersD2',_0x1f6faf),[_0x194760,_0x1b47b7]=await Promise['all']([getDoc(_0xb4d569),getDoc(_0x17f20f)]);if(!_0x194760[_0xfd8ee2(0x1bc)]()||!_0x1b47b7['exists']())throw new Error(_0xfd8ee2(0x1af));const _0x360bc3=_0x194760['data'](),_0xfe6c98=_0x1b47b7['data'](),_0xef046=_0x360bc3['position']||Number['MAX_SAFE_INTEGER'],_0x5e5cbe=_0xfe6c98[_0xfd8ee2(0x1bb)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x4f2f2a,newLoserRating:_0x363a5e}=calculateEloD2(_0x360bc3[_0xfd8ee2(0x1b3)]||0x4b0,_0xfe6c98['eloRating']||0x4b0);let _0x2d0a38=_0xef046,_0x45978b=_0x5e5cbe;if(_0xef046>_0x5e5cbe){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x2d0a38=_0x5e5cbe,_0x45978b=_0x5e5cbe+0x1;const _0x5bda50=query(collection(db,_0xfd8ee2(0x1aa)),where(_0xfd8ee2(0x1bb),'>',_0x5e5cbe),where('position','<',_0xef046)),_0xf659d5=await getDocs(_0x5bda50);for(const _0x1723c7 of _0xf659d5['docs']){_0x1723c7['id']!==_0x9c6eb8&&_0x1723c7['id']!==_0x1f6faf&&_0x18a0b0['update'](doc(db,'playersD2',_0x1723c7['id']),{'position':_0x1723c7[_0xfd8ee2(0x1ad)]()['position']+0x1});}}else console[_0xfd8ee2(0x1b0)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x18a0b0['update'](_0xb4d569,{'eloRating':_0x4f2f2a,'lastMatchDate':serverTimestamp(),'position':_0x2d0a38,'lastMatchId':_0x455b92}),_0x18a0b0[_0xfd8ee2(0x1a9)](_0x17f20f,{'eloRating':_0x363a5e,'lastMatchDate':serverTimestamp(),'position':_0x45978b,'lastMatchId':_0x455b92}),await _0x18a0b0['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x9c6eb8,'previousElo':_0x360bc3[_0xfd8ee2(0x1b3)]||0x4b0,'newElo':_0x4f2f2a,'opponentId':_0x1f6faf,'matchResult':'win','previousPosition':_0xef046,'newPosition':_0x2d0a38,'isPromotion':_0x2d0a38<_0xef046,'matchId':_0x455b92,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x1f6faf,'previousElo':_0xfe6c98['eloRating']||0x4b0,'newElo':_0x363a5e,'opponentId':_0x9c6eb8,'matchResult':'loss','previousPosition':_0x5e5cbe,'newPosition':_0x45978b,'isDemotion':_0x45978b>_0x5e5cbe,'matchId':_0x455b92,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x9c6eb8,_0x4f2f2a,_0x360bc3['eloRating'],{'source':'match-d2','matchId':_0x455b92}),await promotionManager[_0xfd8ee2(0x1b5)](_0x1f6faf,_0x363a5e,_0xfe6c98['eloRating'],{'source':_0xfd8ee2(0x1a3),'matchId':_0x455b92}),!![];}catch(_0x177645){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x177645);throw _0x177645;}}export async function approveReportD2(_0x33524e,_0x3f9450,_0x1df3cb,_0x2e3044){const _0x1c4c84=a28_0x14bb;try{console['log'](_0x1c4c84(0x1a8),{'reportId':_0x33524e,'winnerScore':_0x3f9450,'winnerSuicides':_0x1df3cb,'winnerComment':_0x2e3044});const _0x427844=auth['currentUser'];if(!_0x427844){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log'](_0x1c4c84(0x1b8),_0x427844['email']);const _0x723b95=await getDoc(doc(db,_0x1c4c84(0x1aa),_0x427844[_0x1c4c84(0x1a6)])),_0x5bd5b7=_0x723b95[_0x1c4c84(0x1bc)]()?_0x723b95['data']()['username']:null;console['log']('Current\x20username:',_0x5bd5b7);const _0x528652=doc(db,_0x1c4c84(0x1ba),_0x33524e),_0x39b803=await getDoc(_0x528652);if(!_0x39b803['exists']()){console['log'](_0x1c4c84(0x1b2),_0x33524e);throw new Error(_0x1c4c84(0x1ab));}const _0x44c2b6=_0x39b803[_0x1c4c84(0x1ad)]();console[_0x1c4c84(0x1b0)]('D2\x20Report\x20data:',_0x44c2b6);if(_0x5bd5b7!==_0x44c2b6['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x21d284={..._0x44c2b6,'winnerScore':_0x3f9450,'winnerSuicides':_0x1df3cb,'winnerComment':_0x2e3044,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x5bd5b7,'createdAt':_0x44c2b6['createdAt']||serverTimestamp(),'winnerUsername':_0x44c2b6['winnerUsername'],'loserUsername':_0x44c2b6[_0x1c4c84(0x1a1)]};await setDoc(doc(db,'approvedMatchesD2',_0x33524e),_0x21d284),await deleteDoc(_0x528652),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x3ed8dd,_0x1e4bb1]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x44c2b6['winnerUsername']))),getDocs(query(collection(db,_0x1c4c84(0x1aa)),where('username','==',_0x44c2b6['loserUsername'])))]);if(_0x3ed8dd['empty']||_0x1e4bb1[_0x1c4c84(0x1b6)])throw new Error(_0x1c4c84(0x1b7));const _0x27fd21=_0x3ed8dd['docs'][0x0]['id'],_0x3904c2=_0x1e4bb1[_0x1c4c84(0x1a5)][0x0]['id'];return await updateEloRatingsD2(_0x27fd21,_0x3904c2,_0x33524e),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x391247){console['error']('Error\x20in\x20approveReportD2:',_0x391247);throw _0x391247;}}