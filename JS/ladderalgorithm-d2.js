const a26_0x2a978a=(function(){let _0x235e3e=!![];return function(_0x4abe82,_0x45719c){const _0x34d82e=_0x235e3e?function(){const _0x31790f=a26_0x433c;if(_0x45719c){const _0x1705ed=_0x45719c[_0x31790f(0x19b)](_0x4abe82,arguments);return _0x45719c=null,_0x1705ed;}}:function(){};return _0x235e3e=![],_0x34d82e;};}()),a26_0x566bc2=a26_0x2a978a(this,function(){const _0x444304=a26_0x433c,_0x57e4dc=function(){let _0x1b07ae;try{_0x1b07ae=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x446923){_0x1b07ae=window;}return _0x1b07ae;},_0x156ac7=_0x57e4dc(),_0x1a3840=_0x156ac7['console']=_0x156ac7['console']||{},_0x259b82=['log','warn','info','error','exception','table','trace'];for(let _0x58c784=0x0;_0x58c784<_0x259b82['length'];_0x58c784++){const _0x4a41c5=a26_0x2a978a[_0x444304(0x1a0)]['prototype'][_0x444304(0x19d)](a26_0x2a978a),_0x2ca186=_0x259b82[_0x58c784],_0x24dba2=_0x1a3840[_0x2ca186]||_0x4a41c5;_0x4a41c5['__proto__']=a26_0x2a978a['bind'](a26_0x2a978a),_0x4a41c5['toString']=_0x24dba2['toString']['bind'](_0x24dba2),_0x1a3840[_0x2ca186]=_0x4a41c5;}});a26_0x566bc2();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a26_0x433c(_0x573767,_0x3c3623){const _0x566bc2=a26_0x5ae7();return a26_0x433c=function(_0x2a978a,_0x49d510){_0x2a978a=_0x2a978a-0x190;let _0x5ae741=_0x566bc2[_0x2a978a];return _0x5ae741;},a26_0x433c(_0x573767,_0x3c3623);}import a26_0x3816da from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x171a23,_0x595118,_0x187f54=0x20){const _0x268766=0x1/(0x1+Math['pow'](0xa,(_0x595118-_0x171a23)/0x190)),_0x1dcf52=0x1/(0x1+Math['pow'](0xa,(_0x171a23-_0x595118)/0x190)),_0x17a281=_0x171a23+_0x187f54*(0x1-_0x268766),_0xefbb4c=_0x595118+_0x187f54*(0x0-_0x1dcf52);return{'newWinnerRating':Math['round'](_0x17a281),'newLoserRating':Math['round'](_0xefbb4c)};}export async function updateEloRatingsD2(_0x4b32a1,_0x44df84,_0x5ca5b8){const _0x509a90=a26_0x433c;try{const _0x11bfa0=writeBatch(db),_0x31e21a=doc(db,'playersD2',_0x4b32a1),_0x190014=doc(db,'playersD2',_0x44df84),[_0x511c1a,_0x5b0604]=await Promise[_0x509a90(0x197)]([getDoc(_0x31e21a),getDoc(_0x190014)]);if(!_0x511c1a[_0x509a90(0x190)]()||!_0x5b0604['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x2b7c5d=_0x511c1a['data'](),_0x273e9c=_0x5b0604[_0x509a90(0x192)](),_0x2f0d0e=_0x2b7c5d['position']||Number[_0x509a90(0x19f)],_0x574bae=_0x273e9c[_0x509a90(0x199)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x5837a4,newLoserRating:_0x217133}=calculateEloD2(_0x2b7c5d['eloRating']||0x4b0,_0x273e9c[_0x509a90(0x191)]||0x4b0);let _0x539e1b=_0x2f0d0e,_0x124be5=_0x574bae;if(_0x2f0d0e>_0x574bae){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x539e1b=_0x574bae,_0x124be5=_0x574bae+0x1;const _0x1d42f2=query(collection(db,_0x509a90(0x194)),where('position','>',_0x574bae),where('position','<',_0x2f0d0e)),_0x110a74=await getDocs(_0x1d42f2);for(const _0x22bdbd of _0x110a74[_0x509a90(0x1a1)]){_0x22bdbd['id']!==_0x4b32a1&&_0x22bdbd['id']!==_0x44df84&&_0x11bfa0['update'](doc(db,'playersD2',_0x22bdbd['id']),{'position':_0x22bdbd['data']()[_0x509a90(0x199)]+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x11bfa0[_0x509a90(0x19e)](_0x31e21a,{'eloRating':_0x5837a4,'lastMatchDate':serverTimestamp(),'position':_0x539e1b,'lastMatchId':_0x5ca5b8}),_0x11bfa0[_0x509a90(0x19e)](_0x190014,{'eloRating':_0x217133,'lastMatchDate':serverTimestamp(),'position':_0x124be5,'lastMatchId':_0x5ca5b8}),await _0x11bfa0['commit'](),console[_0x509a90(0x198)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x4b32a1,'previousElo':_0x2b7c5d['eloRating']||0x4b0,'newElo':_0x5837a4,'opponentId':_0x44df84,'matchResult':_0x509a90(0x19c),'previousPosition':_0x2f0d0e,'newPosition':_0x539e1b,'isPromotion':_0x539e1b<_0x2f0d0e,'matchId':_0x5ca5b8,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x44df84,'previousElo':_0x273e9c['eloRating']||0x4b0,'newElo':_0x217133,'opponentId':_0x4b32a1,'matchResult':'loss','previousPosition':_0x574bae,'newPosition':_0x124be5,'isDemotion':_0x124be5>_0x574bae,'matchId':_0x5ca5b8,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x4b32a1,_0x5837a4,_0x2b7c5d[_0x509a90(0x191)],{'source':_0x509a90(0x193),'matchId':_0x5ca5b8}),await promotionManager[_0x509a90(0x19a)](_0x44df84,_0x217133,_0x273e9c['eloRating'],{'source':_0x509a90(0x193),'matchId':_0x5ca5b8}),!![];}catch(_0x41353c){console['error'](_0x509a90(0x196),_0x41353c);throw _0x41353c;}}export async function approveReportD2(_0x57ddfc,_0x425410,_0x44c818,_0x21215f){const _0x2a2dce=a26_0x433c;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x57ddfc,'winnerScore':_0x425410,'winnerSuicides':_0x44c818,'winnerComment':_0x21215f});const _0x1f3224=auth['currentUser'];if(!_0x1f3224){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x1f3224['email']);const _0x5872da=await getDoc(doc(db,'playersD2',_0x1f3224['uid'])),_0x8ec6d2=_0x5872da[_0x2a2dce(0x190)]()?_0x5872da['data']()['username']:null;console[_0x2a2dce(0x198)]('Current\x20username:',_0x8ec6d2);const _0x3f7fa7=doc(db,'pendingMatchesD2',_0x57ddfc),_0x3b84f5=await getDoc(_0x3f7fa7);if(!_0x3b84f5['exists']()){console[_0x2a2dce(0x198)]('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x57ddfc);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x283a17=_0x3b84f5['data']();console['log']('D2\x20Report\x20data:',_0x283a17);if(_0x8ec6d2!==_0x283a17['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0xe12c0={..._0x283a17,'winnerScore':_0x425410,'winnerSuicides':_0x44c818,'winnerComment':_0x21215f,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x8ec6d2,'createdAt':_0x283a17['createdAt']||serverTimestamp(),'winnerUsername':_0x283a17['winnerUsername'],'loserUsername':_0x283a17['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x57ddfc),_0xe12c0),await deleteDoc(_0x3f7fa7),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x2195b9,_0x385404]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x283a17['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x283a17['loserUsername'])))]);if(_0x2195b9['empty']||_0x385404['empty'])throw new Error(_0x2a2dce(0x195));const _0x1b892c=_0x2195b9['docs'][0x0]['id'],_0x5c710b=_0x385404[_0x2a2dce(0x1a1)][0x0]['id'];return await updateEloRatingsD2(_0x1b892c,_0x5c710b,_0x57ddfc),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x470767){console['error']('Error\x20in\x20approveReportD2:',_0x470767);throw _0x470767;}}function a26_0x5ae7(){const _0x19abe5=['exists','eloRating','data','match-d2','playersD2','Could\x20not\x20find\x20D2\x20player\x20documents','Error\x20in\x20updateEloRatingsD2:','all','log','position','checkAndRecordPromotion','apply','win','bind','update','MAX_SAFE_INTEGER','constructor','docs'];a26_0x5ae7=function(){return _0x19abe5;};return a26_0x5ae7();}