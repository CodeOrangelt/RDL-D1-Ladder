const a28_0x702b33=(function(){let _0x15119b=!![];return function(_0x55756d,_0x1e850e){const _0x21b1bf=_0x15119b?function(){const _0x4cf7d4=a28_0x48fa;if(_0x1e850e){const _0x56142a=_0x1e850e[_0x4cf7d4(0xd3)](_0x55756d,arguments);return _0x1e850e=null,_0x56142a;}}:function(){};return _0x15119b=![],_0x21b1bf;};}()),a28_0x1ae6f7=a28_0x702b33(this,function(){const _0x10b1ec=a28_0x48fa,_0x318c99=function(){const _0x42d018=a28_0x48fa;let _0x4ed3fc;try{_0x4ed3fc=Function(_0x42d018(0xe4)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x3167c2){_0x4ed3fc=window;}return _0x4ed3fc;},_0x148dbb=_0x318c99(),_0x305d9d=_0x148dbb['console']=_0x148dbb['console']||{},_0x394c03=['log','warn','info','error','exception','table','trace'];for(let _0x3dddad=0x0;_0x3dddad<_0x394c03['length'];_0x3dddad++){const _0x33dc23=a28_0x702b33['constructor']['prototype']['bind'](a28_0x702b33),_0x54e28d=_0x394c03[_0x3dddad],_0x2ce169=_0x305d9d[_0x54e28d]||_0x33dc23;_0x33dc23['__proto__']=a28_0x702b33[_0x10b1ec(0xe1)](a28_0x702b33),_0x33dc23[_0x10b1ec(0xe5)]=_0x2ce169[_0x10b1ec(0xe5)][_0x10b1ec(0xe1)](_0x2ce169),_0x305d9d[_0x54e28d]=_0x33dc23;}});a28_0x1ae6f7();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x1425a3,_0x5da023,_0x1144d8=0x20){const _0x3f5b9c=0x1/(0x1+Math['pow'](0xa,(_0x5da023-_0x1425a3)/0x190)),_0x24015f=0x1/(0x1+Math['pow'](0xa,(_0x1425a3-_0x5da023)/0x190)),_0x325ebb=_0x1425a3+_0x1144d8*(0x1-_0x3f5b9c),_0x115062=_0x5da023+_0x1144d8*(0x0-_0x24015f);return{'newWinnerRating':Math['round'](_0x325ebb),'newLoserRating':Math['round'](_0x115062)};}function a28_0x48fa(_0x42975f,_0x85f0d2){const _0x1ae6f7=a28_0x3876();return a28_0x48fa=function(_0x702b33,_0x557a2d){_0x702b33=_0x702b33-0xc5;let _0x3876b5=_0x1ae6f7[_0x702b33];return _0x3876b5;},a28_0x48fa(_0x42975f,_0x85f0d2);}export function assignDefaultEloRating(_0x476c47,_0x2ddeb9){const _0x2c03be=a28_0x48fa,_0x3e66c8=0x4b0;!_0x2ddeb9['eloRating']&&db[_0x2c03be(0xce)](_0x2c03be(0xd7))['doc'](_0x476c47)['update']({'eloRating':_0x3e66c8})[_0x2c03be(0xe8)](()=>{const _0x35ed53=_0x2c03be;console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x2ddeb9[_0x35ed53(0xc8)]);})['catch'](_0x5d122a=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x5d122a);});}export async function updateEloRatings(_0x6424ce,_0x42d8f5,_0x4ad426){const _0x1cee42=a28_0x48fa;try{const _0xe25737=writeBatch(db),_0x45f4bb=doc(db,_0x1cee42(0xd7),_0x6424ce),_0x38fc3b=doc(db,_0x1cee42(0xd7),_0x42d8f5),[_0x1b01e0,_0x3382c0]=await Promise['all']([getDoc(_0x45f4bb),getDoc(_0x38fc3b)]);if(!_0x1b01e0[_0x1cee42(0xe9)]()||!_0x3382c0['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x4948b4=_0x1b01e0['data'](),_0x4b7044=_0x3382c0['data'](),_0x4d41a4=_0x4948b4[_0x1cee42(0xd1)]||Number['MAX_SAFE_INTEGER'],_0x1ce49e=_0x4b7044['position']||Number[_0x1cee42(0xde)],{newWinnerRating:_0x2df6df,newLoserRating:_0x299d98}=calculateElo(_0x4948b4['eloRating']||0x4b0,_0x4b7044['eloRating']||0x4b0);let _0x16ab25=_0x4d41a4,_0x83ff0d=_0x1ce49e;if(_0x4d41a4>_0x1ce49e){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x16ab25=_0x1ce49e,_0x83ff0d=_0x1ce49e+0x1;const _0x3c8014=query(collection(db,'players'),where(_0x1cee42(0xd1),'>',_0x1ce49e),where('position','<',_0x4d41a4)),_0x4fa199=await getDocs(_0x3c8014);for(const _0x2b467c of _0x4fa199['docs']){_0x2b467c['id']!==_0x6424ce&&_0x2b467c['id']!==_0x42d8f5&&_0xe25737[_0x1cee42(0xd2)](doc(db,'players',_0x2b467c['id']),{'position':_0x2b467c['data']()['position']+0x1});}}else console[_0x1cee42(0xdd)]('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0xf4f96c={'eloRating':_0x2df6df,'lastMatchDate':serverTimestamp(),'position':_0x16ab25,'lastMatchId':_0x4ad426},_0x362288={'eloRating':_0x299d98,'lastMatchDate':serverTimestamp(),'position':_0x83ff0d,'lastMatchId':_0x4ad426};return _0xe25737[_0x1cee42(0xd2)](_0x45f4bb,_0xf4f96c),_0xe25737['update'](_0x38fc3b,_0x362288),await _0xe25737['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x6424ce,'previousElo':_0x4948b4[_0x1cee42(0xc5)]||0x4b0,'newElo':_0x2df6df,'opponentId':_0x42d8f5,'matchResult':'win','previousPosition':_0x4d41a4,'newPosition':_0x16ab25,'isPromotion':_0x16ab25<_0x4d41a4,'matchId':_0x4ad426,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x42d8f5,'previousElo':_0x4b7044['eloRating']||0x4b0,'newElo':_0x299d98,'opponentId':_0x6424ce,'matchResult':'loss','previousPosition':_0x1ce49e,'newPosition':_0x83ff0d,'isDemotion':_0x83ff0d>_0x1ce49e,'matchId':_0x4ad426,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x6424ce,_0x2df6df,_0x4948b4[_0x1cee42(0xc5)],{'source':'match','matchId':_0x4ad426}),await promotionManager[_0x1cee42(0xc6)](_0x42d8f5,_0x299d98,_0x4b7044[_0x1cee42(0xc5)],{'source':'match','matchId':_0x4ad426}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x3116c9){console['error'](_0x1cee42(0xdb),_0x3116c9);throw _0x3116c9;}}function a28_0x3876(){const _0x3e58bf=['eloRating','checkAndRecordPromotion','subgameType','username','losses','Match\x20points:\x20','data','Error\x20approving\x20report:','Unknown\x20User','collection','winnerScore','warn','position','update','apply','Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found','loserScore','winRate','players','playerStats','totalDeaths','points','Error\x20in\x20updateEloRatings:','system-match-award','log','MAX_SAFE_INTEGER','docs','userProfiles','bind','toFixed','Awarded\x20','return\x20(function()\x20','toString','lastUpdated','pointsHistory','then','exists','pendingMatches','loserUsername','all'];a28_0x3876=function(){return _0x3e58bf;};return a28_0x3876();}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x1d9d0d,_0x22b739,_0xc2dfc7,_0x1864a4,_0x39a4e2){const _0x4fd6ab=a28_0x48fa;try{const _0x61016f=doc(db,_0x4fd6ab(0xea),_0x1d9d0d),_0x21e9ff=await getDoc(_0x61016f);if(!_0x21e9ff['exists']())throw new Error('Report\x20not\x20found');const _0x168099=_0x21e9ff['data'](),_0x3d183a={..._0x168099,'winnerScore':_0x22b739,'winnerSuicides':_0xc2dfc7,'winnerComment':_0x1864a4,'winnerDemoLink':_0x39a4e2,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x1d9d0d),_0x3d183a),await deleteDoc(_0x61016f),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x1e65c5,_0x11821b]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x168099['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x168099[_0x4fd6ab(0xeb)])))]);if(_0x1e65c5['empty']||_0x11821b['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x39be87=_0x1e65c5[_0x4fd6ab(0xdf)][0x0]['id'],_0x3201ec=_0x11821b['docs'][0x0]['id'];await updateEloRatings(_0x39be87,_0x3201ec,_0x1d9d0d);try{const _0x1625f1=_0x168099[_0x4fd6ab(0xc7)]||'Standard',_0x2631a4=POINTS_CHART[_0x1625f1]||0xa,_0x24d037=doc(db,_0x4fd6ab(0xe0),_0x39be87),_0x30f40c=doc(db,'userProfiles',_0x3201ec),[_0x75d633,_0x44d8dd]=await Promise[_0x4fd6ab(0xec)]([getDoc(_0x24d037),getDoc(_0x30f40c)]);if(_0x75d633['exists']()&&_0x44d8dd['exists']()){const _0x32e45a=_0x75d633['data'](),_0x25b2f1=_0x44d8dd['data'](),_0x94b7fc=_0x32e45a['points']||0x0,_0x27082e=_0x25b2f1[_0x4fd6ab(0xda)]||0x0,_0x52de0b=_0x94b7fc+_0x2631a4,_0xe3078d=_0x27082e+_0x2631a4;await Promise['all']([updateDoc(_0x24d037,{'points':_0x52de0b,'lastPointsModified':serverTimestamp()}),updateDoc(_0x30f40c,{'points':_0xe3078d,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,_0x4fd6ab(0xe7)),{'userId':_0x39be87,'userEmail':_0x32e45a['email']||'unknown','displayName':_0x32e45a['displayName']||_0x32e45a[_0x4fd6ab(0xc8)]||_0x4fd6ab(0xcd),'action':'add','amount':_0x2631a4,'previousPoints':_0x94b7fc,'newPoints':_0x52de0b,'reason':'Match\x20points:\x20'+_0x1625f1+'\x20match\x20(Winner)','adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x3201ec,'userEmail':_0x25b2f1['email']||'unknown','displayName':_0x25b2f1['displayName']||_0x25b2f1['username']||_0x4fd6ab(0xcd),'action':'add','amount':_0x2631a4,'previousPoints':_0x27082e,'newPoints':_0xe3078d,'reason':_0x4fd6ab(0xca)+_0x1625f1+'\x20match\x20(Participant)','adminEmail':_0x4fd6ab(0xdc),'timestamp':serverTimestamp()})]),console['log'](_0x4fd6ab(0xe3)+_0x2631a4+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x1625f1+'\x20match');}else console[_0x4fd6ab(0xd0)](_0x4fd6ab(0xd4));}catch(_0x5a9b1f){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x5a9b1f);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x2f3c19){console['error'](_0x4fd6ab(0xcc),_0x2f3c19);throw _0x2f3c19;}}async function updatePlayerElo(_0xe673b4,_0x5bbca1,_0x124af2){await setDoc(doc(db,'players',_0xe673b4),{...playerData,'eloRating':_0x124af2}),await checkAndRecordPromotion(_0xe673b4,_0x124af2,_0x5bbca1);}async function updatePlayerStats(_0x585994,_0x4a2028,_0x427202){const _0x42538b=a28_0x48fa,_0x4d4b28=doc(db,_0x42538b(0xd8),_0x585994),_0x41177e=await getDoc(_0x4d4b28);let _0x29f388=_0x41177e['exists']()?_0x41177e[_0x42538b(0xcb)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x427202?(_0x29f388['wins']++,_0x29f388['totalKills']+=parseInt(_0x4a2028[_0x42538b(0xcf)]||0x0),_0x29f388['totalDeaths']+=parseInt(_0x4a2028[_0x42538b(0xd5)]||0x0)):(_0x29f388['losses']++,_0x29f388['totalKills']+=parseInt(_0x4a2028[_0x42538b(0xd5)]||0x0),_0x29f388[_0x42538b(0xd9)]+=parseInt(_0x4a2028[_0x42538b(0xcf)]||0x0));const _0xd1df47=_0x29f388['wins']+_0x29f388[_0x42538b(0xc9)];_0x29f388[_0x42538b(0xd6)]=_0xd1df47>0x0?(_0x29f388['wins']/_0xd1df47*0x64)[_0x42538b(0xe2)](0x1):0x0,_0x29f388[_0x42538b(0xe6)]=new Date()['toISOString'](),await setDoc(_0x4d4b28,_0x29f388,{'merge':!![]});}