const a29_0x496476=(function(){let _0x2f9b04=!![];return function(_0x22cabc,_0x5d1f1b){const _0x95b978=_0x2f9b04?function(){if(_0x5d1f1b){const _0x208556=_0x5d1f1b['apply'](_0x22cabc,arguments);return _0x5d1f1b=null,_0x208556;}}:function(){};return _0x2f9b04=![],_0x95b978;};}()),a29_0x1f4e73=a29_0x496476(this,function(){const _0x4b8acb=a29_0x417a,_0x53881f=function(){let _0x29869c;try{_0x29869c=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0xd60f8d){_0x29869c=window;}return _0x29869c;},_0x53a5b5=_0x53881f(),_0x380126=_0x53a5b5[_0x4b8acb(0x12b)]=_0x53a5b5['console']||{},_0x224adb=['log','warn','info','error','exception','table',_0x4b8acb(0x131)];for(let _0x48bb92=0x0;_0x48bb92<_0x224adb[_0x4b8acb(0x122)];_0x48bb92++){const _0x5e5dda=a29_0x496476['constructor'][_0x4b8acb(0x127)][_0x4b8acb(0x11c)](a29_0x496476),_0x46d15a=_0x224adb[_0x48bb92],_0x3e6552=_0x380126[_0x46d15a]||_0x5e5dda;_0x5e5dda['__proto__']=a29_0x496476['bind'](a29_0x496476),_0x5e5dda['toString']=_0x3e6552['toString'][_0x4b8acb(0x11c)](_0x3e6552),_0x380126[_0x46d15a]=_0x5e5dda;}});a29_0x1f4e73();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a29_0x417a(_0x56182f,_0x53f41e){const _0x1f4e73=a29_0x48aa();return a29_0x417a=function(_0x496476,_0x432447){_0x496476=_0x496476-0x11b;let _0x48aac2=_0x1f4e73[_0x496476];return _0x48aac2;},a29_0x417a(_0x56182f,_0x53f41e);}function a29_0x48aa(){const _0x47f343=['win','bind','position','username','all','log','update','length','pendingMatchesD3','No\x20user\x20logged\x20in','data','currentUser','prototype','D3\x20ELO\x20ratings\x20updated\x20successfully','playersD3','Starting\x20approveReportD3\x20function\x20with:','console','docs','loserUsername','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','exists','D3\x20Report\x20data:','trace'];a29_0x48aa=function(){return _0x47f343;};return a29_0x48aa();}import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x5f3b4d,_0x4292da,_0x4bd1d1=0x20){const _0x95aff3=0x1/(0x1+Math['pow'](0xa,(_0x4292da-_0x5f3b4d)/0x190)),_0x517e4c=0x1/(0x1+Math['pow'](0xa,(_0x5f3b4d-_0x4292da)/0x190)),_0x29eeb6=_0x5f3b4d+_0x4bd1d1*(0x1-_0x95aff3),_0x1a2877=_0x4292da+_0x4bd1d1*(0x0-_0x517e4c);return{'newWinnerRating':Math['round'](_0x29eeb6),'newLoserRating':Math['round'](_0x1a2877)};}export async function updateEloRatingsD3(_0x1f0f7a,_0x40606b,_0x248865){const _0x1afd9b=a29_0x417a;try{const _0x232e57=writeBatch(db),_0x348955=doc(db,_0x1afd9b(0x129),_0x1f0f7a),_0x4172e7=doc(db,_0x1afd9b(0x129),_0x40606b),[_0x18550f,_0x2f7376]=await Promise['all']([getDoc(_0x348955),getDoc(_0x4172e7)]);if(!_0x18550f['exists']()||!_0x2f7376['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x52f272=_0x18550f['data'](),_0x25fd6c=_0x2f7376['data'](),_0x53a140=_0x52f272['position']||Number['MAX_SAFE_INTEGER'],_0x310e88=_0x25fd6c[_0x1afd9b(0x11d)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x362ceb,newLoserRating:_0x1bea3c}=calculateEloD3(_0x52f272['eloRating']||0x4b0,_0x25fd6c['eloRating']||0x4b0);let _0x37ceef=_0x53a140,_0x3cdd12=_0x310e88;if(_0x53a140>_0x310e88){console['log'](_0x1afd9b(0x12e)),_0x37ceef=_0x310e88,_0x3cdd12=_0x310e88+0x1;const _0x1c434a=query(collection(db,'playersD3'),where(_0x1afd9b(0x11d),'>',_0x310e88),where('position','<',_0x53a140)),_0x4a9e03=await getDocs(_0x1c434a);for(const _0x58bdd0 of _0x4a9e03[_0x1afd9b(0x12c)]){_0x58bdd0['id']!==_0x1f0f7a&&_0x58bdd0['id']!==_0x40606b&&_0x232e57['update'](doc(db,'playersD3',_0x58bdd0['id']),{'position':_0x58bdd0[_0x1afd9b(0x125)]()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x232e57[_0x1afd9b(0x121)](_0x348955,{'eloRating':_0x362ceb,'lastMatchDate':serverTimestamp(),'position':_0x37ceef,'lastMatchId':_0x248865}),_0x232e57['update'](_0x4172e7,{'eloRating':_0x1bea3c,'lastMatchDate':serverTimestamp(),'position':_0x3cdd12,'lastMatchId':_0x248865}),await _0x232e57['commit'](),console['log'](_0x1afd9b(0x128)),await Promise[_0x1afd9b(0x11f)]([recordEloChangeD3({'playerId':_0x1f0f7a,'previousElo':_0x52f272['eloRating']||0x4b0,'newElo':_0x362ceb,'opponentId':_0x40606b,'matchResult':_0x1afd9b(0x11b),'previousPosition':_0x53a140,'newPosition':_0x37ceef,'isPromotion':_0x37ceef<_0x53a140,'matchId':_0x248865,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x40606b,'previousElo':_0x25fd6c['eloRating']||0x4b0,'newElo':_0x1bea3c,'opponentId':_0x1f0f7a,'matchResult':'loss','previousPosition':_0x310e88,'newPosition':_0x3cdd12,'isDemotion':_0x3cdd12>_0x310e88,'matchId':_0x248865,'timestamp':serverTimestamp()})]),!![];}catch(_0x30a1c9){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x30a1c9);throw _0x30a1c9;}}export async function approveReportD3(_0x333786,_0x4ce758,_0x2db4f3,_0x2aa0ce){const _0x2d387b=a29_0x417a;try{console[_0x2d387b(0x120)](_0x2d387b(0x12a),{'reportId':_0x333786,'winnerScore':_0x4ce758,'winnerSuicides':_0x2db4f3,'winnerComment':_0x2aa0ce});const _0x455913=auth[_0x2d387b(0x126)];if(!_0x455913){console['log'](_0x2d387b(0x124));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console[_0x2d387b(0x120)]('Current\x20user:',_0x455913['email']);const _0x523750=await getDoc(doc(db,'playersD3',_0x455913['uid'])),_0x11b55a=_0x523750['exists']()?_0x523750[_0x2d387b(0x125)]()['username']:null;console['log']('Current\x20username:',_0x11b55a);const _0x15a664=doc(db,_0x2d387b(0x123),_0x333786),_0x3e29a7=await getDoc(_0x15a664);if(!_0x3e29a7[_0x2d387b(0x12f)]()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x333786);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x5d5511=_0x3e29a7['data']();console['log'](_0x2d387b(0x130),_0x5d5511);if(_0x11b55a!==_0x5d5511['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0xdce82d={..._0x5d5511,'winnerScore':_0x4ce758,'winnerSuicides':_0x2db4f3,'winnerComment':_0x2aa0ce,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x11b55a,'createdAt':_0x5d5511['createdAt']||serverTimestamp(),'winnerUsername':_0x5d5511['winnerUsername'],'loserUsername':_0x5d5511['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x333786),_0xdce82d),await deleteDoc(_0x15a664),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x370244,_0x2af823]=await Promise[_0x2d387b(0x11f)]([getDocs(query(collection(db,_0x2d387b(0x129)),where(_0x2d387b(0x11e),'==',_0x5d5511['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x2d387b(0x11e),'==',_0x5d5511[_0x2d387b(0x12d)])))]);if(_0x370244['empty']||_0x2af823['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x4ceda0=_0x370244['docs'][0x0]['id'],_0x17ea0b=_0x2af823[_0x2d387b(0x12c)][0x0]['id'];return await updateEloRatingsD3(_0x4ceda0,_0x17ea0b,_0x333786),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x6d4a10){console['error']('Error\x20in\x20approveReportD3:',_0x6d4a10);throw _0x6d4a10;}}