const a28_0x29f9d5=(function(){let _0x3d9919=!![];return function(_0x1961a2,_0x3bde41){const _0x36bc56=_0x3d9919?function(){if(_0x3bde41){const _0x5c029b=_0x3bde41['apply'](_0x1961a2,arguments);return _0x3bde41=null,_0x5c029b;}}:function(){};return _0x3d9919=![],_0x36bc56;};}()),a28_0x47c742=a28_0x29f9d5(this,function(){const _0x578c89=a28_0x1df9,_0x2b297b=function(){const _0x6c2112=a28_0x1df9;let _0x5aa5b2;try{_0x5aa5b2=Function(_0x6c2112(0x1a9)+_0x6c2112(0x1aa)+');')();}catch(_0x38524d){_0x5aa5b2=window;}return _0x5aa5b2;},_0x1e3cfb=_0x2b297b(),_0x5a9180=_0x1e3cfb[_0x578c89(0x1ab)]=_0x1e3cfb['console']||{},_0x5875d0=['log',_0x578c89(0x1b6),'info',_0x578c89(0x1b7),'exception','table','trace'];for(let _0xb82574=0x0;_0xb82574<_0x5875d0['length'];_0xb82574++){const _0x56b8b9=a28_0x29f9d5['constructor'][_0x578c89(0x1b0)][_0x578c89(0x1ba)](a28_0x29f9d5),_0xdfd0c=_0x5875d0[_0xb82574],_0x5fc76=_0x5a9180[_0xdfd0c]||_0x56b8b9;_0x56b8b9['__proto__']=a28_0x29f9d5['bind'](a28_0x29f9d5),_0x56b8b9['toString']=_0x5fc76['toString']['bind'](_0x5fc76),_0x5a9180[_0xdfd0c]=_0x56b8b9;}});a28_0x47c742();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x1df9(_0x91f4b9,_0x3dc337){const _0x47c742=a28_0x2cee();return a28_0x1df9=function(_0x29f9d5,_0x5edbae){_0x29f9d5=_0x29f9d5-0x1a8;let _0x2cee34=_0x47c742[_0x29f9d5];return _0x2cee34;},a28_0x1df9(_0x91f4b9,_0x3dc337);}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';function a28_0x2cee(){const _0x55b4ae=['doc','return\x20(function()\x20','{}.constructor(\x22return\x20this\x22)(\x20)','console','userProfiles','wins','Match\x20points:\x20','system-match-award','prototype','Unknown\x20User','winRate','loserScore','update','position','warn','error','round','totalKills','bind','Error\x20in\x20updateEloRatings:','empty','\x20match\x20(Participant)','all','Report\x20not\x20found','approvedMatches','loserUsername','docs','log','pendingMatches','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','\x20match','username','totalDeaths','Could\x20not\x20find\x20player\x20documents','losses','checkAndRecordPromotion','exists','match','data','toISOString','Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found','email','toFixed','eloRating'];a28_0x2cee=function(){return _0x55b4ae;};return a28_0x2cee();}export function calculateElo(_0x2ae8bd,_0x2f28d3,_0x555450=0x20){const _0x319e43=a28_0x1df9,_0x436a77=0x1/(0x1+Math['pow'](0xa,(_0x2f28d3-_0x2ae8bd)/0x190)),_0x31e260=0x1/(0x1+Math['pow'](0xa,(_0x2ae8bd-_0x2f28d3)/0x190)),_0x1ae8b1=_0x2ae8bd+_0x555450*(0x1-_0x436a77),_0x1ed416=_0x2f28d3+_0x555450*(0x0-_0x31e260);return{'newWinnerRating':Math[_0x319e43(0x1b8)](_0x1ae8b1),'newLoserRating':Math[_0x319e43(0x1b8)](_0x1ed416)};}export function assignDefaultEloRating(_0x37b93e,_0x2e16c0){const _0x40b4bf=a28_0x1df9,_0x27c399=0x4b0;!_0x2e16c0[_0x40b4bf(0x1d3)]&&db['collection']('players')[_0x40b4bf(0x1a8)](_0x37b93e)['update']({'eloRating':_0x27c399})['then'](()=>{const _0xaafae2=_0x40b4bf;console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x2e16c0[_0xaafae2(0x1c7)]);})['catch'](_0x18b5ac=>{const _0x5c1c10=_0x40b4bf;console[_0x5c1c10(0x1b7)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x18b5ac);});}export async function updateEloRatings(_0x289cc6,_0x5ab7c4,_0x40ad62){const _0x3a129e=a28_0x1df9;try{const _0x2a5cab=writeBatch(db),_0x5444f7=doc(db,'players',_0x289cc6),_0x49a5de=doc(db,'players',_0x5ab7c4),[_0x56574e,_0x2dce59]=await Promise[_0x3a129e(0x1be)]([getDoc(_0x5444f7),getDoc(_0x49a5de)]);if(!_0x56574e[_0x3a129e(0x1cc)]()||!_0x2dce59[_0x3a129e(0x1cc)]())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x5abe09=_0x56574e['data'](),_0x71043=_0x2dce59['data'](),_0x5e6722=_0x5abe09['position']||Number['MAX_SAFE_INTEGER'],_0x31a787=_0x71043['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x56e217,newLoserRating:_0x4f089a}=calculateElo(_0x5abe09[_0x3a129e(0x1d3)]||0x4b0,_0x71043['eloRating']||0x4b0);let _0x50fb12=_0x5e6722,_0x11a212=_0x31a787;if(_0x5e6722>_0x31a787){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x50fb12=_0x31a787,_0x11a212=_0x31a787+0x1;const _0x5383dd=query(collection(db,'players'),where(_0x3a129e(0x1b5),'>',_0x31a787),where('position','<',_0x5e6722)),_0x394bf4=await getDocs(_0x5383dd);for(const _0x2d110e of _0x394bf4['docs']){_0x2d110e['id']!==_0x289cc6&&_0x2d110e['id']!==_0x5ab7c4&&_0x2a5cab[_0x3a129e(0x1b4)](doc(db,'players',_0x2d110e['id']),{'position':_0x2d110e[_0x3a129e(0x1ce)]()[_0x3a129e(0x1b5)]+0x1});}}else console['log'](_0x3a129e(0x1c5));const _0x27a4fa={'eloRating':_0x56e217,'lastMatchDate':serverTimestamp(),'position':_0x50fb12,'lastMatchId':_0x40ad62},_0x2748fd={'eloRating':_0x4f089a,'lastMatchDate':serverTimestamp(),'position':_0x11a212,'lastMatchId':_0x40ad62};return _0x2a5cab[_0x3a129e(0x1b4)](_0x5444f7,_0x27a4fa),_0x2a5cab[_0x3a129e(0x1b4)](_0x49a5de,_0x2748fd),await _0x2a5cab['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x289cc6,'previousElo':_0x5abe09['eloRating']||0x4b0,'newElo':_0x56e217,'opponentId':_0x5ab7c4,'matchResult':'win','previousPosition':_0x5e6722,'newPosition':_0x50fb12,'isPromotion':_0x50fb12<_0x5e6722,'matchId':_0x40ad62,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x5ab7c4,'previousElo':_0x71043['eloRating']||0x4b0,'newElo':_0x4f089a,'opponentId':_0x289cc6,'matchResult':'loss','previousPosition':_0x31a787,'newPosition':_0x11a212,'isDemotion':_0x11a212>_0x31a787,'matchId':_0x40ad62,'timestamp':serverTimestamp()})]),await promotionManager[_0x3a129e(0x1cb)](_0x289cc6,_0x56e217,_0x5abe09['eloRating'],{'source':_0x3a129e(0x1cd),'matchId':_0x40ad62}),await promotionManager['checkAndRecordPromotion'](_0x5ab7c4,_0x4f089a,_0x71043[_0x3a129e(0x1d3)],{'source':'match','matchId':_0x40ad62}),console[_0x3a129e(0x1c3)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x1012ad){console['error'](_0x3a129e(0x1bb),_0x1012ad);throw _0x1012ad;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x317bc8,_0x140f76,_0x413e10,_0x2f3530,_0x4eb3e5){const _0xb9f527=a28_0x1df9;try{const _0x5e12d7=doc(db,_0xb9f527(0x1c4),_0x317bc8),_0xbe9941=await getDoc(_0x5e12d7);if(!_0xbe9941['exists']())throw new Error(_0xb9f527(0x1bf));const _0xcd8aca=_0xbe9941[_0xb9f527(0x1ce)](),_0x344034={..._0xcd8aca,'winnerScore':_0x140f76,'winnerSuicides':_0x413e10,'winnerComment':_0x2f3530,'winnerDemoLink':_0x4eb3e5,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,_0xb9f527(0x1c0),_0x317bc8),_0x344034),await deleteDoc(_0x5e12d7),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x3c7373,_0x2d33dd]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0xcd8aca['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0xcd8aca[_0xb9f527(0x1c1)])))]);if(_0x3c7373['empty']||_0x2d33dd[_0xb9f527(0x1bc)])throw new Error(_0xb9f527(0x1c9));const _0x56ff17=_0x3c7373['docs'][0x0]['id'],_0x26e9ec=_0x2d33dd[_0xb9f527(0x1c2)][0x0]['id'];await updateEloRatings(_0x56ff17,_0x26e9ec,_0x317bc8);try{const _0xf6a99c=_0xcd8aca['subgameType']||'Standard',_0xa70143=POINTS_CHART[_0xf6a99c]||0xa,_0x30751e=doc(db,'userProfiles',_0x56ff17),_0x48c46c=doc(db,_0xb9f527(0x1ac),_0x26e9ec),[_0x55c784,_0x26b807]=await Promise['all']([getDoc(_0x30751e),getDoc(_0x48c46c)]);if(_0x55c784['exists']()&&_0x26b807['exists']()){const _0x40d4e4=_0x55c784['data'](),_0x12624d=_0x26b807[_0xb9f527(0x1ce)](),_0x2bf23e=_0x40d4e4['points']||0x0,_0x34a91e=_0x12624d['points']||0x0,_0x3adcaa=_0x2bf23e+_0xa70143,_0x90c800=_0x34a91e+_0xa70143;await Promise['all']([updateDoc(_0x30751e,{'points':_0x3adcaa,'lastPointsModified':serverTimestamp()}),updateDoc(_0x48c46c,{'points':_0x90c800,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,'pointsHistory'),{'userId':_0x56ff17,'userEmail':_0x40d4e4['email']||'unknown','displayName':_0x40d4e4['displayName']||_0x40d4e4[_0xb9f527(0x1c7)]||_0xb9f527(0x1b1),'action':'add','amount':_0xa70143,'previousPoints':_0x2bf23e,'newPoints':_0x3adcaa,'reason':'Match\x20points:\x20'+_0xf6a99c+'\x20match\x20(Winner)','adminEmail':_0xb9f527(0x1af),'timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x26e9ec,'userEmail':_0x12624d[_0xb9f527(0x1d1)]||'unknown','displayName':_0x12624d['displayName']||_0x12624d['username']||'Unknown\x20User','action':'add','amount':_0xa70143,'previousPoints':_0x34a91e,'newPoints':_0x90c800,'reason':_0xb9f527(0x1ae)+_0xf6a99c+_0xb9f527(0x1bd),'adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console[_0xb9f527(0x1c3)]('Awarded\x20'+_0xa70143+'\x20points\x20to\x20both\x20players\x20for\x20'+_0xf6a99c+_0xb9f527(0x1c6));}else console[_0xb9f527(0x1b6)](_0xb9f527(0x1d0));}catch(_0x45229b){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x45229b);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3ca57c){console['error']('Error\x20approving\x20report:',_0x3ca57c);throw _0x3ca57c;}}async function updatePlayerElo(_0x4ac95f,_0x37b2a2,_0x3e013e){await setDoc(doc(db,'players',_0x4ac95f),{...playerData,'eloRating':_0x3e013e}),await checkAndRecordPromotion(_0x4ac95f,_0x3e013e,_0x37b2a2);}async function updatePlayerStats(_0x2e456d,_0x21d9c,_0x15eff4){const _0x1376b0=a28_0x1df9,_0x416a40=doc(db,'playerStats',_0x2e456d),_0x37e7ac=await getDoc(_0x416a40);let _0xff81b5=_0x37e7ac[_0x1376b0(0x1cc)]()?_0x37e7ac[_0x1376b0(0x1ce)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x15eff4?(_0xff81b5['wins']++,_0xff81b5['totalKills']+=parseInt(_0x21d9c['winnerScore']||0x0),_0xff81b5[_0x1376b0(0x1c8)]+=parseInt(_0x21d9c['loserScore']||0x0)):(_0xff81b5['losses']++,_0xff81b5[_0x1376b0(0x1b9)]+=parseInt(_0x21d9c[_0x1376b0(0x1b3)]||0x0),_0xff81b5[_0x1376b0(0x1c8)]+=parseInt(_0x21d9c['winnerScore']||0x0));const _0x18ed22=_0xff81b5['wins']+_0xff81b5[_0x1376b0(0x1ca)];_0xff81b5[_0x1376b0(0x1b2)]=_0x18ed22>0x0?(_0xff81b5[_0x1376b0(0x1ad)]/_0x18ed22*0x64)[_0x1376b0(0x1d2)](0x1):0x0,_0xff81b5['lastUpdated']=new Date()[_0x1376b0(0x1cf)](),await setDoc(_0x416a40,_0xff81b5,{'merge':!![]});}