const a28_0x547c14=(function(){let _0x2647ac=!![];return function(_0x3b81f6,_0x396e67){const _0x558ec5=_0x2647ac?function(){if(_0x396e67){const _0x4fab98=_0x396e67['apply'](_0x3b81f6,arguments);return _0x396e67=null,_0x4fab98;}}:function(){};return _0x2647ac=![],_0x558ec5;};}()),a28_0x1453f2=a28_0x547c14(this,function(){const _0x563f27=a28_0x4a62;let _0x3b37e6;try{const _0xf9faa1=Function(_0x563f27(0x7a)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x3b37e6=_0xf9faa1();}catch(_0x53f506){_0x3b37e6=window;}const _0x38659f=_0x3b37e6['console']=_0x3b37e6['console']||{},_0x3ef095=['log',_0x563f27(0x84),'info','error',_0x563f27(0x79),_0x563f27(0x82),_0x563f27(0x80)];for(let _0xf091ca=0x0;_0xf091ca<_0x3ef095['length'];_0xf091ca++){const _0x53e5db=a28_0x547c14[_0x563f27(0x7e)]['prototype']['bind'](a28_0x547c14),_0x5f5b4d=_0x3ef095[_0xf091ca],_0x56aba5=_0x38659f[_0x5f5b4d]||_0x53e5db;_0x53e5db['__proto__']=a28_0x547c14['bind'](a28_0x547c14),_0x53e5db['toString']=_0x56aba5['toString']['bind'](_0x56aba5),_0x38659f[_0x5f5b4d]=_0x53e5db;}});a28_0x1453f2();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a28_0x4055(){const _0x275f60=['pow','approvedMatchesD2','username','Error\x20in\x20updateEloRatingsD2:','log','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','data','error','docs','match-d2','email','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','round','playersD2','exception','return\x20(function()\x20','loss','update','winnerUsername','constructor','position','trace','all','table','Current\x20user:','warn','D2\x20Match\x20moved\x20to\x20approved\x20collection','No\x20user\x20logged\x20in','eloRating','exists','D2\x20Report\x20data:'];a28_0x4055=function(){return _0x275f60;};return a28_0x4055();}function a28_0x4a62(_0x6d0455,_0x5a3030){const _0x1453f2=a28_0x4055();return a28_0x4a62=function(_0x547c14,_0x29cc78){_0x547c14=_0x547c14-0x6b;let _0x4055a5=_0x1453f2[_0x547c14];return _0x4055a5;},a28_0x4a62(_0x6d0455,_0x5a3030);}import a28_0x3c189d from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x6c49ec,_0x503c2e,_0x16d927=0x20){const _0x499aac=a28_0x4a62,_0x48b8d0=0x1/(0x1+Math['pow'](0xa,(_0x503c2e-_0x6c49ec)/0x190)),_0x4e0b30=0x1/(0x1+Math[_0x499aac(0x6b)](0xa,(_0x6c49ec-_0x503c2e)/0x190)),_0x1f57ff=_0x6c49ec+_0x16d927*(0x1-_0x48b8d0),_0x51ae3e=_0x503c2e+_0x16d927*(0x0-_0x4e0b30);return{'newWinnerRating':Math['round'](_0x1f57ff),'newLoserRating':Math[_0x499aac(0x77)](_0x51ae3e)};}export async function updateEloRatingsD2(_0x1dd059,_0x3601ba,_0x1ae962){const _0x4bd6be=a28_0x4a62;try{const _0x30ce2d=writeBatch(db),_0x2b4cb3=doc(db,'playersD2',_0x1dd059),_0x45e77d=doc(db,'playersD2',_0x3601ba),[_0x18f93f,_0x282c07]=await Promise[_0x4bd6be(0x81)]([getDoc(_0x2b4cb3),getDoc(_0x45e77d)]);if(!_0x18f93f[_0x4bd6be(0x88)]()||!_0x282c07[_0x4bd6be(0x88)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x13cbec=_0x18f93f['data'](),_0x13b4de=_0x282c07['data'](),_0x2dbb57=_0x13cbec['position']||Number['MAX_SAFE_INTEGER'],_0x17dc33=_0x13b4de['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x163893,newLoserRating:_0x4318f1}=calculateEloD2(_0x13cbec['eloRating']||0x4b0,_0x13b4de['eloRating']||0x4b0);let _0x1006bc=_0x2dbb57,_0x435289=_0x17dc33;if(_0x2dbb57>_0x17dc33){console['log'](_0x4bd6be(0x76)),_0x1006bc=_0x17dc33,_0x435289=_0x17dc33+0x1;const _0x2292ac=query(collection(db,_0x4bd6be(0x78)),where('position','>',_0x17dc33),where('position','<',_0x2dbb57)),_0x40c2ab=await getDocs(_0x2292ac);for(const _0x320a14 of _0x40c2ab['docs']){_0x320a14['id']!==_0x1dd059&&_0x320a14['id']!==_0x3601ba&&_0x30ce2d['update'](doc(db,'playersD2',_0x320a14['id']),{'position':_0x320a14[_0x4bd6be(0x71)]()[_0x4bd6be(0x7f)]+0x1});}}else console[_0x4bd6be(0x6f)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x30ce2d['update'](_0x2b4cb3,{'eloRating':_0x163893,'lastMatchDate':serverTimestamp(),'position':_0x1006bc,'lastMatchId':_0x1ae962}),_0x30ce2d[_0x4bd6be(0x7c)](_0x45e77d,{'eloRating':_0x4318f1,'lastMatchDate':serverTimestamp(),'position':_0x435289,'lastMatchId':_0x1ae962}),await _0x30ce2d['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x1dd059,'previousElo':_0x13cbec['eloRating']||0x4b0,'newElo':_0x163893,'opponentId':_0x3601ba,'matchResult':'win','previousPosition':_0x2dbb57,'newPosition':_0x1006bc,'isPromotion':_0x1006bc<_0x2dbb57,'matchId':_0x1ae962,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x3601ba,'previousElo':_0x13b4de[_0x4bd6be(0x87)]||0x4b0,'newElo':_0x4318f1,'opponentId':_0x1dd059,'matchResult':_0x4bd6be(0x7b),'previousPosition':_0x17dc33,'newPosition':_0x435289,'isDemotion':_0x435289>_0x17dc33,'matchId':_0x1ae962,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x1dd059,_0x163893,_0x13cbec['eloRating'],{'source':_0x4bd6be(0x74),'matchId':_0x1ae962}),await promotionManager['checkAndRecordPromotion'](_0x3601ba,_0x4318f1,_0x13b4de['eloRating'],{'source':'match-d2','matchId':_0x1ae962}),!![];}catch(_0x325942){console['error'](_0x4bd6be(0x6e),_0x325942);throw _0x325942;}}export async function approveReportD2(_0x1f02eb,_0x5ddcdf,_0x1d1216,_0x3fa2fa){const _0x4c6926=a28_0x4a62;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x1f02eb,'winnerScore':_0x5ddcdf,'winnerSuicides':_0x1d1216,'winnerComment':_0x3fa2fa});const _0x12a71d=auth['currentUser'];if(!_0x12a71d){console['log'](_0x4c6926(0x86));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log'](_0x4c6926(0x83),_0x12a71d[_0x4c6926(0x75)]);const _0x5ed6f6=await getDoc(doc(db,'playersD2',_0x12a71d['uid'])),_0x57b231=_0x5ed6f6['exists']()?_0x5ed6f6['data']()[_0x4c6926(0x6d)]:null;console[_0x4c6926(0x6f)]('Current\x20username:',_0x57b231);const _0x46aaea=doc(db,'pendingMatchesD2',_0x1f02eb),_0x34a151=await getDoc(_0x46aaea);if(!_0x34a151[_0x4c6926(0x88)]()){console[_0x4c6926(0x6f)]('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x1f02eb);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x4a0c1b=_0x34a151['data']();console[_0x4c6926(0x6f)](_0x4c6926(0x89),_0x4a0c1b);if(_0x57b231!==_0x4a0c1b['winnerUsername'])throw new Error(_0x4c6926(0x70));const _0x95b796={..._0x4a0c1b,'winnerScore':_0x5ddcdf,'winnerSuicides':_0x1d1216,'winnerComment':_0x3fa2fa,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x57b231,'createdAt':_0x4a0c1b['createdAt']||serverTimestamp(),'winnerUsername':_0x4a0c1b[_0x4c6926(0x7d)],'loserUsername':_0x4a0c1b['loserUsername']};await setDoc(doc(db,_0x4c6926(0x6c),_0x1f02eb),_0x95b796),await deleteDoc(_0x46aaea),console['log'](_0x4c6926(0x85));const [_0x60067f,_0xffb8c3]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x4a0c1b['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x4a0c1b['loserUsername'])))]);if(_0x60067f['empty']||_0xffb8c3['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x2937bc=_0x60067f[_0x4c6926(0x73)][0x0]['id'],_0x3be4fc=_0xffb8c3['docs'][0x0]['id'];return await updateEloRatingsD2(_0x2937bc,_0x3be4fc,_0x1f02eb),console[_0x4c6926(0x6f)]('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x22aa1f){console[_0x4c6926(0x72)]('Error\x20in\x20approveReportD2:',_0x22aa1f);throw _0x22aa1f;}}