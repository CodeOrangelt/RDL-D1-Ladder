const a28_0x3fc65b=(function(){let _0x1d60ff=!![];return function(_0x3e9b4a,_0x2aa57b){const _0x362e5d=_0x1d60ff?function(){if(_0x2aa57b){const _0x27bbd8=_0x2aa57b['apply'](_0x3e9b4a,arguments);return _0x2aa57b=null,_0x27bbd8;}}:function(){};return _0x1d60ff=![],_0x362e5d;};}()),a28_0x4b8c54=a28_0x3fc65b(this,function(){const _0x441342=a28_0x887e;let _0x3c99f4;try{const _0x2ab3b5=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x3c99f4=_0x2ab3b5();}catch(_0x4057d8){_0x3c99f4=window;}const _0x410200=_0x3c99f4['console']=_0x3c99f4['console']||{},_0x2acf09=['log','warn','info','error','exception','table','trace'];for(let _0x4c866c=0x0;_0x4c866c<_0x2acf09['length'];_0x4c866c++){const _0xbede17=a28_0x3fc65b['constructor'][_0x441342(0x16e)]['bind'](a28_0x3fc65b),_0x4c4e0e=_0x2acf09[_0x4c866c],_0x55e2ce=_0x410200[_0x4c4e0e]||_0xbede17;_0xbede17['__proto__']=a28_0x3fc65b['bind'](a28_0x3fc65b),_0xbede17['toString']=_0x55e2ce['toString']['bind'](_0x55e2ce),_0x410200[_0x4c4e0e]=_0xbede17;}});a28_0x4b8c54();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x2b31(){const _0x31339e=['Could\x20not\x20find\x20D2\x20player\x20documents','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','log','data','empty','Current\x20user:','update','No\x20user\x20logged\x20in','playersD2','pendingMatchesD2','Error\x20in\x20updateEloRatingsD2:','prototype','currentUser','winnerUsername','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','position','MAX_SAFE_INTEGER','eloRating','exists'];a28_0x2b31=function(){return _0x31339e;};return a28_0x2b31();}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x4138e3 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x5d7cef,_0x374f47,_0x167d97=0x20){const _0x26f0aa=0x1/(0x1+Math['pow'](0xa,(_0x374f47-_0x5d7cef)/0x190)),_0x1326e8=0x1/(0x1+Math['pow'](0xa,(_0x5d7cef-_0x374f47)/0x190)),_0x4cf0c7=_0x5d7cef+_0x167d97*(0x1-_0x26f0aa),_0x44a64d=_0x374f47+_0x167d97*(0x0-_0x1326e8);return{'newWinnerRating':Math['round'](_0x4cf0c7),'newLoserRating':Math['round'](_0x44a64d)};}export async function updateEloRatingsD2(_0x4fea0b,_0x4483f4,_0x710a41){const _0x31dbab=a28_0x887e;try{const _0x30781e=writeBatch(db),_0x37a7cb=doc(db,'playersD2',_0x4fea0b),_0x250088=doc(db,'playersD2',_0x4483f4),[_0x27edaa,_0x19d3ad]=await Promise['all']([getDoc(_0x37a7cb),getDoc(_0x250088)]);if(!_0x27edaa['exists']()||!_0x19d3ad[_0x31dbab(0x175)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x98a72=_0x27edaa[_0x31dbab(0x166)](),_0xe7a813=_0x19d3ad['data'](),_0x1a4e8f=_0x98a72[_0x31dbab(0x172)]||Number['MAX_SAFE_INTEGER'],_0x1afeb0=_0xe7a813[_0x31dbab(0x172)]||Number[_0x31dbab(0x173)],{newWinnerRating:_0x447b8d,newLoserRating:_0x40a007}=calculateEloD2(_0x98a72[_0x31dbab(0x174)]||0x4b0,_0xe7a813['eloRating']||0x4b0);let _0x197cc7=_0x1a4e8f,_0x4829a1=_0x1afeb0;if(_0x1a4e8f>_0x1afeb0){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x197cc7=_0x1afeb0,_0x4829a1=_0x1afeb0+0x1;const _0x54e39e=query(collection(db,'playersD2'),where('position','>',_0x1afeb0),where(_0x31dbab(0x172),'<',_0x1a4e8f)),_0x87c131=await getDocs(_0x54e39e);for(const _0x2dd91e of _0x87c131['docs']){_0x2dd91e['id']!==_0x4fea0b&&_0x2dd91e['id']!==_0x4483f4&&_0x30781e['update'](doc(db,'playersD2',_0x2dd91e['id']),{'position':_0x2dd91e[_0x31dbab(0x166)]()[_0x31dbab(0x172)]+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x30781e[_0x31dbab(0x169)](_0x37a7cb,{'eloRating':_0x447b8d,'lastMatchDate':serverTimestamp(),'position':_0x197cc7,'lastMatchId':_0x710a41}),_0x30781e['update'](_0x250088,{'eloRating':_0x40a007,'lastMatchDate':serverTimestamp(),'position':_0x4829a1,'lastMatchId':_0x710a41}),await _0x30781e['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x4fea0b,'previousElo':_0x98a72['eloRating']||0x4b0,'newElo':_0x447b8d,'opponentId':_0x4483f4,'matchResult':'win','previousPosition':_0x1a4e8f,'newPosition':_0x197cc7,'isPromotion':_0x197cc7<_0x1a4e8f,'matchId':_0x710a41,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x4483f4,'previousElo':_0xe7a813[_0x31dbab(0x174)]||0x4b0,'newElo':_0x40a007,'opponentId':_0x4fea0b,'matchResult':'loss','previousPosition':_0x1afeb0,'newPosition':_0x4829a1,'isDemotion':_0x4829a1>_0x1afeb0,'matchId':_0x710a41,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x4fea0b,_0x447b8d,_0x98a72['eloRating'],{'source':'match-d2','matchId':_0x710a41}),await promotionManager['checkAndRecordPromotion'](_0x4483f4,_0x40a007,_0xe7a813['eloRating'],{'source':'match-d2','matchId':_0x710a41}),!![];}catch(_0x13e7fa){console['error'](_0x31dbab(0x16d),_0x13e7fa);throw _0x13e7fa;}}function a28_0x887e(_0x148f3c,_0x3c92b2){const _0x4b8c54=a28_0x2b31();return a28_0x887e=function(_0x3fc65b,_0x11505d){_0x3fc65b=_0x3fc65b-0x163;let _0x2b3158=_0x4b8c54[_0x3fc65b];return _0x2b3158;},a28_0x887e(_0x148f3c,_0x3c92b2);}export async function approveReportD2(_0x3fdebb,_0x14702a,_0x5d1765,_0x395a1f){const _0x37b70d=a28_0x887e;try{console[_0x37b70d(0x165)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x3fdebb,'winnerScore':_0x14702a,'winnerSuicides':_0x5d1765,'winnerComment':_0x395a1f});const _0x2d624a=auth[_0x37b70d(0x16f)];if(!_0x2d624a){console[_0x37b70d(0x165)](_0x37b70d(0x16a));throw new Error(_0x37b70d(0x171));}console['log'](_0x37b70d(0x168),_0x2d624a['email']);const _0x16e7a2=await getDoc(doc(db,'playersD2',_0x2d624a['uid'])),_0x4a2798=_0x16e7a2['exists']()?_0x16e7a2[_0x37b70d(0x166)]()['username']:null;console['log']('Current\x20username:',_0x4a2798);const _0x16294e=doc(db,_0x37b70d(0x16c),_0x3fdebb),_0x2b3e3f=await getDoc(_0x16294e);if(!_0x2b3e3f['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x3fdebb);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x764f4e=_0x2b3e3f['data']();console['log']('D2\x20Report\x20data:',_0x764f4e);if(_0x4a2798!==_0x764f4e['winnerUsername'])throw new Error(_0x37b70d(0x164));const _0x41f318={..._0x764f4e,'winnerScore':_0x14702a,'winnerSuicides':_0x5d1765,'winnerComment':_0x395a1f,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x4a2798,'createdAt':_0x764f4e['createdAt']||serverTimestamp(),'winnerUsername':_0x764f4e['winnerUsername'],'loserUsername':_0x764f4e['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x3fdebb),_0x41f318),await deleteDoc(_0x16294e),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x37dd6f,_0x43736a]=await Promise['all']([getDocs(query(collection(db,_0x37b70d(0x16b)),where('username','==',_0x764f4e[_0x37b70d(0x170)]))),getDocs(query(collection(db,_0x37b70d(0x16b)),where('username','==',_0x764f4e['loserUsername'])))]);if(_0x37dd6f[_0x37b70d(0x167)]||_0x43736a[_0x37b70d(0x167)])throw new Error(_0x37b70d(0x163));const _0x2b845f=_0x37dd6f['docs'][0x0]['id'],_0x3c3ddb=_0x43736a['docs'][0x0]['id'];return await updateEloRatingsD2(_0x2b845f,_0x3c3ddb,_0x3fdebb),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3aa614){console['error']('Error\x20in\x20approveReportD2:',_0x3aa614);throw _0x3aa614;}}