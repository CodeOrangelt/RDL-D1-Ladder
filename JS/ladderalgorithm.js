const a30_0x1d9a05=(function(){let _0xb68550=!![];return function(_0x1ef3df,_0x2398f4){const _0x137d8a=_0xb68550?function(){if(_0x2398f4){const _0x98e117=_0x2398f4['apply'](_0x1ef3df,arguments);return _0x2398f4=null,_0x98e117;}}:function(){};return _0xb68550=![],_0x137d8a;};}()),a30_0x2cce92=a30_0x1d9a05(this,function(){const _0x499e1d=a30_0x51f7,_0x4cc775=function(){let _0x6facb8;try{_0x6facb8=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0xa090a7){_0x6facb8=window;}return _0x6facb8;},_0x51df41=_0x4cc775(),_0x16e5cf=_0x51df41['console']=_0x51df41[_0x499e1d(0xb7)]||{},_0x1418eb=['log','warn',_0x499e1d(0xbc),'error','exception','table',_0x499e1d(0xa1)];for(let _0x336b0a=0x0;_0x336b0a<_0x1418eb['length'];_0x336b0a++){const _0x5f44f0=a30_0x1d9a05['constructor']['prototype'][_0x499e1d(0xad)](a30_0x1d9a05),_0x20dfd9=_0x1418eb[_0x336b0a],_0x34a7fa=_0x16e5cf[_0x20dfd9]||_0x5f44f0;_0x5f44f0['__proto__']=a30_0x1d9a05[_0x499e1d(0xad)](a30_0x1d9a05),_0x5f44f0['toString']=_0x34a7fa['toString']['bind'](_0x34a7fa),_0x16e5cf[_0x20dfd9]=_0x5f44f0;}});a30_0x2cce92();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x346257,_0x1cc875,_0x50308b=0x20){const _0xe32ab9=a30_0x51f7,_0x5e8dfc=0x1/(0x1+Math[_0xe32ab9(0xb4)](0xa,(_0x1cc875-_0x346257)/0x190)),_0x5080fa=0x1/(0x1+Math[_0xe32ab9(0xb4)](0xa,(_0x346257-_0x1cc875)/0x190)),_0xe2799b=_0x346257+_0x50308b*(0x1-_0x5e8dfc),_0x55e615=_0x1cc875+_0x50308b*(0x0-_0x5080fa);return{'newWinnerRating':Math[_0xe32ab9(0xb5)](_0xe2799b),'newLoserRating':Math['round'](_0x55e615)};}function a30_0x3a58(){const _0x3568bb=['Error\x20approving\x20report:','username','update','One\x20or\x20both\x20players\x20not\x20found','trace','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','error','players','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','loss','docs','subgameType','ELO\x20ratings\x20updated\x20successfully','data','wins','checkAndRecordPromotion','bind','position','empty','loserUsername','totalDeaths','eloRating','catch','pow','round','log','console','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','toFixed','totalKills','MAX_SAFE_INTEGER','info','Could\x20not\x20find\x20player\x20documents'];a30_0x3a58=function(){return _0x3568bb;};return a30_0x3a58();}export function assignDefaultEloRating(_0x12357f,_0x1185ea){const _0x41f501=a30_0x51f7,_0x395297=0x4b0;!_0x1185ea['eloRating']&&db['collection']('players')['doc'](_0x12357f)['update']({'eloRating':_0x395297})['then'](()=>{const _0x340f7b=a30_0x51f7;console[_0x340f7b(0xb6)](_0x340f7b(0xa2)+_0x1185ea[_0x340f7b(0x9e)]);})[_0x41f501(0xb3)](_0x5edb52=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x5edb52);});}function a30_0x51f7(_0x2968e2,_0x1e961b){const _0x2cce92=a30_0x3a58();return a30_0x51f7=function(_0x1d9a05,_0x3b1329){_0x1d9a05=_0x1d9a05-0x9d;let _0x3a5814=_0x2cce92[_0x1d9a05];return _0x3a5814;},a30_0x51f7(_0x2968e2,_0x1e961b);}export async function updateEloRatings(_0x38dc44,_0xb7114d,_0xd4ce7){const _0x516964=a30_0x51f7;try{const _0x31e2a9=writeBatch(db),_0x1fc774=doc(db,'players',_0x38dc44),_0x2558d8=doc(db,'players',_0xb7114d),[_0x37369a,_0x3a70f5]=await Promise['all']([getDoc(_0x1fc774),getDoc(_0x2558d8)]);if(!_0x37369a['exists']()||!_0x3a70f5['exists']())throw new Error(_0x516964(0xa0));const _0x21fb9f=_0x37369a['data'](),_0x3ed5fb=_0x3a70f5['data'](),_0x3d779e=_0x21fb9f['position']||Number[_0x516964(0xbb)],_0x25d3ff=_0x3ed5fb[_0x516964(0xae)]||Number[_0x516964(0xbb)],{newWinnerRating:_0x1a77c7,newLoserRating:_0x55ee8b}=calculateElo(_0x21fb9f['eloRating']||0x4b0,_0x3ed5fb[_0x516964(0xb2)]||0x4b0);let _0x2a9b4e=_0x3d779e,_0x4d31bc=_0x25d3ff;if(_0x3d779e>_0x25d3ff){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x2a9b4e=_0x25d3ff,_0x4d31bc=_0x25d3ff+0x1;const _0x36b996=query(collection(db,'players'),where('position','>',_0x25d3ff),where('position','<',_0x3d779e)),_0x4cf995=await getDocs(_0x36b996);for(const _0x3130da of _0x4cf995['docs']){_0x3130da['id']!==_0x38dc44&&_0x3130da['id']!==_0xb7114d&&_0x31e2a9['update'](doc(db,'players',_0x3130da['id']),{'position':_0x3130da['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x248dd7={'eloRating':_0x1a77c7,'lastMatchDate':serverTimestamp(),'position':_0x2a9b4e,'lastMatchId':_0xd4ce7},_0x2cb8f5={'eloRating':_0x55ee8b,'lastMatchDate':serverTimestamp(),'position':_0x4d31bc,'lastMatchId':_0xd4ce7};return _0x31e2a9['update'](_0x1fc774,_0x248dd7),_0x31e2a9[_0x516964(0x9f)](_0x2558d8,_0x2cb8f5),await _0x31e2a9['commit'](),console[_0x516964(0xb6)](_0x516964(0xa9)),await Promise['all']([recordEloChange({'playerId':_0x38dc44,'previousElo':_0x21fb9f[_0x516964(0xb2)]||0x4b0,'newElo':_0x1a77c7,'opponentId':_0xb7114d,'matchResult':'win','previousPosition':_0x3d779e,'newPosition':_0x2a9b4e,'isPromotion':_0x2a9b4e<_0x3d779e,'matchId':_0xd4ce7,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0xb7114d,'previousElo':_0x3ed5fb['eloRating']||0x4b0,'newElo':_0x55ee8b,'opponentId':_0x38dc44,'matchResult':_0x516964(0xa6),'previousPosition':_0x25d3ff,'newPosition':_0x4d31bc,'isDemotion':_0x4d31bc>_0x25d3ff,'matchId':_0xd4ce7,'timestamp':serverTimestamp()})]),await promotionManager[_0x516964(0xac)](_0x38dc44,_0x1a77c7,_0x21fb9f['eloRating'],{'source':'match','matchId':_0xd4ce7}),await promotionManager['checkAndRecordPromotion'](_0xb7114d,_0x55ee8b,_0x3ed5fb['eloRating'],{'source':'match','matchId':_0xd4ce7}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x5e9ef9){console[_0x516964(0xa3)]('Error\x20in\x20updateEloRatings:',_0x5e9ef9);throw _0x5e9ef9;}}export async function approveReport(_0x35353d,_0x101a1d,_0x479a0e,_0x3d589c,_0x3d345d){const _0x45214e=a30_0x51f7;try{const _0x1ee167=doc(db,'pendingMatches',_0x35353d),_0x2d0bc9=await getDoc(_0x1ee167);if(!_0x2d0bc9['exists']())throw new Error('Report\x20not\x20found');const _0x5ce9e0=_0x2d0bc9['data'](),_0x33032b={..._0x5ce9e0,'winnerScore':_0x101a1d,'winnerSuicides':_0x479a0e,'winnerComment':_0x3d589c,'winnerDemoLink':_0x3d345d,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x35353d),_0x33032b),await deleteDoc(_0x1ee167),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x23d0dc,_0x35f867]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x5ce9e0['winnerUsername']))),getDocs(query(collection(db,_0x45214e(0xa4)),where(_0x45214e(0x9e),'==',_0x5ce9e0[_0x45214e(0xb0)])))]);if(_0x23d0dc[_0x45214e(0xaf)]||_0x35f867['empty'])throw new Error(_0x45214e(0xbd));const _0x23acab=_0x23d0dc[_0x45214e(0xa7)][0x0]['id'],_0x37cd22=_0x35f867['docs'][0x0]['id'];await updateEloRatings(_0x23acab,_0x37cd22,_0x35353d);try{await awardMatchPoints(_0x23acab,_0x37cd22,_0x5ce9e0[_0x45214e(0xa8)]);}catch(_0x1aa762){console['warn'](_0x45214e(0xa5),_0x1aa762);}return console['log'](_0x45214e(0xb8)),!![];}catch(_0x350dbb){console[_0x45214e(0xa3)](_0x45214e(0x9d),_0x350dbb);throw _0x350dbb;}}async function updatePlayerElo(_0x4efcd1,_0x12127b,_0x240494){const _0x30e8da=a30_0x51f7;await setDoc(doc(db,_0x30e8da(0xa4),_0x4efcd1),{...playerData,'eloRating':_0x240494}),await checkAndRecordPromotion(_0x4efcd1,_0x240494,_0x12127b);}async function updatePlayerStats(_0x50c473,_0x162031,_0xa30015){const _0x28e37f=a30_0x51f7,_0x5155b1=doc(db,'playerStats',_0x50c473),_0x5200b5=await getDoc(_0x5155b1);let _0x5980fd=_0x5200b5['exists']()?_0x5200b5[_0x28e37f(0xaa)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0xa30015?(_0x5980fd[_0x28e37f(0xab)]++,_0x5980fd['totalKills']+=parseInt(_0x162031['winnerScore']||0x0),_0x5980fd[_0x28e37f(0xb1)]+=parseInt(_0x162031['loserScore']||0x0)):(_0x5980fd['losses']++,_0x5980fd[_0x28e37f(0xba)]+=parseInt(_0x162031['loserScore']||0x0),_0x5980fd[_0x28e37f(0xb1)]+=parseInt(_0x162031['winnerScore']||0x0));const _0x4d869e=_0x5980fd['wins']+_0x5980fd['losses'];_0x5980fd['winRate']=_0x4d869e>0x0?(_0x5980fd['wins']/_0x4d869e*0x64)[_0x28e37f(0xb9)](0x1):0x0,_0x5980fd['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x5155b1,_0x5980fd,{'merge':!![]});}