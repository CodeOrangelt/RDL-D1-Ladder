const a28_0x3edc8c=(function(){let _0x35930f=!![];return function(_0x2ee5ac,_0x372239){const _0x580bdb=_0x35930f?function(){if(_0x372239){const _0x4dc41e=_0x372239['apply'](_0x2ee5ac,arguments);return _0x372239=null,_0x4dc41e;}}:function(){};return _0x35930f=![],_0x580bdb;};}()),a28_0x525a76=a28_0x3edc8c(this,function(){const _0x4ffd61=a28_0x4c3a;let _0xd24b33;try{const _0x236fc4=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0xd24b33=_0x236fc4();}catch(_0x67c687){_0xd24b33=window;}const _0x8a45f4=_0xd24b33['console']=_0xd24b33['console']||{},_0x12ff16=[_0x4ffd61(0x1eb),_0x4ffd61(0x1f0),_0x4ffd61(0x1e9),_0x4ffd61(0x1f4),'exception','table','trace'];for(let _0x252d57=0x0;_0x252d57<_0x12ff16['length'];_0x252d57++){const _0x48f3de=a28_0x3edc8c['constructor'][_0x4ffd61(0x1ee)]['bind'](a28_0x3edc8c),_0x56edd2=_0x12ff16[_0x252d57],_0x265d13=_0x8a45f4[_0x56edd2]||_0x48f3de;_0x48f3de[_0x4ffd61(0x1e3)]=a28_0x3edc8c['bind'](a28_0x3edc8c),_0x48f3de['toString']=_0x265d13['toString']['bind'](_0x265d13),_0x8a45f4[_0x56edd2]=_0x48f3de;}});a28_0x525a76();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x16b401,_0x49ee7d,_0x5caadc=0x20){const _0x23dc50=0x1/(0x1+Math['pow'](0xa,(_0x49ee7d-_0x16b401)/0x190)),_0x2350e8=0x1/(0x1+Math['pow'](0xa,(_0x16b401-_0x49ee7d)/0x190)),_0x4399d8=_0x16b401+_0x5caadc*(0x1-_0x23dc50),_0x5b4925=_0x49ee7d+_0x5caadc*(0x0-_0x2350e8);return{'newWinnerRating':Math['round'](_0x4399d8),'newLoserRating':Math['round'](_0x5b4925)};}export function assignDefaultEloRating(_0x2270df,_0x19aaca){const _0x39761e=a28_0x4c3a,_0x464032=0x4b0;!_0x19aaca['eloRating']&&db['collection'](_0x39761e(0x1ec))['doc'](_0x2270df)['update']({'eloRating':_0x464032})['then'](()=>{const _0x142153=_0x39761e;console['log'](_0x142153(0x1fb)+_0x19aaca['username']);})[_0x39761e(0x1ef)](_0x1f8fb=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x1f8fb);});}export async function updateEloRatings(_0x748b7e,_0x1c713d,_0x1ee088){const _0xb845e7=a28_0x4c3a;try{const _0x1b9c0e=writeBatch(db),_0x1e1da0=doc(db,'players',_0x748b7e),_0x3afef4=doc(db,'players',_0x1c713d),[_0x2e1b08,_0x3cf636]=await Promise['all']([getDoc(_0x1e1da0),getDoc(_0x3afef4)]);if(!_0x2e1b08[_0xb845e7(0x1e2)]()||!_0x3cf636['exists']())throw new Error(_0xb845e7(0x1e6));const _0x310062=_0x2e1b08['data'](),_0x1d3fb5=_0x3cf636['data'](),_0x2fdc08=_0x310062['position']||Number['MAX_SAFE_INTEGER'],_0x60453e=_0x1d3fb5[_0xb845e7(0x1f7)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x5e77aa,newLoserRating:_0x30dc64}=calculateElo(_0x310062['eloRating']||0x4b0,_0x1d3fb5[_0xb845e7(0x1e5)]||0x4b0);let _0x2a321c=_0x2fdc08,_0x6c3bf1=_0x60453e;if(_0x2fdc08>_0x60453e){console[_0xb845e7(0x1eb)]('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x2a321c=_0x60453e,_0x6c3bf1=_0x60453e+0x1;const _0x347fca=query(collection(db,'players'),where('position','>',_0x60453e),where('position','<',_0x2fdc08)),_0x206dc4=await getDocs(_0x347fca);for(const _0xa1744b of _0x206dc4['docs']){_0xa1744b['id']!==_0x748b7e&&_0xa1744b['id']!==_0x1c713d&&_0x1b9c0e['update'](doc(db,'players',_0xa1744b['id']),{'position':_0xa1744b['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x4477ef={'eloRating':_0x5e77aa,'lastMatchDate':serverTimestamp(),'position':_0x2a321c,'lastMatchId':_0x1ee088},_0x1abf10={'eloRating':_0x30dc64,'lastMatchDate':serverTimestamp(),'position':_0x6c3bf1,'lastMatchId':_0x1ee088};return _0x1b9c0e[_0xb845e7(0x1df)](_0x1e1da0,_0x4477ef),_0x1b9c0e['update'](_0x3afef4,_0x1abf10),await _0x1b9c0e['commit'](),console[_0xb845e7(0x1eb)]('ELO\x20ratings\x20updated\x20successfully'),await Promise[_0xb845e7(0x1f2)]([recordEloChange({'playerId':_0x748b7e,'previousElo':_0x310062['eloRating']||0x4b0,'newElo':_0x5e77aa,'opponentId':_0x1c713d,'matchResult':'win','previousPosition':_0x2fdc08,'newPosition':_0x2a321c,'isPromotion':_0x2a321c<_0x2fdc08,'matchId':_0x1ee088,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x1c713d,'previousElo':_0x1d3fb5[_0xb845e7(0x1e5)]||0x4b0,'newElo':_0x30dc64,'opponentId':_0x748b7e,'matchResult':'loss','previousPosition':_0x60453e,'newPosition':_0x6c3bf1,'isDemotion':_0x6c3bf1>_0x60453e,'matchId':_0x1ee088,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x748b7e,_0x5e77aa,_0x310062[_0xb845e7(0x1e5)],{'source':_0xb845e7(0x1de),'matchId':_0x1ee088}),await promotionManager['checkAndRecordPromotion'](_0x1c713d,_0x30dc64,_0x1d3fb5['eloRating'],{'source':'match','matchId':_0x1ee088}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x17fcc6){console['error']('Error\x20in\x20updateEloRatings:',_0x17fcc6);throw _0x17fcc6;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x46a128,_0x2b77e5,_0x2f1b0b,_0x1f8366,_0x3d2915){const _0x5432df=a28_0x4c3a;try{const _0x49c4ab=doc(db,'pendingMatches',_0x46a128),_0x4be230=await getDoc(_0x49c4ab);if(!_0x4be230['exists']())throw new Error('Report\x20not\x20found');const _0x26caf2=_0x4be230['data'](),_0x152988={..._0x26caf2,'winnerScore':_0x2b77e5,'winnerSuicides':_0x2f1b0b,'winnerComment':_0x1f8366,'winnerDemoLink':_0x3d2915,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,_0x5432df(0x1f3),_0x46a128),_0x152988),await deleteDoc(_0x49c4ab),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x2d27e1,_0x3cadbd]=await Promise[_0x5432df(0x1f2)]([getDocs(query(collection(db,'players'),where('username','==',_0x26caf2[_0x5432df(0x1f9)]))),getDocs(query(collection(db,'players'),where(_0x5432df(0x1e0),'==',_0x26caf2['loserUsername'])))]);if(_0x2d27e1['empty']||_0x3cadbd['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x57290c=_0x2d27e1['docs'][0x0]['id'],_0x162422=_0x3cadbd[_0x5432df(0x1e1)][0x0]['id'];await updateEloRatings(_0x57290c,_0x162422,_0x46a128);try{const _0x3d73ef=_0x26caf2['subgameType']||_0x5432df(0x1e7),_0x4792a5=POINTS_CHART[_0x3d73ef]||0xa,_0x4f0a62=doc(db,'userProfiles',_0x57290c),_0x27be8c=doc(db,_0x5432df(0x1e8),_0x162422),[_0x54ebe0,_0x424f2c]=await Promise[_0x5432df(0x1f2)]([getDoc(_0x4f0a62),getDoc(_0x27be8c)]);if(_0x54ebe0['exists']()&&_0x424f2c['exists']()){const _0x43a8ad=_0x54ebe0['data'](),_0x5e737d=_0x424f2c['data'](),_0x333b9b=_0x43a8ad[_0x5432df(0x1e4)]||0x0,_0x26ab94=_0x5e737d['points']||0x0,_0x442210=_0x333b9b+_0x4792a5,_0x507687=_0x26ab94+_0x4792a5;await Promise['all']([updateDoc(_0x4f0a62,{'points':_0x442210,'lastPointsModified':serverTimestamp()}),updateDoc(_0x27be8c,{'points':_0x507687,'lastPointsModified':serverTimestamp()})]),await Promise[_0x5432df(0x1f2)]([addDoc(collection(db,'pointsHistory'),{'userId':_0x57290c,'userEmail':_0x43a8ad['email']||'unknown','displayName':_0x43a8ad['displayName']||_0x43a8ad['username']||'Unknown\x20User','action':'add','amount':_0x4792a5,'previousPoints':_0x333b9b,'newPoints':_0x442210,'reason':'Match\x20points:\x20'+_0x3d73ef+'\x20match\x20(Winner)','adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,_0x5432df(0x1f5)),{'userId':_0x162422,'userEmail':_0x5e737d['email']||'unknown','displayName':_0x5e737d['displayName']||_0x5e737d['username']||'Unknown\x20User','action':'add','amount':_0x4792a5,'previousPoints':_0x26ab94,'newPoints':_0x507687,'reason':'Match\x20points:\x20'+_0x3d73ef+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log']('Awarded\x20'+_0x4792a5+_0x5432df(0x1f6)+_0x3d73ef+'\x20match');}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x33650e){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x33650e);}return console[_0x5432df(0x1eb)](_0x5432df(0x1f1)),!![];}catch(_0x51d7e2){console[_0x5432df(0x1f4)]('Error\x20approving\x20report:',_0x51d7e2);throw _0x51d7e2;}}function a28_0x4c3a(_0x430a6b,_0x2975a4){const _0x525a76=a28_0x7ab5();return a28_0x4c3a=function(_0x3edc8c,_0x8e85cf){_0x3edc8c=_0x3edc8c-0x1de;let _0x7ab5c4=_0x525a76[_0x3edc8c];return _0x7ab5c4;},a28_0x4c3a(_0x430a6b,_0x2975a4);}async function updatePlayerElo(_0x1d8839,_0x5ca12d,_0x3fc10d){await setDoc(doc(db,'players',_0x1d8839),{...playerData,'eloRating':_0x3fc10d}),await checkAndRecordPromotion(_0x1d8839,_0x3fc10d,_0x5ca12d);}function a28_0x7ab5(){const _0x42a99e=['match','update','username','docs','exists','__proto__','points','eloRating','One\x20or\x20both\x20players\x20not\x20found','Standard','userProfiles','info','winnerScore','log','players','totalKills','prototype','catch','warn','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','all','approvedMatches','error','pointsHistory','\x20points\x20to\x20both\x20players\x20for\x20','position','wins','winnerUsername','data','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'];a28_0x7ab5=function(){return _0x42a99e;};return a28_0x7ab5();}async function updatePlayerStats(_0x412294,_0x365798,_0x5b14fc){const _0xe20562=a28_0x4c3a,_0x56a416=doc(db,'playerStats',_0x412294),_0x60ae8=await getDoc(_0x56a416);let _0x1d8422=_0x60ae8['exists']()?_0x60ae8[_0xe20562(0x1fa)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x5b14fc?(_0x1d8422['wins']++,_0x1d8422[_0xe20562(0x1ed)]+=parseInt(_0x365798[_0xe20562(0x1ea)]||0x0),_0x1d8422['totalDeaths']+=parseInt(_0x365798['loserScore']||0x0)):(_0x1d8422['losses']++,_0x1d8422[_0xe20562(0x1ed)]+=parseInt(_0x365798['loserScore']||0x0),_0x1d8422['totalDeaths']+=parseInt(_0x365798['winnerScore']||0x0));const _0x512034=_0x1d8422['wins']+_0x1d8422['losses'];_0x1d8422['winRate']=_0x512034>0x0?(_0x1d8422[_0xe20562(0x1f8)]/_0x512034*0x64)['toFixed'](0x1):0x0,_0x1d8422['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x56a416,_0x1d8422,{'merge':!![]});}