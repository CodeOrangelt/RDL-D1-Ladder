const a27_0x1a732b=(function(){let _0x2f639c=!![];return function(_0xf021b2,_0x1792df){const _0x42ffa7=_0x2f639c?function(){if(_0x1792df){const _0x58dac0=_0x1792df['apply'](_0xf021b2,arguments);return _0x1792df=null,_0x58dac0;}}:function(){};return _0x2f639c=![],_0x42ffa7;};}()),a27_0x27f80c=a27_0x1a732b(this,function(){const _0x561a84=a27_0x1cac,_0x4f2942=function(){let _0xbb32f3;try{_0xbb32f3=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x4e1014){_0xbb32f3=window;}return _0xbb32f3;},_0x15938f=_0x4f2942(),_0x73913a=_0x15938f['console']=_0x15938f[_0x561a84(0x1b2)]||{},_0x32bad2=['log','warn','info','error','exception','table','trace'];for(let _0x1d362f=0x0;_0x1d362f<_0x32bad2['length'];_0x1d362f++){const _0x1e0357=a27_0x1a732b['constructor'][_0x561a84(0x1b9)]['bind'](a27_0x1a732b),_0x3cf328=_0x32bad2[_0x1d362f],_0x3db119=_0x73913a[_0x3cf328]||_0x1e0357;_0x1e0357['__proto__']=a27_0x1a732b['bind'](a27_0x1a732b),_0x1e0357[_0x561a84(0x1bd)]=_0x3db119['toString'][_0x561a84(0x1b6)](_0x3db119),_0x73913a[_0x3cf328]=_0x1e0357;}});a27_0x27f80c();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a27_0x1cac(_0x1a0fca,_0x30fcff){const _0x27f80c=a27_0x576b();return a27_0x1cac=function(_0x1a732b,_0x36d271){_0x1a732b=_0x1a732b-0x1ac;let _0x576b88=_0x27f80c[_0x1a732b];return _0x576b88;},a27_0x1cac(_0x1a0fca,_0x30fcff);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x3c9173,_0x2d2415,_0x557c4a=0x20){const _0x25fbf9=a27_0x1cac,_0x2d44c3=0x1/(0x1+Math['pow'](0xa,(_0x2d2415-_0x3c9173)/0x190)),_0x353071=0x1/(0x1+Math[_0x25fbf9(0x1b0)](0xa,(_0x3c9173-_0x2d2415)/0x190)),_0x38e4e5=_0x3c9173+_0x557c4a*(0x1-_0x2d44c3),_0x4e481b=_0x2d2415+_0x557c4a*(0x0-_0x353071);return{'newWinnerRating':Math['round'](_0x38e4e5),'newLoserRating':Math[_0x25fbf9(0x1b3)](_0x4e481b)};}function a27_0x576b(){const _0x4e5fc1=['docs','username','data','update','pow','MAX_SAFE_INTEGER','console','round','D3\x20Report\x20data:','log','bind','Current\x20user:','One\x20or\x20both\x20D3\x20players\x20not\x20found','prototype','eloRating','position','playersD3','toString','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'];a27_0x576b=function(){return _0x4e5fc1;};return a27_0x576b();}export async function updateEloRatingsD3(_0x2ce784,_0x556f3f,_0x5cad2b){const _0x546eec=a27_0x1cac;try{const _0x52eeff=writeBatch(db),_0x4d6781=doc(db,'playersD3',_0x2ce784),_0x507221=doc(db,_0x546eec(0x1bc),_0x556f3f),[_0x142fd5,_0xdbf918]=await Promise['all']([getDoc(_0x4d6781),getDoc(_0x507221)]);if(!_0x142fd5['exists']()||!_0xdbf918['exists']())throw new Error(_0x546eec(0x1b8));const _0x382bb7=_0x142fd5['data'](),_0x341a6c=_0xdbf918['data'](),_0x5e2fd1=_0x382bb7['position']||Number['MAX_SAFE_INTEGER'],_0x49392a=_0x341a6c[_0x546eec(0x1bb)]||Number[_0x546eec(0x1b1)],{newWinnerRating:_0x213942,newLoserRating:_0x32ddb0}=calculateEloD3(_0x382bb7['eloRating']||0x4b0,_0x341a6c[_0x546eec(0x1ba)]||0x4b0);let _0x86876c=_0x5e2fd1,_0xe397fc=_0x49392a;if(_0x5e2fd1>_0x49392a){console[_0x546eec(0x1b5)](_0x546eec(0x1be)),_0x86876c=_0x49392a,_0xe397fc=_0x49392a+0x1;const _0xed468c=query(collection(db,'playersD3'),where('position','>',_0x49392a),where(_0x546eec(0x1bb),'<',_0x5e2fd1)),_0x3c4583=await getDocs(_0xed468c);for(const _0x5f0caa of _0x3c4583[_0x546eec(0x1ac)]){_0x5f0caa['id']!==_0x2ce784&&_0x5f0caa['id']!==_0x556f3f&&_0x52eeff[_0x546eec(0x1af)](doc(db,'playersD3',_0x5f0caa['id']),{'position':_0x5f0caa[_0x546eec(0x1ae)]()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x52eeff['update'](_0x4d6781,{'eloRating':_0x213942,'lastMatchDate':serverTimestamp(),'position':_0x86876c,'lastMatchId':_0x5cad2b}),_0x52eeff['update'](_0x507221,{'eloRating':_0x32ddb0,'lastMatchDate':serverTimestamp(),'position':_0xe397fc,'lastMatchId':_0x5cad2b}),await _0x52eeff['commit'](),console[_0x546eec(0x1b5)]('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD3({'playerId':_0x2ce784,'previousElo':_0x382bb7['eloRating']||0x4b0,'newElo':_0x213942,'opponentId':_0x556f3f,'matchResult':'win','previousPosition':_0x5e2fd1,'newPosition':_0x86876c,'isPromotion':_0x86876c<_0x5e2fd1,'matchId':_0x5cad2b,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x556f3f,'previousElo':_0x341a6c['eloRating']||0x4b0,'newElo':_0x32ddb0,'opponentId':_0x2ce784,'matchResult':'loss','previousPosition':_0x49392a,'newPosition':_0xe397fc,'isDemotion':_0xe397fc>_0x49392a,'matchId':_0x5cad2b,'timestamp':serverTimestamp()})]),!![];}catch(_0x13d2ef){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x13d2ef);throw _0x13d2ef;}}export async function approveReportD3(_0x12e588,_0x56653a,_0x4b8341,_0x202591){const _0x3f2083=a27_0x1cac;try{console[_0x3f2083(0x1b5)]('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x12e588,'winnerScore':_0x56653a,'winnerSuicides':_0x4b8341,'winnerComment':_0x202591});const _0x58de5a=auth['currentUser'];if(!_0x58de5a){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console[_0x3f2083(0x1b5)](_0x3f2083(0x1b7),_0x58de5a['email']);const _0x27e6ed=await getDoc(doc(db,'playersD3',_0x58de5a['uid'])),_0x615c6f=_0x27e6ed['exists']()?_0x27e6ed[_0x3f2083(0x1ae)]()[_0x3f2083(0x1ad)]:null;console['log']('Current\x20username:',_0x615c6f);const _0x34cf93=doc(db,'pendingMatchesD3',_0x12e588),_0x550552=await getDoc(_0x34cf93);if(!_0x550552['exists']()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x12e588);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x106f31=_0x550552['data']();console['log'](_0x3f2083(0x1b4),_0x106f31);if(_0x615c6f!==_0x106f31['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x3b1a39={..._0x106f31,'winnerScore':_0x56653a,'winnerSuicides':_0x4b8341,'winnerComment':_0x202591,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x615c6f,'createdAt':_0x106f31['createdAt']||serverTimestamp(),'winnerUsername':_0x106f31['winnerUsername'],'loserUsername':_0x106f31['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x12e588),_0x3b1a39),await deleteDoc(_0x34cf93),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x14f521,_0x27b8c4]=await Promise['all']([getDocs(query(collection(db,_0x3f2083(0x1bc)),where(_0x3f2083(0x1ad),'==',_0x106f31['winnerUsername']))),getDocs(query(collection(db,_0x3f2083(0x1bc)),where(_0x3f2083(0x1ad),'==',_0x106f31['loserUsername'])))]);if(_0x14f521['empty']||_0x27b8c4['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x46ffcb=_0x14f521['docs'][0x0]['id'],_0x4a6765=_0x27b8c4['docs'][0x0]['id'];return await updateEloRatingsD3(_0x46ffcb,_0x4a6765,_0x12e588),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x10c795){console['error']('Error\x20in\x20approveReportD3:',_0x10c795);throw _0x10c795;}}