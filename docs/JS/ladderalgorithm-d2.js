(function(_0x4d9ef3,_0x5d6214){const _0x4df9eb=a0_0x2891,_0xf0f967=_0x4d9ef3();while(!![]){try{const _0x265f9d=-parseInt(_0x4df9eb(0x15a))/0x1+-parseInt(_0x4df9eb(0x15c))/0x2+parseInt(_0x4df9eb(0x163))/0x3+-parseInt(_0x4df9eb(0x177))/0x4*(parseInt(_0x4df9eb(0x162))/0x5)+parseInt(_0x4df9eb(0x173))/0x6+-parseInt(_0x4df9eb(0x179))/0x7+-parseInt(_0x4df9eb(0x16b))/0x8*(-parseInt(_0x4df9eb(0x16a))/0x9);if(_0x265f9d===_0x5d6214)break;else _0xf0f967['push'](_0xf0f967['shift']());}catch(_0x3662b4){_0xf0f967['push'](_0xf0f967['shift']());}}}(a0_0x11ae,0xc6a67));const a0_0x3b4b7d=(function(){let _0x4863f4=!![];return function(_0x245768,_0x17cb19){const _0x38a8c3=_0x4863f4?function(){const _0x4c86db=a0_0x2891;if(_0x17cb19){const _0x18d694=_0x17cb19[_0x4c86db(0x16f)](_0x245768,arguments);return _0x17cb19=null,_0x18d694;}}:function(){};return _0x4863f4=![],_0x38a8c3;};}()),a0_0x580f04=a0_0x3b4b7d(this,function(){const _0x1a4f62=a0_0x2891;let _0x4caf2d;try{const _0x5c3653=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x4caf2d=_0x5c3653();}catch(_0x5988d9){_0x4caf2d=window;}const _0x2a0cb6=_0x4caf2d[_0x1a4f62(0x160)]=_0x4caf2d['console']||{},_0x4dff16=[_0x1a4f62(0x165),'warn','info','error','exception','table','trace'];for(let _0x2ceebf=0x0;_0x2ceebf<_0x4dff16['length'];_0x2ceebf++){const _0x36d868=a0_0x3b4b7d['constructor'][_0x1a4f62(0x15b)]['bind'](a0_0x3b4b7d),_0x2f05d8=_0x4dff16[_0x2ceebf],_0x4f418a=_0x2a0cb6[_0x2f05d8]||_0x36d868;_0x36d868['__proto__']=a0_0x3b4b7d[_0x1a4f62(0x16e)](a0_0x3b4b7d),_0x36d868[_0x1a4f62(0x166)]=_0x4f418a['toString']['bind'](_0x4f418a),_0x2a0cb6[_0x2f05d8]=_0x36d868;}});a0_0x580f04();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a0_0x11ae(){const _0x15c955=['D2\x20match\x20report\x20not\x20found','winnerUsername','win','console','pow','240tQJevQ','3886308pLqMqw','loserUsername','log','toString','Error\x20in\x20approveReportD2:','empty','loss','12863637lXRsDQ','8QnlLOA','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','uid','bind','apply','playersD2','One\x20or\x20both\x20D2\x20players\x20not\x20found','eloRating','3512916jPIejX','docs','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','match-d2','2164YEehjZ','data','9664249oTqdsD','commit','position','username','3067IZqWSs','prototype','2173804qDaIjp'];a0_0x11ae=function(){return _0x15c955;};return a0_0x11ae();}import{db,auth}from'./firebase-config.js';function a0_0x2891(_0x16a8a8,_0x163afb){const _0x5bf913=a0_0x11ae();return a0_0x2891=function(_0x580f04,_0x3b4b7d){_0x580f04=_0x580f04-0x159;let _0xcc80f1=_0x5bf913[_0x580f04];return _0xcc80f1;},a0_0x2891(_0x16a8a8,_0x163afb);}import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a0_0x265123 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x3beebc,_0x2d2a61,_0x52e43c=0x20){const _0x28e5c9=a0_0x2891,_0x4d3357=0x1/(0x1+Math[_0x28e5c9(0x161)](0xa,(_0x2d2a61-_0x3beebc)/0x190)),_0x104832=0x1/(0x1+Math['pow'](0xa,(_0x3beebc-_0x2d2a61)/0x190)),_0x274c83=_0x3beebc+_0x52e43c*(0x1-_0x4d3357),_0x18118e=_0x2d2a61+_0x52e43c*(0x0-_0x104832);return{'newWinnerRating':Math['round'](_0x274c83),'newLoserRating':Math['round'](_0x18118e)};}export async function updateEloRatingsD2(_0x6a187,_0x4b7827,_0x27d3a9){const _0x30c283=a0_0x2891;try{const _0x1e7ebd=writeBatch(db),_0x6045bb=doc(db,_0x30c283(0x170),_0x6a187),_0x1612c2=doc(db,'playersD2',_0x4b7827),[_0x5dd7b9,_0x26d186]=await Promise['all']([getDoc(_0x6045bb),getDoc(_0x1612c2)]);if(!_0x5dd7b9['exists']()||!_0x26d186['exists']())throw new Error(_0x30c283(0x171));const _0x3fed50=_0x5dd7b9['data'](),_0x11243f=_0x26d186[_0x30c283(0x178)](),_0x409242=_0x3fed50['position']||Number['MAX_SAFE_INTEGER'],_0x4c705c=_0x11243f['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x39aa89,newLoserRating:_0x194444}=calculateEloD2(_0x3fed50['eloRating']||0x4b0,_0x11243f[_0x30c283(0x172)]||0x4b0);let _0x327fdc=_0x409242,_0x38837e=_0x4c705c;if(_0x409242>_0x4c705c){console[_0x30c283(0x165)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x327fdc=_0x4c705c,_0x38837e=_0x4c705c+0x1;const _0x3fcdce=query(collection(db,'playersD2'),where('position','>',_0x4c705c),where(_0x30c283(0x17b),'<',_0x409242)),_0x27565c=await getDocs(_0x3fcdce);for(const _0x450b36 of _0x27565c['docs']){_0x450b36['id']!==_0x6a187&&_0x450b36['id']!==_0x4b7827&&_0x1e7ebd['update'](doc(db,'playersD2',_0x450b36['id']),{'position':_0x450b36['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x1e7ebd['update'](_0x6045bb,{'eloRating':_0x39aa89,'lastMatchDate':serverTimestamp(),'position':_0x327fdc,'lastMatchId':_0x27d3a9}),_0x1e7ebd['update'](_0x1612c2,{'eloRating':_0x194444,'lastMatchDate':serverTimestamp(),'position':_0x38837e,'lastMatchId':_0x27d3a9}),await _0x1e7ebd[_0x30c283(0x17a)](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x6a187,'previousElo':_0x3fed50['eloRating']||0x4b0,'newElo':_0x39aa89,'opponentId':_0x4b7827,'matchResult':_0x30c283(0x15f),'previousPosition':_0x409242,'newPosition':_0x327fdc,'isPromotion':_0x327fdc<_0x409242,'matchId':_0x27d3a9,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x4b7827,'previousElo':_0x11243f[_0x30c283(0x172)]||0x4b0,'newElo':_0x194444,'opponentId':_0x6a187,'matchResult':_0x30c283(0x169),'previousPosition':_0x4c705c,'newPosition':_0x38837e,'isDemotion':_0x38837e>_0x4c705c,'matchId':_0x27d3a9,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x6a187,_0x39aa89,_0x3fed50['eloRating'],{'source':_0x30c283(0x176),'matchId':_0x27d3a9}),await promotionManager['checkAndRecordPromotion'](_0x4b7827,_0x194444,_0x11243f['eloRating'],{'source':_0x30c283(0x176),'matchId':_0x27d3a9}),!![];}catch(_0x4ec26c){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x4ec26c);throw _0x4ec26c;}}export async function approveReportD2(_0x3a1a16,_0x306408,_0x530e3f,_0x53a961){const _0x5cf863=a0_0x2891;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x3a1a16,'winnerScore':_0x306408,'winnerSuicides':_0x530e3f,'winnerComment':_0x53a961});const _0x52d2ed=auth['currentUser'];if(!_0x52d2ed){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x52d2ed['email']);const _0x56b788=await getDoc(doc(db,'playersD2',_0x52d2ed[_0x5cf863(0x16d)])),_0xeac21f=_0x56b788['exists']()?_0x56b788[_0x5cf863(0x178)]()[_0x5cf863(0x159)]:null;console['log']('Current\x20username:',_0xeac21f);const _0x25c39a=doc(db,'pendingMatchesD2',_0x3a1a16),_0x1ea0e4=await getDoc(_0x25c39a);if(!_0x1ea0e4['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x3a1a16);throw new Error(_0x5cf863(0x15d));}const _0x597be4=_0x1ea0e4[_0x5cf863(0x178)]();console['log']('D2\x20Report\x20data:',_0x597be4);if(_0xeac21f!==_0x597be4['winnerUsername'])throw new Error(_0x5cf863(0x175));const _0x51b334={..._0x597be4,'winnerScore':_0x306408,'winnerSuicides':_0x530e3f,'winnerComment':_0x53a961,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0xeac21f,'createdAt':_0x597be4['createdAt']||serverTimestamp(),'winnerUsername':_0x597be4[_0x5cf863(0x15e)],'loserUsername':_0x597be4[_0x5cf863(0x164)]};await setDoc(doc(db,'approvedMatchesD2',_0x3a1a16),_0x51b334),await deleteDoc(_0x25c39a),console[_0x5cf863(0x165)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x2879e9,_0x1cf3e6]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where(_0x5cf863(0x159),'==',_0x597be4[_0x5cf863(0x15e)]))),getDocs(query(collection(db,_0x5cf863(0x170)),where('username','==',_0x597be4['loserUsername'])))]);if(_0x2879e9['empty']||_0x1cf3e6[_0x5cf863(0x168)])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0xaad6c4=_0x2879e9['docs'][0x0]['id'],_0x6e86d4=_0x1cf3e6[_0x5cf863(0x174)][0x0]['id'];return await updateEloRatingsD2(_0xaad6c4,_0x6e86d4,_0x3a1a16),console['log'](_0x5cf863(0x16c)),!![];}catch(_0x3e9c0a){console['error'](_0x5cf863(0x167),_0x3e9c0a);throw _0x3e9c0a;}}