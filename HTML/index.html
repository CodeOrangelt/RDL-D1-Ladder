<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
    <title>Redux Descent League</title>
    <link rel="icon" type="image/x-icon" href="../images/cloak.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../CSS/style.css">
    <link rel="stylesheet" href="../CSS/promotionlightbox.css">
    <link rel="stylesheet" href="../CSS/nav.css">
    <link rel="stylesheet" href="../CSS/footer.css">
    <link rel="stylesheet" href="../CSS/themes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="nav-placeholder"></div>
    
    <div id="mapping-competition-popup" class="mapping-competition-popup hidden" style="display: none;"> <!--CODE, THIS IS KEEPING IT HIDDEN :)-->
        <div class="mapping-popup-header">
            <h3 class="mapping-popup-title">
                <i class="fas fa-map small-icon"></i> RDL Map Competition<br>
                <span class="golden-text">HALLOWEEN 2025</span>
            </h3>
            <button class="mapping-popup-close" onclick="closeMappingPopup()" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mapping-popup-content">
            <p class="mapping-popup-subtitle">
                A new competition is brewing, and it's spooky...
            </p>
        </div>
        <button class="mapping-popup-button" onclick="goToMappingCompetition()">
            <i class="tiny-icon"></i> Take Me There!
        </button>
    </div>

    <main>
        <div id="promotion-banner-container" class="promotion-container"></div>
        <div class="ladder-switch">
            <input type="radio" id="d1-switch" name="ladder" value="D1" checked>
            <label for="d1-switch">D1 Solo's</label>
            
            <input type="radio" id="d2-switch" name="ladder" value="D2">
            <label for="d2-switch">D2 Solo's</label>
            
            <input type="radio" id="d3-switch" name="ladder" value="D3">
            <label for="d3-switch">D3 Solo's</label>
            
            <input type="radio" id="duos-switch" name="ladder" value="DUOS">
            <label for="duos-switch">Duo's</label>
            
            <input type="radio" id="ffa-switch" name="ladder" value="FFA">
            <label for="ffa-switch">FFA</label>
        </div>

        <div class="outer-container">
            <img src="../images/RDL.png" alt="Ladder Backdrop" class="ladder-backdrop">

            <div id="d1-ladder-container" class="ladder-container table-container active">
                <table id="ladder">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="d2-ladder-container" class="ladder-container table-container">
                <table id="ladder-d2">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="d3-ladder-container" class="ladder-container table-container">
                <table id="ladder-d3">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            
            <div id="duos-ladder-container" class="ladder-container table-container">
                <table id="ladder-duos">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                            <th>ELO</th>
                            <th>Matches</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>K/D</th>
                            <th>Win Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="ffa-ladder-container" class="ladder-container table-container" style="display: none;">
                <table id="ladder-ffa">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>ELO</th>
                            <th>Matches</th>
                            <th>Wins</th>
                            <th>Top 3</th>
                            <th>Avg Place</th>
                            <th>K/D</th>
                            <th>FFA Points</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

        <div id="ladder-retire-tiny-container" style="display: flex; gap: 8px; align-items: center;">
            <button id="leave-team-button" class="tiny-retire-button" style="display: none; background: #dc3545;">
                Leave Team
            </button>
            <button id="hiatus-button" class="tiny-retire-button" style="display: none; background: #f39c12;">
                Hiatus
            </button>
            <button id="tiny-retire-button" class="tiny-retire-button" style="display: none;">Retire</button>
        </div>
        <div id="ladder-join-tiny-container">
            <button id="tiny-join-button" class="tiny-join-button" style="display: none;">Join</button>
        </div>
        <div id="elo-toggle-container" style="position: absolute; bottom: 10px; left: 10px; z-index: 1000; pointer-events: auto;">
            <button id="toggle-elo-button" class="tiny-retire-button" style="background: #6c757d; cursor: pointer; pointer-events: auto;">
                Toggle ELO
            </button>
        </div>
        </div>

        <div id="leave-team-prompt" class="ladder-join-prompt" style="display: none;">
            <div class="ladder-join-message">
                <button class="close-button" style="position: absolute; top: 10px; right: 15px; background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">&times;</button>
                
                <p>Are you sure you want to leave your current team?</p>
                <p class="retire-warning">This will remove you from your current team and dissolve it. Your teammate will become a solo player, but you will remain on the DUOS ladder as a solo player and can form a new team.</p>
                <div class="join-form">
                    <label for="leave-team-username-input">Enter your username to confirm:</label>
                    <input type="text" id="leave-team-username-input" placeholder="Your username">
                    <button id="confirm-leave-team-button" class="join-ladder-button danger-button">Leave Team</button>
                </div>
                <span id="leave-team-status" class="ladder-join-status"></span>
            </div>
        </div>

        <div id="hiatus-prompt" class="ladder-join-prompt" style="display: none;">
            <div class="ladder-join-message">
                <button class="close-button" style="position: absolute; top: 10px; right: 15px; background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">&times;</button>
                <p>Are you sure you want to go on hiatus from the <span id="hiatus-ladder-type"></span> ladder?</p>
                <p class="retire-warning">This will temporarily remove you from the ladder rankings. You can return at any time with your same rank.</p>
                <div class="join-form">
                    <label for="hiatus-username-input">Enter your username to confirm:</label>
                    <input type="text" id="hiatus-username-input" placeholder="Your username">
                    <button id="confirm-hiatus-button" class="join-ladder-button warning-button">Go on Hiatus</button>
                </div>
                <span id="hiatus-status" class="ladder-join-status"></span>
            </div>
        </div>

        <div id="unhiatus-prompt" class="ladder-join-prompt" style="display: none;">
            <div class="ladder-join-message">
                <button class="close-button" style="position: absolute; top: 10px; right: 15px; background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer;">&times;</button>
                <p>Return to the <span id="unhiatus-ladder-type"></span> ladder?</p>
                <p>This will restore your previous rank and stats on the ladder.</p>
                <div class="join-form">
                    <label for="unhiatus-username-input">Enter your username to confirm:</label>
                    <input type="text" id="unhiatus-username-input" placeholder="Your username">
                    <button id="confirm-unhiatus-button" class="join-ladder-button success-button">Return to Ladder</button>
                </div>
                <span id="unhiatus-status" class="ladder-join-status"></span>
            </div>
        </div>
        
        <p id="elo-recommendation-text-d1" class="elo-recommendation-text ladder-d1"></p>
        <p id="elo-recommendation-text-d2" class="elo-recommendation-text ladder-d2" style="display: none;"></p>
        <p id="elo-recommendation-text-d3" class="elo-recommendation-text ladder-d3" style="display: none;"></p>
        <p id="elo-recommendation-text-duos" class="elo-recommendation-text ladder-duos" style="display: none;"></p>
        <p id="elo-recommendation-text-ffa" class="elo-recommendation-text ladder-ffa" style="display: none;"></p>
        <p id="elo-recommendation-text-ffa" class="elo-recommendation-text ladder-ffa" style="display: none;"></p>


        <div class="queue-section">
            <div id="queue-container">
                <div class="queue-box">
                    <h2>Waiting for a game</h2>
                    <div class="queue-list">
                    </div>
                </div>
            </div>
        </div>

        <br>

        <div id="ladder-join-prompt" class="ladder-join-prompt" style="display: none;">
            <div class="ladder-join-message">
                <p>Want to join the <span id="join-ladder-type"></span> ladder?</p>
                <div class="join-form">
                    <label for="join-username-input">Enter your username to confirm:</label>
                    <input type="text" id="join-username-input" placeholder="Your username">
                    <button id="join-ladder-button" class="join-ladder-button">Join</button>
                </div>
                <span id="ladder-join-status" class="ladder-join-status"></span>
            </div>
        </div>

        <div id="ladder-retire-section" class="section">
        </div>

        <div id="ladder-retire-prompt" class="ladder-join-prompt" style="display: none;">
            <div class="ladder-join-message">
                <p>Are you sure you want to retire from the <span id="retire-ladder-type"></span> ladder?</p>
                <p class="retire-warning">This will remove you from the ladder rankings. Your records will be preserved
                    but you will need to re-register if you want to participate again.</p>
                <div class="join-form">
                    <label for="retire-username-input">Enter your username to confirm:</label>
                    <input type="text" id="retire-username-input" placeholder="Your username">
                    <button id="retire-ladder-button" class="join-ladder-button danger-button">Retire from
                        Ladder</button>
                </div>
                <span id="ladder-retire-status" class="ladder-join-status"></span>
            </div>
        </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>
    <div id="promotion-banner-container"></div>
    
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"></script>

    <script src="../JS/page-components.js"></script>

    <script type="module" src="../JS/firebase-config.js"></script>
    <script type="module" src="../JS/current-user.js"></script>
    <script type="module" src="../JS/logout.js"></script>
    <script type="module" src="../JS/ladder.js"></script>
    <script type="module" src="../JS/ladderd2.js"></script>
    <script type="module" src="../JS/ladderd3.js"></script>
    <script type="module" src="../JS/queue.js"></script>
    <script type="module" src="../JS/promotions.js"></script>
    <script type="module" src="../JS/ladder-join.js"></script>
    <script type="module" src="../JS/ladder-retire.js"></script>
    <script type="module" src="../JS/ladderduos.js"></script>
    <script type="module" src="../JS/whosplaying.js"></script>
    <script src="../JS/announcements.js" defer></script>
    <script type="module" src="../JS/themes.js"></script>
    <script src="../JS/metadata.js"></script>

    <script>
        function closeMappingPopup() {
            const popup = document.getElementById('mapping-competition-popup');
            if (popup) {
                popup.classList.add('hidden');
                localStorage.setItem('mappingCompetitionPopupClosed', 'true');
            }
        }

        function goToMappingCompetition() {
            window.location.href = 'Mapcomp02.html';fetch
        }

        document.addEventListener('DOMContentLoaded', () => {
            const checkNavLoaded = setInterval(() => {
                const nav = document.querySelector('nav') || document.querySelector('.navbar');
                if (nav) {
                    clearInterval(checkNavLoaded);
                    
                    const popup = document.getElementById('mapping-competition-popup');
                    const wasClosed = localStorage.getItem('mappingCompetitionPopupClosed');
                    
                    if (!wasClosed && popup) {
                        setTimeout(() => {
                            popup.classList.remove('hidden');
                        }, 800);
                    }
                }
            }, 100);
            
            setTimeout(() => {
                clearInterval(checkNavLoaded);
                const popup = document.getElementById('mapping-competition-popup');
                const wasClosed = localStorage.getItem('mappingCompetitionPopupClosed');
                if (!wasClosed && popup) {
                    popup.classList.remove('hidden');
                }
            }, 5000);
        });
    </script>

      <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleEloButton = document.getElementById('toggle-elo-button');
            const eloToggleContainer = document.getElementById('elo-toggle-container');
            // Fix: Default to true if null/undefined, only hide if explicitly set to 'false'
            let eloVisible = localStorage.getItem('eloVisible') === null ? true : localStorage.getItem('eloVisible') === 'true';

            function applyEloVisibility() {
                const tables = ['#ladder', '#ladder-d2', '#ladder-d3', '#ladder-duos', '#ladder-ffa'];
                tables.forEach(tableSelector => {
                    const table = document.querySelector(tableSelector);
                    if (table) {
                        const headerRow = table.querySelector('thead tr');
                        if (headerRow) {
                            const headers = headerRow.querySelectorAll('th');
                            let eloColumnIndex = -1;
                            headers.forEach((header, index) => {
                                if (header.textContent.trim() === 'ELO') {
                                    eloColumnIndex = index;
                                }
                            });
                            if (eloColumnIndex !== -1) {
                                headers[eloColumnIndex].style.display = eloVisible ? '' : 'none';
                                // Batch update rows
                                const bodyRows = table.tBodies[0]?.rows;
                                if (bodyRows) {
                                    for (let row of bodyRows) {
                                        if (row.cells[eloColumnIndex]) {
                                            row.cells[eloColumnIndex].style.display = eloVisible ? '' : 'none';
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function updateButtonAppearance() {
                if (toggleEloButton) {
                    toggleEloButton.style.background = eloVisible ? '#6c757d' : '#28a745';
                    toggleEloButton.textContent = eloVisible ? 'Toggle ELO' : 'Show ELO';
                }
                
                // Hide/show ELO recommendations based on toggle state
                const recommendations = [
                    'elo-recommendation-text-d1',
                    'elo-recommendation-text-d2', 
                    'elo-recommendation-text-d3',
                    'elo-recommendation-text-duos',
                    'elo-recommendation-text-ffa'
                ];
                
                // Hide all recommendations first
                recommendations.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) {
                        elem.style.display = 'none';
                    }
                });

                // Only show the active ladder's recommendation if ELO is visible
                if (eloVisible) {
                    const d1Active = document.getElementById('d1-ladder-container')?.classList.contains('active');
                    const d2Active = document.getElementById('d2-ladder-container')?.classList.contains('active');
                    const d3Active = document.getElementById('d3-ladder-container')?.classList.contains('active');
                    const duosActive = document.getElementById('duos-ladder-container')?.classList.contains('active');
                    const ffaActive = document.getElementById('ffa-ladder-container')?.classList.contains('active'); // âœ… ADDED
                    
                    if (d1Active) {
                        const elem = document.getElementById('elo-recommendation-text-d1');
                        if (elem && elem.textContent.trim()) elem.style.display = 'block';
                    } else if (d2Active) {
                        const elem = document.getElementById('elo-recommendation-text-d2');
                        if (elem && elem.textContent.trim()) elem.style.display = 'block';
                    } else if (d3Active) {
                        const elem = document.getElementById('elo-recommendation-text-d3');
                        if (elem && elem.textContent.trim()) elem.style.display = 'block';
                    } else if (duosActive) {
                        const elem = document.getElementById('elo-recommendation-text-duos');
                        if (elem && elem.textContent.trim()) elem.style.display = 'block';
                    } else if (ffaActive) {
                        const elem = document.getElementById('elo-recommendation-text-ffa');
                        if (elem && elem.textContent.trim()) elem.style.display = 'block';
                    }
                }
            }

            // Use MutationObserver only, no polling
            const observer = new MutationObserver(applyEloVisibility);
            ['#ladder', '#ladder-d2', '#ladder-d3', '#ladder-duos', '#ladder-ffa'].forEach(sel => {
                const tbody = document.querySelector(sel + ' tbody');
                if (tbody) observer.observe(tbody, { childList: true, subtree: true });
            });

            applyEloVisibility();
            updateButtonAppearance();
            if (eloToggleContainer) eloToggleContainer.style.display = 'block';

            if (toggleEloButton) {
                toggleEloButton.addEventListener('click', () => {
                    eloVisible = !eloVisible;
                    localStorage.setItem('eloVisible', eloVisible.toString());
                    applyEloVisibility();
                    updateButtonAppearance();
                });
            }

            document.querySelectorAll('input[name="ladder"]').forEach(radio => {
                radio.addEventListener('change', () => setTimeout(() => {
                    applyEloVisibility();
                    updateButtonAppearance();
                }, 500));
            });
        });
    </script>

    <script>
        Object.keys(localStorage).forEach(key => {
            const value = localStorage.getItem(key);
            
            if (value && value.includes('[object Object]')) {
                localStorage.removeItem(key);
            }
        });

        Object.keys(sessionStorage).forEach(key => {
            const value = sessionStorage.getItem(key);
            
            if (value && value.includes('[object Object]')) {
                sessionStorage.removeItem(key);
            }
        });
    </script>

    <script type="module">
        import { auth } from '../JS/firebase-config.js';
        import { checkPendingMatches } from '../JS/checkPendingMatches.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            const checkNavLoaded = setInterval(() => {
                const reportMatchLink = document.querySelector('.nav-notification');
                if (reportMatchLink) {
                    clearInterval(checkNavLoaded);
                    
                    setTimeout(() => {
                        try {
                            checkPendingMatches();
                        } catch (err) {
                            console.error('Error checking pending matches on index page:', err);
                        }
                    }, 1000);
                    
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            setTimeout(() => checkPendingMatches(), 1000);
                        }
                    });
                }
            }, 200);
            
            setTimeout(() => clearInterval(checkNavLoaded), 10000);
        });
    </script>
</body>
</html>