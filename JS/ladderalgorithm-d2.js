function a28_0x4610(){const _0x461a34=['trace','empty','table','update','position','docs','Current\x20username:','D2\x20Match\x20moved\x20to\x20approved\x20collection','createdAt','winnerUsername','commit','Error\x20in\x20updateEloRatingsD2:','bind','checkAndRecordPromotion','error','exists','log','loss','data','all','toString','loserUsername','playersD2','prototype','constructor','console','Could\x20not\x20find\x20D2\x20player\x20documents','eloRating','return\x20(function()\x20'];a28_0x4610=function(){return _0x461a34;};return a28_0x4610();}const a28_0x20f1d9=(function(){let _0x5340bd=!![];return function(_0x5d6825,_0x59d74d){const _0x4aeda8=_0x5340bd?function(){if(_0x59d74d){const _0x3ffe9a=_0x59d74d['apply'](_0x5d6825,arguments);return _0x59d74d=null,_0x3ffe9a;}}:function(){};return _0x5340bd=![],_0x4aeda8;};}()),a28_0x2d48ae=a28_0x20f1d9(this,function(){const _0x301188=a28_0x247d,_0x156f61=function(){const _0x141fb0=a28_0x247d;let _0x5b9419;try{_0x5b9419=Function(_0x141fb0(0x196)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x3be6d1){_0x5b9419=window;}return _0x5b9419;},_0x1abb71=_0x156f61(),_0x22d1a5=_0x1abb71[_0x301188(0x193)]=_0x1abb71['console']||{},_0x761ec8=[_0x301188(0x18a),'warn','info','error','exception',_0x301188(0x17c),_0x301188(0x17a)];for(let _0x1be09a=0x0;_0x1be09a<_0x761ec8['length'];_0x1be09a++){const _0x259de0=a28_0x20f1d9[_0x301188(0x192)][_0x301188(0x191)][_0x301188(0x186)](a28_0x20f1d9),_0xc82a43=_0x761ec8[_0x1be09a],_0x2cdc96=_0x22d1a5[_0xc82a43]||_0x259de0;_0x259de0['__proto__']=a28_0x20f1d9[_0x301188(0x186)](a28_0x20f1d9),_0x259de0[_0x301188(0x18e)]=_0x2cdc96[_0x301188(0x18e)][_0x301188(0x186)](_0x2cdc96),_0x22d1a5[_0xc82a43]=_0x259de0;}});a28_0x2d48ae();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a28_0x247d(_0x181804,_0x5d57dc){const _0x2d48ae=a28_0x4610();return a28_0x247d=function(_0x20f1d9,_0x592fc7){_0x20f1d9=_0x20f1d9-0x17a;let _0x46105b=_0x2d48ae[_0x20f1d9];return _0x46105b;},a28_0x247d(_0x181804,_0x5d57dc);}import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x176d94 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0xd74e02,_0x1bb885,_0x3777e7=0x20){const _0x1cf26a=0x1/(0x1+Math['pow'](0xa,(_0x1bb885-_0xd74e02)/0x190)),_0xb35716=0x1/(0x1+Math['pow'](0xa,(_0xd74e02-_0x1bb885)/0x190)),_0x5d6fe9=_0xd74e02+_0x3777e7*(0x1-_0x1cf26a),_0x489747=_0x1bb885+_0x3777e7*(0x0-_0xb35716);return{'newWinnerRating':Math['round'](_0x5d6fe9),'newLoserRating':Math['round'](_0x489747)};}export async function updateEloRatingsD2(_0x5bf728,_0x538f6a,_0x3d020f){const _0x17ff21=a28_0x247d;try{const _0x4f3e27=writeBatch(db),_0x59c04c=doc(db,'playersD2',_0x5bf728),_0x5f1b45=doc(db,_0x17ff21(0x190),_0x538f6a),[_0x2d9de1,_0x1d6617]=await Promise['all']([getDoc(_0x59c04c),getDoc(_0x5f1b45)]);if(!_0x2d9de1['exists']()||!_0x1d6617[_0x17ff21(0x189)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x51981a=_0x2d9de1['data'](),_0x453809=_0x1d6617['data'](),_0x55bc03=_0x51981a[_0x17ff21(0x17e)]||Number['MAX_SAFE_INTEGER'],_0xb2f5a6=_0x453809['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x508527,newLoserRating:_0x203fd9}=calculateEloD2(_0x51981a['eloRating']||0x4b0,_0x453809['eloRating']||0x4b0);let _0x480914=_0x55bc03,_0x6d0b3c=_0xb2f5a6;if(_0x55bc03>_0xb2f5a6){console[_0x17ff21(0x18a)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x480914=_0xb2f5a6,_0x6d0b3c=_0xb2f5a6+0x1;const _0x1bcaee=query(collection(db,'playersD2'),where('position','>',_0xb2f5a6),where('position','<',_0x55bc03)),_0xd171fa=await getDocs(_0x1bcaee);for(const _0x39eaec of _0xd171fa['docs']){_0x39eaec['id']!==_0x5bf728&&_0x39eaec['id']!==_0x538f6a&&_0x4f3e27[_0x17ff21(0x17d)](doc(db,'playersD2',_0x39eaec['id']),{'position':_0x39eaec['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x4f3e27['update'](_0x59c04c,{'eloRating':_0x508527,'lastMatchDate':serverTimestamp(),'position':_0x480914,'lastMatchId':_0x3d020f}),_0x4f3e27['update'](_0x5f1b45,{'eloRating':_0x203fd9,'lastMatchDate':serverTimestamp(),'position':_0x6d0b3c,'lastMatchId':_0x3d020f}),await _0x4f3e27[_0x17ff21(0x184)](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x5bf728,'previousElo':_0x51981a['eloRating']||0x4b0,'newElo':_0x508527,'opponentId':_0x538f6a,'matchResult':'win','previousPosition':_0x55bc03,'newPosition':_0x480914,'isPromotion':_0x480914<_0x55bc03,'matchId':_0x3d020f,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x538f6a,'previousElo':_0x453809[_0x17ff21(0x195)]||0x4b0,'newElo':_0x203fd9,'opponentId':_0x5bf728,'matchResult':_0x17ff21(0x18b),'previousPosition':_0xb2f5a6,'newPosition':_0x6d0b3c,'isDemotion':_0x6d0b3c>_0xb2f5a6,'matchId':_0x3d020f,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x5bf728,_0x508527,_0x51981a['eloRating'],{'source':'match-d2','matchId':_0x3d020f}),await promotionManager[_0x17ff21(0x187)](_0x538f6a,_0x203fd9,_0x453809['eloRating'],{'source':'match-d2','matchId':_0x3d020f}),!![];}catch(_0x5d3a1d){console[_0x17ff21(0x188)](_0x17ff21(0x185),_0x5d3a1d);throw _0x5d3a1d;}}export async function approveReportD2(_0x27e445,_0x38bcb8,_0x49bbdf,_0x4c7667){const _0x9810b5=a28_0x247d;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x27e445,'winnerScore':_0x38bcb8,'winnerSuicides':_0x49bbdf,'winnerComment':_0x4c7667});const _0x13ef94=auth['currentUser'];if(!_0x13ef94){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x13ef94['email']);const _0x2394e3=await getDoc(doc(db,'playersD2',_0x13ef94['uid'])),_0x440f5d=_0x2394e3['exists']()?_0x2394e3['data']()['username']:null;console[_0x9810b5(0x18a)](_0x9810b5(0x180),_0x440f5d);const _0xef7c15=doc(db,'pendingMatchesD2',_0x27e445),_0x40e530=await getDoc(_0xef7c15);if(!_0x40e530[_0x9810b5(0x189)]()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x27e445);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x5c1eaf=_0x40e530[_0x9810b5(0x18c)]();console['log']('D2\x20Report\x20data:',_0x5c1eaf);if(_0x440f5d!==_0x5c1eaf['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x2ca23a={..._0x5c1eaf,'winnerScore':_0x38bcb8,'winnerSuicides':_0x49bbdf,'winnerComment':_0x4c7667,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x440f5d,'createdAt':_0x5c1eaf[_0x9810b5(0x182)]||serverTimestamp(),'winnerUsername':_0x5c1eaf[_0x9810b5(0x183)],'loserUsername':_0x5c1eaf['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x27e445),_0x2ca23a),await deleteDoc(_0xef7c15),console[_0x9810b5(0x18a)](_0x9810b5(0x181));const [_0x3848b8,_0x1caa4f]=await Promise[_0x9810b5(0x18d)]([getDocs(query(collection(db,_0x9810b5(0x190)),where('username','==',_0x5c1eaf['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x5c1eaf[_0x9810b5(0x18f)])))]);if(_0x3848b8['empty']||_0x1caa4f[_0x9810b5(0x17b)])throw new Error(_0x9810b5(0x194));const _0x3612e8=_0x3848b8['docs'][0x0]['id'],_0x2b0db7=_0x1caa4f[_0x9810b5(0x17f)][0x0]['id'];return await updateEloRatingsD2(_0x3612e8,_0x2b0db7,_0x27e445),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x243616){console['error']('Error\x20in\x20approveReportD2:',_0x243616);throw _0x243616;}}