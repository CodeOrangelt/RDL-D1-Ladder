const a29_0xd37913=(function(){let _0x5ae763=!![];return function(_0x354c1a,_0x430bed){const _0x1771b1=_0x5ae763?function(){const _0xa51f24=a29_0x2586;if(_0x430bed){const _0x245576=_0x430bed[_0xa51f24(0x17f)](_0x354c1a,arguments);return _0x430bed=null,_0x245576;}}:function(){};return _0x5ae763=![],_0x1771b1;};}()),a29_0x56de91=a29_0xd37913(this,function(){const _0x4fc2d3=a29_0x2586,_0x288ed8=function(){let _0x581f90;try{_0x581f90=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x48a584){_0x581f90=window;}return _0x581f90;},_0x420317=_0x288ed8(),_0x5e8ada=_0x420317[_0x4fc2d3(0x17e)]=_0x420317[_0x4fc2d3(0x17e)]||{},_0x1bf0b3=['log','warn',_0x4fc2d3(0x180),'error','exception','table','trace'];for(let _0x159e88=0x0;_0x159e88<_0x1bf0b3['length'];_0x159e88++){const _0x32cd86=a29_0xd37913['constructor']['prototype']['bind'](a29_0xd37913),_0x360de5=_0x1bf0b3[_0x159e88],_0x42745b=_0x5e8ada[_0x360de5]||_0x32cd86;_0x32cd86['__proto__']=a29_0xd37913['bind'](a29_0xd37913),_0x32cd86[_0x4fc2d3(0x18b)]=_0x42745b['toString'][_0x4fc2d3(0x183)](_0x42745b),_0x5e8ada[_0x360de5]=_0x32cd86;}});function a29_0x5286(){const _0x2f463c=['console','apply','info','playersD3','winnerUsername','bind','Current\x20user:','eloRating','loss','all','currentUser','D3\x20ELO\x20ratings\x20updated\x20successfully','round','toString','error','log','docs','Current\x20username:','data','uid','username','createdAt','exists'];a29_0x5286=function(){return _0x2f463c;};return a29_0x5286();}function a29_0x2586(_0x44759a,_0x4ca3cd){const _0x56de91=a29_0x5286();return a29_0x2586=function(_0xd37913,_0x5adb31){_0xd37913=_0xd37913-0x17e;let _0x5286d5=_0x56de91[_0xd37913];return _0x5286d5;},a29_0x2586(_0x44759a,_0x4ca3cd);}a29_0x56de91();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x5d72d4,_0x2e23bb,_0x305a58=0x20){const _0x5be1dd=a29_0x2586,_0x2c866f=0x1/(0x1+Math['pow'](0xa,(_0x2e23bb-_0x5d72d4)/0x190)),_0x1d6f02=0x1/(0x1+Math['pow'](0xa,(_0x5d72d4-_0x2e23bb)/0x190)),_0x445a51=_0x5d72d4+_0x305a58*(0x1-_0x2c866f),_0xd6d3f4=_0x2e23bb+_0x305a58*(0x0-_0x1d6f02);return{'newWinnerRating':Math[_0x5be1dd(0x18a)](_0x445a51),'newLoserRating':Math['round'](_0xd6d3f4)};}export async function updateEloRatingsD3(_0x299a0a,_0x1f736b,_0x40db10){const _0x5ed282=a29_0x2586;try{const _0x3bf6b7=writeBatch(db),_0x4f558f=doc(db,'playersD3',_0x299a0a),_0x4a8a20=doc(db,'playersD3',_0x1f736b),[_0x460acf,_0x347b82]=await Promise[_0x5ed282(0x187)]([getDoc(_0x4f558f),getDoc(_0x4a8a20)]);if(!_0x460acf['exists']()||!_0x347b82['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x7a1519=_0x460acf['data'](),_0x46c0ef=_0x347b82['data'](),_0x158e05=_0x7a1519['position']||Number['MAX_SAFE_INTEGER'],_0x5e915e=_0x46c0ef['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x86143e,newLoserRating:_0xb2033}=calculateEloD3(_0x7a1519['eloRating']||0x4b0,_0x46c0ef[_0x5ed282(0x185)]||0x4b0);let _0x4d2224=_0x158e05,_0x54e6fc=_0x5e915e;if(_0x158e05>_0x5e915e){console[_0x5ed282(0x18d)]('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4d2224=_0x5e915e,_0x54e6fc=_0x5e915e+0x1;const _0x42f282=query(collection(db,_0x5ed282(0x181)),where('position','>',_0x5e915e),where('position','<',_0x158e05)),_0xb0329f=await getDocs(_0x42f282);for(const _0x4cd17f of _0xb0329f[_0x5ed282(0x18e)]){_0x4cd17f['id']!==_0x299a0a&&_0x4cd17f['id']!==_0x1f736b&&_0x3bf6b7['update'](doc(db,'playersD3',_0x4cd17f['id']),{'position':_0x4cd17f['data']()['position']+0x1});}}else console[_0x5ed282(0x18d)]('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x3bf6b7['update'](_0x4f558f,{'eloRating':_0x86143e,'lastMatchDate':serverTimestamp(),'position':_0x4d2224,'lastMatchId':_0x40db10}),_0x3bf6b7['update'](_0x4a8a20,{'eloRating':_0xb2033,'lastMatchDate':serverTimestamp(),'position':_0x54e6fc,'lastMatchId':_0x40db10}),await _0x3bf6b7['commit'](),console['log'](_0x5ed282(0x189)),await Promise[_0x5ed282(0x187)]([recordEloChangeD3({'playerId':_0x299a0a,'previousElo':_0x7a1519['eloRating']||0x4b0,'newElo':_0x86143e,'opponentId':_0x1f736b,'matchResult':'win','previousPosition':_0x158e05,'newPosition':_0x4d2224,'isPromotion':_0x4d2224<_0x158e05,'matchId':_0x40db10,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x1f736b,'previousElo':_0x46c0ef['eloRating']||0x4b0,'newElo':_0xb2033,'opponentId':_0x299a0a,'matchResult':_0x5ed282(0x186),'previousPosition':_0x5e915e,'newPosition':_0x54e6fc,'isDemotion':_0x54e6fc>_0x5e915e,'matchId':_0x40db10,'timestamp':serverTimestamp()})]),!![];}catch(_0x3cf4cd){console[_0x5ed282(0x18c)]('Error\x20in\x20updateEloRatingsD3:',_0x3cf4cd);throw _0x3cf4cd;}}export async function approveReportD3(_0x44e038,_0x33dd08,_0x4901ed,_0x2278cc){const _0x53a991=a29_0x2586;try{console[_0x53a991(0x18d)]('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x44e038,'winnerScore':_0x33dd08,'winnerSuicides':_0x4901ed,'winnerComment':_0x2278cc});const _0x4ec8fe=auth[_0x53a991(0x188)];if(!_0x4ec8fe){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log'](_0x53a991(0x184),_0x4ec8fe['email']);const _0x3c9ed0=await getDoc(doc(db,'playersD3',_0x4ec8fe[_0x53a991(0x191)])),_0x24cd3b=_0x3c9ed0['exists']()?_0x3c9ed0[_0x53a991(0x190)]()['username']:null;console['log'](_0x53a991(0x18f),_0x24cd3b);const _0x36606e=doc(db,'pendingMatchesD3',_0x44e038),_0x5d8f1e=await getDoc(_0x36606e);if(!_0x5d8f1e[_0x53a991(0x194)]()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x44e038);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x1f3ee5=_0x5d8f1e['data']();console['log']('D3\x20Report\x20data:',_0x1f3ee5);if(_0x24cd3b!==_0x1f3ee5[_0x53a991(0x182)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0xce3f4c={..._0x1f3ee5,'winnerScore':_0x33dd08,'winnerSuicides':_0x4901ed,'winnerComment':_0x2278cc,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x24cd3b,'createdAt':_0x1f3ee5[_0x53a991(0x193)]||serverTimestamp(),'winnerUsername':_0x1f3ee5[_0x53a991(0x182)],'loserUsername':_0x1f3ee5['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x44e038),_0xce3f4c),await deleteDoc(_0x36606e),console[_0x53a991(0x18d)]('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x52fd5b,_0xa3532b]=await Promise['all']([getDocs(query(collection(db,_0x53a991(0x181)),where(_0x53a991(0x192),'==',_0x1f3ee5['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x53a991(0x192),'==',_0x1f3ee5['loserUsername'])))]);if(_0x52fd5b['empty']||_0xa3532b['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x49314d=_0x52fd5b['docs'][0x0]['id'],_0x57bf1c=_0xa3532b['docs'][0x0]['id'];return await updateEloRatingsD3(_0x49314d,_0x57bf1c,_0x44e038),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x4029de){console[_0x53a991(0x18c)]('Error\x20in\x20approveReportD3:',_0x4029de);throw _0x4029de;}}