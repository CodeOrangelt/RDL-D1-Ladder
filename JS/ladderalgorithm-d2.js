function a26_0x40d2(_0x17f3d2,_0x3d3c7e){const _0x2f646e=a26_0x59a9();return a26_0x40d2=function(_0x8fa5c3,_0x48fad7){_0x8fa5c3=_0x8fa5c3-0xb7;let _0x59a923=_0x2f646e[_0x8fa5c3];return _0x59a923;},a26_0x40d2(_0x17f3d2,_0x3d3c7e);}const a26_0x8fa5c3=(function(){let _0x4dd11d=!![];return function(_0x5e3aa1,_0x230141){const _0x10e5a7=_0x4dd11d?function(){if(_0x230141){const _0x16f2fd=_0x230141['apply'](_0x5e3aa1,arguments);return _0x230141=null,_0x16f2fd;}}:function(){};return _0x4dd11d=![],_0x10e5a7;};}()),a26_0x2f646e=a26_0x8fa5c3(this,function(){const _0x4d617e=a26_0x40d2,_0xdcb42e=function(){const _0x20a725=a26_0x40d2;let _0x51fca8;try{_0x51fca8=Function('return\x20(function()\x20'+_0x20a725(0xb8)+');')();}catch(_0x36de90){_0x51fca8=window;}return _0x51fca8;},_0x2fb086=_0xdcb42e(),_0x3eb8e1=_0x2fb086[_0x4d617e(0xb9)]=_0x2fb086['console']||{},_0x2d29a1=['log','warn','info',_0x4d617e(0xc9),'exception','table',_0x4d617e(0xbc)];for(let _0x1d0323=0x0;_0x1d0323<_0x2d29a1['length'];_0x1d0323++){const _0x1af70e=a26_0x8fa5c3[_0x4d617e(0xc5)]['prototype']['bind'](a26_0x8fa5c3),_0x2418fd=_0x2d29a1[_0x1d0323],_0x18b738=_0x3eb8e1[_0x2418fd]||_0x1af70e;_0x1af70e['__proto__']=a26_0x8fa5c3[_0x4d617e(0xbe)](a26_0x8fa5c3),_0x1af70e['toString']=_0x18b738['toString'][_0x4d617e(0xbe)](_0x18b738),_0x3eb8e1[_0x2418fd]=_0x1af70e;}});a26_0x2f646e();function a26_0x59a9(){const _0x19b8b6=['Could\x20not\x20find\x20D2\x20player\x20documents','{}.constructor(\x22return\x20this\x22)(\x20)','console','exists','log','trace','docs','bind','data','pendingMatchesD2','D2\x20match\x20report\x20not\x20found','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','empty','constructor','playersD2','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','One\x20or\x20both\x20D2\x20players\x20not\x20found','error','winnerUsername','eloRating','approvedMatchesD2','all','currentUser'];a26_0x59a9=function(){return _0x19b8b6;};return a26_0x59a9();}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x380367 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0xe6bf0f,_0x570e2c,_0x1ec7cf=0x20){const _0x1e7d4f=0x1/(0x1+Math['pow'](0xa,(_0x570e2c-_0xe6bf0f)/0x190)),_0x4a5dca=0x1/(0x1+Math['pow'](0xa,(_0xe6bf0f-_0x570e2c)/0x190)),_0x2a6535=_0xe6bf0f+_0x1ec7cf*(0x1-_0x1e7d4f),_0x5921f7=_0x570e2c+_0x1ec7cf*(0x0-_0x4a5dca);return{'newWinnerRating':Math['round'](_0x2a6535),'newLoserRating':Math['round'](_0x5921f7)};}export async function updateEloRatingsD2(_0x3c8bd3,_0x2d70a7,_0x34333c){const _0x42f9dc=a26_0x40d2;try{const _0x1616a4=writeBatch(db),_0x2d386c=doc(db,'playersD2',_0x3c8bd3),_0x237d7c=doc(db,_0x42f9dc(0xc6),_0x2d70a7),[_0x2332e3,_0x56bc04]=await Promise[_0x42f9dc(0xcd)]([getDoc(_0x2d386c),getDoc(_0x237d7c)]);if(!_0x2332e3[_0x42f9dc(0xba)]()||!_0x56bc04['exists']())throw new Error(_0x42f9dc(0xc8));const _0x1d5dc4=_0x2332e3[_0x42f9dc(0xbf)](),_0x12345e=_0x56bc04['data'](),_0x17c514=_0x1d5dc4['position']||Number['MAX_SAFE_INTEGER'],_0x5c8e85=_0x12345e['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x4687a6,newLoserRating:_0x202257}=calculateEloD2(_0x1d5dc4['eloRating']||0x4b0,_0x12345e[_0x42f9dc(0xcb)]||0x4b0);let _0x27faa5=_0x17c514,_0x469eed=_0x5c8e85;if(_0x17c514>_0x5c8e85){console[_0x42f9dc(0xbb)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x27faa5=_0x5c8e85,_0x469eed=_0x5c8e85+0x1;const _0xad2f0e=query(collection(db,'playersD2'),where('position','>',_0x5c8e85),where('position','<',_0x17c514)),_0x185be2=await getDocs(_0xad2f0e);for(const _0x21443a of _0x185be2['docs']){_0x21443a['id']!==_0x3c8bd3&&_0x21443a['id']!==_0x2d70a7&&_0x1616a4['update'](doc(db,'playersD2',_0x21443a['id']),{'position':_0x21443a[_0x42f9dc(0xbf)]()['position']+0x1});}}else console['log'](_0x42f9dc(0xc3));return _0x1616a4['update'](_0x2d386c,{'eloRating':_0x4687a6,'lastMatchDate':serverTimestamp(),'position':_0x27faa5,'lastMatchId':_0x34333c}),_0x1616a4['update'](_0x237d7c,{'eloRating':_0x202257,'lastMatchDate':serverTimestamp(),'position':_0x469eed,'lastMatchId':_0x34333c}),await _0x1616a4['commit'](),console[_0x42f9dc(0xbb)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x3c8bd3,'previousElo':_0x1d5dc4['eloRating']||0x4b0,'newElo':_0x4687a6,'opponentId':_0x2d70a7,'matchResult':'win','previousPosition':_0x17c514,'newPosition':_0x27faa5,'isPromotion':_0x27faa5<_0x17c514,'matchId':_0x34333c,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x2d70a7,'previousElo':_0x12345e['eloRating']||0x4b0,'newElo':_0x202257,'opponentId':_0x3c8bd3,'matchResult':'loss','previousPosition':_0x5c8e85,'newPosition':_0x469eed,'isDemotion':_0x469eed>_0x5c8e85,'matchId':_0x34333c,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x3c8bd3,_0x4687a6,_0x1d5dc4['eloRating'],{'source':'match-d2','matchId':_0x34333c}),await promotionManager['checkAndRecordPromotion'](_0x2d70a7,_0x202257,_0x12345e[_0x42f9dc(0xcb)],{'source':'match-d2','matchId':_0x34333c}),!![];}catch(_0x2e599a){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x2e599a);throw _0x2e599a;}}export async function approveReportD2(_0x30f6de,_0x2e1e0f,_0x179c92,_0x5d500d){const _0x5be79d=a26_0x40d2;try{console[_0x5be79d(0xbb)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x30f6de,'winnerScore':_0x2e1e0f,'winnerSuicides':_0x179c92,'winnerComment':_0x5d500d});const _0x4d0677=auth[_0x5be79d(0xce)];if(!_0x4d0677){console['log']('No\x20user\x20logged\x20in');throw new Error(_0x5be79d(0xc7));}console['log']('Current\x20user:',_0x4d0677['email']);const _0x1ca901=await getDoc(doc(db,'playersD2',_0x4d0677['uid'])),_0x1d25a8=_0x1ca901[_0x5be79d(0xba)]()?_0x1ca901['data']()['username']:null;console[_0x5be79d(0xbb)]('Current\x20username:',_0x1d25a8);const _0x368e07=doc(db,_0x5be79d(0xc0),_0x30f6de),_0x55ff4b=await getDoc(_0x368e07);if(!_0x55ff4b[_0x5be79d(0xba)]()){console[_0x5be79d(0xbb)]('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x30f6de);throw new Error(_0x5be79d(0xc1));}const _0x4cc9aa=_0x55ff4b['data']();console[_0x5be79d(0xbb)]('D2\x20Report\x20data:',_0x4cc9aa);if(_0x1d25a8!==_0x4cc9aa['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x3ee348={..._0x4cc9aa,'winnerScore':_0x2e1e0f,'winnerSuicides':_0x179c92,'winnerComment':_0x5d500d,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1d25a8,'createdAt':_0x4cc9aa['createdAt']||serverTimestamp(),'winnerUsername':_0x4cc9aa[_0x5be79d(0xca)],'loserUsername':_0x4cc9aa['loserUsername']};await setDoc(doc(db,_0x5be79d(0xcc),_0x30f6de),_0x3ee348),await deleteDoc(_0x368e07),console[_0x5be79d(0xbb)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x4eb408,_0x160209]=await Promise[_0x5be79d(0xcd)]([getDocs(query(collection(db,_0x5be79d(0xc6)),where('username','==',_0x4cc9aa[_0x5be79d(0xca)]))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x4cc9aa['loserUsername'])))]);if(_0x4eb408[_0x5be79d(0xc4)]||_0x160209[_0x5be79d(0xc4)])throw new Error(_0x5be79d(0xb7));const _0x48d97c=_0x4eb408[_0x5be79d(0xbd)][0x0]['id'],_0x2184eb=_0x160209['docs'][0x0]['id'];return await updateEloRatingsD2(_0x48d97c,_0x2184eb,_0x30f6de),console[_0x5be79d(0xbb)](_0x5be79d(0xc2)),!![];}catch(_0x15f76a){console['error']('Error\x20in\x20approveReportD2:',_0x15f76a);throw _0x15f76a;}}