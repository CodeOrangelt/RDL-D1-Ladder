(function(_0x365e87,_0x27c2bf){const _0x383799=a0_0x47a3,_0x56ddcd=_0x365e87();while(!![]){try{const _0x1a195e=-parseInt(_0x383799(0x1a8))/0x1+-parseInt(_0x383799(0x194))/0x2+-parseInt(_0x383799(0x1a6))/0x3+-parseInt(_0x383799(0x19d))/0x4+-parseInt(_0x383799(0x192))/0x5*(parseInt(_0x383799(0x1a9))/0x6)+-parseInt(_0x383799(0x1ad))/0x7*(-parseInt(_0x383799(0x1b2))/0x8)+parseInt(_0x383799(0x1aa))/0x9;if(_0x1a195e===_0x27c2bf)break;else _0x56ddcd['push'](_0x56ddcd['shift']());}catch(_0x2cf099){_0x56ddcd['push'](_0x56ddcd['shift']());}}}(a0_0x4fa3,0xd6ed7));const a0_0x292d8c=(function(){let _0x1514f0=!![];return function(_0x5ab23c,_0x2d3124){const _0x5da3bc=_0x1514f0?function(){const _0x13ac9b=a0_0x47a3;if(_0x2d3124){const _0x330b18=_0x2d3124[_0x13ac9b(0x19e)](_0x5ab23c,arguments);return _0x2d3124=null,_0x330b18;}}:function(){};return _0x1514f0=![],_0x5da3bc;};}()),a0_0x40ceac=a0_0x292d8c(this,function(){const _0x2570b5=a0_0x47a3,_0x23facf=function(){const _0x39264c=a0_0x47a3;let _0x1301fd;try{_0x1301fd=Function(_0x39264c(0x196)+_0x39264c(0x193)+');')();}catch(_0x40b3b7){_0x1301fd=window;}return _0x1301fd;},_0x2e7fcb=_0x23facf(),_0x2d872a=_0x2e7fcb[_0x2570b5(0x19a)]=_0x2e7fcb['console']||{},_0x527734=['log','warn','info','error','exception','table','trace'];for(let _0x361e23=0x0;_0x361e23<_0x527734['length'];_0x361e23++){const _0x48eb21=a0_0x292d8c['constructor']['prototype']['bind'](a0_0x292d8c),_0x3893b5=_0x527734[_0x361e23],_0x43572f=_0x2d872a[_0x3893b5]||_0x48eb21;_0x48eb21[_0x2570b5(0x1a1)]=a0_0x292d8c['bind'](a0_0x292d8c),_0x48eb21['toString']=_0x43572f[_0x2570b5(0x1b5)]['bind'](_0x43572f),_0x2d872a[_0x3893b5]=_0x48eb21;}});function a0_0x4fa3(){const _0x336cde=['__proto__','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','log','data','commit','3122559AbKQsT','exists','969230QWjrrM','8743548LxdTlJ','39512844ZSWosh','error','playersD2','3017ZSnfVu','eloRating','docs','pow','MAX_SAFE_INTEGER','15816mElhww','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','round','toString','5OqlyMk','{}.constructor(\x22return\x20this\x22)(\x20)','993906CKozhf','No\x20user\x20logged\x20in','return\x20(function()\x20','Error\x20in\x20approveReportD2:','position','Current\x20username:','console','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','match-d2','1591064qJHpCP','apply','loserUsername','loss'];a0_0x4fa3=function(){return _0x336cde;};return a0_0x4fa3();}a0_0x40ceac();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a0_0x47a3(_0x402b23,_0x258124){const _0x4fc0ec=a0_0x4fa3();return a0_0x47a3=function(_0x40ceac,_0x292d8c){_0x40ceac=_0x40ceac-0x192;let _0x4f31a4=_0x4fc0ec[_0x40ceac];return _0x4f31a4;},a0_0x47a3(_0x402b23,_0x258124);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a0_0x48e719 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x493aa2,_0x1da606,_0x1ebc32=0x20){const _0x522dc4=a0_0x47a3,_0x20cecb=0x1/(0x1+Math['pow'](0xa,(_0x1da606-_0x493aa2)/0x190)),_0x476c28=0x1/(0x1+Math[_0x522dc4(0x1b0)](0xa,(_0x493aa2-_0x1da606)/0x190)),_0x29c2fb=_0x493aa2+_0x1ebc32*(0x1-_0x20cecb),_0x5dc0ec=_0x1da606+_0x1ebc32*(0x0-_0x476c28);return{'newWinnerRating':Math[_0x522dc4(0x1b4)](_0x29c2fb),'newLoserRating':Math['round'](_0x5dc0ec)};}export async function updateEloRatingsD2(_0x3e99ba,_0x2e08bf,_0x48a09f){const _0x467642=a0_0x47a3;try{const _0x5852b8=writeBatch(db),_0x13619a=doc(db,'playersD2',_0x3e99ba),_0x4f379e=doc(db,_0x467642(0x1ac),_0x2e08bf),[_0x386e27,_0x5110ac]=await Promise['all']([getDoc(_0x13619a),getDoc(_0x4f379e)]);if(!_0x386e27['exists']()||!_0x5110ac[_0x467642(0x1a7)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x28c72=_0x386e27['data'](),_0x505758=_0x5110ac['data'](),_0x4aa0f8=_0x28c72['position']||Number['MAX_SAFE_INTEGER'],_0x3703e5=_0x505758['position']||Number[_0x467642(0x1b1)],{newWinnerRating:_0x4197be,newLoserRating:_0x2966df}=calculateEloD2(_0x28c72['eloRating']||0x4b0,_0x505758['eloRating']||0x4b0);let _0x152708=_0x4aa0f8,_0x2a7853=_0x3703e5;if(_0x4aa0f8>_0x3703e5){console['log'](_0x467642(0x1b3)),_0x152708=_0x3703e5,_0x2a7853=_0x3703e5+0x1;const _0x280a3a=query(collection(db,'playersD2'),where('position','>',_0x3703e5),where(_0x467642(0x198),'<',_0x4aa0f8)),_0x872a8a=await getDocs(_0x280a3a);for(const _0x1e4d19 of _0x872a8a[_0x467642(0x1af)]){_0x1e4d19['id']!==_0x3e99ba&&_0x1e4d19['id']!==_0x2e08bf&&_0x5852b8['update'](doc(db,'playersD2',_0x1e4d19['id']),{'position':_0x1e4d19['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x5852b8['update'](_0x13619a,{'eloRating':_0x4197be,'lastMatchDate':serverTimestamp(),'position':_0x152708,'lastMatchId':_0x48a09f}),_0x5852b8['update'](_0x4f379e,{'eloRating':_0x2966df,'lastMatchDate':serverTimestamp(),'position':_0x2a7853,'lastMatchId':_0x48a09f}),await _0x5852b8[_0x467642(0x1a5)](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x3e99ba,'previousElo':_0x28c72['eloRating']||0x4b0,'newElo':_0x4197be,'opponentId':_0x2e08bf,'matchResult':'win','previousPosition':_0x4aa0f8,'newPosition':_0x152708,'isPromotion':_0x152708<_0x4aa0f8,'matchId':_0x48a09f,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x2e08bf,'previousElo':_0x505758['eloRating']||0x4b0,'newElo':_0x2966df,'opponentId':_0x3e99ba,'matchResult':_0x467642(0x1a0),'previousPosition':_0x3703e5,'newPosition':_0x2a7853,'isDemotion':_0x2a7853>_0x3703e5,'matchId':_0x48a09f,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x3e99ba,_0x4197be,_0x28c72[_0x467642(0x1ae)],{'source':'match-d2','matchId':_0x48a09f}),await promotionManager['checkAndRecordPromotion'](_0x2e08bf,_0x2966df,_0x505758['eloRating'],{'source':_0x467642(0x19c),'matchId':_0x48a09f}),!![];}catch(_0x20a63d){console[_0x467642(0x1ab)]('Error\x20in\x20updateEloRatingsD2:',_0x20a63d);throw _0x20a63d;}}export async function approveReportD2(_0x3c48fe,_0x2a7ad6,_0x4eef0e,_0x5a7bf2){const _0x44c42b=a0_0x47a3;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x3c48fe,'winnerScore':_0x2a7ad6,'winnerSuicides':_0x4eef0e,'winnerComment':_0x5a7bf2});const _0x19b9a9=auth['currentUser'];if(!_0x19b9a9){console['log'](_0x44c42b(0x195));throw new Error(_0x44c42b(0x19b));}console['log']('Current\x20user:',_0x19b9a9['email']);const _0x9a3dc6=await getDoc(doc(db,_0x44c42b(0x1ac),_0x19b9a9['uid'])),_0x41997e=_0x9a3dc6[_0x44c42b(0x1a7)]()?_0x9a3dc6['data']()['username']:null;console[_0x44c42b(0x1a3)](_0x44c42b(0x199),_0x41997e);const _0x40e9b6=doc(db,'pendingMatchesD2',_0x3c48fe),_0x3d7502=await getDoc(_0x40e9b6);if(!_0x3d7502['exists']()){console[_0x44c42b(0x1a3)]('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x3c48fe);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x2b5298=_0x3d7502[_0x44c42b(0x1a4)]();console['log']('D2\x20Report\x20data:',_0x2b5298);if(_0x41997e!==_0x2b5298['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x55e386={..._0x2b5298,'winnerScore':_0x2a7ad6,'winnerSuicides':_0x4eef0e,'winnerComment':_0x5a7bf2,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x41997e,'createdAt':_0x2b5298['createdAt']||serverTimestamp(),'winnerUsername':_0x2b5298['winnerUsername'],'loserUsername':_0x2b5298[_0x44c42b(0x19f)]};await setDoc(doc(db,'approvedMatchesD2',_0x3c48fe),_0x55e386),await deleteDoc(_0x40e9b6),console[_0x44c42b(0x1a3)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x50e3f8,_0x2ebf0f]=await Promise['all']([getDocs(query(collection(db,_0x44c42b(0x1ac)),where('username','==',_0x2b5298['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x2b5298[_0x44c42b(0x19f)])))]);if(_0x50e3f8['empty']||_0x2ebf0f['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x3ec921=_0x50e3f8['docs'][0x0]['id'],_0x5c3dc1=_0x2ebf0f['docs'][0x0]['id'];return await updateEloRatingsD2(_0x3ec921,_0x5c3dc1,_0x3c48fe),console['log'](_0x44c42b(0x1a2)),!![];}catch(_0x21c08e){console['error'](_0x44c42b(0x197),_0x21c08e);throw _0x21c08e;}}