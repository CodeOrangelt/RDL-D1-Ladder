const a30_0x20fa90=(function(){let _0xc982ba=!![];return function(_0x3bb65c,_0x4236a4){const _0x4afa5c=_0xc982ba?function(){const _0x221a1d=a30_0x3967;if(_0x4236a4){const _0x570899=_0x4236a4[_0x221a1d(0x166)](_0x3bb65c,arguments);return _0x4236a4=null,_0x570899;}}:function(){};return _0xc982ba=![],_0x4afa5c;};}()),a30_0x18f266=a30_0x20fa90(this,function(){const _0x19779b=a30_0x3967;let _0x511e68;try{const _0x4a8614=Function(_0x19779b(0x13b)+_0x19779b(0x154)+');');_0x511e68=_0x4a8614();}catch(_0x173968){_0x511e68=window;}const _0xed4eba=_0x511e68[_0x19779b(0x133)]=_0x511e68[_0x19779b(0x133)]||{},_0x9f99c4=[_0x19779b(0x162),_0x19779b(0x163),_0x19779b(0x143),_0x19779b(0x132),_0x19779b(0x14c),_0x19779b(0x158),_0x19779b(0x139)];for(let _0x34e341=0x0;_0x34e341<_0x9f99c4[_0x19779b(0x13c)];_0x34e341++){const _0x11c08e=a30_0x20fa90[_0x19779b(0x15a)][_0x19779b(0x129)][_0x19779b(0x161)](a30_0x20fa90),_0x54d046=_0x9f99c4[_0x34e341],_0x408c87=_0xed4eba[_0x54d046]||_0x11c08e;_0x11c08e[_0x19779b(0x131)]=a30_0x20fa90[_0x19779b(0x161)](a30_0x20fa90),_0x11c08e[_0x19779b(0x13d)]=_0x408c87[_0x19779b(0x13d)][_0x19779b(0x161)](_0x408c87),_0xed4eba[_0x54d046]=_0x11c08e;}});a30_0x18f266();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a30_0x3967(_0x282504,_0x551f6a){_0x282504=_0x282504-0x127;const _0x18f266=a30_0x3262();let _0x20fa90=_0x18f266[_0x282504];return _0x20fa90;}import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import{checkAndAwardTopRankRibbon}from'./ribbons.js';export function calculateEloD2(_0x3dca1f,_0x35bfff,_0x5427c1=0x20){const _0xc2a687=a30_0x3967,_0x3ecb38=0x1/(0x1+Math[_0xc2a687(0x16a)](0xa,(_0x35bfff-_0x3dca1f)/0x190)),_0x501260=0x1/(0x1+Math[_0xc2a687(0x16a)](0xa,(_0x3dca1f-_0x35bfff)/0x190)),_0x2f826e=_0x3dca1f+_0x5427c1*(0x1-_0x3ecb38),_0x8b04b4=_0x35bfff+_0x5427c1*(0x0-_0x501260);return{'newWinnerRating':Math[_0xc2a687(0x147)](_0x2f826e),'newLoserRating':Math[_0xc2a687(0x147)](_0x8b04b4)};}export async function updateEloRatingsD2(_0x5cf8d3,_0x205d46,_0x4c7b73){const _0x4fa2b3=a30_0x3967;try{const _0x41fc0c=writeBatch(db),_0x2c95b2=doc(db,_0x4fa2b3(0x168),_0x5cf8d3),_0xcac083=doc(db,_0x4fa2b3(0x168),_0x205d46),[_0x3feb35,_0x5797c6]=await Promise[_0x4fa2b3(0x12c)]([getDoc(_0x2c95b2),getDoc(_0xcac083)]);if(!_0x3feb35[_0x4fa2b3(0x15e)]()||!_0x5797c6[_0x4fa2b3(0x15e)]())throw new Error(_0x4fa2b3(0x15b));const _0x5d5c04=_0x3feb35[_0x4fa2b3(0x12d)](),_0x2a2430=_0x5797c6[_0x4fa2b3(0x12d)](),_0x4edfa7=_0x5d5c04[_0x4fa2b3(0x12f)]||Number[_0x4fa2b3(0x151)],_0x581a95=_0x2a2430[_0x4fa2b3(0x12f)]||Number[_0x4fa2b3(0x151)],_0x172e68=_0x5d5c04[_0x4fa2b3(0x152)]||0xc8,_0x40f87c=_0x2a2430[_0x4fa2b3(0x152)]||0xc8,_0x4068a8=(_0x5d5c04[_0x4fa2b3(0x135)]||0x0)+(_0x5d5c04[_0x4fa2b3(0x14d)]||0x0),_0x2cc76d=(_0x2a2430[_0x4fa2b3(0x135)]||0x0)+(_0x2a2430[_0x4fa2b3(0x14d)]||0x0),_0x23af62=_0x4068a8>0x0?(_0x5d5c04[_0x4fa2b3(0x135)]||0x0)/_0x4068a8*0x64:0x0,_0xbeeace=_0x2cc76d>0x0?(_0x2a2430[_0x4fa2b3(0x135)]||0x0)/_0x2cc76d*0x64:0x0,{newWinnerRating:_0x5758f8,newLoserRating:_0x18370b}=calculateEloD2(_0x172e68,_0x40f87c);let _0x4ebe3e=_0x4edfa7,_0x2d10fe=_0x581a95;if(_0x4edfa7>_0x581a95){console[_0x4fa2b3(0x162)](_0x4fa2b3(0x13e)),_0x4ebe3e=_0x581a95,_0x2d10fe=_0x581a95+0x1;const _0x884a05=query(collection(db,_0x4fa2b3(0x168)),where(_0x4fa2b3(0x12f),'>',_0x581a95),where(_0x4fa2b3(0x12f),'<',_0x4edfa7)),_0x19640e=await getDocs(_0x884a05);for(const _0x245c94 of _0x19640e[_0x4fa2b3(0x155)]){_0x245c94['id']!==_0x5cf8d3&&_0x245c94['id']!==_0x205d46&&_0x41fc0c[_0x4fa2b3(0x15c)](doc(db,_0x4fa2b3(0x168),_0x245c94['id']),{'position':_0x245c94[_0x4fa2b3(0x12d)]()[_0x4fa2b3(0x12f)]+0x1});}}else console[_0x4fa2b3(0x162)](_0x4fa2b3(0x146));_0x41fc0c[_0x4fa2b3(0x15c)](_0x2c95b2,{'eloRating':_0x5758f8,'lastMatchDate':serverTimestamp(),'position':_0x4ebe3e,'lastMatchId':_0x4c7b73}),_0x41fc0c[_0x4fa2b3(0x15c)](_0xcac083,{'eloRating':_0x18370b,'lastMatchDate':serverTimestamp(),'position':_0x2d10fe,'lastMatchId':_0x4c7b73}),await _0x41fc0c[_0x4fa2b3(0x160)](),console[_0x4fa2b3(0x162)](_0x4fa2b3(0x169));const _0x440276=serverTimestamp();return await Promise[_0x4fa2b3(0x12c)]([recordEloChangeD2({'playerId':_0x5cf8d3,'previousElo':_0x172e68,'newElo':_0x5758f8,'opponentId':_0x205d46,'matchResult':_0x4fa2b3(0x15d),'previousPosition':_0x4edfa7,'newPosition':_0x4ebe3e,'isPromotion':_0x4ebe3e<_0x4edfa7,'matchId':_0x4c7b73,'timestamp':_0x440276,'matchCount':_0x4068a8,'winRate':_0x23af62}),recordEloChangeD2({'playerId':_0x205d46,'previousElo':_0x40f87c,'newElo':_0x18370b,'opponentId':_0x5cf8d3,'matchResult':_0x4fa2b3(0x149),'previousPosition':_0x581a95,'newPosition':_0x2d10fe,'isDemotion':_0x2d10fe>_0x581a95,'matchId':_0x4c7b73,'timestamp':_0x440276,'matchCount':_0x2cc76d,'winRate':_0xbeeace})]),await promotionManager[_0x4fa2b3(0x14e)](_0x5cf8d3,_0x5758f8,_0x172e68,{'source':_0x4fa2b3(0x140),'matchId':_0x4c7b73}),await promotionManager[_0x4fa2b3(0x14e)](_0x205d46,_0x18370b,_0x40f87c,{'source':_0x4fa2b3(0x140),'matchId':_0x4c7b73}),!![];}catch(_0x1dab49){console[_0x4fa2b3(0x132)](_0x4fa2b3(0x142),_0x1dab49);throw _0x1dab49;}}function getDisplayElo(_0x44c6ab,_0x52ff1e){const _0x3d2cd3=a30_0x3967,_0x5d6973=new Date(_0x3d2cd3(0x148));let _0x5e096d=null;if(_0x52ff1e){if(_0x52ff1e[_0x3d2cd3(0x138)])_0x5e096d=_0x52ff1e[_0x3d2cd3(0x138)]();else{if(_0x52ff1e[_0x3d2cd3(0x12b)])_0x5e096d=new Date(_0x52ff1e[_0x3d2cd3(0x12b)]*0x3e8);else _0x52ff1e instanceof Date&&(_0x5e096d=_0x52ff1e);}}if(_0x5e096d&&_0x5e096d<_0x5d6973)return Math[_0x3d2cd3(0x150)](0x0,(Number(_0x44c6ab)||0x0)-0x258);return Number(_0x44c6ab)||0x0;}function a30_0x3262(){const _0x1e7810=['D2\x20Match\x20moved\x20to\x20approved\x20collection','Top\x20Rank\x20ribbon\x20check\x20failed,\x20but\x20match\x20approval\x20continues:','prototype','empty','seconds','all','data','currentUser','position','winnerUsername','__proto__','error','console','pendingMatchesD2','wins','No\x20user\x20logged\x20in','D2\x20Report\x20data:','toDate','trace','Current\x20user:','return\x20(function()\x20','length','toString','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','Starting\x20approveReportD2\x20function\x20with:','match-d2','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','Error\x20in\x20updateEloRatingsD2:','info','Error\x20in\x20approveReportD2:','Current\x20username:','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','round','2025-12-02T00:00:00','loss','loserUsername','email','exception','losses','checkAndRecordPromotion','Could\x20not\x20find\x20D2\x20player\x20documents','max','MAX_SAFE_INTEGER','eloRating','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','{}.constructor(\x22return\x20this\x22)(\x20)','docs','approvedMatchesD2','D2\x20match\x20report\x20not\x20found','table','Checked\x20Top\x20Rank\x20ribbon\x20for\x20D2\x20winner:\x20','constructor','One\x20or\x20both\x20D2\x20players\x20not\x20found','update','win','exists','createdAt','commit','bind','log','warn','username','D2\x20Report\x20not\x20found\x20with\x20ID:','apply','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','playersD2','D2\x20ELO\x20ratings\x20updated\x20successfully','pow','uid'];a30_0x3262=function(){return _0x1e7810;};return a30_0x3262();}export async function approveReportD2(_0x525d5c,_0x44328b,_0xd075b,_0x4a9885){const _0x269e79=a30_0x3967;try{console[_0x269e79(0x162)](_0x269e79(0x13f),{'reportId':_0x525d5c,'winnerScore':_0x44328b,'winnerSuicides':_0xd075b,'winnerComment':_0x4a9885});const _0x52a7be=auth[_0x269e79(0x12e)];if(!_0x52a7be){console[_0x269e79(0x162)](_0x269e79(0x136));throw new Error(_0x269e79(0x167));}console[_0x269e79(0x162)](_0x269e79(0x13a),_0x52a7be[_0x269e79(0x14b)]);const _0x2bcd93=await getDoc(doc(db,_0x269e79(0x168),_0x52a7be[_0x269e79(0x16b)])),_0x1ca6c1=_0x2bcd93[_0x269e79(0x15e)]()?_0x2bcd93[_0x269e79(0x12d)]()[_0x269e79(0x164)]:null;console[_0x269e79(0x162)](_0x269e79(0x145),_0x1ca6c1);const _0x3e6b89=doc(db,_0x269e79(0x134),_0x525d5c),_0x4cab69=await getDoc(_0x3e6b89);if(!_0x4cab69[_0x269e79(0x15e)]()){console[_0x269e79(0x162)](_0x269e79(0x165),_0x525d5c);throw new Error(_0x269e79(0x157));}const _0x53d5ca=_0x4cab69[_0x269e79(0x12d)]();console[_0x269e79(0x162)](_0x269e79(0x137),_0x53d5ca);if(_0x1ca6c1!==_0x53d5ca[_0x269e79(0x130)])throw new Error(_0x269e79(0x153));const [_0x405230,_0x5e6e0d]=await Promise[_0x269e79(0x12c)]([getDocs(query(collection(db,_0x269e79(0x168)),where(_0x269e79(0x164),'==',_0x53d5ca[_0x269e79(0x130)]))),getDocs(query(collection(db,_0x269e79(0x168)),where(_0x269e79(0x164),'==',_0x53d5ca[_0x269e79(0x14a)])))]);if(_0x405230[_0x269e79(0x12a)]||_0x5e6e0d[_0x269e79(0x12a)])throw new Error(_0x269e79(0x14f));const _0x590f98=_0x405230[_0x269e79(0x155)][0x0]['id'],_0xf5316b=_0x5e6e0d[_0x269e79(0x155)][0x0]['id'],_0x25f60d=_0x405230[_0x269e79(0x155)][0x0][_0x269e79(0x12d)](),_0x38abb8=_0x5e6e0d[_0x269e79(0x155)][0x0][_0x269e79(0x12d)](),_0x391185=_0x25f60d[_0x269e79(0x152)]||0xc8,_0x56a44a=_0x38abb8[_0x269e79(0x152)]||0xc8,_0x370984=(_0x25f60d[_0x269e79(0x135)]||0x0)+(_0x25f60d[_0x269e79(0x14d)]||0x0),_0x202b14=(_0x38abb8[_0x269e79(0x135)]||0x0)+(_0x38abb8[_0x269e79(0x14d)]||0x0),_0x4e9ac5=_0x370984>0x0?(_0x25f60d[_0x269e79(0x135)]||0x0)/_0x370984*0x64:0x0,_0x33e29f=_0x202b14>0x0?(_0x38abb8[_0x269e79(0x135)]||0x0)/_0x202b14*0x64:0x0,{newWinnerRating:_0x452b2f,newLoserRating:_0x4dfd79}=calculateEloD2(_0x391185,_0x56a44a),_0x15890e={..._0x53d5ca,'winnerScore':_0x44328b,'winnerSuicides':_0xd075b,'winnerComment':_0x4a9885,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1ca6c1,'createdAt':_0x53d5ca[_0x269e79(0x15f)]||serverTimestamp(),'winnerUsername':_0x53d5ca[_0x269e79(0x130)],'loserUsername':_0x53d5ca[_0x269e79(0x14a)],'winnerId':_0x590f98,'loserId':_0xf5316b,'winnerOldElo':_0x391185,'loserOldElo':_0x56a44a,'losersOldElo':_0x56a44a,'winnerNewElo':_0x452b2f,'loserNewElo':_0x4dfd79,'winnerEloChange':_0x452b2f-_0x391185,'loserEloChange':_0x4dfd79-_0x56a44a,'winnerMatchCount':_0x370984,'loserMatchCount':_0x202b14,'winnerWinRate':_0x4e9ac5,'loserWinRate':_0x33e29f};await setDoc(doc(db,_0x269e79(0x156),_0x525d5c),_0x15890e),await deleteDoc(_0x3e6b89),console[_0x269e79(0x162)](_0x269e79(0x127)),await updateEloRatingsD2(_0x590f98,_0xf5316b,_0x525d5c);try{await checkAndAwardTopRankRibbon(_0x53d5ca[_0x269e79(0x130)],'D2'),console[_0x269e79(0x162)](_0x269e79(0x159)+_0x53d5ca[_0x269e79(0x130)]);}catch(_0x20b0a7){console[_0x269e79(0x163)](_0x269e79(0x128),_0x20b0a7);}return console[_0x269e79(0x162)](_0x269e79(0x141)),!![];}catch(_0x261497){console[_0x269e79(0x132)](_0x269e79(0x144),_0x261497);throw _0x261497;}}