const a29_0x25c46f=(function(){let _0x1a92c4=!![];return function(_0x31ea5f,_0x4417e5){const _0xd5fac4=_0x1a92c4?function(){if(_0x4417e5){const _0x87e52b=_0x4417e5['apply'](_0x31ea5f,arguments);return _0x4417e5=null,_0x87e52b;}}:function(){};return _0x1a92c4=![],_0xd5fac4;};}()),a29_0x4ef176=a29_0x25c46f(this,function(){const _0x41d470=a29_0x1086;let _0x342a6a;try{const _0x3b9675=Function('return\x20(function()\x20'+_0x41d470(0x1b6)+');');_0x342a6a=_0x3b9675();}catch(_0x424c9a){_0x342a6a=window;}const _0x34fc8d=_0x342a6a['console']=_0x342a6a['console']||{},_0x39a2b0=['log','warn',_0x41d470(0x1aa),_0x41d470(0x1a1),_0x41d470(0x1b1),'table','trace'];for(let _0x1b9dc9=0x0;_0x1b9dc9<_0x39a2b0['length'];_0x1b9dc9++){const _0x45c937=a29_0x25c46f['constructor'][_0x41d470(0x1ac)]['bind'](a29_0x25c46f),_0x4cf710=_0x39a2b0[_0x1b9dc9],_0x431862=_0x34fc8d[_0x4cf710]||_0x45c937;_0x45c937['__proto__']=a29_0x25c46f[_0x41d470(0x1ad)](a29_0x25c46f),_0x45c937['toString']=_0x431862[_0x41d470(0x1a9)][_0x41d470(0x1ad)](_0x431862),_0x34fc8d[_0x4cf710]=_0x45c937;}});a29_0x4ef176();function a29_0x1086(_0x4a096d,_0x1f5e91){const _0x4ef176=a29_0x3b14();return a29_0x1086=function(_0x25c46f,_0x1535d6){_0x25c46f=_0x25c46f-0x19f;let _0x3b143d=_0x4ef176[_0x25c46f];return _0x3b143d;},a29_0x1086(_0x4a096d,_0x1f5e91);}import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a29_0x3b14(){const _0x18c603=['data','Error\x20in\x20updateEloRatingsD3:','error','docs','pow','update','winnerUsername','playersD3','approvedMatchesD3','position','toString','info','exists','prototype','bind','D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','D3\x20match\x20report\x20not\x20found','all','exception','D3\x20ELO\x20ratings\x20updated\x20successfully','username','No\x20user\x20logged\x20in','empty','{}.constructor(\x22return\x20this\x22)(\x20)','log','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'];a29_0x3b14=function(){return _0x18c603;};return a29_0x3b14();}import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0xd3e172,_0x419e09,_0x381599=0x20){const _0x5b75ea=a29_0x1086,_0x5db972=0x1/(0x1+Math[_0x5b75ea(0x1a3)](0xa,(_0x419e09-_0xd3e172)/0x190)),_0x105ed5=0x1/(0x1+Math['pow'](0xa,(_0xd3e172-_0x419e09)/0x190)),_0x2381e3=_0xd3e172+_0x381599*(0x1-_0x5db972),_0x2393f2=_0x419e09+_0x381599*(0x0-_0x105ed5);return{'newWinnerRating':Math['round'](_0x2381e3),'newLoserRating':Math['round'](_0x2393f2)};}export async function updateEloRatingsD3(_0x529f85,_0x593ff5,_0x224965){const _0x10e290=a29_0x1086;try{const _0x1217b0=writeBatch(db),_0x36deb6=doc(db,'playersD3',_0x529f85),_0x23a7ba=doc(db,'playersD3',_0x593ff5),[_0x16ce50,_0x4dba23]=await Promise['all']([getDoc(_0x36deb6),getDoc(_0x23a7ba)]);if(!_0x16ce50[_0x10e290(0x1ab)]()||!_0x4dba23['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x1e2e89=_0x16ce50[_0x10e290(0x19f)](),_0x211ed3=_0x4dba23['data'](),_0x51318c=_0x1e2e89[_0x10e290(0x1a8)]||Number['MAX_SAFE_INTEGER'],_0x1263eb=_0x211ed3[_0x10e290(0x1a8)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x48b296,newLoserRating:_0x4e4f33}=calculateEloD3(_0x1e2e89['eloRating']||0x4b0,_0x211ed3['eloRating']||0x4b0);let _0x3fdea5=_0x51318c,_0x2093a5=_0x1263eb;if(_0x51318c>_0x1263eb){console['log'](_0x10e290(0x1b8)),_0x3fdea5=_0x1263eb,_0x2093a5=_0x1263eb+0x1;const _0x4a3ce5=query(collection(db,'playersD3'),where('position','>',_0x1263eb),where(_0x10e290(0x1a8),'<',_0x51318c)),_0x43018e=await getDocs(_0x4a3ce5);for(const _0x3f267f of _0x43018e['docs']){_0x3f267f['id']!==_0x529f85&&_0x3f267f['id']!==_0x593ff5&&_0x1217b0['update'](doc(db,_0x10e290(0x1a6),_0x3f267f['id']),{'position':_0x3f267f['data']()['position']+0x1});}}else console[_0x10e290(0x1b7)]('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x1217b0[_0x10e290(0x1a4)](_0x36deb6,{'eloRating':_0x48b296,'lastMatchDate':serverTimestamp(),'position':_0x3fdea5,'lastMatchId':_0x224965}),_0x1217b0['update'](_0x23a7ba,{'eloRating':_0x4e4f33,'lastMatchDate':serverTimestamp(),'position':_0x2093a5,'lastMatchId':_0x224965}),await _0x1217b0['commit'](),console[_0x10e290(0x1b7)](_0x10e290(0x1b2)),await Promise[_0x10e290(0x1b0)]([recordEloChangeD3({'playerId':_0x529f85,'previousElo':_0x1e2e89['eloRating']||0x4b0,'newElo':_0x48b296,'opponentId':_0x593ff5,'matchResult':'win','previousPosition':_0x51318c,'newPosition':_0x3fdea5,'isPromotion':_0x3fdea5<_0x51318c,'matchId':_0x224965,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x593ff5,'previousElo':_0x211ed3['eloRating']||0x4b0,'newElo':_0x4e4f33,'opponentId':_0x529f85,'matchResult':'loss','previousPosition':_0x1263eb,'newPosition':_0x2093a5,'isDemotion':_0x2093a5>_0x1263eb,'matchId':_0x224965,'timestamp':serverTimestamp()})]),!![];}catch(_0x15ca77){console[_0x10e290(0x1a1)](_0x10e290(0x1a0),_0x15ca77);throw _0x15ca77;}}export async function approveReportD3(_0xd4ae76,_0x6a5e48,_0x1c2cd3,_0x3b4487){const _0x4a0020=a29_0x1086;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0xd4ae76,'winnerScore':_0x6a5e48,'winnerSuicides':_0x1c2cd3,'winnerComment':_0x3b4487});const _0x967171=auth['currentUser'];if(!_0x967171){console['log'](_0x4a0020(0x1b4));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console[_0x4a0020(0x1b7)]('Current\x20user:',_0x967171['email']);const _0x34193d=await getDoc(doc(db,_0x4a0020(0x1a6),_0x967171['uid'])),_0x469cf3=_0x34193d['exists']()?_0x34193d['data']()['username']:null;console[_0x4a0020(0x1b7)]('Current\x20username:',_0x469cf3);const _0x332b89=doc(db,'pendingMatchesD3',_0xd4ae76),_0x146ed1=await getDoc(_0x332b89);if(!_0x146ed1[_0x4a0020(0x1ab)]()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0xd4ae76);throw new Error(_0x4a0020(0x1af));}const _0x3bc938=_0x146ed1[_0x4a0020(0x19f)]();console['log']('D3\x20Report\x20data:',_0x3bc938);if(_0x469cf3!==_0x3bc938[_0x4a0020(0x1a5)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0xc3af74={..._0x3bc938,'winnerScore':_0x6a5e48,'winnerSuicides':_0x1c2cd3,'winnerComment':_0x3b4487,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x469cf3,'createdAt':_0x3bc938['createdAt']||serverTimestamp(),'winnerUsername':_0x3bc938[_0x4a0020(0x1a5)],'loserUsername':_0x3bc938['loserUsername']};await setDoc(doc(db,_0x4a0020(0x1a7),_0xd4ae76),_0xc3af74),await deleteDoc(_0x332b89),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x36c2d8,_0x1ac65e]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where(_0x4a0020(0x1b3),'==',_0x3bc938['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x3bc938['loserUsername'])))]);if(_0x36c2d8[_0x4a0020(0x1b5)]||_0x1ac65e['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x586b4d=_0x36c2d8[_0x4a0020(0x1a2)][0x0]['id'],_0x41747c=_0x1ac65e['docs'][0x0]['id'];return await updateEloRatingsD3(_0x586b4d,_0x41747c,_0xd4ae76),console[_0x4a0020(0x1b7)](_0x4a0020(0x1ae)),!![];}catch(_0x19d4b7){console['error']('Error\x20in\x20approveReportD3:',_0x19d4b7);throw _0x19d4b7;}}