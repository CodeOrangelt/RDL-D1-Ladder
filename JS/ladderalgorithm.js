const a28_0x154728=(function(){let _0x1a2ad6=!![];return function(_0xc458ae,_0x28a81c){const _0x20ffd0=_0x1a2ad6?function(){if(_0x28a81c){const _0x1d7e1a=_0x28a81c['apply'](_0xc458ae,arguments);return _0x28a81c=null,_0x1d7e1a;}}:function(){};return _0x1a2ad6=![],_0x20ffd0;};}()),a28_0x52e5b7=a28_0x154728(this,function(){const _0x3681ec=a28_0x5714;let _0x57fdeb;try{const _0x3665cf=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x57fdeb=_0x3665cf();}catch(_0x930c10){_0x57fdeb=window;}const _0x281f4=_0x57fdeb['console']=_0x57fdeb[_0x3681ec(0x1d5)]||{},_0x41ed68=[_0x3681ec(0x1c9),'warn','info','error',_0x3681ec(0x1ca),'table','trace'];for(let _0x174333=0x0;_0x174333<_0x41ed68['length'];_0x174333++){const _0x570841=a28_0x154728['constructor']['prototype'][_0x3681ec(0x1b0)](a28_0x154728),_0x2e7bbd=_0x41ed68[_0x174333],_0x55d1df=_0x281f4[_0x2e7bbd]||_0x570841;_0x570841[_0x3681ec(0x1ce)]=a28_0x154728['bind'](a28_0x154728),_0x570841['toString']=_0x55d1df['toString']['bind'](_0x55d1df),_0x281f4[_0x2e7bbd]=_0x570841;}});a28_0x52e5b7();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x59b1(){const _0x5e4972=['bind','loss','displayName','username','pointsHistory','pendingMatches','points','loserUsername','Error\x20approving\x20report:','wins','update','round','match','loserScore','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','docs','Standard','players','eloRating','winnerScore','userProfiles','unknown','commit','Match\x20moved\x20to\x20approved\x20collection','playerStats','log','exception','currentUser','all','position','__proto__','Error\x20assigning\x20default\x20ELO\x20rating:','Match\x20points:\x20','collection','pow','exists','winnerUsername','console','error','data','then'];a28_0x59b1=function(){return _0x5e4972;};return a28_0x59b1();}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x2fae46,_0x86a6af,_0x3a249c=0x20){const _0x2daff6=a28_0x5714,_0x4b8920=0x1/(0x1+Math['pow'](0xa,(_0x86a6af-_0x2fae46)/0x190)),_0x44c6c7=0x1/(0x1+Math[_0x2daff6(0x1d2)](0xa,(_0x2fae46-_0x86a6af)/0x190)),_0x59cddb=_0x2fae46+_0x3a249c*(0x1-_0x4b8920),_0x507e47=_0x86a6af+_0x3a249c*(0x0-_0x44c6c7);return{'newWinnerRating':Math[_0x2daff6(0x1bb)](_0x59cddb),'newLoserRating':Math[_0x2daff6(0x1bb)](_0x507e47)};}export function assignDefaultEloRating(_0x3f0b2b,_0x229b07){const _0x101219=a28_0x5714,_0x4b7559=0x4b0;!_0x229b07['eloRating']&&db[_0x101219(0x1d1)]('players')['doc'](_0x3f0b2b)[_0x101219(0x1ba)]({'eloRating':_0x4b7559})[_0x101219(0x1d8)](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x229b07['username']);})['catch'](_0x29e69c=>{const _0x2d41a7=_0x101219;console[_0x2d41a7(0x1d6)](_0x2d41a7(0x1cf),_0x29e69c);});}export async function updateEloRatings(_0x50a54e,_0xd5425a,_0x3b84cc){const _0x442713=a28_0x5714;try{const _0x510b60=writeBatch(db),_0x2031ea=doc(db,'players',_0x50a54e),_0x1756f4=doc(db,'players',_0xd5425a),[_0x2f6dff,_0x1f23f1]=await Promise['all']([getDoc(_0x2031ea),getDoc(_0x1756f4)]);if(!_0x2f6dff['exists']()||!_0x1f23f1[_0x442713(0x1d3)]())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x32fa93=_0x2f6dff['data'](),_0x2daac8=_0x1f23f1['data'](),_0x443332=_0x32fa93[_0x442713(0x1cd)]||Number['MAX_SAFE_INTEGER'],_0x24e017=_0x2daac8['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x478b78,newLoserRating:_0x4b1aaa}=calculateElo(_0x32fa93['eloRating']||0x4b0,_0x2daac8[_0x442713(0x1c2)]||0x4b0);let _0x4ebf40=_0x443332,_0x4b5921=_0x24e017;if(_0x443332>_0x24e017){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4ebf40=_0x24e017,_0x4b5921=_0x24e017+0x1;const _0x5a7d91=query(collection(db,'players'),where('position','>',_0x24e017),where('position','<',_0x443332)),_0x259c31=await getDocs(_0x5a7d91);for(const _0x46557e of _0x259c31[_0x442713(0x1bf)]){_0x46557e['id']!==_0x50a54e&&_0x46557e['id']!==_0xd5425a&&_0x510b60[_0x442713(0x1ba)](doc(db,_0x442713(0x1c1),_0x46557e['id']),{'position':_0x46557e['data']()['position']+0x1});}}else console['log'](_0x442713(0x1be));const _0x2e413e={'eloRating':_0x478b78,'lastMatchDate':serverTimestamp(),'position':_0x4ebf40,'lastMatchId':_0x3b84cc},_0x3a6380={'eloRating':_0x4b1aaa,'lastMatchDate':serverTimestamp(),'position':_0x4b5921,'lastMatchId':_0x3b84cc};return _0x510b60['update'](_0x2031ea,_0x2e413e),_0x510b60['update'](_0x1756f4,_0x3a6380),await _0x510b60[_0x442713(0x1c6)](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x50a54e,'previousElo':_0x32fa93['eloRating']||0x4b0,'newElo':_0x478b78,'opponentId':_0xd5425a,'matchResult':'win','previousPosition':_0x443332,'newPosition':_0x4ebf40,'isPromotion':_0x4ebf40<_0x443332,'matchId':_0x3b84cc,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0xd5425a,'previousElo':_0x2daac8[_0x442713(0x1c2)]||0x4b0,'newElo':_0x4b1aaa,'opponentId':_0x50a54e,'matchResult':_0x442713(0x1b1),'previousPosition':_0x24e017,'newPosition':_0x4b5921,'isDemotion':_0x4b5921>_0x24e017,'matchId':_0x3b84cc,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x50a54e,_0x478b78,_0x32fa93['eloRating'],{'source':_0x442713(0x1bc),'matchId':_0x3b84cc}),await promotionManager['checkAndRecordPromotion'](_0xd5425a,_0x4b1aaa,_0x2daac8[_0x442713(0x1c2)],{'source':'match','matchId':_0x3b84cc}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x424dc6){console['error']('Error\x20in\x20updateEloRatings:',_0x424dc6);throw _0x424dc6;}}function a28_0x5714(_0x30f6c8,_0x442f3b){const _0x52e5b7=a28_0x59b1();return a28_0x5714=function(_0x154728,_0x1b3c32){_0x154728=_0x154728-0x1b0;let _0x59b1ca=_0x52e5b7[_0x154728];return _0x59b1ca;},a28_0x5714(_0x30f6c8,_0x442f3b);}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x564701,_0x485481,_0x2223ba,_0x221e2d,_0x209c78){const _0x44e08a=a28_0x5714;try{const _0x393d15=doc(db,_0x44e08a(0x1b5),_0x564701),_0x362afa=await getDoc(_0x393d15);if(!_0x362afa['exists']())throw new Error('Report\x20not\x20found');const _0x59ac1d=_0x362afa[_0x44e08a(0x1d7)](),_0x4bed43={..._0x59ac1d,'winnerScore':_0x485481,'winnerSuicides':_0x2223ba,'winnerComment':_0x221e2d,'winnerDemoLink':_0x209c78,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth[_0x44e08a(0x1cb)]['uid']};await setDoc(doc(db,'approvedMatches',_0x564701),_0x4bed43),await deleteDoc(_0x393d15),console['log'](_0x44e08a(0x1c7));const [_0x284fb8,_0x188ac9]=await Promise[_0x44e08a(0x1cc)]([getDocs(query(collection(db,'players'),where(_0x44e08a(0x1b3),'==',_0x59ac1d[_0x44e08a(0x1d4)]))),getDocs(query(collection(db,'players'),where(_0x44e08a(0x1b3),'==',_0x59ac1d[_0x44e08a(0x1b7)])))]);if(_0x284fb8['empty']||_0x188ac9['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x392f2d=_0x284fb8[_0x44e08a(0x1bf)][0x0]['id'],_0x575f48=_0x188ac9['docs'][0x0]['id'];await updateEloRatings(_0x392f2d,_0x575f48,_0x564701);try{const _0x262cb4=_0x59ac1d['subgameType']||_0x44e08a(0x1c0),_0x3a2f47=POINTS_CHART[_0x262cb4]||0xa,_0x192b92=doc(db,'userProfiles',_0x392f2d),_0x455ed6=doc(db,_0x44e08a(0x1c4),_0x575f48),[_0x2865a8,_0x232b3e]=await Promise[_0x44e08a(0x1cc)]([getDoc(_0x192b92),getDoc(_0x455ed6)]);if(_0x2865a8[_0x44e08a(0x1d3)]()&&_0x232b3e['exists']()){const _0x30c532=_0x2865a8['data'](),_0x1a4b03=_0x232b3e['data'](),_0x401ac8=_0x30c532[_0x44e08a(0x1b6)]||0x0,_0x48aafd=_0x1a4b03['points']||0x0,_0x5ef80a=_0x401ac8+_0x3a2f47,_0x1c898a=_0x48aafd+_0x3a2f47;await Promise['all']([updateDoc(_0x192b92,{'points':_0x5ef80a,'lastPointsModified':serverTimestamp()}),updateDoc(_0x455ed6,{'points':_0x1c898a,'lastPointsModified':serverTimestamp()})]),await Promise[_0x44e08a(0x1cc)]([addDoc(collection(db,_0x44e08a(0x1b4)),{'userId':_0x392f2d,'userEmail':_0x30c532['email']||_0x44e08a(0x1c5),'displayName':_0x30c532['displayName']||_0x30c532['username']||'Unknown\x20User','action':'add','amount':_0x3a2f47,'previousPoints':_0x401ac8,'newPoints':_0x5ef80a,'reason':_0x44e08a(0x1d0)+_0x262cb4+'\x20match\x20(Winner)','adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,_0x44e08a(0x1b4)),{'userId':_0x575f48,'userEmail':_0x1a4b03['email']||_0x44e08a(0x1c5),'displayName':_0x1a4b03[_0x44e08a(0x1b2)]||_0x1a4b03['username']||'Unknown\x20User','action':'add','amount':_0x3a2f47,'previousPoints':_0x48aafd,'newPoints':_0x1c898a,'reason':_0x44e08a(0x1d0)+_0x262cb4+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console[_0x44e08a(0x1c9)]('Awarded\x20'+_0x3a2f47+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x262cb4+'\x20match');}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0xf9c2dd){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0xf9c2dd);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x30830f){console['error'](_0x44e08a(0x1b8),_0x30830f);throw _0x30830f;}}async function updatePlayerElo(_0xf5699f,_0x517d60,_0x3054af){await setDoc(doc(db,'players',_0xf5699f),{...playerData,'eloRating':_0x3054af}),await checkAndRecordPromotion(_0xf5699f,_0x3054af,_0x517d60);}async function updatePlayerStats(_0x580bb5,_0x215a28,_0x138caa){const _0x269cd6=a28_0x5714,_0x46d0e3=doc(db,_0x269cd6(0x1c8),_0x580bb5),_0x45f3f1=await getDoc(_0x46d0e3);let _0x4ee2df=_0x45f3f1['exists']()?_0x45f3f1['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x138caa?(_0x4ee2df['wins']++,_0x4ee2df['totalKills']+=parseInt(_0x215a28['winnerScore']||0x0),_0x4ee2df['totalDeaths']+=parseInt(_0x215a28['loserScore']||0x0)):(_0x4ee2df['losses']++,_0x4ee2df['totalKills']+=parseInt(_0x215a28[_0x269cd6(0x1bd)]||0x0),_0x4ee2df['totalDeaths']+=parseInt(_0x215a28[_0x269cd6(0x1c3)]||0x0));const _0x534404=_0x4ee2df[_0x269cd6(0x1b9)]+_0x4ee2df['losses'];_0x4ee2df['winRate']=_0x534404>0x0?(_0x4ee2df[_0x269cd6(0x1b9)]/_0x534404*0x64)['toFixed'](0x1):0x0,_0x4ee2df['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x46d0e3,_0x4ee2df,{'merge':!![]});}