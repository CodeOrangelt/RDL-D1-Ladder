const a28_0x2e9dd0=(function(){let _0x39b1e6=!![];return function(_0x22621c,_0x276211){const _0x392f83=_0x39b1e6?function(){const _0x22bc97=a28_0x115b;if(_0x276211){const _0xe5b19e=_0x276211[_0x22bc97(0x172)](_0x22621c,arguments);return _0x276211=null,_0xe5b19e;}}:function(){};return _0x39b1e6=![],_0x392f83;};}()),a28_0x3a3512=a28_0x2e9dd0(this,function(){const _0x387d92=a28_0x115b,_0x411e36=function(){let _0xa1e01f;try{_0xa1e01f=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x31743c){_0xa1e01f=window;}return _0xa1e01f;},_0x61e8e7=_0x411e36(),_0x59d4f9=_0x61e8e7['console']=_0x61e8e7[_0x387d92(0x16d)]||{},_0x24ccda=[_0x387d92(0x170),'warn',_0x387d92(0x164),_0x387d92(0x169),'exception','table','trace'];for(let _0xfe1a50=0x0;_0xfe1a50<_0x24ccda['length'];_0xfe1a50++){const _0x510d43=a28_0x2e9dd0['constructor']['prototype']['bind'](a28_0x2e9dd0),_0x24d90a=_0x24ccda[_0xfe1a50],_0x5ee3f2=_0x59d4f9[_0x24d90a]||_0x510d43;_0x510d43['__proto__']=a28_0x2e9dd0['bind'](a28_0x2e9dd0),_0x510d43[_0x387d92(0x16e)]=_0x5ee3f2[_0x387d92(0x16e)]['bind'](_0x5ee3f2),_0x59d4f9[_0x24d90a]=_0x510d43;}});a28_0x3a3512();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x115b(_0x523db4,_0x481ef2){const _0x3a3512=a28_0x1f71();return a28_0x115b=function(_0x2e9dd0,_0x5d0a24){_0x2e9dd0=_0x2e9dd0-0x15a;let _0x1f71da=_0x3a3512[_0x2e9dd0];return _0x1f71da;},a28_0x115b(_0x523db4,_0x481ef2);}function a28_0x1f71(){const _0x43d519=['loserUsername','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','eloRating','docs','data','Error\x20in\x20updateEloRatingsD2:','currentUser','playersD2','Current\x20username:','position','info','One\x20or\x20both\x20D2\x20players\x20not\x20found','approvedMatchesD2','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','D2\x20Match\x20moved\x20to\x20approved\x20collection','error','win','username','commit','console','toString','D2\x20Report\x20not\x20found\x20with\x20ID:','log','MAX_SAFE_INTEGER','apply'];a28_0x1f71=function(){return _0x43d519;};return a28_0x1f71();}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x4f8a90 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x14c0de,_0xaac906,_0x106abd=0x20){const _0x5ddc88=0x1/(0x1+Math['pow'](0xa,(_0xaac906-_0x14c0de)/0x190)),_0x5675c0=0x1/(0x1+Math['pow'](0xa,(_0x14c0de-_0xaac906)/0x190)),_0x558acb=_0x14c0de+_0x106abd*(0x1-_0x5ddc88),_0x2a602b=_0xaac906+_0x106abd*(0x0-_0x5675c0);return{'newWinnerRating':Math['round'](_0x558acb),'newLoserRating':Math['round'](_0x2a602b)};}export async function updateEloRatingsD2(_0x308518,_0x22cc0b,_0x1ba7df){const _0x571554=a28_0x115b;try{const _0x45e82f=writeBatch(db),_0x57578b=doc(db,'playersD2',_0x308518),_0x138bb4=doc(db,'playersD2',_0x22cc0b),[_0x30e0fc,_0x231439]=await Promise['all']([getDoc(_0x57578b),getDoc(_0x138bb4)]);if(!_0x30e0fc['exists']()||!_0x231439['exists']())throw new Error(_0x571554(0x165));const _0xc8392e=_0x30e0fc[_0x571554(0x15e)](),_0x3733f3=_0x231439['data'](),_0x5d68f8=_0xc8392e['position']||Number[_0x571554(0x171)],_0x197396=_0x3733f3['position']||Number[_0x571554(0x171)],{newWinnerRating:_0x13b053,newLoserRating:_0x44e678}=calculateEloD2(_0xc8392e['eloRating']||0x4b0,_0x3733f3['eloRating']||0x4b0);let _0x118027=_0x5d68f8,_0xfb8838=_0x197396;if(_0x5d68f8>_0x197396){console[_0x571554(0x170)](_0x571554(0x167)),_0x118027=_0x197396,_0xfb8838=_0x197396+0x1;const _0x391fdb=query(collection(db,'playersD2'),where(_0x571554(0x163),'>',_0x197396),where('position','<',_0x5d68f8)),_0x1ba438=await getDocs(_0x391fdb);for(const _0x2c4a77 of _0x1ba438['docs']){_0x2c4a77['id']!==_0x308518&&_0x2c4a77['id']!==_0x22cc0b&&_0x45e82f['update'](doc(db,_0x571554(0x161),_0x2c4a77['id']),{'position':_0x2c4a77['data']()['position']+0x1});}}else console[_0x571554(0x170)](_0x571554(0x15b));return _0x45e82f['update'](_0x57578b,{'eloRating':_0x13b053,'lastMatchDate':serverTimestamp(),'position':_0x118027,'lastMatchId':_0x1ba7df}),_0x45e82f['update'](_0x138bb4,{'eloRating':_0x44e678,'lastMatchDate':serverTimestamp(),'position':_0xfb8838,'lastMatchId':_0x1ba7df}),await _0x45e82f[_0x571554(0x16c)](),console[_0x571554(0x170)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x308518,'previousElo':_0xc8392e['eloRating']||0x4b0,'newElo':_0x13b053,'opponentId':_0x22cc0b,'matchResult':_0x571554(0x16a),'previousPosition':_0x5d68f8,'newPosition':_0x118027,'isPromotion':_0x118027<_0x5d68f8,'matchId':_0x1ba7df,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x22cc0b,'previousElo':_0x3733f3['eloRating']||0x4b0,'newElo':_0x44e678,'opponentId':_0x308518,'matchResult':'loss','previousPosition':_0x197396,'newPosition':_0xfb8838,'isDemotion':_0xfb8838>_0x197396,'matchId':_0x1ba7df,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x308518,_0x13b053,_0xc8392e['eloRating'],{'source':'match-d2','matchId':_0x1ba7df}),await promotionManager['checkAndRecordPromotion'](_0x22cc0b,_0x44e678,_0x3733f3[_0x571554(0x15c)],{'source':'match-d2','matchId':_0x1ba7df}),!![];}catch(_0x1e651f){console['error'](_0x571554(0x15f),_0x1e651f);throw _0x1e651f;}}export async function approveReportD2(_0x12dfed,_0x29e284,_0x3d1a8b,_0x53d58f){const _0x123608=a28_0x115b;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x12dfed,'winnerScore':_0x29e284,'winnerSuicides':_0x3d1a8b,'winnerComment':_0x53d58f});const _0x28d224=auth[_0x123608(0x160)];if(!_0x28d224){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x28d224['email']);const _0x481815=await getDoc(doc(db,_0x123608(0x161),_0x28d224['uid'])),_0x41d180=_0x481815['exists']()?_0x481815[_0x123608(0x15e)]()[_0x123608(0x16b)]:null;console[_0x123608(0x170)](_0x123608(0x162),_0x41d180);const _0x5431d5=doc(db,'pendingMatchesD2',_0x12dfed),_0x3da5f0=await getDoc(_0x5431d5);if(!_0x3da5f0['exists']()){console['log'](_0x123608(0x16f),_0x12dfed);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x280f7c=_0x3da5f0[_0x123608(0x15e)]();console['log']('D2\x20Report\x20data:',_0x280f7c);if(_0x41d180!==_0x280f7c['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x347bdb={..._0x280f7c,'winnerScore':_0x29e284,'winnerSuicides':_0x3d1a8b,'winnerComment':_0x53d58f,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x41d180,'createdAt':_0x280f7c['createdAt']||serverTimestamp(),'winnerUsername':_0x280f7c['winnerUsername'],'loserUsername':_0x280f7c[_0x123608(0x15a)]};await setDoc(doc(db,_0x123608(0x166),_0x12dfed),_0x347bdb),await deleteDoc(_0x5431d5),console['log'](_0x123608(0x168));const [_0x437582,_0x4e6ab3]=await Promise['all']([getDocs(query(collection(db,_0x123608(0x161)),where('username','==',_0x280f7c['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where(_0x123608(0x16b),'==',_0x280f7c['loserUsername'])))]);if(_0x437582['empty']||_0x4e6ab3['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x2c9934=_0x437582[_0x123608(0x15d)][0x0]['id'],_0x4fd007=_0x4e6ab3['docs'][0x0]['id'];return await updateEloRatingsD2(_0x2c9934,_0x4fd007,_0x12dfed),console[_0x123608(0x170)]('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3bf3c7){console['error']('Error\x20in\x20approveReportD2:',_0x3bf3c7);throw _0x3bf3c7;}}