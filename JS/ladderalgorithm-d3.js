const a27_0x412792=(function(){let _0x2ad41a=!![];return function(_0x3a39e8,_0x4e7963){const _0x2a6629=_0x2ad41a?function(){const _0xf96507=a27_0x557c;if(_0x4e7963){const _0x2b641e=_0x4e7963[_0xf96507(0x179)](_0x3a39e8,arguments);return _0x4e7963=null,_0x2b641e;}}:function(){};return _0x2ad41a=![],_0x2a6629;};}()),a27_0x163c0d=a27_0x412792(this,function(){const _0xb1affa=a27_0x557c;let _0x2f8016;try{const _0x208590=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x2f8016=_0x208590();}catch(_0x3b50c5){_0x2f8016=window;}const _0x475126=_0x2f8016[_0xb1affa(0x187)]=_0x2f8016[_0xb1affa(0x187)]||{},_0x1202d4=['log',_0xb1affa(0x185),'info','error',_0xb1affa(0x175),'table','trace'];for(let _0x1164cc=0x0;_0x1164cc<_0x1202d4['length'];_0x1164cc++){const _0x9378c5=a27_0x412792['constructor']['prototype']['bind'](a27_0x412792),_0x24fd5b=_0x1202d4[_0x1164cc],_0x50f649=_0x475126[_0x24fd5b]||_0x9378c5;_0x9378c5[_0xb1affa(0x184)]=a27_0x412792['bind'](a27_0x412792),_0x9378c5[_0xb1affa(0x174)]=_0x50f649[_0xb1affa(0x174)]['bind'](_0x50f649),_0x475126[_0x24fd5b]=_0x9378c5;}});a27_0x163c0d();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a27_0x20f7(){const _0x48eb23=['currentUser','docs','eloRating','toString','exception','Current\x20username:','position','loss','apply','empty','data','winnerUsername','D3\x20Report\x20data:','loserUsername','Error\x20in\x20approveReportD3:','D3\x20ELO\x20ratings\x20updated\x20successfully','commit','D3\x20match\x20report\x20not\x20found','all','__proto__','warn','Could\x20not\x20find\x20D3\x20player\x20documents','console','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','log'];a27_0x20f7=function(){return _0x48eb23;};return a27_0x20f7();}function a27_0x557c(_0x5770db,_0x1768ac){const _0x163c0d=a27_0x20f7();return a27_0x557c=function(_0x412792,_0x21b50e){_0x412792=_0x412792-0x171;let _0x20f7d5=_0x163c0d[_0x412792];return _0x20f7d5;},a27_0x557c(_0x5770db,_0x1768ac);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x56ebe3,_0x2d5974,_0x3a624c=0x20){const _0x5ed374=0x1/(0x1+Math['pow'](0xa,(_0x2d5974-_0x56ebe3)/0x190)),_0x1a13e1=0x1/(0x1+Math['pow'](0xa,(_0x56ebe3-_0x2d5974)/0x190)),_0x3ec21a=_0x56ebe3+_0x3a624c*(0x1-_0x5ed374),_0x32b8fc=_0x2d5974+_0x3a624c*(0x0-_0x1a13e1);return{'newWinnerRating':Math['round'](_0x3ec21a),'newLoserRating':Math['round'](_0x32b8fc)};}export async function updateEloRatingsD3(_0x2789ba,_0x1785ce,_0x524fa0){const _0x5cf684=a27_0x557c;try{const _0x5510f2=writeBatch(db),_0x3b6a39=doc(db,'playersD3',_0x2789ba),_0xf0b851=doc(db,'playersD3',_0x1785ce),[_0x540ddf,_0x466bf9]=await Promise[_0x5cf684(0x183)]([getDoc(_0x3b6a39),getDoc(_0xf0b851)]);if(!_0x540ddf['exists']()||!_0x466bf9['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x6b5205=_0x540ddf['data'](),_0x25e3c7=_0x466bf9['data'](),_0x540f56=_0x6b5205['position']||Number['MAX_SAFE_INTEGER'],_0x5cf9ab=_0x25e3c7['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x9931b1,newLoserRating:_0x3fa16f}=calculateEloD3(_0x6b5205[_0x5cf684(0x173)]||0x4b0,_0x25e3c7['eloRating']||0x4b0);let _0x519426=_0x540f56,_0x3b6547=_0x5cf9ab;if(_0x540f56>_0x5cf9ab){console['log'](_0x5cf684(0x188)),_0x519426=_0x5cf9ab,_0x3b6547=_0x5cf9ab+0x1;const _0x260fd6=query(collection(db,'playersD3'),where('position','>',_0x5cf9ab),where(_0x5cf684(0x177),'<',_0x540f56)),_0x1d2d52=await getDocs(_0x260fd6);for(const _0x4cec5f of _0x1d2d52['docs']){_0x4cec5f['id']!==_0x2789ba&&_0x4cec5f['id']!==_0x1785ce&&_0x5510f2['update'](doc(db,'playersD3',_0x4cec5f['id']),{'position':_0x4cec5f['data']()[_0x5cf684(0x177)]+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x5510f2['update'](_0x3b6a39,{'eloRating':_0x9931b1,'lastMatchDate':serverTimestamp(),'position':_0x519426,'lastMatchId':_0x524fa0}),_0x5510f2['update'](_0xf0b851,{'eloRating':_0x3fa16f,'lastMatchDate':serverTimestamp(),'position':_0x3b6547,'lastMatchId':_0x524fa0}),await _0x5510f2[_0x5cf684(0x181)](),console[_0x5cf684(0x189)](_0x5cf684(0x180)),await Promise[_0x5cf684(0x183)]([recordEloChangeD3({'playerId':_0x2789ba,'previousElo':_0x6b5205['eloRating']||0x4b0,'newElo':_0x9931b1,'opponentId':_0x1785ce,'matchResult':'win','previousPosition':_0x540f56,'newPosition':_0x519426,'isPromotion':_0x519426<_0x540f56,'matchId':_0x524fa0,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x1785ce,'previousElo':_0x25e3c7[_0x5cf684(0x173)]||0x4b0,'newElo':_0x3fa16f,'opponentId':_0x2789ba,'matchResult':_0x5cf684(0x178),'previousPosition':_0x5cf9ab,'newPosition':_0x3b6547,'isDemotion':_0x3b6547>_0x5cf9ab,'matchId':_0x524fa0,'timestamp':serverTimestamp()})]),!![];}catch(_0x3954a7){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x3954a7);throw _0x3954a7;}}export async function approveReportD3(_0x147084,_0x5e40b9,_0x240e61,_0x597d9d){const _0x566b11=a27_0x557c;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x147084,'winnerScore':_0x5e40b9,'winnerSuicides':_0x240e61,'winnerComment':_0x597d9d});const _0x14209b=auth[_0x566b11(0x171)];if(!_0x14209b){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x14209b['email']);const _0x2573b3=await getDoc(doc(db,'playersD3',_0x14209b['uid'])),_0x3f6949=_0x2573b3['exists']()?_0x2573b3['data']()['username']:null;console['log'](_0x566b11(0x176),_0x3f6949);const _0x250f1f=doc(db,'pendingMatchesD3',_0x147084),_0x32d371=await getDoc(_0x250f1f);if(!_0x32d371['exists']()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x147084);throw new Error(_0x566b11(0x182));}const _0x53121e=_0x32d371[_0x566b11(0x17b)]();console['log'](_0x566b11(0x17d),_0x53121e);if(_0x3f6949!==_0x53121e['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x4ea69e={..._0x53121e,'winnerScore':_0x5e40b9,'winnerSuicides':_0x240e61,'winnerComment':_0x597d9d,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x3f6949,'createdAt':_0x53121e['createdAt']||serverTimestamp(),'winnerUsername':_0x53121e[_0x566b11(0x17c)],'loserUsername':_0x53121e[_0x566b11(0x17e)]};await setDoc(doc(db,'approvedMatchesD3',_0x147084),_0x4ea69e),await deleteDoc(_0x250f1f),console[_0x566b11(0x189)]('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x2bef68,_0x2c72c5]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x53121e[_0x566b11(0x17c)]))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x53121e['loserUsername'])))]);if(_0x2bef68[_0x566b11(0x17a)]||_0x2c72c5['empty'])throw new Error(_0x566b11(0x186));const _0x535fe1=_0x2bef68['docs'][0x0]['id'],_0x198830=_0x2c72c5[_0x566b11(0x172)][0x0]['id'];return await updateEloRatingsD3(_0x535fe1,_0x198830,_0x147084),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3bf5ec){console['error'](_0x566b11(0x17f),_0x3bf5ec);throw _0x3bf5ec;}}