const a26_0xd9bf45=(function(){let _0x1d6839=!![];return function(_0x517f0a,_0x2b02ae){const _0x4862e6=_0x1d6839?function(){if(_0x2b02ae){const _0x50da96=_0x2b02ae['apply'](_0x517f0a,arguments);return _0x2b02ae=null,_0x50da96;}}:function(){};return _0x1d6839=![],_0x4862e6;};}()),a26_0x1456f8=a26_0xd9bf45(this,function(){const _0x134f00=a26_0x5685;let _0x58d6bb;try{const _0x1d9800=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x58d6bb=_0x1d9800();}catch(_0x3dd889){_0x58d6bb=window;}const _0x42c545=_0x58d6bb['console']=_0x58d6bb['console']||{},_0xf489b5=['log','warn',_0x134f00(0xfe),'error','exception',_0x134f00(0xf5),'trace'];for(let _0x5d30f5=0x0;_0x5d30f5<_0xf489b5['length'];_0x5d30f5++){const _0x19292a=a26_0xd9bf45[_0x134f00(0x107)]['prototype']['bind'](a26_0xd9bf45),_0x16334a=_0xf489b5[_0x5d30f5],_0x4e65a7=_0x42c545[_0x16334a]||_0x19292a;_0x19292a['__proto__']=a26_0xd9bf45[_0x134f00(0xf1)](a26_0xd9bf45),_0x19292a['toString']=_0x4e65a7['toString']['bind'](_0x4e65a7),_0x42c545[_0x16334a]=_0x19292a;}});a26_0x1456f8();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x1ecec0 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x36b0c6,_0x3f975b,_0x171a02=0x20){const _0x40a56d=a26_0x5685,_0x5bc4af=0x1/(0x1+Math[_0x40a56d(0x106)](0xa,(_0x3f975b-_0x36b0c6)/0x190)),_0x522616=0x1/(0x1+Math[_0x40a56d(0x106)](0xa,(_0x36b0c6-_0x3f975b)/0x190)),_0x3802ca=_0x36b0c6+_0x171a02*(0x1-_0x5bc4af),_0x5a3dc8=_0x3f975b+_0x171a02*(0x0-_0x522616);return{'newWinnerRating':Math[_0x40a56d(0xf3)](_0x3802ca),'newLoserRating':Math[_0x40a56d(0xf3)](_0x5a3dc8)};}export async function updateEloRatingsD2(_0x3368a0,_0x23d018,_0xcef718){const _0x5dfb5e=a26_0x5685;try{const _0x3f7c97=writeBatch(db),_0x32b5fa=doc(db,'playersD2',_0x3368a0),_0xff50f8=doc(db,'playersD2',_0x23d018),[_0x2e4515,_0x9b245f]=await Promise['all']([getDoc(_0x32b5fa),getDoc(_0xff50f8)]);if(!_0x2e4515['exists']()||!_0x9b245f['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x1f414d=_0x2e4515[_0x5dfb5e(0xfb)](),_0x3955cf=_0x9b245f['data'](),_0x4f2dbe=_0x1f414d['position']||Number['MAX_SAFE_INTEGER'],_0x5ece20=_0x3955cf['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x4fb2a2,newLoserRating:_0x3009dd}=calculateEloD2(_0x1f414d['eloRating']||0x4b0,_0x3955cf['eloRating']||0x4b0);let _0x309568=_0x4f2dbe,_0x5beab7=_0x5ece20;if(_0x4f2dbe>_0x5ece20){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x309568=_0x5ece20,_0x5beab7=_0x5ece20+0x1;const _0x3d9e1d=query(collection(db,_0x5dfb5e(0x103)),where('position','>',_0x5ece20),where('position','<',_0x4f2dbe)),_0x2d6982=await getDocs(_0x3d9e1d);for(const _0x18385f of _0x2d6982[_0x5dfb5e(0xf6)]){_0x18385f['id']!==_0x3368a0&&_0x18385f['id']!==_0x23d018&&_0x3f7c97['update'](doc(db,'playersD2',_0x18385f['id']),{'position':_0x18385f['data']()['position']+0x1});}}else console[_0x5dfb5e(0x100)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x3f7c97['update'](_0x32b5fa,{'eloRating':_0x4fb2a2,'lastMatchDate':serverTimestamp(),'position':_0x309568,'lastMatchId':_0xcef718}),_0x3f7c97[_0x5dfb5e(0xf9)](_0xff50f8,{'eloRating':_0x3009dd,'lastMatchDate':serverTimestamp(),'position':_0x5beab7,'lastMatchId':_0xcef718}),await _0x3f7c97[_0x5dfb5e(0x104)](),console['log'](_0x5dfb5e(0xfa)),await Promise['all']([recordEloChangeD2({'playerId':_0x3368a0,'previousElo':_0x1f414d['eloRating']||0x4b0,'newElo':_0x4fb2a2,'opponentId':_0x23d018,'matchResult':'win','previousPosition':_0x4f2dbe,'newPosition':_0x309568,'isPromotion':_0x309568<_0x4f2dbe,'matchId':_0xcef718,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x23d018,'previousElo':_0x3955cf['eloRating']||0x4b0,'newElo':_0x3009dd,'opponentId':_0x3368a0,'matchResult':_0x5dfb5e(0xfd),'previousPosition':_0x5ece20,'newPosition':_0x5beab7,'isDemotion':_0x5beab7>_0x5ece20,'matchId':_0xcef718,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x3368a0,_0x4fb2a2,_0x1f414d['eloRating'],{'source':_0x5dfb5e(0x105),'matchId':_0xcef718}),await promotionManager['checkAndRecordPromotion'](_0x23d018,_0x3009dd,_0x3955cf[_0x5dfb5e(0x101)],{'source':'match-d2','matchId':_0xcef718}),!![];}catch(_0x58f9f0){console[_0x5dfb5e(0x108)](_0x5dfb5e(0xf2),_0x58f9f0);throw _0x58f9f0;}}export async function approveReportD2(_0xb0b547,_0x457d3b,_0x2336e0,_0x2d8a9e){const _0x1eecf5=a26_0x5685;try{console['log'](_0x1eecf5(0x109),{'reportId':_0xb0b547,'winnerScore':_0x457d3b,'winnerSuicides':_0x2336e0,'winnerComment':_0x2d8a9e});const _0x87b62c=auth[_0x1eecf5(0xf0)];if(!_0x87b62c){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x87b62c['email']);const _0x37aef2=await getDoc(doc(db,_0x1eecf5(0x103),_0x87b62c['uid'])),_0x5d912c=_0x37aef2['exists']()?_0x37aef2['data']()['username']:null;console['log']('Current\x20username:',_0x5d912c);const _0x443d05=doc(db,'pendingMatchesD2',_0xb0b547),_0x565d5c=await getDoc(_0x443d05);if(!_0x565d5c['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0xb0b547);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x44a561=_0x565d5c['data']();console['log']('D2\x20Report\x20data:',_0x44a561);if(_0x5d912c!==_0x44a561['winnerUsername'])throw new Error(_0x1eecf5(0xf7));const _0x5e075b={..._0x44a561,'winnerScore':_0x457d3b,'winnerSuicides':_0x2336e0,'winnerComment':_0x2d8a9e,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x5d912c,'createdAt':_0x44a561['createdAt']||serverTimestamp(),'winnerUsername':_0x44a561['winnerUsername'],'loserUsername':_0x44a561['loserUsername']};await setDoc(doc(db,_0x1eecf5(0xf4),_0xb0b547),_0x5e075b),await deleteDoc(_0x443d05),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x4fdb5f,_0x231cbe]=await Promise[_0x1eecf5(0xff)]([getDocs(query(collection(db,'playersD2'),where('username','==',_0x44a561[_0x1eecf5(0x102)]))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x44a561[_0x1eecf5(0xf8)])))]);if(_0x4fdb5f[_0x1eecf5(0xfc)]||_0x231cbe['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x1d1c90=_0x4fdb5f['docs'][0x0]['id'],_0x58f08b=_0x231cbe['docs'][0x0]['id'];return await updateEloRatingsD2(_0x1d1c90,_0x58f08b,_0xb0b547),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x56fd1a){console['error']('Error\x20in\x20approveReportD2:',_0x56fd1a);throw _0x56fd1a;}}function a26_0x5685(_0x107d03,_0x900f6d){const _0x1456f8=a26_0x15fe();return a26_0x5685=function(_0xd9bf45,_0x1bf77b){_0xd9bf45=_0xd9bf45-0xf0;let _0x15fe58=_0x1456f8[_0xd9bf45];return _0x15fe58;},a26_0x5685(_0x107d03,_0x900f6d);}function a26_0x15fe(){const _0x2be258=['currentUser','bind','Error\x20in\x20updateEloRatingsD2:','round','approvedMatchesD2','table','docs','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','loserUsername','update','D2\x20ELO\x20ratings\x20updated\x20successfully','data','empty','loss','info','all','log','eloRating','winnerUsername','playersD2','commit','match-d2','pow','constructor','error','Starting\x20approveReportD2\x20function\x20with:'];a26_0x15fe=function(){return _0x2be258;};return a26_0x15fe();}