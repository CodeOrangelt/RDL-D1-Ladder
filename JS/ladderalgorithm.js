const a28_0x3a3c1f=(function(){let _0x453049=!![];return function(_0x3cd5e3,_0x2542cb){const _0x3dfea9=_0x453049?function(){if(_0x2542cb){const _0x465cd7=_0x2542cb['apply'](_0x3cd5e3,arguments);return _0x2542cb=null,_0x465cd7;}}:function(){};return _0x453049=![],_0x3dfea9;};}()),a28_0x407548=a28_0x3a3c1f(this,function(){const _0x599f16=a28_0x151e;let _0x3f5e46;try{const _0x116c8e=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x3f5e46=_0x116c8e();}catch(_0x4e19a9){_0x3f5e46=window;}const _0x4d68b0=_0x3f5e46[_0x599f16(0x10a)]=_0x3f5e46['console']||{},_0x3e77bc=['log',_0x599f16(0xec),'info','error','exception','table','trace'];for(let _0x581dd6=0x0;_0x581dd6<_0x3e77bc['length'];_0x581dd6++){const _0x44e87d=a28_0x3a3c1f[_0x599f16(0xf0)]['prototype'][_0x599f16(0xf8)](a28_0x3a3c1f),_0x5d842d=_0x3e77bc[_0x581dd6],_0x599300=_0x4d68b0[_0x5d842d]||_0x44e87d;_0x44e87d['__proto__']=a28_0x3a3c1f['bind'](a28_0x3a3c1f),_0x44e87d[_0x599f16(0xf6)]=_0x599300[_0x599f16(0xf6)]['bind'](_0x599300),_0x4d68b0[_0x5d842d]=_0x44e87d;}});a28_0x407548();function a28_0x51f3(){const _0x569d40=['Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','update','userProfiles','Unknown\x20User','exists','players','warn','pow','loss','wins','constructor','docs','log','totalKills','toFixed','unknown','toString','round','bind','checkAndRecordPromotion','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','match','ELO\x20ratings\x20updated\x20successfully','error','data','Standard','MAX_SAFE_INTEGER','playerStats','all','system-match-award','winRate','loserScore','currentUser','eloRating','position','empty','console'];a28_0x51f3=function(){return _0x569d40;};return a28_0x51f3();}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x151e(_0x3bb7f7,_0x4afe8b){const _0x407548=a28_0x51f3();return a28_0x151e=function(_0x3a3c1f,_0x2a25e9){_0x3a3c1f=_0x3a3c1f-0xe6;let _0x51f355=_0x407548[_0x3a3c1f];return _0x51f355;},a28_0x151e(_0x3bb7f7,_0x4afe8b);}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x1ffc77,_0x977960,_0x5431bf=0x20){const _0x391062=a28_0x151e,_0x9c8a11=0x1/(0x1+Math[_0x391062(0xed)](0xa,(_0x977960-_0x1ffc77)/0x190)),_0x1ba028=0x1/(0x1+Math[_0x391062(0xed)](0xa,(_0x1ffc77-_0x977960)/0x190)),_0x4f9ea9=_0x1ffc77+_0x5431bf*(0x1-_0x9c8a11),_0x7c3945=_0x977960+_0x5431bf*(0x0-_0x1ba028);return{'newWinnerRating':Math['round'](_0x4f9ea9),'newLoserRating':Math[_0x391062(0xf7)](_0x7c3945)};}export function assignDefaultEloRating(_0x9a264d,_0x312e18){const _0x23a4b3=0x4b0;!_0x312e18['eloRating']&&db['collection']('players')['doc'](_0x9a264d)['update']({'eloRating':_0x23a4b3})['then'](()=>{const _0x3562d0=a28_0x151e;console[_0x3562d0(0xf2)]('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x312e18['username']);})['catch'](_0x5006bf=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x5006bf);});}export async function updateEloRatings(_0x1fc848,_0x15cfb7,_0x282960){const _0x377e98=a28_0x151e;try{const _0x3511b8=writeBatch(db),_0x34f9fc=doc(db,'players',_0x1fc848),_0x9fc567=doc(db,'players',_0x15cfb7),[_0x20e3f8,_0x4beb77]=await Promise[_0x377e98(0x102)]([getDoc(_0x34f9fc),getDoc(_0x9fc567)]);if(!_0x20e3f8['exists']()||!_0x4beb77[_0x377e98(0xea)]())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x1f994d=_0x20e3f8['data'](),_0x2e2e00=_0x4beb77[_0x377e98(0xfe)](),_0x419f16=_0x1f994d[_0x377e98(0x108)]||Number[_0x377e98(0x100)],_0x36d942=_0x2e2e00['position']||Number[_0x377e98(0x100)],{newWinnerRating:_0x4af185,newLoserRating:_0x49d78e}=calculateElo(_0x1f994d[_0x377e98(0x107)]||0x4b0,_0x2e2e00[_0x377e98(0x107)]||0x4b0);let _0x2f5b61=_0x419f16,_0x242e9a=_0x36d942;if(_0x419f16>_0x36d942){console['log'](_0x377e98(0xfa)),_0x2f5b61=_0x36d942,_0x242e9a=_0x36d942+0x1;const _0x2fdb7d=query(collection(db,_0x377e98(0xeb)),where(_0x377e98(0x108),'>',_0x36d942),where('position','<',_0x419f16)),_0x250778=await getDocs(_0x2fdb7d);for(const _0x2fee61 of _0x250778[_0x377e98(0xf1)]){_0x2fee61['id']!==_0x1fc848&&_0x2fee61['id']!==_0x15cfb7&&_0x3511b8['update'](doc(db,'players',_0x2fee61['id']),{'position':_0x2fee61['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x2365bf={'eloRating':_0x4af185,'lastMatchDate':serverTimestamp(),'position':_0x2f5b61,'lastMatchId':_0x282960},_0x130f2f={'eloRating':_0x49d78e,'lastMatchDate':serverTimestamp(),'position':_0x242e9a,'lastMatchId':_0x282960};return _0x3511b8[_0x377e98(0xe7)](_0x34f9fc,_0x2365bf),_0x3511b8[_0x377e98(0xe7)](_0x9fc567,_0x130f2f),await _0x3511b8['commit'](),console['log'](_0x377e98(0xfc)),await Promise[_0x377e98(0x102)]([recordEloChange({'playerId':_0x1fc848,'previousElo':_0x1f994d[_0x377e98(0x107)]||0x4b0,'newElo':_0x4af185,'opponentId':_0x15cfb7,'matchResult':'win','previousPosition':_0x419f16,'newPosition':_0x2f5b61,'isPromotion':_0x2f5b61<_0x419f16,'matchId':_0x282960,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x15cfb7,'previousElo':_0x2e2e00['eloRating']||0x4b0,'newElo':_0x49d78e,'opponentId':_0x1fc848,'matchResult':_0x377e98(0xee),'previousPosition':_0x36d942,'newPosition':_0x242e9a,'isDemotion':_0x242e9a>_0x36d942,'matchId':_0x282960,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x1fc848,_0x4af185,_0x1f994d['eloRating'],{'source':_0x377e98(0xfb),'matchId':_0x282960}),await promotionManager[_0x377e98(0xf9)](_0x15cfb7,_0x49d78e,_0x2e2e00['eloRating'],{'source':'match','matchId':_0x282960}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x3f698d){console['error']('Error\x20in\x20updateEloRatings:',_0x3f698d);throw _0x3f698d;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x1c7a40,_0xc1347e,_0x165fbb,_0x5b2980,_0x3ffb1b){const _0x216da2=a28_0x151e;try{const _0x375b5a=doc(db,'pendingMatches',_0x1c7a40),_0x4a0b4b=await getDoc(_0x375b5a);if(!_0x4a0b4b['exists']())throw new Error('Report\x20not\x20found');const _0x1971ac=_0x4a0b4b['data'](),_0x51c670={..._0x1971ac,'winnerScore':_0xc1347e,'winnerSuicides':_0x165fbb,'winnerComment':_0x5b2980,'winnerDemoLink':_0x3ffb1b,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth[_0x216da2(0x106)]['uid']};await setDoc(doc(db,'approvedMatches',_0x1c7a40),_0x51c670),await deleteDoc(_0x375b5a),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x429831,_0x2ed7d3]=await Promise['all']([getDocs(query(collection(db,_0x216da2(0xeb)),where('username','==',_0x1971ac['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x1971ac['loserUsername'])))]);if(_0x429831['empty']||_0x2ed7d3[_0x216da2(0x109)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x3d179b=_0x429831['docs'][0x0]['id'],_0x390794=_0x2ed7d3['docs'][0x0]['id'];await updateEloRatings(_0x3d179b,_0x390794,_0x1c7a40);try{const _0x4ff15b=_0x1971ac['subgameType']||_0x216da2(0xff),_0x1289e2=POINTS_CHART[_0x4ff15b]||0xa,_0x3bddf6=doc(db,_0x216da2(0xe8),_0x3d179b),_0x16131a=doc(db,'userProfiles',_0x390794),[_0x57b1e2,_0x4975b5]=await Promise['all']([getDoc(_0x3bddf6),getDoc(_0x16131a)]);if(_0x57b1e2['exists']()&&_0x4975b5['exists']()){const _0x51e15d=_0x57b1e2['data'](),_0x47e15f=_0x4975b5['data'](),_0x2fb1db=_0x51e15d['points']||0x0,_0x2a2891=_0x47e15f['points']||0x0,_0x151b8e=_0x2fb1db+_0x1289e2,_0x36a05e=_0x2a2891+_0x1289e2;await Promise[_0x216da2(0x102)]([updateDoc(_0x3bddf6,{'points':_0x151b8e,'lastPointsModified':serverTimestamp()}),updateDoc(_0x16131a,{'points':_0x36a05e,'lastPointsModified':serverTimestamp()})]),await Promise[_0x216da2(0x102)]([addDoc(collection(db,'pointsHistory'),{'userId':_0x3d179b,'userEmail':_0x51e15d['email']||_0x216da2(0xf5),'displayName':_0x51e15d['displayName']||_0x51e15d['username']||_0x216da2(0xe9),'action':'add','amount':_0x1289e2,'previousPoints':_0x2fb1db,'newPoints':_0x151b8e,'reason':'Match\x20points:\x20'+_0x4ff15b+'\x20match\x20(Winner)','adminEmail':_0x216da2(0x103),'timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x390794,'userEmail':_0x47e15f['email']||'unknown','displayName':_0x47e15f['displayName']||_0x47e15f['username']||_0x216da2(0xe9),'action':'add','amount':_0x1289e2,'previousPoints':_0x2a2891,'newPoints':_0x36a05e,'reason':'Match\x20points:\x20'+_0x4ff15b+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console[_0x216da2(0xf2)]('Awarded\x20'+_0x1289e2+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x4ff15b+'\x20match');}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x1c9556){console[_0x216da2(0xec)](_0x216da2(0xe6),_0x1c9556);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x357561){console[_0x216da2(0xfd)]('Error\x20approving\x20report:',_0x357561);throw _0x357561;}}async function updatePlayerElo(_0x3130f3,_0x5bb707,_0x2b87b){await setDoc(doc(db,'players',_0x3130f3),{...playerData,'eloRating':_0x2b87b}),await checkAndRecordPromotion(_0x3130f3,_0x2b87b,_0x5bb707);}async function updatePlayerStats(_0x5b792e,_0x287002,_0x11c821){const _0x297489=a28_0x151e,_0x1776fa=doc(db,_0x297489(0x101),_0x5b792e),_0x54c98a=await getDoc(_0x1776fa);let _0x5efde9=_0x54c98a['exists']()?_0x54c98a['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x11c821?(_0x5efde9['wins']++,_0x5efde9['totalKills']+=parseInt(_0x287002['winnerScore']||0x0),_0x5efde9['totalDeaths']+=parseInt(_0x287002[_0x297489(0x105)]||0x0)):(_0x5efde9['losses']++,_0x5efde9[_0x297489(0xf3)]+=parseInt(_0x287002[_0x297489(0x105)]||0x0),_0x5efde9['totalDeaths']+=parseInt(_0x287002['winnerScore']||0x0));const _0x4623f5=_0x5efde9[_0x297489(0xef)]+_0x5efde9['losses'];_0x5efde9[_0x297489(0x104)]=_0x4623f5>0x0?(_0x5efde9['wins']/_0x4623f5*0x64)[_0x297489(0xf4)](0x1):0x0,_0x5efde9['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x1776fa,_0x5efde9,{'merge':!![]});}