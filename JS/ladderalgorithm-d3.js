const a27_0x4e4dd4=(function(){let _0x3cbbc3=!![];return function(_0x48a515,_0x346686){const _0x2195a0=_0x3cbbc3?function(){const _0x410a6d=a27_0x4a8a;if(_0x346686){const _0x35895d=_0x346686[_0x410a6d(0x7e)](_0x48a515,arguments);return _0x346686=null,_0x35895d;}}:function(){};return _0x3cbbc3=![],_0x2195a0;};}()),a27_0xdf8008=a27_0x4e4dd4(this,function(){const _0x4130de=a27_0x4a8a,_0x1ac1aa=function(){const _0x45f2b9=a27_0x4a8a;let _0x1aee2b;try{_0x1aee2b=Function('return\x20(function()\x20'+_0x45f2b9(0x8a)+');')();}catch(_0x4abbc7){_0x1aee2b=window;}return _0x1aee2b;},_0x4ece04=_0x1ac1aa(),_0x2f134f=_0x4ece04[_0x4130de(0x87)]=_0x4ece04['console']||{},_0x497fec=[_0x4130de(0x80),_0x4130de(0x7b),_0x4130de(0x8b),'error','exception',_0x4130de(0x82),_0x4130de(0x83)];for(let _0x43e65a=0x0;_0x43e65a<_0x497fec[_0x4130de(0x8f)];_0x43e65a++){const _0x41e28d=a27_0x4e4dd4['constructor'][_0x4130de(0x72)]['bind'](a27_0x4e4dd4),_0xac33bf=_0x497fec[_0x43e65a],_0x30e537=_0x2f134f[_0xac33bf]||_0x41e28d;_0x41e28d[_0x4130de(0x8e)]=a27_0x4e4dd4[_0x4130de(0x78)](a27_0x4e4dd4),_0x41e28d['toString']=_0x30e537[_0x4130de(0x89)]['bind'](_0x30e537),_0x2f134f[_0xac33bf]=_0x41e28d;}});a27_0xdf8008();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a27_0x2d09(){const _0x273791=['eloRating','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','exists','empty','all','prototype','MAX_SAFE_INTEGER','loserUsername','pow','error','currentUser','bind','No\x20user\x20logged\x20in','Current\x20user:','warn','Error\x20in\x20updateEloRatingsD3:','winnerUsername','apply','D3\x20Match\x20moved\x20to\x20approved\x20collection','log','playersD3','table','trace','win','commit','data','console','round','toString','{}.constructor(\x22return\x20this\x22)(\x20)','info','Error\x20in\x20approveReportD3:','position','__proto__','length'];a27_0x2d09=function(){return _0x273791;};return a27_0x2d09();}import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';function a27_0x4a8a(_0x16a1c8,_0x23b078){const _0xdf8008=a27_0x2d09();return a27_0x4a8a=function(_0x4e4dd4,_0x513883){_0x4e4dd4=_0x4e4dd4-0x6d;let _0x2d096b=_0xdf8008[_0x4e4dd4];return _0x2d096b;},a27_0x4a8a(_0x16a1c8,_0x23b078);}export function calculateEloD3(_0x1fde78,_0x3ed8ad,_0x4502d6=0x20){const _0x124c81=a27_0x4a8a,_0x1f39d7=0x1/(0x1+Math['pow'](0xa,(_0x3ed8ad-_0x1fde78)/0x190)),_0x5aa13d=0x1/(0x1+Math[_0x124c81(0x75)](0xa,(_0x1fde78-_0x3ed8ad)/0x190)),_0x36901a=_0x1fde78+_0x4502d6*(0x1-_0x1f39d7),_0x3376c8=_0x3ed8ad+_0x4502d6*(0x0-_0x5aa13d);return{'newWinnerRating':Math['round'](_0x36901a),'newLoserRating':Math[_0x124c81(0x88)](_0x3376c8)};}export async function updateEloRatingsD3(_0x27caf0,_0x3b7b66,_0x138218){const _0x1ff017=a27_0x4a8a;try{const _0x5b391a=writeBatch(db),_0x4e3f57=doc(db,_0x1ff017(0x81),_0x27caf0),_0x486d86=doc(db,_0x1ff017(0x81),_0x3b7b66),[_0x28b138,_0xee60f8]=await Promise[_0x1ff017(0x71)]([getDoc(_0x4e3f57),getDoc(_0x486d86)]);if(!_0x28b138[_0x1ff017(0x6f)]()||!_0xee60f8['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x39fef5=_0x28b138['data'](),_0x1ab7e9=_0xee60f8['data'](),_0x33bfd1=_0x39fef5['position']||Number['MAX_SAFE_INTEGER'],_0x20b27b=_0x1ab7e9[_0x1ff017(0x8d)]||Number[_0x1ff017(0x73)],{newWinnerRating:_0x470dd3,newLoserRating:_0x4e21ec}=calculateEloD3(_0x39fef5[_0x1ff017(0x6d)]||0x4b0,_0x1ab7e9['eloRating']||0x4b0);let _0x2740e0=_0x33bfd1,_0x1f5961=_0x20b27b;if(_0x33bfd1>_0x20b27b){console['log'](_0x1ff017(0x6e)),_0x2740e0=_0x20b27b,_0x1f5961=_0x20b27b+0x1;const _0x26570e=query(collection(db,'playersD3'),where('position','>',_0x20b27b),where('position','<',_0x33bfd1)),_0x3f5d75=await getDocs(_0x26570e);for(const _0x496a51 of _0x3f5d75['docs']){_0x496a51['id']!==_0x27caf0&&_0x496a51['id']!==_0x3b7b66&&_0x5b391a['update'](doc(db,'playersD3',_0x496a51['id']),{'position':_0x496a51[_0x1ff017(0x86)]()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x5b391a['update'](_0x4e3f57,{'eloRating':_0x470dd3,'lastMatchDate':serverTimestamp(),'position':_0x2740e0,'lastMatchId':_0x138218}),_0x5b391a['update'](_0x486d86,{'eloRating':_0x4e21ec,'lastMatchDate':serverTimestamp(),'position':_0x1f5961,'lastMatchId':_0x138218}),await _0x5b391a[_0x1ff017(0x85)](),console[_0x1ff017(0x80)]('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x1ff017(0x71)]([recordEloChangeD3({'playerId':_0x27caf0,'previousElo':_0x39fef5['eloRating']||0x4b0,'newElo':_0x470dd3,'opponentId':_0x3b7b66,'matchResult':_0x1ff017(0x84),'previousPosition':_0x33bfd1,'newPosition':_0x2740e0,'isPromotion':_0x2740e0<_0x33bfd1,'matchId':_0x138218,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x3b7b66,'previousElo':_0x1ab7e9[_0x1ff017(0x6d)]||0x4b0,'newElo':_0x4e21ec,'opponentId':_0x27caf0,'matchResult':'loss','previousPosition':_0x20b27b,'newPosition':_0x1f5961,'isDemotion':_0x1f5961>_0x20b27b,'matchId':_0x138218,'timestamp':serverTimestamp()})]),!![];}catch(_0xac6b9f){console[_0x1ff017(0x76)](_0x1ff017(0x7c),_0xac6b9f);throw _0xac6b9f;}}export async function approveReportD3(_0xce08a2,_0x215bfd,_0x7a136e,_0x3c29ce){const _0x598a7b=a27_0x4a8a;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0xce08a2,'winnerScore':_0x215bfd,'winnerSuicides':_0x7a136e,'winnerComment':_0x3c29ce});const _0xa5b673=auth[_0x598a7b(0x77)];if(!_0xa5b673){console['log'](_0x598a7b(0x79));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log'](_0x598a7b(0x7a),_0xa5b673['email']);const _0x3fee1c=await getDoc(doc(db,'playersD3',_0xa5b673['uid'])),_0x109b1f=_0x3fee1c[_0x598a7b(0x6f)]()?_0x3fee1c[_0x598a7b(0x86)]()['username']:null;console['log']('Current\x20username:',_0x109b1f);const _0x27e46b=doc(db,'pendingMatchesD3',_0xce08a2),_0x3def59=await getDoc(_0x27e46b);if(!_0x3def59[_0x598a7b(0x6f)]()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0xce08a2);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x9a415=_0x3def59[_0x598a7b(0x86)]();console['log']('D3\x20Report\x20data:',_0x9a415);if(_0x109b1f!==_0x9a415[_0x598a7b(0x7d)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x36df7f={..._0x9a415,'winnerScore':_0x215bfd,'winnerSuicides':_0x7a136e,'winnerComment':_0x3c29ce,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x109b1f,'createdAt':_0x9a415['createdAt']||serverTimestamp(),'winnerUsername':_0x9a415[_0x598a7b(0x7d)],'loserUsername':_0x9a415[_0x598a7b(0x74)]};await setDoc(doc(db,'approvedMatchesD3',_0xce08a2),_0x36df7f),await deleteDoc(_0x27e46b),console['log'](_0x598a7b(0x7f));const [_0x1b0ec5,_0x326388]=await Promise['all']([getDocs(query(collection(db,_0x598a7b(0x81)),where('username','==',_0x9a415['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x9a415['loserUsername'])))]);if(_0x1b0ec5[_0x598a7b(0x70)]||_0x326388['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x1072e4=_0x1b0ec5['docs'][0x0]['id'],_0x52daec=_0x326388['docs'][0x0]['id'];return await updateEloRatingsD3(_0x1072e4,_0x52daec,_0xce08a2),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3d8cbd){console[_0x598a7b(0x76)](_0x598a7b(0x8c),_0x3d8cbd);throw _0x3d8cbd;}}