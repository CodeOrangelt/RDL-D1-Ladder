const a27_0x3e1ee2=(function(){let _0x292cad=!![];return function(_0x3b6abb,_0x265a94){const _0x17ff16=_0x292cad?function(){if(_0x265a94){const _0x2e0bdc=_0x265a94['apply'](_0x3b6abb,arguments);return _0x265a94=null,_0x2e0bdc;}}:function(){};return _0x292cad=![],_0x17ff16;};}()),a27_0x7a4b00=a27_0x3e1ee2(this,function(){const _0x1ed993=a27_0x4357,_0x590f17=function(){const _0x525b7b=a27_0x4357;let _0x1e1013;try{_0x1e1013=Function('return\x20(function()\x20'+_0x525b7b(0xff)+');')();}catch(_0xb93d30){_0x1e1013=window;}return _0x1e1013;},_0x47ce48=_0x590f17(),_0x483604=_0x47ce48[_0x1ed993(0xf2)]=_0x47ce48[_0x1ed993(0xf2)]||{},_0x4e9b98=['log',_0x1ed993(0xfc),_0x1ed993(0xec),'error','exception',_0x1ed993(0xeb),_0x1ed993(0xf9)];for(let _0x52168b=0x0;_0x52168b<_0x4e9b98['length'];_0x52168b++){const _0x1502d0=a27_0x3e1ee2[_0x1ed993(0xed)]['prototype'][_0x1ed993(0xef)](a27_0x3e1ee2),_0x3b8225=_0x4e9b98[_0x52168b],_0x3874e5=_0x483604[_0x3b8225]||_0x1502d0;_0x1502d0['__proto__']=a27_0x3e1ee2['bind'](a27_0x3e1ee2),_0x1502d0['toString']=_0x3874e5['toString']['bind'](_0x3874e5),_0x483604[_0x3b8225]=_0x1502d0;}});a27_0x7a4b00();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x5061ea,_0xb55024,_0x58c8d1=0x20){const _0x5a991c=a27_0x4357,_0x4024e3=0x1/(0x1+Math[_0x5a991c(0xea)](0xa,(_0xb55024-_0x5061ea)/0x190)),_0x59ba54=0x1/(0x1+Math[_0x5a991c(0xea)](0xa,(_0x5061ea-_0xb55024)/0x190)),_0x161171=_0x5061ea+_0x58c8d1*(0x1-_0x4024e3),_0xfe8b58=_0xb55024+_0x58c8d1*(0x0-_0x59ba54);return{'newWinnerRating':Math['round'](_0x161171),'newLoserRating':Math['round'](_0xfe8b58)};}function a27_0x4a64(){const _0x41a462=['pow','table','info','constructor','No\x20user\x20logged\x20in','bind','playersD3','Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches','console','loserUsername','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','position','docs','winnerUsername','exists','trace','MAX_SAFE_INTEGER','Error\x20in\x20updateEloRatingsD3:','warn','D3\x20match\x20report\x20not\x20found','pendingMatchesD3','{}.constructor(\x22return\x20this\x22)(\x20)','eloRating','log'];a27_0x4a64=function(){return _0x41a462;};return a27_0x4a64();}function a27_0x4357(_0x4763ae,_0x2987f3){const _0x7a4b00=a27_0x4a64();return a27_0x4357=function(_0x3e1ee2,_0x3c174c){_0x3e1ee2=_0x3e1ee2-0xea;let _0x4a64f2=_0x7a4b00[_0x3e1ee2];return _0x4a64f2;},a27_0x4357(_0x4763ae,_0x2987f3);}export async function updateEloRatingsD3(_0x5e7a68,_0x40a1d2,_0x26ca63){const _0x3738ee=a27_0x4357;try{const _0x4d2702=writeBatch(db),_0xe9494d=doc(db,'playersD3',_0x5e7a68),_0x4cc014=doc(db,_0x3738ee(0xf0),_0x40a1d2),[_0x55fb4a,_0x5c155c]=await Promise['all']([getDoc(_0xe9494d),getDoc(_0x4cc014)]);if(!_0x55fb4a[_0x3738ee(0xf8)]()||!_0x5c155c['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x26ebd9=_0x55fb4a['data'](),_0x394f96=_0x5c155c['data'](),_0x53465c=_0x26ebd9['position']||Number['MAX_SAFE_INTEGER'],_0x161f11=_0x394f96[_0x3738ee(0xf5)]||Number[_0x3738ee(0xfa)],{newWinnerRating:_0x3b3a89,newLoserRating:_0x3a601d}=calculateEloD3(_0x26ebd9['eloRating']||0x4b0,_0x394f96[_0x3738ee(0x100)]||0x4b0);let _0x4a024b=_0x53465c,_0x3c532d=_0x161f11;if(_0x53465c>_0x161f11){console[_0x3738ee(0x101)](_0x3738ee(0xf4)),_0x4a024b=_0x161f11,_0x3c532d=_0x161f11+0x1;const _0x266614=query(collection(db,_0x3738ee(0xf0)),where('position','>',_0x161f11),where(_0x3738ee(0xf5),'<',_0x53465c)),_0x51951c=await getDocs(_0x266614);for(const _0x3095f2 of _0x51951c[_0x3738ee(0xf6)]){_0x3095f2['id']!==_0x5e7a68&&_0x3095f2['id']!==_0x40a1d2&&_0x4d2702['update'](doc(db,'playersD3',_0x3095f2['id']),{'position':_0x3095f2['data']()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x4d2702['update'](_0xe9494d,{'eloRating':_0x3b3a89,'lastMatchDate':serverTimestamp(),'position':_0x4a024b,'lastMatchId':_0x26ca63}),_0x4d2702['update'](_0x4cc014,{'eloRating':_0x3a601d,'lastMatchDate':serverTimestamp(),'position':_0x3c532d,'lastMatchId':_0x26ca63}),await _0x4d2702['commit'](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD3({'playerId':_0x5e7a68,'previousElo':_0x26ebd9[_0x3738ee(0x100)]||0x4b0,'newElo':_0x3b3a89,'opponentId':_0x40a1d2,'matchResult':'win','previousPosition':_0x53465c,'newPosition':_0x4a024b,'isPromotion':_0x4a024b<_0x53465c,'matchId':_0x26ca63,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x40a1d2,'previousElo':_0x394f96['eloRating']||0x4b0,'newElo':_0x3a601d,'opponentId':_0x5e7a68,'matchResult':'loss','previousPosition':_0x161f11,'newPosition':_0x3c532d,'isDemotion':_0x3c532d>_0x161f11,'matchId':_0x26ca63,'timestamp':serverTimestamp()})]),!![];}catch(_0x34d876){console['error'](_0x3738ee(0xfb),_0x34d876);throw _0x34d876;}}export async function approveReportD3(_0x2d18ee,_0x5ab0e6,_0x3e7e31,_0x373daa){const _0x2364a7=a27_0x4357;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x2d18ee,'winnerScore':_0x5ab0e6,'winnerSuicides':_0x3e7e31,'winnerComment':_0x373daa});const _0x2233d2=auth['currentUser'];if(!_0x2233d2){console['log'](_0x2364a7(0xee));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x2233d2['email']);const _0x20d536=await getDoc(doc(db,_0x2364a7(0xf0),_0x2233d2['uid'])),_0x2960d4=_0x20d536['exists']()?_0x20d536['data']()['username']:null;console['log']('Current\x20username:',_0x2960d4);const _0x31256b=doc(db,_0x2364a7(0xfe),_0x2d18ee),_0x481751=await getDoc(_0x31256b);if(!_0x481751['exists']()){console[_0x2364a7(0x101)]('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x2d18ee);throw new Error(_0x2364a7(0xfd));}const _0x552571=_0x481751['data']();console['log']('D3\x20Report\x20data:',_0x552571);if(_0x2960d4!==_0x552571['winnerUsername'])throw new Error(_0x2364a7(0xf1));const _0x184087={..._0x552571,'winnerScore':_0x5ab0e6,'winnerSuicides':_0x3e7e31,'winnerComment':_0x373daa,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x2960d4,'createdAt':_0x552571['createdAt']||serverTimestamp(),'winnerUsername':_0x552571['winnerUsername'],'loserUsername':_0x552571[_0x2364a7(0xf3)]};await setDoc(doc(db,'approvedMatchesD3',_0x2d18ee),_0x184087),await deleteDoc(_0x31256b),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x30076e,_0x2df454]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x552571[_0x2364a7(0xf7)]))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x552571[_0x2364a7(0xf3)])))]);if(_0x30076e['empty']||_0x2df454['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x481e28=_0x30076e[_0x2364a7(0xf6)][0x0]['id'],_0x1ee58a=_0x2df454['docs'][0x0]['id'];return await updateEloRatingsD3(_0x481e28,_0x1ee58a,_0x2d18ee),console[_0x2364a7(0x101)]('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3521a4){console['error']('Error\x20in\x20approveReportD3:',_0x3521a4);throw _0x3521a4;}}