(function(a,b){const u=a28b,c=a();while(!![]){try{const d=-parseInt(u(0x1de))/0x1*(parseInt(u(0x1c6))/0x2)+parseInt(u(0x1ce))/0x3+parseInt(u(0x1d2))/0x4*(parseInt(u(0x1d9))/0x5)+-parseInt(u(0x1ca))/0x6+-parseInt(u(0x1d8))/0x7+parseInt(u(0x1c8))/0x8*(parseInt(u(0x1bf))/0x9)+-parseInt(u(0x1cd))/0xa*(-parseInt(u(0x1d0))/0xb);if(d===b)break;else c['push'](c['shift']());}catch(e){c['push'](c['shift']());}}}(a28a,0xac309));import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a28b(a,b){const c=a28a();return a28b=function(d,e){d=d-0x1ba;let f=c[d];if(a28b['afLfVD']===undefined){var g=function(l){const m='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let n='',o='';for(let p=0x0,q,r,s=0x0;r=l['charAt'](s++);~r&&(q=p%0x4?q*0x40+r:r,p++%0x4)?n+=String['fromCharCode'](0xff&q>>(-0x2*p&0x6)):0x0){r=m['indexOf'](r);}for(let t=0x0,u=n['length'];t<u;t++){o+='%'+('00'+n['charCodeAt'](t)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(o);};a28b['ZWUXzN']=g,a=arguments,a28b['afLfVD']=!![];}const h=c[0x0],i=d+h,j=a[i];return!j?(f=a28b['ZWUXzN'](f),a[i]=f):f=j,f;},a28b(a,b);}import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28c from'./firebase-idle-wrapper.js';export function calculateEloD2(a,b,c=0x20){const v=a28b,d=0x1/(0x1+Math[v(0x1c2)](0xa,(b-a)/0x190)),e=0x1/(0x1+Math['pow'](0xa,(a-b)/0x190)),f=a+c*(0x1-d),g=b+c*(0x0-e);return{'newWinnerRating':Math['round'](f),'newLoserRating':Math['round'](g)};}export async function updateEloRatingsD2(a,b,c){const w=a28b;try{const d=writeBatch(db),e=doc(db,w(0x1ba),a),f=doc(db,'playersD2',b),[g,h]=await Promise['all']([getDoc(e),getDoc(f)]);if(!g['exists']()||!h[w(0x1d6)]())throw new Error(w(0x1c0));const i=g[w(0x1db)](),j=h[w(0x1db)](),k=i[w(0x1da)]||Number['MAX_SAFE_INTEGER'],l=j['position']||Number[w(0x1bd)],{newWinnerRating:m,newLoserRating:n}=calculateEloD2(i['eloRating']||0x4b0,j['eloRating']||0x4b0);let o=k,p=l;if(k>l){console['log'](w(0x1bc)),o=l,p=l+0x1;const q=query(collection(db,w(0x1ba)),where('position','>',l),where('position','<',k)),r=await getDocs(q);for(const s of r['docs']){s['id']!==a&&s['id']!==b&&d['update'](doc(db,'playersD2',s['id']),{'position':s[w(0x1db)]()[w(0x1da)]+0x1});}}else console[w(0x1d4)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return d[w(0x1be)](e,{'eloRating':m,'lastMatchDate':serverTimestamp(),'position':o,'lastMatchId':c}),d['update'](f,{'eloRating':n,'lastMatchDate':serverTimestamp(),'position':p,'lastMatchId':c}),await d['commit'](),console['log'](w(0x1d7)),await Promise[w(0x1e1)]([recordEloChangeD2({'playerId':a,'previousElo':i[w(0x1d1)]||0x4b0,'newElo':m,'opponentId':b,'matchResult':'win','previousPosition':k,'newPosition':o,'isPromotion':o<k,'matchId':c,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':b,'previousElo':j['eloRating']||0x4b0,'newElo':n,'opponentId':a,'matchResult':'loss','previousPosition':l,'newPosition':p,'isDemotion':p>l,'matchId':c,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](a,m,i['eloRating'],{'source':'match-d2','matchId':c}),await promotionManager['checkAndRecordPromotion'](b,n,j[w(0x1d1)],{'source':'match-d2','matchId':c}),!![];}catch(t){console['error']('Error\x20in\x20updateEloRatingsD2:',t);throw t;}}function a28a(){const y=['Bg9N','rxjYB3iGAw4GyxbWCM92zvjLCg9YDeqYoG','zxHPC3rZ','rdiGruXpihjHDgLUz3mGDxbKyxrLzcbZDwnJzxnZzNvSBhK','mJqWnZC1nu5OyLn0DG','mJG2nduZmfjRzKPSBq','Cg9ZAxrPB24','zgf0yq','rdiGtwf0y2GGBw92zwqGDg8GyxbWCM92zwqGy29SBgvJDgLVBG','Bg9ZzxjvC2vYBMfTzq','muXzBKvgDG','zw1HAwW','zg9JCW','ywXS','zw1WDhK','tM8GDxnLCIbSB2DNzwqGAw4','CgXHEwvYC0qY','t25SEsb0AguGD2LUBMvYignHBIbHChbYB3zLieqYig1HDgnOzxm','rdiGug9ZAxrPB24GC3DHCcbUzwvKzwqGlsb3Aw5UzxiGD2fZigXVD2vYihjHBMTLza','tufyx1nbrKvFsu5uruDfuG','DxbKyxrL','ndu1ndLMB2TyDvG','t25Lig9YigjVDgGGrdiGCgXHEwvYCYbUB3qGzM91BMq','DwLK','Cg93','rdiGBwf0y2GGCMvWB3j0ig5VDcbMB3vUza','rdiGuMvWB3j0igrHDge6','zxjYB3i','mtiWodiYmMrQC2fNza','CgvUzgLUz01HDgnOzxnemG','mtKYoeDXv0TUDa','q291BgqGBM90igzPBMqGrdiGCgXHEwvYigrVy3vTzw50CW','nJm0odi1og5hB3HyCG','q3vYCMvUDcb1C2vYBMfTztO','DxnLCM5HBwu','mtuYmdmWBvnytfPg','otaWodu4r1jmCwHH','rdiGuMvWB3j0ig5VDcbMB3vUzcb3AxrOieLeoG','mZncwuzpB3e','zwXVuMf0Aw5N','ogvQEhHjCq','D2LUBMvYvxnLCM5HBwu'];a28a=function(){return y;};return a28a();}export async function approveReportD2(a,b,c,d){const x=a28b;try{console[x(0x1d4)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':a,'winnerScore':b,'winnerSuicides':c,'winnerComment':d});const e=auth['currentUser'];if(!e){console[x(0x1d4)](x(0x1e3));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',e[x(0x1df)]);const f=await getDoc(doc(db,'playersD2',e[x(0x1c1)])),g=f[x(0x1d6)]()?f['data']()['username']:null;console[x(0x1d4)](x(0x1cb),g);const h=doc(db,x(0x1c7),a),i=await getDoc(h);if(!i[x(0x1d6)]()){console['log'](x(0x1cf),a);throw new Error(x(0x1c3));}const j=i['data']();console['log'](x(0x1c4),j);if(g!==j[x(0x1d3)])throw new Error(x(0x1bb));const k={...j,'winnerScore':b,'winnerSuicides':c,'winnerComment':d,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':g,'createdAt':j['createdAt']||serverTimestamp(),'winnerUsername':j[x(0x1d3)],'loserUsername':j[x(0x1dd)]};await setDoc(doc(db,'approvedMatchesD2',a),k),await deleteDoc(h),console['log'](x(0x1dc));const [l,m]=await Promise[x(0x1e1)]([getDocs(query(collection(db,'playersD2'),where('username','==',j[x(0x1d3)]))),getDocs(query(collection(db,x(0x1ba)),where(x(0x1cc),'==',j[x(0x1dd)])))]);if(l['empty']||m[x(0x1e2)])throw new Error(x(0x1c9));const n=l[x(0x1e0)][0x0]['id'],o=m['docs'][0x0]['id'];return await updateEloRatingsD2(n,o,a),console[x(0x1d4)]('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(p){console[x(0x1c5)](x(0x1d5),p);throw p;}}