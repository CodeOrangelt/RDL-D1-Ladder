const a29_0x1ecc46=(function(){let _0x53bb80=!![];return function(_0x3f2597,_0x513565){const _0x288f94=_0x53bb80?function(){if(_0x513565){const _0x16d900=_0x513565['apply'](_0x3f2597,arguments);return _0x513565=null,_0x16d900;}}:function(){};return _0x53bb80=![],_0x288f94;};}()),a29_0x3ad6ef=a29_0x1ecc46(this,function(){const _0x5436bc=a29_0x3592;let _0x573541;try{const _0x2d1f3a=Function(_0x5436bc(0xe2)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x573541=_0x2d1f3a();}catch(_0x37d59e){_0x573541=window;}const _0x22443f=_0x573541[_0x5436bc(0xed)]=_0x573541['console']||{},_0x34263a=['log','warn','info',_0x5436bc(0xe6),'exception','table','trace'];for(let _0x5919df=0x0;_0x5919df<_0x34263a['length'];_0x5919df++){const _0x23ade9=a29_0x1ecc46['constructor']['prototype']['bind'](a29_0x1ecc46),_0x50e5ab=_0x34263a[_0x5919df],_0x1975c3=_0x22443f[_0x50e5ab]||_0x23ade9;_0x23ade9[_0x5436bc(0xf0)]=a29_0x1ecc46['bind'](a29_0x1ecc46),_0x23ade9['toString']=_0x1975c3[_0x5436bc(0xe5)]['bind'](_0x1975c3),_0x22443f[_0x50e5ab]=_0x23ade9;}});function a29_0x4a98(){const _0x6da75=['D3\x20Report\x20not\x20found\x20with\x20ID:','Error\x20in\x20updateEloRatingsD3:','docs','email','No\x20user\x20logged\x20in','return\x20(function()\x20','position','empty','toString','error','playersD3','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches','round','data','win','loss','console','update','pendingMatchesD3','__proto__','log','D3\x20Report\x20data:','username','exists','eloRating'];a29_0x4a98=function(){return _0x6da75;};return a29_0x4a98();}a29_0x3ad6ef();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a29_0x3592(_0x5ca656,_0x4c4907){const _0x3ad6ef=a29_0x4a98();return a29_0x3592=function(_0x1ecc46,_0x6c2b00){_0x1ecc46=_0x1ecc46-0xdd;let _0x4a9803=_0x3ad6ef[_0x1ecc46];return _0x4a9803;},a29_0x3592(_0x5ca656,_0x4c4907);}import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x352cfe,_0x725c7c,_0x537b05=0x20){const _0x4847cc=a29_0x3592,_0x3d5880=0x1/(0x1+Math['pow'](0xa,(_0x725c7c-_0x352cfe)/0x190)),_0x347ce0=0x1/(0x1+Math['pow'](0xa,(_0x352cfe-_0x725c7c)/0x190)),_0x55fdd8=_0x352cfe+_0x537b05*(0x1-_0x3d5880),_0x292e61=_0x725c7c+_0x537b05*(0x0-_0x347ce0);return{'newWinnerRating':Math['round'](_0x55fdd8),'newLoserRating':Math[_0x4847cc(0xe9)](_0x292e61)};}export async function updateEloRatingsD3(_0x5f356a,_0x24dfcc,_0x367506){const _0x4b0779=a29_0x3592;try{const _0x2d42ea=writeBatch(db),_0x294700=doc(db,_0x4b0779(0xe7),_0x5f356a),_0x112c03=doc(db,'playersD3',_0x24dfcc),[_0x236770,_0x740eb5]=await Promise['all']([getDoc(_0x294700),getDoc(_0x112c03)]);if(!_0x236770['exists']()||!_0x740eb5[_0x4b0779(0xf4)]())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x131829=_0x236770[_0x4b0779(0xea)](),_0x1b1f6c=_0x740eb5[_0x4b0779(0xea)](),_0x38d592=_0x131829[_0x4b0779(0xe3)]||Number['MAX_SAFE_INTEGER'],_0x174670=_0x1b1f6c['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x21ea6e,newLoserRating:_0x394526}=calculateEloD3(_0x131829[_0x4b0779(0xf5)]||0x4b0,_0x1b1f6c[_0x4b0779(0xf5)]||0x4b0);let _0x3b1a47=_0x38d592,_0x36e2e2=_0x174670;if(_0x38d592>_0x174670){console[_0x4b0779(0xf1)]('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x3b1a47=_0x174670,_0x36e2e2=_0x174670+0x1;const _0x5dde0e=query(collection(db,_0x4b0779(0xe7)),where(_0x4b0779(0xe3),'>',_0x174670),where(_0x4b0779(0xe3),'<',_0x38d592)),_0x39c8bf=await getDocs(_0x5dde0e);for(const _0x28b106 of _0x39c8bf[_0x4b0779(0xdf)]){_0x28b106['id']!==_0x5f356a&&_0x28b106['id']!==_0x24dfcc&&_0x2d42ea['update'](doc(db,'playersD3',_0x28b106['id']),{'position':_0x28b106['data']()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x2d42ea['update'](_0x294700,{'eloRating':_0x21ea6e,'lastMatchDate':serverTimestamp(),'position':_0x3b1a47,'lastMatchId':_0x367506}),_0x2d42ea[_0x4b0779(0xee)](_0x112c03,{'eloRating':_0x394526,'lastMatchDate':serverTimestamp(),'position':_0x36e2e2,'lastMatchId':_0x367506}),await _0x2d42ea['commit'](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD3({'playerId':_0x5f356a,'previousElo':_0x131829[_0x4b0779(0xf5)]||0x4b0,'newElo':_0x21ea6e,'opponentId':_0x24dfcc,'matchResult':_0x4b0779(0xeb),'previousPosition':_0x38d592,'newPosition':_0x3b1a47,'isPromotion':_0x3b1a47<_0x38d592,'matchId':_0x367506,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x24dfcc,'previousElo':_0x1b1f6c['eloRating']||0x4b0,'newElo':_0x394526,'opponentId':_0x5f356a,'matchResult':_0x4b0779(0xec),'previousPosition':_0x174670,'newPosition':_0x36e2e2,'isDemotion':_0x36e2e2>_0x174670,'matchId':_0x367506,'timestamp':serverTimestamp()})]),!![];}catch(_0x5118ac){console['error'](_0x4b0779(0xde),_0x5118ac);throw _0x5118ac;}}export async function approveReportD3(_0x1f6d83,_0x2e6419,_0x2bd5ff,_0x29c75e){const _0x3765e7=a29_0x3592;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x1f6d83,'winnerScore':_0x2e6419,'winnerSuicides':_0x2bd5ff,'winnerComment':_0x29c75e});const _0x24d745=auth['currentUser'];if(!_0x24d745){console[_0x3765e7(0xf1)](_0x3765e7(0xe1));throw new Error(_0x3765e7(0xe8));}console['log']('Current\x20user:',_0x24d745[_0x3765e7(0xe0)]);const _0x4616cc=await getDoc(doc(db,'playersD3',_0x24d745['uid'])),_0xd31d54=_0x4616cc['exists']()?_0x4616cc['data']()[_0x3765e7(0xf3)]:null;console['log']('Current\x20username:',_0xd31d54);const _0xa2f26e=doc(db,_0x3765e7(0xef),_0x1f6d83),_0x51e937=await getDoc(_0xa2f26e);if(!_0x51e937['exists']()){console['log'](_0x3765e7(0xdd),_0x1f6d83);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x2d577b=_0x51e937['data']();console[_0x3765e7(0xf1)](_0x3765e7(0xf2),_0x2d577b);if(_0xd31d54!==_0x2d577b['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x1fc497={..._0x2d577b,'winnerScore':_0x2e6419,'winnerSuicides':_0x2bd5ff,'winnerComment':_0x29c75e,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0xd31d54,'createdAt':_0x2d577b['createdAt']||serverTimestamp(),'winnerUsername':_0x2d577b['winnerUsername'],'loserUsername':_0x2d577b['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x1f6d83),_0x1fc497),await deleteDoc(_0xa2f26e),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x35b5b8,_0x5ae871]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where(_0x3765e7(0xf3),'==',_0x2d577b['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x2d577b['loserUsername'])))]);if(_0x35b5b8['empty']||_0x5ae871[_0x3765e7(0xe4)])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x392e57=_0x35b5b8[_0x3765e7(0xdf)][0x0]['id'],_0x47d91b=_0x5ae871[_0x3765e7(0xdf)][0x0]['id'];return await updateEloRatingsD3(_0x392e57,_0x47d91b,_0x1f6d83),console[_0x3765e7(0xf1)]('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x5396e8){console[_0x3765e7(0xe6)]('Error\x20in\x20approveReportD3:',_0x5396e8);throw _0x5396e8;}}