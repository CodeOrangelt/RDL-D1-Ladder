const a28_0x52d0d3=(function(){let _0xea57ad=!![];return function(_0x4382c3,_0x4b1335){const _0x4358a5=_0xea57ad?function(){if(_0x4b1335){const _0x5c3b52=_0x4b1335['apply'](_0x4382c3,arguments);return _0x4b1335=null,_0x5c3b52;}}:function(){};return _0xea57ad=![],_0x4358a5;};}()),a28_0x5b61e1=a28_0x52d0d3(this,function(){const _0x4fb72d=a28_0x2837,_0x3b12a9=function(){const _0x414791=a28_0x2837;let _0x4c6f84;try{_0x4c6f84=Function('return\x20(function()\x20'+_0x414791(0x109)+');')();}catch(_0x482c47){_0x4c6f84=window;}return _0x4c6f84;},_0x257532=_0x3b12a9(),_0x24c90b=_0x257532['console']=_0x257532['console']||{},_0x46160a=['log','warn',_0x4fb72d(0xef),'error',_0x4fb72d(0xee),'table',_0x4fb72d(0x105)];for(let _0x1801aa=0x0;_0x1801aa<_0x46160a[_0x4fb72d(0xf1)];_0x1801aa++){const _0x5c85ad=a28_0x52d0d3['constructor'][_0x4fb72d(0x102)]['bind'](a28_0x52d0d3),_0x139e97=_0x46160a[_0x1801aa],_0x56347b=_0x24c90b[_0x139e97]||_0x5c85ad;_0x5c85ad[_0x4fb72d(0xf8)]=a28_0x52d0d3[_0x4fb72d(0x101)](a28_0x52d0d3),_0x5c85ad['toString']=_0x56347b['toString']['bind'](_0x56347b),_0x24c90b[_0x139e97]=_0x5c85ad;}});a28_0x5b61e1();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';function a28_0x18be(){const _0x2b001e=['win','exception','info','D2\x20Report\x20data:','length','uid','update','Starting\x20approveReportD2\x20function\x20with:','position','eloRating','email','__proto__','Current\x20username:','data','username','checkAndRecordPromotion','empty','round','winnerUsername','log','bind','prototype','docs','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','trace','approvedMatchesD2','loserUsername','match-d2','{}.constructor(\x22return\x20this\x22)(\x20)'];a28_0x18be=function(){return _0x2b001e;};return a28_0x18be();}function a28_0x2837(_0x55dab2,_0x4bc164){const _0x5b61e1=a28_0x18be();return a28_0x2837=function(_0x52d0d3,_0x55ee1a){_0x52d0d3=_0x52d0d3-0xed;let _0x18be00=_0x5b61e1[_0x52d0d3];return _0x18be00;},a28_0x2837(_0x55dab2,_0x4bc164);}import{promotionManager}from'./promotions.js';import a28_0x1f8e53 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x5c6071,_0x74e664,_0x30b610=0x20){const _0x51ca27=a28_0x2837,_0x3bfcc5=0x1/(0x1+Math['pow'](0xa,(_0x74e664-_0x5c6071)/0x190)),_0x561562=0x1/(0x1+Math['pow'](0xa,(_0x5c6071-_0x74e664)/0x190)),_0x39e47b=_0x5c6071+_0x30b610*(0x1-_0x3bfcc5),_0x3f6334=_0x74e664+_0x30b610*(0x0-_0x561562);return{'newWinnerRating':Math['round'](_0x39e47b),'newLoserRating':Math[_0x51ca27(0xfe)](_0x3f6334)};}export async function updateEloRatingsD2(_0x11b3c4,_0x1230dc,_0x11747a){const _0x39bc6c=a28_0x2837;try{const _0x63570e=writeBatch(db),_0x122dbe=doc(db,'playersD2',_0x11b3c4),_0x4dd9cd=doc(db,'playersD2',_0x1230dc),[_0x1f82de,_0x39c67e]=await Promise['all']([getDoc(_0x122dbe),getDoc(_0x4dd9cd)]);if(!_0x1f82de['exists']()||!_0x39c67e['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x5a24f3=_0x1f82de['data'](),_0x595010=_0x39c67e['data'](),_0x4eb14e=_0x5a24f3[_0x39bc6c(0xf5)]||Number['MAX_SAFE_INTEGER'],_0xe9fb4f=_0x595010['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x45b65d,newLoserRating:_0x4866f4}=calculateEloD2(_0x5a24f3['eloRating']||0x4b0,_0x595010['eloRating']||0x4b0);let _0x444e25=_0x4eb14e,_0x4006d5=_0xe9fb4f;if(_0x4eb14e>_0xe9fb4f){console[_0x39bc6c(0x100)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x444e25=_0xe9fb4f,_0x4006d5=_0xe9fb4f+0x1;const _0x5a3490=query(collection(db,'playersD2'),where('position','>',_0xe9fb4f),where('position','<',_0x4eb14e)),_0x2fade9=await getDocs(_0x5a3490);for(const _0x27d3f8 of _0x2fade9[_0x39bc6c(0x103)]){_0x27d3f8['id']!==_0x11b3c4&&_0x27d3f8['id']!==_0x1230dc&&_0x63570e[_0x39bc6c(0xf3)](doc(db,'playersD2',_0x27d3f8['id']),{'position':_0x27d3f8['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x63570e['update'](_0x122dbe,{'eloRating':_0x45b65d,'lastMatchDate':serverTimestamp(),'position':_0x444e25,'lastMatchId':_0x11747a}),_0x63570e['update'](_0x4dd9cd,{'eloRating':_0x4866f4,'lastMatchDate':serverTimestamp(),'position':_0x4006d5,'lastMatchId':_0x11747a}),await _0x63570e['commit'](),console[_0x39bc6c(0x100)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x11b3c4,'previousElo':_0x5a24f3['eloRating']||0x4b0,'newElo':_0x45b65d,'opponentId':_0x1230dc,'matchResult':_0x39bc6c(0xed),'previousPosition':_0x4eb14e,'newPosition':_0x444e25,'isPromotion':_0x444e25<_0x4eb14e,'matchId':_0x11747a,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x1230dc,'previousElo':_0x595010[_0x39bc6c(0xf6)]||0x4b0,'newElo':_0x4866f4,'opponentId':_0x11b3c4,'matchResult':'loss','previousPosition':_0xe9fb4f,'newPosition':_0x4006d5,'isDemotion':_0x4006d5>_0xe9fb4f,'matchId':_0x11747a,'timestamp':serverTimestamp()})]),await promotionManager[_0x39bc6c(0xfc)](_0x11b3c4,_0x45b65d,_0x5a24f3[_0x39bc6c(0xf6)],{'source':_0x39bc6c(0x108),'matchId':_0x11747a}),await promotionManager['checkAndRecordPromotion'](_0x1230dc,_0x4866f4,_0x595010['eloRating'],{'source':'match-d2','matchId':_0x11747a}),!![];}catch(_0x2ff94e){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x2ff94e);throw _0x2ff94e;}}export async function approveReportD2(_0x253e7d,_0x13f7e0,_0x299b87,_0x1fa1e9){const _0x591e57=a28_0x2837;try{console['log'](_0x591e57(0xf4),{'reportId':_0x253e7d,'winnerScore':_0x13f7e0,'winnerSuicides':_0x299b87,'winnerComment':_0x1fa1e9});const _0x5c532b=auth['currentUser'];if(!_0x5c532b){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console[_0x591e57(0x100)]('Current\x20user:',_0x5c532b[_0x591e57(0xf7)]);const _0x4c0cb5=await getDoc(doc(db,'playersD2',_0x5c532b[_0x591e57(0xf2)])),_0x148409=_0x4c0cb5['exists']()?_0x4c0cb5[_0x591e57(0xfa)]()['username']:null;console['log'](_0x591e57(0xf9),_0x148409);const _0x5b4e38=doc(db,'pendingMatchesD2',_0x253e7d),_0x448044=await getDoc(_0x5b4e38);if(!_0x448044['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x253e7d);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x59f28b=_0x448044['data']();console['log'](_0x591e57(0xf0),_0x59f28b);if(_0x148409!==_0x59f28b[_0x591e57(0xff)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x5e2074={..._0x59f28b,'winnerScore':_0x13f7e0,'winnerSuicides':_0x299b87,'winnerComment':_0x1fa1e9,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x148409,'createdAt':_0x59f28b['createdAt']||serverTimestamp(),'winnerUsername':_0x59f28b['winnerUsername'],'loserUsername':_0x59f28b[_0x591e57(0x107)]};await setDoc(doc(db,_0x591e57(0x106),_0x253e7d),_0x5e2074),await deleteDoc(_0x5b4e38),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x101b06,_0x25b43f]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x59f28b['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where(_0x591e57(0xfb),'==',_0x59f28b['loserUsername'])))]);if(_0x101b06['empty']||_0x25b43f[_0x591e57(0xfd)])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x4bd426=_0x101b06['docs'][0x0]['id'],_0x6caf52=_0x25b43f['docs'][0x0]['id'];return await updateEloRatingsD2(_0x4bd426,_0x6caf52,_0x253e7d),console[_0x591e57(0x100)](_0x591e57(0x104)),!![];}catch(_0x40d075){console['error']('Error\x20in\x20approveReportD2:',_0x40d075);throw _0x40d075;}}