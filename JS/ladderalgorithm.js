const a28_0xb26191=(function(){let _0x14f9e0=!![];return function(_0x561318,_0x4aac9c){const _0x593cda=_0x14f9e0?function(){if(_0x4aac9c){const _0x31fb7b=_0x4aac9c['apply'](_0x561318,arguments);return _0x4aac9c=null,_0x31fb7b;}}:function(){};return _0x14f9e0=![],_0x593cda;};}()),a28_0x176823=a28_0xb26191(this,function(){const _0x5732f6=a28_0x3fc4,_0x5e78d7=function(){const _0xb34e0b=a28_0x3fc4;let _0x13b328;try{_0x13b328=Function(_0xb34e0b(0x19c)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x44ef14){_0x13b328=window;}return _0x13b328;},_0x42b85f=_0x5e78d7(),_0x212881=_0x42b85f['console']=_0x42b85f['console']||{},_0x4f46f1=['log',_0x5732f6(0x1a0),'info','error',_0x5732f6(0x1b8),_0x5732f6(0x19a),'trace'];for(let _0x4b7f14=0x0;_0x4b7f14<_0x4f46f1[_0x5732f6(0x1b2)];_0x4b7f14++){const _0x2581c3=a28_0xb26191[_0x5732f6(0x198)][_0x5732f6(0x1b7)]['bind'](a28_0xb26191),_0xebfe42=_0x4f46f1[_0x4b7f14],_0x37991d=_0x212881[_0xebfe42]||_0x2581c3;_0x2581c3['__proto__']=a28_0xb26191['bind'](a28_0xb26191),_0x2581c3['toString']=_0x37991d['toString']['bind'](_0x37991d),_0x212881[_0xebfe42]=_0x2581c3;}});a28_0x176823();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';function a28_0x150f(){const _0x2a8c2d=['constructor','approvedMatches','table','empty','return\x20(function()\x20','currentUser','toISOString','position','warn','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','system-match-award','data','playerStats','collection','win','checkAndRecordPromotion','winnerScore','Error\x20in\x20updateEloRatings:','pow','round','totalDeaths','docs','toFixed','all','wins','username','length','\x20points\x20to\x20both\x20players\x20for\x20','eloRating','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','log','prototype','exception','Match\x20moved\x20to\x20approved\x20collection','userProfiles','players','match'];a28_0x150f=function(){return _0x2a8c2d;};return a28_0x150f();}import{promotionManager,checkAndRecordPromotion}from'./promotions.js';function a28_0x3fc4(_0x364187,_0x925168){const _0x176823=a28_0x150f();return a28_0x3fc4=function(_0xb26191,_0x43916a){_0xb26191=_0xb26191-0x198;let _0x150fd5=_0x176823[_0xb26191];return _0x150fd5;},a28_0x3fc4(_0x364187,_0x925168);}import{isAdmin}from'./admin-check.js';export function calculateElo(_0x10ea1a,_0xbda604,_0x446b21=0x20){const _0x5573a4=a28_0x3fc4,_0x5b6f69=0x1/(0x1+Math[_0x5573a4(0x1aa)](0xa,(_0xbda604-_0x10ea1a)/0x190)),_0x49d434=0x1/(0x1+Math[_0x5573a4(0x1aa)](0xa,(_0x10ea1a-_0xbda604)/0x190)),_0x1400aa=_0x10ea1a+_0x446b21*(0x1-_0x5b6f69),_0x1d033c=_0xbda604+_0x446b21*(0x0-_0x49d434);return{'newWinnerRating':Math[_0x5573a4(0x1ab)](_0x1400aa),'newLoserRating':Math['round'](_0x1d033c)};}export function assignDefaultEloRating(_0x2904e2,_0x3a94e0){const _0x21bc2f=a28_0x3fc4,_0x230f51=0x4b0;!_0x3a94e0['eloRating']&&db[_0x21bc2f(0x1a5)]('players')['doc'](_0x2904e2)['update']({'eloRating':_0x230f51})['then'](()=>{const _0xa747db=_0x21bc2f;console['log'](_0xa747db(0x1b5)+_0x3a94e0['username']);})['catch'](_0xb748b5=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0xb748b5);});}export async function updateEloRatings(_0xe4225b,_0x1c0c94,_0x5f43cb){const _0x5667cc=a28_0x3fc4;try{const _0x17f098=writeBatch(db),_0x34ab29=doc(db,'players',_0xe4225b),_0x5845fd=doc(db,_0x5667cc(0x1bb),_0x1c0c94),[_0x6d0dde,_0x560ea1]=await Promise['all']([getDoc(_0x34ab29),getDoc(_0x5845fd)]);if(!_0x6d0dde['exists']()||!_0x560ea1['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x153248=_0x6d0dde['data'](),_0x2ea08d=_0x560ea1['data'](),_0x21883d=_0x153248[_0x5667cc(0x19f)]||Number['MAX_SAFE_INTEGER'],_0x11654a=_0x2ea08d[_0x5667cc(0x19f)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x542a7f,newLoserRating:_0x4ef271}=calculateElo(_0x153248[_0x5667cc(0x1b4)]||0x4b0,_0x2ea08d['eloRating']||0x4b0);let _0x4a3029=_0x21883d,_0x4fd12a=_0x11654a;if(_0x21883d>_0x11654a){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4a3029=_0x11654a,_0x4fd12a=_0x11654a+0x1;const _0x4b57a3=query(collection(db,'players'),where('position','>',_0x11654a),where(_0x5667cc(0x19f),'<',_0x21883d)),_0x136ce0=await getDocs(_0x4b57a3);for(const _0x4db833 of _0x136ce0['docs']){_0x4db833['id']!==_0xe4225b&&_0x4db833['id']!==_0x1c0c94&&_0x17f098['update'](doc(db,'players',_0x4db833['id']),{'position':_0x4db833['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x246230={'eloRating':_0x542a7f,'lastMatchDate':serverTimestamp(),'position':_0x4a3029,'lastMatchId':_0x5f43cb},_0x23fc4e={'eloRating':_0x4ef271,'lastMatchDate':serverTimestamp(),'position':_0x4fd12a,'lastMatchId':_0x5f43cb};return _0x17f098['update'](_0x34ab29,_0x246230),_0x17f098['update'](_0x5845fd,_0x23fc4e),await _0x17f098['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0xe4225b,'previousElo':_0x153248[_0x5667cc(0x1b4)]||0x4b0,'newElo':_0x542a7f,'opponentId':_0x1c0c94,'matchResult':_0x5667cc(0x1a6),'previousPosition':_0x21883d,'newPosition':_0x4a3029,'isPromotion':_0x4a3029<_0x21883d,'matchId':_0x5f43cb,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x1c0c94,'previousElo':_0x2ea08d['eloRating']||0x4b0,'newElo':_0x4ef271,'opponentId':_0xe4225b,'matchResult':'loss','previousPosition':_0x11654a,'newPosition':_0x4fd12a,'isDemotion':_0x4fd12a>_0x11654a,'matchId':_0x5f43cb,'timestamp':serverTimestamp()})]),await promotionManager[_0x5667cc(0x1a7)](_0xe4225b,_0x542a7f,_0x153248['eloRating'],{'source':_0x5667cc(0x1bc),'matchId':_0x5f43cb}),await promotionManager['checkAndRecordPromotion'](_0x1c0c94,_0x4ef271,_0x2ea08d['eloRating'],{'source':'match','matchId':_0x5f43cb}),console['log'](_0x5667cc(0x1a1)),!![];}catch(_0x987c4f){console['error'](_0x5667cc(0x1a9),_0x987c4f);throw _0x987c4f;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x32dd64,_0x54b8f9,_0x41fa49,_0x15c9a6,_0x27d6a5){const _0xb3425f=a28_0x3fc4;try{const _0x29f16c=doc(db,'pendingMatches',_0x32dd64),_0x252c23=await getDoc(_0x29f16c);if(!_0x252c23['exists']())throw new Error('Report\x20not\x20found');const _0x2d23f9=_0x252c23['data'](),_0x93f7d3={..._0x2d23f9,'winnerScore':_0x54b8f9,'winnerSuicides':_0x41fa49,'winnerComment':_0x15c9a6,'winnerDemoLink':_0x27d6a5,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth[_0xb3425f(0x19d)]['uid']};await setDoc(doc(db,_0xb3425f(0x199),_0x32dd64),_0x93f7d3),await deleteDoc(_0x29f16c),console['log'](_0xb3425f(0x1b9));const [_0x3f63ee,_0x539271]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x2d23f9['winnerUsername']))),getDocs(query(collection(db,_0xb3425f(0x1bb)),where('username','==',_0x2d23f9['loserUsername'])))]);if(_0x3f63ee['empty']||_0x539271[_0xb3425f(0x19b)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x5102d1=_0x3f63ee['docs'][0x0]['id'],_0x45facf=_0x539271[_0xb3425f(0x1ad)][0x0]['id'];await updateEloRatings(_0x5102d1,_0x45facf,_0x32dd64);try{const _0x37d041=_0x2d23f9['subgameType']||'Standard',_0xc3eb39=POINTS_CHART[_0x37d041]||0xa,_0xc9de8b=doc(db,'userProfiles',_0x5102d1),_0x960b19=doc(db,_0xb3425f(0x1ba),_0x45facf),[_0x49fc33,_0xb4ed43]=await Promise[_0xb3425f(0x1af)]([getDoc(_0xc9de8b),getDoc(_0x960b19)]);if(_0x49fc33['exists']()&&_0xb4ed43['exists']()){const _0x362562=_0x49fc33[_0xb3425f(0x1a3)](),_0x116c0c=_0xb4ed43['data'](),_0x13a9b7=_0x362562['points']||0x0,_0x4cabb8=_0x116c0c['points']||0x0,_0x59eba0=_0x13a9b7+_0xc3eb39,_0x123066=_0x4cabb8+_0xc3eb39;await Promise[_0xb3425f(0x1af)]([updateDoc(_0xc9de8b,{'points':_0x59eba0,'lastPointsModified':serverTimestamp()}),updateDoc(_0x960b19,{'points':_0x123066,'lastPointsModified':serverTimestamp()})]),await Promise[_0xb3425f(0x1af)]([addDoc(collection(db,'pointsHistory'),{'userId':_0x5102d1,'userEmail':_0x362562['email']||'unknown','displayName':_0x362562['displayName']||_0x362562[_0xb3425f(0x1b1)]||'Unknown\x20User','action':'add','amount':_0xc3eb39,'previousPoints':_0x13a9b7,'newPoints':_0x59eba0,'reason':'Match\x20points:\x20'+_0x37d041+'\x20match\x20(Winner)','adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x45facf,'userEmail':_0x116c0c['email']||'unknown','displayName':_0x116c0c['displayName']||_0x116c0c['username']||'Unknown\x20User','action':'add','amount':_0xc3eb39,'previousPoints':_0x4cabb8,'newPoints':_0x123066,'reason':'Match\x20points:\x20'+_0x37d041+'\x20match\x20(Participant)','adminEmail':_0xb3425f(0x1a2),'timestamp':serverTimestamp()})]),console[_0xb3425f(0x1b6)]('Awarded\x20'+_0xc3eb39+_0xb3425f(0x1b3)+_0x37d041+'\x20match');}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x59e6c2){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x59e6c2);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x494c26){console['error']('Error\x20approving\x20report:',_0x494c26);throw _0x494c26;}}async function updatePlayerElo(_0x42e0b4,_0x1fb030,_0x4ea9b4){await setDoc(doc(db,'players',_0x42e0b4),{...playerData,'eloRating':_0x4ea9b4}),await checkAndRecordPromotion(_0x42e0b4,_0x4ea9b4,_0x1fb030);}async function updatePlayerStats(_0x2cb00e,_0x2bd53c,_0x132d9b){const _0x275f62=a28_0x3fc4,_0x115736=doc(db,_0x275f62(0x1a4),_0x2cb00e),_0x8009d2=await getDoc(_0x115736);let _0x3120fa=_0x8009d2['exists']()?_0x8009d2[_0x275f62(0x1a3)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x132d9b?(_0x3120fa['wins']++,_0x3120fa['totalKills']+=parseInt(_0x2bd53c['winnerScore']||0x0),_0x3120fa[_0x275f62(0x1ac)]+=parseInt(_0x2bd53c['loserScore']||0x0)):(_0x3120fa['losses']++,_0x3120fa['totalKills']+=parseInt(_0x2bd53c['loserScore']||0x0),_0x3120fa['totalDeaths']+=parseInt(_0x2bd53c[_0x275f62(0x1a8)]||0x0));const _0x381c92=_0x3120fa['wins']+_0x3120fa['losses'];_0x3120fa['winRate']=_0x381c92>0x0?(_0x3120fa[_0x275f62(0x1b0)]/_0x381c92*0x64)[_0x275f62(0x1ae)](0x1):0x0,_0x3120fa['lastUpdated']=new Date()[_0x275f62(0x19e)](),await setDoc(_0x115736,_0x3120fa,{'merge':!![]});}