const a28_0x40497c=(function(){let _0x4f2228=!![];return function(_0x59cd83,_0x555734){const _0x1f7bbb=_0x4f2228?function(){const _0x21ea74=a28_0x42b5;if(_0x555734){const _0x10c4c8=_0x555734[_0x21ea74(0x144)](_0x59cd83,arguments);return _0x555734=null,_0x10c4c8;}}:function(){};return _0x4f2228=![],_0x1f7bbb;};}()),a28_0x4a4721=a28_0x40497c(this,function(){const _0x5d5de7=a28_0x42b5,_0x439904=function(){const _0x13d135=a28_0x42b5;let _0x2f9022;try{_0x2f9022=Function('return\x20(function()\x20'+_0x13d135(0x14c)+');')();}catch(_0x5c0b3e){_0x2f9022=window;}return _0x2f9022;},_0x4b415d=_0x439904(),_0x90ff1d=_0x4b415d[_0x5d5de7(0x13e)]=_0x4b415d[_0x5d5de7(0x13e)]||{},_0x4d956b=['log','warn','info','error','exception',_0x5d5de7(0x14d),'trace'];for(let _0x4344ac=0x0;_0x4344ac<_0x4d956b[_0x5d5de7(0x14b)];_0x4344ac++){const _0x2a766f=a28_0x40497c['constructor']['prototype'][_0x5d5de7(0x136)](a28_0x40497c),_0xdd08a9=_0x4d956b[_0x4344ac],_0x150266=_0x90ff1d[_0xdd08a9]||_0x2a766f;_0x2a766f['__proto__']=a28_0x40497c[_0x5d5de7(0x136)](a28_0x40497c),_0x2a766f['toString']=_0x150266['toString'][_0x5d5de7(0x136)](_0x150266),_0x90ff1d[_0xdd08a9]=_0x2a766f;}});a28_0x4a4721();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a28_0x42b5(_0x1dd1a6,_0x27cbce){const _0x4a4721=a28_0x5dd8();return a28_0x42b5=function(_0x40497c,_0x3c32d5){_0x40497c=_0x40497c-0x135;let _0x5dd896=_0x4a4721[_0x40497c];return _0x5dd896;},a28_0x42b5(_0x1dd1a6,_0x27cbce);}import a28_0x7a1aea from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x17a2e9,_0x39641a,_0x3bf2c1=0x20){const _0x54f33d=0x1/(0x1+Math['pow'](0xa,(_0x39641a-_0x17a2e9)/0x190)),_0x26e456=0x1/(0x1+Math['pow'](0xa,(_0x17a2e9-_0x39641a)/0x190)),_0x1f2698=_0x17a2e9+_0x3bf2c1*(0x1-_0x54f33d),_0x341808=_0x39641a+_0x3bf2c1*(0x0-_0x26e456);return{'newWinnerRating':Math['round'](_0x1f2698),'newLoserRating':Math['round'](_0x341808)};}export async function updateEloRatingsD2(_0x4d721b,_0x472417,_0x1388e2){const _0x4e80df=a28_0x42b5;try{const _0x39e715=writeBatch(db),_0x377916=doc(db,'playersD2',_0x4d721b),_0x55f41f=doc(db,'playersD2',_0x472417),[_0x439399,_0x5bd652]=await Promise['all']([getDoc(_0x377916),getDoc(_0x55f41f)]);if(!_0x439399['exists']()||!_0x5bd652[_0x4e80df(0x13b)]())throw new Error(_0x4e80df(0x13f));const _0x2a6718=_0x439399[_0x4e80df(0x14a)](),_0x170372=_0x5bd652['data'](),_0x3bd927=_0x2a6718['position']||Number[_0x4e80df(0x139)],_0x167508=_0x170372[_0x4e80df(0x145)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x36631f,newLoserRating:_0x24c746}=calculateEloD2(_0x2a6718['eloRating']||0x4b0,_0x170372['eloRating']||0x4b0);let _0x35e011=_0x3bd927,_0x1fcb18=_0x167508;if(_0x3bd927>_0x167508){console['log'](_0x4e80df(0x14e)),_0x35e011=_0x167508,_0x1fcb18=_0x167508+0x1;const _0x427877=query(collection(db,'playersD2'),where(_0x4e80df(0x145),'>',_0x167508),where('position','<',_0x3bd927)),_0x493f9a=await getDocs(_0x427877);for(const _0x5187ef of _0x493f9a['docs']){_0x5187ef['id']!==_0x4d721b&&_0x5187ef['id']!==_0x472417&&_0x39e715['update'](doc(db,'playersD2',_0x5187ef['id']),{'position':_0x5187ef['data']()['position']+0x1});}}else console[_0x4e80df(0x13d)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x39e715[_0x4e80df(0x149)](_0x377916,{'eloRating':_0x36631f,'lastMatchDate':serverTimestamp(),'position':_0x35e011,'lastMatchId':_0x1388e2}),_0x39e715['update'](_0x55f41f,{'eloRating':_0x24c746,'lastMatchDate':serverTimestamp(),'position':_0x1fcb18,'lastMatchId':_0x1388e2}),await _0x39e715['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x4d721b,'previousElo':_0x2a6718['eloRating']||0x4b0,'newElo':_0x36631f,'opponentId':_0x472417,'matchResult':'win','previousPosition':_0x3bd927,'newPosition':_0x35e011,'isPromotion':_0x35e011<_0x3bd927,'matchId':_0x1388e2,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x472417,'previousElo':_0x170372['eloRating']||0x4b0,'newElo':_0x24c746,'opponentId':_0x4d721b,'matchResult':'loss','previousPosition':_0x167508,'newPosition':_0x1fcb18,'isDemotion':_0x1fcb18>_0x167508,'matchId':_0x1388e2,'timestamp':serverTimestamp()})]),await promotionManager[_0x4e80df(0x141)](_0x4d721b,_0x36631f,_0x2a6718['eloRating'],{'source':_0x4e80df(0x135),'matchId':_0x1388e2}),await promotionManager[_0x4e80df(0x141)](_0x472417,_0x24c746,_0x170372['eloRating'],{'source':_0x4e80df(0x135),'matchId':_0x1388e2}),!![];}catch(_0x415d37){console[_0x4e80df(0x138)](_0x4e80df(0x142),_0x415d37);throw _0x415d37;}}export async function approveReportD2(_0x3e4b8c,_0x3aa220,_0x50e785,_0x26c105){const _0x27130d=a28_0x42b5;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x3e4b8c,'winnerScore':_0x3aa220,'winnerSuicides':_0x50e785,'winnerComment':_0x26c105});const _0x361159=auth['currentUser'];if(!_0x361159){console['log']('No\x20user\x20logged\x20in');throw new Error(_0x27130d(0x137));}console['log']('Current\x20user:',_0x361159[_0x27130d(0x148)]);const _0x3e61fd=await getDoc(doc(db,'playersD2',_0x361159['uid'])),_0x54fb4e=_0x3e61fd['exists']()?_0x3e61fd['data']()['username']:null;console[_0x27130d(0x13d)]('Current\x20username:',_0x54fb4e);const _0x15e25d=doc(db,'pendingMatchesD2',_0x3e4b8c),_0x4a7aed=await getDoc(_0x15e25d);if(!_0x4a7aed['exists']()){console['log'](_0x27130d(0x146),_0x3e4b8c);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x16f7e0=_0x4a7aed['data']();console['log']('D2\x20Report\x20data:',_0x16f7e0);if(_0x54fb4e!==_0x16f7e0[_0x27130d(0x143)])throw new Error(_0x27130d(0x13a));const _0x3fa473={..._0x16f7e0,'winnerScore':_0x3aa220,'winnerSuicides':_0x50e785,'winnerComment':_0x26c105,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x54fb4e,'createdAt':_0x16f7e0['createdAt']||serverTimestamp(),'winnerUsername':_0x16f7e0[_0x27130d(0x143)],'loserUsername':_0x16f7e0['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x3e4b8c),_0x3fa473),await deleteDoc(_0x15e25d),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x46b3dc,_0x1216e2]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x16f7e0['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x16f7e0['loserUsername'])))]);if(_0x46b3dc['empty']||_0x1216e2[_0x27130d(0x13c)])throw new Error(_0x27130d(0x147));const _0x32b830=_0x46b3dc['docs'][0x0]['id'],_0x3eac0f=_0x1216e2['docs'][0x0]['id'];return await updateEloRatingsD2(_0x32b830,_0x3eac0f,_0x3e4b8c),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x2603e0){console[_0x27130d(0x138)](_0x27130d(0x140),_0x2603e0);throw _0x2603e0;}}function a28_0x5dd8(){const _0x2eab62=['match-d2','bind','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','error','MAX_SAFE_INTEGER','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','exists','empty','log','console','One\x20or\x20both\x20D2\x20players\x20not\x20found','Error\x20in\x20approveReportD2:','checkAndRecordPromotion','Error\x20in\x20updateEloRatingsD2:','winnerUsername','apply','position','D2\x20Report\x20not\x20found\x20with\x20ID:','Could\x20not\x20find\x20D2\x20player\x20documents','email','update','data','length','{}.constructor(\x22return\x20this\x22)(\x20)','table','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'];a28_0x5dd8=function(){return _0x2eab62;};return a28_0x5dd8();}