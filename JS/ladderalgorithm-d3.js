const a27_0x3a682a=(function(){let _0x516010=!![];return function(_0x58d869,_0x6e259a){const _0x35822d=_0x516010?function(){const _0x29a1d2=a27_0x40f2;if(_0x6e259a){const _0x298003=_0x6e259a[_0x29a1d2(0x131)](_0x58d869,arguments);return _0x6e259a=null,_0x298003;}}:function(){};return _0x516010=![],_0x35822d;};}()),a27_0x20e630=a27_0x3a682a(this,function(){const _0x3cc356=a27_0x40f2,_0xb971c9=function(){let _0xa79afd;try{_0xa79afd=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x21fe94){_0xa79afd=window;}return _0xa79afd;},_0x273dbf=_0xb971c9(),_0x41f93a=_0x273dbf[_0x3cc356(0x12d)]=_0x273dbf['console']||{},_0x386810=[_0x3cc356(0x127),'warn','info','error','exception','table','trace'];for(let _0xf8783d=0x0;_0xf8783d<_0x386810['length'];_0xf8783d++){const _0x308341=a27_0x3a682a['constructor']['prototype']['bind'](a27_0x3a682a),_0x14e0e4=_0x386810[_0xf8783d],_0x338a87=_0x41f93a[_0x14e0e4]||_0x308341;_0x308341[_0x3cc356(0x128)]=a27_0x3a682a[_0x3cc356(0x11e)](a27_0x3a682a),_0x308341['toString']=_0x338a87['toString']['bind'](_0x338a87),_0x41f93a[_0x14e0e4]=_0x308341;}});a27_0x20e630();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a27_0x5c56(){const _0xa6dd1b=['bind','No\x20user\x20logged\x20in','createdAt','MAX_SAFE_INTEGER','pow','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches','position','data','exists','log','__proto__','uid','D3\x20match\x20report\x20not\x20found','all','loserUsername','console','email','update','commit','apply','loss','Current\x20username:','error','playersD3'];a27_0x5c56=function(){return _0xa6dd1b;};return a27_0x5c56();}import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x2a5f7d,_0x29d440,_0x1d66c2=0x20){const _0x5af667=a27_0x40f2,_0x4abc6f=0x1/(0x1+Math[_0x5af667(0x122)](0xa,(_0x29d440-_0x2a5f7d)/0x190)),_0x1643c5=0x1/(0x1+Math[_0x5af667(0x122)](0xa,(_0x2a5f7d-_0x29d440)/0x190)),_0x3a9989=_0x2a5f7d+_0x1d66c2*(0x1-_0x4abc6f),_0x32a301=_0x29d440+_0x1d66c2*(0x0-_0x1643c5);return{'newWinnerRating':Math['round'](_0x3a9989),'newLoserRating':Math['round'](_0x32a301)};}export async function updateEloRatingsD3(_0x26904e,_0x5ab6ac,_0x1eaf76){const _0x4b73d2=a27_0x40f2;try{const _0x3bad5a=writeBatch(db),_0x65c62a=doc(db,'playersD3',_0x26904e),_0x5ae96b=doc(db,_0x4b73d2(0x135),_0x5ab6ac),[_0x3414d3,_0x448648]=await Promise[_0x4b73d2(0x12b)]([getDoc(_0x65c62a),getDoc(_0x5ae96b)]);if(!_0x3414d3[_0x4b73d2(0x126)]()||!_0x448648['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x15fc17=_0x3414d3[_0x4b73d2(0x125)](),_0xe32e7e=_0x448648['data'](),_0x5113a3=_0x15fc17['position']||Number['MAX_SAFE_INTEGER'],_0x914409=_0xe32e7e[_0x4b73d2(0x124)]||Number[_0x4b73d2(0x121)],{newWinnerRating:_0x1f771d,newLoserRating:_0x449123}=calculateEloD3(_0x15fc17['eloRating']||0x4b0,_0xe32e7e['eloRating']||0x4b0);let _0x3fb2fe=_0x5113a3,_0x3ac56b=_0x914409;if(_0x5113a3>_0x914409){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x3fb2fe=_0x914409,_0x3ac56b=_0x914409+0x1;const _0x9f675f=query(collection(db,'playersD3'),where('position','>',_0x914409),where('position','<',_0x5113a3)),_0x328546=await getDocs(_0x9f675f);for(const _0x2cdfab of _0x328546['docs']){_0x2cdfab['id']!==_0x26904e&&_0x2cdfab['id']!==_0x5ab6ac&&_0x3bad5a['update'](doc(db,'playersD3',_0x2cdfab['id']),{'position':_0x2cdfab[_0x4b73d2(0x125)]()['position']+0x1});}}else console[_0x4b73d2(0x127)]('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x3bad5a[_0x4b73d2(0x12f)](_0x65c62a,{'eloRating':_0x1f771d,'lastMatchDate':serverTimestamp(),'position':_0x3fb2fe,'lastMatchId':_0x1eaf76}),_0x3bad5a['update'](_0x5ae96b,{'eloRating':_0x449123,'lastMatchDate':serverTimestamp(),'position':_0x3ac56b,'lastMatchId':_0x1eaf76}),await _0x3bad5a[_0x4b73d2(0x130)](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD3({'playerId':_0x26904e,'previousElo':_0x15fc17['eloRating']||0x4b0,'newElo':_0x1f771d,'opponentId':_0x5ab6ac,'matchResult':'win','previousPosition':_0x5113a3,'newPosition':_0x3fb2fe,'isPromotion':_0x3fb2fe<_0x5113a3,'matchId':_0x1eaf76,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x5ab6ac,'previousElo':_0xe32e7e['eloRating']||0x4b0,'newElo':_0x449123,'opponentId':_0x26904e,'matchResult':_0x4b73d2(0x132),'previousPosition':_0x914409,'newPosition':_0x3ac56b,'isDemotion':_0x3ac56b>_0x914409,'matchId':_0x1eaf76,'timestamp':serverTimestamp()})]),!![];}catch(_0x265013){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x265013);throw _0x265013;}}function a27_0x40f2(_0x243060,_0x16d493){const _0x20e630=a27_0x5c56();return a27_0x40f2=function(_0x3a682a,_0x4f4c99){_0x3a682a=_0x3a682a-0x11e;let _0x5c56b3=_0x20e630[_0x3a682a];return _0x5c56b3;},a27_0x40f2(_0x243060,_0x16d493);}export async function approveReportD3(_0x5f19fe,_0x42eea9,_0x2db6d6,_0x9b9dc7){const _0x28fff5=a27_0x40f2;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x5f19fe,'winnerScore':_0x42eea9,'winnerSuicides':_0x2db6d6,'winnerComment':_0x9b9dc7});const _0x5c58cf=auth['currentUser'];if(!_0x5c58cf){console[_0x28fff5(0x127)](_0x28fff5(0x11f));throw new Error(_0x28fff5(0x123));}console['log']('Current\x20user:',_0x5c58cf[_0x28fff5(0x12e)]);const _0x2b3adb=await getDoc(doc(db,'playersD3',_0x5c58cf[_0x28fff5(0x129)])),_0x350815=_0x2b3adb['exists']()?_0x2b3adb['data']()['username']:null;console['log'](_0x28fff5(0x133),_0x350815);const _0x3c7beb=doc(db,'pendingMatchesD3',_0x5f19fe),_0x498d3f=await getDoc(_0x3c7beb);if(!_0x498d3f['exists']()){console[_0x28fff5(0x127)]('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x5f19fe);throw new Error(_0x28fff5(0x12a));}const _0x58c5ab=_0x498d3f['data']();console[_0x28fff5(0x127)]('D3\x20Report\x20data:',_0x58c5ab);if(_0x350815!==_0x58c5ab['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x4687a3={..._0x58c5ab,'winnerScore':_0x42eea9,'winnerSuicides':_0x2db6d6,'winnerComment':_0x9b9dc7,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x350815,'createdAt':_0x58c5ab[_0x28fff5(0x120)]||serverTimestamp(),'winnerUsername':_0x58c5ab['winnerUsername'],'loserUsername':_0x58c5ab[_0x28fff5(0x12c)]};await setDoc(doc(db,'approvedMatchesD3',_0x5f19fe),_0x4687a3),await deleteDoc(_0x3c7beb),console[_0x28fff5(0x127)]('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x20cd94,_0x2faa92]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x58c5ab['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x58c5ab[_0x28fff5(0x12c)])))]);if(_0x20cd94['empty']||_0x2faa92['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x4e9553=_0x20cd94['docs'][0x0]['id'],_0x286f68=_0x2faa92['docs'][0x0]['id'];return await updateEloRatingsD3(_0x4e9553,_0x286f68,_0x5f19fe),console[_0x28fff5(0x127)]('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x486f96){console[_0x28fff5(0x134)]('Error\x20in\x20approveReportD3:',_0x486f96);throw _0x486f96;}}