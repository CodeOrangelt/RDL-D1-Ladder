const a30_0x4bc492=(function(){let _0x42d000=!![];return function(_0x5d8f31,_0x42c6a6){const _0x361359=_0x42d000?function(){if(_0x42c6a6){const _0xd12d04=_0x42c6a6['apply'](_0x5d8f31,arguments);return _0x42c6a6=null,_0xd12d04;}}:function(){};return _0x42d000=![],_0x361359;};}()),a30_0x18167a=a30_0x4bc492(this,function(){const _0x186ba4=a30_0x3a93,_0x557eb1=function(){let _0x59987d;try{_0x59987d=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x208180){_0x59987d=window;}return _0x59987d;},_0xd5ef2f=_0x557eb1(),_0x1490aa=_0xd5ef2f['console']=_0xd5ef2f['console']||{},_0x17a998=[_0x186ba4(0x1a3),_0x186ba4(0x19c),_0x186ba4(0x1aa),_0x186ba4(0x1a5),_0x186ba4(0x1a6),_0x186ba4(0x195),'trace'];for(let _0x2b3bbe=0x0;_0x2b3bbe<_0x17a998['length'];_0x2b3bbe++){const _0x5e51ef=a30_0x4bc492[_0x186ba4(0x199)]['prototype']['bind'](a30_0x4bc492),_0x4f03f3=_0x17a998[_0x2b3bbe],_0x4cd0c5=_0x1490aa[_0x4f03f3]||_0x5e51ef;_0x5e51ef[_0x186ba4(0x1b3)]=a30_0x4bc492[_0x186ba4(0x19b)](a30_0x4bc492),_0x5e51ef['toString']=_0x4cd0c5[_0x186ba4(0x194)][_0x186ba4(0x19b)](_0x4cd0c5),_0x1490aa[_0x4f03f3]=_0x5e51ef;}});a30_0x18167a();function a30_0x205b(){const _0x1d4585=['commit','Awarded\x20','uid','toFixed','toString','table','Match\x20points:\x20','empty','position','constructor','pow','bind','warn','players','One\x20or\x20both\x20players\x20not\x20found','losses','toISOString','loss','collection','log','loserUsername','error','exception','Error\x20in\x20updateEloRatings:','wins','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','info','eloRating','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','username','match','add','docs','playerStats','data','__proto__'];a30_0x205b=function(){return _0x1d4585;};return a30_0x205b();}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';function a30_0x3a93(_0x132870,_0x147a0e){const _0x18167a=a30_0x205b();return a30_0x3a93=function(_0x4bc492,_0x42dec4){_0x4bc492=_0x4bc492-0x190;let _0x205b4c=_0x18167a[_0x4bc492];return _0x205b4c;},a30_0x3a93(_0x132870,_0x147a0e);}import{isAdmin}from'./admin-check.js';import{modifyUserPoints}from'./adminbackend.js';export function calculateElo(_0x5e24ae,_0x16996b,_0x16065f=0x20){const _0x29938e=a30_0x3a93,_0x23e2db=0x1/(0x1+Math[_0x29938e(0x19a)](0xa,(_0x16996b-_0x5e24ae)/0x190)),_0x28c6c3=0x1/(0x1+Math[_0x29938e(0x19a)](0xa,(_0x5e24ae-_0x16996b)/0x190)),_0x27fb7c=_0x5e24ae+_0x16065f*(0x1-_0x23e2db),_0x468dcb=_0x16996b+_0x16065f*(0x0-_0x28c6c3);return{'newWinnerRating':Math['round'](_0x27fb7c),'newLoserRating':Math['round'](_0x468dcb)};}export function assignDefaultEloRating(_0x57e5cd,_0xc292c8){const _0x21ab02=a30_0x3a93,_0x487e28=0x4b0;!_0xc292c8['eloRating']&&db[_0x21ab02(0x1a2)](_0x21ab02(0x19d))['doc'](_0x57e5cd)['update']({'eloRating':_0x487e28})['then'](()=>{const _0xdd8f46=_0x21ab02;console['log'](_0xdd8f46(0x1ac)+_0xc292c8['username']);})['catch'](_0x2b3638=>{const _0x4da793=_0x21ab02;console[_0x4da793(0x1a5)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x2b3638);});}export async function updateEloRatings(_0x326e41,_0x492229,_0x2e7223){const _0x5c7e42=a30_0x3a93;try{const _0x5887e=writeBatch(db),_0x2d22f4=doc(db,_0x5c7e42(0x19d),_0x326e41),_0x23a303=doc(db,'players',_0x492229),[_0x5658ea,_0x2627bb]=await Promise['all']([getDoc(_0x2d22f4),getDoc(_0x23a303)]);if(!_0x5658ea['exists']()||!_0x2627bb['exists']())throw new Error(_0x5c7e42(0x19e));const _0x4469be=_0x5658ea['data'](),_0x279495=_0x2627bb['data'](),_0x2f602e=_0x4469be[_0x5c7e42(0x198)]||Number['MAX_SAFE_INTEGER'],_0x4d45cf=_0x279495[_0x5c7e42(0x198)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x2be295,newLoserRating:_0x1ad5ec}=calculateElo(_0x4469be[_0x5c7e42(0x1ab)]||0x4b0,_0x279495['eloRating']||0x4b0);let _0xe18c44=_0x2f602e,_0x4d332b=_0x4d45cf;if(_0x2f602e>_0x4d45cf){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0xe18c44=_0x4d45cf,_0x4d332b=_0x4d45cf+0x1;const _0x50c19a=query(collection(db,'players'),where('position','>',_0x4d45cf),where(_0x5c7e42(0x198),'<',_0x2f602e)),_0x42027a=await getDocs(_0x50c19a);for(const _0x3a37c2 of _0x42027a['docs']){_0x3a37c2['id']!==_0x326e41&&_0x3a37c2['id']!==_0x492229&&_0x5887e['update'](doc(db,'players',_0x3a37c2['id']),{'position':_0x3a37c2[_0x5c7e42(0x1b2)]()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x2ca2a4={'eloRating':_0x2be295,'lastMatchDate':serverTimestamp(),'position':_0xe18c44,'lastMatchId':_0x2e7223},_0xf245f6={'eloRating':_0x1ad5ec,'lastMatchDate':serverTimestamp(),'position':_0x4d332b,'lastMatchId':_0x2e7223};return _0x5887e['update'](_0x2d22f4,_0x2ca2a4),_0x5887e['update'](_0x23a303,_0xf245f6),await _0x5887e[_0x5c7e42(0x190)](),console[_0x5c7e42(0x1a3)]('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x326e41,'previousElo':_0x4469be['eloRating']||0x4b0,'newElo':_0x2be295,'opponentId':_0x492229,'matchResult':'win','previousPosition':_0x2f602e,'newPosition':_0xe18c44,'isPromotion':_0xe18c44<_0x2f602e,'matchId':_0x2e7223,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x492229,'previousElo':_0x279495['eloRating']||0x4b0,'newElo':_0x1ad5ec,'opponentId':_0x326e41,'matchResult':_0x5c7e42(0x1a1),'previousPosition':_0x4d45cf,'newPosition':_0x4d332b,'isDemotion':_0x4d332b>_0x4d45cf,'matchId':_0x2e7223,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x326e41,_0x2be295,_0x4469be['eloRating'],{'source':_0x5c7e42(0x1ae),'matchId':_0x2e7223}),await promotionManager['checkAndRecordPromotion'](_0x492229,_0x1ad5ec,_0x279495[_0x5c7e42(0x1ab)],{'source':_0x5c7e42(0x1ae),'matchId':_0x2e7223}),console['log'](_0x5c7e42(0x1a9)),!![];}catch(_0x7551){console[_0x5c7e42(0x1a5)](_0x5c7e42(0x1a7),_0x7551);throw _0x7551;}}async function awardMatchPoints(_0x186f79,_0x5234ec,_0x5b2e56){const _0x39a9cb=a30_0x3a93,_0x526a6f={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e},_0xd9c92=_0x526a6f[_0x5b2e56]||0xa;try{return await modifyUserPoints(_0x186f79,_0x39a9cb(0x1af),_0xd9c92,'Match\x20points:\x20'+(_0x5b2e56||'Standard')+'\x20match'),await modifyUserPoints(_0x5234ec,'add',_0xd9c92,_0x39a9cb(0x196)+(_0x5b2e56||'Standard')+'\x20match'),console[_0x39a9cb(0x1a3)](_0x39a9cb(0x191)+_0xd9c92+'\x20points\x20to\x20both\x20players\x20for\x20'+(_0x5b2e56||'Standard')+'\x20match'),!![];}catch(_0x5ec33c){return console[_0x39a9cb(0x1a5)]('Error\x20awarding\x20match\x20points:',_0x5ec33c),![];}}export async function approveReport(_0x583a36,_0x2d8aee,_0x3b419d,_0x4e77f6,_0x12e070){const _0x514ca3=a30_0x3a93;try{const _0x57106e=doc(db,'pendingMatches',_0x583a36),_0x24c43f=await getDoc(_0x57106e);if(!_0x24c43f['exists']())throw new Error('Report\x20not\x20found');const _0x33b677=_0x24c43f['data'](),_0x18034e={..._0x33b677,'winnerScore':_0x2d8aee,'winnerSuicides':_0x3b419d,'winnerComment':_0x4e77f6,'winnerDemoLink':_0x12e070,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x514ca3(0x192)]};await setDoc(doc(db,'approvedMatches',_0x583a36),_0x18034e),await deleteDoc(_0x57106e),console[_0x514ca3(0x1a3)]('Match\x20moved\x20to\x20approved\x20collection');const [_0x56df69,_0x26f238]=await Promise['all']([getDocs(query(collection(db,'players'),where(_0x514ca3(0x1ad),'==',_0x33b677['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x33b677[_0x514ca3(0x1a4)])))]);if(_0x56df69[_0x514ca3(0x197)]||_0x26f238['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x23c7b5=_0x56df69['docs'][0x0]['id'],_0x5a8666=_0x26f238[_0x514ca3(0x1b0)][0x0]['id'];return await updateEloRatings(_0x23c7b5,_0x5a8666,_0x583a36),await awardMatchPoints(_0x23c7b5,_0x5a8666,_0x33b677['subgameType']),console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0xf0444){console[_0x514ca3(0x1a5)]('Error\x20approving\x20report:',_0xf0444);throw _0xf0444;}}async function updatePlayerElo(_0x2451bf,_0x22a351,_0x3a972d){await setDoc(doc(db,'players',_0x2451bf),{...playerData,'eloRating':_0x3a972d}),await checkAndRecordPromotion(_0x2451bf,_0x3a972d,_0x22a351);}async function updatePlayerStats(_0x1494db,_0x4f05c4,_0x10a8bf){const _0x1cbb41=a30_0x3a93,_0x367998=doc(db,_0x1cbb41(0x1b1),_0x1494db),_0x29411d=await getDoc(_0x367998);let _0x161c91=_0x29411d['exists']()?_0x29411d[_0x1cbb41(0x1b2)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x10a8bf?(_0x161c91[_0x1cbb41(0x1a8)]++,_0x161c91['totalKills']+=parseInt(_0x4f05c4['winnerScore']||0x0),_0x161c91['totalDeaths']+=parseInt(_0x4f05c4['loserScore']||0x0)):(_0x161c91[_0x1cbb41(0x19f)]++,_0x161c91['totalKills']+=parseInt(_0x4f05c4['loserScore']||0x0),_0x161c91['totalDeaths']+=parseInt(_0x4f05c4['winnerScore']||0x0));const _0x2cde6a=_0x161c91['wins']+_0x161c91['losses'];_0x161c91['winRate']=_0x2cde6a>0x0?(_0x161c91['wins']/_0x2cde6a*0x64)[_0x1cbb41(0x193)](0x1):0x0,_0x161c91['lastUpdated']=new Date()[_0x1cbb41(0x1a0)](),await setDoc(_0x367998,_0x161c91,{'merge':!![]});}