const a26_0x24f546=(function(){let _0x408ce9=!![];return function(_0x59853d,_0x48355c){const _0x3d0fd5=_0x408ce9?function(){if(_0x48355c){const _0x110df6=_0x48355c['apply'](_0x59853d,arguments);return _0x48355c=null,_0x110df6;}}:function(){};return _0x408ce9=![],_0x3d0fd5;};}()),a26_0x139055=a26_0x24f546(this,function(){const _0x34bd94=a26_0x2ac7;let _0x15f0b6;try{const _0x2ff77c=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x15f0b6=_0x2ff77c();}catch(_0x5edbac){_0x15f0b6=window;}const _0x1cae0f=_0x15f0b6['console']=_0x15f0b6[_0x34bd94(0xcd)]||{},_0x135b2d=['log',_0x34bd94(0xdc),_0x34bd94(0xe5),_0x34bd94(0xd7),_0x34bd94(0xcf),_0x34bd94(0xd5),'trace'];for(let _0x34bb55=0x0;_0x34bb55<_0x135b2d[_0x34bd94(0xe2)];_0x34bb55++){const _0x561725=a26_0x24f546[_0x34bd94(0xe1)]['prototype']['bind'](a26_0x24f546),_0x34ad65=_0x135b2d[_0x34bb55],_0x2e1564=_0x1cae0f[_0x34ad65]||_0x561725;_0x561725['__proto__']=a26_0x24f546['bind'](a26_0x24f546),_0x561725['toString']=_0x2e1564['toString']['bind'](_0x2e1564),_0x1cae0f[_0x34ad65]=_0x561725;}});a26_0x139055();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x11578e from'./firebase-idle-wrapper.js';function a26_0x2ac7(_0x3f962a,_0x552b3b){const _0x139055=a26_0x351d();return a26_0x2ac7=function(_0x24f546,_0x1f5074){_0x24f546=_0x24f546-0xcc;let _0x351d75=_0x139055[_0x24f546];return _0x351d75;},a26_0x2ac7(_0x3f962a,_0x552b3b);}export function calculateEloD2(_0x5b967d,_0x6c8771,_0x4dd182=0x20){const _0x4e2e8f=a26_0x2ac7,_0x195bbc=0x1/(0x1+Math[_0x4e2e8f(0xea)](0xa,(_0x6c8771-_0x5b967d)/0x190)),_0x181412=0x1/(0x1+Math[_0x4e2e8f(0xea)](0xa,(_0x5b967d-_0x6c8771)/0x190)),_0x3ee89b=_0x5b967d+_0x4dd182*(0x1-_0x195bbc),_0x47f3ad=_0x6c8771+_0x4dd182*(0x0-_0x181412);return{'newWinnerRating':Math['round'](_0x3ee89b),'newLoserRating':Math[_0x4e2e8f(0xd6)](_0x47f3ad)};}function a26_0x351d(){const _0x1dddcb=['log','console','update','exception','Current\x20user:','playersD2','D2\x20Report\x20data:','Starting\x20approveReportD2\x20function\x20with:','checkAndRecordPromotion','table','round','error','winnerUsername','Error\x20in\x20approveReportD2:','match-d2','loserUsername','warn','username','loss','eloRating','D2\x20Report\x20not\x20found\x20with\x20ID:','constructor','length','email','exists','info','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','D2\x20Match\x20moved\x20to\x20approved\x20collection','position','D2\x20match\x20report\x20not\x20found','pow','docs','One\x20or\x20both\x20D2\x20players\x20not\x20found','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','data','all','MAX_SAFE_INTEGER'];a26_0x351d=function(){return _0x1dddcb;};return a26_0x351d();}export async function updateEloRatingsD2(_0x6df51d,_0x294f71,_0x4ea9c9){const _0x398e04=a26_0x2ac7;try{const _0x1c1ad9=writeBatch(db),_0x1c1870=doc(db,'playersD2',_0x6df51d),_0x24bb52=doc(db,_0x398e04(0xd1),_0x294f71),[_0xf9e694,_0x5d5290]=await Promise['all']([getDoc(_0x1c1870),getDoc(_0x24bb52)]);if(!_0xf9e694[_0x398e04(0xe4)]()||!_0x5d5290['exists']())throw new Error(_0x398e04(0xec));const _0x47f38d=_0xf9e694['data'](),_0x23307b=_0x5d5290['data'](),_0x227183=_0x47f38d['position']||Number[_0x398e04(0xf0)],_0x2085ad=_0x23307b['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x34f31d,newLoserRating:_0x3e2f62}=calculateEloD2(_0x47f38d[_0x398e04(0xdf)]||0x4b0,_0x23307b['eloRating']||0x4b0);let _0x2c682e=_0x227183,_0x43d843=_0x2085ad;if(_0x227183>_0x2085ad){console['log'](_0x398e04(0xed)),_0x2c682e=_0x2085ad,_0x43d843=_0x2085ad+0x1;const _0x28bde7=query(collection(db,_0x398e04(0xd1)),where('position','>',_0x2085ad),where('position','<',_0x227183)),_0x1e1b1f=await getDocs(_0x28bde7);for(const _0x37174b of _0x1e1b1f['docs']){_0x37174b['id']!==_0x6df51d&&_0x37174b['id']!==_0x294f71&&_0x1c1ad9['update'](doc(db,'playersD2',_0x37174b['id']),{'position':_0x37174b[_0x398e04(0xee)]()[_0x398e04(0xe8)]+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x1c1ad9[_0x398e04(0xce)](_0x1c1870,{'eloRating':_0x34f31d,'lastMatchDate':serverTimestamp(),'position':_0x2c682e,'lastMatchId':_0x4ea9c9}),_0x1c1ad9[_0x398e04(0xce)](_0x24bb52,{'eloRating':_0x3e2f62,'lastMatchDate':serverTimestamp(),'position':_0x43d843,'lastMatchId':_0x4ea9c9}),await _0x1c1ad9['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x6df51d,'previousElo':_0x47f38d[_0x398e04(0xdf)]||0x4b0,'newElo':_0x34f31d,'opponentId':_0x294f71,'matchResult':'win','previousPosition':_0x227183,'newPosition':_0x2c682e,'isPromotion':_0x2c682e<_0x227183,'matchId':_0x4ea9c9,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x294f71,'previousElo':_0x23307b[_0x398e04(0xdf)]||0x4b0,'newElo':_0x3e2f62,'opponentId':_0x6df51d,'matchResult':_0x398e04(0xde),'previousPosition':_0x2085ad,'newPosition':_0x43d843,'isDemotion':_0x43d843>_0x2085ad,'matchId':_0x4ea9c9,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x6df51d,_0x34f31d,_0x47f38d[_0x398e04(0xdf)],{'source':'match-d2','matchId':_0x4ea9c9}),await promotionManager[_0x398e04(0xd4)](_0x294f71,_0x3e2f62,_0x23307b['eloRating'],{'source':_0x398e04(0xda),'matchId':_0x4ea9c9}),!![];}catch(_0x45b26d){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x45b26d);throw _0x45b26d;}}export async function approveReportD2(_0xafd85b,_0x5d9455,_0x3cdc42,_0x2ba16a){const _0x47666d=a26_0x2ac7;try{console['log'](_0x47666d(0xd3),{'reportId':_0xafd85b,'winnerScore':_0x5d9455,'winnerSuicides':_0x3cdc42,'winnerComment':_0x2ba16a});const _0x31fd1d=auth['currentUser'];if(!_0x31fd1d){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log'](_0x47666d(0xd0),_0x31fd1d[_0x47666d(0xe3)]);const _0x1a8b2a=await getDoc(doc(db,'playersD2',_0x31fd1d['uid'])),_0x27617a=_0x1a8b2a['exists']()?_0x1a8b2a['data']()['username']:null;console[_0x47666d(0xcc)]('Current\x20username:',_0x27617a);const _0x552850=doc(db,'pendingMatchesD2',_0xafd85b),_0x1960dd=await getDoc(_0x552850);if(!_0x1960dd['exists']()){console['log'](_0x47666d(0xe0),_0xafd85b);throw new Error(_0x47666d(0xe9));}const _0x2ae55b=_0x1960dd['data']();console['log'](_0x47666d(0xd2),_0x2ae55b);if(_0x27617a!==_0x2ae55b['winnerUsername'])throw new Error(_0x47666d(0xe6));const _0x566099={..._0x2ae55b,'winnerScore':_0x5d9455,'winnerSuicides':_0x3cdc42,'winnerComment':_0x2ba16a,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x27617a,'createdAt':_0x2ae55b['createdAt']||serverTimestamp(),'winnerUsername':_0x2ae55b[_0x47666d(0xd8)],'loserUsername':_0x2ae55b[_0x47666d(0xdb)]};await setDoc(doc(db,'approvedMatchesD2',_0xafd85b),_0x566099),await deleteDoc(_0x552850),console[_0x47666d(0xcc)](_0x47666d(0xe7));const [_0x268f97,_0x207fd0]=await Promise[_0x47666d(0xef)]([getDocs(query(collection(db,_0x47666d(0xd1)),where(_0x47666d(0xdd),'==',_0x2ae55b['winnerUsername']))),getDocs(query(collection(db,_0x47666d(0xd1)),where(_0x47666d(0xdd),'==',_0x2ae55b['loserUsername'])))]);if(_0x268f97['empty']||_0x207fd0['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x5777ae=_0x268f97[_0x47666d(0xeb)][0x0]['id'],_0x4f0256=_0x207fd0['docs'][0x0]['id'];return await updateEloRatingsD2(_0x5777ae,_0x4f0256,_0xafd85b),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x2d9a29){console['error'](_0x47666d(0xd9),_0x2d9a29);throw _0x2d9a29;}}