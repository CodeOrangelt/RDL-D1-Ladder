const a27_0x569c82=(function(){let _0x4a7b1f=!![];return function(_0x5303bd,_0x5c1b6a){const _0x226124=_0x4a7b1f?function(){if(_0x5c1b6a){const _0x384a86=_0x5c1b6a['apply'](_0x5303bd,arguments);return _0x5c1b6a=null,_0x384a86;}}:function(){};return _0x4a7b1f=![],_0x226124;};}()),a27_0x3b97a1=a27_0x569c82(this,function(){const _0x7b9903=a27_0x88eb;let _0x5bf907;try{const _0x4673f4=Function(_0x7b9903(0xf7)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x5bf907=_0x4673f4();}catch(_0x5c454e){_0x5bf907=window;}const _0x50a42f=_0x5bf907['console']=_0x5bf907[_0x7b9903(0xfb)]||{},_0x5bf8cb=['log','warn','info','error','exception',_0x7b9903(0xec),_0x7b9903(0xf3)];for(let _0x46c9cd=0x0;_0x46c9cd<_0x5bf8cb[_0x7b9903(0x101)];_0x46c9cd++){const _0x468ee2=a27_0x569c82[_0x7b9903(0x102)]['prototype'][_0x7b9903(0xe9)](a27_0x569c82),_0x4b78f3=_0x5bf8cb[_0x46c9cd],_0x11624e=_0x50a42f[_0x4b78f3]||_0x468ee2;_0x468ee2['__proto__']=a27_0x569c82['bind'](a27_0x569c82),_0x468ee2['toString']=_0x11624e['toString']['bind'](_0x11624e),_0x50a42f[_0x4b78f3]=_0x468ee2;}});function a27_0x1d93(){const _0x1c17c8=['playersD3','bind','data','username','table','eloRating','D3\x20match\x20report\x20not\x20found','D3\x20Match\x20moved\x20to\x20approved\x20collection','winnerUsername','D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','Error\x20in\x20approveReportD3:','trace','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','email','No\x20user\x20logged\x20in','return\x20(function()\x20','log','docs','all','console','Error\x20in\x20updateEloRatingsD3:','uid','exists','round','position','length','constructor','loserUsername','MAX_SAFE_INTEGER','error','D3\x20ELO\x20ratings\x20updated\x20successfully'];a27_0x1d93=function(){return _0x1c17c8;};return a27_0x1d93();}a27_0x3b97a1();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';function a27_0x88eb(_0x3d5cfa,_0x12158d){const _0x3b97a1=a27_0x1d93();return a27_0x88eb=function(_0x569c82,_0x1578c8){_0x569c82=_0x569c82-0xe8;let _0x1d93cf=_0x3b97a1[_0x569c82];return _0x1d93cf;},a27_0x88eb(_0x3d5cfa,_0x12158d);}export function calculateEloD3(_0x16cfee,_0x637eae,_0x3b1f23=0x20){const _0x2252f2=a27_0x88eb,_0x3a6b7c=0x1/(0x1+Math['pow'](0xa,(_0x637eae-_0x16cfee)/0x190)),_0x42f099=0x1/(0x1+Math['pow'](0xa,(_0x16cfee-_0x637eae)/0x190)),_0x5daf4c=_0x16cfee+_0x3b1f23*(0x1-_0x3a6b7c),_0xfe0215=_0x637eae+_0x3b1f23*(0x0-_0x42f099);return{'newWinnerRating':Math[_0x2252f2(0xff)](_0x5daf4c),'newLoserRating':Math['round'](_0xfe0215)};}export async function updateEloRatingsD3(_0x41aaab,_0x5c3b09,_0x48a574){const _0x45f95b=a27_0x88eb;try{const _0x47fa3d=writeBatch(db),_0x59b4df=doc(db,_0x45f95b(0xe8),_0x41aaab),_0x32c25e=doc(db,'playersD3',_0x5c3b09),[_0x51e2ad,_0x158a53]=await Promise[_0x45f95b(0xfa)]([getDoc(_0x59b4df),getDoc(_0x32c25e)]);if(!_0x51e2ad[_0x45f95b(0xfe)]()||!_0x158a53['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x5e3981=_0x51e2ad['data'](),_0x547928=_0x158a53[_0x45f95b(0xea)](),_0x4a1bd6=_0x5e3981['position']||Number[_0x45f95b(0x104)],_0x496a52=_0x547928['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x10b878,newLoserRating:_0x9b3ea2}=calculateEloD3(_0x5e3981[_0x45f95b(0xed)]||0x4b0,_0x547928[_0x45f95b(0xed)]||0x4b0);let _0x2d7ebf=_0x4a1bd6,_0x39a3c9=_0x496a52;if(_0x4a1bd6>_0x496a52){console['log'](_0x45f95b(0xf4)),_0x2d7ebf=_0x496a52,_0x39a3c9=_0x496a52+0x1;const _0x38c8cd=query(collection(db,'playersD3'),where(_0x45f95b(0x100),'>',_0x496a52),where('position','<',_0x4a1bd6)),_0xa48af3=await getDocs(_0x38c8cd);for(const _0x15903d of _0xa48af3[_0x45f95b(0xf9)]){_0x15903d['id']!==_0x41aaab&&_0x15903d['id']!==_0x5c3b09&&_0x47fa3d['update'](doc(db,_0x45f95b(0xe8),_0x15903d['id']),{'position':_0x15903d['data']()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x47fa3d['update'](_0x59b4df,{'eloRating':_0x10b878,'lastMatchDate':serverTimestamp(),'position':_0x2d7ebf,'lastMatchId':_0x48a574}),_0x47fa3d['update'](_0x32c25e,{'eloRating':_0x9b3ea2,'lastMatchDate':serverTimestamp(),'position':_0x39a3c9,'lastMatchId':_0x48a574}),await _0x47fa3d['commit'](),console['log'](_0x45f95b(0x106)),await Promise['all']([recordEloChangeD3({'playerId':_0x41aaab,'previousElo':_0x5e3981['eloRating']||0x4b0,'newElo':_0x10b878,'opponentId':_0x5c3b09,'matchResult':'win','previousPosition':_0x4a1bd6,'newPosition':_0x2d7ebf,'isPromotion':_0x2d7ebf<_0x4a1bd6,'matchId':_0x48a574,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x5c3b09,'previousElo':_0x547928['eloRating']||0x4b0,'newElo':_0x9b3ea2,'opponentId':_0x41aaab,'matchResult':'loss','previousPosition':_0x496a52,'newPosition':_0x39a3c9,'isDemotion':_0x39a3c9>_0x496a52,'matchId':_0x48a574,'timestamp':serverTimestamp()})]),!![];}catch(_0x4e0280){console['error'](_0x45f95b(0xfc),_0x4e0280);throw _0x4e0280;}}export async function approveReportD3(_0x234326,_0x15d058,_0x2c50df,_0x2fb4ff){const _0x49e307=a27_0x88eb;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x234326,'winnerScore':_0x15d058,'winnerSuicides':_0x2c50df,'winnerComment':_0x2fb4ff});const _0x2e04c8=auth['currentUser'];if(!_0x2e04c8){console[_0x49e307(0xf8)](_0x49e307(0xf6));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x2e04c8[_0x49e307(0xf5)]);const _0x45f261=await getDoc(doc(db,'playersD3',_0x2e04c8[_0x49e307(0xfd)])),_0x29b533=_0x45f261[_0x49e307(0xfe)]()?_0x45f261[_0x49e307(0xea)]()['username']:null;console['log']('Current\x20username:',_0x29b533);const _0x16aee0=doc(db,'pendingMatchesD3',_0x234326),_0x19734f=await getDoc(_0x16aee0);if(!_0x19734f['exists']()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x234326);throw new Error(_0x49e307(0xee));}const _0x185be8=_0x19734f[_0x49e307(0xea)]();console[_0x49e307(0xf8)]('D3\x20Report\x20data:',_0x185be8);if(_0x29b533!==_0x185be8['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x5f861a={..._0x185be8,'winnerScore':_0x15d058,'winnerSuicides':_0x2c50df,'winnerComment':_0x2fb4ff,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x29b533,'createdAt':_0x185be8['createdAt']||serverTimestamp(),'winnerUsername':_0x185be8[_0x49e307(0xf0)],'loserUsername':_0x185be8[_0x49e307(0x103)]};await setDoc(doc(db,'approvedMatchesD3',_0x234326),_0x5f861a),await deleteDoc(_0x16aee0),console['log'](_0x49e307(0xef));const [_0x5dc727,_0x1c02e9]=await Promise['all']([getDocs(query(collection(db,_0x49e307(0xe8)),where(_0x49e307(0xeb),'==',_0x185be8['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x185be8['loserUsername'])))]);if(_0x5dc727['empty']||_0x1c02e9['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x489707=_0x5dc727[_0x49e307(0xf9)][0x0]['id'],_0x26aba3=_0x1c02e9['docs'][0x0]['id'];return await updateEloRatingsD3(_0x489707,_0x26aba3,_0x234326),console[_0x49e307(0xf8)](_0x49e307(0xf1)),!![];}catch(_0x411910){console[_0x49e307(0x105)](_0x49e307(0xf2),_0x411910);throw _0x411910;}}