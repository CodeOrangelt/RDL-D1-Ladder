const a30_0x4c169e=(function(){let _0x5b513f=!![];return function(_0x3dc348,_0x5cae64){const _0xb2f330=_0x5b513f?function(){const _0x362b17=a30_0x3d18;if(_0x5cae64){const _0x5ddbcf=_0x5cae64[_0x362b17(0x1b5)](_0x3dc348,arguments);return _0x5cae64=null,_0x5ddbcf;}}:function(){};return _0x5b513f=![],_0xb2f330;};}()),a30_0x36af43=a30_0x4c169e(this,function(){const _0x48a9ff=a30_0x3d18,_0x395c00=function(){let _0x480630;try{_0x480630=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x474d22){_0x480630=window;}return _0x480630;},_0x3b536a=_0x395c00(),_0x247087=_0x3b536a['console']=_0x3b536a[_0x48a9ff(0x1a1)]||{},_0x479904=['log',_0x48a9ff(0x1b3),_0x48a9ff(0x199),'error',_0x48a9ff(0x1b9),_0x48a9ff(0x1a2),_0x48a9ff(0x1a0)];for(let _0x453af7=0x0;_0x453af7<_0x479904[_0x48a9ff(0x1b6)];_0x453af7++){const _0x55f99d=a30_0x4c169e['constructor']['prototype']['bind'](a30_0x4c169e),_0x56fff5=_0x479904[_0x453af7],_0x5a8180=_0x247087[_0x56fff5]||_0x55f99d;_0x55f99d['__proto__']=a30_0x4c169e['bind'](a30_0x4c169e),_0x55f99d['toString']=_0x5a8180['toString']['bind'](_0x5a8180),_0x247087[_0x56fff5]=_0x55f99d;}});a30_0x36af43();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0xe372cf,_0xcd4318,_0x3cc7e9=0x20){const _0x5257b4=0x1/(0x1+Math['pow'](0xa,(_0xcd4318-_0xe372cf)/0x190)),_0x2bd50b=0x1/(0x1+Math['pow'](0xa,(_0xe372cf-_0xcd4318)/0x190)),_0x2e69a6=_0xe372cf+_0x3cc7e9*(0x1-_0x5257b4),_0x1ea7b7=_0xcd4318+_0x3cc7e9*(0x0-_0x2bd50b);return{'newWinnerRating':Math['round'](_0x2e69a6),'newLoserRating':Math['round'](_0x1ea7b7)};}export function assignDefaultEloRating(_0xcf423c,_0x1b7f63){const _0x5c6ab1=a30_0x3d18,_0x3a37c9=0x4b0;!_0x1b7f63[_0x5c6ab1(0x1b8)]&&db['collection']('players')[_0x5c6ab1(0x1ab)](_0xcf423c)['update']({'eloRating':_0x3a37c9})[_0x5c6ab1(0x1a6)](()=>{const _0x4c6379=_0x5c6ab1;console['log'](_0x4c6379(0x1b1)+_0x1b7f63[_0x4c6379(0x1b7)]);})['catch'](_0x5f25a7=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x5f25a7);});}export async function updateEloRatings(_0x1dd465,_0x5a7443,_0x91ca8e){const _0x441f25=a30_0x3d18;try{const _0x40c0ba=writeBatch(db),_0x2e2bd0=doc(db,'players',_0x1dd465),_0x5afc21=doc(db,_0x441f25(0x1b2),_0x5a7443),[_0x14ef13,_0x402196]=await Promise[_0x441f25(0x1a9)]([getDoc(_0x2e2bd0),getDoc(_0x5afc21)]);if(!_0x14ef13['exists']()||!_0x402196['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x50d8e6=_0x14ef13['data'](),_0x78d037=_0x402196['data'](),_0xcec4d2=_0x50d8e6[_0x441f25(0x1a4)]||Number['MAX_SAFE_INTEGER'],_0x351acf=_0x78d037[_0x441f25(0x1a4)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x42b23a,newLoserRating:_0x3064a1}=calculateElo(_0x50d8e6[_0x441f25(0x1b8)]||0x4b0,_0x78d037[_0x441f25(0x1b8)]||0x4b0);let _0xec1594=_0xcec4d2,_0x2c5be0=_0x351acf;if(_0xcec4d2>_0x351acf){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0xec1594=_0x351acf,_0x2c5be0=_0x351acf+0x1;const _0x122914=query(collection(db,'players'),where('position','>',_0x351acf),where('position','<',_0xcec4d2)),_0x265193=await getDocs(_0x122914);for(const _0x4a9c51 of _0x265193['docs']){_0x4a9c51['id']!==_0x1dd465&&_0x4a9c51['id']!==_0x5a7443&&_0x40c0ba[_0x441f25(0x1a8)](doc(db,'players',_0x4a9c51['id']),{'position':_0x4a9c51[_0x441f25(0x1aa)]()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x1ba1a8={'eloRating':_0x42b23a,'lastMatchDate':serverTimestamp(),'position':_0xec1594,'lastMatchId':_0x91ca8e},_0x765e2f={'eloRating':_0x3064a1,'lastMatchDate':serverTimestamp(),'position':_0x2c5be0,'lastMatchId':_0x91ca8e};return _0x40c0ba['update'](_0x2e2bd0,_0x1ba1a8),_0x40c0ba['update'](_0x5afc21,_0x765e2f),await _0x40c0ba['commit'](),console[_0x441f25(0x1bb)]('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x1dd465,'previousElo':_0x50d8e6['eloRating']||0x4b0,'newElo':_0x42b23a,'opponentId':_0x5a7443,'matchResult':'win','previousPosition':_0xcec4d2,'newPosition':_0xec1594,'isPromotion':_0xec1594<_0xcec4d2,'matchId':_0x91ca8e,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x5a7443,'previousElo':_0x78d037['eloRating']||0x4b0,'newElo':_0x3064a1,'opponentId':_0x1dd465,'matchResult':'loss','previousPosition':_0x351acf,'newPosition':_0x2c5be0,'isDemotion':_0x2c5be0>_0x351acf,'matchId':_0x91ca8e,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x1dd465,_0x42b23a,_0x50d8e6[_0x441f25(0x1b8)],{'source':'match','matchId':_0x91ca8e}),await promotionManager['checkAndRecordPromotion'](_0x5a7443,_0x3064a1,_0x78d037[_0x441f25(0x1b8)],{'source':'match','matchId':_0x91ca8e}),console['log'](_0x441f25(0x1b0)),!![];}catch(_0x5c83d4){console['error']('Error\x20in\x20updateEloRatings:',_0x5c83d4);throw _0x5c83d4;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x2298f2,_0x4a9cd3,_0x19159b,_0xad60c9,_0x21f518){const _0x40309c=a30_0x3d18;try{const _0xeea693=doc(db,'pendingMatches',_0x2298f2),_0x44285b=await getDoc(_0xeea693);if(!_0x44285b['exists']())throw new Error(_0x40309c(0x19e));const _0x2ce8fc=_0x44285b['data'](),_0x5e1a9d={..._0x2ce8fc,'winnerScore':_0x4a9cd3,'winnerSuicides':_0x19159b,'winnerComment':_0xad60c9,'winnerDemoLink':_0x21f518,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x2298f2),_0x5e1a9d),await deleteDoc(_0xeea693),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x330eb9,_0x41a865]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x2ce8fc['winnerUsername']))),getDocs(query(collection(db,'players'),where(_0x40309c(0x1b7),'==',_0x2ce8fc['loserUsername'])))]);if(_0x330eb9['empty']||_0x41a865['empty'])throw new Error(_0x40309c(0x1bc));const _0x546f79=_0x330eb9['docs'][0x0]['id'],_0x51ea7e=_0x41a865[_0x40309c(0x1ae)][0x0]['id'];await updateEloRatings(_0x546f79,_0x51ea7e,_0x2298f2);try{const _0xea3e73=_0x2ce8fc['subgameType']||'Standard',_0x1389d0=POINTS_CHART[_0xea3e73]||0xa,_0x3a21cf=doc(db,'userProfiles',_0x546f79),_0x19fcdc=doc(db,'userProfiles',_0x51ea7e),[_0x2dc96e,_0x5c64cd]=await Promise['all']([getDoc(_0x3a21cf),getDoc(_0x19fcdc)]);if(_0x2dc96e['exists']()&&_0x5c64cd['exists']()){const _0xd7125=_0x2dc96e['data'](),_0x4db6d4=_0x5c64cd[_0x40309c(0x1aa)](),_0x3479bc=_0xd7125[_0x40309c(0x19c)]||0x0,_0x2b920b=_0x4db6d4['points']||0x0,_0x164b67=_0x3479bc+_0x1389d0,_0x2ad4ea=_0x2b920b+_0x1389d0;await Promise['all']([updateDoc(_0x3a21cf,{'points':_0x164b67,'lastPointsModified':serverTimestamp()}),updateDoc(_0x19fcdc,{'points':_0x2ad4ea,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,'pointsHistory'),{'userId':_0x546f79,'userEmail':_0xd7125['email']||'unknown','displayName':_0xd7125['displayName']||_0xd7125['username']||_0x40309c(0x1ba),'action':_0x40309c(0x1b4),'amount':_0x1389d0,'previousPoints':_0x3479bc,'newPoints':_0x164b67,'reason':'Match\x20points:\x20'+_0xea3e73+'\x20match\x20(Winner)','adminEmail':_0x40309c(0x1a7),'timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x51ea7e,'userEmail':_0x4db6d4['email']||'unknown','displayName':_0x4db6d4['displayName']||_0x4db6d4['username']||'Unknown\x20User','action':_0x40309c(0x1b4),'amount':_0x1389d0,'previousPoints':_0x2b920b,'newPoints':_0x2ad4ea,'reason':'Match\x20points:\x20'+_0xea3e73+'\x20match\x20(Participant)','adminEmail':_0x40309c(0x1a7),'timestamp':serverTimestamp()})]),console[_0x40309c(0x1bb)]('Awarded\x20'+_0x1389d0+'\x20points\x20to\x20both\x20players\x20for\x20'+_0xea3e73+_0x40309c(0x1ad));}else console[_0x40309c(0x1b3)]('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x58a59b){console['warn'](_0x40309c(0x19a),_0x58a59b);}return console[_0x40309c(0x1bb)]('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x5b7682){console['error'](_0x40309c(0x19b),_0x5b7682);throw _0x5b7682;}}function a30_0x30a3(){const _0x1e481a=['info','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','Error\x20approving\x20report:','points','totalDeaths','Report\x20not\x20found','exists','trace','console','table','wins','position','losses','then','system-match-award','update','all','data','doc','winnerScore','\x20match','docs','toISOString','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','players','warn','add','apply','length','username','eloRating','exception','Unknown\x20User','log','Could\x20not\x20find\x20player\x20documents'];a30_0x30a3=function(){return _0x1e481a;};return a30_0x30a3();}function a30_0x3d18(_0x322197,_0x1fbd9a){const _0x36af43=a30_0x30a3();return a30_0x3d18=function(_0x4c169e,_0x39a3f8){_0x4c169e=_0x4c169e-0x199;let _0x30a3a4=_0x36af43[_0x4c169e];return _0x30a3a4;},a30_0x3d18(_0x322197,_0x1fbd9a);}async function updatePlayerElo(_0x5d1d17,_0x26b810,_0x55ff70){await setDoc(doc(db,'players',_0x5d1d17),{...playerData,'eloRating':_0x55ff70}),await checkAndRecordPromotion(_0x5d1d17,_0x55ff70,_0x26b810);}async function updatePlayerStats(_0x1bf213,_0x50345b,_0x204959){const _0x2baacb=a30_0x3d18,_0x16e530=doc(db,'playerStats',_0x1bf213),_0x1d953e=await getDoc(_0x16e530);let _0x3de6eb=_0x1d953e[_0x2baacb(0x19f)]()?_0x1d953e['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x204959?(_0x3de6eb['wins']++,_0x3de6eb['totalKills']+=parseInt(_0x50345b[_0x2baacb(0x1ac)]||0x0),_0x3de6eb['totalDeaths']+=parseInt(_0x50345b['loserScore']||0x0)):(_0x3de6eb[_0x2baacb(0x1a5)]++,_0x3de6eb['totalKills']+=parseInt(_0x50345b['loserScore']||0x0),_0x3de6eb[_0x2baacb(0x19d)]+=parseInt(_0x50345b['winnerScore']||0x0));const _0x17cda3=_0x3de6eb['wins']+_0x3de6eb['losses'];_0x3de6eb['winRate']=_0x17cda3>0x0?(_0x3de6eb[_0x2baacb(0x1a3)]/_0x17cda3*0x64)['toFixed'](0x1):0x0,_0x3de6eb['lastUpdated']=new Date()[_0x2baacb(0x1af)](),await setDoc(_0x16e530,_0x3de6eb,{'merge':!![]});}