const a26_0x488c17=(function(){let _0x59f50b=!![];return function(_0x1bdf16,_0xd6230a){const _0x47a995=_0x59f50b?function(){const _0x5c4f12=a26_0x524b;if(_0xd6230a){const _0xf6c30e=_0xd6230a[_0x5c4f12(0x11d)](_0x1bdf16,arguments);return _0xd6230a=null,_0xf6c30e;}}:function(){};return _0x59f50b=![],_0x47a995;};}()),a26_0x36cfe7=a26_0x488c17(this,function(){const _0x2623e0=a26_0x524b;let _0x2e4a01;try{const _0x57ba0c=Function('return\x20(function()\x20'+_0x2623e0(0x133)+');');_0x2e4a01=_0x57ba0c();}catch(_0x4f5c78){_0x2e4a01=window;}const _0xe5890f=_0x2e4a01['console']=_0x2e4a01['console']||{},_0x40f322=['log','warn',_0x2623e0(0x124),_0x2623e0(0x135),'exception',_0x2623e0(0x122),'trace'];for(let _0x23f8be=0x0;_0x23f8be<_0x40f322['length'];_0x23f8be++){const _0x4d9866=a26_0x488c17[_0x2623e0(0x12b)][_0x2623e0(0x127)]['bind'](a26_0x488c17),_0x2f92de=_0x40f322[_0x23f8be],_0x16357b=_0xe5890f[_0x2f92de]||_0x4d9866;_0x4d9866['__proto__']=a26_0x488c17[_0x2623e0(0x132)](a26_0x488c17),_0x4d9866['toString']=_0x16357b['toString'][_0x2623e0(0x132)](_0x16357b),_0xe5890f[_0x2f92de]=_0x4d9866;}});function a26_0x2555(){const _0x2b7ff9=['winnerUsername','checkAndRecordPromotion','apply','eloRating','createdAt','D2\x20Match\x20moved\x20to\x20approved\x20collection','data','table','playersD2','info','One\x20or\x20both\x20D2\x20players\x20not\x20found','log','prototype','docs','exists','all','constructor','pow','MAX_SAFE_INTEGER','approvedMatchesD2','position','D2\x20ELO\x20ratings\x20updated\x20successfully','loserUsername','bind','{}.constructor(\x22return\x20this\x22)(\x20)','match-d2','error'];a26_0x2555=function(){return _0x2b7ff9;};return a26_0x2555();}a26_0x36cfe7();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a26_0x524b(_0x529b00,_0x483cd2){const _0x36cfe7=a26_0x2555();return a26_0x524b=function(_0x488c17,_0x1f80e2){_0x488c17=_0x488c17-0x11b;let _0x2555db=_0x36cfe7[_0x488c17];return _0x2555db;},a26_0x524b(_0x529b00,_0x483cd2);}import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x3c8a77 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x28dc81,_0x23da0f,_0x5df931=0x20){const _0x340c1d=a26_0x524b,_0x55cca7=0x1/(0x1+Math[_0x340c1d(0x12c)](0xa,(_0x23da0f-_0x28dc81)/0x190)),_0x344869=0x1/(0x1+Math['pow'](0xa,(_0x28dc81-_0x23da0f)/0x190)),_0x13a49b=_0x28dc81+_0x5df931*(0x1-_0x55cca7),_0x3b125a=_0x23da0f+_0x5df931*(0x0-_0x344869);return{'newWinnerRating':Math['round'](_0x13a49b),'newLoserRating':Math['round'](_0x3b125a)};}export async function updateEloRatingsD2(_0x447c74,_0x452787,_0x46e510){const _0x4cc439=a26_0x524b;try{const _0x15e986=writeBatch(db),_0x10400b=doc(db,'playersD2',_0x447c74),_0x176e24=doc(db,'playersD2',_0x452787),[_0xba4813,_0x1386b7]=await Promise['all']([getDoc(_0x10400b),getDoc(_0x176e24)]);if(!_0xba4813[_0x4cc439(0x129)]()||!_0x1386b7['exists']())throw new Error(_0x4cc439(0x125));const _0x3e9137=_0xba4813['data'](),_0x4f8b8c=_0x1386b7['data'](),_0xa825a4=_0x3e9137['position']||Number[_0x4cc439(0x12d)],_0x3a5366=_0x4f8b8c[_0x4cc439(0x12f)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x549d56,newLoserRating:_0x5bab53}=calculateEloD2(_0x3e9137[_0x4cc439(0x11e)]||0x4b0,_0x4f8b8c[_0x4cc439(0x11e)]||0x4b0);let _0x190612=_0xa825a4,_0x2f0be4=_0x3a5366;if(_0xa825a4>_0x3a5366){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x190612=_0x3a5366,_0x2f0be4=_0x3a5366+0x1;const _0x5287ac=query(collection(db,_0x4cc439(0x123)),where('position','>',_0x3a5366),where(_0x4cc439(0x12f),'<',_0xa825a4)),_0x32cb93=await getDocs(_0x5287ac);for(const _0x3a3eed of _0x32cb93['docs']){_0x3a3eed['id']!==_0x447c74&&_0x3a3eed['id']!==_0x452787&&_0x15e986['update'](doc(db,'playersD2',_0x3a3eed['id']),{'position':_0x3a3eed['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x15e986['update'](_0x10400b,{'eloRating':_0x549d56,'lastMatchDate':serverTimestamp(),'position':_0x190612,'lastMatchId':_0x46e510}),_0x15e986['update'](_0x176e24,{'eloRating':_0x5bab53,'lastMatchDate':serverTimestamp(),'position':_0x2f0be4,'lastMatchId':_0x46e510}),await _0x15e986['commit'](),console[_0x4cc439(0x126)](_0x4cc439(0x130)),await Promise[_0x4cc439(0x12a)]([recordEloChangeD2({'playerId':_0x447c74,'previousElo':_0x3e9137['eloRating']||0x4b0,'newElo':_0x549d56,'opponentId':_0x452787,'matchResult':'win','previousPosition':_0xa825a4,'newPosition':_0x190612,'isPromotion':_0x190612<_0xa825a4,'matchId':_0x46e510,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x452787,'previousElo':_0x4f8b8c[_0x4cc439(0x11e)]||0x4b0,'newElo':_0x5bab53,'opponentId':_0x447c74,'matchResult':'loss','previousPosition':_0x3a5366,'newPosition':_0x2f0be4,'isDemotion':_0x2f0be4>_0x3a5366,'matchId':_0x46e510,'timestamp':serverTimestamp()})]),await promotionManager[_0x4cc439(0x11c)](_0x447c74,_0x549d56,_0x3e9137[_0x4cc439(0x11e)],{'source':_0x4cc439(0x134),'matchId':_0x46e510}),await promotionManager['checkAndRecordPromotion'](_0x452787,_0x5bab53,_0x4f8b8c[_0x4cc439(0x11e)],{'source':_0x4cc439(0x134),'matchId':_0x46e510}),!![];}catch(_0x290fec){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x290fec);throw _0x290fec;}}export async function approveReportD2(_0x2dcc95,_0x175520,_0x7a0c22,_0x437fdc){const _0x49a75e=a26_0x524b;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x2dcc95,'winnerScore':_0x175520,'winnerSuicides':_0x7a0c22,'winnerComment':_0x437fdc});const _0x2694d6=auth['currentUser'];if(!_0x2694d6){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x2694d6['email']);const _0xc61a60=await getDoc(doc(db,'playersD2',_0x2694d6['uid'])),_0x5dfe5e=_0xc61a60['exists']()?_0xc61a60['data']()['username']:null;console['log']('Current\x20username:',_0x5dfe5e);const _0x2e6096=doc(db,'pendingMatchesD2',_0x2dcc95),_0x4c88de=await getDoc(_0x2e6096);if(!_0x4c88de['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x2dcc95);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x1bbb91=_0x4c88de[_0x49a75e(0x121)]();console['log']('D2\x20Report\x20data:',_0x1bbb91);if(_0x5dfe5e!==_0x1bbb91[_0x49a75e(0x11b)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x5004ee={..._0x1bbb91,'winnerScore':_0x175520,'winnerSuicides':_0x7a0c22,'winnerComment':_0x437fdc,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x5dfe5e,'createdAt':_0x1bbb91[_0x49a75e(0x11f)]||serverTimestamp(),'winnerUsername':_0x1bbb91['winnerUsername'],'loserUsername':_0x1bbb91[_0x49a75e(0x131)]};await setDoc(doc(db,_0x49a75e(0x12e),_0x2dcc95),_0x5004ee),await deleteDoc(_0x2e6096),console['log'](_0x49a75e(0x120));const [_0x35645b,_0x5caebf]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x1bbb91[_0x49a75e(0x11b)]))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x1bbb91[_0x49a75e(0x131)])))]);if(_0x35645b['empty']||_0x5caebf['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x53530c=_0x35645b[_0x49a75e(0x128)][0x0]['id'],_0x24adc6=_0x5caebf['docs'][0x0]['id'];return await updateEloRatingsD2(_0x53530c,_0x24adc6,_0x2dcc95),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x45846a){console['error']('Error\x20in\x20approveReportD2:',_0x45846a);throw _0x45846a;}}