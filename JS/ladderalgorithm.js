const a28_0x10df01=(function(){let _0x411773=!![];return function(_0x3a7327,_0x55e9ba){const _0x32b8f8=_0x411773?function(){if(_0x55e9ba){const _0x2f171b=_0x55e9ba['apply'](_0x3a7327,arguments);return _0x55e9ba=null,_0x2f171b;}}:function(){};return _0x411773=![],_0x32b8f8;};}()),a28_0x624c15=a28_0x10df01(this,function(){const _0x58b228=a28_0x52da;let _0x52ceca;try{const _0x2b28a8=Function('return\x20(function()\x20'+_0x58b228(0x8d)+');');_0x52ceca=_0x2b28a8();}catch(_0x5632ef){_0x52ceca=window;}const _0x2cf9fe=_0x52ceca['console']=_0x52ceca[_0x58b228(0x7f)]||{},_0x29ef1b=[_0x58b228(0x90),'warn','info','error','exception','table',_0x58b228(0x94)];for(let _0x45a6f3=0x0;_0x45a6f3<_0x29ef1b['length'];_0x45a6f3++){const _0x206400=a28_0x10df01[_0x58b228(0x79)]['prototype']['bind'](a28_0x10df01),_0x11d03c=_0x29ef1b[_0x45a6f3],_0x2e9995=_0x2cf9fe[_0x11d03c]||_0x206400;_0x206400[_0x58b228(0x9c)]=a28_0x10df01[_0x58b228(0x8e)](a28_0x10df01),_0x206400['toString']=_0x2e9995[_0x58b228(0x86)][_0x58b228(0x8e)](_0x2e9995),_0x2cf9fe[_0x11d03c]=_0x206400;}});a28_0x624c15();function a28_0x582f(){const _0x14e3a1=['constructor','loserScore','docs','match','loserUsername','doc','console','userProfiles','Awarded\x20','Match\x20moved\x20to\x20approved\x20collection','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','exists','wins','toString','MAX_SAFE_INTEGER','then','add','totalKills','Could\x20not\x20find\x20player\x20documents','position','{}.constructor(\x22return\x20this\x22)(\x20)','bind','eloRating','log','email','Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found','empty','trace','update','displayName','points','pendingMatches','system-match-award','data','all','__proto__','username','players','Error\x20assigning\x20default\x20ELO\x20rating:'];a28_0x582f=function(){return _0x14e3a1;};return a28_0x582f();}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x292e91,_0x4e6d90,_0x1d902c=0x20){const _0x1263c4=0x1/(0x1+Math['pow'](0xa,(_0x4e6d90-_0x292e91)/0x190)),_0x233434=0x1/(0x1+Math['pow'](0xa,(_0x292e91-_0x4e6d90)/0x190)),_0x15ca32=_0x292e91+_0x1d902c*(0x1-_0x1263c4),_0x5f8b34=_0x4e6d90+_0x1d902c*(0x0-_0x233434);return{'newWinnerRating':Math['round'](_0x15ca32),'newLoserRating':Math['round'](_0x5f8b34)};}export function assignDefaultEloRating(_0x5015f3,_0x596e8e){const _0x3d8545=a28_0x52da,_0x5e3a41=0x4b0;!_0x596e8e[_0x3d8545(0x8f)]&&db['collection'](_0x3d8545(0x9e))[_0x3d8545(0x7e)](_0x5015f3)['update']({'eloRating':_0x5e3a41})[_0x3d8545(0x88)](()=>{const _0x3e8e38=_0x3d8545;console['log'](_0x3e8e38(0x83)+_0x596e8e['username']);})['catch'](_0x4be888=>{const _0x1e4efd=_0x3d8545;console['error'](_0x1e4efd(0x9f),_0x4be888);});}export async function updateEloRatings(_0xe9cf2b,_0x3886f7,_0x5ba4a0){const _0x21e293=a28_0x52da;try{const _0x221bd8=writeBatch(db),_0x6613fd=doc(db,'players',_0xe9cf2b),_0x29c103=doc(db,'players',_0x3886f7),[_0x30b15a,_0x416899]=await Promise['all']([getDoc(_0x6613fd),getDoc(_0x29c103)]);if(!_0x30b15a['exists']()||!_0x416899['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x479d0e=_0x30b15a['data'](),_0x97b7bc=_0x416899['data'](),_0x438127=_0x479d0e[_0x21e293(0x8c)]||Number['MAX_SAFE_INTEGER'],_0x388e76=_0x97b7bc['position']||Number[_0x21e293(0x87)],{newWinnerRating:_0x58454c,newLoserRating:_0x283642}=calculateElo(_0x479d0e['eloRating']||0x4b0,_0x97b7bc['eloRating']||0x4b0);let _0x4568a9=_0x438127,_0x3a43bc=_0x388e76;if(_0x438127>_0x388e76){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4568a9=_0x388e76,_0x3a43bc=_0x388e76+0x1;const _0x544bc9=query(collection(db,'players'),where('position','>',_0x388e76),where('position','<',_0x438127)),_0x42041a=await getDocs(_0x544bc9);for(const _0x15a35a of _0x42041a['docs']){_0x15a35a['id']!==_0xe9cf2b&&_0x15a35a['id']!==_0x3886f7&&_0x221bd8['update'](doc(db,'players',_0x15a35a['id']),{'position':_0x15a35a['data']()[_0x21e293(0x8c)]+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x897ea0={'eloRating':_0x58454c,'lastMatchDate':serverTimestamp(),'position':_0x4568a9,'lastMatchId':_0x5ba4a0},_0x4ecc68={'eloRating':_0x283642,'lastMatchDate':serverTimestamp(),'position':_0x3a43bc,'lastMatchId':_0x5ba4a0};return _0x221bd8[_0x21e293(0x95)](_0x6613fd,_0x897ea0),_0x221bd8['update'](_0x29c103,_0x4ecc68),await _0x221bd8['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0xe9cf2b,'previousElo':_0x479d0e['eloRating']||0x4b0,'newElo':_0x58454c,'opponentId':_0x3886f7,'matchResult':'win','previousPosition':_0x438127,'newPosition':_0x4568a9,'isPromotion':_0x4568a9<_0x438127,'matchId':_0x5ba4a0,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x3886f7,'previousElo':_0x97b7bc['eloRating']||0x4b0,'newElo':_0x283642,'opponentId':_0xe9cf2b,'matchResult':'loss','previousPosition':_0x388e76,'newPosition':_0x3a43bc,'isDemotion':_0x3a43bc>_0x388e76,'matchId':_0x5ba4a0,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0xe9cf2b,_0x58454c,_0x479d0e[_0x21e293(0x8f)],{'source':_0x21e293(0x7c),'matchId':_0x5ba4a0}),await promotionManager['checkAndRecordPromotion'](_0x3886f7,_0x283642,_0x97b7bc['eloRating'],{'source':'match','matchId':_0x5ba4a0}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0xcc587){console['error']('Error\x20in\x20updateEloRatings:',_0xcc587);throw _0xcc587;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};function a28_0x52da(_0x536be0,_0x50269e){const _0x624c15=a28_0x582f();return a28_0x52da=function(_0x10df01,_0x18aa98){_0x10df01=_0x10df01-0x79;let _0x582f37=_0x624c15[_0x10df01];return _0x582f37;},a28_0x52da(_0x536be0,_0x50269e);}export async function approveReport(_0x52fd3b,_0x59a469,_0x42bf99,_0x1c8fcf,_0x510792){const _0x3d2598=a28_0x52da;try{const _0x49ea3a=doc(db,_0x3d2598(0x98),_0x52fd3b),_0x15f29f=await getDoc(_0x49ea3a);if(!_0x15f29f['exists']())throw new Error('Report\x20not\x20found');const _0x25f038=_0x15f29f['data'](),_0x2482a6={..._0x25f038,'winnerScore':_0x59a469,'winnerSuicides':_0x42bf99,'winnerComment':_0x1c8fcf,'winnerDemoLink':_0x510792,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x52fd3b),_0x2482a6),await deleteDoc(_0x49ea3a),console['log'](_0x3d2598(0x82));const [_0x4cd111,_0x3fbd38]=await Promise['all']([getDocs(query(collection(db,_0x3d2598(0x9e)),where('username','==',_0x25f038['winnerUsername']))),getDocs(query(collection(db,'players'),where(_0x3d2598(0x9d),'==',_0x25f038[_0x3d2598(0x7d)])))]);if(_0x4cd111['empty']||_0x3fbd38[_0x3d2598(0x93)])throw new Error(_0x3d2598(0x8b));const _0x3183ff=_0x4cd111['docs'][0x0]['id'],_0x495b2f=_0x3fbd38[_0x3d2598(0x7b)][0x0]['id'];await updateEloRatings(_0x3183ff,_0x495b2f,_0x52fd3b);try{const _0x5713f2=_0x25f038['subgameType']||'Standard',_0x122286=POINTS_CHART[_0x5713f2]||0xa,_0xebf0df=doc(db,'userProfiles',_0x3183ff),_0x86dc10=doc(db,_0x3d2598(0x80),_0x495b2f),[_0x4860b1,_0x122dc2]=await Promise[_0x3d2598(0x9b)]([getDoc(_0xebf0df),getDoc(_0x86dc10)]);if(_0x4860b1['exists']()&&_0x122dc2[_0x3d2598(0x84)]()){const _0x2efa8d=_0x4860b1['data'](),_0x4bbd63=_0x122dc2['data'](),_0x20b7ea=_0x2efa8d[_0x3d2598(0x97)]||0x0,_0x2081c0=_0x4bbd63['points']||0x0,_0x403a7c=_0x20b7ea+_0x122286,_0x51afd7=_0x2081c0+_0x122286;await Promise[_0x3d2598(0x9b)]([updateDoc(_0xebf0df,{'points':_0x403a7c,'lastPointsModified':serverTimestamp()}),updateDoc(_0x86dc10,{'points':_0x51afd7,'lastPointsModified':serverTimestamp()})]),await Promise[_0x3d2598(0x9b)]([addDoc(collection(db,'pointsHistory'),{'userId':_0x3183ff,'userEmail':_0x2efa8d['email']||'unknown','displayName':_0x2efa8d[_0x3d2598(0x96)]||_0x2efa8d['username']||'Unknown\x20User','action':_0x3d2598(0x89),'amount':_0x122286,'previousPoints':_0x20b7ea,'newPoints':_0x403a7c,'reason':'Match\x20points:\x20'+_0x5713f2+'\x20match\x20(Winner)','adminEmail':_0x3d2598(0x99),'timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x495b2f,'userEmail':_0x4bbd63[_0x3d2598(0x91)]||'unknown','displayName':_0x4bbd63['displayName']||_0x4bbd63['username']||'Unknown\x20User','action':_0x3d2598(0x89),'amount':_0x122286,'previousPoints':_0x2081c0,'newPoints':_0x51afd7,'reason':'Match\x20points:\x20'+_0x5713f2+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log'](_0x3d2598(0x81)+_0x122286+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x5713f2+'\x20match');}else console['warn'](_0x3d2598(0x92));}catch(_0x2db996){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x2db996);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x446e1b){console['error']('Error\x20approving\x20report:',_0x446e1b);throw _0x446e1b;}}async function updatePlayerElo(_0x776727,_0x5da69d,_0x497b8b){await setDoc(doc(db,'players',_0x776727),{...playerData,'eloRating':_0x497b8b}),await checkAndRecordPromotion(_0x776727,_0x497b8b,_0x5da69d);}async function updatePlayerStats(_0x2d0fea,_0x1610fe,_0x9a99b7){const _0x370173=a28_0x52da,_0x349aeb=doc(db,'playerStats',_0x2d0fea),_0x5c949a=await getDoc(_0x349aeb);let _0xc469b3=_0x5c949a[_0x370173(0x84)]()?_0x5c949a[_0x370173(0x9a)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x9a99b7?(_0xc469b3[_0x370173(0x85)]++,_0xc469b3['totalKills']+=parseInt(_0x1610fe['winnerScore']||0x0),_0xc469b3['totalDeaths']+=parseInt(_0x1610fe[_0x370173(0x7a)]||0x0)):(_0xc469b3['losses']++,_0xc469b3[_0x370173(0x8a)]+=parseInt(_0x1610fe['loserScore']||0x0),_0xc469b3['totalDeaths']+=parseInt(_0x1610fe['winnerScore']||0x0));const _0x5e2ff4=_0xc469b3[_0x370173(0x85)]+_0xc469b3['losses'];_0xc469b3['winRate']=_0x5e2ff4>0x0?(_0xc469b3['wins']/_0x5e2ff4*0x64)['toFixed'](0x1):0x0,_0xc469b3['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x349aeb,_0xc469b3,{'merge':!![]});}