function a28_0x3441(){const _0x8450c2=['MAX_SAFE_INTEGER','log','toString','return\x20(function()\x20','One\x20or\x20both\x20D2\x20players\x20not\x20found','match-d2','eloRating','round','update','D2\x20Report\x20data:','loserUsername','email','length','createdAt','pow','bind','data','docs','error','commit','username'];a28_0x3441=function(){return _0x8450c2;};return a28_0x3441();}const a28_0x22ed34=(function(){let _0x7b296b=!![];return function(_0x2eb4c7,_0x2365cb){const _0x4489c7=_0x7b296b?function(){if(_0x2365cb){const _0x7c787=_0x2365cb['apply'](_0x2eb4c7,arguments);return _0x2365cb=null,_0x7c787;}}:function(){};return _0x7b296b=![],_0x4489c7;};}()),a28_0x45749d=a28_0x22ed34(this,function(){const _0x18ca3b=a28_0x5473,_0x502729=function(){const _0x19ad5d=a28_0x5473;let _0x422e4b;try{_0x422e4b=Function(_0x19ad5d(0x156)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x25037b){_0x422e4b=window;}return _0x422e4b;},_0x14908d=_0x502729(),_0x149611=_0x14908d['console']=_0x14908d['console']||{},_0x5ef70e=['log','warn','info','error','exception','table','trace'];for(let _0x2832cf=0x0;_0x2832cf<_0x5ef70e[_0x18ca3b(0x15f)];_0x2832cf++){const _0x17bf9d=a28_0x22ed34['constructor']['prototype']['bind'](a28_0x22ed34),_0x11f402=_0x5ef70e[_0x2832cf],_0x2b6898=_0x149611[_0x11f402]||_0x17bf9d;_0x17bf9d['__proto__']=a28_0x22ed34[_0x18ca3b(0x162)](a28_0x22ed34),_0x17bf9d[_0x18ca3b(0x155)]=_0x2b6898['toString']['bind'](_0x2b6898),_0x149611[_0x11f402]=_0x17bf9d;}});function a28_0x5473(_0x2a6068,_0x1c3a9c){const _0x45749d=a28_0x3441();return a28_0x5473=function(_0x22ed34,_0x473d09){_0x22ed34=_0x22ed34-0x153;let _0x34410e=_0x45749d[_0x22ed34];return _0x34410e;},a28_0x5473(_0x2a6068,_0x1c3a9c);}a28_0x45749d();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x260f54 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x3c0407,_0x305320,_0x13dcea=0x20){const _0x215e49=a28_0x5473,_0x2289d2=0x1/(0x1+Math[_0x215e49(0x161)](0xa,(_0x305320-_0x3c0407)/0x190)),_0x531bd0=0x1/(0x1+Math['pow'](0xa,(_0x3c0407-_0x305320)/0x190)),_0x4f35cd=_0x3c0407+_0x13dcea*(0x1-_0x2289d2),_0xa81709=_0x305320+_0x13dcea*(0x0-_0x531bd0);return{'newWinnerRating':Math['round'](_0x4f35cd),'newLoserRating':Math[_0x215e49(0x15a)](_0xa81709)};}export async function updateEloRatingsD2(_0x5da1d5,_0x12cdb5,_0x124c85){const _0x132071=a28_0x5473;try{const _0x23dd5d=writeBatch(db),_0x2a0acb=doc(db,'playersD2',_0x5da1d5),_0x6889a9=doc(db,'playersD2',_0x12cdb5),[_0x30cf80,_0x251d56]=await Promise['all']([getDoc(_0x2a0acb),getDoc(_0x6889a9)]);if(!_0x30cf80['exists']()||!_0x251d56['exists']())throw new Error(_0x132071(0x157));const _0x4c6966=_0x30cf80['data'](),_0x44300b=_0x251d56[_0x132071(0x163)](),_0x462ce9=_0x4c6966['position']||Number['MAX_SAFE_INTEGER'],_0x429cfc=_0x44300b['position']||Number[_0x132071(0x153)],{newWinnerRating:_0x1bd886,newLoserRating:_0x3cd888}=calculateEloD2(_0x4c6966[_0x132071(0x159)]||0x4b0,_0x44300b['eloRating']||0x4b0);let _0x31920d=_0x462ce9,_0x47aabb=_0x429cfc;if(_0x462ce9>_0x429cfc){console[_0x132071(0x154)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x31920d=_0x429cfc,_0x47aabb=_0x429cfc+0x1;const _0x34110c=query(collection(db,'playersD2'),where('position','>',_0x429cfc),where('position','<',_0x462ce9)),_0x163862=await getDocs(_0x34110c);for(const _0x3033cb of _0x163862[_0x132071(0x164)]){_0x3033cb['id']!==_0x5da1d5&&_0x3033cb['id']!==_0x12cdb5&&_0x23dd5d[_0x132071(0x15b)](doc(db,'playersD2',_0x3033cb['id']),{'position':_0x3033cb[_0x132071(0x163)]()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x23dd5d['update'](_0x2a0acb,{'eloRating':_0x1bd886,'lastMatchDate':serverTimestamp(),'position':_0x31920d,'lastMatchId':_0x124c85}),_0x23dd5d['update'](_0x6889a9,{'eloRating':_0x3cd888,'lastMatchDate':serverTimestamp(),'position':_0x47aabb,'lastMatchId':_0x124c85}),await _0x23dd5d[_0x132071(0x166)](),console[_0x132071(0x154)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x5da1d5,'previousElo':_0x4c6966['eloRating']||0x4b0,'newElo':_0x1bd886,'opponentId':_0x12cdb5,'matchResult':'win','previousPosition':_0x462ce9,'newPosition':_0x31920d,'isPromotion':_0x31920d<_0x462ce9,'matchId':_0x124c85,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x12cdb5,'previousElo':_0x44300b[_0x132071(0x159)]||0x4b0,'newElo':_0x3cd888,'opponentId':_0x5da1d5,'matchResult':'loss','previousPosition':_0x429cfc,'newPosition':_0x47aabb,'isDemotion':_0x47aabb>_0x429cfc,'matchId':_0x124c85,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x5da1d5,_0x1bd886,_0x4c6966[_0x132071(0x159)],{'source':_0x132071(0x158),'matchId':_0x124c85}),await promotionManager['checkAndRecordPromotion'](_0x12cdb5,_0x3cd888,_0x44300b[_0x132071(0x159)],{'source':'match-d2','matchId':_0x124c85}),!![];}catch(_0x2b6e60){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x2b6e60);throw _0x2b6e60;}}export async function approveReportD2(_0x3656e5,_0x59389d,_0x27ffa6,_0x1dc421){const _0x3738de=a28_0x5473;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x3656e5,'winnerScore':_0x59389d,'winnerSuicides':_0x27ffa6,'winnerComment':_0x1dc421});const _0x2af3b4=auth['currentUser'];if(!_0x2af3b4){console[_0x3738de(0x154)]('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x2af3b4[_0x3738de(0x15e)]);const _0x163338=await getDoc(doc(db,'playersD2',_0x2af3b4['uid'])),_0x43ae25=_0x163338['exists']()?_0x163338['data']()['username']:null;console[_0x3738de(0x154)]('Current\x20username:',_0x43ae25);const _0x4a80c6=doc(db,'pendingMatchesD2',_0x3656e5),_0x31ece9=await getDoc(_0x4a80c6);if(!_0x31ece9['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x3656e5);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0xefa9ae=_0x31ece9['data']();console['log'](_0x3738de(0x15c),_0xefa9ae);if(_0x43ae25!==_0xefa9ae['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x148aa2={..._0xefa9ae,'winnerScore':_0x59389d,'winnerSuicides':_0x27ffa6,'winnerComment':_0x1dc421,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x43ae25,'createdAt':_0xefa9ae[_0x3738de(0x160)]||serverTimestamp(),'winnerUsername':_0xefa9ae['winnerUsername'],'loserUsername':_0xefa9ae[_0x3738de(0x15d)]};await setDoc(doc(db,'approvedMatchesD2',_0x3656e5),_0x148aa2),await deleteDoc(_0x4a80c6),console[_0x3738de(0x154)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x3b88c6,_0x1d03a4]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0xefa9ae['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where(_0x3738de(0x167),'==',_0xefa9ae['loserUsername'])))]);if(_0x3b88c6['empty']||_0x1d03a4['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x5494eb=_0x3b88c6['docs'][0x0]['id'],_0x4d9bd6=_0x1d03a4['docs'][0x0]['id'];return await updateEloRatingsD2(_0x5494eb,_0x4d9bd6,_0x3656e5),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0xfe0d56){console[_0x3738de(0x165)]('Error\x20in\x20approveReportD2:',_0xfe0d56);throw _0xfe0d56;}}