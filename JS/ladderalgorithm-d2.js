const a28_0x20a1d3=(function(){let _0x12a726=!![];return function(_0x3f3b53,_0x22ba48){const _0x289937=_0x12a726?function(){if(_0x22ba48){const _0x33e265=_0x22ba48['apply'](_0x3f3b53,arguments);return _0x22ba48=null,_0x33e265;}}:function(){};return _0x12a726=![],_0x289937;};}()),a28_0x1bd1ee=a28_0x20a1d3(this,function(){const _0x25781a=a28_0xca29,_0xb0e75d=function(){const _0x16c2a6=a28_0xca29;let _0x27a067;try{_0x27a067=Function('return\x20(function()\x20'+_0x16c2a6(0xfb)+');')();}catch(_0x56a8c3){_0x27a067=window;}return _0x27a067;},_0x19d5e7=_0xb0e75d(),_0x522a5b=_0x19d5e7['console']=_0x19d5e7['console']||{},_0x259903=['log','warn',_0x25781a(0x10d),_0x25781a(0x10a),'exception','table','trace'];for(let _0x1d6aaa=0x0;_0x1d6aaa<_0x259903['length'];_0x1d6aaa++){const _0x14f938=a28_0x20a1d3['constructor'][_0x25781a(0x101)][_0x25781a(0x10e)](a28_0x20a1d3),_0x539674=_0x259903[_0x1d6aaa],_0x5291ed=_0x522a5b[_0x539674]||_0x14f938;_0x14f938['__proto__']=a28_0x20a1d3['bind'](a28_0x20a1d3),_0x14f938['toString']=_0x5291ed['toString']['bind'](_0x5291ed),_0x522a5b[_0x539674]=_0x14f938;}});a28_0x1bd1ee();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0xca29(_0x3a8bc6,_0x1432f0){const _0x1bd1ee=a28_0x59f9();return a28_0xca29=function(_0x20a1d3,_0x5b2fdb){_0x20a1d3=_0x20a1d3-0xf7;let _0x59f93d=_0x1bd1ee[_0x20a1d3];return _0x59f93d;},a28_0xca29(_0x3a8bc6,_0x1432f0);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a28_0x59f9(){const _0x33a6dc=['eloRating','D2\x20Match\x20moved\x20to\x20approved\x20collection','data','exists','{}.constructor(\x22return\x20this\x22)(\x20)','Current\x20username:','loserUsername','winnerUsername','playersD2','checkAndRecordPromotion','prototype','position','username','round','all','docs','loss','MAX_SAFE_INTEGER','log','error','match-d2','No\x20user\x20logged\x20in','info','bind'];a28_0x59f9=function(){return _0x33a6dc;};return a28_0x59f9();}import a28_0x76eb66 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x3a65c6,_0x3d634a,_0xa04401=0x20){const _0x24a38c=a28_0xca29,_0x2fa06e=0x1/(0x1+Math['pow'](0xa,(_0x3d634a-_0x3a65c6)/0x190)),_0x300ee1=0x1/(0x1+Math['pow'](0xa,(_0x3a65c6-_0x3d634a)/0x190)),_0x4f6bff=_0x3a65c6+_0xa04401*(0x1-_0x2fa06e),_0x2f8c89=_0x3d634a+_0xa04401*(0x0-_0x300ee1);return{'newWinnerRating':Math[_0x24a38c(0x104)](_0x4f6bff),'newLoserRating':Math['round'](_0x2f8c89)};}export async function updateEloRatingsD2(_0x369c5a,_0x38c086,_0x8d500){const _0x468dca=a28_0xca29;try{const _0x283518=writeBatch(db),_0x4527b2=doc(db,'playersD2',_0x369c5a),_0x3ae937=doc(db,'playersD2',_0x38c086),[_0x4450f1,_0x4d7091]=await Promise['all']([getDoc(_0x4527b2),getDoc(_0x3ae937)]);if(!_0x4450f1['exists']()||!_0x4d7091[_0x468dca(0xfa)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x3b8abc=_0x4450f1['data'](),_0x1f38ee=_0x4d7091[_0x468dca(0xf9)](),_0x524bc9=_0x3b8abc[_0x468dca(0x102)]||Number['MAX_SAFE_INTEGER'],_0x3e9aa1=_0x1f38ee[_0x468dca(0x102)]||Number[_0x468dca(0x108)],{newWinnerRating:_0x22f592,newLoserRating:_0x3407d7}=calculateEloD2(_0x3b8abc['eloRating']||0x4b0,_0x1f38ee['eloRating']||0x4b0);let _0xcb47f7=_0x524bc9,_0x587fbd=_0x3e9aa1;if(_0x524bc9>_0x3e9aa1){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0xcb47f7=_0x3e9aa1,_0x587fbd=_0x3e9aa1+0x1;const _0x49b10b=query(collection(db,'playersD2'),where('position','>',_0x3e9aa1),where('position','<',_0x524bc9)),_0x3ff629=await getDocs(_0x49b10b);for(const _0x289cb0 of _0x3ff629[_0x468dca(0x106)]){_0x289cb0['id']!==_0x369c5a&&_0x289cb0['id']!==_0x38c086&&_0x283518['update'](doc(db,'playersD2',_0x289cb0['id']),{'position':_0x289cb0[_0x468dca(0xf9)]()['position']+0x1});}}else console[_0x468dca(0x109)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x283518['update'](_0x4527b2,{'eloRating':_0x22f592,'lastMatchDate':serverTimestamp(),'position':_0xcb47f7,'lastMatchId':_0x8d500}),_0x283518['update'](_0x3ae937,{'eloRating':_0x3407d7,'lastMatchDate':serverTimestamp(),'position':_0x587fbd,'lastMatchId':_0x8d500}),await _0x283518['commit'](),console[_0x468dca(0x109)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x369c5a,'previousElo':_0x3b8abc['eloRating']||0x4b0,'newElo':_0x22f592,'opponentId':_0x38c086,'matchResult':'win','previousPosition':_0x524bc9,'newPosition':_0xcb47f7,'isPromotion':_0xcb47f7<_0x524bc9,'matchId':_0x8d500,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x38c086,'previousElo':_0x1f38ee['eloRating']||0x4b0,'newElo':_0x3407d7,'opponentId':_0x369c5a,'matchResult':_0x468dca(0x107),'previousPosition':_0x3e9aa1,'newPosition':_0x587fbd,'isDemotion':_0x587fbd>_0x3e9aa1,'matchId':_0x8d500,'timestamp':serverTimestamp()})]),await promotionManager[_0x468dca(0x100)](_0x369c5a,_0x22f592,_0x3b8abc['eloRating'],{'source':_0x468dca(0x10b),'matchId':_0x8d500}),await promotionManager['checkAndRecordPromotion'](_0x38c086,_0x3407d7,_0x1f38ee[_0x468dca(0xf7)],{'source':'match-d2','matchId':_0x8d500}),!![];}catch(_0x177c11){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x177c11);throw _0x177c11;}}export async function approveReportD2(_0x313471,_0x4d8cf6,_0x37f03c,_0x192980){const _0x60bd44=a28_0xca29;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x313471,'winnerScore':_0x4d8cf6,'winnerSuicides':_0x37f03c,'winnerComment':_0x192980});const _0x228c78=auth['currentUser'];if(!_0x228c78){console[_0x60bd44(0x109)](_0x60bd44(0x10c));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x228c78['email']);const _0x45c053=await getDoc(doc(db,_0x60bd44(0xff),_0x228c78['uid'])),_0x12550a=_0x45c053['exists']()?_0x45c053['data']()['username']:null;console[_0x60bd44(0x109)](_0x60bd44(0xfc),_0x12550a);const _0x458065=doc(db,'pendingMatchesD2',_0x313471),_0x9b9398=await getDoc(_0x458065);if(!_0x9b9398['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x313471);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x59be44=_0x9b9398['data']();console['log']('D2\x20Report\x20data:',_0x59be44);if(_0x12550a!==_0x59be44['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x5e5958={..._0x59be44,'winnerScore':_0x4d8cf6,'winnerSuicides':_0x37f03c,'winnerComment':_0x192980,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x12550a,'createdAt':_0x59be44['createdAt']||serverTimestamp(),'winnerUsername':_0x59be44[_0x60bd44(0xfe)],'loserUsername':_0x59be44[_0x60bd44(0xfd)]};await setDoc(doc(db,'approvedMatchesD2',_0x313471),_0x5e5958),await deleteDoc(_0x458065),console['log'](_0x60bd44(0xf8));const [_0x4b7181,_0x1f05fc]=await Promise[_0x60bd44(0x105)]([getDocs(query(collection(db,'playersD2'),where(_0x60bd44(0x103),'==',_0x59be44['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where(_0x60bd44(0x103),'==',_0x59be44['loserUsername'])))]);if(_0x4b7181['empty']||_0x1f05fc['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x2e1a3e=_0x4b7181['docs'][0x0]['id'],_0x477933=_0x1f05fc['docs'][0x0]['id'];return await updateEloRatingsD2(_0x2e1a3e,_0x477933,_0x313471),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x37e931){console['error']('Error\x20in\x20approveReportD2:',_0x37e931);throw _0x37e931;}}