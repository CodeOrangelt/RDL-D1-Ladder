const a27_0x1e42e1=(function(){let _0x1266b6=!![];return function(_0x370335,_0x3deb6c){const _0x52bdfb=_0x1266b6?function(){if(_0x3deb6c){const _0x586b59=_0x3deb6c['apply'](_0x370335,arguments);return _0x3deb6c=null,_0x586b59;}}:function(){};return _0x1266b6=![],_0x52bdfb;};}()),a27_0xc5af61=a27_0x1e42e1(this,function(){const _0x468aad=a27_0x2b95,_0x9ef0e9=function(){let _0x226501;try{_0x226501=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x2c71fd){_0x226501=window;}return _0x226501;},_0x35e1ac=_0x9ef0e9(),_0x3b8af7=_0x35e1ac['console']=_0x35e1ac[_0x468aad(0xb0)]||{},_0x5cdb52=['log','warn','info','error',_0x468aad(0xa3),'table','trace'];for(let _0x295995=0x0;_0x295995<_0x5cdb52['length'];_0x295995++){const _0x71a7=a27_0x1e42e1[_0x468aad(0xa6)]['prototype']['bind'](a27_0x1e42e1),_0xabcd75=_0x5cdb52[_0x295995],_0x3aed51=_0x3b8af7[_0xabcd75]||_0x71a7;_0x71a7[_0x468aad(0xac)]=a27_0x1e42e1['bind'](a27_0x1e42e1),_0x71a7['toString']=_0x3aed51['toString'][_0x468aad(0x9f)](_0x3aed51),_0x3b8af7[_0xabcd75]=_0x71a7;}});a27_0xc5af61();function a27_0x2b95(_0x141338,_0x4e1b46){const _0xc5af61=a27_0x47a5();return a27_0x2b95=function(_0x1e42e1,_0x536c4d){_0x1e42e1=_0x1e42e1-0x9f;let _0x47a5f6=_0xc5af61[_0x1e42e1];return _0x47a5f6;},a27_0x2b95(_0x141338,_0x4e1b46);}import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x119e15,_0x12e8f4,_0x3ad653=0x20){const _0x97a00d=a27_0x2b95,_0x1a5977=0x1/(0x1+Math['pow'](0xa,(_0x12e8f4-_0x119e15)/0x190)),_0x1ea662=0x1/(0x1+Math['pow'](0xa,(_0x119e15-_0x12e8f4)/0x190)),_0x2874db=_0x119e15+_0x3ad653*(0x1-_0x1a5977),_0x3b01c3=_0x12e8f4+_0x3ad653*(0x0-_0x1ea662);return{'newWinnerRating':Math[_0x97a00d(0xa5)](_0x2874db),'newLoserRating':Math['round'](_0x3b01c3)};}function a27_0x47a5(){const _0x2b6044=['bind','Starting\x20approveReportD3\x20function\x20with:','playersD3','empty','exception','MAX_SAFE_INTEGER','round','constructor','update','Current\x20user:','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','winnerUsername','No\x20user\x20logged\x20in','__proto__','data','docs','all','console','exists','error','log','D3\x20ELO\x20ratings\x20updated\x20successfully','uid','position','D3\x20Match\x20moved\x20to\x20approved\x20collection','createdAt'];a27_0x47a5=function(){return _0x2b6044;};return a27_0x47a5();}export async function updateEloRatingsD3(_0x51d7d7,_0x40be45,_0x5ec1bc){const _0x30a534=a27_0x2b95;try{const _0x2c8ca3=writeBatch(db),_0x28370d=doc(db,_0x30a534(0xa1),_0x51d7d7),_0xd58cf8=doc(db,_0x30a534(0xa1),_0x40be45),[_0x30bc9d,_0x3c200a]=await Promise['all']([getDoc(_0x28370d),getDoc(_0xd58cf8)]);if(!_0x30bc9d['exists']()||!_0x3c200a[_0x30a534(0xb1)]())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x3dc31f=_0x30bc9d['data'](),_0x1f2af9=_0x3c200a['data'](),_0x213b88=_0x3dc31f[_0x30a534(0xb6)]||Number['MAX_SAFE_INTEGER'],_0x3cae24=_0x1f2af9[_0x30a534(0xb6)]||Number[_0x30a534(0xa4)],{newWinnerRating:_0x4b103b,newLoserRating:_0x4fc345}=calculateEloD3(_0x3dc31f['eloRating']||0x4b0,_0x1f2af9['eloRating']||0x4b0);let _0x3c8e01=_0x213b88,_0x26f8e0=_0x3cae24;if(_0x213b88>_0x3cae24){console['log'](_0x30a534(0xa9)),_0x3c8e01=_0x3cae24,_0x26f8e0=_0x3cae24+0x1;const _0x32ca50=query(collection(db,'playersD3'),where(_0x30a534(0xb6),'>',_0x3cae24),where('position','<',_0x213b88)),_0xfe29ca=await getDocs(_0x32ca50);for(const _0x3fbd9a of _0xfe29ca['docs']){_0x3fbd9a['id']!==_0x51d7d7&&_0x3fbd9a['id']!==_0x40be45&&_0x2c8ca3[_0x30a534(0xa7)](doc(db,'playersD3',_0x3fbd9a['id']),{'position':_0x3fbd9a[_0x30a534(0xad)]()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x2c8ca3['update'](_0x28370d,{'eloRating':_0x4b103b,'lastMatchDate':serverTimestamp(),'position':_0x3c8e01,'lastMatchId':_0x5ec1bc}),_0x2c8ca3['update'](_0xd58cf8,{'eloRating':_0x4fc345,'lastMatchDate':serverTimestamp(),'position':_0x26f8e0,'lastMatchId':_0x5ec1bc}),await _0x2c8ca3['commit'](),console[_0x30a534(0xb3)](_0x30a534(0xb4)),await Promise[_0x30a534(0xaf)]([recordEloChangeD3({'playerId':_0x51d7d7,'previousElo':_0x3dc31f['eloRating']||0x4b0,'newElo':_0x4b103b,'opponentId':_0x40be45,'matchResult':'win','previousPosition':_0x213b88,'newPosition':_0x3c8e01,'isPromotion':_0x3c8e01<_0x213b88,'matchId':_0x5ec1bc,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x40be45,'previousElo':_0x1f2af9['eloRating']||0x4b0,'newElo':_0x4fc345,'opponentId':_0x51d7d7,'matchResult':'loss','previousPosition':_0x3cae24,'newPosition':_0x26f8e0,'isDemotion':_0x26f8e0>_0x3cae24,'matchId':_0x5ec1bc,'timestamp':serverTimestamp()})]),!![];}catch(_0x1b1e3e){console[_0x30a534(0xb2)]('Error\x20in\x20updateEloRatingsD3:',_0x1b1e3e);throw _0x1b1e3e;}}export async function approveReportD3(_0x395f50,_0x2931f3,_0x4cd018,_0x553e1e){const _0x3b7cb6=a27_0x2b95;try{console[_0x3b7cb6(0xb3)](_0x3b7cb6(0xa0),{'reportId':_0x395f50,'winnerScore':_0x2931f3,'winnerSuicides':_0x4cd018,'winnerComment':_0x553e1e});const _0x1f0f72=auth['currentUser'];if(!_0x1f0f72){console['log'](_0x3b7cb6(0xab));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log'](_0x3b7cb6(0xa8),_0x1f0f72['email']);const _0x57e9fc=await getDoc(doc(db,'playersD3',_0x1f0f72[_0x3b7cb6(0xb5)])),_0x1e9661=_0x57e9fc['exists']()?_0x57e9fc[_0x3b7cb6(0xad)]()['username']:null;console['log']('Current\x20username:',_0x1e9661);const _0x396058=doc(db,'pendingMatchesD3',_0x395f50),_0x4b86f0=await getDoc(_0x396058);if(!_0x4b86f0[_0x3b7cb6(0xb1)]()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x395f50);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0xd11da1=_0x4b86f0['data']();console['log']('D3\x20Report\x20data:',_0xd11da1);if(_0x1e9661!==_0xd11da1['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x23a6cb={..._0xd11da1,'winnerScore':_0x2931f3,'winnerSuicides':_0x4cd018,'winnerComment':_0x553e1e,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1e9661,'createdAt':_0xd11da1[_0x3b7cb6(0xb8)]||serverTimestamp(),'winnerUsername':_0xd11da1[_0x3b7cb6(0xaa)],'loserUsername':_0xd11da1['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x395f50),_0x23a6cb),await deleteDoc(_0x396058),console['log'](_0x3b7cb6(0xb7));const [_0x2b6a87,_0x5cca77]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0xd11da1['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where('username','==',_0xd11da1['loserUsername'])))]);if(_0x2b6a87[_0x3b7cb6(0xa2)]||_0x5cca77['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x8f7903=_0x2b6a87[_0x3b7cb6(0xae)][0x0]['id'],_0x3cbe75=_0x5cca77['docs'][0x0]['id'];return await updateEloRatingsD3(_0x8f7903,_0x3cbe75,_0x395f50),console[_0x3b7cb6(0xb3)]('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x42f50f){console['error']('Error\x20in\x20approveReportD3:',_0x42f50f);throw _0x42f50f;}}