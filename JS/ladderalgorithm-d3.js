const a29_0x5059a7=(function(){let _0x5d7705=!![];return function(_0x211330,_0x49660b){const _0x49bd1b=_0x5d7705?function(){if(_0x49660b){const _0x52e162=_0x49660b['apply'](_0x211330,arguments);return _0x49660b=null,_0x52e162;}}:function(){};return _0x5d7705=![],_0x49bd1b;};}()),a29_0x550113=a29_0x5059a7(this,function(){const _0x33b087=a29_0xe13a;let _0x4a31e4;try{const _0x17615d=Function('return\x20(function()\x20'+_0x33b087(0x13e)+');');_0x4a31e4=_0x17615d();}catch(_0xef6129){_0x4a31e4=window;}const _0x718898=_0x4a31e4['console']=_0x4a31e4['console']||{},_0x1cc5c8=[_0x33b087(0x134),_0x33b087(0x12a),_0x33b087(0x13c),_0x33b087(0x135),_0x33b087(0x12d),_0x33b087(0x140),'trace'];for(let _0x463899=0x0;_0x463899<_0x1cc5c8[_0x33b087(0x12c)];_0x463899++){const _0x1de53e=a29_0x5059a7['constructor'][_0x33b087(0x136)]['bind'](a29_0x5059a7),_0x58cd41=_0x1cc5c8[_0x463899],_0x2be134=_0x718898[_0x58cd41]||_0x1de53e;_0x1de53e['__proto__']=a29_0x5059a7[_0x33b087(0x124)](a29_0x5059a7),_0x1de53e[_0x33b087(0x139)]=_0x2be134['toString']['bind'](_0x2be134),_0x718898[_0x58cd41]=_0x1de53e;}});function a29_0x279f(){const _0x1b4001=['D3\x20Report\x20not\x20found\x20with\x20ID:','bind','pow','win','exists','username','D3\x20ELO\x20ratings\x20updated\x20successfully','warn','eloRating','length','exception','Error\x20in\x20approveReportD3:','data','email','approvedMatchesD3','uid','round','log','error','prototype','D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','docs','toString','update','Current\x20username:','info','position','{}.constructor(\x22return\x20this\x22)(\x20)','winnerUsername','table','createdAt'];a29_0x279f=function(){return _0x1b4001;};return a29_0x279f();}a29_0x550113();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a29_0xe13a(_0x2247fb,_0x191c3b){const _0x550113=a29_0x279f();return a29_0xe13a=function(_0x5059a7,_0x28ecd4){_0x5059a7=_0x5059a7-0x123;let _0x279f2c=_0x550113[_0x5059a7];return _0x279f2c;},a29_0xe13a(_0x2247fb,_0x191c3b);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x45dd60,_0x6b2615,_0x15fc3a=0x20){const _0x273d51=a29_0xe13a,_0x3bb938=0x1/(0x1+Math['pow'](0xa,(_0x6b2615-_0x45dd60)/0x190)),_0x216a9e=0x1/(0x1+Math[_0x273d51(0x125)](0xa,(_0x45dd60-_0x6b2615)/0x190)),_0x182586=_0x45dd60+_0x15fc3a*(0x1-_0x3bb938),_0xcd191=_0x6b2615+_0x15fc3a*(0x0-_0x216a9e);return{'newWinnerRating':Math[_0x273d51(0x133)](_0x182586),'newLoserRating':Math['round'](_0xcd191)};}export async function updateEloRatingsD3(_0x28b2d5,_0x48d7e6,_0x40937c){const _0x380c76=a29_0xe13a;try{const _0x1edaf4=writeBatch(db),_0x26342f=doc(db,'playersD3',_0x28b2d5),_0x4f4ab3=doc(db,'playersD3',_0x48d7e6),[_0x35be09,_0x5daa9d]=await Promise['all']([getDoc(_0x26342f),getDoc(_0x4f4ab3)]);if(!_0x35be09['exists']()||!_0x5daa9d[_0x380c76(0x127)]())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x2fc8ea=_0x35be09['data'](),_0x3ed4a3=_0x5daa9d[_0x380c76(0x12f)](),_0x4f7e07=_0x2fc8ea['position']||Number['MAX_SAFE_INTEGER'],_0x31fe51=_0x3ed4a3['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x437155,newLoserRating:_0x27a5d6}=calculateEloD3(_0x2fc8ea['eloRating']||0x4b0,_0x3ed4a3[_0x380c76(0x12b)]||0x4b0);let _0x4d92d6=_0x4f7e07,_0x12bc5f=_0x31fe51;if(_0x4f7e07>_0x31fe51){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4d92d6=_0x31fe51,_0x12bc5f=_0x31fe51+0x1;const _0x38549f=query(collection(db,'playersD3'),where('position','>',_0x31fe51),where(_0x380c76(0x13d),'<',_0x4f7e07)),_0x403ab5=await getDocs(_0x38549f);for(const _0x1294e8 of _0x403ab5['docs']){_0x1294e8['id']!==_0x28b2d5&&_0x1294e8['id']!==_0x48d7e6&&_0x1edaf4['update'](doc(db,'playersD3',_0x1294e8['id']),{'position':_0x1294e8['data']()['position']+0x1});}}else console[_0x380c76(0x134)]('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x1edaf4['update'](_0x26342f,{'eloRating':_0x437155,'lastMatchDate':serverTimestamp(),'position':_0x4d92d6,'lastMatchId':_0x40937c}),_0x1edaf4[_0x380c76(0x13a)](_0x4f4ab3,{'eloRating':_0x27a5d6,'lastMatchDate':serverTimestamp(),'position':_0x12bc5f,'lastMatchId':_0x40937c}),await _0x1edaf4['commit'](),console[_0x380c76(0x134)](_0x380c76(0x129)),await Promise['all']([recordEloChangeD3({'playerId':_0x28b2d5,'previousElo':_0x2fc8ea['eloRating']||0x4b0,'newElo':_0x437155,'opponentId':_0x48d7e6,'matchResult':_0x380c76(0x126),'previousPosition':_0x4f7e07,'newPosition':_0x4d92d6,'isPromotion':_0x4d92d6<_0x4f7e07,'matchId':_0x40937c,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x48d7e6,'previousElo':_0x3ed4a3['eloRating']||0x4b0,'newElo':_0x27a5d6,'opponentId':_0x28b2d5,'matchResult':'loss','previousPosition':_0x31fe51,'newPosition':_0x12bc5f,'isDemotion':_0x12bc5f>_0x31fe51,'matchId':_0x40937c,'timestamp':serverTimestamp()})]),!![];}catch(_0x3b8bdc){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x3b8bdc);throw _0x3b8bdc;}}export async function approveReportD3(_0x2eae9f,_0x161396,_0xac7f8a,_0x32466e){const _0x2d062a=a29_0xe13a;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x2eae9f,'winnerScore':_0x161396,'winnerSuicides':_0xac7f8a,'winnerComment':_0x32466e});const _0x284e74=auth['currentUser'];if(!_0x284e74){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x284e74[_0x2d062a(0x130)]);const _0x261847=await getDoc(doc(db,'playersD3',_0x284e74[_0x2d062a(0x132)])),_0x418e5e=_0x261847['exists']()?_0x261847['data']()['username']:null;console['log'](_0x2d062a(0x13b),_0x418e5e);const _0x3c5f3b=doc(db,'pendingMatchesD3',_0x2eae9f),_0x4fe23a=await getDoc(_0x3c5f3b);if(!_0x4fe23a[_0x2d062a(0x127)]()){console['log'](_0x2d062a(0x123),_0x2eae9f);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x4814b2=_0x4fe23a['data']();console['log']('D3\x20Report\x20data:',_0x4814b2);if(_0x418e5e!==_0x4814b2['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x2493ac={..._0x4814b2,'winnerScore':_0x161396,'winnerSuicides':_0xac7f8a,'winnerComment':_0x32466e,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x418e5e,'createdAt':_0x4814b2[_0x2d062a(0x141)]||serverTimestamp(),'winnerUsername':_0x4814b2[_0x2d062a(0x13f)],'loserUsername':_0x4814b2['loserUsername']};await setDoc(doc(db,_0x2d062a(0x131),_0x2eae9f),_0x2493ac),await deleteDoc(_0x3c5f3b),console[_0x2d062a(0x134)]('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x2c19ec,_0x4c697e]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where(_0x2d062a(0x128),'==',_0x4814b2[_0x2d062a(0x13f)]))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x4814b2['loserUsername'])))]);if(_0x2c19ec['empty']||_0x4c697e['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x2fe699=_0x2c19ec[_0x2d062a(0x138)][0x0]['id'],_0x4c7942=_0x4c697e[_0x2d062a(0x138)][0x0]['id'];return await updateEloRatingsD3(_0x2fe699,_0x4c7942,_0x2eae9f),console[_0x2d062a(0x134)](_0x2d062a(0x137)),!![];}catch(_0x4bdeef){console['error'](_0x2d062a(0x12e),_0x4bdeef);throw _0x4bdeef;}}