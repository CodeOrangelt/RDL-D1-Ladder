const a27_0x4e0d8c=(function(){let _0x442efb=!![];return function(_0x2eb368,_0x4176a2){const _0x552a46=_0x442efb?function(){if(_0x4176a2){const _0x52201a=_0x4176a2['apply'](_0x2eb368,arguments);return _0x4176a2=null,_0x52201a;}}:function(){};return _0x442efb=![],_0x552a46;};}()),a27_0x876ffc=a27_0x4e0d8c(this,function(){const _0x36fc8f=a27_0x335a;let _0x5117ca;try{const _0x4d72c2=Function('return\x20(function()\x20'+_0x36fc8f(0xae)+');');_0x5117ca=_0x4d72c2();}catch(_0x5c6003){_0x5117ca=window;}const _0x22c680=_0x5117ca[_0x36fc8f(0xaf)]=_0x5117ca['console']||{},_0xf73f2b=['log',_0x36fc8f(0xb7),'info','error',_0x36fc8f(0xb4),_0x36fc8f(0xab),'trace'];for(let _0xd0d0c1=0x0;_0xd0d0c1<_0xf73f2b['length'];_0xd0d0c1++){const _0x30b201=a27_0x4e0d8c['constructor']['prototype']['bind'](a27_0x4e0d8c),_0x2596f7=_0xf73f2b[_0xd0d0c1],_0x503f3b=_0x22c680[_0x2596f7]||_0x30b201;_0x30b201['__proto__']=a27_0x4e0d8c['bind'](a27_0x4e0d8c),_0x30b201['toString']=_0x503f3b['toString']['bind'](_0x503f3b),_0x22c680[_0x2596f7]=_0x30b201;}});a27_0x876ffc();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a27_0x1377(){const _0x43436e=['error','D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','docs','playersD3','D3\x20match\x20report\x20not\x20found','username','loss','eloRating','table','loserUsername','D3\x20Report\x20data:','{}.constructor(\x22return\x20this\x22)(\x20)','console','pow','commit','update','exists','exception','position','log','warn','Starting\x20approveReportD3\x20function\x20with:','all','D3\x20Report\x20not\x20found\x20with\x20ID:'];a27_0x1377=function(){return _0x43436e;};return a27_0x1377();}import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x3449e5,_0x1084ff,_0x283670=0x20){const _0x5e8b69=a27_0x335a,_0x5ab290=0x1/(0x1+Math[_0x5e8b69(0xb0)](0xa,(_0x1084ff-_0x3449e5)/0x190)),_0x507b7b=0x1/(0x1+Math['pow'](0xa,(_0x3449e5-_0x1084ff)/0x190)),_0x485fa1=_0x3449e5+_0x283670*(0x1-_0x5ab290),_0x5631c6=_0x1084ff+_0x283670*(0x0-_0x507b7b);return{'newWinnerRating':Math['round'](_0x485fa1),'newLoserRating':Math['round'](_0x5631c6)};}function a27_0x335a(_0x5f5dcd,_0x2bd3db){const _0x876ffc=a27_0x1377();return a27_0x335a=function(_0x4e0d8c,_0x87f199){_0x4e0d8c=_0x4e0d8c-0xa2;let _0x1377ae=_0x876ffc[_0x4e0d8c];return _0x1377ae;},a27_0x335a(_0x5f5dcd,_0x2bd3db);}export async function updateEloRatingsD3(_0x260b84,_0x23505a,_0x5c2758){const _0x2e619d=a27_0x335a;try{const _0x2eaf45=writeBatch(db),_0x203413=doc(db,'playersD3',_0x260b84),_0xa4ad79=doc(db,'playersD3',_0x23505a),[_0x467760,_0x46d19e]=await Promise[_0x2e619d(0xb9)]([getDoc(_0x203413),getDoc(_0xa4ad79)]);if(!_0x467760['exists']()||!_0x46d19e[_0x2e619d(0xb3)]())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x118985=_0x467760['data'](),_0x5e0381=_0x46d19e['data'](),_0xfacfef=_0x118985[_0x2e619d(0xb5)]||Number['MAX_SAFE_INTEGER'],_0x47eb54=_0x5e0381['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0xd9784e,newLoserRating:_0x1e101d}=calculateEloD3(_0x118985['eloRating']||0x4b0,_0x5e0381['eloRating']||0x4b0);let _0x14281e=_0xfacfef,_0x20c209=_0x47eb54;if(_0xfacfef>_0x47eb54){console['log'](_0x2e619d(0xa4)),_0x14281e=_0x47eb54,_0x20c209=_0x47eb54+0x1;const _0x136f33=query(collection(db,'playersD3'),where('position','>',_0x47eb54),where(_0x2e619d(0xb5),'<',_0xfacfef)),_0x517eee=await getDocs(_0x136f33);for(const _0x1ba75a of _0x517eee['docs']){_0x1ba75a['id']!==_0x260b84&&_0x1ba75a['id']!==_0x23505a&&_0x2eaf45['update'](doc(db,_0x2e619d(0xa6),_0x1ba75a['id']),{'position':_0x1ba75a['data']()['position']+0x1});}}else console['log'](_0x2e619d(0xa3));return _0x2eaf45[_0x2e619d(0xb2)](_0x203413,{'eloRating':_0xd9784e,'lastMatchDate':serverTimestamp(),'position':_0x14281e,'lastMatchId':_0x5c2758}),_0x2eaf45['update'](_0xa4ad79,{'eloRating':_0x1e101d,'lastMatchDate':serverTimestamp(),'position':_0x20c209,'lastMatchId':_0x5c2758}),await _0x2eaf45[_0x2e619d(0xb1)](),console[_0x2e619d(0xb6)]('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x2e619d(0xb9)]([recordEloChangeD3({'playerId':_0x260b84,'previousElo':_0x118985['eloRating']||0x4b0,'newElo':_0xd9784e,'opponentId':_0x23505a,'matchResult':'win','previousPosition':_0xfacfef,'newPosition':_0x14281e,'isPromotion':_0x14281e<_0xfacfef,'matchId':_0x5c2758,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x23505a,'previousElo':_0x5e0381[_0x2e619d(0xaa)]||0x4b0,'newElo':_0x1e101d,'opponentId':_0x260b84,'matchResult':_0x2e619d(0xa9),'previousPosition':_0x47eb54,'newPosition':_0x20c209,'isDemotion':_0x20c209>_0x47eb54,'matchId':_0x5c2758,'timestamp':serverTimestamp()})]),!![];}catch(_0x2f5ea6){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x2f5ea6);throw _0x2f5ea6;}}export async function approveReportD3(_0x5edc72,_0x38afee,_0x13ea14,_0x1f768e){const _0x53f050=a27_0x335a;try{console['log'](_0x53f050(0xb8),{'reportId':_0x5edc72,'winnerScore':_0x38afee,'winnerSuicides':_0x13ea14,'winnerComment':_0x1f768e});const _0x1b73e9=auth['currentUser'];if(!_0x1b73e9){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x1b73e9['email']);const _0x6007c9=await getDoc(doc(db,_0x53f050(0xa6),_0x1b73e9['uid'])),_0xe3dbcd=_0x6007c9['exists']()?_0x6007c9['data']()[_0x53f050(0xa8)]:null;console['log']('Current\x20username:',_0xe3dbcd);const _0x34e61a=doc(db,'pendingMatchesD3',_0x5edc72),_0x3365cf=await getDoc(_0x34e61a);if(!_0x3365cf['exists']()){console['log'](_0x53f050(0xba),_0x5edc72);throw new Error(_0x53f050(0xa7));}const _0x33c5ad=_0x3365cf['data']();console['log'](_0x53f050(0xad),_0x33c5ad);if(_0xe3dbcd!==_0x33c5ad['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x4a2427={..._0x33c5ad,'winnerScore':_0x38afee,'winnerSuicides':_0x13ea14,'winnerComment':_0x1f768e,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0xe3dbcd,'createdAt':_0x33c5ad['createdAt']||serverTimestamp(),'winnerUsername':_0x33c5ad['winnerUsername'],'loserUsername':_0x33c5ad[_0x53f050(0xac)]};await setDoc(doc(db,'approvedMatchesD3',_0x5edc72),_0x4a2427),await deleteDoc(_0x34e61a),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x5267d0,_0x2e4ec1]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where(_0x53f050(0xa8),'==',_0x33c5ad['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x53f050(0xa8),'==',_0x33c5ad['loserUsername'])))]);if(_0x5267d0['empty']||_0x2e4ec1['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x124a91=_0x5267d0['docs'][0x0]['id'],_0x3ff823=_0x2e4ec1[_0x53f050(0xa5)][0x0]['id'];return await updateEloRatingsD3(_0x124a91,_0x3ff823,_0x5edc72),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x4bef2e){console[_0x53f050(0xa2)]('Error\x20in\x20approveReportD3:',_0x4bef2e);throw _0x4bef2e;}}