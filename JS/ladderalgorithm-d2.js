const a28_0x362f97=(function(){let _0x41feb9=!![];return function(_0x34b3eb,_0x42c64a){const _0x243740=_0x41feb9?function(){if(_0x42c64a){const _0x34f51e=_0x42c64a['apply'](_0x34b3eb,arguments);return _0x42c64a=null,_0x34f51e;}}:function(){};return _0x41feb9=![],_0x243740;};}()),a28_0x276541=a28_0x362f97(this,function(){const _0x5f4f04=a28_0x3a05,_0x440f8c=function(){let _0x37e3bd;try{_0x37e3bd=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x35bd33){_0x37e3bd=window;}return _0x37e3bd;},_0x462516=_0x440f8c(),_0x396ce7=_0x462516['console']=_0x462516['console']||{},_0x49a749=['log','warn','info',_0x5f4f04(0x66),'exception',_0x5f4f04(0x68),_0x5f4f04(0x6e)];for(let _0x3cd68a=0x0;_0x3cd68a<_0x49a749['length'];_0x3cd68a++){const _0x23fa47=a28_0x362f97['constructor'][_0x5f4f04(0x75)]['bind'](a28_0x362f97),_0x5f3b30=_0x49a749[_0x3cd68a],_0x3a27ad=_0x396ce7[_0x5f3b30]||_0x23fa47;_0x23fa47[_0x5f4f04(0x7c)]=a28_0x362f97['bind'](a28_0x362f97),_0x23fa47['toString']=_0x3a27ad['toString']['bind'](_0x3a27ad),_0x396ce7[_0x5f3b30]=_0x23fa47;}});a28_0x276541();function a28_0x3a05(_0x3cac95,_0xdf3dce){const _0x276541=a28_0x6f55();return a28_0x3a05=function(_0x362f97,_0x417d2c){_0x362f97=_0x362f97-0x66;let _0x6f55e5=_0x276541[_0x362f97];return _0x6f55e5;},a28_0x3a05(_0x3cac95,_0xdf3dce);}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';function a28_0x6f55(){const _0x192f89=['error','Current\x20username:','table','log','D2\x20Report\x20data:','win','eloRating','playersD2','trace','MAX_SAFE_INTEGER','exists','data','D2\x20ELO\x20ratings\x20updated\x20successfully','checkAndRecordPromotion','pow','prototype','winnerUsername','docs','Current\x20user:','empty','email','No\x20user\x20logged\x20in','__proto__'];a28_0x6f55=function(){return _0x192f89;};return a28_0x6f55();}import{promotionManager}from'./promotions.js';import a28_0x2a0caf from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x3ec96f,_0x5e5189,_0x20195b=0x20){const _0x376612=a28_0x3a05,_0x5ab81a=0x1/(0x1+Math[_0x376612(0x74)](0xa,(_0x5e5189-_0x3ec96f)/0x190)),_0x4426a8=0x1/(0x1+Math['pow'](0xa,(_0x3ec96f-_0x5e5189)/0x190)),_0x717e4f=_0x3ec96f+_0x20195b*(0x1-_0x5ab81a),_0x2ff6a8=_0x5e5189+_0x20195b*(0x0-_0x4426a8);return{'newWinnerRating':Math['round'](_0x717e4f),'newLoserRating':Math['round'](_0x2ff6a8)};}export async function updateEloRatingsD2(_0x8b55af,_0xa664e7,_0x2cde3f){const _0x49f905=a28_0x3a05;try{const _0x23161c=writeBatch(db),_0x580d86=doc(db,'playersD2',_0x8b55af),_0x170ae6=doc(db,'playersD2',_0xa664e7),[_0x40b52e,_0x47c48d]=await Promise['all']([getDoc(_0x580d86),getDoc(_0x170ae6)]);if(!_0x40b52e[_0x49f905(0x70)]()||!_0x47c48d[_0x49f905(0x70)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x45309c=_0x40b52e['data'](),_0x39ceca=_0x47c48d['data'](),_0x409fb9=_0x45309c['position']||Number[_0x49f905(0x6f)],_0x497612=_0x39ceca['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x3e3313,newLoserRating:_0x13d592}=calculateEloD2(_0x45309c['eloRating']||0x4b0,_0x39ceca['eloRating']||0x4b0);let _0x4d2557=_0x409fb9,_0x417412=_0x497612;if(_0x409fb9>_0x497612){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4d2557=_0x497612,_0x417412=_0x497612+0x1;const _0x21cbcd=query(collection(db,_0x49f905(0x6d)),where('position','>',_0x497612),where('position','<',_0x409fb9)),_0x4fa2da=await getDocs(_0x21cbcd);for(const _0x3ed379 of _0x4fa2da['docs']){_0x3ed379['id']!==_0x8b55af&&_0x3ed379['id']!==_0xa664e7&&_0x23161c['update'](doc(db,'playersD2',_0x3ed379['id']),{'position':_0x3ed379['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x23161c['update'](_0x580d86,{'eloRating':_0x3e3313,'lastMatchDate':serverTimestamp(),'position':_0x4d2557,'lastMatchId':_0x2cde3f}),_0x23161c['update'](_0x170ae6,{'eloRating':_0x13d592,'lastMatchDate':serverTimestamp(),'position':_0x417412,'lastMatchId':_0x2cde3f}),await _0x23161c['commit'](),console['log'](_0x49f905(0x72)),await Promise['all']([recordEloChangeD2({'playerId':_0x8b55af,'previousElo':_0x45309c[_0x49f905(0x6c)]||0x4b0,'newElo':_0x3e3313,'opponentId':_0xa664e7,'matchResult':_0x49f905(0x6b),'previousPosition':_0x409fb9,'newPosition':_0x4d2557,'isPromotion':_0x4d2557<_0x409fb9,'matchId':_0x2cde3f,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0xa664e7,'previousElo':_0x39ceca['eloRating']||0x4b0,'newElo':_0x13d592,'opponentId':_0x8b55af,'matchResult':'loss','previousPosition':_0x497612,'newPosition':_0x417412,'isDemotion':_0x417412>_0x497612,'matchId':_0x2cde3f,'timestamp':serverTimestamp()})]),await promotionManager[_0x49f905(0x73)](_0x8b55af,_0x3e3313,_0x45309c['eloRating'],{'source':'match-d2','matchId':_0x2cde3f}),await promotionManager[_0x49f905(0x73)](_0xa664e7,_0x13d592,_0x39ceca['eloRating'],{'source':'match-d2','matchId':_0x2cde3f}),!![];}catch(_0x3014c7){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x3014c7);throw _0x3014c7;}}export async function approveReportD2(_0x242a76,_0x215241,_0xe87cd4,_0x1fde0b){const _0x22f42d=a28_0x3a05;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x242a76,'winnerScore':_0x215241,'winnerSuicides':_0xe87cd4,'winnerComment':_0x1fde0b});const _0x431fc=auth['currentUser'];if(!_0x431fc){console['log'](_0x22f42d(0x7b));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log'](_0x22f42d(0x78),_0x431fc[_0x22f42d(0x7a)]);const _0x498d13=await getDoc(doc(db,'playersD2',_0x431fc['uid'])),_0x4281ad=_0x498d13['exists']()?_0x498d13[_0x22f42d(0x71)]()['username']:null;console['log'](_0x22f42d(0x67),_0x4281ad);const _0x58f6a5=doc(db,'pendingMatchesD2',_0x242a76),_0x5241e8=await getDoc(_0x58f6a5);if(!_0x5241e8[_0x22f42d(0x70)]()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x242a76);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x369029=_0x5241e8['data']();console['log'](_0x22f42d(0x6a),_0x369029);if(_0x4281ad!==_0x369029[_0x22f42d(0x76)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x2e199c={..._0x369029,'winnerScore':_0x215241,'winnerSuicides':_0xe87cd4,'winnerComment':_0x1fde0b,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x4281ad,'createdAt':_0x369029['createdAt']||serverTimestamp(),'winnerUsername':_0x369029['winnerUsername'],'loserUsername':_0x369029['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x242a76),_0x2e199c),await deleteDoc(_0x58f6a5),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x32ae0f,_0x689ef6]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x369029['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x369029['loserUsername'])))]);if(_0x32ae0f[_0x22f42d(0x79)]||_0x689ef6['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x883523=_0x32ae0f[_0x22f42d(0x77)][0x0]['id'],_0x5dc605=_0x689ef6['docs'][0x0]['id'];return await updateEloRatingsD2(_0x883523,_0x5dc605,_0x242a76),console[_0x22f42d(0x69)]('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x2fe4ce){console[_0x22f42d(0x66)]('Error\x20in\x20approveReportD2:',_0x2fe4ce);throw _0x2fe4ce;}}