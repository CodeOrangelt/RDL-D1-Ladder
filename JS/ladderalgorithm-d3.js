const a27_0x55012a=(function(){let _0x3bfdc4=!![];return function(_0x40ff82,_0x49abc3){const _0x37d627=_0x3bfdc4?function(){const _0x549d53=a27_0xa98a;if(_0x49abc3){const _0x12080d=_0x49abc3[_0x549d53(0xc1)](_0x40ff82,arguments);return _0x49abc3=null,_0x12080d;}}:function(){};return _0x3bfdc4=![],_0x37d627;};}()),a27_0x2a6440=a27_0x55012a(this,function(){const _0x9812b9=a27_0xa98a,_0x2750a3=function(){let _0x2aefa2;try{_0x2aefa2=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x5d50e7){_0x2aefa2=window;}return _0x2aefa2;},_0x5802ca=_0x2750a3(),_0x2855a3=_0x5802ca[_0x9812b9(0xb6)]=_0x5802ca[_0x9812b9(0xb6)]||{},_0x29cc92=['log','warn','info',_0x9812b9(0xb2),_0x9812b9(0xa8),'table',_0x9812b9(0xbe)];for(let _0x431e6e=0x0;_0x431e6e<_0x29cc92['length'];_0x431e6e++){const _0x264caf=a27_0x55012a['constructor']['prototype']['bind'](a27_0x55012a),_0x3b5643=_0x29cc92[_0x431e6e],_0x4bc5d5=_0x2855a3[_0x3b5643]||_0x264caf;_0x264caf[_0x9812b9(0xb0)]=a27_0x55012a[_0x9812b9(0xac)](a27_0x55012a),_0x264caf['toString']=_0x4bc5d5['toString']['bind'](_0x4bc5d5),_0x2855a3[_0x3b5643]=_0x264caf;}});a27_0x2a6440();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x5592cc,_0x54c119,_0x466122=0x20){const _0x6b66fc=a27_0xa98a,_0x4b95e2=0x1/(0x1+Math[_0x6b66fc(0xa6)](0xa,(_0x54c119-_0x5592cc)/0x190)),_0x442299=0x1/(0x1+Math[_0x6b66fc(0xa6)](0xa,(_0x5592cc-_0x54c119)/0x190)),_0x573d68=_0x5592cc+_0x466122*(0x1-_0x4b95e2),_0x116402=_0x54c119+_0x466122*(0x0-_0x442299);return{'newWinnerRating':Math['round'](_0x573d68),'newLoserRating':Math['round'](_0x116402)};}export async function updateEloRatingsD3(_0x5c8ef2,_0x50b4d3,_0x560542){const _0x46600e=a27_0xa98a;try{const _0x2da591=writeBatch(db),_0x18bea0=doc(db,_0x46600e(0xae),_0x5c8ef2),_0x314fb7=doc(db,'playersD3',_0x50b4d3),[_0x55a897,_0x1ce83c]=await Promise['all']([getDoc(_0x18bea0),getDoc(_0x314fb7)]);if(!_0x55a897[_0x46600e(0xa7)]()||!_0x1ce83c['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x49d6a9=_0x55a897['data'](),_0x1f2c20=_0x1ce83c[_0x46600e(0xba)](),_0x5b4158=_0x49d6a9['position']||Number['MAX_SAFE_INTEGER'],_0x1d18f7=_0x1f2c20['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x36bac9,newLoserRating:_0x2329ac}=calculateEloD3(_0x49d6a9[_0x46600e(0xad)]||0x4b0,_0x1f2c20['eloRating']||0x4b0);let _0x1a1cf8=_0x5b4158,_0x4ce1f0=_0x1d18f7;if(_0x5b4158>_0x1d18f7){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x1a1cf8=_0x1d18f7,_0x4ce1f0=_0x1d18f7+0x1;const _0x5cd474=query(collection(db,'playersD3'),where('position','>',_0x1d18f7),where('position','<',_0x5b4158)),_0x1c0b39=await getDocs(_0x5cd474);for(const _0x1a1df8 of _0x1c0b39['docs']){_0x1a1df8['id']!==_0x5c8ef2&&_0x1a1df8['id']!==_0x50b4d3&&_0x2da591['update'](doc(db,'playersD3',_0x1a1df8['id']),{'position':_0x1a1df8['data']()[_0x46600e(0xaf)]+0x1});}}else console['log'](_0x46600e(0xbc));return _0x2da591[_0x46600e(0xb9)](_0x18bea0,{'eloRating':_0x36bac9,'lastMatchDate':serverTimestamp(),'position':_0x1a1cf8,'lastMatchId':_0x560542}),_0x2da591['update'](_0x314fb7,{'eloRating':_0x2329ac,'lastMatchDate':serverTimestamp(),'position':_0x4ce1f0,'lastMatchId':_0x560542}),await _0x2da591['commit'](),console['log'](_0x46600e(0xaa)),await Promise['all']([recordEloChangeD3({'playerId':_0x5c8ef2,'previousElo':_0x49d6a9['eloRating']||0x4b0,'newElo':_0x36bac9,'opponentId':_0x50b4d3,'matchResult':'win','previousPosition':_0x5b4158,'newPosition':_0x1a1cf8,'isPromotion':_0x1a1cf8<_0x5b4158,'matchId':_0x560542,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x50b4d3,'previousElo':_0x1f2c20['eloRating']||0x4b0,'newElo':_0x2329ac,'opponentId':_0x5c8ef2,'matchResult':_0x46600e(0xb1),'previousPosition':_0x1d18f7,'newPosition':_0x4ce1f0,'isDemotion':_0x4ce1f0>_0x1d18f7,'matchId':_0x560542,'timestamp':serverTimestamp()})]),!![];}catch(_0x40a8fd){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x40a8fd);throw _0x40a8fd;}}function a27_0xa98a(_0x4e6aec,_0x2c511a){const _0x2a6440=a27_0x4fd3();return a27_0xa98a=function(_0x55012a,_0x42544b){_0x55012a=_0x55012a-0xa6;let _0x4fd32f=_0x2a6440[_0x55012a];return _0x4fd32f;},a27_0xa98a(_0x4e6aec,_0x2c511a);}function a27_0x4fd3(){const _0x33a23d=['pow','exists','exception','Current\x20username:','D3\x20ELO\x20ratings\x20updated\x20successfully','D3\x20match\x20report\x20not\x20found','bind','eloRating','playersD3','position','__proto__','loss','error','uid','log','Error\x20in\x20approveReportD3:','console','D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','No\x20user\x20logged\x20in','update','data','username','D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','currentUser','trace','winnerUsername','email','apply','loserUsername'];a27_0x4fd3=function(){return _0x33a23d;};return a27_0x4fd3();}export async function approveReportD3(_0x185028,_0x571341,_0x440b69,_0x5e7c3e){const _0x308ed1=a27_0xa98a;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x185028,'winnerScore':_0x571341,'winnerSuicides':_0x440b69,'winnerComment':_0x5e7c3e});const _0x59b6d0=auth[_0x308ed1(0xbd)];if(!_0x59b6d0){console[_0x308ed1(0xb4)](_0x308ed1(0xb8));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x59b6d0[_0x308ed1(0xc0)]);const _0x4f4b76=await getDoc(doc(db,'playersD3',_0x59b6d0[_0x308ed1(0xb3)])),_0x189439=_0x4f4b76['exists']()?_0x4f4b76[_0x308ed1(0xba)]()[_0x308ed1(0xbb)]:null;console['log'](_0x308ed1(0xa9),_0x189439);const _0x26008a=doc(db,'pendingMatchesD3',_0x185028),_0x38e57a=await getDoc(_0x26008a);if(!_0x38e57a['exists']()){console[_0x308ed1(0xb4)]('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x185028);throw new Error(_0x308ed1(0xab));}const _0x2d7b59=_0x38e57a[_0x308ed1(0xba)]();console['log']('D3\x20Report\x20data:',_0x2d7b59);if(_0x189439!==_0x2d7b59['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x4964ba={..._0x2d7b59,'winnerScore':_0x571341,'winnerSuicides':_0x440b69,'winnerComment':_0x5e7c3e,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x189439,'createdAt':_0x2d7b59['createdAt']||serverTimestamp(),'winnerUsername':_0x2d7b59['winnerUsername'],'loserUsername':_0x2d7b59['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x185028),_0x4964ba),await deleteDoc(_0x26008a),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x503f27,_0x977f6d]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x2d7b59[_0x308ed1(0xbf)]))),getDocs(query(collection(db,'playersD3'),where('username','==',_0x2d7b59[_0x308ed1(0xc2)])))]);if(_0x503f27['empty']||_0x977f6d['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x3ecca3=_0x503f27['docs'][0x0]['id'],_0x1b1349=_0x977f6d['docs'][0x0]['id'];return await updateEloRatingsD3(_0x3ecca3,_0x1b1349,_0x185028),console['log'](_0x308ed1(0xb7)),!![];}catch(_0xc75954){console['error'](_0x308ed1(0xb5),_0xc75954);throw _0xc75954;}}