const a29_0x556bf6=(function(){let _0x17b3d9=!![];return function(_0x29d300,_0x4ec06f){const _0x3ea4a2=_0x17b3d9?function(){if(_0x4ec06f){const _0x9f03f5=_0x4ec06f['apply'](_0x29d300,arguments);return _0x4ec06f=null,_0x9f03f5;}}:function(){};return _0x17b3d9=![],_0x3ea4a2;};}()),a29_0x4f2d90=a29_0x556bf6(this,function(){const _0x2ab3f7=a29_0x2c22;let _0x30462a;try{const _0x49789e=Function('return\x20(function()\x20'+_0x2ab3f7(0x8f)+');');_0x30462a=_0x49789e();}catch(_0x3479fd){_0x30462a=window;}const _0xbf41b0=_0x30462a['console']=_0x30462a['console']||{},_0x60355d=[_0x2ab3f7(0x9b),'warn','info','error','exception','table','trace'];for(let _0x3a3946=0x0;_0x3a3946<_0x60355d['length'];_0x3a3946++){const _0x209741=a29_0x556bf6[_0x2ab3f7(0x9a)]['prototype']['bind'](a29_0x556bf6),_0x365238=_0x60355d[_0x3a3946],_0x27e1ab=_0xbf41b0[_0x365238]||_0x209741;_0x209741['__proto__']=a29_0x556bf6['bind'](a29_0x556bf6),_0x209741['toString']=_0x27e1ab['toString'][_0x2ab3f7(0x97)](_0x27e1ab),_0xbf41b0[_0x365238]=_0x209741;}});a29_0x4f2d90();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a29_0x4af3(){const _0x55d358=['exists','{}.constructor(\x22return\x20this\x22)(\x20)','data','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches','D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','createdAt','No\x20user\x20logged\x20in','playersD3','docs','bind','pendingMatchesD3','username','constructor','log','loserUsername','email','pow','win','eloRating','position','winnerUsername'];a29_0x4af3=function(){return _0x55d358;};return a29_0x4af3();}import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x432a1c,_0x34e36d,_0x5b215f=0x20){const _0x285e37=a29_0x2c22,_0xad036c=0x1/(0x1+Math[_0x285e37(0x9e)](0xa,(_0x34e36d-_0x432a1c)/0x190)),_0x580dc0=0x1/(0x1+Math[_0x285e37(0x9e)](0xa,(_0x432a1c-_0x34e36d)/0x190)),_0x335cdc=_0x432a1c+_0x5b215f*(0x1-_0xad036c),_0x3cf7b6=_0x34e36d+_0x5b215f*(0x0-_0x580dc0);return{'newWinnerRating':Math['round'](_0x335cdc),'newLoserRating':Math['round'](_0x3cf7b6)};}export async function updateEloRatingsD3(_0x21c552,_0x41403b,_0x59ad17){const _0x5f3a09=a29_0x2c22;try{const _0x25d2e7=writeBatch(db),_0x30ae74=doc(db,'playersD3',_0x21c552),_0x2df79b=doc(db,'playersD3',_0x41403b),[_0x4ff2b7,_0x54580b]=await Promise['all']([getDoc(_0x30ae74),getDoc(_0x2df79b)]);if(!_0x4ff2b7['exists']()||!_0x54580b['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x537347=_0x4ff2b7[_0x5f3a09(0x90)](),_0x58386b=_0x54580b['data'](),_0x1870aa=_0x537347['position']||Number['MAX_SAFE_INTEGER'],_0x32ebe1=_0x58386b['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x1573a5,newLoserRating:_0x3059f3}=calculateEloD3(_0x537347['eloRating']||0x4b0,_0x58386b[_0x5f3a09(0xa0)]||0x4b0);let _0x47283c=_0x1870aa,_0x47a414=_0x32ebe1;if(_0x1870aa>_0x32ebe1){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x47283c=_0x32ebe1,_0x47a414=_0x32ebe1+0x1;const _0x322e62=query(collection(db,_0x5f3a09(0x95)),where('position','>',_0x32ebe1),where(_0x5f3a09(0xa1),'<',_0x1870aa)),_0x16ad22=await getDocs(_0x322e62);for(const _0x348305 of _0x16ad22[_0x5f3a09(0x96)]){_0x348305['id']!==_0x21c552&&_0x348305['id']!==_0x41403b&&_0x25d2e7['update'](doc(db,'playersD3',_0x348305['id']),{'position':_0x348305['data']()['position']+0x1});}}else console[_0x5f3a09(0x9b)]('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x25d2e7['update'](_0x30ae74,{'eloRating':_0x1573a5,'lastMatchDate':serverTimestamp(),'position':_0x47283c,'lastMatchId':_0x59ad17}),_0x25d2e7['update'](_0x2df79b,{'eloRating':_0x3059f3,'lastMatchDate':serverTimestamp(),'position':_0x47a414,'lastMatchId':_0x59ad17}),await _0x25d2e7['commit'](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD3({'playerId':_0x21c552,'previousElo':_0x537347[_0x5f3a09(0xa0)]||0x4b0,'newElo':_0x1573a5,'opponentId':_0x41403b,'matchResult':_0x5f3a09(0x9f),'previousPosition':_0x1870aa,'newPosition':_0x47283c,'isPromotion':_0x47283c<_0x1870aa,'matchId':_0x59ad17,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x41403b,'previousElo':_0x58386b['eloRating']||0x4b0,'newElo':_0x3059f3,'opponentId':_0x21c552,'matchResult':'loss','previousPosition':_0x32ebe1,'newPosition':_0x47a414,'isDemotion':_0x47a414>_0x32ebe1,'matchId':_0x59ad17,'timestamp':serverTimestamp()})]),!![];}catch(_0x342165){console['error']('Error\x20in\x20updateEloRatingsD3:',_0x342165);throw _0x342165;}}function a29_0x2c22(_0x94e1a5,_0x4f219f){const _0x4f2d90=a29_0x4af3();return a29_0x2c22=function(_0x556bf6,_0xb6906f){_0x556bf6=_0x556bf6-0x8e;let _0x4af323=_0x4f2d90[_0x556bf6];return _0x4af323;},a29_0x2c22(_0x94e1a5,_0x4f219f);}export async function approveReportD3(_0x149c43,_0x1bd751,_0x5270aa,_0x1bb032){const _0x599e0c=a29_0x2c22;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x149c43,'winnerScore':_0x1bd751,'winnerSuicides':_0x5270aa,'winnerComment':_0x1bb032});const _0xb1d7a9=auth['currentUser'];if(!_0xb1d7a9){console[_0x599e0c(0x9b)](_0x599e0c(0x94));throw new Error(_0x599e0c(0x91));}console[_0x599e0c(0x9b)]('Current\x20user:',_0xb1d7a9[_0x599e0c(0x9d)]);const _0x28dab4=await getDoc(doc(db,_0x599e0c(0x95),_0xb1d7a9['uid'])),_0xed3986=_0x28dab4['exists']()?_0x28dab4['data']()['username']:null;console[_0x599e0c(0x9b)]('Current\x20username:',_0xed3986);const _0x4812b3=doc(db,_0x599e0c(0x98),_0x149c43),_0x8fb510=await getDoc(_0x4812b3);if(!_0x8fb510[_0x599e0c(0x8e)]()){console[_0x599e0c(0x9b)]('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x149c43);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x5e9d08=_0x8fb510['data']();console['log']('D3\x20Report\x20data:',_0x5e9d08);if(_0xed3986!==_0x5e9d08[_0x599e0c(0xa2)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x453482={..._0x5e9d08,'winnerScore':_0x1bd751,'winnerSuicides':_0x5270aa,'winnerComment':_0x1bb032,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0xed3986,'createdAt':_0x5e9d08[_0x599e0c(0x93)]||serverTimestamp(),'winnerUsername':_0x5e9d08['winnerUsername'],'loserUsername':_0x5e9d08[_0x599e0c(0x9c)]};await setDoc(doc(db,'approvedMatchesD3',_0x149c43),_0x453482),await deleteDoc(_0x4812b3),console['log']('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x2726bf,_0x205cea]=await Promise['all']([getDocs(query(collection(db,_0x599e0c(0x95)),where('username','==',_0x5e9d08['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x599e0c(0x99),'==',_0x5e9d08[_0x599e0c(0x9c)])))]);if(_0x2726bf['empty']||_0x205cea['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x1a46bc=_0x2726bf[_0x599e0c(0x96)][0x0]['id'],_0x338ffe=_0x205cea['docs'][0x0]['id'];return await updateEloRatingsD3(_0x1a46bc,_0x338ffe,_0x149c43),console['log'](_0x599e0c(0x92)),!![];}catch(_0x5b6aeb){console['error']('Error\x20in\x20approveReportD3:',_0x5b6aeb);throw _0x5b6aeb;}}