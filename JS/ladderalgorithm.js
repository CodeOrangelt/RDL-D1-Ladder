const a28_0x2d3e4c=(function(){let _0x45fad1=!![];return function(_0x2ca581,_0x34619d){const _0x464d46=_0x45fad1?function(){const _0x70d0d0=a28_0x2f2b;if(_0x34619d){const _0x12b0b9=_0x34619d[_0x70d0d0(0xde)](_0x2ca581,arguments);return _0x34619d=null,_0x12b0b9;}}:function(){};return _0x45fad1=![],_0x464d46;};}()),a28_0x527146=a28_0x2d3e4c(this,function(){const _0x516d3e=a28_0x2f2b,_0x3a68ec=function(){let _0x5898bc;try{_0x5898bc=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x1d8563){_0x5898bc=window;}return _0x5898bc;},_0x4ebfcd=_0x3a68ec(),_0xcba9b0=_0x4ebfcd['console']=_0x4ebfcd[_0x516d3e(0xbb)]||{},_0xbe0111=[_0x516d3e(0xb9),_0x516d3e(0xd4),'info','error','exception',_0x516d3e(0xba),'trace'];for(let _0x1844cc=0x0;_0x1844cc<_0xbe0111['length'];_0x1844cc++){const _0xfff155=a28_0x2d3e4c['constructor']['prototype']['bind'](a28_0x2d3e4c),_0x4bae13=_0xbe0111[_0x1844cc],_0x48e07d=_0xcba9b0[_0x4bae13]||_0xfff155;_0xfff155[_0x516d3e(0xdc)]=a28_0x2d3e4c['bind'](a28_0x2d3e4c),_0xfff155[_0x516d3e(0xe0)]=_0x48e07d[_0x516d3e(0xe0)]['bind'](_0x48e07d),_0xcba9b0[_0x4bae13]=_0xfff155;}});a28_0x527146();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{RANKS,getRankStyle}from'./ranks.js';export function calculateElo(_0xc6b830,_0x10855e,_0x5625bb=0x20){const _0x1d003b=a28_0x2f2b;_0xc6b830=_0xc6b830>0x3e8?0xc8:_0xc6b830,_0x10855e=_0x10855e>0x3e8?0xc8:_0x10855e;const _0x374d86=0x1/(0x1+Math[_0x1d003b(0xd6)](0xa,(_0x10855e-_0xc6b830)/0x190)),_0x40e6cd=0x1/(0x1+Math['pow'](0xa,(_0xc6b830-_0x10855e)/0x190)),_0x3ae048=_0xc6b830+_0x5625bb*(0x1-_0x374d86),_0x2ebe9c=_0x10855e+_0x5625bb*(0x0-_0x40e6cd);return{'newWinnerRating':Math['round'](Math['min'](_0x3ae048)),'newLoserRating':Math['round'](Math[_0x1d003b(0xdf)](_0x2ebe9c,0x0))};}export function assignDefaultEloRating(_0x149906,_0x201a6d){const _0x3a4af7=a28_0x2f2b,_0x21a969=0xc8;!_0x201a6d['eloRating']&&db[_0x3a4af7(0xdb)]('players')['doc'](_0x149906)['update']({'eloRating':_0x21a969})['then'](()=>{const _0xd5c8ac=_0x3a4af7;console['log'](_0xd5c8ac(0xd7)+_0x201a6d[_0xd5c8ac(0xcd)]);})[_0x3a4af7(0xc3)](_0x1d5386=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x1d5386);});}function a28_0x189d(){const _0x1090f5=['totalKills','\x20match','log','table','console','Could\x20not\x20find\x20player\x20documents','displayName','system-match-award','email','data','unknown','winRate','catch','Match\x20points:\x20','toFixed','error','position','players','Error\x20in\x20updateEloRatings:','MAX_SAFE_INTEGER','lastUpdated','wins','username','docs','match','losses','eloRating','commit','\x20match\x20(Winner)','warn','exists','pow','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','loserScore','checkAndRecordPromotion','ELO\x20ratings\x20updated\x20successfully','collection','__proto__','all','apply','max','toString','winnerScore'];a28_0x189d=function(){return _0x1090f5;};return a28_0x189d();}export async function updateEloRatings(_0xedeb17,_0x5718e6,_0x20731f){const _0x46c631=a28_0x2f2b;try{const _0x893c12=writeBatch(db),_0x376647=doc(db,'players',_0xedeb17),_0x4728fa=doc(db,'players',_0x5718e6),[_0x567831,_0x3759ed]=await Promise['all']([getDoc(_0x376647),getDoc(_0x4728fa)]);if(!_0x567831['exists']()||!_0x3759ed['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x5a0145=_0x567831['data'](),_0x2f8f82=_0x3759ed['data'](),_0x1c06bf=_0x5a0145['position']||Number['MAX_SAFE_INTEGER'],_0x13b0af=_0x2f8f82[_0x46c631(0xc7)]||Number[_0x46c631(0xca)],{newWinnerRating:_0x6d3e99,newLoserRating:_0x31d316}=calculateElo(_0x5a0145[_0x46c631(0xd1)]||0x4b0,_0x2f8f82['eloRating']||0x4b0);let _0x4dcb1b=_0x1c06bf,_0x2333fc=_0x13b0af;if(_0x1c06bf>_0x13b0af){console[_0x46c631(0xb9)]('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4dcb1b=_0x13b0af,_0x2333fc=_0x13b0af+0x1;const _0x511809=query(collection(db,'players'),where('position','>',_0x13b0af),where('position','<',_0x1c06bf)),_0x1ec125=await getDocs(_0x511809);for(const _0x1f6c15 of _0x1ec125[_0x46c631(0xce)]){_0x1f6c15['id']!==_0xedeb17&&_0x1f6c15['id']!==_0x5718e6&&_0x893c12['update'](doc(db,_0x46c631(0xc8),_0x1f6c15['id']),{'position':_0x1f6c15['data']()[_0x46c631(0xc7)]+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x20aea3={'eloRating':_0x6d3e99,'lastMatchDate':serverTimestamp(),'position':_0x4dcb1b,'lastMatchId':_0x20731f},_0x4f1461={'eloRating':_0x31d316,'lastMatchDate':serverTimestamp(),'position':_0x2333fc,'lastMatchId':_0x20731f};return _0x893c12['update'](_0x376647,_0x20aea3),_0x893c12['update'](_0x4728fa,_0x4f1461),await _0x893c12[_0x46c631(0xd2)](),console['log'](_0x46c631(0xda)),await Promise['all']([recordEloChange({'playerId':_0xedeb17,'previousElo':_0x5a0145[_0x46c631(0xd1)]||0x4b0,'newElo':_0x6d3e99,'opponentId':_0x5718e6,'matchResult':'win','previousPosition':_0x1c06bf,'newPosition':_0x4dcb1b,'isPromotion':_0x4dcb1b<_0x1c06bf,'matchId':_0x20731f,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x5718e6,'previousElo':_0x2f8f82['eloRating']||0x4b0,'newElo':_0x31d316,'opponentId':_0xedeb17,'matchResult':'loss','previousPosition':_0x13b0af,'newPosition':_0x2333fc,'isDemotion':_0x2333fc>_0x13b0af,'matchId':_0x20731f,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0xedeb17,_0x6d3e99,_0x5a0145['eloRating'],{'source':_0x46c631(0xcf),'matchId':_0x20731f}),await promotionManager[_0x46c631(0xd9)](_0x5718e6,_0x31d316,_0x2f8f82['eloRating'],{'source':_0x46c631(0xcf),'matchId':_0x20731f}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x422cfe){console[_0x46c631(0xc6)](_0x46c631(0xc9),_0x422cfe);throw _0x422cfe;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};function a28_0x2f2b(_0x4b7893,_0x4007ee){const _0x527146=a28_0x189d();return a28_0x2f2b=function(_0x2d3e4c,_0x3ff3fe){_0x2d3e4c=_0x2d3e4c-0xb7;let _0x189d09=_0x527146[_0x2d3e4c];return _0x189d09;},a28_0x2f2b(_0x4b7893,_0x4007ee);}export async function approveReport(_0x3131db,_0x3daa01,_0x25050c,_0x37bdde,_0x331aec){const _0x4cfd6d=a28_0x2f2b;try{const _0x12345d=doc(db,'pendingMatches',_0x3131db),_0x2c5ebe=await getDoc(_0x12345d);if(!_0x2c5ebe['exists']())throw new Error('Report\x20not\x20found');const _0x53059b=_0x2c5ebe['data'](),_0x16dca1={..._0x53059b,'winnerScore':_0x3daa01,'winnerSuicides':_0x25050c,'winnerComment':_0x37bdde,'winnerDemoLink':_0x331aec,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x3131db),_0x16dca1),await deleteDoc(_0x12345d),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x52c937,_0x387f7e]=await Promise['all']([getDocs(query(collection(db,_0x4cfd6d(0xc8)),where('username','==',_0x53059b['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x53059b['loserUsername'])))]);if(_0x52c937['empty']||_0x387f7e['empty'])throw new Error(_0x4cfd6d(0xbc));const _0x57ab28=_0x52c937['docs'][0x0]['id'],_0x20344b=_0x387f7e['docs'][0x0]['id'];await updateEloRatings(_0x57ab28,_0x20344b,_0x3131db);try{const _0xccb4d2=_0x53059b['subgameType']||'Standard',_0x2f74e8=POINTS_CHART[_0xccb4d2]||0xa,_0x3ffd62=doc(db,'userProfiles',_0x57ab28),_0x3ea1c6=doc(db,'userProfiles',_0x20344b),[_0x877a70,_0x5038f1]=await Promise[_0x4cfd6d(0xdd)]([getDoc(_0x3ffd62),getDoc(_0x3ea1c6)]);if(_0x877a70['exists']()&&_0x5038f1[_0x4cfd6d(0xd5)]()){const _0x149234=_0x877a70[_0x4cfd6d(0xc0)](),_0x150716=_0x5038f1[_0x4cfd6d(0xc0)](),_0xe6f7b1=_0x149234['points']||0x0,_0x515a79=_0x150716['points']||0x0,_0x215d99=_0xe6f7b1+_0x2f74e8,_0x52c528=_0x515a79+_0x2f74e8;await Promise[_0x4cfd6d(0xdd)]([updateDoc(_0x3ffd62,{'points':_0x215d99,'lastPointsModified':serverTimestamp()}),updateDoc(_0x3ea1c6,{'points':_0x52c528,'lastPointsModified':serverTimestamp()})]),await Promise[_0x4cfd6d(0xdd)]([addDoc(collection(db,'pointsHistory'),{'userId':_0x57ab28,'userEmail':_0x149234['email']||'unknown','displayName':_0x149234[_0x4cfd6d(0xbd)]||_0x149234['username']||'Unknown\x20User','action':'add','amount':_0x2f74e8,'previousPoints':_0xe6f7b1,'newPoints':_0x215d99,'reason':_0x4cfd6d(0xc4)+_0xccb4d2+_0x4cfd6d(0xd3),'adminEmail':_0x4cfd6d(0xbe),'timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x20344b,'userEmail':_0x150716[_0x4cfd6d(0xbf)]||_0x4cfd6d(0xc1),'displayName':_0x150716['displayName']||_0x150716['username']||'Unknown\x20User','action':'add','amount':_0x2f74e8,'previousPoints':_0x515a79,'newPoints':_0x52c528,'reason':'Match\x20points:\x20'+_0xccb4d2+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log']('Awarded\x20'+_0x2f74e8+'\x20points\x20to\x20both\x20players\x20for\x20'+_0xccb4d2+_0x4cfd6d(0xb8));}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x2cfd17){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x2cfd17);}return console[_0x4cfd6d(0xb9)]('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x27225f){console['error']('Error\x20approving\x20report:',_0x27225f);throw _0x27225f;}}async function updatePlayerElo(_0x5693c1,_0x597c8e,_0x5b9848){const _0x471320=a28_0x2f2b,_0x2db638=doc(db,_0x471320(0xc8),_0x5693c1),_0x58a3fe=await getDoc(_0x2db638),_0xab582e=_0x58a3fe['data'](),_0x375a90=doc(db,'playerStats',_0x5693c1),_0x5c51c5=await getDoc(_0x375a90),_0x149d61=_0x5c51c5['data']()||{'totalMatches':0x0,'winRate':0x0},_0xbcbdcb=getRankStyle(_0x5b9848,_0x149d61['totalMatches'],_0x149d61['winRate']);await updateDoc(_0x2db638,{'eloRating':_0x5b9848,'rank':_0xbcbdcb['name'],'rankColor':_0xbcbdcb['color']}),await checkAndRecordPromotion(_0x5693c1,_0x5b9848,_0x597c8e,{'matchCount':_0x149d61['totalMatches'],'winRate':_0x149d61[_0x471320(0xc2)]});}async function updatePlayerStats(_0x4aab7e,_0x2316ae,_0x4d64b4){const _0x36391e=a28_0x2f2b,_0x62c977=doc(db,'playerStats',_0x4aab7e),_0x3a645d=await getDoc(_0x62c977);let _0x401284=_0x3a645d['exists']()?_0x3a645d['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x4d64b4?(_0x401284['wins']++,_0x401284['totalKills']+=parseInt(_0x2316ae['winnerScore']||0x0),_0x401284['totalDeaths']+=parseInt(_0x2316ae[_0x36391e(0xd8)]||0x0)):(_0x401284['losses']++,_0x401284[_0x36391e(0xb7)]+=parseInt(_0x2316ae['loserScore']||0x0),_0x401284['totalDeaths']+=parseInt(_0x2316ae[_0x36391e(0xe1)]||0x0));const _0x4e9732=_0x401284[_0x36391e(0xcc)]+_0x401284[_0x36391e(0xd0)];_0x401284['winRate']=_0x4e9732>0x0?(_0x401284['wins']/_0x4e9732*0x64)[_0x36391e(0xc5)](0x1):0x0,_0x401284[_0x36391e(0xcb)]=new Date()['toISOString'](),await setDoc(_0x62c977,_0x401284,{'merge':!![]});}