const a27_0x502636=(function(){let _0x2f9ccc=!![];return function(_0x82208a,_0x16a0a){const _0x22d576=_0x2f9ccc?function(){if(_0x16a0a){const _0x42a112=_0x16a0a['apply'](_0x82208a,arguments);return _0x16a0a=null,_0x42a112;}}:function(){};return _0x2f9ccc=![],_0x22d576;};}()),a27_0x5401ce=a27_0x502636(this,function(){const _0x132c3d=a27_0x2bfd,_0x2aff38=function(){const _0x589260=a27_0x2bfd;let _0x536a1b;try{_0x536a1b=Function(_0x589260(0x80)+_0x589260(0x7e)+');')();}catch(_0xd64797){_0x536a1b=window;}return _0x536a1b;},_0x2c423a=_0x2aff38(),_0x2d3106=_0x2c423a[_0x132c3d(0x7c)]=_0x2c423a['console']||{},_0x2da4db=[_0x132c3d(0x70),'warn',_0x132c3d(0x72),'error',_0x132c3d(0x79),'table','trace'];for(let _0xc74d7e=0x0;_0xc74d7e<_0x2da4db['length'];_0xc74d7e++){const _0x376978=a27_0x502636['constructor'][_0x132c3d(0x7b)][_0x132c3d(0x73)](a27_0x502636),_0x451ce7=_0x2da4db[_0xc74d7e],_0x9ccff2=_0x2d3106[_0x451ce7]||_0x376978;_0x376978['__proto__']=a27_0x502636['bind'](a27_0x502636),_0x376978[_0x132c3d(0x89)]=_0x9ccff2[_0x132c3d(0x89)]['bind'](_0x9ccff2),_0x2d3106[_0x451ce7]=_0x376978;}});a27_0x5401ce();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a27_0x1421(){const _0x414290=['log','pow','info','bind','docs','D3\x20Match\x20moved\x20to\x20approved\x20collection','playersD3','username','all','exception','error','prototype','console','data','{}.constructor(\x22return\x20this\x22)(\x20)','createdAt','return\x20(function()\x20','position','round','eloRating','Error\x20in\x20updateEloRatingsD3:','uid','exists','loserUsername','currentUser','toString'];a27_0x1421=function(){return _0x414290;};return a27_0x1421();}import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x2e937e,_0x5c653a,_0x445386=0x20){const _0x1836ac=a27_0x2bfd,_0x2d7f67=0x1/(0x1+Math['pow'](0xa,(_0x5c653a-_0x2e937e)/0x190)),_0x4544ca=0x1/(0x1+Math[_0x1836ac(0x71)](0xa,(_0x2e937e-_0x5c653a)/0x190)),_0x2a2794=_0x2e937e+_0x445386*(0x1-_0x2d7f67),_0x830a4b=_0x5c653a+_0x445386*(0x0-_0x4544ca);return{'newWinnerRating':Math['round'](_0x2a2794),'newLoserRating':Math[_0x1836ac(0x82)](_0x830a4b)};}function a27_0x2bfd(_0x2fbb41,_0x5f0000){const _0x5401ce=a27_0x1421();return a27_0x2bfd=function(_0x502636,_0x5e03b6){_0x502636=_0x502636-0x70;let _0x142131=_0x5401ce[_0x502636];return _0x142131;},a27_0x2bfd(_0x2fbb41,_0x5f0000);}export async function updateEloRatingsD3(_0x4064c8,_0x2b42ba,_0x55680a){const _0x3622c9=a27_0x2bfd;try{const _0x424321=writeBatch(db),_0x3d1956=doc(db,'playersD3',_0x4064c8),_0x56d40c=doc(db,'playersD3',_0x2b42ba),[_0x1324d3,_0x1b787a]=await Promise[_0x3622c9(0x78)]([getDoc(_0x3d1956),getDoc(_0x56d40c)]);if(!_0x1324d3['exists']()||!_0x1b787a['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x12b5e4=_0x1324d3[_0x3622c9(0x7d)](),_0x33c580=_0x1b787a['data'](),_0xc72daf=_0x12b5e4[_0x3622c9(0x81)]||Number['MAX_SAFE_INTEGER'],_0x1ac147=_0x33c580[_0x3622c9(0x81)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x3a0169,newLoserRating:_0x39b874}=calculateEloD3(_0x12b5e4['eloRating']||0x4b0,_0x33c580['eloRating']||0x4b0);let _0x10bc31=_0xc72daf,_0xa547e3=_0x1ac147;if(_0xc72daf>_0x1ac147){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x10bc31=_0x1ac147,_0xa547e3=_0x1ac147+0x1;const _0x20a7f9=query(collection(db,'playersD3'),where('position','>',_0x1ac147),where('position','<',_0xc72daf)),_0x348950=await getDocs(_0x20a7f9);for(const _0x5da59b of _0x348950['docs']){_0x5da59b['id']!==_0x4064c8&&_0x5da59b['id']!==_0x2b42ba&&_0x424321['update'](doc(db,'playersD3',_0x5da59b['id']),{'position':_0x5da59b['data']()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x424321['update'](_0x3d1956,{'eloRating':_0x3a0169,'lastMatchDate':serverTimestamp(),'position':_0x10bc31,'lastMatchId':_0x55680a}),_0x424321['update'](_0x56d40c,{'eloRating':_0x39b874,'lastMatchDate':serverTimestamp(),'position':_0xa547e3,'lastMatchId':_0x55680a}),await _0x424321['commit'](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x3622c9(0x78)]([recordEloChangeD3({'playerId':_0x4064c8,'previousElo':_0x12b5e4['eloRating']||0x4b0,'newElo':_0x3a0169,'opponentId':_0x2b42ba,'matchResult':'win','previousPosition':_0xc72daf,'newPosition':_0x10bc31,'isPromotion':_0x10bc31<_0xc72daf,'matchId':_0x55680a,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x2b42ba,'previousElo':_0x33c580[_0x3622c9(0x83)]||0x4b0,'newElo':_0x39b874,'opponentId':_0x4064c8,'matchResult':'loss','previousPosition':_0x1ac147,'newPosition':_0xa547e3,'isDemotion':_0xa547e3>_0x1ac147,'matchId':_0x55680a,'timestamp':serverTimestamp()})]),!![];}catch(_0x2b28a7){console[_0x3622c9(0x7a)](_0x3622c9(0x84),_0x2b28a7);throw _0x2b28a7;}}export async function approveReportD3(_0x167573,_0x159ee1,_0x10007f,_0x324a61){const _0x140293=a27_0x2bfd;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x167573,'winnerScore':_0x159ee1,'winnerSuicides':_0x10007f,'winnerComment':_0x324a61});const _0x4d335f=auth[_0x140293(0x88)];if(!_0x4d335f){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x4d335f['email']);const _0x1e77f2=await getDoc(doc(db,'playersD3',_0x4d335f[_0x140293(0x85)])),_0x1efd35=_0x1e77f2[_0x140293(0x86)]()?_0x1e77f2[_0x140293(0x7d)]()[_0x140293(0x77)]:null;console['log']('Current\x20username:',_0x1efd35);const _0x1002fe=doc(db,'pendingMatchesD3',_0x167573),_0x16ec8f=await getDoc(_0x1002fe);if(!_0x16ec8f[_0x140293(0x86)]()){console[_0x140293(0x70)]('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x167573);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x5cfbf8=_0x16ec8f['data']();console['log']('D3\x20Report\x20data:',_0x5cfbf8);if(_0x1efd35!==_0x5cfbf8['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x21a4be={..._0x5cfbf8,'winnerScore':_0x159ee1,'winnerSuicides':_0x10007f,'winnerComment':_0x324a61,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1efd35,'createdAt':_0x5cfbf8[_0x140293(0x7f)]||serverTimestamp(),'winnerUsername':_0x5cfbf8['winnerUsername'],'loserUsername':_0x5cfbf8[_0x140293(0x87)]};await setDoc(doc(db,'approvedMatchesD3',_0x167573),_0x21a4be),await deleteDoc(_0x1002fe),console['log'](_0x140293(0x75));const [_0x4927c3,_0x30a168]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x5cfbf8['winnerUsername']))),getDocs(query(collection(db,_0x140293(0x76)),where('username','==',_0x5cfbf8[_0x140293(0x87)])))]);if(_0x4927c3['empty']||_0x30a168['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x5b52c4=_0x4927c3['docs'][0x0]['id'],_0x48d84e=_0x30a168[_0x140293(0x74)][0x0]['id'];return await updateEloRatingsD3(_0x5b52c4,_0x48d84e,_0x167573),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x5ae928){console[_0x140293(0x7a)]('Error\x20in\x20approveReportD3:',_0x5ae928);throw _0x5ae928;}}