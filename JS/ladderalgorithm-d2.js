const a28_0x4b8ad4=(function(){let _0x197674=!![];return function(_0x5037d3,_0x1f8160){const _0x1587ba=_0x197674?function(){if(_0x1f8160){const _0x12516b=_0x1f8160['apply'](_0x5037d3,arguments);return _0x1f8160=null,_0x12516b;}}:function(){};return _0x197674=![],_0x1587ba;};}()),a28_0x249d9e=a28_0x4b8ad4(this,function(){const _0x26a23b=a28_0x1a79;let _0x50a8bd;try{const _0x4bfd0a=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x50a8bd=_0x4bfd0a();}catch(_0x5e00ed){_0x50a8bd=window;}const _0x181121=_0x50a8bd['console']=_0x50a8bd['console']||{},_0x4e59ea=['log','warn','info','error','exception','table','trace'];for(let _0x32fac8=0x0;_0x32fac8<_0x4e59ea[_0x26a23b(0x185)];_0x32fac8++){const _0x2d1bf6=a28_0x4b8ad4['constructor']['prototype']['bind'](a28_0x4b8ad4),_0x18d97b=_0x4e59ea[_0x32fac8],_0x2dd9f1=_0x181121[_0x18d97b]||_0x2d1bf6;_0x2d1bf6['__proto__']=a28_0x4b8ad4['bind'](a28_0x4b8ad4),_0x2d1bf6['toString']=_0x2dd9f1['toString']['bind'](_0x2dd9f1),_0x181121[_0x18d97b]=_0x2d1bf6;}});a28_0x249d9e();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x2e3b18 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x4ce56d,_0x25e6b0,_0x3fc22b=0x20){const _0x29754e=a28_0x1a79,_0x312718=0x1/(0x1+Math[_0x29754e(0x18f)](0xa,(_0x25e6b0-_0x4ce56d)/0x190)),_0x5d4a62=0x1/(0x1+Math[_0x29754e(0x18f)](0xa,(_0x4ce56d-_0x25e6b0)/0x190)),_0x1c7cbe=_0x4ce56d+_0x3fc22b*(0x1-_0x312718),_0x26b430=_0x25e6b0+_0x3fc22b*(0x0-_0x5d4a62);return{'newWinnerRating':Math[_0x29754e(0x19a)](_0x1c7cbe),'newLoserRating':Math['round'](_0x26b430)};}export async function updateEloRatingsD2(_0x33731f,_0x3472d9,_0x1c03d5){const _0x36c906=a28_0x1a79;try{const _0x3b0aec=writeBatch(db),_0x46aa1c=doc(db,_0x36c906(0x184),_0x33731f),_0x588eb1=doc(db,'playersD2',_0x3472d9),[_0x52ca1b,_0x38bd85]=await Promise['all']([getDoc(_0x46aa1c),getDoc(_0x588eb1)]);if(!_0x52ca1b['exists']()||!_0x38bd85['exists']())throw new Error(_0x36c906(0x191));const _0x5b7ba0=_0x52ca1b['data'](),_0xb3aa4a=_0x38bd85['data'](),_0x5ce014=_0x5b7ba0[_0x36c906(0x188)]||Number['MAX_SAFE_INTEGER'],_0x31643c=_0xb3aa4a[_0x36c906(0x188)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x39659e,newLoserRating:_0x5b08d4}=calculateEloD2(_0x5b7ba0[_0x36c906(0x192)]||0x4b0,_0xb3aa4a['eloRating']||0x4b0);let _0x3eb194=_0x5ce014,_0x2bb3cd=_0x31643c;if(_0x5ce014>_0x31643c){console[_0x36c906(0x18e)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x3eb194=_0x31643c,_0x2bb3cd=_0x31643c+0x1;const _0x1d696c=query(collection(db,'playersD2'),where('position','>',_0x31643c),where('position','<',_0x5ce014)),_0x4e0d92=await getDocs(_0x1d696c);for(const _0x4f61b8 of _0x4e0d92['docs']){_0x4f61b8['id']!==_0x33731f&&_0x4f61b8['id']!==_0x3472d9&&_0x3b0aec['update'](doc(db,'playersD2',_0x4f61b8['id']),{'position':_0x4f61b8['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x3b0aec['update'](_0x46aa1c,{'eloRating':_0x39659e,'lastMatchDate':serverTimestamp(),'position':_0x3eb194,'lastMatchId':_0x1c03d5}),_0x3b0aec['update'](_0x588eb1,{'eloRating':_0x5b08d4,'lastMatchDate':serverTimestamp(),'position':_0x2bb3cd,'lastMatchId':_0x1c03d5}),await _0x3b0aec[_0x36c906(0x197)](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x36c906(0x196)]([recordEloChangeD2({'playerId':_0x33731f,'previousElo':_0x5b7ba0['eloRating']||0x4b0,'newElo':_0x39659e,'opponentId':_0x3472d9,'matchResult':'win','previousPosition':_0x5ce014,'newPosition':_0x3eb194,'isPromotion':_0x3eb194<_0x5ce014,'matchId':_0x1c03d5,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x3472d9,'previousElo':_0xb3aa4a[_0x36c906(0x192)]||0x4b0,'newElo':_0x5b08d4,'opponentId':_0x33731f,'matchResult':_0x36c906(0x198),'previousPosition':_0x31643c,'newPosition':_0x2bb3cd,'isDemotion':_0x2bb3cd>_0x31643c,'matchId':_0x1c03d5,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x33731f,_0x39659e,_0x5b7ba0[_0x36c906(0x192)],{'source':_0x36c906(0x18a),'matchId':_0x1c03d5}),await promotionManager['checkAndRecordPromotion'](_0x3472d9,_0x5b08d4,_0xb3aa4a['eloRating'],{'source':'match-d2','matchId':_0x1c03d5}),!![];}catch(_0x9b132f){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x9b132f);throw _0x9b132f;}}function a28_0x5f22(){const _0x4d7670=['playersD2','length','empty','approvedMatchesD2','position','exists','match-d2','loserUsername','winnerUsername','createdAt','log','pow','No\x20user\x20logged\x20in','One\x20or\x20both\x20D2\x20players\x20not\x20found','eloRating','docs','currentUser','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','all','commit','loss','D2\x20Report\x20data:','round','Could\x20not\x20find\x20D2\x20player\x20documents'];a28_0x5f22=function(){return _0x4d7670;};return a28_0x5f22();}function a28_0x1a79(_0x154b63,_0x34210c){const _0x249d9e=a28_0x5f22();return a28_0x1a79=function(_0x4b8ad4,_0x202f37){_0x4b8ad4=_0x4b8ad4-0x184;let _0x5f22ca=_0x249d9e[_0x4b8ad4];return _0x5f22ca;},a28_0x1a79(_0x154b63,_0x34210c);}export async function approveReportD2(_0x2582ce,_0x55a786,_0x12b34e,_0x2fd43e){const _0x1dc355=a28_0x1a79;try{console[_0x1dc355(0x18e)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x2582ce,'winnerScore':_0x55a786,'winnerSuicides':_0x12b34e,'winnerComment':_0x2fd43e});const _0xedeb63=auth[_0x1dc355(0x194)];if(!_0xedeb63){console['log'](_0x1dc355(0x190));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console[_0x1dc355(0x18e)]('Current\x20user:',_0xedeb63['email']);const _0xdc65d=await getDoc(doc(db,'playersD2',_0xedeb63['uid'])),_0x26aeb4=_0xdc65d[_0x1dc355(0x189)]()?_0xdc65d['data']()['username']:null;console['log']('Current\x20username:',_0x26aeb4);const _0x264aa1=doc(db,'pendingMatchesD2',_0x2582ce),_0x55d349=await getDoc(_0x264aa1);if(!_0x55d349['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x2582ce);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0xc0fda4=_0x55d349['data']();console[_0x1dc355(0x18e)](_0x1dc355(0x199),_0xc0fda4);if(_0x26aeb4!==_0xc0fda4[_0x1dc355(0x18c)])throw new Error(_0x1dc355(0x195));const _0x1e3236={..._0xc0fda4,'winnerScore':_0x55a786,'winnerSuicides':_0x12b34e,'winnerComment':_0x2fd43e,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x26aeb4,'createdAt':_0xc0fda4[_0x1dc355(0x18d)]||serverTimestamp(),'winnerUsername':_0xc0fda4['winnerUsername'],'loserUsername':_0xc0fda4['loserUsername']};await setDoc(doc(db,_0x1dc355(0x187),_0x2582ce),_0x1e3236),await deleteDoc(_0x264aa1),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0xf993ea,_0x3f730c]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0xc0fda4[_0x1dc355(0x18c)]))),getDocs(query(collection(db,'playersD2'),where('username','==',_0xc0fda4[_0x1dc355(0x18b)])))]);if(_0xf993ea['empty']||_0x3f730c[_0x1dc355(0x186)])throw new Error(_0x1dc355(0x19b));const _0x28dab5=_0xf993ea['docs'][0x0]['id'],_0x5a2086=_0x3f730c[_0x1dc355(0x193)][0x0]['id'];return await updateEloRatingsD2(_0x28dab5,_0x5a2086,_0x2582ce),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0xb91c08){console['error']('Error\x20in\x20approveReportD2:',_0xb91c08);throw _0xb91c08;}}