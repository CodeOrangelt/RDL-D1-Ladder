const a28_0x4da0d1=(function(){let _0x3fe54b=!![];return function(_0x87a0d9,_0x249926){const _0x2553de=_0x3fe54b?function(){const _0x34b45a=a28_0x5cd0;if(_0x249926){const _0x4906da=_0x249926[_0x34b45a(0xaf)](_0x87a0d9,arguments);return _0x249926=null,_0x4906da;}}:function(){};return _0x3fe54b=![],_0x2553de;};}()),a28_0x394b38=a28_0x4da0d1(this,function(){const _0x2e802a=a28_0x5cd0,_0x4687a5=function(){const _0x15c9ff=a28_0x5cd0;let _0x5cd2d2;try{_0x5cd2d2=Function(_0x15c9ff(0xb9)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x59c0a9){_0x5cd2d2=window;}return _0x5cd2d2;},_0x3df537=_0x4687a5(),_0x14b5be=_0x3df537['console']=_0x3df537['console']||{},_0x4cc83a=['log','warn','info','error',_0x2e802a(0xb3),_0x2e802a(0xba),'trace'];for(let _0x311649=0x0;_0x311649<_0x4cc83a['length'];_0x311649++){const _0x15ae13=a28_0x4da0d1['constructor'][_0x2e802a(0xad)][_0x2e802a(0xbc)](a28_0x4da0d1),_0x5bfc71=_0x4cc83a[_0x311649],_0x1cb4ee=_0x14b5be[_0x5bfc71]||_0x15ae13;_0x15ae13[_0x2e802a(0xb4)]=a28_0x4da0d1['bind'](a28_0x4da0d1),_0x15ae13['toString']=_0x1cb4ee['toString']['bind'](_0x1cb4ee),_0x14b5be[_0x5bfc71]=_0x15ae13;}});a28_0x394b38();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a28_0x5cd0(_0x4473a7,_0x33d38c){const _0x394b38=a28_0x1096();return a28_0x5cd0=function(_0x4da0d1,_0x416207){_0x4da0d1=_0x4da0d1-0xa7;let _0x10966e=_0x394b38[_0x4da0d1];return _0x10966e;},a28_0x5cd0(_0x4473a7,_0x33d38c);}import a28_0x3afe26 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x554bfd,_0x217611,_0x48d730=0x20){const _0xf84ede=a28_0x5cd0,_0x186b83=0x1/(0x1+Math[_0xf84ede(0xac)](0xa,(_0x217611-_0x554bfd)/0x190)),_0x4fd643=0x1/(0x1+Math['pow'](0xa,(_0x554bfd-_0x217611)/0x190)),_0x5492c2=_0x554bfd+_0x48d730*(0x1-_0x186b83),_0xfffa69=_0x217611+_0x48d730*(0x0-_0x4fd643);return{'newWinnerRating':Math['round'](_0x5492c2),'newLoserRating':Math['round'](_0xfffa69)};}export async function updateEloRatingsD2(_0x39f5f7,_0x36ef1e,_0x1fe29d){const _0x55efb5=a28_0x5cd0;try{const _0x525d0a=writeBatch(db),_0x396773=doc(db,_0x55efb5(0xb6),_0x39f5f7),_0x165db6=doc(db,_0x55efb5(0xb6),_0x36ef1e),[_0x1f7c42,_0x88384b]=await Promise['all']([getDoc(_0x396773),getDoc(_0x165db6)]);if(!_0x1f7c42['exists']()||!_0x88384b['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x1c4bf3=_0x1f7c42[_0x55efb5(0xb1)](),_0xd91f00=_0x88384b['data'](),_0x3d809e=_0x1c4bf3['position']||Number[_0x55efb5(0xb5)],_0xf4551c=_0xd91f00[_0x55efb5(0xab)]||Number[_0x55efb5(0xb5)],{newWinnerRating:_0x2cb8c6,newLoserRating:_0x1287c9}=calculateEloD2(_0x1c4bf3['eloRating']||0x4b0,_0xd91f00['eloRating']||0x4b0);let _0x5619fb=_0x3d809e,_0x1352f6=_0xf4551c;if(_0x3d809e>_0xf4551c){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x5619fb=_0xf4551c,_0x1352f6=_0xf4551c+0x1;const _0x1eb8d6=query(collection(db,'playersD2'),where('position','>',_0xf4551c),where('position','<',_0x3d809e)),_0x5d5a19=await getDocs(_0x1eb8d6);for(const _0x385453 of _0x5d5a19['docs']){_0x385453['id']!==_0x39f5f7&&_0x385453['id']!==_0x36ef1e&&_0x525d0a['update'](doc(db,_0x55efb5(0xb6),_0x385453['id']),{'position':_0x385453[_0x55efb5(0xb1)]()['position']+0x1});}}else console[_0x55efb5(0xa9)](_0x55efb5(0xae));return _0x525d0a['update'](_0x396773,{'eloRating':_0x2cb8c6,'lastMatchDate':serverTimestamp(),'position':_0x5619fb,'lastMatchId':_0x1fe29d}),_0x525d0a['update'](_0x165db6,{'eloRating':_0x1287c9,'lastMatchDate':serverTimestamp(),'position':_0x1352f6,'lastMatchId':_0x1fe29d}),await _0x525d0a['commit'](),console[_0x55efb5(0xa9)]('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x39f5f7,'previousElo':_0x1c4bf3['eloRating']||0x4b0,'newElo':_0x2cb8c6,'opponentId':_0x36ef1e,'matchResult':_0x55efb5(0xa8),'previousPosition':_0x3d809e,'newPosition':_0x5619fb,'isPromotion':_0x5619fb<_0x3d809e,'matchId':_0x1fe29d,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x36ef1e,'previousElo':_0xd91f00[_0x55efb5(0xbd)]||0x4b0,'newElo':_0x1287c9,'opponentId':_0x39f5f7,'matchResult':'loss','previousPosition':_0xf4551c,'newPosition':_0x1352f6,'isDemotion':_0x1352f6>_0xf4551c,'matchId':_0x1fe29d,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x39f5f7,_0x2cb8c6,_0x1c4bf3['eloRating'],{'source':'match-d2','matchId':_0x1fe29d}),await promotionManager['checkAndRecordPromotion'](_0x36ef1e,_0x1287c9,_0xd91f00['eloRating'],{'source':'match-d2','matchId':_0x1fe29d}),!![];}catch(_0x24acda){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x24acda);throw _0x24acda;}}function a28_0x1096(){const _0x2337a8=['docs','win','log','Current\x20username:','position','pow','prototype','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','apply','Starting\x20approveReportD2\x20function\x20with:','data','approvedMatchesD2','exception','__proto__','MAX_SAFE_INTEGER','playersD2','exists','D2\x20Report\x20not\x20found\x20with\x20ID:','return\x20(function()\x20','table','D2\x20Report\x20data:','bind','eloRating'];a28_0x1096=function(){return _0x2337a8;};return a28_0x1096();}export async function approveReportD2(_0x5126ab,_0x3ee380,_0x290d4f,_0x4833d1){const _0x14d5b2=a28_0x5cd0;try{console['log'](_0x14d5b2(0xb0),{'reportId':_0x5126ab,'winnerScore':_0x3ee380,'winnerSuicides':_0x290d4f,'winnerComment':_0x4833d1});const _0x461da3=auth['currentUser'];if(!_0x461da3){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x461da3['email']);const _0x959572=await getDoc(doc(db,'playersD2',_0x461da3['uid'])),_0x1a34cf=_0x959572['exists']()?_0x959572['data']()['username']:null;console['log'](_0x14d5b2(0xaa),_0x1a34cf);const _0x24628d=doc(db,'pendingMatchesD2',_0x5126ab),_0x58ce78=await getDoc(_0x24628d);if(!_0x58ce78[_0x14d5b2(0xb7)]()){console['log'](_0x14d5b2(0xb8),_0x5126ab);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x397490=_0x58ce78[_0x14d5b2(0xb1)]();console['log'](_0x14d5b2(0xbb),_0x397490);if(_0x1a34cf!==_0x397490['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x35afb1={..._0x397490,'winnerScore':_0x3ee380,'winnerSuicides':_0x290d4f,'winnerComment':_0x4833d1,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1a34cf,'createdAt':_0x397490['createdAt']||serverTimestamp(),'winnerUsername':_0x397490['winnerUsername'],'loserUsername':_0x397490['loserUsername']};await setDoc(doc(db,_0x14d5b2(0xb2),_0x5126ab),_0x35afb1),await deleteDoc(_0x24628d),console[_0x14d5b2(0xa9)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x1a1094,_0x4c3bb5]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x397490['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x397490['loserUsername'])))]);if(_0x1a1094['empty']||_0x4c3bb5['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x301405=_0x1a1094[_0x14d5b2(0xa7)][0x0]['id'],_0xe8ebf=_0x4c3bb5[_0x14d5b2(0xa7)][0x0]['id'];return await updateEloRatingsD2(_0x301405,_0xe8ebf,_0x5126ab),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x25c4ba){console['error']('Error\x20in\x20approveReportD2:',_0x25c4ba);throw _0x25c4ba;}}