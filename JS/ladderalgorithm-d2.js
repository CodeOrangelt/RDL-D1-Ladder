const a28_0x1c6339=(function(){let _0x7687fc=!![];return function(_0x2927b7,_0x326081){const _0x204963=_0x7687fc?function(){if(_0x326081){const _0x28cc05=_0x326081['apply'](_0x2927b7,arguments);return _0x326081=null,_0x28cc05;}}:function(){};return _0x7687fc=![],_0x204963;};}()),a28_0x3197c2=a28_0x1c6339(this,function(){const _0x3c4013=a28_0x3807;let _0x41273f;try{const _0x34a92f=Function(_0x3c4013(0x199)+_0x3c4013(0x1a7)+');');_0x41273f=_0x34a92f();}catch(_0x2e1ef9){_0x41273f=window;}const _0x1638bd=_0x41273f['console']=_0x41273f['console']||{},_0x343b3b=['log',_0x3c4013(0x19b),'info','error','exception',_0x3c4013(0x1a5),_0x3c4013(0x1a1)];for(let _0x445f1e=0x0;_0x445f1e<_0x343b3b['length'];_0x445f1e++){const _0x2e33b8=a28_0x1c6339['constructor']['prototype']['bind'](a28_0x1c6339),_0x35454b=_0x343b3b[_0x445f1e],_0x2f3284=_0x1638bd[_0x35454b]||_0x2e33b8;_0x2e33b8['__proto__']=a28_0x1c6339[_0x3c4013(0x1a2)](a28_0x1c6339),_0x2e33b8[_0x3c4013(0x1a0)]=_0x2f3284[_0x3c4013(0x1a0)]['bind'](_0x2f3284),_0x1638bd[_0x35454b]=_0x2e33b8;}});a28_0x3197c2();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x3807(_0x17a610,_0x2f611f){const _0x3197c2=a28_0x2dfc();return a28_0x3807=function(_0x1c6339,_0x2aebf4){_0x1c6339=_0x1c6339-0x196;let _0x2dfc27=_0x3197c2[_0x1c6339];return _0x2dfc27;},a28_0x3807(_0x17a610,_0x2f611f);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';function a28_0x2dfc(){const _0x29db7e=['playersD2','position','currentUser','return\x20(function()\x20','log','warn','Error\x20in\x20updateEloRatingsD2:','D2\x20ELO\x20ratings\x20updated\x20successfully','winnerUsername','exists','toString','trace','bind','D2\x20match\x20report\x20not\x20found','pow','table','Could\x20not\x20find\x20D2\x20player\x20documents','{}.constructor(\x22return\x20this\x22)(\x20)','all','checkAndRecordPromotion','match-d2','D2\x20Report\x20data:','data','docs'];a28_0x2dfc=function(){return _0x29db7e;};return a28_0x2dfc();}import{promotionManager}from'./promotions.js';import a28_0x5ad409 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x568508,_0x456c24,_0x5e79bb=0x20){const _0x2b4fed=a28_0x3807,_0x708779=0x1/(0x1+Math[_0x2b4fed(0x1a4)](0xa,(_0x456c24-_0x568508)/0x190)),_0x550379=0x1/(0x1+Math['pow'](0xa,(_0x568508-_0x456c24)/0x190)),_0x570a18=_0x568508+_0x5e79bb*(0x1-_0x708779),_0x1fb8a7=_0x456c24+_0x5e79bb*(0x0-_0x550379);return{'newWinnerRating':Math['round'](_0x570a18),'newLoserRating':Math['round'](_0x1fb8a7)};}export async function updateEloRatingsD2(_0x19868f,_0x40bbc5,_0x293c38){const _0x4c9fec=a28_0x3807;try{const _0x143385=writeBatch(db),_0xfae503=doc(db,_0x4c9fec(0x196),_0x19868f),_0x1d642b=doc(db,'playersD2',_0x40bbc5),[_0x3fc0ba,_0x15df82]=await Promise[_0x4c9fec(0x1a8)]([getDoc(_0xfae503),getDoc(_0x1d642b)]);if(!_0x3fc0ba['exists']()||!_0x15df82['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x2f64c5=_0x3fc0ba[_0x4c9fec(0x1ac)](),_0x1a20d5=_0x15df82[_0x4c9fec(0x1ac)](),_0xf93c94=_0x2f64c5[_0x4c9fec(0x197)]||Number['MAX_SAFE_INTEGER'],_0x4ca74a=_0x1a20d5['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x2d8d86,newLoserRating:_0x27e050}=calculateEloD2(_0x2f64c5['eloRating']||0x4b0,_0x1a20d5['eloRating']||0x4b0);let _0x1b459b=_0xf93c94,_0x224fac=_0x4ca74a;if(_0xf93c94>_0x4ca74a){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x1b459b=_0x4ca74a,_0x224fac=_0x4ca74a+0x1;const _0x52393c=query(collection(db,'playersD2'),where('position','>',_0x4ca74a),where('position','<',_0xf93c94)),_0x414560=await getDocs(_0x52393c);for(const _0x5c6118 of _0x414560['docs']){_0x5c6118['id']!==_0x19868f&&_0x5c6118['id']!==_0x40bbc5&&_0x143385['update'](doc(db,'playersD2',_0x5c6118['id']),{'position':_0x5c6118[_0x4c9fec(0x1ac)]()[_0x4c9fec(0x197)]+0x1});}}else console[_0x4c9fec(0x19a)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x143385['update'](_0xfae503,{'eloRating':_0x2d8d86,'lastMatchDate':serverTimestamp(),'position':_0x1b459b,'lastMatchId':_0x293c38}),_0x143385['update'](_0x1d642b,{'eloRating':_0x27e050,'lastMatchDate':serverTimestamp(),'position':_0x224fac,'lastMatchId':_0x293c38}),await _0x143385['commit'](),console['log'](_0x4c9fec(0x19d)),await Promise['all']([recordEloChangeD2({'playerId':_0x19868f,'previousElo':_0x2f64c5['eloRating']||0x4b0,'newElo':_0x2d8d86,'opponentId':_0x40bbc5,'matchResult':'win','previousPosition':_0xf93c94,'newPosition':_0x1b459b,'isPromotion':_0x1b459b<_0xf93c94,'matchId':_0x293c38,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x40bbc5,'previousElo':_0x1a20d5['eloRating']||0x4b0,'newElo':_0x27e050,'opponentId':_0x19868f,'matchResult':'loss','previousPosition':_0x4ca74a,'newPosition':_0x224fac,'isDemotion':_0x224fac>_0x4ca74a,'matchId':_0x293c38,'timestamp':serverTimestamp()})]),await promotionManager[_0x4c9fec(0x1a9)](_0x19868f,_0x2d8d86,_0x2f64c5['eloRating'],{'source':'match-d2','matchId':_0x293c38}),await promotionManager['checkAndRecordPromotion'](_0x40bbc5,_0x27e050,_0x1a20d5['eloRating'],{'source':_0x4c9fec(0x1aa),'matchId':_0x293c38}),!![];}catch(_0x3fb983){console['error'](_0x4c9fec(0x19c),_0x3fb983);throw _0x3fb983;}}export async function approveReportD2(_0x6eb430,_0x2d02ec,_0x4bc62a,_0x52e238){const _0x1ea323=a28_0x3807;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x6eb430,'winnerScore':_0x2d02ec,'winnerSuicides':_0x4bc62a,'winnerComment':_0x52e238});const _0x10054e=auth[_0x1ea323(0x198)];if(!_0x10054e){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x10054e['email']);const _0x187248=await getDoc(doc(db,_0x1ea323(0x196),_0x10054e['uid'])),_0x3be896=_0x187248['exists']()?_0x187248[_0x1ea323(0x1ac)]()['username']:null;console['log']('Current\x20username:',_0x3be896);const _0x546e78=doc(db,'pendingMatchesD2',_0x6eb430),_0x6ed1c4=await getDoc(_0x546e78);if(!_0x6ed1c4[_0x1ea323(0x19f)]()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x6eb430);throw new Error(_0x1ea323(0x1a3));}const _0x19c76c=_0x6ed1c4['data']();console['log'](_0x1ea323(0x1ab),_0x19c76c);if(_0x3be896!==_0x19c76c[_0x1ea323(0x19e)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x47da74={..._0x19c76c,'winnerScore':_0x2d02ec,'winnerSuicides':_0x4bc62a,'winnerComment':_0x52e238,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x3be896,'createdAt':_0x19c76c['createdAt']||serverTimestamp(),'winnerUsername':_0x19c76c['winnerUsername'],'loserUsername':_0x19c76c['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x6eb430),_0x47da74),await deleteDoc(_0x546e78),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x217d0c,_0xf62878]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x19c76c['winnerUsername']))),getDocs(query(collection(db,_0x1ea323(0x196)),where('username','==',_0x19c76c['loserUsername'])))]);if(_0x217d0c['empty']||_0xf62878['empty'])throw new Error(_0x1ea323(0x1a6));const _0x38b8a0=_0x217d0c['docs'][0x0]['id'],_0x40d7c1=_0xf62878[_0x1ea323(0x1ad)][0x0]['id'];return await updateEloRatingsD2(_0x38b8a0,_0x40d7c1,_0x6eb430),console[_0x1ea323(0x19a)]('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3f10a2){console['error']('Error\x20in\x20approveReportD2:',_0x3f10a2);throw _0x3f10a2;}}