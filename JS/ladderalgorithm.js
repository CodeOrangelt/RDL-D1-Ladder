const a30_0x15a950=(function(){let _0x2f9848=!![];return function(_0x2bf2c5,_0x53215a){const _0x20e9cf=_0x2f9848?function(){if(_0x53215a){const _0x3af641=_0x53215a['apply'](_0x2bf2c5,arguments);return _0x53215a=null,_0x3af641;}}:function(){};return _0x2f9848=![],_0x20e9cf;};}()),a30_0x31b92c=a30_0x15a950(this,function(){const _0x2499ab=a30_0x4258,_0x4249e4=function(){const _0x35a5fa=a30_0x4258;let _0x409e82;try{_0x409e82=Function(_0x35a5fa(0xc4)+_0x35a5fa(0xb2)+');')();}catch(_0x3ddf63){_0x409e82=window;}return _0x409e82;},_0xca9c37=_0x4249e4(),_0x3fc10c=_0xca9c37['console']=_0xca9c37[_0x2499ab(0xc8)]||{},_0x23b03f=['log','warn',_0x2499ab(0xbb),'error','exception','table','trace'];for(let _0x28a25c=0x0;_0x28a25c<_0x23b03f[_0x2499ab(0xc1)];_0x28a25c++){const _0x330728=a30_0x15a950['constructor']['prototype']['bind'](a30_0x15a950),_0x37c72a=_0x23b03f[_0x28a25c],_0x14a1b4=_0x3fc10c[_0x37c72a]||_0x330728;_0x330728['__proto__']=a30_0x15a950[_0x2499ab(0xb6)](a30_0x15a950),_0x330728['toString']=_0x14a1b4['toString']['bind'](_0x14a1b4),_0x3fc10c[_0x37c72a]=_0x330728;}});a30_0x31b92c();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a30_0x4258(_0x3b3458,_0x1d35ad){const _0x31b92c=a30_0x1248();return a30_0x4258=function(_0x15a950,_0x3af444){_0x15a950=_0x15a950-0xb1;let _0x124878=_0x31b92c[_0x15a950];return _0x124878;},a30_0x4258(_0x3b3458,_0x1d35ad);}import{recordEloChange}from'./elo-history.js';function a30_0x1248(){const _0x1574f1=['update','{}.constructor(\x22return\x20this\x22)(\x20)','ELO\x20ratings\x20updated\x20successfully','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','losses','bind','approvedMatches','docs','match','then','info','checkAndRecordPromotion','MAX_SAFE_INTEGER','exists','round','Could\x20not\x20find\x20player\x20documents','length','toFixed','doc','return\x20(function()\x20','pow','eloRating','log','console','position','winnerScore','players','toISOString','username','Error\x20in\x20updateEloRatings:','all'];a30_0x1248=function(){return _0x1574f1;};return a30_0x1248();}import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x33275a,_0x38b466,_0x360276=0x20){const _0x350231=a30_0x4258,_0x309ed2=0x1/(0x1+Math[_0x350231(0xc5)](0xa,(_0x38b466-_0x33275a)/0x190)),_0x1b5363=0x1/(0x1+Math['pow'](0xa,(_0x33275a-_0x38b466)/0x190)),_0x386a86=_0x33275a+_0x360276*(0x1-_0x309ed2),_0xbb4466=_0x38b466+_0x360276*(0x0-_0x1b5363);return{'newWinnerRating':Math[_0x350231(0xbf)](_0x386a86),'newLoserRating':Math['round'](_0xbb4466)};}export function assignDefaultEloRating(_0x38c2b9,_0x38bf49){const _0x5041cb=a30_0x4258,_0x38bab7=0x4b0;!_0x38bf49[_0x5041cb(0xc6)]&&db['collection']('players')[_0x5041cb(0xc3)](_0x38c2b9)['update']({'eloRating':_0x38bab7})[_0x5041cb(0xba)](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x38bf49['username']);})['catch'](_0x517e93=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x517e93);});}export async function updateEloRatings(_0x50c046,_0x4e2594,_0x43345d){const _0x5f0509=a30_0x4258;try{const _0x1edd41=writeBatch(db),_0x2cbccd=doc(db,'players',_0x50c046),_0x36250d=doc(db,_0x5f0509(0xcb),_0x4e2594),[_0x10d439,_0x3a27e3]=await Promise[_0x5f0509(0xcf)]([getDoc(_0x2cbccd),getDoc(_0x36250d)]);if(!_0x10d439[_0x5f0509(0xbe)]()||!_0x3a27e3['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x7c3e35=_0x10d439['data'](),_0x3adbae=_0x3a27e3['data'](),_0x504429=_0x7c3e35[_0x5f0509(0xc9)]||Number[_0x5f0509(0xbd)],_0x5cf86b=_0x3adbae[_0x5f0509(0xc9)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x57ac66,newLoserRating:_0x40bf33}=calculateElo(_0x7c3e35['eloRating']||0x4b0,_0x3adbae[_0x5f0509(0xc6)]||0x4b0);let _0x5213fb=_0x504429,_0x14da70=_0x5cf86b;if(_0x504429>_0x5cf86b){console[_0x5f0509(0xc7)]('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x5213fb=_0x5cf86b,_0x14da70=_0x5cf86b+0x1;const _0x4c126e=query(collection(db,'players'),where('position','>',_0x5cf86b),where(_0x5f0509(0xc9),'<',_0x504429)),_0x5de34d=await getDocs(_0x4c126e);for(const _0x4119fb of _0x5de34d[_0x5f0509(0xb8)]){_0x4119fb['id']!==_0x50c046&&_0x4119fb['id']!==_0x4e2594&&_0x1edd41['update'](doc(db,'players',_0x4119fb['id']),{'position':_0x4119fb['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x21bfa1={'eloRating':_0x57ac66,'lastMatchDate':serverTimestamp(),'position':_0x5213fb,'lastMatchId':_0x43345d},_0x14ee65={'eloRating':_0x40bf33,'lastMatchDate':serverTimestamp(),'position':_0x14da70,'lastMatchId':_0x43345d};return _0x1edd41[_0x5f0509(0xb1)](_0x2cbccd,_0x21bfa1),_0x1edd41['update'](_0x36250d,_0x14ee65),await _0x1edd41['commit'](),console['log'](_0x5f0509(0xb3)),await Promise['all']([recordEloChange({'playerId':_0x50c046,'previousElo':_0x7c3e35['eloRating']||0x4b0,'newElo':_0x57ac66,'opponentId':_0x4e2594,'matchResult':'win','previousPosition':_0x504429,'newPosition':_0x5213fb,'isPromotion':_0x5213fb<_0x504429,'matchId':_0x43345d,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x4e2594,'previousElo':_0x3adbae['eloRating']||0x4b0,'newElo':_0x40bf33,'opponentId':_0x50c046,'matchResult':'loss','previousPosition':_0x5cf86b,'newPosition':_0x14da70,'isDemotion':_0x14da70>_0x5cf86b,'matchId':_0x43345d,'timestamp':serverTimestamp()})]),await promotionManager[_0x5f0509(0xbc)](_0x50c046,_0x57ac66,_0x7c3e35['eloRating'],{'source':'match','matchId':_0x43345d}),await promotionManager['checkAndRecordPromotion'](_0x4e2594,_0x40bf33,_0x3adbae[_0x5f0509(0xc6)],{'source':_0x5f0509(0xb9),'matchId':_0x43345d}),console[_0x5f0509(0xc7)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x3636cc){console['error'](_0x5f0509(0xce),_0x3636cc);throw _0x3636cc;}}export async function approveReport(_0x2a6030,_0x527186,_0x15fa2f,_0x268a27,_0x1c5989){const _0x54a30a=a30_0x4258;try{const _0x54992e=doc(db,'pendingMatches',_0x2a6030),_0x2e4217=await getDoc(_0x54992e);if(!_0x2e4217['exists']())throw new Error('Report\x20not\x20found');const _0x413dc2=_0x2e4217['data'](),_0x210371={..._0x413dc2,'winnerScore':_0x527186,'winnerSuicides':_0x15fa2f,'winnerComment':_0x268a27,'winnerDemoLink':_0x1c5989,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,_0x54a30a(0xb7),_0x2a6030),_0x210371),await deleteDoc(_0x54992e),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x23879c,_0x4f096d]=await Promise[_0x54a30a(0xcf)]([getDocs(query(collection(db,_0x54a30a(0xcb)),where(_0x54a30a(0xcd),'==',_0x413dc2['winnerUsername']))),getDocs(query(collection(db,_0x54a30a(0xcb)),where('username','==',_0x413dc2['loserUsername'])))]);if(_0x23879c['empty']||_0x4f096d['empty'])throw new Error(_0x54a30a(0xc0));const _0x555b7d=_0x23879c['docs'][0x0]['id'],_0x46a618=_0x4f096d['docs'][0x0]['id'];await updateEloRatings(_0x555b7d,_0x46a618,_0x2a6030);try{await awardMatchPoints(_0x555b7d,_0x46a618,_0x413dc2['subgameType']);}catch(_0x286c51){console['warn'](_0x54a30a(0xb4),_0x286c51);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x352d32){console['error']('Error\x20approving\x20report:',_0x352d32);throw _0x352d32;}}async function updatePlayerElo(_0x2ac601,_0x5c26c3,_0x53bc4a){const _0x38fd07=a30_0x4258;await setDoc(doc(db,_0x38fd07(0xcb),_0x2ac601),{...playerData,'eloRating':_0x53bc4a}),await checkAndRecordPromotion(_0x2ac601,_0x53bc4a,_0x5c26c3);}async function updatePlayerStats(_0x4fcd90,_0x48933a,_0x27b69e){const _0x4e6536=a30_0x4258,_0x497e0a=doc(db,'playerStats',_0x4fcd90),_0x1d325f=await getDoc(_0x497e0a);let _0x5c5878=_0x1d325f['exists']()?_0x1d325f['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x27b69e?(_0x5c5878['wins']++,_0x5c5878['totalKills']+=parseInt(_0x48933a[_0x4e6536(0xca)]||0x0),_0x5c5878['totalDeaths']+=parseInt(_0x48933a['loserScore']||0x0)):(_0x5c5878['losses']++,_0x5c5878['totalKills']+=parseInt(_0x48933a['loserScore']||0x0),_0x5c5878['totalDeaths']+=parseInt(_0x48933a[_0x4e6536(0xca)]||0x0));const _0x2ca991=_0x5c5878['wins']+_0x5c5878[_0x4e6536(0xb5)];_0x5c5878['winRate']=_0x2ca991>0x0?(_0x5c5878['wins']/_0x2ca991*0x64)[_0x4e6536(0xc2)](0x1):0x0,_0x5c5878['lastUpdated']=new Date()[_0x4e6536(0xcc)](),await setDoc(_0x497e0a,_0x5c5878,{'merge':!![]});}