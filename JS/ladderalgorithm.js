function a30_0x335d(){const _0x47b95d=['winnerUsername','One\x20or\x20both\x20players\x20not\x20found','totalKills','Match\x20moved\x20to\x20approved\x20collection','empty','error','commit','bind','update','pow','wins','winnerScore','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','username','exists','console','trace','loserScore','data','all','collection','toFixed','return\x20(function()\x20','eloRating','docs','ELO\x20ratings\x20updated\x20successfully','warn','log','catch','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'];a30_0x335d=function(){return _0x47b95d;};return a30_0x335d();}const a30_0x1996f2=(function(){let _0x4e97ea=!![];return function(_0x30dd8b,_0x55369c){const _0x358340=_0x4e97ea?function(){if(_0x55369c){const _0x15cff0=_0x55369c['apply'](_0x30dd8b,arguments);return _0x55369c=null,_0x15cff0;}}:function(){};return _0x4e97ea=![],_0x358340;};}()),a30_0x4ef8b0=a30_0x1996f2(this,function(){const _0x13326d=a30_0x48e5;let _0x3a9a0f;try{const _0x396c3a=Function(_0x13326d(0x1ce)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x3a9a0f=_0x396c3a();}catch(_0xdf5ceb){_0x3a9a0f=window;}const _0x8482ef=_0x3a9a0f[_0x13326d(0x1c7)]=_0x3a9a0f[_0x13326d(0x1c7)]||{},_0x213941=[_0x13326d(0x1d3),'warn','info',_0x13326d(0x1bd),'exception','table',_0x13326d(0x1c8)];for(let _0xe29d84=0x0;_0xe29d84<_0x213941['length'];_0xe29d84++){const _0x430f0e=a30_0x1996f2['constructor']['prototype']['bind'](a30_0x1996f2),_0x111857=_0x213941[_0xe29d84],_0x4c4e8d=_0x8482ef[_0x111857]||_0x430f0e;_0x430f0e['__proto__']=a30_0x1996f2[_0x13326d(0x1bf)](a30_0x1996f2),_0x430f0e['toString']=_0x4c4e8d['toString'][_0x13326d(0x1bf)](_0x4c4e8d),_0x8482ef[_0x111857]=_0x430f0e;}});a30_0x4ef8b0();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a30_0x48e5(_0x3f079c,_0x1e6179){const _0x4ef8b0=a30_0x335d();return a30_0x48e5=function(_0x1996f2,_0xc6bc26){_0x1996f2=_0x1996f2-0x1b8;let _0x335ddf=_0x4ef8b0[_0x1996f2];return _0x335ddf;},a30_0x48e5(_0x3f079c,_0x1e6179);}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x121555,_0x2029b9,_0x24f5e9=0x20){const _0x27c7b7=a30_0x48e5,_0x33f27d=0x1/(0x1+Math[_0x27c7b7(0x1c1)](0xa,(_0x2029b9-_0x121555)/0x190)),_0x54229e=0x1/(0x1+Math['pow'](0xa,(_0x121555-_0x2029b9)/0x190)),_0x26ae28=_0x121555+_0x24f5e9*(0x1-_0x33f27d),_0x14da8e=_0x2029b9+_0x24f5e9*(0x0-_0x54229e);return{'newWinnerRating':Math['round'](_0x26ae28),'newLoserRating':Math['round'](_0x14da8e)};}export function assignDefaultEloRating(_0x2ca949,_0x14569f){const _0x418ef0=a30_0x48e5,_0x20f437=0x4b0;!_0x14569f['eloRating']&&db[_0x418ef0(0x1cc)]('players')['doc'](_0x2ca949)['update']({'eloRating':_0x20f437})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x14569f['username']);})[_0x418ef0(0x1d4)](_0x4ad936=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x4ad936);});}export async function updateEloRatings(_0x164f48,_0x74a730,_0x335db1){const _0xcb11ae=a30_0x48e5;try{const _0x19d030=writeBatch(db),_0x19dfea=doc(db,'players',_0x164f48),_0x16f8f7=doc(db,'players',_0x74a730),[_0xfa16df,_0x133ecd]=await Promise[_0xcb11ae(0x1cb)]([getDoc(_0x19dfea),getDoc(_0x16f8f7)]);if(!_0xfa16df[_0xcb11ae(0x1c6)]()||!_0x133ecd['exists']())throw new Error(_0xcb11ae(0x1b9));const _0x2023df=_0xfa16df['data'](),_0x3ac995=_0x133ecd['data'](),_0x491048=_0x2023df['position']||Number['MAX_SAFE_INTEGER'],_0x4cf5b4=_0x3ac995['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x35e1e3,newLoserRating:_0x2ce019}=calculateElo(_0x2023df['eloRating']||0x4b0,_0x3ac995[_0xcb11ae(0x1cf)]||0x4b0);let _0x239da9=_0x491048,_0x4fb5b7=_0x4cf5b4;if(_0x491048>_0x4cf5b4){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x239da9=_0x4cf5b4,_0x4fb5b7=_0x4cf5b4+0x1;const _0x5eb5dd=query(collection(db,'players'),where('position','>',_0x4cf5b4),where('position','<',_0x491048)),_0x38a799=await getDocs(_0x5eb5dd);for(const _0x3a61b1 of _0x38a799[_0xcb11ae(0x1d0)]){_0x3a61b1['id']!==_0x164f48&&_0x3a61b1['id']!==_0x74a730&&_0x19d030['update'](doc(db,'players',_0x3a61b1['id']),{'position':_0x3a61b1[_0xcb11ae(0x1ca)]()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x29863d={'eloRating':_0x35e1e3,'lastMatchDate':serverTimestamp(),'position':_0x239da9,'lastMatchId':_0x335db1},_0xf70c25={'eloRating':_0x2ce019,'lastMatchDate':serverTimestamp(),'position':_0x4fb5b7,'lastMatchId':_0x335db1};return _0x19d030[_0xcb11ae(0x1c0)](_0x19dfea,_0x29863d),_0x19d030['update'](_0x16f8f7,_0xf70c25),await _0x19d030[_0xcb11ae(0x1be)](),console['log'](_0xcb11ae(0x1d1)),await Promise['all']([recordEloChange({'playerId':_0x164f48,'previousElo':_0x2023df['eloRating']||0x4b0,'newElo':_0x35e1e3,'opponentId':_0x74a730,'matchResult':'win','previousPosition':_0x491048,'newPosition':_0x239da9,'isPromotion':_0x239da9<_0x491048,'matchId':_0x335db1,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x74a730,'previousElo':_0x3ac995['eloRating']||0x4b0,'newElo':_0x2ce019,'opponentId':_0x164f48,'matchResult':'loss','previousPosition':_0x4cf5b4,'newPosition':_0x4fb5b7,'isDemotion':_0x4fb5b7>_0x4cf5b4,'matchId':_0x335db1,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x164f48,_0x35e1e3,_0x2023df['eloRating'],{'source':'match','matchId':_0x335db1}),await promotionManager['checkAndRecordPromotion'](_0x74a730,_0x2ce019,_0x3ac995[_0xcb11ae(0x1cf)],{'source':'match','matchId':_0x335db1}),console['log'](_0xcb11ae(0x1d5)),!![];}catch(_0x16c1e8){console['error']('Error\x20in\x20updateEloRatings:',_0x16c1e8);throw _0x16c1e8;}}export async function approveReport(_0x2602d2,_0x41ba3e,_0x315f74,_0x7e1ea1,_0x34bd96){const _0x426646=a30_0x48e5;try{const _0x2537b6=doc(db,'pendingMatches',_0x2602d2),_0x2517f7=await getDoc(_0x2537b6);if(!_0x2517f7['exists']())throw new Error('Report\x20not\x20found');const _0x2c3f09=_0x2517f7['data'](),_0x1f8b00={..._0x2c3f09,'winnerScore':_0x41ba3e,'winnerSuicides':_0x315f74,'winnerComment':_0x7e1ea1,'winnerDemoLink':_0x34bd96,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x2602d2),_0x1f8b00),await deleteDoc(_0x2537b6),console['log'](_0x426646(0x1bb));const [_0x4f65e0,_0x611495]=await Promise[_0x426646(0x1cb)]([getDocs(query(collection(db,'players'),where('username','==',_0x2c3f09[_0x426646(0x1b8)]))),getDocs(query(collection(db,'players'),where(_0x426646(0x1c5),'==',_0x2c3f09['loserUsername'])))]);if(_0x4f65e0['empty']||_0x611495[_0x426646(0x1bc)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x5e443f=_0x4f65e0['docs'][0x0]['id'],_0x4467ee=_0x611495[_0x426646(0x1d0)][0x0]['id'];await updateEloRatings(_0x5e443f,_0x4467ee,_0x2602d2);try{await awardMatchPoints(_0x5e443f,_0x4467ee,_0x2c3f09['subgameType']);}catch(_0x27ec8b){console[_0x426646(0x1d2)]('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x27ec8b);}return console['log'](_0x426646(0x1c4)),!![];}catch(_0x41bdc5){console[_0x426646(0x1bd)]('Error\x20approving\x20report:',_0x41bdc5);throw _0x41bdc5;}}async function updatePlayerElo(_0x3eea8b,_0x284ba8,_0x23907d){await setDoc(doc(db,'players',_0x3eea8b),{...playerData,'eloRating':_0x23907d}),await checkAndRecordPromotion(_0x3eea8b,_0x23907d,_0x284ba8);}async function updatePlayerStats(_0x17ab1d,_0x240a0f,_0x461f94){const _0x17bf7c=a30_0x48e5,_0x5676f9=doc(db,'playerStats',_0x17ab1d),_0x1183b1=await getDoc(_0x5676f9);let _0x1127bc=_0x1183b1['exists']()?_0x1183b1[_0x17bf7c(0x1ca)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x461f94?(_0x1127bc['wins']++,_0x1127bc['totalKills']+=parseInt(_0x240a0f[_0x17bf7c(0x1c3)]||0x0),_0x1127bc['totalDeaths']+=parseInt(_0x240a0f[_0x17bf7c(0x1c9)]||0x0)):(_0x1127bc['losses']++,_0x1127bc[_0x17bf7c(0x1ba)]+=parseInt(_0x240a0f[_0x17bf7c(0x1c9)]||0x0),_0x1127bc['totalDeaths']+=parseInt(_0x240a0f['winnerScore']||0x0));const _0x130009=_0x1127bc[_0x17bf7c(0x1c2)]+_0x1127bc['losses'];_0x1127bc['winRate']=_0x130009>0x0?(_0x1127bc['wins']/_0x130009*0x64)[_0x17bf7c(0x1cd)](0x1):0x0,_0x1127bc['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x5676f9,_0x1127bc,{'merge':!![]});}