const a28_0x262dc0=(function(){let _0x279457=!![];return function(_0x33d55b,_0x1e384c){const _0x5c0c3e=_0x279457?function(){const _0x1f1ea8=a28_0x45b3;if(_0x1e384c){const _0x5f0dd5=_0x1e384c[_0x1f1ea8(0x120)](_0x33d55b,arguments);return _0x1e384c=null,_0x5f0dd5;}}:function(){};return _0x279457=![],_0x5c0c3e;};}()),a28_0x3e339e=a28_0x262dc0(this,function(){const _0x562b46=a28_0x45b3,_0x55d824=function(){const _0x3b8a73=a28_0x45b3;let _0x48531a;try{_0x48531a=Function(_0x3b8a73(0x115)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x24bd4d){_0x48531a=window;}return _0x48531a;},_0x165361=_0x55d824(),_0x5b94ca=_0x165361['console']=_0x165361['console']||{},_0x23a2dc=['log',_0x562b46(0x11c),'info',_0x562b46(0x118),'exception','table','trace'];for(let _0x3cdb31=0x0;_0x3cdb31<_0x23a2dc['length'];_0x3cdb31++){const _0x3e3991=a28_0x262dc0['constructor'][_0x562b46(0x12b)][_0x562b46(0x12c)](a28_0x262dc0),_0x492574=_0x23a2dc[_0x3cdb31],_0x5df84e=_0x5b94ca[_0x492574]||_0x3e3991;_0x3e3991[_0x562b46(0x114)]=a28_0x262dc0['bind'](a28_0x262dc0),_0x3e3991['toString']=_0x5df84e['toString']['bind'](_0x5df84e),_0x5b94ca[_0x492574]=_0x3e3991;}});a28_0x3e339e();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';function a28_0x45b3(_0x5878c3,_0x17ddce){const _0x3e339e=a28_0x2c0a();return a28_0x45b3=function(_0x262dc0,_0x3ab8ad){_0x262dc0=_0x262dc0-0x111;let _0x2c0aa8=_0x3e339e[_0x262dc0];return _0x2c0aa8;},a28_0x45b3(_0x5878c3,_0x17ddce);}export function calculateElo(_0x1c5981,_0xb3515f,_0x290c03=0x20){const _0x4075ef=a28_0x45b3,_0x10f1ff=0x1/(0x1+Math['pow'](0xa,(_0xb3515f-_0x1c5981)/0x190)),_0x3bc5da=0x1/(0x1+Math[_0x4075ef(0x112)](0xa,(_0x1c5981-_0xb3515f)/0x190)),_0x23fd30=_0x1c5981+_0x290c03*(0x1-_0x10f1ff),_0x5c87b8=_0xb3515f+_0x290c03*(0x0-_0x3bc5da);return{'newWinnerRating':Math['round'](_0x23fd30),'newLoserRating':Math['round'](_0x5c87b8)};}export function assignDefaultEloRating(_0x2d7b04,_0x31c847){const _0x6f05d3=a28_0x45b3,_0x3322a2=0x4b0;!_0x31c847[_0x6f05d3(0x123)]&&db[_0x6f05d3(0x12a)]('players')['doc'](_0x2d7b04)[_0x6f05d3(0x119)]({'eloRating':_0x3322a2})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x31c847['username']);})[_0x6f05d3(0x124)](_0x4c9d78=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x4c9d78);});}export async function updateEloRatings(_0xebd2ee,_0x2af608,_0x1d241a){const _0x131f8e=a28_0x45b3;try{const _0x4a9fdf=writeBatch(db),_0x40644b=doc(db,'players',_0xebd2ee),_0x5e306f=doc(db,_0x131f8e(0x127),_0x2af608),[_0x3955e0,_0x3ee5c1]=await Promise['all']([getDoc(_0x40644b),getDoc(_0x5e306f)]);if(!_0x3955e0['exists']()||!_0x3ee5c1[_0x131f8e(0x11f)]())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x5caca7=_0x3955e0[_0x131f8e(0x133)](),_0x4e98ce=_0x3ee5c1[_0x131f8e(0x133)](),_0x579f9b=_0x5caca7[_0x131f8e(0x132)]||Number[_0x131f8e(0x11b)],_0x1f28aa=_0x4e98ce['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x338cb6,newLoserRating:_0x3a222d}=calculateElo(_0x5caca7['eloRating']||0x4b0,_0x4e98ce[_0x131f8e(0x123)]||0x4b0);let _0x3868d=_0x579f9b,_0x449624=_0x1f28aa;if(_0x579f9b>_0x1f28aa){console['log'](_0x131f8e(0x111)),_0x3868d=_0x1f28aa,_0x449624=_0x1f28aa+0x1;const _0x173733=query(collection(db,'players'),where('position','>',_0x1f28aa),where('position','<',_0x579f9b)),_0xbabacb=await getDocs(_0x173733);for(const _0x3082b4 of _0xbabacb['docs']){_0x3082b4['id']!==_0xebd2ee&&_0x3082b4['id']!==_0x2af608&&_0x4a9fdf['update'](doc(db,'players',_0x3082b4['id']),{'position':_0x3082b4['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x5c581e={'eloRating':_0x338cb6,'lastMatchDate':serverTimestamp(),'position':_0x3868d,'lastMatchId':_0x1d241a},_0x3d507c={'eloRating':_0x3a222d,'lastMatchDate':serverTimestamp(),'position':_0x449624,'lastMatchId':_0x1d241a};return _0x4a9fdf['update'](_0x40644b,_0x5c581e),_0x4a9fdf['update'](_0x5e306f,_0x3d507c),await _0x4a9fdf[_0x131f8e(0x11e)](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0xebd2ee,'previousElo':_0x5caca7['eloRating']||0x4b0,'newElo':_0x338cb6,'opponentId':_0x2af608,'matchResult':_0x131f8e(0x12f),'previousPosition':_0x579f9b,'newPosition':_0x3868d,'isPromotion':_0x3868d<_0x579f9b,'matchId':_0x1d241a,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x2af608,'previousElo':_0x4e98ce['eloRating']||0x4b0,'newElo':_0x3a222d,'opponentId':_0xebd2ee,'matchResult':_0x131f8e(0x134),'previousPosition':_0x1f28aa,'newPosition':_0x449624,'isDemotion':_0x449624>_0x1f28aa,'matchId':_0x1d241a,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0xebd2ee,_0x338cb6,_0x5caca7['eloRating'],{'source':_0x131f8e(0x11a),'matchId':_0x1d241a}),await promotionManager[_0x131f8e(0x11d)](_0x2af608,_0x3a222d,_0x4e98ce[_0x131f8e(0x123)],{'source':_0x131f8e(0x11a),'matchId':_0x1d241a}),console['log'](_0x131f8e(0x128)),!![];}catch(_0x12ba67){console['error']('Error\x20in\x20updateEloRatings:',_0x12ba67);throw _0x12ba67;}}function a28_0x2c0a(){const _0x255e68=['Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','pow','Unknown\x20User','__proto__','return\x20(function()\x20','add','email','error','update','match','MAX_SAFE_INTEGER','warn','checkAndRecordPromotion','commit','exists','apply','docs','toFixed','eloRating','catch','displayName','loserScore','players','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','approvedMatches','collection','prototype','bind','username','Standard','win','winnerScore','\x20match','position','data','loss','losses'];a28_0x2c0a=function(){return _0x255e68;};return a28_0x2c0a();}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x5c2673,_0x28278b,_0x3c8671,_0x27817e,_0x18aaa1){const _0x1c2798=a28_0x45b3;try{const _0x46322e=doc(db,'pendingMatches',_0x5c2673),_0x7e8b1d=await getDoc(_0x46322e);if(!_0x7e8b1d['exists']())throw new Error('Report\x20not\x20found');const _0x150739=_0x7e8b1d[_0x1c2798(0x133)](),_0x457a6a={..._0x150739,'winnerScore':_0x28278b,'winnerSuicides':_0x3c8671,'winnerComment':_0x27817e,'winnerDemoLink':_0x18aaa1,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,_0x1c2798(0x129),_0x5c2673),_0x457a6a),await deleteDoc(_0x46322e),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x29ac70,_0x3a944a]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x150739['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x150739['loserUsername'])))]);if(_0x29ac70['empty']||_0x3a944a['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x5a4bac=_0x29ac70['docs'][0x0]['id'],_0xff2e89=_0x3a944a[_0x1c2798(0x121)][0x0]['id'];await updateEloRatings(_0x5a4bac,_0xff2e89,_0x5c2673);try{const _0x412696=_0x150739['subgameType']||_0x1c2798(0x12e),_0x45b239=POINTS_CHART[_0x412696]||0xa,_0x31d178=doc(db,'userProfiles',_0x5a4bac),_0x2054a8=doc(db,'userProfiles',_0xff2e89),[_0x3c5658,_0x436f68]=await Promise['all']([getDoc(_0x31d178),getDoc(_0x2054a8)]);if(_0x3c5658['exists']()&&_0x436f68['exists']()){const _0x11e2ee=_0x3c5658['data'](),_0x3e3d12=_0x436f68['data'](),_0x27475b=_0x11e2ee['points']||0x0,_0x443ed6=_0x3e3d12['points']||0x0,_0x2e1a9e=_0x27475b+_0x45b239,_0x5e9f25=_0x443ed6+_0x45b239;await Promise['all']([updateDoc(_0x31d178,{'points':_0x2e1a9e,'lastPointsModified':serverTimestamp()}),updateDoc(_0x2054a8,{'points':_0x5e9f25,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,'pointsHistory'),{'userId':_0x5a4bac,'userEmail':_0x11e2ee[_0x1c2798(0x117)]||'unknown','displayName':_0x11e2ee['displayName']||_0x11e2ee[_0x1c2798(0x12d)]||_0x1c2798(0x113),'action':_0x1c2798(0x116),'amount':_0x45b239,'previousPoints':_0x27475b,'newPoints':_0x2e1a9e,'reason':'Match\x20points:\x20'+_0x412696+'\x20match\x20(Winner)','adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0xff2e89,'userEmail':_0x3e3d12['email']||'unknown','displayName':_0x3e3d12[_0x1c2798(0x125)]||_0x3e3d12[_0x1c2798(0x12d)]||_0x1c2798(0x113),'action':'add','amount':_0x45b239,'previousPoints':_0x443ed6,'newPoints':_0x5e9f25,'reason':'Match\x20points:\x20'+_0x412696+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log']('Awarded\x20'+_0x45b239+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x412696+_0x1c2798(0x131));}else console['warn']('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x282e41){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x282e41);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x16e992){console[_0x1c2798(0x118)]('Error\x20approving\x20report:',_0x16e992);throw _0x16e992;}}async function updatePlayerElo(_0x2d9699,_0x25b291,_0x21ded9){const _0x296de2=a28_0x45b3;await setDoc(doc(db,_0x296de2(0x127),_0x2d9699),{...playerData,'eloRating':_0x21ded9}),await checkAndRecordPromotion(_0x2d9699,_0x21ded9,_0x25b291);}async function updatePlayerStats(_0x2116e6,_0x54878a,_0x186d36){const _0x5fcc39=a28_0x45b3,_0x306a99=doc(db,'playerStats',_0x2116e6),_0x4dc3e4=await getDoc(_0x306a99);let _0x586ebc=_0x4dc3e4['exists']()?_0x4dc3e4['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x186d36?(_0x586ebc['wins']++,_0x586ebc['totalKills']+=parseInt(_0x54878a[_0x5fcc39(0x130)]||0x0),_0x586ebc['totalDeaths']+=parseInt(_0x54878a[_0x5fcc39(0x126)]||0x0)):(_0x586ebc[_0x5fcc39(0x135)]++,_0x586ebc['totalKills']+=parseInt(_0x54878a['loserScore']||0x0),_0x586ebc['totalDeaths']+=parseInt(_0x54878a[_0x5fcc39(0x130)]||0x0));const _0x2925a1=_0x586ebc['wins']+_0x586ebc['losses'];_0x586ebc['winRate']=_0x2925a1>0x0?(_0x586ebc['wins']/_0x2925a1*0x64)[_0x5fcc39(0x122)](0x1):0x0,_0x586ebc['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x306a99,_0x586ebc,{'merge':!![]});}