function a28_0x3ced(_0x34c780,_0x3fddbd){const _0x16795f=a28_0x1533();return a28_0x3ced=function(_0x97f404,_0x346b90){_0x97f404=_0x97f404-0x189;let _0x1533bf=_0x16795f[_0x97f404];return _0x1533bf;},a28_0x3ced(_0x34c780,_0x3fddbd);}function a28_0x1533(){const _0xf4be5b=['loserUsername','playersD2','D2\x20Match\x20moved\x20to\x20approved\x20collection','winnerUsername','position','update','warn','MAX_SAFE_INTEGER','pendingMatchesD2','data','log','error','docs','empty','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','length','return\x20(function()\x20','D2\x20Report\x20not\x20found\x20with\x20ID:','toString','bind','exists','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','round','Could\x20not\x20find\x20D2\x20player\x20documents'];a28_0x1533=function(){return _0xf4be5b;};return a28_0x1533();}const a28_0x97f404=(function(){let _0x3e0d34=!![];return function(_0x5d5067,_0x35c411){const _0x457ec1=_0x3e0d34?function(){if(_0x35c411){const _0x125217=_0x35c411['apply'](_0x5d5067,arguments);return _0x35c411=null,_0x125217;}}:function(){};return _0x3e0d34=![],_0x457ec1;};}()),a28_0x16795f=a28_0x97f404(this,function(){const _0x1eacc4=a28_0x3ced,_0x3e7df3=function(){const _0x1d59bc=a28_0x3ced;let _0x2c21c9;try{_0x2c21c9=Function(_0x1d59bc(0x199)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x5fcad9){_0x2c21c9=window;}return _0x2c21c9;},_0x3bc6f2=_0x3e7df3(),_0x4dd6b5=_0x3bc6f2['console']=_0x3bc6f2['console']||{},_0x2c17a7=['log',_0x1eacc4(0x18f),'info','error','exception','table','trace'];for(let _0x3c6909=0x0;_0x3c6909<_0x2c17a7[_0x1eacc4(0x198)];_0x3c6909++){const _0x50e9f5=a28_0x97f404['constructor']['prototype']['bind'](a28_0x97f404),_0x3256fc=_0x2c17a7[_0x3c6909],_0x205ec5=_0x4dd6b5[_0x3256fc]||_0x50e9f5;_0x50e9f5['__proto__']=a28_0x97f404['bind'](a28_0x97f404),_0x50e9f5[_0x1eacc4(0x19b)]=_0x205ec5['toString'][_0x1eacc4(0x19c)](_0x205ec5),_0x4dd6b5[_0x3256fc]=_0x50e9f5;}});a28_0x16795f();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x2df232 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x543096,_0x53e2c2,_0x5e2005=0x20){const _0x3d271a=a28_0x3ced,_0x51d457=0x1/(0x1+Math['pow'](0xa,(_0x53e2c2-_0x543096)/0x190)),_0x37d9d6=0x1/(0x1+Math['pow'](0xa,(_0x543096-_0x53e2c2)/0x190)),_0x224e2b=_0x543096+_0x5e2005*(0x1-_0x51d457),_0x105e12=_0x53e2c2+_0x5e2005*(0x0-_0x37d9d6);return{'newWinnerRating':Math[_0x3d271a(0x19f)](_0x224e2b),'newLoserRating':Math['round'](_0x105e12)};}export async function updateEloRatingsD2(_0x829b7c,_0x209b25,_0x31ea6f){const _0xb563a0=a28_0x3ced;try{const _0x28b78e=writeBatch(db),_0x1e7c1b=doc(db,'playersD2',_0x829b7c),_0x45d644=doc(db,_0xb563a0(0x18a),_0x209b25),[_0x104eff,_0x40e272]=await Promise['all']([getDoc(_0x1e7c1b),getDoc(_0x45d644)]);if(!_0x104eff[_0xb563a0(0x19d)]()||!_0x40e272['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x43bd40=_0x104eff['data'](),_0x2ac0c2=_0x40e272[_0xb563a0(0x192)](),_0x4b71fe=_0x43bd40['position']||Number[_0xb563a0(0x190)],_0xe9b1d6=_0x2ac0c2[_0xb563a0(0x18d)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x292173,newLoserRating:_0x151198}=calculateEloD2(_0x43bd40['eloRating']||0x4b0,_0x2ac0c2['eloRating']||0x4b0);let _0x139cad=_0x4b71fe,_0x44928d=_0xe9b1d6;if(_0x4b71fe>_0xe9b1d6){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x139cad=_0xe9b1d6,_0x44928d=_0xe9b1d6+0x1;const _0x576ec5=query(collection(db,'playersD2'),where('position','>',_0xe9b1d6),where('position','<',_0x4b71fe)),_0x10d8d6=await getDocs(_0x576ec5);for(const _0x4771a3 of _0x10d8d6[_0xb563a0(0x195)]){_0x4771a3['id']!==_0x829b7c&&_0x4771a3['id']!==_0x209b25&&_0x28b78e['update'](doc(db,'playersD2',_0x4771a3['id']),{'position':_0x4771a3['data']()[_0xb563a0(0x18d)]+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x28b78e[_0xb563a0(0x18e)](_0x1e7c1b,{'eloRating':_0x292173,'lastMatchDate':serverTimestamp(),'position':_0x139cad,'lastMatchId':_0x31ea6f}),_0x28b78e['update'](_0x45d644,{'eloRating':_0x151198,'lastMatchDate':serverTimestamp(),'position':_0x44928d,'lastMatchId':_0x31ea6f}),await _0x28b78e['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x829b7c,'previousElo':_0x43bd40['eloRating']||0x4b0,'newElo':_0x292173,'opponentId':_0x209b25,'matchResult':'win','previousPosition':_0x4b71fe,'newPosition':_0x139cad,'isPromotion':_0x139cad<_0x4b71fe,'matchId':_0x31ea6f,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x209b25,'previousElo':_0x2ac0c2['eloRating']||0x4b0,'newElo':_0x151198,'opponentId':_0x829b7c,'matchResult':'loss','previousPosition':_0xe9b1d6,'newPosition':_0x44928d,'isDemotion':_0x44928d>_0xe9b1d6,'matchId':_0x31ea6f,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x829b7c,_0x292173,_0x43bd40['eloRating'],{'source':'match-d2','matchId':_0x31ea6f}),await promotionManager['checkAndRecordPromotion'](_0x209b25,_0x151198,_0x2ac0c2['eloRating'],{'source':'match-d2','matchId':_0x31ea6f}),!![];}catch(_0x500e04){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x500e04);throw _0x500e04;}}export async function approveReportD2(_0x42451b,_0x2d1b68,_0xe78b79,_0x3a0aaa){const _0x53df2f=a28_0x3ced;try{console[_0x53df2f(0x193)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x42451b,'winnerScore':_0x2d1b68,'winnerSuicides':_0xe78b79,'winnerComment':_0x3a0aaa});const _0x44d755=auth['currentUser'];if(!_0x44d755){console['log']('No\x20user\x20logged\x20in');throw new Error(_0x53df2f(0x19e));}console[_0x53df2f(0x193)]('Current\x20user:',_0x44d755['email']);const _0x443b28=await getDoc(doc(db,'playersD2',_0x44d755['uid'])),_0x95d69f=_0x443b28['exists']()?_0x443b28['data']()['username']:null;console[_0x53df2f(0x193)]('Current\x20username:',_0x95d69f);const _0x13fec6=doc(db,_0x53df2f(0x191),_0x42451b),_0xa4d91c=await getDoc(_0x13fec6);if(!_0xa4d91c['exists']()){console['log'](_0x53df2f(0x19a),_0x42451b);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x381eaa=_0xa4d91c['data']();console['log']('D2\x20Report\x20data:',_0x381eaa);if(_0x95d69f!==_0x381eaa['winnerUsername'])throw new Error(_0x53df2f(0x197));const _0x100b51={..._0x381eaa,'winnerScore':_0x2d1b68,'winnerSuicides':_0xe78b79,'winnerComment':_0x3a0aaa,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x95d69f,'createdAt':_0x381eaa['createdAt']||serverTimestamp(),'winnerUsername':_0x381eaa[_0x53df2f(0x18c)],'loserUsername':_0x381eaa[_0x53df2f(0x189)]};await setDoc(doc(db,'approvedMatchesD2',_0x42451b),_0x100b51),await deleteDoc(_0x13fec6),console['log'](_0x53df2f(0x18b));const [_0x336d46,_0x53fdbd]=await Promise['all']([getDocs(query(collection(db,_0x53df2f(0x18a)),where('username','==',_0x381eaa['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x381eaa[_0x53df2f(0x189)])))]);if(_0x336d46['empty']||_0x53fdbd[_0x53df2f(0x196)])throw new Error(_0x53df2f(0x1a0));const _0x247ad5=_0x336d46['docs'][0x0]['id'],_0x212c1f=_0x53fdbd['docs'][0x0]['id'];return await updateEloRatingsD2(_0x247ad5,_0x212c1f,_0x42451b),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x37da09){console[_0x53df2f(0x194)]('Error\x20in\x20approveReportD2:',_0x37da09);throw _0x37da09;}}