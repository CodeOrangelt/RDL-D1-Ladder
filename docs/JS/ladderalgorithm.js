(function(_0x3732d2,_0xc16fec){const _0x26ded7=a0_0x4c29,_0x240b62=_0x3732d2();while(!![]){try{const _0x1d5a05=-parseInt(_0x26ded7(0xf3))/0x1+-parseInt(_0x26ded7(0x101))/0x2+-parseInt(_0x26ded7(0xf2))/0x3*(parseInt(_0x26ded7(0x116))/0x4)+parseInt(_0x26ded7(0xfb))/0x5+-parseInt(_0x26ded7(0xfc))/0x6+parseInt(_0x26ded7(0x105))/0x7*(-parseInt(_0x26ded7(0xe9))/0x8)+parseInt(_0x26ded7(0xf5))/0x9;if(_0x1d5a05===_0xc16fec)break;else _0x240b62['push'](_0x240b62['shift']());}catch(_0xc36a23){_0x240b62['push'](_0x240b62['shift']());}}}(a0_0x1442,0xc7740));const a0_0x2b9b83=(function(){let _0x4609c3=!![];return function(_0x4c5ac1,_0x5dd608){const _0x5812ec=_0x4609c3?function(){if(_0x5dd608){const _0x352db3=_0x5dd608['apply'](_0x4c5ac1,arguments);return _0x5dd608=null,_0x352db3;}}:function(){};return _0x4609c3=![],_0x5812ec;};}()),a0_0x47c3f9=a0_0x2b9b83(this,function(){const _0x5e2c3f=a0_0x4c29;let _0x416c55;try{const _0x59cebe=Function(_0x5e2c3f(0xfe)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x416c55=_0x59cebe();}catch(_0x53e9e7){_0x416c55=window;}const _0x326e9f=_0x416c55[_0x5e2c3f(0x10e)]=_0x416c55['console']||{},_0x5d6873=['log','warn','info','error','exception','table','trace'];for(let _0x1b498b=0x0;_0x1b498b<_0x5d6873[_0x5e2c3f(0x10f)];_0x1b498b++){const _0x10eeca=a0_0x2b9b83[_0x5e2c3f(0xec)][_0x5e2c3f(0xeb)]['bind'](a0_0x2b9b83),_0x50b7ee=_0x5d6873[_0x1b498b],_0x2d7236=_0x326e9f[_0x50b7ee]||_0x10eeca;_0x10eeca[_0x5e2c3f(0x112)]=a0_0x2b9b83['bind'](a0_0x2b9b83),_0x10eeca['toString']=_0x2d7236[_0x5e2c3f(0xfa)]['bind'](_0x2d7236),_0x326e9f[_0x50b7ee]=_0x10eeca;}});a0_0x47c3f9();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';function a0_0x4c29(_0x433bab,_0x4f57a9){const _0x55aa7c=a0_0x1442();return a0_0x4c29=function(_0x47c3f9,_0x2b9b83){_0x47c3f9=_0x47c3f9-0xe1;let _0x1e0718=_0x55aa7c[_0x47c3f9];return _0x1e0718;},a0_0x4c29(_0x433bab,_0x4f57a9);}import{isAdmin}from'./admin-check.js';import{RANKS,getRankStyle}from'./ranks.js';export function calculateElo(_0x2956ef,_0x3b8563,_0x552f26=0x20){const _0x430fc3=a0_0x4c29;_0x2956ef=_0x2956ef>0x3e8?0xc8:_0x2956ef,_0x3b8563=_0x3b8563>0x3e8?0xc8:_0x3b8563;const _0x283e18=0x1/(0x1+Math[_0x430fc3(0x103)](0xa,(_0x3b8563-_0x2956ef)/0x190)),_0x431fef=0x1/(0x1+Math[_0x430fc3(0x103)](0xa,(_0x2956ef-_0x3b8563)/0x190)),_0x1d6a74=_0x2956ef+_0x552f26*(0x1-_0x283e18),_0x24bbe7=_0x3b8563+_0x552f26*(0x0-_0x431fef);return{'newWinnerRating':Math['round'](Math[_0x430fc3(0xed)](_0x1d6a74)),'newLoserRating':Math['round'](Math[_0x430fc3(0xff)](_0x24bbe7,0x0))};}export function assignDefaultEloRating(_0x17fdf1,_0x5e59aa){const _0x1188c5=a0_0x4c29,_0x1cb642=0xc8;!_0x5e59aa['eloRating']&&db[_0x1188c5(0xf7)]('players')[_0x1188c5(0x10b)](_0x17fdf1)['update']({'eloRating':_0x1cb642})[_0x1188c5(0xe7)](()=>{const _0x686d62=_0x1188c5;console['log'](_0x686d62(0xf9)+_0x5e59aa['username']);})['catch'](_0x55f213=>{const _0x2f87b2=_0x1188c5;console['error'](_0x2f87b2(0xea),_0x55f213);});}export async function updateEloRatings(_0x434197,_0x2bfc3d,_0x7ad1da){const _0x14dce7=a0_0x4c29;try{const _0x118d82=writeBatch(db),_0x48c91c=doc(db,_0x14dce7(0xf0),_0x434197),_0x2dcaee=doc(db,'players',_0x2bfc3d),[_0xb3145e,_0x4066b5]=await Promise[_0x14dce7(0x10a)]([getDoc(_0x48c91c),getDoc(_0x2dcaee)]);if(!_0xb3145e['exists']()||!_0x4066b5['exists']())throw new Error(_0x14dce7(0x109));const _0x25dc7d=_0xb3145e[_0x14dce7(0x10c)](),_0x59664f=_0x4066b5['data'](),_0x8aeea6=_0x25dc7d['position']||Number['MAX_SAFE_INTEGER'],_0x4f5608=_0x59664f['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x159bce,newLoserRating:_0x1038a1}=calculateElo(_0x25dc7d['eloRating']||0x4b0,_0x59664f[_0x14dce7(0x113)]||0x4b0);let _0x42e7ba=_0x8aeea6,_0x1dad05=_0x4f5608;if(_0x8aeea6>_0x4f5608){console[_0x14dce7(0x110)](_0x14dce7(0x114)),_0x42e7ba=_0x4f5608,_0x1dad05=_0x4f5608+0x1;const _0x491765=query(collection(db,_0x14dce7(0xf0)),where('position','>',_0x4f5608),where('position','<',_0x8aeea6)),_0x431258=await getDocs(_0x491765);for(const _0x2e8210 of _0x431258['docs']){_0x2e8210['id']!==_0x434197&&_0x2e8210['id']!==_0x2bfc3d&&_0x118d82['update'](doc(db,'players',_0x2e8210['id']),{'position':_0x2e8210[_0x14dce7(0x10c)]()[_0x14dce7(0xef)]+0x1});}}else console['log'](_0x14dce7(0x104));const _0x1eb35d={'eloRating':_0x159bce,'lastMatchDate':serverTimestamp(),'position':_0x42e7ba,'lastMatchId':_0x7ad1da},_0x1692f3={'eloRating':_0x1038a1,'lastMatchDate':serverTimestamp(),'position':_0x1dad05,'lastMatchId':_0x7ad1da};return _0x118d82[_0x14dce7(0x108)](_0x48c91c,_0x1eb35d),_0x118d82[_0x14dce7(0x108)](_0x2dcaee,_0x1692f3),await _0x118d82[_0x14dce7(0x107)](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x434197,'previousElo':_0x25dc7d['eloRating']||0x4b0,'newElo':_0x159bce,'opponentId':_0x2bfc3d,'matchResult':'win','previousPosition':_0x8aeea6,'newPosition':_0x42e7ba,'isPromotion':_0x42e7ba<_0x8aeea6,'matchId':_0x7ad1da,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x2bfc3d,'previousElo':_0x59664f['eloRating']||0x4b0,'newElo':_0x1038a1,'opponentId':_0x434197,'matchResult':'loss','previousPosition':_0x4f5608,'newPosition':_0x1dad05,'isDemotion':_0x1dad05>_0x4f5608,'matchId':_0x7ad1da,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x434197,_0x159bce,_0x25dc7d[_0x14dce7(0x113)],{'source':_0x14dce7(0xe5),'matchId':_0x7ad1da}),await promotionManager['checkAndRecordPromotion'](_0x2bfc3d,_0x1038a1,_0x59664f[_0x14dce7(0x113)],{'source':_0x14dce7(0xe5),'matchId':_0x7ad1da}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x381e14){console['error']('Error\x20in\x20updateEloRatings:',_0x381e14);throw _0x381e14;}}function a0_0x1442(){const _0x23bf59=['doc','data','system-match-award','console','length','log','Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found','__proto__','eloRating','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','wins','75728NVlJnG','totalKills','Match\x20moved\x20to\x20approved\x20collection','currentUser','approvedMatches','Match\x20points:\x20','match','loserUsername','then','empty','56mtjgLI','Error\x20assigning\x20default\x20ELO\x20rating:','prototype','constructor','min','exists','position','players','userProfiles','204yCAtjr','1270272lyWACe','email','36344367KpuFds','winRate','collection','pointsHistory','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','toString','5340275OdEQPk','2057046EqITMl','Report\x20not\x20found','return\x20(function()\x20','max','Error\x20approving\x20report:','1389148Rkwnzc','name','pow','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','694295wLAiVA','warn','commit','update','One\x20or\x20both\x20players\x20not\x20found','all'];a0_0x1442=function(){return _0x23bf59;};return a0_0x1442();}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x11af50,_0x28117c,_0x484d24,_0x239f63,_0x4ba813){const _0x2e9b65=a0_0x4c29;try{const _0x2eb7d5=doc(db,'pendingMatches',_0x11af50),_0x53ab22=await getDoc(_0x2eb7d5);if(!_0x53ab22['exists']())throw new Error(_0x2e9b65(0xfd));const _0x49807c=_0x53ab22['data'](),_0x47d481={..._0x49807c,'winnerScore':_0x28117c,'winnerSuicides':_0x484d24,'winnerComment':_0x239f63,'winnerDemoLink':_0x4ba813,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth[_0x2e9b65(0xe2)]['uid']};await setDoc(doc(db,_0x2e9b65(0xe3),_0x11af50),_0x47d481),await deleteDoc(_0x2eb7d5),console['log'](_0x2e9b65(0xe1));const [_0xee61bb,_0x5e1297]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x49807c['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x49807c[_0x2e9b65(0xe6)])))]);if(_0xee61bb['empty']||_0x5e1297[_0x2e9b65(0xe8)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x363750=_0xee61bb['docs'][0x0]['id'],_0x330b23=_0x5e1297['docs'][0x0]['id'];await updateEloRatings(_0x363750,_0x330b23,_0x11af50);try{const _0x423dd8=_0x49807c['subgameType']||'Standard',_0x4c430d=POINTS_CHART[_0x423dd8]||0xa,_0x3fb4d2=doc(db,_0x2e9b65(0xf1),_0x363750),_0xb5057=doc(db,'userProfiles',_0x330b23),[_0x47e0ab,_0x556ce0]=await Promise['all']([getDoc(_0x3fb4d2),getDoc(_0xb5057)]);if(_0x47e0ab[_0x2e9b65(0xee)]()&&_0x556ce0['exists']()){const _0x5d5f36=_0x47e0ab['data'](),_0x4e81f6=_0x556ce0['data'](),_0x327a28=_0x5d5f36['points']||0x0,_0x60bc7a=_0x4e81f6['points']||0x0,_0xc10a89=_0x327a28+_0x4c430d,_0x1de301=_0x60bc7a+_0x4c430d;await Promise['all']([updateDoc(_0x3fb4d2,{'points':_0xc10a89,'lastPointsModified':serverTimestamp()}),updateDoc(_0xb5057,{'points':_0x1de301,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,'pointsHistory'),{'userId':_0x363750,'userEmail':_0x5d5f36[_0x2e9b65(0xf4)]||'unknown','displayName':_0x5d5f36['displayName']||_0x5d5f36['username']||'Unknown\x20User','action':'add','amount':_0x4c430d,'previousPoints':_0x327a28,'newPoints':_0xc10a89,'reason':_0x2e9b65(0xe4)+_0x423dd8+'\x20match\x20(Winner)','adminEmail':_0x2e9b65(0x10d),'timestamp':serverTimestamp()}),addDoc(collection(db,_0x2e9b65(0xf8)),{'userId':_0x330b23,'userEmail':_0x4e81f6['email']||'unknown','displayName':_0x4e81f6['displayName']||_0x4e81f6['username']||'Unknown\x20User','action':'add','amount':_0x4c430d,'previousPoints':_0x60bc7a,'newPoints':_0x1de301,'reason':'Match\x20points:\x20'+_0x423dd8+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console[_0x2e9b65(0x110)]('Awarded\x20'+_0x4c430d+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x423dd8+'\x20match');}else console[_0x2e9b65(0x106)](_0x2e9b65(0x111));}catch(_0x403bfb){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x403bfb);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x348a9c){console['error'](_0x2e9b65(0x100),_0x348a9c);throw _0x348a9c;}}async function updatePlayerElo(_0x2206e9,_0x417487,_0x58075c){const _0x40c3b7=a0_0x4c29,_0x4e0028=doc(db,'players',_0x2206e9),_0x144fd6=await getDoc(_0x4e0028),_0x362941=_0x144fd6['data'](),_0x3bc97f=doc(db,'playerStats',_0x2206e9),_0x4351d1=await getDoc(_0x3bc97f),_0x5860c5=_0x4351d1[_0x40c3b7(0x10c)]()||{'totalMatches':0x0,'winRate':0x0},_0x31b34c=getRankStyle(_0x58075c,_0x5860c5['totalMatches'],_0x5860c5[_0x40c3b7(0xf6)]);await updateDoc(_0x4e0028,{'eloRating':_0x58075c,'rank':_0x31b34c[_0x40c3b7(0x102)],'rankColor':_0x31b34c['color']}),await checkAndRecordPromotion(_0x2206e9,_0x58075c,_0x417487,{'matchCount':_0x5860c5['totalMatches'],'winRate':_0x5860c5['winRate']});}async function updatePlayerStats(_0x1f7f84,_0x53a80c,_0xb1d698){const _0xe2f035=a0_0x4c29,_0x3d9d15=doc(db,'playerStats',_0x1f7f84),_0x55293b=await getDoc(_0x3d9d15);let _0x51a756=_0x55293b[_0xe2f035(0xee)]()?_0x55293b[_0xe2f035(0x10c)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0xb1d698?(_0x51a756['wins']++,_0x51a756[_0xe2f035(0x117)]+=parseInt(_0x53a80c['winnerScore']||0x0),_0x51a756['totalDeaths']+=parseInt(_0x53a80c['loserScore']||0x0)):(_0x51a756['losses']++,_0x51a756['totalKills']+=parseInt(_0x53a80c['loserScore']||0x0),_0x51a756['totalDeaths']+=parseInt(_0x53a80c['winnerScore']||0x0));const _0x1a0747=_0x51a756['wins']+_0x51a756['losses'];_0x51a756['winRate']=_0x1a0747>0x0?(_0x51a756[_0xe2f035(0x115)]/_0x1a0747*0x64)['toFixed'](0x1):0x0,_0x51a756['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x3d9d15,_0x51a756,{'merge':!![]});}