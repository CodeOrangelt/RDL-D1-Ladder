const a30_0x53c907=(function(){let _0x5265d4=!![];return function(_0x1359be,_0x4a16c2){const _0x530024=_0x5265d4?function(){if(_0x4a16c2){const _0x264723=_0x4a16c2['apply'](_0x1359be,arguments);return _0x4a16c2=null,_0x264723;}}:function(){};return _0x5265d4=![],_0x530024;};}()),a30_0x58f284=a30_0x53c907(this,function(){const _0x1ceeb5=a30_0x1737,_0x697079=function(){const _0x2909fb=a30_0x1737;let _0x52eafe;try{_0x52eafe=Function(_0x2909fb(0xff)+_0x2909fb(0x104)+');')();}catch(_0x2335a5){_0x52eafe=window;}return _0x52eafe;},_0x3aa6a1=_0x697079(),_0x43cbc1=_0x3aa6a1[_0x1ceeb5(0x11c)]=_0x3aa6a1['console']||{},_0x1c8ddd=['log',_0x1ceeb5(0x112),'info',_0x1ceeb5(0xfd),'exception','table','trace'];for(let _0x5a261c=0x0;_0x5a261c<_0x1c8ddd['length'];_0x5a261c++){const _0x3e6933=a30_0x53c907[_0x1ceeb5(0x109)][_0x1ceeb5(0x11b)]['bind'](a30_0x53c907),_0x3340d4=_0x1c8ddd[_0x5a261c],_0x2822de=_0x43cbc1[_0x3340d4]||_0x3e6933;_0x3e6933[_0x1ceeb5(0x118)]=a30_0x53c907['bind'](a30_0x53c907),_0x3e6933['toString']=_0x2822de['toString']['bind'](_0x2822de),_0x43cbc1[_0x3340d4]=_0x3e6933;}});a30_0x58f284();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{awardMatchPoints}from'./points-service.js';export function calculateElo(_0x5ca4f1,_0x5811f2,_0x120e52=0x20){const _0x320521=a30_0x1737,_0x4f7422=0x1/(0x1+Math[_0x320521(0x106)](0xa,(_0x5811f2-_0x5ca4f1)/0x190)),_0x1db13c=0x1/(0x1+Math['pow'](0xa,(_0x5ca4f1-_0x5811f2)/0x190)),_0x115e59=_0x5ca4f1+_0x120e52*(0x1-_0x4f7422),_0x2286df=_0x5811f2+_0x120e52*(0x0-_0x1db13c);return{'newWinnerRating':Math['round'](_0x115e59),'newLoserRating':Math[_0x320521(0x100)](_0x2286df)};}export function assignDefaultEloRating(_0x5dc4de,_0x131fd9){const _0x45d51b=a30_0x1737,_0x4236ac=0x4b0;!_0x131fd9['eloRating']&&db['collection'](_0x45d51b(0x10c))['doc'](_0x5dc4de)['update']({'eloRating':_0x4236ac})['then'](()=>{const _0x3f3b34=_0x45d51b;console['log'](_0x3f3b34(0x107)+_0x131fd9['username']);})['catch'](_0x4b3b11=>{const _0x230a3b=_0x45d51b;console[_0x230a3b(0xfd)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x4b3b11);});}function a30_0x1737(_0x19be12,_0xf47ac0){const _0x58f284=a30_0x49db();return a30_0x1737=function(_0x53c907,_0x31218f){_0x53c907=_0x53c907-0xfc;let _0x49db52=_0x58f284[_0x53c907];return _0x49db52;},a30_0x1737(_0x19be12,_0xf47ac0);}export async function updateEloRatings(_0x5d16e3,_0x53a8ee,_0x156b23){const _0x43a5c8=a30_0x1737;try{const _0x14e6ba=writeBatch(db),_0x476d3c=doc(db,'players',_0x5d16e3),_0xa2b17f=doc(db,'players',_0x53a8ee),[_0xdc15f9,_0x30636f]=await Promise['all']([getDoc(_0x476d3c),getDoc(_0xa2b17f)]);if(!_0xdc15f9['exists']()||!_0x30636f['exists']())throw new Error(_0x43a5c8(0xfe));const _0x490e6b=_0xdc15f9[_0x43a5c8(0x114)](),_0x4f48d8=_0x30636f[_0x43a5c8(0x114)](),_0x1367d6=_0x490e6b['position']||Number['MAX_SAFE_INTEGER'],_0x5e876a=_0x4f48d8['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x175604,newLoserRating:_0xbf4f75}=calculateElo(_0x490e6b[_0x43a5c8(0x10d)]||0x4b0,_0x4f48d8['eloRating']||0x4b0);let _0x22fc68=_0x1367d6,_0x208656=_0x5e876a;if(_0x1367d6>_0x5e876a){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x22fc68=_0x5e876a,_0x208656=_0x5e876a+0x1;const _0x3afde2=query(collection(db,'players'),where('position','>',_0x5e876a),where(_0x43a5c8(0x119),'<',_0x1367d6)),_0x11fa83=await getDocs(_0x3afde2);for(const _0x2e4b81 of _0x11fa83['docs']){_0x2e4b81['id']!==_0x5d16e3&&_0x2e4b81['id']!==_0x53a8ee&&_0x14e6ba['update'](doc(db,'players',_0x2e4b81['id']),{'position':_0x2e4b81[_0x43a5c8(0x114)]()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0xdec194={'eloRating':_0x175604,'lastMatchDate':serverTimestamp(),'position':_0x22fc68,'lastMatchId':_0x156b23},_0x1ad93d={'eloRating':_0xbf4f75,'lastMatchDate':serverTimestamp(),'position':_0x208656,'lastMatchId':_0x156b23};return _0x14e6ba['update'](_0x476d3c,_0xdec194),_0x14e6ba[_0x43a5c8(0x11d)](_0xa2b17f,_0x1ad93d),await _0x14e6ba[_0x43a5c8(0x102)](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x5d16e3,'previousElo':_0x490e6b['eloRating']||0x4b0,'newElo':_0x175604,'opponentId':_0x53a8ee,'matchResult':_0x43a5c8(0x103),'previousPosition':_0x1367d6,'newPosition':_0x22fc68,'isPromotion':_0x22fc68<_0x1367d6,'matchId':_0x156b23,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x53a8ee,'previousElo':_0x4f48d8['eloRating']||0x4b0,'newElo':_0xbf4f75,'opponentId':_0x5d16e3,'matchResult':'loss','previousPosition':_0x5e876a,'newPosition':_0x208656,'isDemotion':_0x208656>_0x5e876a,'matchId':_0x156b23,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x5d16e3,_0x175604,_0x490e6b['eloRating'],{'source':'match','matchId':_0x156b23}),await promotionManager['checkAndRecordPromotion'](_0x53a8ee,_0xbf4f75,_0x4f48d8['eloRating'],{'source':_0x43a5c8(0x105),'matchId':_0x156b23}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x3d4d0b){console['error']('Error\x20in\x20updateEloRatings:',_0x3d4d0b);throw _0x3d4d0b;}}export async function approveReport(_0x5278e4,_0xb3a751,_0x122566,_0x271360,_0x1c2da0){const _0x46669c=a30_0x1737;try{const _0x29b2ef=doc(db,'pendingMatches',_0x5278e4),_0x58092e=await getDoc(_0x29b2ef);if(!_0x58092e[_0x46669c(0x10f)]())throw new Error('Report\x20not\x20found');const _0x3d82c4=_0x58092e['data'](),_0xb79e04={..._0x3d82c4,'winnerScore':_0xb3a751,'winnerSuicides':_0x122566,'winnerComment':_0x271360,'winnerDemoLink':_0x1c2da0,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x46669c(0x116)]};await setDoc(doc(db,'approvedMatches',_0x5278e4),_0xb79e04),await deleteDoc(_0x29b2ef),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x3a2a29,_0x1df8be]=await Promise[_0x46669c(0x11a)]([getDocs(query(collection(db,'players'),where('username','==',_0x3d82c4['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x3d82c4[_0x46669c(0x117)])))]);if(_0x3a2a29['empty']||_0x1df8be['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x16c3d0=_0x3a2a29[_0x46669c(0x108)][0x0]['id'],_0x183360=_0x1df8be['docs'][0x0]['id'];await updateEloRatings(_0x16c3d0,_0x183360,_0x5278e4);try{console['log']('ðŸŽ¯\x20Awarding\x20match\x20points\x20to\x20winner:\x20'+_0x16c3d0+_0x46669c(0x10a)+_0x183360+',\x20subgame:\x20'+(_0x3d82c4['subgameType']||_0x46669c(0x101)));const _0x3769f4=await awardMatchPoints(_0x16c3d0,_0x183360,_0x3d82c4['subgameType']);_0x3769f4?console['log']('âœ…\x20Match\x20points\x20awarded\x20successfully'):console['warn']('âš ï¸\x20Match\x20points\x20failed\x20to\x20award,\x20but\x20match\x20approval\x20continues');}catch(_0x324e26){console['error']('âŒ\x20Points\x20award\x20error:',_0x324e26);}return console[_0x46669c(0xfc)]('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x502da0){console[_0x46669c(0xfd)]('Error\x20approving\x20report:',_0x502da0);throw _0x502da0;}}async function updatePlayerElo(_0x336060,_0x39821c,_0x1e3ed0){await setDoc(doc(db,'players',_0x336060),{...playerData,'eloRating':_0x1e3ed0}),await checkAndRecordPromotion(_0x336060,_0x1e3ed0,_0x39821c);}function a30_0x49db(){const _0x411591=['log','error','One\x20or\x20both\x20players\x20not\x20found','return\x20(function()\x20','round','Standard','commit','win','{}.constructor(\x22return\x20this\x22)(\x20)','match','pow','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','docs','constructor',',\x20loser:\x20','winnerScore','players','eloRating','losses','exists','wins','totalKills','warn','loserScore','data','totalDeaths','uid','loserUsername','__proto__','position','all','prototype','console','update'];a30_0x49db=function(){return _0x411591;};return a30_0x49db();}async function updatePlayerStats(_0x37e2fc,_0x503080,_0x1d0a6f){const _0x5f01f1=a30_0x1737,_0x28a013=doc(db,'playerStats',_0x37e2fc),_0x1bfe37=await getDoc(_0x28a013);let _0x4eea62=_0x1bfe37[_0x5f01f1(0x10f)]()?_0x1bfe37['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x1d0a6f?(_0x4eea62[_0x5f01f1(0x110)]++,_0x4eea62[_0x5f01f1(0x111)]+=parseInt(_0x503080['winnerScore']||0x0),_0x4eea62['totalDeaths']+=parseInt(_0x503080[_0x5f01f1(0x113)]||0x0)):(_0x4eea62[_0x5f01f1(0x10e)]++,_0x4eea62[_0x5f01f1(0x111)]+=parseInt(_0x503080['loserScore']||0x0),_0x4eea62[_0x5f01f1(0x115)]+=parseInt(_0x503080[_0x5f01f1(0x10b)]||0x0));const _0x44ae72=_0x4eea62[_0x5f01f1(0x110)]+_0x4eea62['losses'];_0x4eea62['winRate']=_0x44ae72>0x0?(_0x4eea62[_0x5f01f1(0x110)]/_0x44ae72*0x64)['toFixed'](0x1):0x0,_0x4eea62['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x28a013,_0x4eea62,{'merge':!![]});}