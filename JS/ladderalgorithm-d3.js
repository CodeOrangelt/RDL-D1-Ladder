const a27_0x228d8c=(function(){let _0x1ec4c3=!![];return function(_0x28261e,_0x53014a){const _0x51f57e=_0x1ec4c3?function(){const _0x27978f=a27_0x2feb;if(_0x53014a){const _0x10cc7e=_0x53014a[_0x27978f(0x16d)](_0x28261e,arguments);return _0x53014a=null,_0x10cc7e;}}:function(){};return _0x1ec4c3=![],_0x51f57e;};}()),a27_0xea6b3e=a27_0x228d8c(this,function(){const _0x295039=a27_0x2feb,_0x33a642=function(){let _0xe85dba;try{_0xe85dba=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x1d9944){_0xe85dba=window;}return _0xe85dba;},_0x1310bb=_0x33a642(),_0x5d56f3=_0x1310bb['console']=_0x1310bb['console']||{},_0x5972d9=[_0x295039(0x178),_0x295039(0x17b),'info','error',_0x295039(0x16c),'table',_0x295039(0x16f)];for(let _0x10a4a5=0x0;_0x10a4a5<_0x5972d9['length'];_0x10a4a5++){const _0x255460=a27_0x228d8c['constructor'][_0x295039(0x177)]['bind'](a27_0x228d8c),_0x3c8886=_0x5972d9[_0x10a4a5],_0x111872=_0x5d56f3[_0x3c8886]||_0x255460;_0x255460['__proto__']=a27_0x228d8c[_0x295039(0x17f)](a27_0x228d8c),_0x255460['toString']=_0x111872['toString']['bind'](_0x111872),_0x5d56f3[_0x3c8886]=_0x255460;}});a27_0xea6b3e();function a27_0x2feb(_0x133fa3,_0x3bb5dc){const _0xea6b3e=a27_0x552b();return a27_0x2feb=function(_0x228d8c,_0x3364c1){_0x228d8c=_0x228d8c-0x167;let _0x552bfe=_0xea6b3e[_0x228d8c];return _0x552bfe;},a27_0x2feb(_0x133fa3,_0x3bb5dc);}import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x23d0aa,_0x5682ab,_0x2daa45=0x20){const _0x450a5d=a27_0x2feb,_0x3f5710=0x1/(0x1+Math[_0x450a5d(0x170)](0xa,(_0x5682ab-_0x23d0aa)/0x190)),_0x4a68ab=0x1/(0x1+Math['pow'](0xa,(_0x23d0aa-_0x5682ab)/0x190)),_0x4f6664=_0x23d0aa+_0x2daa45*(0x1-_0x3f5710),_0x37895a=_0x5682ab+_0x2daa45*(0x0-_0x4a68ab);return{'newWinnerRating':Math['round'](_0x4f6664),'newLoserRating':Math['round'](_0x37895a)};}export async function updateEloRatingsD3(_0x2534b3,_0x4904cc,_0x204138){const _0x598f46=a27_0x2feb;try{const _0x31cc81=writeBatch(db),_0x3fe115=doc(db,'playersD3',_0x2534b3),_0x54937d=doc(db,'playersD3',_0x4904cc),[_0x1b017b,_0x36b3e7]=await Promise['all']([getDoc(_0x3fe115),getDoc(_0x54937d)]);if(!_0x1b017b['exists']()||!_0x36b3e7['exists']())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x218e07=_0x1b017b['data'](),_0x598e79=_0x36b3e7[_0x598f46(0x175)](),_0x51b254=_0x218e07[_0x598f46(0x179)]||Number['MAX_SAFE_INTEGER'],_0x10d34b=_0x598e79['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x227ebc,newLoserRating:_0x2a84a0}=calculateEloD3(_0x218e07['eloRating']||0x4b0,_0x598e79['eloRating']||0x4b0);let _0x94a48b=_0x51b254,_0x4ce7db=_0x10d34b;if(_0x51b254>_0x10d34b){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x94a48b=_0x10d34b,_0x4ce7db=_0x10d34b+0x1;const _0x4c3a5c=query(collection(db,'playersD3'),where('position','>',_0x10d34b),where('position','<',_0x51b254)),_0x439a57=await getDocs(_0x4c3a5c);for(const _0x198ec4 of _0x439a57[_0x598f46(0x173)]){_0x198ec4['id']!==_0x2534b3&&_0x198ec4['id']!==_0x4904cc&&_0x31cc81['update'](doc(db,'playersD3',_0x198ec4['id']),{'position':_0x198ec4['data']()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x31cc81['update'](_0x3fe115,{'eloRating':_0x227ebc,'lastMatchDate':serverTimestamp(),'position':_0x94a48b,'lastMatchId':_0x204138}),_0x31cc81[_0x598f46(0x167)](_0x54937d,{'eloRating':_0x2a84a0,'lastMatchDate':serverTimestamp(),'position':_0x4ce7db,'lastMatchId':_0x204138}),await _0x31cc81[_0x598f46(0x174)](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD3({'playerId':_0x2534b3,'previousElo':_0x218e07[_0x598f46(0x172)]||0x4b0,'newElo':_0x227ebc,'opponentId':_0x4904cc,'matchResult':'win','previousPosition':_0x51b254,'newPosition':_0x94a48b,'isPromotion':_0x94a48b<_0x51b254,'matchId':_0x204138,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x4904cc,'previousElo':_0x598e79[_0x598f46(0x172)]||0x4b0,'newElo':_0x2a84a0,'opponentId':_0x2534b3,'matchResult':'loss','previousPosition':_0x10d34b,'newPosition':_0x4ce7db,'isDemotion':_0x4ce7db>_0x10d34b,'matchId':_0x204138,'timestamp':serverTimestamp()})]),!![];}catch(_0x3d4144){console[_0x598f46(0x17e)](_0x598f46(0x168),_0x3d4144);throw _0x3d4144;}}export async function approveReportD3(_0x28dd61,_0x431bc3,_0x2f6cc8,_0x250ccd){const _0x3f9671=a27_0x2feb;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x28dd61,'winnerScore':_0x431bc3,'winnerSuicides':_0x2f6cc8,'winnerComment':_0x250ccd});const _0x4fdb4d=auth['currentUser'];if(!_0x4fdb4d){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log']('Current\x20user:',_0x4fdb4d[_0x3f9671(0x17a)]);const _0x459933=await getDoc(doc(db,_0x3f9671(0x16a),_0x4fdb4d[_0x3f9671(0x16e)])),_0x5b784a=_0x459933['exists']()?_0x459933[_0x3f9671(0x175)]()['username']:null;console[_0x3f9671(0x178)](_0x3f9671(0x17c),_0x5b784a);const _0x16f933=doc(db,_0x3f9671(0x17d),_0x28dd61),_0x27fcee=await getDoc(_0x16f933);if(!_0x27fcee['exists']()){console['log']('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x28dd61);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x93d683=_0x27fcee['data']();console['log'](_0x3f9671(0x176),_0x93d683);if(_0x5b784a!==_0x93d683[_0x3f9671(0x171)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0xe38f85={..._0x93d683,'winnerScore':_0x431bc3,'winnerSuicides':_0x2f6cc8,'winnerComment':_0x250ccd,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x5b784a,'createdAt':_0x93d683['createdAt']||serverTimestamp(),'winnerUsername':_0x93d683['winnerUsername'],'loserUsername':_0x93d683['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x28dd61),_0xe38f85),await deleteDoc(_0x16f933),console[_0x3f9671(0x178)]('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x2bb63b,_0x515d0e]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where('username','==',_0x93d683['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x3f9671(0x169),'==',_0x93d683[_0x3f9671(0x16b)])))]);if(_0x2bb63b['empty']||_0x515d0e['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x383dde=_0x2bb63b['docs'][0x0]['id'],_0x14e113=_0x515d0e['docs'][0x0]['id'];return await updateEloRatingsD3(_0x383dde,_0x14e113,_0x28dd61),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x2e5e02){console['error']('Error\x20in\x20approveReportD3:',_0x2e5e02);throw _0x2e5e02;}}function a27_0x552b(){const _0x641ae0=['update','Error\x20in\x20updateEloRatingsD3:','username','playersD3','loserUsername','exception','apply','uid','trace','pow','winnerUsername','eloRating','docs','commit','data','D3\x20Report\x20data:','prototype','log','position','email','warn','Current\x20username:','pendingMatchesD3','error','bind'];a27_0x552b=function(){return _0x641ae0;};return a27_0x552b();}