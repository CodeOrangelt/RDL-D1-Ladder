const a29_0x578449=(function(){let _0x4f77e0=!![];return function(_0x2a8082,_0x1bfb69){const _0x2c14ad=_0x4f77e0?function(){const _0x47268a=a29_0x2ee2;if(_0x1bfb69){const _0x5e757c=_0x1bfb69[_0x47268a(0x7b)](_0x2a8082,arguments);return _0x1bfb69=null,_0x5e757c;}}:function(){};return _0x4f77e0=![],_0x2c14ad;};}()),a29_0x42e372=a29_0x578449(this,function(){const _0x5d08ca=a29_0x2ee2,_0x4e8eff=function(){let _0x55802a;try{_0x55802a=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x1becee){_0x55802a=window;}return _0x55802a;},_0x4658fc=_0x4e8eff(),_0x24e73a=_0x4658fc['console']=_0x4658fc[_0x5d08ca(0x6a)]||{},_0x45dd4e=['log','warn','info','error','exception',_0x5d08ca(0x7c),'trace'];for(let _0x324a40=0x0;_0x324a40<_0x45dd4e['length'];_0x324a40++){const _0x2be476=a29_0x578449['constructor']['prototype'][_0x5d08ca(0x7f)](a29_0x578449),_0xbfdb76=_0x45dd4e[_0x324a40],_0x50baf9=_0x24e73a[_0xbfdb76]||_0x2be476;_0x2be476['__proto__']=a29_0x578449['bind'](a29_0x578449),_0x2be476['toString']=_0x50baf9['toString']['bind'](_0x50baf9),_0x24e73a[_0xbfdb76]=_0x2be476;}});a29_0x42e372();import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a29_0x51d2(){const _0x22aeca=['D3\x20ELO\x20ratings\x20updated\x20successfully','loss','console','exists','username','âŒ\x20D3\x20Points\x20award\x20error:','âš ï¸\x20D3\x20Match\x20points\x20failed\x20to\x20award,\x20but\x20match\x20approval\x20continues','docs','commit','winnerUsername','pow','log','playersD3','position','currentUser','email','empty','error','eloRating','apply','table','Current\x20username:','data','bind','D3\x20Match\x20moved\x20to\x20approved\x20collection','Error\x20in\x20approveReportD3:','update'];a29_0x51d2=function(){return _0x22aeca;};return a29_0x51d2();}import{recordEloChangeD3}from'./elo-history-d3.js';function a29_0x2ee2(_0x596af5,_0x3d49d6){const _0x42e372=a29_0x51d2();return a29_0x2ee2=function(_0x578449,_0x558b36){_0x578449=_0x578449-0x68;let _0x51d2ea=_0x42e372[_0x578449];return _0x51d2ea;},a29_0x2ee2(_0x596af5,_0x3d49d6);}import{awardMatchPoints}from'./points-service.js';export function calculateEloD3(_0x2052f7,_0xa24be9,_0x1bfab1=0x20){const _0x3e8802=a29_0x2ee2,_0x5f1d3c=0x1/(0x1+Math[_0x3e8802(0x72)](0xa,(_0xa24be9-_0x2052f7)/0x190)),_0x3ff6af=0x1/(0x1+Math['pow'](0xa,(_0x2052f7-_0xa24be9)/0x190)),_0x3802c3=_0x2052f7+_0x1bfab1*(0x1-_0x5f1d3c),_0x1641c3=_0xa24be9+_0x1bfab1*(0x0-_0x3ff6af);return{'newWinnerRating':Math['round'](_0x3802c3),'newLoserRating':Math['round'](_0x1641c3)};}export async function updateEloRatingsD3(_0xaba513,_0x234737,_0x5c12b9){const _0x2f9c29=a29_0x2ee2;try{const _0x2f6cdf=writeBatch(db),_0x30a0df=doc(db,'playersD3',_0xaba513),_0x2dafa3=doc(db,'playersD3',_0x234737),[_0x49b7e5,_0x477d45]=await Promise['all']([getDoc(_0x30a0df),getDoc(_0x2dafa3)]);if(!_0x49b7e5['exists']()||!_0x477d45[_0x2f9c29(0x6b)]())throw new Error('One\x20or\x20both\x20D3\x20players\x20not\x20found');const _0x51bdae=_0x49b7e5['data'](),_0x52ebcc=_0x477d45[_0x2f9c29(0x7e)](),_0x24d706=_0x51bdae[_0x2f9c29(0x75)]||Number['MAX_SAFE_INTEGER'],_0x5ae3ed=_0x52ebcc['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x230f2d,newLoserRating:_0x488156}=calculateEloD3(_0x51bdae['eloRating']||0x4b0,_0x52ebcc[_0x2f9c29(0x7a)]||0x4b0);let _0xa69532=_0x24d706,_0x19938e=_0x5ae3ed;if(_0x24d706>_0x5ae3ed){console[_0x2f9c29(0x73)]('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0xa69532=_0x5ae3ed,_0x19938e=_0x5ae3ed+0x1;const _0x46b3e7=query(collection(db,_0x2f9c29(0x74)),where('position','>',_0x5ae3ed),where('position','<',_0x24d706)),_0x10dadd=await getDocs(_0x46b3e7);for(const _0xf72da9 of _0x10dadd[_0x2f9c29(0x6f)]){_0xf72da9['id']!==_0xaba513&&_0xf72da9['id']!==_0x234737&&_0x2f6cdf['update'](doc(db,'playersD3',_0xf72da9['id']),{'position':_0xf72da9[_0x2f9c29(0x7e)]()['position']+0x1});}}else console['log']('D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x2f6cdf['update'](_0x30a0df,{'eloRating':_0x230f2d,'lastMatchDate':serverTimestamp(),'position':_0xa69532,'lastMatchId':_0x5c12b9}),_0x2f6cdf[_0x2f9c29(0x82)](_0x2dafa3,{'eloRating':_0x488156,'lastMatchDate':serverTimestamp(),'position':_0x19938e,'lastMatchId':_0x5c12b9}),await _0x2f6cdf[_0x2f9c29(0x70)](),console['log'](_0x2f9c29(0x68)),await Promise['all']([recordEloChangeD3({'playerId':_0xaba513,'previousElo':_0x51bdae['eloRating']||0x4b0,'newElo':_0x230f2d,'opponentId':_0x234737,'matchResult':'win','previousPosition':_0x24d706,'newPosition':_0xa69532,'isPromotion':_0xa69532<_0x24d706,'matchId':_0x5c12b9,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x234737,'previousElo':_0x52ebcc['eloRating']||0x4b0,'newElo':_0x488156,'opponentId':_0xaba513,'matchResult':_0x2f9c29(0x69),'previousPosition':_0x5ae3ed,'newPosition':_0x19938e,'isDemotion':_0x19938e>_0x5ae3ed,'matchId':_0x5c12b9,'timestamp':serverTimestamp()})]),!![];}catch(_0x5142e5){console[_0x2f9c29(0x79)]('Error\x20in\x20updateEloRatingsD3:',_0x5142e5);throw _0x5142e5;}}export async function approveReportD3(_0x3b9b02,_0x55dd01,_0x2f5894,_0x346da9){const _0x1aecf0=a29_0x2ee2;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x3b9b02,'winnerScore':_0x55dd01,'winnerSuicides':_0x2f5894,'winnerComment':_0x346da9});const _0x3ff3d5=auth[_0x1aecf0(0x76)];if(!_0x3ff3d5){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console[_0x1aecf0(0x73)]('Current\x20user:',_0x3ff3d5[_0x1aecf0(0x77)]);const _0x337e65=await getDoc(doc(db,_0x1aecf0(0x74),_0x3ff3d5['uid'])),_0x453dbd=_0x337e65['exists']()?_0x337e65['data']()['username']:null;console[_0x1aecf0(0x73)](_0x1aecf0(0x7d),_0x453dbd);const _0x4ef7b8=doc(db,'pendingMatchesD3',_0x3b9b02),_0x2730d5=await getDoc(_0x4ef7b8);if(!_0x2730d5[_0x1aecf0(0x6b)]()){console[_0x1aecf0(0x73)]('D3\x20Report\x20not\x20found\x20with\x20ID:',_0x3b9b02);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x439a8a=_0x2730d5[_0x1aecf0(0x7e)]();console['log']('D3\x20Report\x20data:',_0x439a8a);if(_0x453dbd!==_0x439a8a[_0x1aecf0(0x71)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches');const _0x3ee9d1={..._0x439a8a,'winnerScore':_0x55dd01,'winnerSuicides':_0x2f5894,'winnerComment':_0x346da9,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x453dbd,'createdAt':_0x439a8a['createdAt']||serverTimestamp(),'winnerUsername':_0x439a8a['winnerUsername'],'loserUsername':_0x439a8a['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x3b9b02),_0x3ee9d1),await deleteDoc(_0x4ef7b8),console['log'](_0x1aecf0(0x80));const [_0x550cfd,_0x3cd9e2]=await Promise['all']([getDocs(query(collection(db,'playersD3'),where(_0x1aecf0(0x6c),'==',_0x439a8a['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x1aecf0(0x6c),'==',_0x439a8a['loserUsername'])))]);if(_0x550cfd[_0x1aecf0(0x78)]||_0x3cd9e2['empty'])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0xa1e3e5=_0x550cfd['docs'][0x0]['id'],_0x5d1bca=_0x3cd9e2['docs'][0x0]['id'];await updateEloRatingsD3(_0xa1e3e5,_0x5d1bca,_0x3b9b02);try{console['log']('ðŸŽ¯\x20Awarding\x20D3\x20match\x20points\x20to\x20winner:\x20'+_0xa1e3e5+',\x20loser:\x20'+_0x5d1bca+',\x20subgame:\x20'+(_0x439a8a['subgameType']||'Standard'));const _0xd2d1d7=await awardMatchPoints(_0xa1e3e5,_0x5d1bca,_0x439a8a['subgameType']);_0xd2d1d7?console[_0x1aecf0(0x73)]('âœ…\x20D3\x20Match\x20points\x20awarded\x20successfully'):console['warn'](_0x1aecf0(0x6e));}catch(_0x449452){console[_0x1aecf0(0x79)](_0x1aecf0(0x6d),_0x449452);}return console[_0x1aecf0(0x73)]('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x24a0e2){console['error'](_0x1aecf0(0x81),_0x24a0e2);throw _0x24a0e2;}}