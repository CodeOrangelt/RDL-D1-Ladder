const a30_0x43cec6=(function(){let _0x373680=!![];return function(_0x2bb83d,_0x10d796){const _0x27bd6d=_0x373680?function(){if(_0x10d796){const _0x32c028=_0x10d796['apply'](_0x2bb83d,arguments);return _0x10d796=null,_0x32c028;}}:function(){};return _0x373680=![],_0x27bd6d;};}()),a30_0x1afa30=a30_0x43cec6(this,function(){const _0x2823dd=a30_0x1cfb,_0x5e0c4d=function(){let _0x255dbc;try{_0x255dbc=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x3a49ea){_0x255dbc=window;}return _0x255dbc;},_0x3e8f28=_0x5e0c4d(),_0x1329dc=_0x3e8f28['console']=_0x3e8f28['console']||{},_0x3e8b62=['log','warn','info',_0x2823dd(0x15c),'exception','table','trace'];for(let _0x15e026=0x0;_0x15e026<_0x3e8b62['length'];_0x15e026++){const _0x209e45=a30_0x43cec6['constructor']['prototype'][_0x2823dd(0x146)](a30_0x43cec6),_0x481e0b=_0x3e8b62[_0x15e026],_0x2a1547=_0x1329dc[_0x481e0b]||_0x209e45;_0x209e45['__proto__']=a30_0x43cec6[_0x2823dd(0x146)](a30_0x43cec6),_0x209e45['toString']=_0x2a1547['toString'][_0x2823dd(0x146)](_0x2a1547),_0x1329dc[_0x481e0b]=_0x209e45;}});a30_0x1afa30();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x2eb8bc,_0x4f7a54,_0x4688e8=0x20){const _0x34ee5f=a30_0x1cfb,_0x29df06=0x1/(0x1+Math[_0x34ee5f(0x15a)](0xa,(_0x4f7a54-_0x2eb8bc)/0x190)),_0x1180f2=0x1/(0x1+Math['pow'](0xa,(_0x2eb8bc-_0x4f7a54)/0x190)),_0x360d4c=_0x2eb8bc+_0x4688e8*(0x1-_0x29df06),_0x342d6a=_0x4f7a54+_0x4688e8*(0x0-_0x1180f2);return{'newWinnerRating':Math['round'](_0x360d4c),'newLoserRating':Math['round'](_0x342d6a)};}export function assignDefaultEloRating(_0x55d484,_0xf2e3c){const _0x46a022=a30_0x1cfb,_0x18139c=0x4b0;!_0xf2e3c['eloRating']&&db['collection'](_0x46a022(0x14c))['doc'](_0x55d484)['update']({'eloRating':_0x18139c})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0xf2e3c['username']);})['catch'](_0x25d9c8=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x25d9c8);});}function a30_0x1cfb(_0x36fc49,_0x514887){const _0x1afa30=a30_0x5cb6();return a30_0x1cfb=function(_0x43cec6,_0x4603fc){_0x43cec6=_0x43cec6-0x145;let _0x5cb6b1=_0x1afa30[_0x43cec6];return _0x5cb6b1;},a30_0x1cfb(_0x36fc49,_0x514887);}export async function updateEloRatings(_0x4ab5a2,_0x5d4fba,_0x1116d1){const _0x2c7ee7=a30_0x1cfb;try{const _0x2ca653=writeBatch(db),_0x6cee5e=doc(db,'players',_0x4ab5a2),_0x323e7f=doc(db,'players',_0x5d4fba),[_0x3a1aeb,_0x3c4902]=await Promise[_0x2c7ee7(0x157)]([getDoc(_0x6cee5e),getDoc(_0x323e7f)]);if(!_0x3a1aeb['exists']()||!_0x3c4902['exists']())throw new Error(_0x2c7ee7(0x154));const _0x124986=_0x3a1aeb['data'](),_0x10c2ab=_0x3c4902[_0x2c7ee7(0x15b)](),_0x5df082=_0x124986['position']||Number[_0x2c7ee7(0x14a)],_0x19a1a7=_0x10c2ab['position']||Number[_0x2c7ee7(0x14a)],{newWinnerRating:_0x455d09,newLoserRating:_0x520933}=calculateElo(_0x124986['eloRating']||0x4b0,_0x10c2ab['eloRating']||0x4b0);let _0x3e1ade=_0x5df082,_0x197a0b=_0x19a1a7;if(_0x5df082>_0x19a1a7){console['log'](_0x2c7ee7(0x158)),_0x3e1ade=_0x19a1a7,_0x197a0b=_0x19a1a7+0x1;const _0x2e7377=query(collection(db,'players'),where('position','>',_0x19a1a7),where(_0x2c7ee7(0x14b),'<',_0x5df082)),_0x1b647c=await getDocs(_0x2e7377);for(const _0x54a243 of _0x1b647c['docs']){_0x54a243['id']!==_0x4ab5a2&&_0x54a243['id']!==_0x5d4fba&&_0x2ca653[_0x2c7ee7(0x149)](doc(db,'players',_0x54a243['id']),{'position':_0x54a243['data']()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x4bcfb5={'eloRating':_0x455d09,'lastMatchDate':serverTimestamp(),'position':_0x3e1ade,'lastMatchId':_0x1116d1},_0x1580e2={'eloRating':_0x520933,'lastMatchDate':serverTimestamp(),'position':_0x197a0b,'lastMatchId':_0x1116d1};return _0x2ca653[_0x2c7ee7(0x149)](_0x6cee5e,_0x4bcfb5),_0x2ca653['update'](_0x323e7f,_0x1580e2),await _0x2ca653['commit'](),console['log'](_0x2c7ee7(0x150)),await Promise['all']([recordEloChange({'playerId':_0x4ab5a2,'previousElo':_0x124986[_0x2c7ee7(0x151)]||0x4b0,'newElo':_0x455d09,'opponentId':_0x5d4fba,'matchResult':'win','previousPosition':_0x5df082,'newPosition':_0x3e1ade,'isPromotion':_0x3e1ade<_0x5df082,'matchId':_0x1116d1,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x5d4fba,'previousElo':_0x10c2ab[_0x2c7ee7(0x151)]||0x4b0,'newElo':_0x520933,'opponentId':_0x4ab5a2,'matchResult':'loss','previousPosition':_0x19a1a7,'newPosition':_0x197a0b,'isDemotion':_0x197a0b>_0x19a1a7,'matchId':_0x1116d1,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x4ab5a2,_0x455d09,_0x124986[_0x2c7ee7(0x151)],{'source':_0x2c7ee7(0x159),'matchId':_0x1116d1}),await promotionManager[_0x2c7ee7(0x156)](_0x5d4fba,_0x520933,_0x10c2ab['eloRating'],{'source':'match','matchId':_0x1116d1}),console[_0x2c7ee7(0x153)](_0x2c7ee7(0x14e)),!![];}catch(_0x4ef4b9){console['error'](_0x2c7ee7(0x152),_0x4ef4b9);throw _0x4ef4b9;}}function a30_0x5cb6(){const _0x171852=['winnerUsername','bind','totalKills','totalDeaths','update','MAX_SAFE_INTEGER','position','players','currentUser','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','winnerScore','ELO\x20ratings\x20updated\x20successfully','eloRating','Error\x20in\x20updateEloRatings:','log','One\x20or\x20both\x20players\x20not\x20found','exists','checkAndRecordPromotion','all','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','match','pow','data','error'];a30_0x5cb6=function(){return _0x171852;};return a30_0x5cb6();}export async function approveReport(_0x3a276f,_0x2fd0f7,_0x1046eb,_0x3fa4fe,_0x93b826){const _0x4a9f4c=a30_0x1cfb;try{const _0x167f0d=doc(db,'pendingMatches',_0x3a276f),_0x3baea7=await getDoc(_0x167f0d);if(!_0x3baea7['exists']())throw new Error('Report\x20not\x20found');const _0x36f338=_0x3baea7['data'](),_0x3373eb={..._0x36f338,'winnerScore':_0x2fd0f7,'winnerSuicides':_0x1046eb,'winnerComment':_0x3fa4fe,'winnerDemoLink':_0x93b826,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth[_0x4a9f4c(0x14d)]['uid']};await setDoc(doc(db,'approvedMatches',_0x3a276f),_0x3373eb),await deleteDoc(_0x167f0d),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x5a2760,_0x2050d2]=await Promise['all']([getDocs(query(collection(db,_0x4a9f4c(0x14c)),where('username','==',_0x36f338[_0x4a9f4c(0x145)]))),getDocs(query(collection(db,_0x4a9f4c(0x14c)),where('username','==',_0x36f338['loserUsername'])))]);if(_0x5a2760['empty']||_0x2050d2['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x3e9b3d=_0x5a2760['docs'][0x0]['id'],_0x452b67=_0x2050d2['docs'][0x0]['id'];await updateEloRatings(_0x3e9b3d,_0x452b67,_0x3a276f);try{await awardMatchPoints(_0x3e9b3d,_0x452b67,_0x36f338['subgameType']);}catch(_0x13d5d5){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x13d5d5);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x284858){console[_0x4a9f4c(0x15c)]('Error\x20approving\x20report:',_0x284858);throw _0x284858;}}async function updatePlayerElo(_0x206845,_0x43abde,_0x15ca38){const _0x5da2c4=a30_0x1cfb;await setDoc(doc(db,_0x5da2c4(0x14c),_0x206845),{...playerData,'eloRating':_0x15ca38}),await checkAndRecordPromotion(_0x206845,_0x15ca38,_0x43abde);}async function updatePlayerStats(_0x36c5e6,_0x4cfb23,_0x1cd7e3){const _0x3ac5d5=a30_0x1cfb,_0x5f2839=doc(db,'playerStats',_0x36c5e6),_0x590de2=await getDoc(_0x5f2839);let _0x3e491c=_0x590de2[_0x3ac5d5(0x155)]()?_0x590de2[_0x3ac5d5(0x15b)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x1cd7e3?(_0x3e491c['wins']++,_0x3e491c[_0x3ac5d5(0x147)]+=parseInt(_0x4cfb23['winnerScore']||0x0),_0x3e491c[_0x3ac5d5(0x148)]+=parseInt(_0x4cfb23['loserScore']||0x0)):(_0x3e491c['losses']++,_0x3e491c['totalKills']+=parseInt(_0x4cfb23['loserScore']||0x0),_0x3e491c['totalDeaths']+=parseInt(_0x4cfb23[_0x3ac5d5(0x14f)]||0x0));const _0x128ae3=_0x3e491c['wins']+_0x3e491c['losses'];_0x3e491c['winRate']=_0x128ae3>0x0?(_0x3e491c['wins']/_0x128ae3*0x64)['toFixed'](0x1):0x0,_0x3e491c['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x5f2839,_0x3e491c,{'merge':!![]});}