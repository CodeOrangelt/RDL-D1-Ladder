const a30_0x34ed13=(function(){let _0x185fed=!![];return function(_0x3ae97b,_0x4de1aa){const _0x3d0f3a=_0x185fed?function(){if(_0x4de1aa){const _0x234f15=_0x4de1aa['apply'](_0x3ae97b,arguments);return _0x4de1aa=null,_0x234f15;}}:function(){};return _0x185fed=![],_0x3d0f3a;};}()),a30_0x14315b=a30_0x34ed13(this,function(){const _0x41baf1=a30_0x1d3c;let _0x174344;try{const _0x5375fd=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x174344=_0x5375fd();}catch(_0x5c679e){_0x174344=window;}const _0x36b183=_0x174344[_0x41baf1(0x11b)]=_0x174344['console']||{},_0x87c435=['log','warn','info','error',_0x41baf1(0x113),'table',_0x41baf1(0x108)];for(let _0x594884=0x0;_0x594884<_0x87c435[_0x41baf1(0x102)];_0x594884++){const _0x3bed3c=a30_0x34ed13['constructor']['prototype']['bind'](a30_0x34ed13),_0x24415d=_0x87c435[_0x594884],_0x147f35=_0x36b183[_0x24415d]||_0x3bed3c;_0x3bed3c[_0x41baf1(0x10b)]=a30_0x34ed13['bind'](a30_0x34ed13),_0x3bed3c[_0x41baf1(0x112)]=_0x147f35['toString']['bind'](_0x147f35),_0x36b183[_0x24415d]=_0x3bed3c;}});a30_0x14315b();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a30_0x98c3(){const _0x1a0ec1=['eloRating','length','empty','error','log','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','players','trace','pow','Error\x20in\x20updateEloRatings:','__proto__','update','data','round','\x20points\x20to\x20both\x20players\x20for\x20','exists','checkAndRecordPromotion','toString','exception','\x20match','Error\x20awarding\x20match\x20points:','totalKills','MAX_SAFE_INTEGER','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','Match\x20moved\x20to\x20approved\x20collection','add','console','subgameType','uid','Match\x20points:\x20','position'];a30_0x98c3=function(){return _0x1a0ec1;};return a30_0x98c3();}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{modifyUserPoints}from'./adminbackend.js';export function calculateElo(_0x351011,_0x4fe3c0,_0x119de6=0x20){const _0x8ded69=a30_0x1d3c,_0x58e606=0x1/(0x1+Math[_0x8ded69(0x109)](0xa,(_0x4fe3c0-_0x351011)/0x190)),_0x3ee49e=0x1/(0x1+Math['pow'](0xa,(_0x351011-_0x4fe3c0)/0x190)),_0x12fd68=_0x351011+_0x119de6*(0x1-_0x58e606),_0x1f7c7d=_0x4fe3c0+_0x119de6*(0x0-_0x3ee49e);return{'newWinnerRating':Math[_0x8ded69(0x10e)](_0x12fd68),'newLoserRating':Math['round'](_0x1f7c7d)};}export function assignDefaultEloRating(_0x4f4e0b,_0x5f30ae){const _0x1b7e15=a30_0x1d3c,_0x1a5916=0x4b0;!_0x5f30ae['eloRating']&&db['collection']('players')['doc'](_0x4f4e0b)[_0x1b7e15(0x10c)]({'eloRating':_0x1a5916})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x5f30ae['username']);})['catch'](_0x15d67f=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x15d67f);});}export async function updateEloRatings(_0x14431d,_0xfc4524,_0x372f13){const _0x3c0e6f=a30_0x1d3c;try{const _0xc00d2c=writeBatch(db),_0x584ee4=doc(db,'players',_0x14431d),_0x26211a=doc(db,_0x3c0e6f(0x107),_0xfc4524),[_0x3385b0,_0x50dc67]=await Promise['all']([getDoc(_0x584ee4),getDoc(_0x26211a)]);if(!_0x3385b0[_0x3c0e6f(0x110)]()||!_0x50dc67['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x41c2c4=_0x3385b0['data'](),_0x135096=_0x50dc67['data'](),_0x273927=_0x41c2c4['position']||Number[_0x3c0e6f(0x117)],_0x595c34=_0x135096['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x22f53b,newLoserRating:_0x4794e9}=calculateElo(_0x41c2c4[_0x3c0e6f(0x101)]||0x4b0,_0x135096['eloRating']||0x4b0);let _0xd767cc=_0x273927,_0x10def5=_0x595c34;if(_0x273927>_0x595c34){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0xd767cc=_0x595c34,_0x10def5=_0x595c34+0x1;const _0x4b8e55=query(collection(db,'players'),where('position','>',_0x595c34),where(_0x3c0e6f(0x11f),'<',_0x273927)),_0x5957bf=await getDocs(_0x4b8e55);for(const _0x1f5638 of _0x5957bf['docs']){_0x1f5638['id']!==_0x14431d&&_0x1f5638['id']!==_0xfc4524&&_0xc00d2c['update'](doc(db,'players',_0x1f5638['id']),{'position':_0x1f5638[_0x3c0e6f(0x10d)]()[_0x3c0e6f(0x11f)]+0x1});}}else console['log'](_0x3c0e6f(0x118));const _0x4cc454={'eloRating':_0x22f53b,'lastMatchDate':serverTimestamp(),'position':_0xd767cc,'lastMatchId':_0x372f13},_0x25f259={'eloRating':_0x4794e9,'lastMatchDate':serverTimestamp(),'position':_0x10def5,'lastMatchId':_0x372f13};return _0xc00d2c['update'](_0x584ee4,_0x4cc454),_0xc00d2c['update'](_0x26211a,_0x25f259),await _0xc00d2c['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x14431d,'previousElo':_0x41c2c4[_0x3c0e6f(0x101)]||0x4b0,'newElo':_0x22f53b,'opponentId':_0xfc4524,'matchResult':'win','previousPosition':_0x273927,'newPosition':_0xd767cc,'isPromotion':_0xd767cc<_0x273927,'matchId':_0x372f13,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0xfc4524,'previousElo':_0x135096[_0x3c0e6f(0x101)]||0x4b0,'newElo':_0x4794e9,'opponentId':_0x14431d,'matchResult':'loss','previousPosition':_0x595c34,'newPosition':_0x10def5,'isDemotion':_0x10def5>_0x595c34,'matchId':_0x372f13,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x14431d,_0x22f53b,_0x41c2c4['eloRating'],{'source':'match','matchId':_0x372f13}),await promotionManager[_0x3c0e6f(0x111)](_0xfc4524,_0x4794e9,_0x135096['eloRating'],{'source':'match','matchId':_0x372f13}),console[_0x3c0e6f(0x105)](_0x3c0e6f(0x106)),!![];}catch(_0x56be65){console[_0x3c0e6f(0x104)](_0x3c0e6f(0x10a),_0x56be65);throw _0x56be65;}}async function awardMatchPoints(_0x533df0,_0x262f92,_0x1c2298){const _0x4a79cb=a30_0x1d3c,_0x1c52b9={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e},_0x23e7c1=_0x1c52b9[_0x1c2298]||0xa;try{return await modifyUserPoints(_0x533df0,_0x4a79cb(0x11a),_0x23e7c1,_0x4a79cb(0x11e)+(_0x1c2298||'Standard')+_0x4a79cb(0x114)),await modifyUserPoints(_0x262f92,_0x4a79cb(0x11a),_0x23e7c1,'Match\x20points:\x20'+(_0x1c2298||'Standard')+'\x20match'),console['log']('Awarded\x20'+_0x23e7c1+_0x4a79cb(0x10f)+(_0x1c2298||'Standard')+'\x20match'),!![];}catch(_0x30ad74){return console['error'](_0x4a79cb(0x115),_0x30ad74),![];}}export async function approveReport(_0x5cdec1,_0x2c88a1,_0x1b5b95,_0x8ce7ca,_0x371047){const _0x11832a=a30_0x1d3c;try{const _0x3a1160=doc(db,'pendingMatches',_0x5cdec1),_0x5abb25=await getDoc(_0x3a1160);if(!_0x5abb25['exists']())throw new Error('Report\x20not\x20found');const _0x2dad23=_0x5abb25[_0x11832a(0x10d)](),_0x45418f={..._0x2dad23,'winnerScore':_0x2c88a1,'winnerSuicides':_0x1b5b95,'winnerComment':_0x8ce7ca,'winnerDemoLink':_0x371047,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x11832a(0x11d)]};await setDoc(doc(db,'approvedMatches',_0x5cdec1),_0x45418f),await deleteDoc(_0x3a1160),console[_0x11832a(0x105)](_0x11832a(0x119));const [_0x277e98,_0x5a7fb5]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x2dad23['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x2dad23['loserUsername'])))]);if(_0x277e98['empty']||_0x5a7fb5[_0x11832a(0x103)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x22b3b9=_0x277e98['docs'][0x0]['id'],_0x454007=_0x5a7fb5['docs'][0x0]['id'];return await updateEloRatings(_0x22b3b9,_0x454007,_0x5cdec1),await awardMatchPoints(_0x22b3b9,_0x454007,_0x2dad23[_0x11832a(0x11c)]),console[_0x11832a(0x105)]('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x1edfc2){console['error']('Error\x20approving\x20report:',_0x1edfc2);throw _0x1edfc2;}}function a30_0x1d3c(_0x5b3a5f,_0x5be6af){const _0x14315b=a30_0x98c3();return a30_0x1d3c=function(_0x34ed13,_0x73ec6d){_0x34ed13=_0x34ed13-0x101;let _0x98c393=_0x14315b[_0x34ed13];return _0x98c393;},a30_0x1d3c(_0x5b3a5f,_0x5be6af);}async function updatePlayerElo(_0x5af151,_0x229701,_0x8eb2a8){const _0x386269=a30_0x1d3c;await setDoc(doc(db,_0x386269(0x107),_0x5af151),{...playerData,'eloRating':_0x8eb2a8}),await checkAndRecordPromotion(_0x5af151,_0x8eb2a8,_0x229701);}async function updatePlayerStats(_0x1905f1,_0x18fb98,_0x5b1c9d){const _0x1d9f69=a30_0x1d3c,_0x3c8466=doc(db,'playerStats',_0x1905f1),_0x44287e=await getDoc(_0x3c8466);let _0x358818=_0x44287e[_0x1d9f69(0x110)]()?_0x44287e['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x5b1c9d?(_0x358818['wins']++,_0x358818['totalKills']+=parseInt(_0x18fb98['winnerScore']||0x0),_0x358818['totalDeaths']+=parseInt(_0x18fb98['loserScore']||0x0)):(_0x358818['losses']++,_0x358818[_0x1d9f69(0x116)]+=parseInt(_0x18fb98['loserScore']||0x0),_0x358818['totalDeaths']+=parseInt(_0x18fb98['winnerScore']||0x0));const _0x2ec20c=_0x358818['wins']+_0x358818['losses'];_0x358818['winRate']=_0x2ec20c>0x0?(_0x358818['wins']/_0x2ec20c*0x64)['toFixed'](0x1):0x0,_0x358818['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x3c8466,_0x358818,{'merge':!![]});}