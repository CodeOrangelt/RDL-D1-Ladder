const a28_0x15ed5e=(function(){let _0x2c6b54=!![];return function(_0x5884f0,_0x48b9ac){const _0x517a3e=_0x2c6b54?function(){if(_0x48b9ac){const _0x1e9b3a=_0x48b9ac['apply'](_0x5884f0,arguments);return _0x48b9ac=null,_0x1e9b3a;}}:function(){};return _0x2c6b54=![],_0x517a3e;};}()),a28_0x201ebd=a28_0x15ed5e(this,function(){const _0x276f89=a28_0x1b7f;let _0x328dc4;try{const _0x43ad69=Function(_0x276f89(0x198)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x328dc4=_0x43ad69();}catch(_0x22415e){_0x328dc4=window;}const _0xc3d036=_0x328dc4['console']=_0x328dc4['console']||{},_0x148e8e=[_0x276f89(0x1a7),'warn','info','error','exception','table','trace'];for(let _0x29488a=0x0;_0x29488a<_0x148e8e[_0x276f89(0x1a6)];_0x29488a++){const _0x42ad73=a28_0x15ed5e['constructor']['prototype']['bind'](a28_0x15ed5e),_0x9fe45f=_0x148e8e[_0x29488a],_0x3f8296=_0xc3d036[_0x9fe45f]||_0x42ad73;_0x42ad73['__proto__']=a28_0x15ed5e['bind'](a28_0x15ed5e),_0x42ad73['toString']=_0x3f8296[_0x276f89(0x189)]['bind'](_0x3f8296),_0xc3d036[_0x9fe45f]=_0x42ad73;}});function a28_0x7783(){const _0x1691e4=['wins','pointsHistory','toString','warn','toISOString','subgameType','playerStats','totalDeaths','displayName','loserScore','commit','unknown','update','all','MAX_SAFE_INTEGER','name','Error\x20approving\x20report:','return\x20(function()\x20','collection','approvedMatches','\x20match\x20(Winner)','totalKills','max','data','Unknown\x20User','losses','username','error','position','docs','players','length','log','pow','toFixed','eloRating'];a28_0x7783=function(){return _0x1691e4;};return a28_0x7783();}function a28_0x1b7f(_0xf86c41,_0x3b8f76){const _0x201ebd=a28_0x7783();return a28_0x1b7f=function(_0x15ed5e,_0x8066dd){_0x15ed5e=_0x15ed5e-0x187;let _0x778370=_0x201ebd[_0x15ed5e];return _0x778370;},a28_0x1b7f(_0xf86c41,_0x3b8f76);}a28_0x201ebd();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{RANKS,getRankStyle}from'./ranks.js';export function calculateElo(_0x108d8e,_0x3fc726,_0x5dd5b3=0x20){const _0x579154=a28_0x1b7f;_0x108d8e=_0x108d8e>0x3e8?0xc8:_0x108d8e,_0x3fc726=_0x3fc726>0x3e8?0xc8:_0x3fc726;const _0x10bdc0=0x1/(0x1+Math['pow'](0xa,(_0x3fc726-_0x108d8e)/0x190)),_0x4af609=0x1/(0x1+Math[_0x579154(0x1a8)](0xa,(_0x108d8e-_0x3fc726)/0x190)),_0x4bc76b=_0x108d8e+_0x5dd5b3*(0x1-_0x10bdc0),_0x8c2f19=_0x3fc726+_0x5dd5b3*(0x0-_0x4af609);return{'newWinnerRating':Math['round'](Math['min'](_0x4bc76b)),'newLoserRating':Math['round'](Math[_0x579154(0x19d)](_0x8c2f19,0x0))};}export function assignDefaultEloRating(_0xc43589,_0x5f5c8f){const _0x134f06=a28_0x1b7f,_0x24a0b7=0xc8;!_0x5f5c8f['eloRating']&&db[_0x134f06(0x199)]('players')['doc'](_0xc43589)[_0x134f06(0x193)]({'eloRating':_0x24a0b7})['then'](()=>{const _0x191b40=_0x134f06;console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x5f5c8f[_0x191b40(0x1a1)]);})['catch'](_0x28b661=>{const _0x52e12c=_0x134f06;console[_0x52e12c(0x1a2)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x28b661);});}export async function updateEloRatings(_0x252de9,_0x1c8663,_0x2646d4){const _0xd27c79=a28_0x1b7f;try{const _0xfa4cc8=writeBatch(db),_0x59a434=doc(db,'players',_0x252de9),_0x4ac707=doc(db,'players',_0x1c8663),[_0x40b726,_0x10df97]=await Promise[_0xd27c79(0x194)]([getDoc(_0x59a434),getDoc(_0x4ac707)]);if(!_0x40b726['exists']()||!_0x10df97['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0xecf8e7=_0x40b726['data'](),_0x1cc11d=_0x10df97[_0xd27c79(0x19e)](),_0x5cf56=_0xecf8e7['position']||Number[_0xd27c79(0x195)],_0x3df001=_0x1cc11d[_0xd27c79(0x1a3)]||Number[_0xd27c79(0x195)],{newWinnerRating:_0x812cff,newLoserRating:_0x19ccd4}=calculateElo(_0xecf8e7[_0xd27c79(0x1aa)]||0x4b0,_0x1cc11d['eloRating']||0x4b0);let _0x32838c=_0x5cf56,_0x1dbc19=_0x3df001;if(_0x5cf56>_0x3df001){console[_0xd27c79(0x1a7)]('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x32838c=_0x3df001,_0x1dbc19=_0x3df001+0x1;const _0x32318c=query(collection(db,'players'),where('position','>',_0x3df001),where('position','<',_0x5cf56)),_0x48ba0c=await getDocs(_0x32318c);for(const _0x7b60f9 of _0x48ba0c[_0xd27c79(0x1a4)]){_0x7b60f9['id']!==_0x252de9&&_0x7b60f9['id']!==_0x1c8663&&_0xfa4cc8['update'](doc(db,'players',_0x7b60f9['id']),{'position':_0x7b60f9['data']()['position']+0x1});}}else console[_0xd27c79(0x1a7)]('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x42ae4c={'eloRating':_0x812cff,'lastMatchDate':serverTimestamp(),'position':_0x32838c,'lastMatchId':_0x2646d4},_0x65cae={'eloRating':_0x19ccd4,'lastMatchDate':serverTimestamp(),'position':_0x1dbc19,'lastMatchId':_0x2646d4};return _0xfa4cc8[_0xd27c79(0x193)](_0x59a434,_0x42ae4c),_0xfa4cc8[_0xd27c79(0x193)](_0x4ac707,_0x65cae),await _0xfa4cc8[_0xd27c79(0x191)](),console[_0xd27c79(0x1a7)]('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x252de9,'previousElo':_0xecf8e7['eloRating']||0x4b0,'newElo':_0x812cff,'opponentId':_0x1c8663,'matchResult':'win','previousPosition':_0x5cf56,'newPosition':_0x32838c,'isPromotion':_0x32838c<_0x5cf56,'matchId':_0x2646d4,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x1c8663,'previousElo':_0x1cc11d['eloRating']||0x4b0,'newElo':_0x19ccd4,'opponentId':_0x252de9,'matchResult':'loss','previousPosition':_0x3df001,'newPosition':_0x1dbc19,'isDemotion':_0x1dbc19>_0x3df001,'matchId':_0x2646d4,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x252de9,_0x812cff,_0xecf8e7[_0xd27c79(0x1aa)],{'source':'match','matchId':_0x2646d4}),await promotionManager['checkAndRecordPromotion'](_0x1c8663,_0x19ccd4,_0x1cc11d[_0xd27c79(0x1aa)],{'source':'match','matchId':_0x2646d4}),console[_0xd27c79(0x1a7)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0xc84c4f){console['error']('Error\x20in\x20updateEloRatings:',_0xc84c4f);throw _0xc84c4f;}}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x48814d,_0x1aaf5f,_0x555648,_0x1d8416,_0x1bbaac){const _0x1e62be=a28_0x1b7f;try{const _0x4f35fc=doc(db,'pendingMatches',_0x48814d),_0x5b5308=await getDoc(_0x4f35fc);if(!_0x5b5308['exists']())throw new Error('Report\x20not\x20found');const _0x158872=_0x5b5308['data'](),_0x1c498c={..._0x158872,'winnerScore':_0x1aaf5f,'winnerSuicides':_0x555648,'winnerComment':_0x1d8416,'winnerDemoLink':_0x1bbaac,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,_0x1e62be(0x19a),_0x48814d),_0x1c498c),await deleteDoc(_0x4f35fc),console[_0x1e62be(0x1a7)]('Match\x20moved\x20to\x20approved\x20collection');const [_0x6ffd37,_0x30c885]=await Promise['all']([getDocs(query(collection(db,_0x1e62be(0x1a5)),where('username','==',_0x158872['winnerUsername']))),getDocs(query(collection(db,'players'),where(_0x1e62be(0x1a1),'==',_0x158872['loserUsername'])))]);if(_0x6ffd37['empty']||_0x30c885['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x6b5c17=_0x6ffd37['docs'][0x0]['id'],_0x396318=_0x30c885[_0x1e62be(0x1a4)][0x0]['id'];await updateEloRatings(_0x6b5c17,_0x396318,_0x48814d);try{const _0x5bc03d=_0x158872[_0x1e62be(0x18c)]||'Standard',_0x552ad4=POINTS_CHART[_0x5bc03d]||0xa,_0x308310=doc(db,'userProfiles',_0x6b5c17),_0x5bdf29=doc(db,'userProfiles',_0x396318),[_0x57e45e,_0x3d1c08]=await Promise['all']([getDoc(_0x308310),getDoc(_0x5bdf29)]);if(_0x57e45e['exists']()&&_0x3d1c08['exists']()){const _0x418f46=_0x57e45e['data'](),_0x143400=_0x3d1c08['data'](),_0x3c4eb8=_0x418f46['points']||0x0,_0x3eb9c9=_0x143400['points']||0x0,_0x261576=_0x3c4eb8+_0x552ad4,_0x3a6b10=_0x3eb9c9+_0x552ad4;await Promise[_0x1e62be(0x194)]([updateDoc(_0x308310,{'points':_0x261576,'lastPointsModified':serverTimestamp()}),updateDoc(_0x5bdf29,{'points':_0x3a6b10,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,_0x1e62be(0x188)),{'userId':_0x6b5c17,'userEmail':_0x418f46['email']||_0x1e62be(0x192),'displayName':_0x418f46[_0x1e62be(0x18f)]||_0x418f46['username']||_0x1e62be(0x19f),'action':'add','amount':_0x552ad4,'previousPoints':_0x3c4eb8,'newPoints':_0x261576,'reason':'Match\x20points:\x20'+_0x5bc03d+_0x1e62be(0x19b),'adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,'pointsHistory'),{'userId':_0x396318,'userEmail':_0x143400['email']||'unknown','displayName':_0x143400[_0x1e62be(0x18f)]||_0x143400[_0x1e62be(0x1a1)]||'Unknown\x20User','action':'add','amount':_0x552ad4,'previousPoints':_0x3eb9c9,'newPoints':_0x3a6b10,'reason':'Match\x20points:\x20'+_0x5bc03d+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log']('Awarded\x20'+_0x552ad4+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x5bc03d+'\x20match');}else console[_0x1e62be(0x18a)]('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x5cca66){console[_0x1e62be(0x18a)]('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x5cca66);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x1a37ca){console['error'](_0x1e62be(0x197),_0x1a37ca);throw _0x1a37ca;}}async function updatePlayerElo(_0x5b7a4e,_0x3fbcbc,_0x4cb699){const _0x495e03=a28_0x1b7f,_0x404875=doc(db,'players',_0x5b7a4e),_0x47ffbc=await getDoc(_0x404875),_0x2e03ea=_0x47ffbc['data'](),_0x353192=doc(db,_0x495e03(0x18d),_0x5b7a4e),_0x1839b4=await getDoc(_0x353192),_0x206fd8=_0x1839b4['data']()||{'totalMatches':0x0,'winRate':0x0},_0x204f92=getRankStyle(_0x4cb699,_0x206fd8['totalMatches'],_0x206fd8['winRate']);await updateDoc(_0x404875,{'eloRating':_0x4cb699,'rank':_0x204f92[_0x495e03(0x196)],'rankColor':_0x204f92['color']}),await checkAndRecordPromotion(_0x5b7a4e,_0x4cb699,_0x3fbcbc,{'matchCount':_0x206fd8['totalMatches'],'winRate':_0x206fd8['winRate']});}async function updatePlayerStats(_0x104954,_0x5585c6,_0x2b3898){const _0x204065=a28_0x1b7f,_0x482776=doc(db,_0x204065(0x18d),_0x104954),_0x388c80=await getDoc(_0x482776);let _0x2db0d2=_0x388c80['exists']()?_0x388c80['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x2b3898?(_0x2db0d2[_0x204065(0x187)]++,_0x2db0d2[_0x204065(0x19c)]+=parseInt(_0x5585c6['winnerScore']||0x0),_0x2db0d2['totalDeaths']+=parseInt(_0x5585c6['loserScore']||0x0)):(_0x2db0d2[_0x204065(0x1a0)]++,_0x2db0d2['totalKills']+=parseInt(_0x5585c6[_0x204065(0x190)]||0x0),_0x2db0d2[_0x204065(0x18e)]+=parseInt(_0x5585c6['winnerScore']||0x0));const _0x47317b=_0x2db0d2['wins']+_0x2db0d2['losses'];_0x2db0d2['winRate']=_0x47317b>0x0?(_0x2db0d2['wins']/_0x47317b*0x64)[_0x204065(0x1a9)](0x1):0x0,_0x2db0d2['lastUpdated']=new Date()[_0x204065(0x18b)](),await setDoc(_0x482776,_0x2db0d2,{'merge':!![]});}