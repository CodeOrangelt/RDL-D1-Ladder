function a30_0x10b0(){const _0x5de4d2=['then','eloRating','pow','position','subgameType','loserScore','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','log','toString','bind','approvedMatches','exists','Could\x20not\x20find\x20player\x20documents','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','__proto__','warn','empty','checkAndRecordPromotion','players','totalKills','win','ELO\x20ratings\x20updated\x20successfully','doc','data','toFixed','collection'];a30_0x10b0=function(){return _0x5de4d2;};return a30_0x10b0();}const a30_0x1d1b5f=(function(){let _0x12fce8=!![];return function(_0x569d59,_0x5026a4){const _0x3c2133=_0x12fce8?function(){if(_0x5026a4){const _0x45903e=_0x5026a4['apply'](_0x569d59,arguments);return _0x5026a4=null,_0x45903e;}}:function(){};return _0x12fce8=![],_0x3c2133;};}()),a30_0x56a683=a30_0x1d1b5f(this,function(){const _0x5ec8d5=a30_0x46be,_0x292cf4=function(){let _0x46065a;try{_0x46065a=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x46e409){_0x46065a=window;}return _0x46065a;},_0x4ad637=_0x292cf4(),_0x5f4749=_0x4ad637['console']=_0x4ad637['console']||{},_0x57ebb7=['log','warn','info','error','exception','table','trace'];for(let _0xba2023=0x0;_0xba2023<_0x57ebb7['length'];_0xba2023++){const _0x499fcc=a30_0x1d1b5f['constructor']['prototype'][_0x5ec8d5(0x1af)](a30_0x1d1b5f),_0x547e6e=_0x57ebb7[_0xba2023],_0x5e88fc=_0x5f4749[_0x547e6e]||_0x499fcc;_0x499fcc[_0x5ec8d5(0x1b4)]=a30_0x1d1b5f['bind'](a30_0x1d1b5f),_0x499fcc['toString']=_0x5e88fc[_0x5ec8d5(0x1ae)][_0x5ec8d5(0x1af)](_0x5e88fc),_0x5f4749[_0x547e6e]=_0x499fcc;}});a30_0x56a683();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x1cc69e,_0x568d6b,_0x13171a=0x20){const _0x4f615d=a30_0x46be,_0xf8b093=0x1/(0x1+Math[_0x4f615d(0x1a8)](0xa,(_0x568d6b-_0x1cc69e)/0x190)),_0x35dd5f=0x1/(0x1+Math[_0x4f615d(0x1a8)](0xa,(_0x1cc69e-_0x568d6b)/0x190)),_0xef1f4a=_0x1cc69e+_0x13171a*(0x1-_0xf8b093),_0x28bc66=_0x568d6b+_0x13171a*(0x0-_0x35dd5f);return{'newWinnerRating':Math['round'](_0xef1f4a),'newLoserRating':Math['round'](_0x28bc66)};}export function assignDefaultEloRating(_0x16c76b,_0x1a9330){const _0x183e75=a30_0x46be,_0x2e0930=0x4b0;!_0x1a9330['eloRating']&&db[_0x183e75(0x1bf)]('players')[_0x183e75(0x1bc)](_0x16c76b)['update']({'eloRating':_0x2e0930})[_0x183e75(0x1a6)](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x1a9330['username']);})['catch'](_0x428f6d=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x428f6d);});}export async function updateEloRatings(_0x230221,_0x452224,_0x1b4f54){const _0x4e6598=a30_0x46be;try{const _0x14c439=writeBatch(db),_0xc9b696=doc(db,_0x4e6598(0x1b8),_0x230221),_0x468c45=doc(db,'players',_0x452224),[_0x3d413e,_0x13f55a]=await Promise['all']([getDoc(_0xc9b696),getDoc(_0x468c45)]);if(!_0x3d413e['exists']()||!_0x13f55a['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x341b9b=_0x3d413e[_0x4e6598(0x1bd)](),_0x1e2f21=_0x13f55a['data'](),_0x287bf6=_0x341b9b['position']||Number['MAX_SAFE_INTEGER'],_0x41e04d=_0x1e2f21['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x3f5ed5,newLoserRating:_0x5041a8}=calculateElo(_0x341b9b[_0x4e6598(0x1a7)]||0x4b0,_0x1e2f21['eloRating']||0x4b0);let _0x148df7=_0x287bf6,_0x4288e0=_0x41e04d;if(_0x287bf6>_0x41e04d){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x148df7=_0x41e04d,_0x4288e0=_0x41e04d+0x1;const _0x1843a4=query(collection(db,_0x4e6598(0x1b8)),where('position','>',_0x41e04d),where('position','<',_0x287bf6)),_0x4f4653=await getDocs(_0x1843a4);for(const _0x1415b4 of _0x4f4653['docs']){_0x1415b4['id']!==_0x230221&&_0x1415b4['id']!==_0x452224&&_0x14c439['update'](doc(db,_0x4e6598(0x1b8),_0x1415b4['id']),{'position':_0x1415b4['data']()[_0x4e6598(0x1a9)]+0x1});}}else console['log'](_0x4e6598(0x1ac));const _0x56c1e0={'eloRating':_0x3f5ed5,'lastMatchDate':serverTimestamp(),'position':_0x148df7,'lastMatchId':_0x1b4f54},_0x33d4a7={'eloRating':_0x5041a8,'lastMatchDate':serverTimestamp(),'position':_0x4288e0,'lastMatchId':_0x1b4f54};return _0x14c439['update'](_0xc9b696,_0x56c1e0),_0x14c439['update'](_0x468c45,_0x33d4a7),await _0x14c439['commit'](),console['log'](_0x4e6598(0x1bb)),await Promise['all']([recordEloChange({'playerId':_0x230221,'previousElo':_0x341b9b['eloRating']||0x4b0,'newElo':_0x3f5ed5,'opponentId':_0x452224,'matchResult':_0x4e6598(0x1ba),'previousPosition':_0x287bf6,'newPosition':_0x148df7,'isPromotion':_0x148df7<_0x287bf6,'matchId':_0x1b4f54,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x452224,'previousElo':_0x1e2f21['eloRating']||0x4b0,'newElo':_0x5041a8,'opponentId':_0x230221,'matchResult':'loss','previousPosition':_0x41e04d,'newPosition':_0x4288e0,'isDemotion':_0x4288e0>_0x41e04d,'matchId':_0x1b4f54,'timestamp':serverTimestamp()})]),await promotionManager[_0x4e6598(0x1b7)](_0x230221,_0x3f5ed5,_0x341b9b[_0x4e6598(0x1a7)],{'source':'match','matchId':_0x1b4f54}),await promotionManager['checkAndRecordPromotion'](_0x452224,_0x5041a8,_0x1e2f21['eloRating'],{'source':'match','matchId':_0x1b4f54}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x31462a){console['error']('Error\x20in\x20updateEloRatings:',_0x31462a);throw _0x31462a;}}export async function approveReport(_0x1c32cb,_0x3d6e31,_0x49e6ad,_0x3fdea2,_0x298b36){const _0x2f7aaa=a30_0x46be;try{const _0x4cb740=doc(db,'pendingMatches',_0x1c32cb),_0x4b5cab=await getDoc(_0x4cb740);if(!_0x4b5cab[_0x2f7aaa(0x1b1)]())throw new Error('Report\x20not\x20found');const _0x34cf24=_0x4b5cab['data'](),_0x1c3921={..._0x34cf24,'winnerScore':_0x3d6e31,'winnerSuicides':_0x49e6ad,'winnerComment':_0x3fdea2,'winnerDemoLink':_0x298b36,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,_0x2f7aaa(0x1b0),_0x1c32cb),_0x1c3921),await deleteDoc(_0x4cb740),console[_0x2f7aaa(0x1ad)]('Match\x20moved\x20to\x20approved\x20collection');const [_0x36c587,_0x210e44]=await Promise['all']([getDocs(query(collection(db,_0x2f7aaa(0x1b8)),where('username','==',_0x34cf24['winnerUsername']))),getDocs(query(collection(db,'players'),where('username','==',_0x34cf24['loserUsername'])))]);if(_0x36c587['empty']||_0x210e44[_0x2f7aaa(0x1b6)])throw new Error(_0x2f7aaa(0x1b2));const _0x99f2ee=_0x36c587['docs'][0x0]['id'],_0x379147=_0x210e44['docs'][0x0]['id'];await updateEloRatings(_0x99f2ee,_0x379147,_0x1c32cb);try{await awardMatchPoints(_0x99f2ee,_0x379147,_0x34cf24[_0x2f7aaa(0x1aa)]);}catch(_0x3af39e){console[_0x2f7aaa(0x1b5)]('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x3af39e);}return console['log'](_0x2f7aaa(0x1b3)),!![];}catch(_0x501723){console['error']('Error\x20approving\x20report:',_0x501723);throw _0x501723;}}function a30_0x46be(_0xe4798c,_0x34e92a){const _0x56a683=a30_0x10b0();return a30_0x46be=function(_0x1d1b5f,_0x4ce505){_0x1d1b5f=_0x1d1b5f-0x1a6;let _0x10b0a3=_0x56a683[_0x1d1b5f];return _0x10b0a3;},a30_0x46be(_0xe4798c,_0x34e92a);}async function updatePlayerElo(_0x280edf,_0x47e156,_0x2afa65){await setDoc(doc(db,'players',_0x280edf),{...playerData,'eloRating':_0x2afa65}),await checkAndRecordPromotion(_0x280edf,_0x2afa65,_0x47e156);}async function updatePlayerStats(_0x62c6f6,_0x3672e3,_0x24f9e5){const _0x4be134=a30_0x46be,_0x3a8b5e=doc(db,'playerStats',_0x62c6f6),_0xd8c5f5=await getDoc(_0x3a8b5e);let _0x25e0a3=_0xd8c5f5['exists']()?_0xd8c5f5['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x24f9e5?(_0x25e0a3['wins']++,_0x25e0a3[_0x4be134(0x1b9)]+=parseInt(_0x3672e3['winnerScore']||0x0),_0x25e0a3['totalDeaths']+=parseInt(_0x3672e3['loserScore']||0x0)):(_0x25e0a3['losses']++,_0x25e0a3['totalKills']+=parseInt(_0x3672e3[_0x4be134(0x1ab)]||0x0),_0x25e0a3['totalDeaths']+=parseInt(_0x3672e3['winnerScore']||0x0));const _0x4ce579=_0x25e0a3['wins']+_0x25e0a3['losses'];_0x25e0a3['winRate']=_0x4ce579>0x0?(_0x25e0a3['wins']/_0x4ce579*0x64)[_0x4be134(0x1be)](0x1):0x0,_0x25e0a3['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x3a8b5e,_0x25e0a3,{'merge':!![]});}