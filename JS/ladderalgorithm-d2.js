const a28_0x52807a=(function(){let _0x44c754=!![];return function(_0x3db8bc,_0x5dd12c){const _0x551594=_0x44c754?function(){if(_0x5dd12c){const _0x4be934=_0x5dd12c['apply'](_0x3db8bc,arguments);return _0x5dd12c=null,_0x4be934;}}:function(){};return _0x44c754=![],_0x551594;};}()),a28_0x31a112=a28_0x52807a(this,function(){const _0xaf93f=a28_0x3ad4,_0x4ed926=function(){let _0x24db2c;try{_0x24db2c=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x15e7f6){_0x24db2c=window;}return _0x24db2c;},_0x381f73=_0x4ed926(),_0x1a09e4=_0x381f73['console']=_0x381f73['console']||{},_0x976019=['log','warn',_0xaf93f(0x1ec),'error','exception','table','trace'];for(let _0x2ce5e5=0x0;_0x2ce5e5<_0x976019['length'];_0x2ce5e5++){const _0x514a60=a28_0x52807a['constructor']['prototype']['bind'](a28_0x52807a),_0x548325=_0x976019[_0x2ce5e5],_0x4a16c2=_0x1a09e4[_0x548325]||_0x514a60;_0x514a60['__proto__']=a28_0x52807a[_0xaf93f(0x1f1)](a28_0x52807a),_0x514a60['toString']=_0x4a16c2['toString']['bind'](_0x4a16c2),_0x1a09e4[_0x548325]=_0x514a60;}});a28_0x31a112();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x3ad4(_0x1ebbe4,_0x1eb634){const _0x31a112=a28_0x33e4();return a28_0x3ad4=function(_0x52807a,_0x5b39dd){_0x52807a=_0x52807a-0x1e5;let _0x33e46c=_0x31a112[_0x52807a];return _0x33e46c;},a28_0x3ad4(_0x1ebbe4,_0x1eb634);}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a28_0x33e4(){const _0x398ee2=['data','winnerUsername','docs','pow','playersD2','D2\x20match\x20report\x20not\x20found','log','info','checkAndRecordPromotion','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','position','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','bind','eloRating','D2\x20Report\x20not\x20found\x20with\x20ID:','Could\x20not\x20find\x20D2\x20player\x20documents','all','match-d2','D2\x20Report\x20data:'];a28_0x33e4=function(){return _0x398ee2;};return a28_0x33e4();}import a28_0x46107e from'./firebase-idle-wrapper.js';export function calculateEloD2(_0xa1fc13,_0x47e397,_0x324d29=0x20){const _0x51a724=a28_0x3ad4,_0x59d9b8=0x1/(0x1+Math['pow'](0xa,(_0x47e397-_0xa1fc13)/0x190)),_0x58ee34=0x1/(0x1+Math[_0x51a724(0x1e8)](0xa,(_0xa1fc13-_0x47e397)/0x190)),_0x5bfe50=_0xa1fc13+_0x324d29*(0x1-_0x59d9b8),_0xbcb886=_0x47e397+_0x324d29*(0x0-_0x58ee34);return{'newWinnerRating':Math['round'](_0x5bfe50),'newLoserRating':Math['round'](_0xbcb886)};}export async function updateEloRatingsD2(_0xd8a978,_0x11203c,_0x55ca23){const _0x1d6347=a28_0x3ad4;try{const _0x13f2c6=writeBatch(db),_0x24fdcb=doc(db,'playersD2',_0xd8a978),_0x664991=doc(db,_0x1d6347(0x1e9),_0x11203c),[_0x2fe846,_0xf09825]=await Promise['all']([getDoc(_0x24fdcb),getDoc(_0x664991)]);if(!_0x2fe846['exists']()||!_0xf09825['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x5658e0=_0x2fe846[_0x1d6347(0x1e5)](),_0x412cd2=_0xf09825['data'](),_0x1d6123=_0x5658e0['position']||Number['MAX_SAFE_INTEGER'],_0x32eaf3=_0x412cd2['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x1a899d,newLoserRating:_0x1f5a63}=calculateEloD2(_0x5658e0['eloRating']||0x4b0,_0x412cd2[_0x1d6347(0x1f2)]||0x4b0);let _0xe4a496=_0x1d6123,_0x785bd=_0x32eaf3;if(_0x1d6123>_0x32eaf3){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0xe4a496=_0x32eaf3,_0x785bd=_0x32eaf3+0x1;const _0x51af0a=query(collection(db,_0x1d6347(0x1e9)),where('position','>',_0x32eaf3),where('position','<',_0x1d6123)),_0x435587=await getDocs(_0x51af0a);for(const _0x212500 of _0x435587['docs']){_0x212500['id']!==_0xd8a978&&_0x212500['id']!==_0x11203c&&_0x13f2c6['update'](doc(db,'playersD2',_0x212500['id']),{'position':_0x212500[_0x1d6347(0x1e5)]()[_0x1d6347(0x1ef)]+0x1});}}else console[_0x1d6347(0x1eb)](_0x1d6347(0x1ee));return _0x13f2c6['update'](_0x24fdcb,{'eloRating':_0x1a899d,'lastMatchDate':serverTimestamp(),'position':_0xe4a496,'lastMatchId':_0x55ca23}),_0x13f2c6['update'](_0x664991,{'eloRating':_0x1f5a63,'lastMatchDate':serverTimestamp(),'position':_0x785bd,'lastMatchId':_0x55ca23}),await _0x13f2c6['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0xd8a978,'previousElo':_0x5658e0[_0x1d6347(0x1f2)]||0x4b0,'newElo':_0x1a899d,'opponentId':_0x11203c,'matchResult':'win','previousPosition':_0x1d6123,'newPosition':_0xe4a496,'isPromotion':_0xe4a496<_0x1d6123,'matchId':_0x55ca23,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x11203c,'previousElo':_0x412cd2['eloRating']||0x4b0,'newElo':_0x1f5a63,'opponentId':_0xd8a978,'matchResult':'loss','previousPosition':_0x32eaf3,'newPosition':_0x785bd,'isDemotion':_0x785bd>_0x32eaf3,'matchId':_0x55ca23,'timestamp':serverTimestamp()})]),await promotionManager[_0x1d6347(0x1ed)](_0xd8a978,_0x1a899d,_0x5658e0[_0x1d6347(0x1f2)],{'source':_0x1d6347(0x1f6),'matchId':_0x55ca23}),await promotionManager[_0x1d6347(0x1ed)](_0x11203c,_0x1f5a63,_0x412cd2['eloRating'],{'source':'match-d2','matchId':_0x55ca23}),!![];}catch(_0x3f2a64){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x3f2a64);throw _0x3f2a64;}}export async function approveReportD2(_0x5930e1,_0x5de5d7,_0x46b891,_0x29d5ea){const _0x3023c0=a28_0x3ad4;try{console[_0x3023c0(0x1eb)]('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x5930e1,'winnerScore':_0x5de5d7,'winnerSuicides':_0x46b891,'winnerComment':_0x29d5ea});const _0x40b76e=auth['currentUser'];if(!_0x40b76e){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console[_0x3023c0(0x1eb)]('Current\x20user:',_0x40b76e['email']);const _0x329f7f=await getDoc(doc(db,'playersD2',_0x40b76e['uid'])),_0x298271=_0x329f7f['exists']()?_0x329f7f[_0x3023c0(0x1e5)]()['username']:null;console['log']('Current\x20username:',_0x298271);const _0x30d220=doc(db,'pendingMatchesD2',_0x5930e1),_0x337c89=await getDoc(_0x30d220);if(!_0x337c89['exists']()){console['log'](_0x3023c0(0x1f3),_0x5930e1);throw new Error(_0x3023c0(0x1ea));}const _0x125c2b=_0x337c89['data']();console[_0x3023c0(0x1eb)](_0x3023c0(0x1f7),_0x125c2b);if(_0x298271!==_0x125c2b['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x58e77b={..._0x125c2b,'winnerScore':_0x5de5d7,'winnerSuicides':_0x46b891,'winnerComment':_0x29d5ea,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x298271,'createdAt':_0x125c2b['createdAt']||serverTimestamp(),'winnerUsername':_0x125c2b[_0x3023c0(0x1e6)],'loserUsername':_0x125c2b['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x5930e1),_0x58e77b),await deleteDoc(_0x30d220),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x22f9bd,_0x190ffc]=await Promise[_0x3023c0(0x1f5)]([getDocs(query(collection(db,_0x3023c0(0x1e9)),where('username','==',_0x125c2b['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x125c2b['loserUsername'])))]);if(_0x22f9bd['empty']||_0x190ffc['empty'])throw new Error(_0x3023c0(0x1f4));const _0x1fba9a=_0x22f9bd[_0x3023c0(0x1e7)][0x0]['id'],_0x1d464d=_0x190ffc['docs'][0x0]['id'];return await updateEloRatingsD2(_0x1fba9a,_0x1d464d,_0x5930e1),console['log'](_0x3023c0(0x1f0)),!![];}catch(_0x442a10){console['error']('Error\x20in\x20approveReportD2:',_0x442a10);throw _0x442a10;}}