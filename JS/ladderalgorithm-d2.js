const a28_0x3f689f=(function(){let _0x3f9a14=!![];return function(_0x37e663,_0x3b2685){const _0x6bb0a8=_0x3f9a14?function(){if(_0x3b2685){const _0x3ce9ee=_0x3b2685['apply'](_0x37e663,arguments);return _0x3b2685=null,_0x3ce9ee;}}:function(){};return _0x3f9a14=![],_0x6bb0a8;};}()),a28_0x526121=a28_0x3f689f(this,function(){const _0x5758fe=a28_0x4ac0;let _0x25b414;try{const _0x34f61a=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x25b414=_0x34f61a();}catch(_0x416afc){_0x25b414=window;}const _0x2ba11b=_0x25b414[_0x5758fe(0x140)]=_0x25b414['console']||{},_0x106be8=['log','warn',_0x5758fe(0x139),'error',_0x5758fe(0x12d),_0x5758fe(0x134),_0x5758fe(0x13a)];for(let _0x3b3c2d=0x0;_0x3b3c2d<_0x106be8['length'];_0x3b3c2d++){const _0x51c672=a28_0x3f689f['constructor']['prototype']['bind'](a28_0x3f689f),_0xaf1de7=_0x106be8[_0x3b3c2d],_0x349964=_0x2ba11b[_0xaf1de7]||_0x51c672;_0x51c672['__proto__']=a28_0x3f689f['bind'](a28_0x3f689f),_0x51c672[_0x5758fe(0x13f)]=_0x349964['toString']['bind'](_0x349964),_0x2ba11b[_0xaf1de7]=_0x51c672;}});a28_0x526121();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x594579 from'./firebase-idle-wrapper.js';function a28_0x4ac0(_0x13de94,_0x287c07){const _0x526121=a28_0x1601();return a28_0x4ac0=function(_0x3f689f,_0x24d3e7){_0x3f689f=_0x3f689f-0x12d;let _0x160120=_0x526121[_0x3f689f];return _0x160120;},a28_0x4ac0(_0x13de94,_0x287c07);}export function calculateEloD2(_0x252317,_0x17deb2,_0x4d1fcb=0x20){const _0x49690f=a28_0x4ac0,_0x2250f8=0x1/(0x1+Math['pow'](0xa,(_0x17deb2-_0x252317)/0x190)),_0x4c8359=0x1/(0x1+Math[_0x49690f(0x131)](0xa,(_0x252317-_0x17deb2)/0x190)),_0x15af68=_0x252317+_0x4d1fcb*(0x1-_0x2250f8),_0x4414c5=_0x17deb2+_0x4d1fcb*(0x0-_0x4c8359);return{'newWinnerRating':Math[_0x49690f(0x135)](_0x15af68),'newLoserRating':Math['round'](_0x4414c5)};}export async function updateEloRatingsD2(_0xb07f3f,_0x10b3b1,_0xc7ac4){const _0x17a22f=a28_0x4ac0;try{const _0x49087a=writeBatch(db),_0x3d4bd0=doc(db,_0x17a22f(0x13e),_0xb07f3f),_0x596012=doc(db,'playersD2',_0x10b3b1),[_0x3795b4,_0x526b86]=await Promise['all']([getDoc(_0x3d4bd0),getDoc(_0x596012)]);if(!_0x3795b4[_0x17a22f(0x144)]()||!_0x526b86['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x4e42ae=_0x3795b4['data'](),_0x286edd=_0x526b86['data'](),_0x530eea=_0x4e42ae['position']||Number['MAX_SAFE_INTEGER'],_0x27770c=_0x286edd['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x3f2427,newLoserRating:_0x5f1e15}=calculateEloD2(_0x4e42ae['eloRating']||0x4b0,_0x286edd[_0x17a22f(0x133)]||0x4b0);let _0xa5ab77=_0x530eea,_0x91ef78=_0x27770c;if(_0x530eea>_0x27770c){console[_0x17a22f(0x12e)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0xa5ab77=_0x27770c,_0x91ef78=_0x27770c+0x1;const _0x1b4729=query(collection(db,_0x17a22f(0x13e)),where('position','>',_0x27770c),where(_0x17a22f(0x13d),'<',_0x530eea)),_0x5c6436=await getDocs(_0x1b4729);for(const _0x1ca265 of _0x5c6436['docs']){_0x1ca265['id']!==_0xb07f3f&&_0x1ca265['id']!==_0x10b3b1&&_0x49087a['update'](doc(db,'playersD2',_0x1ca265['id']),{'position':_0x1ca265['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x49087a['update'](_0x3d4bd0,{'eloRating':_0x3f2427,'lastMatchDate':serverTimestamp(),'position':_0xa5ab77,'lastMatchId':_0xc7ac4}),_0x49087a['update'](_0x596012,{'eloRating':_0x5f1e15,'lastMatchDate':serverTimestamp(),'position':_0x91ef78,'lastMatchId':_0xc7ac4}),await _0x49087a['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x17a22f(0x136)]([recordEloChangeD2({'playerId':_0xb07f3f,'previousElo':_0x4e42ae['eloRating']||0x4b0,'newElo':_0x3f2427,'opponentId':_0x10b3b1,'matchResult':'win','previousPosition':_0x530eea,'newPosition':_0xa5ab77,'isPromotion':_0xa5ab77<_0x530eea,'matchId':_0xc7ac4,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x10b3b1,'previousElo':_0x286edd[_0x17a22f(0x133)]||0x4b0,'newElo':_0x5f1e15,'opponentId':_0xb07f3f,'matchResult':'loss','previousPosition':_0x27770c,'newPosition':_0x91ef78,'isDemotion':_0x91ef78>_0x27770c,'matchId':_0xc7ac4,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0xb07f3f,_0x3f2427,_0x4e42ae['eloRating'],{'source':'match-d2','matchId':_0xc7ac4}),await promotionManager['checkAndRecordPromotion'](_0x10b3b1,_0x5f1e15,_0x286edd[_0x17a22f(0x133)],{'source':_0x17a22f(0x12f),'matchId':_0xc7ac4}),!![];}catch(_0x59823b){console[_0x17a22f(0x132)]('Error\x20in\x20updateEloRatingsD2:',_0x59823b);throw _0x59823b;}}export async function approveReportD2(_0x780787,_0x5517aa,_0x4c0464,_0x4a551f){const _0x5a58ab=a28_0x4ac0;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x780787,'winnerScore':_0x5517aa,'winnerSuicides':_0x4c0464,'winnerComment':_0x4a551f});const _0x58e660=auth['currentUser'];if(!_0x58e660){console['log']('No\x20user\x20logged\x20in');throw new Error(_0x5a58ab(0x130));}console['log']('Current\x20user:',_0x58e660['email']);const _0x503132=await getDoc(doc(db,'playersD2',_0x58e660[_0x5a58ab(0x143)])),_0x346369=_0x503132[_0x5a58ab(0x144)]()?_0x503132['data']()['username']:null;console[_0x5a58ab(0x12e)]('Current\x20username:',_0x346369);const _0x31405f=doc(db,_0x5a58ab(0x13b),_0x780787),_0xae473=await getDoc(_0x31405f);if(!_0xae473['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x780787);throw new Error(_0x5a58ab(0x138));}const _0xd1689=_0xae473['data']();console[_0x5a58ab(0x12e)]('D2\x20Report\x20data:',_0xd1689);if(_0x346369!==_0xd1689['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x44962b={..._0xd1689,'winnerScore':_0x5517aa,'winnerSuicides':_0x4c0464,'winnerComment':_0x4a551f,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x346369,'createdAt':_0xd1689[_0x5a58ab(0x13c)]||serverTimestamp(),'winnerUsername':_0xd1689['winnerUsername'],'loserUsername':_0xd1689[_0x5a58ab(0x137)]};await setDoc(doc(db,'approvedMatchesD2',_0x780787),_0x44962b),await deleteDoc(_0x31405f),console['log']('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x52a1fc,_0x57c976]=await Promise[_0x5a58ab(0x136)]([getDocs(query(collection(db,'playersD2'),where(_0x5a58ab(0x141),'==',_0xd1689['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0xd1689['loserUsername'])))]);if(_0x52a1fc[_0x5a58ab(0x142)]||_0x57c976['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x49c09d=_0x52a1fc['docs'][0x0]['id'],_0x1504af=_0x57c976[_0x5a58ab(0x145)][0x0]['id'];return await updateEloRatingsD2(_0x49c09d,_0x1504af,_0x780787),console[_0x5a58ab(0x12e)]('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x3f41ab){console['error']('Error\x20in\x20approveReportD2:',_0x3f41ab);throw _0x3f41ab;}}function a28_0x1601(){const _0x2ad27c=['exception','log','match-d2','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','pow','error','eloRating','table','round','all','loserUsername','D2\x20match\x20report\x20not\x20found','info','trace','pendingMatchesD2','createdAt','position','playersD2','toString','console','username','empty','uid','exists','docs'];a28_0x1601=function(){return _0x2ad27c;};return a28_0x1601();}