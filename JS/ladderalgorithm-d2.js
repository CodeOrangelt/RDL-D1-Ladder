const a28_0x38722e=(function(){let _0xc744ba=!![];return function(_0x2f5677,_0x258016){const _0x2e0957=_0xc744ba?function(){const _0x342da1=a28_0xde3d;if(_0x258016){const _0x2b782c=_0x258016[_0x342da1(0xf0)](_0x2f5677,arguments);return _0x258016=null,_0x2b782c;}}:function(){};return _0xc744ba=![],_0x2e0957;};}()),a28_0x2593b7=a28_0x38722e(this,function(){const _0x2115fd=a28_0xde3d,_0x3ade59=function(){const _0x544e82=a28_0xde3d;let _0x5dcfb2;try{_0x5dcfb2=Function('return\x20(function()\x20'+_0x544e82(0xec)+');')();}catch(_0x2ae8e3){_0x5dcfb2=window;}return _0x5dcfb2;},_0xb4ea1b=_0x3ade59(),_0x5f051a=_0xb4ea1b[_0x2115fd(0xe7)]=_0xb4ea1b['console']||{},_0x2ba906=['log',_0x2115fd(0x103),'info','error','exception',_0x2115fd(0xfd),'trace'];for(let _0x4d02e4=0x0;_0x4d02e4<_0x2ba906['length'];_0x4d02e4++){const _0x394c1d=a28_0x38722e[_0x2115fd(0xe6)][_0x2115fd(0xf9)]['bind'](a28_0x38722e),_0x5b88e9=_0x2ba906[_0x4d02e4],_0x35df81=_0x5f051a[_0x5b88e9]||_0x394c1d;_0x394c1d['__proto__']=a28_0x38722e['bind'](a28_0x38722e),_0x394c1d['toString']=_0x35df81[_0x2115fd(0xfe)][_0x2115fd(0xed)](_0x35df81),_0x5f051a[_0x5b88e9]=_0x394c1d;}});a28_0x2593b7();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x3c89(){const _0x4cdb55=['uid','pendingMatchesD2','constructor','console','D2\x20Report\x20not\x20found\x20with\x20ID:','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','exists','Starting\x20approveReportD2\x20function\x20with:','{}.constructor(\x22return\x20this\x22)(\x20)','bind','round','eloRating','apply','error','empty','Could\x20not\x20find\x20D2\x20player\x20documents','log','Error\x20in\x20updateEloRatingsD2:','email','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','playersD2','prototype','MAX_SAFE_INTEGER','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','No\x20user\x20logged\x20in','table','toString','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','data','position','D2\x20Match\x20moved\x20to\x20approved\x20collection','warn'];a28_0x3c89=function(){return _0x4cdb55;};return a28_0x3c89();}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x1cccae from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x4c661f,_0x2e5a65,_0x329994=0x20){const _0x5702b2=a28_0xde3d,_0x6805ce=0x1/(0x1+Math['pow'](0xa,(_0x2e5a65-_0x4c661f)/0x190)),_0x49c6a6=0x1/(0x1+Math['pow'](0xa,(_0x4c661f-_0x2e5a65)/0x190)),_0x51789b=_0x4c661f+_0x329994*(0x1-_0x6805ce),_0x5ca684=_0x2e5a65+_0x329994*(0x0-_0x49c6a6);return{'newWinnerRating':Math['round'](_0x51789b),'newLoserRating':Math[_0x5702b2(0xee)](_0x5ca684)};}export async function updateEloRatingsD2(_0x28adb4,_0x3a7bac,_0x5be8f3){const _0x3e6649=a28_0xde3d;try{const _0x3d597f=writeBatch(db),_0x43079d=doc(db,_0x3e6649(0xf8),_0x28adb4),_0x439a50=doc(db,'playersD2',_0x3a7bac),[_0x222107,_0x5309af]=await Promise['all']([getDoc(_0x43079d),getDoc(_0x439a50)]);if(!_0x222107[_0x3e6649(0xea)]()||!_0x5309af[_0x3e6649(0xea)]())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x1e91d0=_0x222107['data'](),_0x3eb3b7=_0x5309af[_0x3e6649(0x100)](),_0x3a59e1=_0x1e91d0['position']||Number[_0x3e6649(0xfa)],_0x12c7f4=_0x3eb3b7['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x4910d4,newLoserRating:_0x209231}=calculateEloD2(_0x1e91d0['eloRating']||0x4b0,_0x3eb3b7['eloRating']||0x4b0);let _0x1808f5=_0x3a59e1,_0x370581=_0x12c7f4;if(_0x3a59e1>_0x12c7f4){console[_0x3e6649(0xf4)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x1808f5=_0x12c7f4,_0x370581=_0x12c7f4+0x1;const _0x3e6fcb=query(collection(db,'playersD2'),where(_0x3e6649(0x101),'>',_0x12c7f4),where('position','<',_0x3a59e1)),_0x40b729=await getDocs(_0x3e6fcb);for(const _0x44e15f of _0x40b729['docs']){_0x44e15f['id']!==_0x28adb4&&_0x44e15f['id']!==_0x3a7bac&&_0x3d597f['update'](doc(db,'playersD2',_0x44e15f['id']),{'position':_0x44e15f['data']()['position']+0x1});}}else console[_0x3e6649(0xf4)](_0x3e6649(0xe9));return _0x3d597f['update'](_0x43079d,{'eloRating':_0x4910d4,'lastMatchDate':serverTimestamp(),'position':_0x1808f5,'lastMatchId':_0x5be8f3}),_0x3d597f['update'](_0x439a50,{'eloRating':_0x209231,'lastMatchDate':serverTimestamp(),'position':_0x370581,'lastMatchId':_0x5be8f3}),await _0x3d597f['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x28adb4,'previousElo':_0x1e91d0['eloRating']||0x4b0,'newElo':_0x4910d4,'opponentId':_0x3a7bac,'matchResult':'win','previousPosition':_0x3a59e1,'newPosition':_0x1808f5,'isPromotion':_0x1808f5<_0x3a59e1,'matchId':_0x5be8f3,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x3a7bac,'previousElo':_0x3eb3b7[_0x3e6649(0xef)]||0x4b0,'newElo':_0x209231,'opponentId':_0x28adb4,'matchResult':'loss','previousPosition':_0x12c7f4,'newPosition':_0x370581,'isDemotion':_0x370581>_0x12c7f4,'matchId':_0x5be8f3,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x28adb4,_0x4910d4,_0x1e91d0[_0x3e6649(0xef)],{'source':'match-d2','matchId':_0x5be8f3}),await promotionManager['checkAndRecordPromotion'](_0x3a7bac,_0x209231,_0x3eb3b7['eloRating'],{'source':'match-d2','matchId':_0x5be8f3}),!![];}catch(_0x1f0efc){console[_0x3e6649(0xf1)](_0x3e6649(0xf5),_0x1f0efc);throw _0x1f0efc;}}function a28_0xde3d(_0x2e4f0d,_0x46645a){const _0x2593b7=a28_0x3c89();return a28_0xde3d=function(_0x38722e,_0x4dc4c1){_0x38722e=_0x38722e-0xe4;let _0x3c89be=_0x2593b7[_0x38722e];return _0x3c89be;},a28_0xde3d(_0x2e4f0d,_0x46645a);}export async function approveReportD2(_0x231321,_0x14040d,_0xe57829,_0x197b39){const _0x5c0eb0=a28_0xde3d;try{console['log'](_0x5c0eb0(0xeb),{'reportId':_0x231321,'winnerScore':_0x14040d,'winnerSuicides':_0xe57829,'winnerComment':_0x197b39});const _0x1dc1ef=auth['currentUser'];if(!_0x1dc1ef){console['log'](_0x5c0eb0(0xfc));throw new Error(_0x5c0eb0(0xf7));}console['log']('Current\x20user:',_0x1dc1ef[_0x5c0eb0(0xf6)]);const _0x154d12=await getDoc(doc(db,'playersD2',_0x1dc1ef[_0x5c0eb0(0xe4)])),_0x12f4cf=_0x154d12[_0x5c0eb0(0xea)]()?_0x154d12[_0x5c0eb0(0x100)]()['username']:null;console[_0x5c0eb0(0xf4)]('Current\x20username:',_0x12f4cf);const _0x28bbaf=doc(db,_0x5c0eb0(0xe5),_0x231321),_0x53425e=await getDoc(_0x28bbaf);if(!_0x53425e['exists']()){console['log'](_0x5c0eb0(0xe8),_0x231321);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x3e05d1=_0x53425e[_0x5c0eb0(0x100)]();console['log']('D2\x20Report\x20data:',_0x3e05d1);if(_0x12f4cf!==_0x3e05d1['winnerUsername'])throw new Error(_0x5c0eb0(0xfb));const _0x1a908d={..._0x3e05d1,'winnerScore':_0x14040d,'winnerSuicides':_0xe57829,'winnerComment':_0x197b39,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x12f4cf,'createdAt':_0x3e05d1['createdAt']||serverTimestamp(),'winnerUsername':_0x3e05d1['winnerUsername'],'loserUsername':_0x3e05d1['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x231321),_0x1a908d),await deleteDoc(_0x28bbaf),console['log'](_0x5c0eb0(0x102));const [_0x28460b,_0x99827f]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x3e05d1['winnerUsername']))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x3e05d1['loserUsername'])))]);if(_0x28460b[_0x5c0eb0(0xf2)]||_0x99827f['empty'])throw new Error(_0x5c0eb0(0xf3));const _0x2b4a3f=_0x28460b['docs'][0x0]['id'],_0x485cbf=_0x99827f['docs'][0x0]['id'];return await updateEloRatingsD2(_0x2b4a3f,_0x485cbf,_0x231321),console['log'](_0x5c0eb0(0xff)),!![];}catch(_0x6882a3){console['error']('Error\x20in\x20approveReportD2:',_0x6882a3);throw _0x6882a3;}}