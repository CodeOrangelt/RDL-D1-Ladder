const a26_0x422db3=(function(){let _0x20efc4=!![];return function(_0x500f58,_0xa1f9cb){const _0x317f25=_0x20efc4?function(){if(_0xa1f9cb){const _0x2a6522=_0xa1f9cb['apply'](_0x500f58,arguments);return _0xa1f9cb=null,_0x2a6522;}}:function(){};return _0x20efc4=![],_0x317f25;};}()),a26_0x5f13f1=a26_0x422db3(this,function(){const _0x3c25ab=a26_0x49b5;let _0x3bb7df;try{const _0x424801=Function(_0x3c25ab(0x192)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x3bb7df=_0x424801();}catch(_0x51c0f8){_0x3bb7df=window;}const _0x435a83=_0x3bb7df['console']=_0x3bb7df['console']||{},_0x59190=['log',_0x3c25ab(0x1a1),'info',_0x3c25ab(0x1a7),'exception','table',_0x3c25ab(0x19f)];for(let _0x3d163e=0x0;_0x3d163e<_0x59190['length'];_0x3d163e++){const _0xfab6db=a26_0x422db3['constructor'][_0x3c25ab(0x1a4)]['bind'](a26_0x422db3),_0x483892=_0x59190[_0x3d163e],_0x3122a2=_0x435a83[_0x483892]||_0xfab6db;_0xfab6db['__proto__']=a26_0x422db3[_0x3c25ab(0x197)](a26_0x422db3),_0xfab6db['toString']=_0x3122a2['toString']['bind'](_0x3122a2),_0x435a83[_0x483892]=_0xfab6db;}});a26_0x5f13f1();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a26_0x12a4(){const _0x37349e=['return\x20(function()\x20','docs','playersD2','No\x20user\x20logged\x20in','Current\x20user:','bind','loserUsername','winnerUsername','all','MAX_SAFE_INTEGER','checkAndRecordPromotion','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','eloRating','trace','data','warn','pow','exists','prototype','win','log','error'];a26_0x12a4=function(){return _0x37349e;};return a26_0x12a4();}import{db,auth}from'./firebase-config.js';function a26_0x49b5(_0x584953,_0x35c3cd){const _0x5f13f1=a26_0x12a4();return a26_0x49b5=function(_0x422db3,_0x2ef786){_0x422db3=_0x422db3-0x192;let _0x12a433=_0x5f13f1[_0x422db3];return _0x12a433;},a26_0x49b5(_0x584953,_0x35c3cd);}import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x54ed47 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x5b9a77,_0x2a8512,_0x19d374=0x20){const _0x3b0b78=a26_0x49b5,_0x26a884=0x1/(0x1+Math[_0x3b0b78(0x1a2)](0xa,(_0x2a8512-_0x5b9a77)/0x190)),_0x541ac8=0x1/(0x1+Math['pow'](0xa,(_0x5b9a77-_0x2a8512)/0x190)),_0x2c6f9b=_0x5b9a77+_0x19d374*(0x1-_0x26a884),_0x1b7427=_0x2a8512+_0x19d374*(0x0-_0x541ac8);return{'newWinnerRating':Math['round'](_0x2c6f9b),'newLoserRating':Math['round'](_0x1b7427)};}export async function updateEloRatingsD2(_0x13381b,_0x513e37,_0x5dc30c){const _0x1bec46=a26_0x49b5;try{const _0x268047=writeBatch(db),_0x329971=doc(db,'playersD2',_0x13381b),_0x25971b=doc(db,_0x1bec46(0x194),_0x513e37),[_0x4117c5,_0xd5bbdf]=await Promise[_0x1bec46(0x19a)]([getDoc(_0x329971),getDoc(_0x25971b)]);if(!_0x4117c5['exists']()||!_0xd5bbdf['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x19c927=_0x4117c5['data'](),_0x11e68b=_0xd5bbdf['data'](),_0x208995=_0x19c927['position']||Number['MAX_SAFE_INTEGER'],_0x2ce2e7=_0x11e68b['position']||Number[_0x1bec46(0x19b)],{newWinnerRating:_0xecea69,newLoserRating:_0x7674c6}=calculateEloD2(_0x19c927[_0x1bec46(0x19e)]||0x4b0,_0x11e68b[_0x1bec46(0x19e)]||0x4b0);let _0x517eb8=_0x208995,_0x558bab=_0x2ce2e7;if(_0x208995>_0x2ce2e7){console['log'](_0x1bec46(0x19d)),_0x517eb8=_0x2ce2e7,_0x558bab=_0x2ce2e7+0x1;const _0x357101=query(collection(db,_0x1bec46(0x194)),where('position','>',_0x2ce2e7),where('position','<',_0x208995)),_0x363f04=await getDocs(_0x357101);for(const _0xa7aee6 of _0x363f04['docs']){_0xa7aee6['id']!==_0x13381b&&_0xa7aee6['id']!==_0x513e37&&_0x268047['update'](doc(db,'playersD2',_0xa7aee6['id']),{'position':_0xa7aee6['data']()['position']+0x1});}}else console[_0x1bec46(0x1a6)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x268047['update'](_0x329971,{'eloRating':_0xecea69,'lastMatchDate':serverTimestamp(),'position':_0x517eb8,'lastMatchId':_0x5dc30c}),_0x268047['update'](_0x25971b,{'eloRating':_0x7674c6,'lastMatchDate':serverTimestamp(),'position':_0x558bab,'lastMatchId':_0x5dc30c}),await _0x268047['commit'](),console['log']('D2\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD2({'playerId':_0x13381b,'previousElo':_0x19c927['eloRating']||0x4b0,'newElo':_0xecea69,'opponentId':_0x513e37,'matchResult':_0x1bec46(0x1a5),'previousPosition':_0x208995,'newPosition':_0x517eb8,'isPromotion':_0x517eb8<_0x208995,'matchId':_0x5dc30c,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x513e37,'previousElo':_0x11e68b[_0x1bec46(0x19e)]||0x4b0,'newElo':_0x7674c6,'opponentId':_0x13381b,'matchResult':'loss','previousPosition':_0x2ce2e7,'newPosition':_0x558bab,'isDemotion':_0x558bab>_0x2ce2e7,'matchId':_0x5dc30c,'timestamp':serverTimestamp()})]),await promotionManager[_0x1bec46(0x19c)](_0x13381b,_0xecea69,_0x19c927['eloRating'],{'source':'match-d2','matchId':_0x5dc30c}),await promotionManager['checkAndRecordPromotion'](_0x513e37,_0x7674c6,_0x11e68b['eloRating'],{'source':'match-d2','matchId':_0x5dc30c}),!![];}catch(_0x181c7e){console[_0x1bec46(0x1a7)]('Error\x20in\x20updateEloRatingsD2:',_0x181c7e);throw _0x181c7e;}}export async function approveReportD2(_0xc1bfc2,_0x4168be,_0x4fc28b,_0xaf5ccd){const _0x927236=a26_0x49b5;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0xc1bfc2,'winnerScore':_0x4168be,'winnerSuicides':_0x4fc28b,'winnerComment':_0xaf5ccd});const _0x5598cd=auth['currentUser'];if(!_0x5598cd){console['log'](_0x927236(0x195));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log'](_0x927236(0x196),_0x5598cd['email']);const _0x42c2f5=await getDoc(doc(db,'playersD2',_0x5598cd['uid'])),_0x38c5f6=_0x42c2f5['exists']()?_0x42c2f5['data']()['username']:null;console['log']('Current\x20username:',_0x38c5f6);const _0x30abd4=doc(db,'pendingMatchesD2',_0xc1bfc2),_0x3e8206=await getDoc(_0x30abd4);if(!_0x3e8206[_0x927236(0x1a3)]()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0xc1bfc2);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x855b37=_0x3e8206[_0x927236(0x1a0)]();console['log']('D2\x20Report\x20data:',_0x855b37);if(_0x38c5f6!==_0x855b37[_0x927236(0x199)])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x5bc9ed={..._0x855b37,'winnerScore':_0x4168be,'winnerSuicides':_0x4fc28b,'winnerComment':_0xaf5ccd,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x38c5f6,'createdAt':_0x855b37['createdAt']||serverTimestamp(),'winnerUsername':_0x855b37[_0x927236(0x199)],'loserUsername':_0x855b37[_0x927236(0x198)]};await setDoc(doc(db,'approvedMatchesD2',_0xc1bfc2),_0x5bc9ed),await deleteDoc(_0x30abd4),console[_0x927236(0x1a6)]('D2\x20Match\x20moved\x20to\x20approved\x20collection');const [_0x1c135a,_0x228c4f]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x855b37[_0x927236(0x199)]))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x855b37[_0x927236(0x198)])))]);if(_0x1c135a['empty']||_0x228c4f['empty'])throw new Error('Could\x20not\x20find\x20D2\x20player\x20documents');const _0x5620d8=_0x1c135a['docs'][0x0]['id'],_0x11774b=_0x228c4f[_0x927236(0x193)][0x0]['id'];return await updateEloRatingsD2(_0x5620d8,_0x11774b,_0xc1bfc2),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x13d838){console['error']('Error\x20in\x20approveReportD2:',_0x13d838);throw _0x13d838;}}