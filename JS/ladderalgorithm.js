const a28_0xa51d43=(function(){let _0x2ba75f=!![];return function(_0x2c1700,_0x39d7d7){const _0x508c94=_0x2ba75f?function(){const _0x387c0a=a28_0x2da2;if(_0x39d7d7){const _0x4122c5=_0x39d7d7[_0x387c0a(0x1ea)](_0x2c1700,arguments);return _0x39d7d7=null,_0x4122c5;}}:function(){};return _0x2ba75f=![],_0x508c94;};}()),a28_0x1c2cf6=a28_0xa51d43(this,function(){const _0x1880c9=a28_0x2da2,_0x30caed=function(){const _0x215bf2=a28_0x2da2;let _0x5c828e;try{_0x5c828e=Function(_0x215bf2(0x1ed)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x2b9480){_0x5c828e=window;}return _0x5c828e;},_0x224cb7=_0x30caed(),_0x5033f7=_0x224cb7['console']=_0x224cb7['console']||{},_0x423c48=['log','warn','info','error','exception',_0x1880c9(0x1e2),'trace'];for(let _0x5b42a9=0x0;_0x5b42a9<_0x423c48['length'];_0x5b42a9++){const _0x1346f5=a28_0xa51d43['constructor']['prototype']['bind'](a28_0xa51d43),_0xc8c9f2=_0x423c48[_0x5b42a9],_0x616728=_0x5033f7[_0xc8c9f2]||_0x1346f5;_0x1346f5['__proto__']=a28_0xa51d43['bind'](a28_0xa51d43),_0x1346f5['toString']=_0x616728['toString'][_0x1880c9(0x1d5)](_0x616728),_0x5033f7[_0xc8c9f2]=_0x1346f5;}});a28_0x1c2cf6();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';import{RANKS,getRankStyle}from'./ranks.js';function a28_0x13f5(){const _0x1cce0e=['position','round','lastUpdated','bind','error','players','Standard','warn','uid','win','eloRating','pow','displayName','exists','all','totalMatches','table','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','collection','data','update','log','One\x20or\x20both\x20players\x20not\x20found','winnerScore','apply','pointsHistory','wins','return\x20(function()\x20','playerStats','\x20match\x20(Winner)','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:','empty','winnerUsername','MAX_SAFE_INTEGER','add','loserScore','email','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','loserUsername'];a28_0x13f5=function(){return _0x1cce0e;};return a28_0x13f5();}export function calculateElo(_0xcbafc0,_0x1064c0,_0x1b20b0=0x20){const _0x5dac7f=a28_0x2da2;_0xcbafc0=_0xcbafc0>0x3e8?0xc8:_0xcbafc0,_0x1064c0=_0x1064c0>0x3e8?0xc8:_0x1064c0;const _0x54e8e2=0x1/(0x1+Math[_0x5dac7f(0x1dd)](0xa,(_0x1064c0-_0xcbafc0)/0x190)),_0x283d42=0x1/(0x1+Math['pow'](0xa,(_0xcbafc0-_0x1064c0)/0x190)),_0x411eec=_0xcbafc0+_0x1b20b0*(0x1-_0x54e8e2),_0x5f4455=_0x1064c0+_0x1b20b0*(0x0-_0x283d42);return{'newWinnerRating':Math[_0x5dac7f(0x1d3)](Math['min'](_0x411eec)),'newLoserRating':Math['round'](Math['max'](_0x5f4455,0x0))};}export function assignDefaultEloRating(_0x163bf5,_0x2c7627){const _0x15bfe2=a28_0x2da2,_0x192d1a=0xc8;!_0x2c7627['eloRating']&&db[_0x15bfe2(0x1e4)]('players')['doc'](_0x163bf5)[_0x15bfe2(0x1e6)]({'eloRating':_0x192d1a})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x2c7627['username']);})['catch'](_0x3d6633=>{const _0x479c51=_0x15bfe2;console[_0x479c51(0x1d6)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x3d6633);});}export async function updateEloRatings(_0x2a0bea,_0x1ed77b,_0x457e2d){const _0x3fd26e=a28_0x2da2;try{const _0x180f2e=writeBatch(db),_0x1a3139=doc(db,_0x3fd26e(0x1d7),_0x2a0bea),_0xd76804=doc(db,'players',_0x1ed77b),[_0x11ce54,_0x5f3ed9]=await Promise[_0x3fd26e(0x1e0)]([getDoc(_0x1a3139),getDoc(_0xd76804)]);if(!_0x11ce54[_0x3fd26e(0x1df)]()||!_0x5f3ed9['exists']())throw new Error(_0x3fd26e(0x1e8));const _0x1cd0f5=_0x11ce54['data'](),_0x3ffe67=_0x5f3ed9['data'](),_0x1bcb11=_0x1cd0f5[_0x3fd26e(0x1d2)]||Number['MAX_SAFE_INTEGER'],_0x4bec11=_0x3ffe67[_0x3fd26e(0x1d2)]||Number[_0x3fd26e(0x1f3)],{newWinnerRating:_0x4ac855,newLoserRating:_0x4a36a0}=calculateElo(_0x1cd0f5['eloRating']||0x4b0,_0x3ffe67[_0x3fd26e(0x1dc)]||0x4b0);let _0x25dec3=_0x1bcb11,_0x40112b=_0x4bec11;if(_0x1bcb11>_0x4bec11){console[_0x3fd26e(0x1e7)](_0x3fd26e(0x1e3)),_0x25dec3=_0x4bec11,_0x40112b=_0x4bec11+0x1;const _0x142568=query(collection(db,'players'),where('position','>',_0x4bec11),where('position','<',_0x1bcb11)),_0x557fce=await getDocs(_0x142568);for(const _0x30d86c of _0x557fce['docs']){_0x30d86c['id']!==_0x2a0bea&&_0x30d86c['id']!==_0x1ed77b&&_0x180f2e['update'](doc(db,'players',_0x30d86c['id']),{'position':_0x30d86c['data']()[_0x3fd26e(0x1d2)]+0x1});}}else console[_0x3fd26e(0x1e7)]('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x4c7189={'eloRating':_0x4ac855,'lastMatchDate':serverTimestamp(),'position':_0x25dec3,'lastMatchId':_0x457e2d},_0x32fd89={'eloRating':_0x4a36a0,'lastMatchDate':serverTimestamp(),'position':_0x40112b,'lastMatchId':_0x457e2d};return _0x180f2e['update'](_0x1a3139,_0x4c7189),_0x180f2e['update'](_0xd76804,_0x32fd89),await _0x180f2e['commit'](),console[_0x3fd26e(0x1e7)]('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0x2a0bea,'previousElo':_0x1cd0f5['eloRating']||0x4b0,'newElo':_0x4ac855,'opponentId':_0x1ed77b,'matchResult':_0x3fd26e(0x1db),'previousPosition':_0x1bcb11,'newPosition':_0x25dec3,'isPromotion':_0x25dec3<_0x1bcb11,'matchId':_0x457e2d,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x1ed77b,'previousElo':_0x3ffe67[_0x3fd26e(0x1dc)]||0x4b0,'newElo':_0x4a36a0,'opponentId':_0x2a0bea,'matchResult':'loss','previousPosition':_0x4bec11,'newPosition':_0x40112b,'isDemotion':_0x40112b>_0x4bec11,'matchId':_0x457e2d,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x2a0bea,_0x4ac855,_0x1cd0f5['eloRating'],{'source':'match','matchId':_0x457e2d}),await promotionManager['checkAndRecordPromotion'](_0x1ed77b,_0x4a36a0,_0x3ffe67['eloRating'],{'source':'match','matchId':_0x457e2d}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x417895){console['error']('Error\x20in\x20updateEloRatings:',_0x417895);throw _0x417895;}}function a28_0x2da2(_0x49a316,_0x486a80){const _0x1c2cf6=a28_0x13f5();return a28_0x2da2=function(_0xa51d43,_0x5ab1d6){_0xa51d43=_0xa51d43-0x1d2;let _0x13f599=_0x1c2cf6[_0xa51d43];return _0x13f599;},a28_0x2da2(_0x49a316,_0x486a80);}const POINTS_CHART={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e,'Blind\x20Match':0x4b,'Rematch':0x14,'Disorientation':0x32,'Ratting':0x23,'Altered\x20Powerups':0x23,'Mega\x20Match':0x28,'Dogfight':0x32,'Gauss\x20and\x20Mercs':0x19,'Misc':0x1e};export async function approveReport(_0x1edd22,_0x5c1d65,_0x470cf2,_0x4bc024,_0x7ea48a){const _0x471014=a28_0x2da2;try{const _0x555709=doc(db,'pendingMatches',_0x1edd22),_0x2bcde4=await getDoc(_0x555709);if(!_0x2bcde4[_0x471014(0x1df)]())throw new Error('Report\x20not\x20found');const _0x3d3d1a=_0x2bcde4['data'](),_0x258654={..._0x3d3d1a,'winnerScore':_0x5c1d65,'winnerSuicides':_0x470cf2,'winnerComment':_0x4bc024,'winnerDemoLink':_0x7ea48a,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x471014(0x1da)]};await setDoc(doc(db,'approvedMatches',_0x1edd22),_0x258654),await deleteDoc(_0x555709),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0x38fca3,_0x493db0]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0x3d3d1a[_0x471014(0x1f2)]))),getDocs(query(collection(db,'players'),where('username','==',_0x3d3d1a[_0x471014(0x1f8)])))]);if(_0x38fca3[_0x471014(0x1f1)]||_0x493db0[_0x471014(0x1f1)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x24ff0d=_0x38fca3['docs'][0x0]['id'],_0x157e06=_0x493db0['docs'][0x0]['id'];await updateEloRatings(_0x24ff0d,_0x157e06,_0x1edd22);try{const _0x3474a7=_0x3d3d1a['subgameType']||_0x471014(0x1d8),_0x4a0e6b=POINTS_CHART[_0x3474a7]||0xa,_0x2742a5=doc(db,'userProfiles',_0x24ff0d),_0x11cc80=doc(db,'userProfiles',_0x157e06),[_0x349adb,_0x5accb9]=await Promise['all']([getDoc(_0x2742a5),getDoc(_0x11cc80)]);if(_0x349adb['exists']()&&_0x5accb9['exists']()){const _0x44a83c=_0x349adb['data'](),_0xf3a7fd=_0x5accb9['data'](),_0x1ac864=_0x44a83c['points']||0x0,_0xbd1603=_0xf3a7fd['points']||0x0,_0x18f844=_0x1ac864+_0x4a0e6b,_0x50530f=_0xbd1603+_0x4a0e6b;await Promise['all']([updateDoc(_0x2742a5,{'points':_0x18f844,'lastPointsModified':serverTimestamp()}),updateDoc(_0x11cc80,{'points':_0x50530f,'lastPointsModified':serverTimestamp()})]),await Promise['all']([addDoc(collection(db,_0x471014(0x1eb)),{'userId':_0x24ff0d,'userEmail':_0x44a83c['email']||'unknown','displayName':_0x44a83c['displayName']||_0x44a83c['username']||'Unknown\x20User','action':_0x471014(0x1f4),'amount':_0x4a0e6b,'previousPoints':_0x1ac864,'newPoints':_0x18f844,'reason':'Match\x20points:\x20'+_0x3474a7+_0x471014(0x1ef),'adminEmail':'system-match-award','timestamp':serverTimestamp()}),addDoc(collection(db,_0x471014(0x1eb)),{'userId':_0x157e06,'userEmail':_0xf3a7fd[_0x471014(0x1f6)]||'unknown','displayName':_0xf3a7fd[_0x471014(0x1de)]||_0xf3a7fd['username']||'Unknown\x20User','action':'add','amount':_0x4a0e6b,'previousPoints':_0xbd1603,'newPoints':_0x50530f,'reason':'Match\x20points:\x20'+_0x3474a7+'\x20match\x20(Participant)','adminEmail':'system-match-award','timestamp':serverTimestamp()})]),console['log']('Awarded\x20'+_0x4a0e6b+'\x20points\x20to\x20both\x20players\x20for\x20'+_0x3474a7+'\x20match');}else console[_0x471014(0x1d9)]('Could\x20not\x20award\x20points\x20-\x20one\x20or\x20both\x20user\x20profiles\x20not\x20found');}catch(_0x8155ba){console['warn'](_0x471014(0x1f0),_0x8155ba);}return console['log'](_0x471014(0x1f7)),!![];}catch(_0x3abec1){console['error']('Error\x20approving\x20report:',_0x3abec1);throw _0x3abec1;}}async function updatePlayerElo(_0x2e4898,_0x4e3d2c,_0x4c887e){const _0xf9175=a28_0x2da2,_0xc37d00=doc(db,'players',_0x2e4898),_0x41168d=await getDoc(_0xc37d00),_0x112669=_0x41168d[_0xf9175(0x1e5)](),_0x47a18c=doc(db,'playerStats',_0x2e4898),_0xd9575e=await getDoc(_0x47a18c),_0x4d3060=_0xd9575e[_0xf9175(0x1e5)]()||{'totalMatches':0x0,'winRate':0x0},_0x55c400=getRankStyle(_0x4c887e,_0x4d3060[_0xf9175(0x1e1)],_0x4d3060['winRate']);await updateDoc(_0xc37d00,{'eloRating':_0x4c887e,'rank':_0x55c400['name'],'rankColor':_0x55c400['color']}),await checkAndRecordPromotion(_0x2e4898,_0x4c887e,_0x4e3d2c,{'matchCount':_0x4d3060['totalMatches'],'winRate':_0x4d3060['winRate']});}async function updatePlayerStats(_0x50d67c,_0x17aa72,_0x2cdb60){const _0xbaf2fb=a28_0x2da2,_0x17c1cf=doc(db,_0xbaf2fb(0x1ee),_0x50d67c),_0x48a93b=await getDoc(_0x17c1cf);let _0x1833dd=_0x48a93b['exists']()?_0x48a93b[_0xbaf2fb(0x1e5)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x2cdb60?(_0x1833dd[_0xbaf2fb(0x1ec)]++,_0x1833dd['totalKills']+=parseInt(_0x17aa72['winnerScore']||0x0),_0x1833dd['totalDeaths']+=parseInt(_0x17aa72['loserScore']||0x0)):(_0x1833dd['losses']++,_0x1833dd['totalKills']+=parseInt(_0x17aa72[_0xbaf2fb(0x1f5)]||0x0),_0x1833dd['totalDeaths']+=parseInt(_0x17aa72[_0xbaf2fb(0x1e9)]||0x0));const _0x2d9927=_0x1833dd['wins']+_0x1833dd['losses'];_0x1833dd['winRate']=_0x2d9927>0x0?(_0x1833dd[_0xbaf2fb(0x1ec)]/_0x2d9927*0x64)['toFixed'](0x1):0x0,_0x1833dd[_0xbaf2fb(0x1d4)]=new Date()['toISOString'](),await setDoc(_0x17c1cf,_0x1833dd,{'merge':!![]});}