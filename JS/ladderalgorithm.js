const a30_0x5c8870=(function(){let _0x14bf59=!![];return function(_0x59b130,_0x19d5ef){const _0x46772b=_0x14bf59?function(){const _0x4f44b5=a30_0xc94a;if(_0x19d5ef){const _0xfea52a=_0x19d5ef[_0x4f44b5(0x148)](_0x59b130,arguments);return _0x19d5ef=null,_0xfea52a;}}:function(){};return _0x14bf59=![],_0x46772b;};}()),a30_0x44cadd=a30_0x5c8870(this,function(){const _0x47bd0d=a30_0xc94a,_0x51f8ce=function(){let _0x397b29;try{_0x397b29=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x41ee09){_0x397b29=window;}return _0x397b29;},_0x3a5897=_0x51f8ce(),_0x298311=_0x3a5897['console']=_0x3a5897['console']||{},_0x823994=['log','warn','info','error',_0x47bd0d(0x150),'table',_0x47bd0d(0x15a)];for(let _0x17d299=0x0;_0x17d299<_0x823994[_0x47bd0d(0x145)];_0x17d299++){const _0x4e0d5b=a30_0x5c8870['constructor']['prototype'][_0x47bd0d(0x146)](a30_0x5c8870),_0x303370=_0x823994[_0x17d299],_0x2c4d5b=_0x298311[_0x303370]||_0x4e0d5b;_0x4e0d5b[_0x47bd0d(0x159)]=a30_0x5c8870['bind'](a30_0x5c8870),_0x4e0d5b['toString']=_0x2c4d5b['toString'][_0x47bd0d(0x146)](_0x2c4d5b),_0x298311[_0x303370]=_0x4e0d5b;}});a30_0x44cadd();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';function a30_0x1610(){const _0x520937=['players','position','length','bind','ELO\x20ratings\x20updated\x20successfully','apply','error','collection','update','toISOString','approvedMatches','wins','docs','exception','log','One\x20or\x20both\x20players\x20not\x20found','lastUpdated','MAX_SAFE_INTEGER','Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20','pow','all','Match\x20successfully\x20approved\x20and\x20ELO\x20updated','__proto__','trace','winnerUsername','data','eloRating','username','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:'];a30_0x1610=function(){return _0x520937;};return a30_0x1610();}import{isAdmin}from'./admin-check.js';export function calculateElo(_0x2ceea4,_0x4d9ad8,_0x5c4e23=0x20){const _0x50fb62=a30_0xc94a,_0x2f0355=0x1/(0x1+Math['pow'](0xa,(_0x4d9ad8-_0x2ceea4)/0x190)),_0x4c9487=0x1/(0x1+Math[_0x50fb62(0x156)](0xa,(_0x2ceea4-_0x4d9ad8)/0x190)),_0x4fe2c2=_0x2ceea4+_0x5c4e23*(0x1-_0x2f0355),_0x18e377=_0x4d9ad8+_0x5c4e23*(0x0-_0x4c9487);return{'newWinnerRating':Math['round'](_0x4fe2c2),'newLoserRating':Math['round'](_0x18e377)};}export function assignDefaultEloRating(_0x460d69,_0x12589e){const _0x39ef20=a30_0xc94a,_0x2d7d45=0x4b0;!_0x12589e['eloRating']&&db[_0x39ef20(0x14a)]('players')['doc'](_0x460d69)['update']({'eloRating':_0x2d7d45})['then'](()=>{const _0x14225d=_0x39ef20;console['log'](_0x14225d(0x155)+_0x12589e[_0x14225d(0x15e)]);})['catch'](_0x208ee8=>{const _0x5c92b0=_0x39ef20;console[_0x5c92b0(0x149)]('Error\x20assigning\x20default\x20ELO\x20rating:',_0x208ee8);});}export async function updateEloRatings(_0x380a70,_0x47de9e,_0x56588c){const _0x15713b=a30_0xc94a;try{const _0x46af9a=writeBatch(db),_0x75117c=doc(db,'players',_0x380a70),_0x5910bf=doc(db,_0x15713b(0x143),_0x47de9e),[_0x2eb455,_0x43fa09]=await Promise[_0x15713b(0x157)]([getDoc(_0x75117c),getDoc(_0x5910bf)]);if(!_0x2eb455['exists']()||!_0x43fa09['exists']())throw new Error(_0x15713b(0x152));const _0x313e22=_0x2eb455['data'](),_0x2645a0=_0x43fa09['data'](),_0xbeb174=_0x313e22['position']||Number['MAX_SAFE_INTEGER'],_0x268f2c=_0x2645a0[_0x15713b(0x144)]||Number[_0x15713b(0x154)],{newWinnerRating:_0xf12f2e,newLoserRating:_0x8a53ec}=calculateElo(_0x313e22['eloRating']||0x4b0,_0x2645a0[_0x15713b(0x15d)]||0x4b0);let _0x4b9444=_0xbeb174,_0x430f7b=_0x268f2c;if(_0xbeb174>_0x268f2c){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x4b9444=_0x268f2c,_0x430f7b=_0x268f2c+0x1;const _0x164be6=query(collection(db,'players'),where('position','>',_0x268f2c),where(_0x15713b(0x144),'<',_0xbeb174)),_0x44dd3e=await getDocs(_0x164be6);for(const _0x1e8114 of _0x44dd3e['docs']){_0x1e8114['id']!==_0x380a70&&_0x1e8114['id']!==_0x47de9e&&_0x46af9a['update'](doc(db,'players',_0x1e8114['id']),{'position':_0x1e8114[_0x15713b(0x15c)]()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x2fa98e={'eloRating':_0xf12f2e,'lastMatchDate':serverTimestamp(),'position':_0x4b9444,'lastMatchId':_0x56588c},_0x48a410={'eloRating':_0x8a53ec,'lastMatchDate':serverTimestamp(),'position':_0x430f7b,'lastMatchId':_0x56588c};return _0x46af9a[_0x15713b(0x14b)](_0x75117c,_0x2fa98e),_0x46af9a['update'](_0x5910bf,_0x48a410),await _0x46af9a['commit'](),console['log'](_0x15713b(0x147)),await Promise['all']([recordEloChange({'playerId':_0x380a70,'previousElo':_0x313e22['eloRating']||0x4b0,'newElo':_0xf12f2e,'opponentId':_0x47de9e,'matchResult':'win','previousPosition':_0xbeb174,'newPosition':_0x4b9444,'isPromotion':_0x4b9444<_0xbeb174,'matchId':_0x56588c,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x47de9e,'previousElo':_0x2645a0['eloRating']||0x4b0,'newElo':_0x8a53ec,'opponentId':_0x380a70,'matchResult':'loss','previousPosition':_0x268f2c,'newPosition':_0x430f7b,'isDemotion':_0x430f7b>_0x268f2c,'matchId':_0x56588c,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x380a70,_0xf12f2e,_0x313e22['eloRating'],{'source':'match','matchId':_0x56588c}),await promotionManager['checkAndRecordPromotion'](_0x47de9e,_0x8a53ec,_0x2645a0['eloRating'],{'source':'match','matchId':_0x56588c}),console['log']('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x2a6a37){console['error']('Error\x20in\x20updateEloRatings:',_0x2a6a37);throw _0x2a6a37;}}export async function approveReport(_0x537f98,_0x5ae1ca,_0xad6952,_0x180773,_0x1fc980){const _0x456b3e=a30_0xc94a;try{const _0x59e935=doc(db,'pendingMatches',_0x537f98),_0x287df7=await getDoc(_0x59e935);if(!_0x287df7['exists']())throw new Error('Report\x20not\x20found');const _0x17b916=_0x287df7['data'](),_0x35e47f={..._0x17b916,'winnerScore':_0x5ae1ca,'winnerSuicides':_0xad6952,'winnerComment':_0x180773,'winnerDemoLink':_0x1fc980,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,_0x456b3e(0x14d),_0x537f98),_0x35e47f),await deleteDoc(_0x59e935),console['log']('Match\x20moved\x20to\x20approved\x20collection');const [_0xda190c,_0x3c4ffc]=await Promise[_0x456b3e(0x157)]([getDocs(query(collection(db,'players'),where(_0x456b3e(0x15e),'==',_0x17b916[_0x456b3e(0x15b)]))),getDocs(query(collection(db,'players'),where('username','==',_0x17b916['loserUsername'])))]);if(_0xda190c['empty']||_0x3c4ffc['empty'])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x183b9e=_0xda190c['docs'][0x0]['id'],_0x5c408c=_0x3c4ffc[_0x456b3e(0x14f)][0x0]['id'];await updateEloRatings(_0x183b9e,_0x5c408c,_0x537f98);try{await awardMatchPoints(_0x183b9e,_0x5c408c,_0x17b916['subgameType']);}catch(_0x4b37ad){console['warn'](_0x456b3e(0x15f),_0x4b37ad);}return console[_0x456b3e(0x151)](_0x456b3e(0x158)),!![];}catch(_0x49434c){console['error']('Error\x20approving\x20report:',_0x49434c);throw _0x49434c;}}function a30_0xc94a(_0x404c81,_0x17c7dc){const _0x44cadd=a30_0x1610();return a30_0xc94a=function(_0x5c8870,_0x506cd0){_0x5c8870=_0x5c8870-0x143;let _0x16103f=_0x44cadd[_0x5c8870];return _0x16103f;},a30_0xc94a(_0x404c81,_0x17c7dc);}async function updatePlayerElo(_0x41fff8,_0x337b61,_0x2acf0e){await setDoc(doc(db,'players',_0x41fff8),{...playerData,'eloRating':_0x2acf0e}),await checkAndRecordPromotion(_0x41fff8,_0x2acf0e,_0x337b61);}async function updatePlayerStats(_0x1681b0,_0x3a197b,_0x3b8bc5){const _0x318e39=a30_0xc94a,_0x736190=doc(db,'playerStats',_0x1681b0),_0x436873=await getDoc(_0x736190);let _0x423cb5=_0x436873['exists']()?_0x436873['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x3b8bc5?(_0x423cb5['wins']++,_0x423cb5['totalKills']+=parseInt(_0x3a197b['winnerScore']||0x0),_0x423cb5['totalDeaths']+=parseInt(_0x3a197b['loserScore']||0x0)):(_0x423cb5['losses']++,_0x423cb5['totalKills']+=parseInt(_0x3a197b['loserScore']||0x0),_0x423cb5['totalDeaths']+=parseInt(_0x3a197b['winnerScore']||0x0));const _0x45cc9b=_0x423cb5['wins']+_0x423cb5['losses'];_0x423cb5['winRate']=_0x45cc9b>0x0?(_0x423cb5[_0x318e39(0x14e)]/_0x45cc9b*0x64)['toFixed'](0x1):0x0,_0x423cb5[_0x318e39(0x153)]=new Date()[_0x318e39(0x14c)](),await setDoc(_0x736190,_0x423cb5,{'merge':!![]});}