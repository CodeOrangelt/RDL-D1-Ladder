const a30_0x3f582c=(function(){let _0x4cebb5=!![];return function(_0x40f222,_0x3c122a){const _0x52eefa=_0x4cebb5?function(){const _0x8e6744=a30_0xdf51;if(_0x3c122a){const _0x2f4d38=_0x3c122a[_0x8e6744(0x109)](_0x40f222,arguments);return _0x3c122a=null,_0x2f4d38;}}:function(){};return _0x4cebb5=![],_0x52eefa;};}()),a30_0xddd20f=a30_0x3f582c(this,function(){const _0x4f797d=a30_0xdf51,_0x6e35a4=function(){let _0x3a2d22;try{_0x3a2d22=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x118553){_0x3a2d22=window;}return _0x3a2d22;},_0x4b95e6=_0x6e35a4(),_0x2841dd=_0x4b95e6[_0x4f797d(0x105)]=_0x4b95e6['console']||{},_0x3611b4=['log','warn','info','error',_0x4f797d(0x116),'table','trace'];for(let _0x5b62e8=0x0;_0x5b62e8<_0x3611b4['length'];_0x5b62e8++){const _0x4a1a68=a30_0x3f582c[_0x4f797d(0xfa)]['prototype']['bind'](a30_0x3f582c),_0x48899a=_0x3611b4[_0x5b62e8],_0x52ea4e=_0x2841dd[_0x48899a]||_0x4a1a68;_0x4a1a68['__proto__']=a30_0x3f582c['bind'](a30_0x3f582c),_0x4a1a68[_0x4f797d(0x10b)]=_0x52ea4e['toString']['bind'](_0x52ea4e),_0x2841dd[_0x48899a]=_0x4a1a68;}});function a30_0xdf51(_0x15402a,_0x2f173a){const _0xddd20f=a30_0x4040();return a30_0xdf51=function(_0x3f582c,_0x4c812c){_0x3f582c=_0x3f582c-0xf9;let _0x40408d=_0xddd20f[_0x3f582c];return _0x40408d;},a30_0xdf51(_0x15402a,_0x2f173a);}a30_0xddd20f();function a30_0x4040(){const _0xf265dc=['log','constructor','loss','approvedMatches','\x20match','docs','position','uid','Error\x20awarding\x20match\x20points:','One\x20or\x20both\x20players\x20not\x20found','eloRating','Standard','console','empty','Report\x20not\x20found','Match\x20points:\x20','apply','players','toString','all','checkAndRecordPromotion','username','data','win','round','exists','losses','wins','commit','exception','loserScore','Match\x20moved\x20to\x20approved\x20collection','add','update'];a30_0x4040=function(){return _0xf265dc;};return a30_0x4040();}import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x514038,_0x1adde1,_0x520d69=0x20){const _0x3527fe=a30_0xdf51,_0x4f5c04=0x1/(0x1+Math['pow'](0xa,(_0x1adde1-_0x514038)/0x190)),_0x4db1c0=0x1/(0x1+Math['pow'](0xa,(_0x514038-_0x1adde1)/0x190)),_0x38a22a=_0x514038+_0x520d69*(0x1-_0x4f5c04),_0x366fb8=_0x1adde1+_0x520d69*(0x0-_0x4db1c0);return{'newWinnerRating':Math[_0x3527fe(0x111)](_0x38a22a),'newLoserRating':Math['round'](_0x366fb8)};}export function assignDefaultEloRating(_0x24c91d,_0x117ba4){const _0x1b9c6a=a30_0xdf51,_0x15d331=0x4b0;!_0x117ba4['eloRating']&&db['collection'](_0x1b9c6a(0x10a))['doc'](_0x24c91d)[_0x1b9c6a(0x11a)]({'eloRating':_0x15d331})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x117ba4['username']);})['catch'](_0x593f3e=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x593f3e);});}export async function updateEloRatings(_0x14aea1,_0x26d592,_0x175c1c){const _0xdd1579=a30_0xdf51;try{const _0xd72fa8=writeBatch(db),_0x30634a=doc(db,_0xdd1579(0x10a),_0x14aea1),_0x4b622c=doc(db,'players',_0x26d592),[_0x4897fd,_0x31dc71]=await Promise['all']([getDoc(_0x30634a),getDoc(_0x4b622c)]);if(!_0x4897fd['exists']()||!_0x31dc71['exists']())throw new Error(_0xdd1579(0x102));const _0x772868=_0x4897fd[_0xdd1579(0x10f)](),_0x24f447=_0x31dc71['data'](),_0x160fa7=_0x772868['position']||Number['MAX_SAFE_INTEGER'],_0x13d65e=_0x24f447['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x5c4b9c,newLoserRating:_0x41f3eb}=calculateElo(_0x772868['eloRating']||0x4b0,_0x24f447['eloRating']||0x4b0);let _0x1bbe29=_0x160fa7,_0x40a934=_0x13d65e;if(_0x160fa7>_0x13d65e){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x1bbe29=_0x13d65e,_0x40a934=_0x13d65e+0x1;const _0x33cf86=query(collection(db,'players'),where(_0xdd1579(0xff),'>',_0x13d65e),where('position','<',_0x160fa7)),_0x12c342=await getDocs(_0x33cf86);for(const _0x57f22e of _0x12c342['docs']){_0x57f22e['id']!==_0x14aea1&&_0x57f22e['id']!==_0x26d592&&_0xd72fa8[_0xdd1579(0x11a)](doc(db,_0xdd1579(0x10a),_0x57f22e['id']),{'position':_0x57f22e['data']()['position']+0x1});}}else console[_0xdd1579(0xf9)]('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0xd80f80={'eloRating':_0x5c4b9c,'lastMatchDate':serverTimestamp(),'position':_0x1bbe29,'lastMatchId':_0x175c1c},_0x3c19d4={'eloRating':_0x41f3eb,'lastMatchDate':serverTimestamp(),'position':_0x40a934,'lastMatchId':_0x175c1c};return _0xd72fa8['update'](_0x30634a,_0xd80f80),_0xd72fa8[_0xdd1579(0x11a)](_0x4b622c,_0x3c19d4),await _0xd72fa8[_0xdd1579(0x115)](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise[_0xdd1579(0x10c)]([recordEloChange({'playerId':_0x14aea1,'previousElo':_0x772868['eloRating']||0x4b0,'newElo':_0x5c4b9c,'opponentId':_0x26d592,'matchResult':_0xdd1579(0x110),'previousPosition':_0x160fa7,'newPosition':_0x1bbe29,'isPromotion':_0x1bbe29<_0x160fa7,'matchId':_0x175c1c,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x26d592,'previousElo':_0x24f447['eloRating']||0x4b0,'newElo':_0x41f3eb,'opponentId':_0x14aea1,'matchResult':_0xdd1579(0xfb),'previousPosition':_0x13d65e,'newPosition':_0x40a934,'isDemotion':_0x40a934>_0x13d65e,'matchId':_0x175c1c,'timestamp':serverTimestamp()})]),await promotionManager[_0xdd1579(0x10d)](_0x14aea1,_0x5c4b9c,_0x772868['eloRating'],{'source':'match','matchId':_0x175c1c}),await promotionManager['checkAndRecordPromotion'](_0x26d592,_0x41f3eb,_0x24f447[_0xdd1579(0x103)],{'source':'match','matchId':_0x175c1c}),console[_0xdd1579(0xf9)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0xbfca60){console['error']('Error\x20in\x20updateEloRatings:',_0xbfca60);throw _0xbfca60;}}async function awardMatchPoints(_0x5638b9,_0x288556,_0x45f9c5){const _0x2d48b9=a30_0xdf51,_0xda8a27={'':0xa,'Standard':0xa,'Fusion\x20Match':0x19,'â‰¥6\x20Missiles':0xa,'Weapon\x20Imbalance':0x1e},_0x2f4707=_0xda8a27[_0x45f9c5]||0xa;try{return await modifyUserPoints(_0x5638b9,'add',_0x2f4707,'Match\x20points:\x20'+(_0x45f9c5||'Standard')+_0x2d48b9(0xfd)),await modifyUserPoints(_0x288556,_0x2d48b9(0x119),_0x2f4707,_0x2d48b9(0x108)+(_0x45f9c5||_0x2d48b9(0x104))+'\x20match'),console['log']('Awarded\x20'+_0x2f4707+'\x20points\x20to\x20both\x20players\x20for\x20'+(_0x45f9c5||'Standard')+_0x2d48b9(0xfd)),!![];}catch(_0x47a397){return console['error'](_0x2d48b9(0x101),_0x47a397),![];}}export async function approveReport(_0x290f83,_0x1080a4,_0x5e4e0f,_0x2352aa,_0x46a3c0){const _0x12aea6=a30_0xdf51;try{const _0x2457b0=doc(db,'pendingMatches',_0x290f83),_0x2de805=await getDoc(_0x2457b0);if(!_0x2de805['exists']())throw new Error(_0x12aea6(0x107));const _0xbd370e=_0x2de805['data'](),_0x4b7484={..._0xbd370e,'winnerScore':_0x1080a4,'winnerSuicides':_0x5e4e0f,'winnerComment':_0x2352aa,'winnerDemoLink':_0x46a3c0,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x12aea6(0x100)]};await setDoc(doc(db,_0x12aea6(0xfc),_0x290f83),_0x4b7484),await deleteDoc(_0x2457b0),console['log'](_0x12aea6(0x118));const [_0x32f244,_0x4ae145]=await Promise[_0x12aea6(0x10c)]([getDocs(query(collection(db,'players'),where('username','==',_0xbd370e['winnerUsername']))),getDocs(query(collection(db,'players'),where(_0x12aea6(0x10e),'==',_0xbd370e['loserUsername'])))]);if(_0x32f244[_0x12aea6(0x106)]||_0x4ae145[_0x12aea6(0x106)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0xcc73e0=_0x32f244['docs'][0x0]['id'],_0x2b0cd3=_0x4ae145[_0x12aea6(0xfe)][0x0]['id'];return await updateEloRatings(_0xcc73e0,_0x2b0cd3,_0x290f83),await awardMatchPoints(_0xcc73e0,_0x2b0cd3,_0xbd370e['subgameType']),console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x33ba2d){console['error']('Error\x20approving\x20report:',_0x33ba2d);throw _0x33ba2d;}}async function updatePlayerElo(_0x3366dd,_0x1d4be9,_0xa7d3cb){await setDoc(doc(db,'players',_0x3366dd),{...playerData,'eloRating':_0xa7d3cb}),await checkAndRecordPromotion(_0x3366dd,_0xa7d3cb,_0x1d4be9);}async function updatePlayerStats(_0x3d18ab,_0x341689,_0x259741){const _0x549bd5=a30_0xdf51,_0x555364=doc(db,'playerStats',_0x3d18ab),_0x11ee4d=await getDoc(_0x555364);let _0x577160=_0x11ee4d[_0x549bd5(0x112)]()?_0x11ee4d['data']():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x259741?(_0x577160[_0x549bd5(0x114)]++,_0x577160['totalKills']+=parseInt(_0x341689['winnerScore']||0x0),_0x577160['totalDeaths']+=parseInt(_0x341689['loserScore']||0x0)):(_0x577160[_0x549bd5(0x113)]++,_0x577160['totalKills']+=parseInt(_0x341689[_0x549bd5(0x117)]||0x0),_0x577160['totalDeaths']+=parseInt(_0x341689['winnerScore']||0x0));const _0x14b358=_0x577160['wins']+_0x577160['losses'];_0x577160['winRate']=_0x14b358>0x0?(_0x577160['wins']/_0x14b358*0x64)['toFixed'](0x1):0x0,_0x577160['lastUpdated']=new Date()['toISOString'](),await setDoc(_0x555364,_0x577160,{'merge':!![]});}