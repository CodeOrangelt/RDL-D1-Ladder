const a26_0x401f12=(function(){let _0x4ddc8e=!![];return function(_0x15968c,_0x54b21a){const _0x47c2a0=_0x4ddc8e?function(){if(_0x54b21a){const _0x814a8b=_0x54b21a['apply'](_0x15968c,arguments);return _0x54b21a=null,_0x814a8b;}}:function(){};return _0x4ddc8e=![],_0x47c2a0;};}()),a26_0x4334b8=a26_0x401f12(this,function(){const _0x49f2df=a26_0x1f0f,_0x3a22d3=function(){const _0x1d691b=a26_0x1f0f;let _0x4b7d1b;try{_0x4b7d1b=Function(_0x1d691b(0x1e1)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x48cfb5){_0x4b7d1b=window;}return _0x4b7d1b;},_0x5c53bf=_0x3a22d3(),_0x1da6e8=_0x5c53bf['console']=_0x5c53bf[_0x49f2df(0x1d9)]||{},_0x1831c6=['log','warn','info','error','exception',_0x49f2df(0x1cf),'trace'];for(let _0x3a20bf=0x0;_0x3a20bf<_0x1831c6['length'];_0x3a20bf++){const _0x56e47f=a26_0x401f12['constructor']['prototype'][_0x49f2df(0x1d0)](a26_0x401f12),_0x149b71=_0x1831c6[_0x3a20bf],_0x29fdd3=_0x1da6e8[_0x149b71]||_0x56e47f;_0x56e47f['__proto__']=a26_0x401f12['bind'](a26_0x401f12),_0x56e47f[_0x49f2df(0x1e2)]=_0x29fdd3[_0x49f2df(0x1e2)]['bind'](_0x29fdd3),_0x1da6e8[_0x149b71]=_0x56e47f;}});a26_0x4334b8();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';function a26_0x1f0f(_0x4d0fef,_0x5c413f){const _0x4334b8=a26_0x3271();return a26_0x1f0f=function(_0x401f12,_0x3682fb){_0x401f12=_0x401f12-0x1cc;let _0x327114=_0x4334b8[_0x401f12];return _0x327114;},a26_0x1f0f(_0x4d0fef,_0x5c413f);}import a26_0x2be205 from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x101744,_0x2016f9,_0x532c9b=0x20){const _0x2f06a4=0x1/(0x1+Math['pow'](0xa,(_0x2016f9-_0x101744)/0x190)),_0x3cc44f=0x1/(0x1+Math['pow'](0xa,(_0x101744-_0x2016f9)/0x190)),_0x3d7c6b=_0x101744+_0x532c9b*(0x1-_0x2f06a4),_0x81019=_0x2016f9+_0x532c9b*(0x0-_0x3cc44f);return{'newWinnerRating':Math['round'](_0x3d7c6b),'newLoserRating':Math['round'](_0x81019)};}export async function updateEloRatingsD2(_0x40e50c,_0x3bd18b,_0x24ac43){const _0x20f710=a26_0x1f0f;try{const _0x2648ea=writeBatch(db),_0x24e99f=doc(db,_0x20f710(0x1ce),_0x40e50c),_0x7a8621=doc(db,_0x20f710(0x1ce),_0x3bd18b),[_0x1e0a28,_0x552b22]=await Promise['all']([getDoc(_0x24e99f),getDoc(_0x7a8621)]);if(!_0x1e0a28[_0x20f710(0x1db)]()||!_0x552b22['exists']())throw new Error(_0x20f710(0x1dc));const _0x2c9f64=_0x1e0a28['data'](),_0xd2f2ad=_0x552b22['data'](),_0x10111f=_0x2c9f64['position']||Number[_0x20f710(0x1d6)],_0x550e8e=_0xd2f2ad[_0x20f710(0x1cd)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0xce1ec7,newLoserRating:_0x588c52}=calculateEloD2(_0x2c9f64['eloRating']||0x4b0,_0xd2f2ad['eloRating']||0x4b0);let _0x53a27a=_0x10111f,_0x61934f=_0x550e8e;if(_0x10111f>_0x550e8e){console[_0x20f710(0x1d4)](_0x20f710(0x1d1)),_0x53a27a=_0x550e8e,_0x61934f=_0x550e8e+0x1;const _0x2460f6=query(collection(db,'playersD2'),where('position','>',_0x550e8e),where(_0x20f710(0x1cd),'<',_0x10111f)),_0x403c22=await getDocs(_0x2460f6);for(const _0x1ae34a of _0x403c22[_0x20f710(0x1d5)]){_0x1ae34a['id']!==_0x40e50c&&_0x1ae34a['id']!==_0x3bd18b&&_0x2648ea[_0x20f710(0x1e5)](doc(db,_0x20f710(0x1ce),_0x1ae34a['id']),{'position':_0x1ae34a[_0x20f710(0x1dd)]()[_0x20f710(0x1cd)]+0x1});}}else console['log'](_0x20f710(0x1e3));return _0x2648ea['update'](_0x24e99f,{'eloRating':_0xce1ec7,'lastMatchDate':serverTimestamp(),'position':_0x53a27a,'lastMatchId':_0x24ac43}),_0x2648ea['update'](_0x7a8621,{'eloRating':_0x588c52,'lastMatchDate':serverTimestamp(),'position':_0x61934f,'lastMatchId':_0x24ac43}),await _0x2648ea['commit'](),console['log'](_0x20f710(0x1da)),await Promise['all']([recordEloChangeD2({'playerId':_0x40e50c,'previousElo':_0x2c9f64['eloRating']||0x4b0,'newElo':_0xce1ec7,'opponentId':_0x3bd18b,'matchResult':_0x20f710(0x1ea),'previousPosition':_0x10111f,'newPosition':_0x53a27a,'isPromotion':_0x53a27a<_0x10111f,'matchId':_0x24ac43,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x3bd18b,'previousElo':_0xd2f2ad['eloRating']||0x4b0,'newElo':_0x588c52,'opponentId':_0x40e50c,'matchResult':'loss','previousPosition':_0x550e8e,'newPosition':_0x61934f,'isDemotion':_0x61934f>_0x550e8e,'matchId':_0x24ac43,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x40e50c,_0xce1ec7,_0x2c9f64['eloRating'],{'source':'match-d2','matchId':_0x24ac43}),await promotionManager['checkAndRecordPromotion'](_0x3bd18b,_0x588c52,_0xd2f2ad['eloRating'],{'source':'match-d2','matchId':_0x24ac43}),!![];}catch(_0x30f4ad){console['error'](_0x20f710(0x1cc),_0x30f4ad);throw _0x30f4ad;}}function a26_0x3271(){const _0x40ec34=['Error\x20in\x20updateEloRatingsD2:','position','playersD2','table','bind','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','all','log','docs','MAX_SAFE_INTEGER','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','Starting\x20approveReportD2\x20function\x20with:','console','D2\x20ELO\x20ratings\x20updated\x20successfully','exists','One\x20or\x20both\x20D2\x20players\x20not\x20found','data','winnerUsername','error','You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches','return\x20(function()\x20','toString','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','approvedMatchesD2','update','D2\x20Match\x20moved\x20to\x20approved\x20collection','uid','Could\x20not\x20find\x20D2\x20player\x20documents','No\x20user\x20logged\x20in','win'];a26_0x3271=function(){return _0x40ec34;};return a26_0x3271();}export async function approveReportD2(_0xed99b6,_0x391b7a,_0xc91a06,_0x1ec3c7){const _0x4b6c1c=a26_0x1f0f;try{console[_0x4b6c1c(0x1d4)](_0x4b6c1c(0x1d8),{'reportId':_0xed99b6,'winnerScore':_0x391b7a,'winnerSuicides':_0xc91a06,'winnerComment':_0x1ec3c7});const _0x1c1d59=auth['currentUser'];if(!_0x1c1d59){console['log'](_0x4b6c1c(0x1e9));throw new Error(_0x4b6c1c(0x1e0));}console[_0x4b6c1c(0x1d4)]('Current\x20user:',_0x1c1d59['email']);const _0x3a4ac3=await getDoc(doc(db,'playersD2',_0x1c1d59[_0x4b6c1c(0x1e7)])),_0x52ba71=_0x3a4ac3['exists']()?_0x3a4ac3[_0x4b6c1c(0x1dd)]()['username']:null;console[_0x4b6c1c(0x1d4)]('Current\x20username:',_0x52ba71);const _0x3337ce=doc(db,'pendingMatchesD2',_0xed99b6),_0x58bc3e=await getDoc(_0x3337ce);if(!_0x58bc3e['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0xed99b6);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x598603=_0x58bc3e[_0x4b6c1c(0x1dd)]();console['log']('D2\x20Report\x20data:',_0x598603);if(_0x52ba71!==_0x598603[_0x4b6c1c(0x1de)])throw new Error(_0x4b6c1c(0x1d2));const _0x4d224a={..._0x598603,'winnerScore':_0x391b7a,'winnerSuicides':_0xc91a06,'winnerComment':_0x1ec3c7,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x52ba71,'createdAt':_0x598603['createdAt']||serverTimestamp(),'winnerUsername':_0x598603['winnerUsername'],'loserUsername':_0x598603['loserUsername']};await setDoc(doc(db,_0x4b6c1c(0x1e4),_0xed99b6),_0x4d224a),await deleteDoc(_0x3337ce),console['log'](_0x4b6c1c(0x1e6));const [_0x17bbeb,_0x5812a5]=await Promise[_0x4b6c1c(0x1d3)]([getDocs(query(collection(db,'playersD2'),where('username','==',_0x598603[_0x4b6c1c(0x1de)]))),getDocs(query(collection(db,'playersD2'),where('username','==',_0x598603['loserUsername'])))]);if(_0x17bbeb['empty']||_0x5812a5['empty'])throw new Error(_0x4b6c1c(0x1e8));const _0x35e6f0=_0x17bbeb[_0x4b6c1c(0x1d5)][0x0]['id'],_0x429e12=_0x5812a5['docs'][0x0]['id'];return await updateEloRatingsD2(_0x35e6f0,_0x429e12,_0xed99b6),console['log'](_0x4b6c1c(0x1d7)),!![];}catch(_0x518630){console[_0x4b6c1c(0x1df)]('Error\x20in\x20approveReportD2:',_0x518630);throw _0x518630;}}