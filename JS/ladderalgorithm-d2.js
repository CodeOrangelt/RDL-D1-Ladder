const a28_0x2776d4=(function(){let _0x3d0655=!![];return function(_0x29e544,_0x403439){const _0x522c04=_0x3d0655?function(){if(_0x403439){const _0x124de0=_0x403439['apply'](_0x29e544,arguments);return _0x403439=null,_0x124de0;}}:function(){};return _0x3d0655=![],_0x522c04;};}()),a28_0x3dfb7e=a28_0x2776d4(this,function(){const _0x1759b1=a28_0x1d7c,_0x329da9=function(){const _0xa7793e=a28_0x1d7c;let _0x3d0b28;try{_0x3d0b28=Function('return\x20(function()\x20'+_0xa7793e(0x1eb)+');')();}catch(_0x5ef1dd){_0x3d0b28=window;}return _0x3d0b28;},_0x184e4b=_0x329da9(),_0x110ccc=_0x184e4b['console']=_0x184e4b['console']||{},_0x275fcd=[_0x1759b1(0x1f1),_0x1759b1(0x1f5),_0x1759b1(0x202),'error','exception','table','trace'];for(let _0x5e6010=0x0;_0x5e6010<_0x275fcd[_0x1759b1(0x1fa)];_0x5e6010++){const _0x49657c=a28_0x2776d4[_0x1759b1(0x1ec)][_0x1759b1(0x1f7)]['bind'](a28_0x2776d4),_0x23a2e6=_0x275fcd[_0x5e6010],_0x315244=_0x110ccc[_0x23a2e6]||_0x49657c;_0x49657c['__proto__']=a28_0x2776d4[_0x1759b1(0x1f3)](a28_0x2776d4),_0x49657c['toString']=_0x315244[_0x1759b1(0x209)][_0x1759b1(0x1f3)](_0x315244),_0x110ccc[_0x23a2e6]=_0x49657c;}});function a28_0xb453(){const _0x31a7f7=['{}.constructor(\x22return\x20this\x22)(\x20)','constructor','D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','checkAndRecordPromotion','D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated','approvedMatchesD2','log','playersD2','bind','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','warn','data','prototype','D2\x20Report\x20data:','win','length','exists','docs','eloRating','position','round','Error\x20in\x20updateEloRatingsD2:','username','info','uid','winnerUsername','Could\x20not\x20find\x20D2\x20player\x20documents','D2\x20ELO\x20ratings\x20updated\x20successfully','update','D2\x20Match\x20moved\x20to\x20approved\x20collection','toString'];a28_0xb453=function(){return _0x31a7f7;};return a28_0xb453();}a28_0x3dfb7e();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';function a28_0x1d7c(_0x227edb,_0x3ed4a4){const _0x3dfb7e=a28_0xb453();return a28_0x1d7c=function(_0x2776d4,_0x3925b4){_0x2776d4=_0x2776d4-0x1eb;let _0xb453d2=_0x3dfb7e[_0x2776d4];return _0xb453d2;},a28_0x1d7c(_0x227edb,_0x3ed4a4);}import{promotionManager}from'./promotions.js';import a28_0x39df7f from'./firebase-idle-wrapper.js';export function calculateEloD2(_0xcc5d87,_0x54eda5,_0x9fd535=0x20){const _0x2f2203=a28_0x1d7c,_0x20b9a1=0x1/(0x1+Math['pow'](0xa,(_0x54eda5-_0xcc5d87)/0x190)),_0x265ad5=0x1/(0x1+Math['pow'](0xa,(_0xcc5d87-_0x54eda5)/0x190)),_0x294cc6=_0xcc5d87+_0x9fd535*(0x1-_0x20b9a1),_0x56f5d2=_0x54eda5+_0x9fd535*(0x0-_0x265ad5);return{'newWinnerRating':Math['round'](_0x294cc6),'newLoserRating':Math[_0x2f2203(0x1ff)](_0x56f5d2)};}export async function updateEloRatingsD2(_0x42b541,_0x48fa44,_0x4c968b){const _0x31c952=a28_0x1d7c;try{const _0x530526=writeBatch(db),_0x2a7095=doc(db,'playersD2',_0x42b541),_0x590306=doc(db,'playersD2',_0x48fa44),[_0x26b8fa,_0x24c769]=await Promise['all']([getDoc(_0x2a7095),getDoc(_0x590306)]);if(!_0x26b8fa[_0x31c952(0x1fb)]()||!_0x24c769['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x15f5ac=_0x26b8fa['data'](),_0x15a592=_0x24c769[_0x31c952(0x1f6)](),_0x521dee=_0x15f5ac['position']||Number['MAX_SAFE_INTEGER'],_0x3809da=_0x15a592[_0x31c952(0x1fe)]||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x38c8ac,newLoserRating:_0x4ab59f}=calculateEloD2(_0x15f5ac['eloRating']||0x4b0,_0x15a592['eloRating']||0x4b0);let _0x1bd2eb=_0x521dee,_0x487df5=_0x3809da;if(_0x521dee>_0x3809da){console['log']('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x1bd2eb=_0x3809da,_0x487df5=_0x3809da+0x1;const _0x1d6051=query(collection(db,'playersD2'),where('position','>',_0x3809da),where(_0x31c952(0x1fe),'<',_0x521dee)),_0x35de87=await getDocs(_0x1d6051);for(const _0x3f7dad of _0x35de87['docs']){_0x3f7dad['id']!==_0x42b541&&_0x3f7dad['id']!==_0x48fa44&&_0x530526['update'](doc(db,'playersD2',_0x3f7dad['id']),{'position':_0x3f7dad[_0x31c952(0x1f6)]()[_0x31c952(0x1fe)]+0x1});}}else console[_0x31c952(0x1f1)](_0x31c952(0x1ed));return _0x530526[_0x31c952(0x207)](_0x2a7095,{'eloRating':_0x38c8ac,'lastMatchDate':serverTimestamp(),'position':_0x1bd2eb,'lastMatchId':_0x4c968b}),_0x530526['update'](_0x590306,{'eloRating':_0x4ab59f,'lastMatchDate':serverTimestamp(),'position':_0x487df5,'lastMatchId':_0x4c968b}),await _0x530526['commit'](),console[_0x31c952(0x1f1)](_0x31c952(0x206)),await Promise['all']([recordEloChangeD2({'playerId':_0x42b541,'previousElo':_0x15f5ac['eloRating']||0x4b0,'newElo':_0x38c8ac,'opponentId':_0x48fa44,'matchResult':_0x31c952(0x1f9),'previousPosition':_0x521dee,'newPosition':_0x1bd2eb,'isPromotion':_0x1bd2eb<_0x521dee,'matchId':_0x4c968b,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x48fa44,'previousElo':_0x15a592['eloRating']||0x4b0,'newElo':_0x4ab59f,'opponentId':_0x42b541,'matchResult':'loss','previousPosition':_0x3809da,'newPosition':_0x487df5,'isDemotion':_0x487df5>_0x3809da,'matchId':_0x4c968b,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x42b541,_0x38c8ac,_0x15f5ac[_0x31c952(0x1fd)],{'source':'match-d2','matchId':_0x4c968b}),await promotionManager[_0x31c952(0x1ee)](_0x48fa44,_0x4ab59f,_0x15a592[_0x31c952(0x1fd)],{'source':'match-d2','matchId':_0x4c968b}),!![];}catch(_0x561a54){console['error'](_0x31c952(0x200),_0x561a54);throw _0x561a54;}}export async function approveReportD2(_0x106e04,_0xb18999,_0x545c41,_0x426bd5){const _0x5f2e99=a28_0x1d7c;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x106e04,'winnerScore':_0xb18999,'winnerSuicides':_0x545c41,'winnerComment':_0x426bd5});const _0x876335=auth['currentUser'];if(!_0x876335){console[_0x5f2e99(0x1f1)]('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x876335['email']);const _0x2cd532=await getDoc(doc(db,'playersD2',_0x876335[_0x5f2e99(0x203)])),_0x31c414=_0x2cd532['exists']()?_0x2cd532[_0x5f2e99(0x1f6)]()['username']:null;console['log']('Current\x20username:',_0x31c414);const _0x3294e1=doc(db,'pendingMatchesD2',_0x106e04),_0x1942c9=await getDoc(_0x3294e1);if(!_0x1942c9['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x106e04);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x17511b=_0x1942c9[_0x5f2e99(0x1f6)]();console['log'](_0x5f2e99(0x1f8),_0x17511b);if(_0x31c414!==_0x17511b['winnerUsername'])throw new Error(_0x5f2e99(0x1f4));const _0xfc164d={..._0x17511b,'winnerScore':_0xb18999,'winnerSuicides':_0x545c41,'winnerComment':_0x426bd5,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x31c414,'createdAt':_0x17511b['createdAt']||serverTimestamp(),'winnerUsername':_0x17511b[_0x5f2e99(0x204)],'loserUsername':_0x17511b['loserUsername']};await setDoc(doc(db,_0x5f2e99(0x1f0),_0x106e04),_0xfc164d),await deleteDoc(_0x3294e1),console['log'](_0x5f2e99(0x208));const [_0x4c14e0,_0xf5f170]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where(_0x5f2e99(0x201),'==',_0x17511b['winnerUsername']))),getDocs(query(collection(db,_0x5f2e99(0x1f2)),where('username','==',_0x17511b['loserUsername'])))]);if(_0x4c14e0['empty']||_0xf5f170['empty'])throw new Error(_0x5f2e99(0x205));const _0x136738=_0x4c14e0[_0x5f2e99(0x1fc)][0x0]['id'],_0x4ddfd2=_0xf5f170['docs'][0x0]['id'];return await updateEloRatingsD2(_0x136738,_0x4ddfd2,_0x106e04),console['log'](_0x5f2e99(0x1ef)),!![];}catch(_0x32346b){console['error']('Error\x20in\x20approveReportD2:',_0x32346b);throw _0x32346b;}}