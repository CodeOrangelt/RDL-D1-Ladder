const a28_0x1bf1f1=(function(){let _0x45c67e=!![];return function(_0x48d423,_0x210107){const _0xcdedf1=_0x45c67e?function(){const _0x508a29=a28_0x465e;if(_0x210107){const _0x3ff4c5=_0x210107[_0x508a29(0x1db)](_0x48d423,arguments);return _0x210107=null,_0x3ff4c5;}}:function(){};return _0x45c67e=![],_0xcdedf1;};}()),a28_0x552104=a28_0x1bf1f1(this,function(){const _0x421979=a28_0x465e,_0x2dad18=function(){const _0x32e9b7=a28_0x465e;let _0x1bdaa4;try{_0x1bdaa4=Function(_0x32e9b7(0x1dd)+_0x32e9b7(0x1f4)+');')();}catch(_0x56a5f9){_0x1bdaa4=window;}return _0x1bdaa4;},_0x335572=_0x2dad18(),_0x29e25f=_0x335572[_0x421979(0x1e8)]=_0x335572['console']||{},_0x14977b=['log','warn',_0x421979(0x1de),'error',_0x421979(0x1df),'table',_0x421979(0x1ef)];for(let _0x2ad245=0x0;_0x2ad245<_0x14977b['length'];_0x2ad245++){const _0x17a560=a28_0x1bf1f1[_0x421979(0x1dc)]['prototype']['bind'](a28_0x1bf1f1),_0x4249fe=_0x14977b[_0x2ad245],_0x1f17ac=_0x29e25f[_0x4249fe]||_0x17a560;_0x17a560['__proto__']=a28_0x1bf1f1['bind'](a28_0x1bf1f1),_0x17a560['toString']=_0x1f17ac[_0x421979(0x1e1)]['bind'](_0x1f17ac),_0x29e25f[_0x4249fe]=_0x17a560;}});function a28_0x465e(_0x12d1d0,_0xf0c71){const _0x552104=a28_0x38e5();return a28_0x465e=function(_0x1bf1f1,_0x4b5142){_0x1bf1f1=_0x1bf1f1-0x1db;let _0x38e555=_0x552104[_0x1bf1f1];return _0x38e555;},a28_0x465e(_0x12d1d0,_0xf0c71);}a28_0x552104();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a28_0x38e5(){const _0x117ff1=['apply','constructor','return\x20(function()\x20','info','exception','Could\x20not\x20find\x20D2\x20player\x20documents','toString','D2\x20ELO\x20ratings\x20updated\x20successfully','log','eloRating','exists','One\x20or\x20both\x20D2\x20players\x20not\x20found','playersD2','console','Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches','win','loserUsername','checkAndRecordPromotion','D2\x20Report\x20not\x20found\x20with\x20ID:','D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','trace','D2\x20Match\x20moved\x20to\x20approved\x20collection','match-d2','currentUser','update','{}.constructor(\x22return\x20this\x22)(\x20)','data','round','No\x20user\x20logged\x20in','üéØ\x20Awarding\x20D2\x20match\x20points\x20to\x20winner:\x20','commit','Starting\x20approveReportD2\x20function\x20with:'];a28_0x38e5=function(){return _0x117ff1;};return a28_0x38e5();}import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a28_0x3d813e from'./firebase-idle-wrapper.js';import{awardMatchPoints}from'./points-service.js';export function calculateEloD2(_0x5b0e97,_0x4a55e7,_0x583257=0x20){const _0x5358ce=a28_0x465e,_0x445468=0x1/(0x1+Math['pow'](0xa,(_0x4a55e7-_0x5b0e97)/0x190)),_0x2ebccf=0x1/(0x1+Math['pow'](0xa,(_0x5b0e97-_0x4a55e7)/0x190)),_0x5a8855=_0x5b0e97+_0x583257*(0x1-_0x445468),_0x563da5=_0x4a55e7+_0x583257*(0x0-_0x2ebccf);return{'newWinnerRating':Math[_0x5358ce(0x1f6)](_0x5a8855),'newLoserRating':Math['round'](_0x563da5)};}export async function updateEloRatingsD2(_0x1c207c,_0x1d1637,_0x47377c){const _0x464853=a28_0x465e;try{const _0x2910cc=writeBatch(db),_0x3ca216=doc(db,'playersD2',_0x1c207c),_0x6ccbec=doc(db,_0x464853(0x1e7),_0x1d1637),[_0x168be6,_0x4a2dc3]=await Promise['all']([getDoc(_0x3ca216),getDoc(_0x6ccbec)]);if(!_0x168be6[_0x464853(0x1e5)]()||!_0x4a2dc3['exists']())throw new Error(_0x464853(0x1e6));const _0x2b1c37=_0x168be6['data'](),_0xf38ae=_0x4a2dc3['data'](),_0x153c31=_0x2b1c37['position']||Number['MAX_SAFE_INTEGER'],_0x3993d4=_0xf38ae['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x203fda,newLoserRating:_0x3f7e89}=calculateEloD2(_0x2b1c37['eloRating']||0x4b0,_0xf38ae['eloRating']||0x4b0);let _0x395779=_0x153c31,_0x11edfd=_0x3993d4;if(_0x153c31>_0x3993d4){console['log'](_0x464853(0x1ee)),_0x395779=_0x3993d4,_0x11edfd=_0x3993d4+0x1;const _0x41e733=query(collection(db,_0x464853(0x1e7)),where('position','>',_0x3993d4),where('position','<',_0x153c31)),_0x1d736d=await getDocs(_0x41e733);for(const _0x50cc41 of _0x1d736d['docs']){_0x50cc41['id']!==_0x1c207c&&_0x50cc41['id']!==_0x1d1637&&_0x2910cc['update'](doc(db,'playersD2',_0x50cc41['id']),{'position':_0x50cc41['data']()['position']+0x1});}}else console['log']('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x2910cc[_0x464853(0x1f3)](_0x3ca216,{'eloRating':_0x203fda,'lastMatchDate':serverTimestamp(),'position':_0x395779,'lastMatchId':_0x47377c}),_0x2910cc['update'](_0x6ccbec,{'eloRating':_0x3f7e89,'lastMatchDate':serverTimestamp(),'position':_0x11edfd,'lastMatchId':_0x47377c}),await _0x2910cc[_0x464853(0x1f9)](),console['log'](_0x464853(0x1e2)),await Promise['all']([recordEloChangeD2({'playerId':_0x1c207c,'previousElo':_0x2b1c37['eloRating']||0x4b0,'newElo':_0x203fda,'opponentId':_0x1d1637,'matchResult':_0x464853(0x1ea),'previousPosition':_0x153c31,'newPosition':_0x395779,'isPromotion':_0x395779<_0x153c31,'matchId':_0x47377c,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x1d1637,'previousElo':_0xf38ae[_0x464853(0x1e4)]||0x4b0,'newElo':_0x3f7e89,'opponentId':_0x1c207c,'matchResult':'loss','previousPosition':_0x3993d4,'newPosition':_0x11edfd,'isDemotion':_0x11edfd>_0x3993d4,'matchId':_0x47377c,'timestamp':serverTimestamp()})]),await promotionManager[_0x464853(0x1ec)](_0x1c207c,_0x203fda,_0x2b1c37['eloRating'],{'source':'match-d2','matchId':_0x47377c}),await promotionManager['checkAndRecordPromotion'](_0x1d1637,_0x3f7e89,_0xf38ae['eloRating'],{'source':_0x464853(0x1f1),'matchId':_0x47377c}),!![];}catch(_0x5a53ae){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x5a53ae);throw _0x5a53ae;}}export async function approveReportD2(_0x2bc4e1,_0x1ac2af,_0x1c78ae,_0x25330b){const _0x12a425=a28_0x465e;try{console[_0x12a425(0x1e3)](_0x12a425(0x1fa),{'reportId':_0x2bc4e1,'winnerScore':_0x1ac2af,'winnerSuicides':_0x1c78ae,'winnerComment':_0x25330b});const _0x574110=auth[_0x12a425(0x1f2)];if(!_0x574110){console[_0x12a425(0x1e3)](_0x12a425(0x1f7));throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log']('Current\x20user:',_0x574110['email']);const _0x46452c=await getDoc(doc(db,'playersD2',_0x574110['uid'])),_0x1f688f=_0x46452c['exists']()?_0x46452c[_0x12a425(0x1f5)]()['username']:null;console['log']('Current\x20username:',_0x1f688f);const _0x5d3150=doc(db,'pendingMatchesD2',_0x2bc4e1),_0x51b5df=await getDoc(_0x5d3150);if(!_0x51b5df['exists']()){console['log'](_0x12a425(0x1ed),_0x2bc4e1);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x511b78=_0x51b5df['data']();console['log']('D2\x20Report\x20data:',_0x511b78);if(_0x1f688f!==_0x511b78['winnerUsername'])throw new Error(_0x12a425(0x1e9));const _0x481d27={..._0x511b78,'winnerScore':_0x1ac2af,'winnerSuicides':_0x1c78ae,'winnerComment':_0x25330b,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1f688f,'createdAt':_0x511b78['createdAt']||serverTimestamp(),'winnerUsername':_0x511b78['winnerUsername'],'loserUsername':_0x511b78[_0x12a425(0x1eb)]};await setDoc(doc(db,'approvedMatchesD2',_0x2bc4e1),_0x481d27),await deleteDoc(_0x5d3150),console['log'](_0x12a425(0x1f0));const [_0x10bdf7,_0x4158d7]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x511b78['winnerUsername']))),getDocs(query(collection(db,_0x12a425(0x1e7)),where('username','==',_0x511b78['loserUsername'])))]);if(_0x10bdf7['empty']||_0x4158d7['empty'])throw new Error(_0x12a425(0x1e0));const _0x48f1f2=_0x10bdf7['docs'][0x0]['id'],_0x1a905e=_0x4158d7['docs'][0x0]['id'];await updateEloRatingsD2(_0x48f1f2,_0x1a905e,_0x2bc4e1);try{console[_0x12a425(0x1e3)](_0x12a425(0x1f8)+_0x48f1f2+',\x20loser:\x20'+_0x1a905e+',\x20subgame:\x20'+(_0x511b78['subgameType']||'Standard'));const _0x491189=await awardMatchPoints(_0x48f1f2,_0x1a905e,_0x511b78['subgameType']);_0x491189?console[_0x12a425(0x1e3)]('‚úÖ\x20D2\x20Match\x20points\x20awarded\x20successfully'):console['warn']('‚ö†Ô∏è\x20D2\x20Match\x20points\x20failed\x20to\x20award,\x20but\x20match\x20approval\x20continues');}catch(_0x7cdf92){console['error']('‚ùå\x20D2\x20Points\x20award\x20error:',_0x7cdf92);}return console[_0x12a425(0x1e3)]('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x4a769c){console['error']('Error\x20in\x20approveReportD2:',_0x4a769c);throw _0x4a769c;}}