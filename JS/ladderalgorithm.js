const a30_0x45e0fa=(function(){let _0x4ad2f7=!![];return function(_0x422107,_0x42b568){const _0x173ce4=_0x4ad2f7?function(){const _0x19affe=a30_0x5142;if(_0x42b568){const _0x4aa8fc=_0x42b568[_0x19affe(0xee)](_0x422107,arguments);return _0x42b568=null,_0x4aa8fc;}}:function(){};return _0x4ad2f7=![],_0x173ce4;};}()),a30_0x3177d9=a30_0x45e0fa(this,function(){const _0x2a2060=a30_0x5142,_0xe58ae8=function(){let _0x3d917c;try{_0x3d917c=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x3abe4b){_0x3d917c=window;}return _0x3d917c;},_0x32e399=_0xe58ae8(),_0x92998f=_0x32e399[_0x2a2060(0xe3)]=_0x32e399['console']||{},_0x360456=[_0x2a2060(0xdb),_0x2a2060(0xe1),'info','error','exception',_0x2a2060(0xf5),'trace'];for(let _0x510cf0=0x0;_0x510cf0<_0x360456['length'];_0x510cf0++){const _0x501d6d=a30_0x45e0fa['constructor']['prototype']['bind'](a30_0x45e0fa),_0x48e294=_0x360456[_0x510cf0],_0x90d358=_0x92998f[_0x48e294]||_0x501d6d;_0x501d6d['__proto__']=a30_0x45e0fa['bind'](a30_0x45e0fa),_0x501d6d[_0x2a2060(0xef)]=_0x90d358['toString']['bind'](_0x90d358),_0x92998f[_0x48e294]=_0x501d6d;}});a30_0x3177d9();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';function a30_0x5142(_0x4b5375,_0x42eda){const _0x3177d9=a30_0x409b();return a30_0x5142=function(_0x45e0fa,_0x4c03cb){_0x45e0fa=_0x45e0fa-0xd6;let _0x409be4=_0x3177d9[_0x45e0fa];return _0x409be4;},a30_0x5142(_0x4b5375,_0x42eda);}function a30_0x409b(){const _0x210a03=['match','pow','data','position','eloRating','log','commit','players','catch','loserScore','totalKills','warn','subgameType','console','Error\x20approving\x20report:','wins','docs','toISOString','ELO\x20ratings\x20and\x20positions\x20updated\x20successfully','toFixed','Could\x20not\x20find\x20player\x20documents','playerStats','MAX_SAFE_INTEGER','winnerScore','apply','toString','lastUpdated','uid','Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','exists','Report\x20not\x20found','table','update','loserUsername','totalDeaths','checkAndRecordPromotion','Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:'];a30_0x409b=function(){return _0x210a03;};return a30_0x409b();}import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0xc4378e,_0x223940,_0x4fbb50=0x20){const _0x3f0fc6=a30_0x5142,_0x2d9ba5=0x1/(0x1+Math[_0x3f0fc6(0xd7)](0xa,(_0x223940-_0xc4378e)/0x190)),_0x136c6a=0x1/(0x1+Math['pow'](0xa,(_0xc4378e-_0x223940)/0x190)),_0x36d562=_0xc4378e+_0x4fbb50*(0x1-_0x2d9ba5),_0x3983ca=_0x223940+_0x4fbb50*(0x0-_0x136c6a);return{'newWinnerRating':Math['round'](_0x36d562),'newLoserRating':Math['round'](_0x3983ca)};}export function assignDefaultEloRating(_0xe0a441,_0x3490c5){const _0x2ee30e=a30_0x5142,_0x183875=0x4b0;!_0x3490c5[_0x2ee30e(0xda)]&&db['collection'](_0x2ee30e(0xdd))['doc'](_0xe0a441)['update']({'eloRating':_0x183875})['then'](()=>{console['log']('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x3490c5['username']);})[_0x2ee30e(0xde)](_0x187e59=>{console['error']('Error\x20assigning\x20default\x20ELO\x20rating:',_0x187e59);});}export async function updateEloRatings(_0xcffaf7,_0x217f8f,_0x42c491){const _0x4241aa=a30_0x5142;try{const _0x1ca455=writeBatch(db),_0xe84e15=doc(db,'players',_0xcffaf7),_0x3cb470=doc(db,'players',_0x217f8f),[_0x19f133,_0x20e642]=await Promise['all']([getDoc(_0xe84e15),getDoc(_0x3cb470)]);if(!_0x19f133['exists']()||!_0x20e642['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x376978=_0x19f133['data'](),_0x43ff0c=_0x20e642['data'](),_0x3f1239=_0x376978['position']||Number['MAX_SAFE_INTEGER'],_0x3361d9=_0x43ff0c[_0x4241aa(0xd9)]||Number[_0x4241aa(0xec)],{newWinnerRating:_0x24602d,newLoserRating:_0x387bc0}=calculateElo(_0x376978['eloRating']||0x4b0,_0x43ff0c[_0x4241aa(0xda)]||0x4b0);let _0x53713f=_0x3f1239,_0x1229d2=_0x3361d9;if(_0x3f1239>_0x3361d9){console['log']('Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x53713f=_0x3361d9,_0x1229d2=_0x3361d9+0x1;const _0x4a7e20=query(collection(db,'players'),where('position','>',_0x3361d9),where('position','<',_0x3f1239)),_0x598bc6=await getDocs(_0x4a7e20);for(const _0x30f766 of _0x598bc6['docs']){_0x30f766['id']!==_0xcffaf7&&_0x30f766['id']!==_0x217f8f&&_0x1ca455[_0x4241aa(0xf6)](doc(db,'players',_0x30f766['id']),{'position':_0x30f766['data']()[_0x4241aa(0xd9)]+0x1});}}else console[_0x4241aa(0xdb)](_0x4241aa(0xf2));const _0x3f57fd={'eloRating':_0x24602d,'lastMatchDate':serverTimestamp(),'position':_0x53713f,'lastMatchId':_0x42c491},_0x36bb93={'eloRating':_0x387bc0,'lastMatchDate':serverTimestamp(),'position':_0x1229d2,'lastMatchId':_0x42c491};return _0x1ca455['update'](_0xe84e15,_0x3f57fd),_0x1ca455['update'](_0x3cb470,_0x36bb93),await _0x1ca455[_0x4241aa(0xdc)](),console[_0x4241aa(0xdb)]('ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChange({'playerId':_0xcffaf7,'previousElo':_0x376978['eloRating']||0x4b0,'newElo':_0x24602d,'opponentId':_0x217f8f,'matchResult':'win','previousPosition':_0x3f1239,'newPosition':_0x53713f,'isPromotion':_0x53713f<_0x3f1239,'matchId':_0x42c491,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x217f8f,'previousElo':_0x43ff0c[_0x4241aa(0xda)]||0x4b0,'newElo':_0x387bc0,'opponentId':_0xcffaf7,'matchResult':'loss','previousPosition':_0x3361d9,'newPosition':_0x1229d2,'isDemotion':_0x1229d2>_0x3361d9,'matchId':_0x42c491,'timestamp':serverTimestamp()})]),await promotionManager[_0x4241aa(0xf9)](_0xcffaf7,_0x24602d,_0x376978[_0x4241aa(0xda)],{'source':_0x4241aa(0xd6),'matchId':_0x42c491}),await promotionManager['checkAndRecordPromotion'](_0x217f8f,_0x387bc0,_0x43ff0c['eloRating'],{'source':'match','matchId':_0x42c491}),console['log'](_0x4241aa(0xe8)),!![];}catch(_0x58e649){console['error']('Error\x20in\x20updateEloRatings:',_0x58e649);throw _0x58e649;}}export async function approveReport(_0x4ecf4b,_0x18484,_0x19e296,_0x2d8c7d,_0x29c400){const _0x124438=a30_0x5142;try{const _0x4a5750=doc(db,'pendingMatches',_0x4ecf4b),_0x31db26=await getDoc(_0x4a5750);if(!_0x31db26[_0x124438(0xf3)]())throw new Error(_0x124438(0xf4));const _0xc289eb=_0x31db26[_0x124438(0xd8)](),_0x51decb={..._0xc289eb,'winnerScore':_0x18484,'winnerSuicides':_0x19e296,'winnerComment':_0x2d8c7d,'winnerDemoLink':_0x29c400,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser'][_0x124438(0xf1)]};await setDoc(doc(db,'approvedMatches',_0x4ecf4b),_0x51decb),await deleteDoc(_0x4a5750),console[_0x124438(0xdb)]('Match\x20moved\x20to\x20approved\x20collection');const [_0x30a9dc,_0xe227ee]=await Promise['all']([getDocs(query(collection(db,'players'),where('username','==',_0xc289eb['winnerUsername']))),getDocs(query(collection(db,_0x124438(0xdd)),where('username','==',_0xc289eb[_0x124438(0xf7)])))]);if(_0x30a9dc['empty']||_0xe227ee['empty'])throw new Error(_0x124438(0xea));const _0x472487=_0x30a9dc[_0x124438(0xe6)][0x0]['id'],_0xc96361=_0xe227ee[_0x124438(0xe6)][0x0]['id'];await updateEloRatings(_0x472487,_0xc96361,_0x4ecf4b);try{await awardMatchPoints(_0x472487,_0xc96361,_0xc289eb[_0x124438(0xe2)]);}catch(_0x379b4a){console[_0x124438(0xe1)](_0x124438(0xfa),_0x379b4a);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x4ddf74){console['error'](_0x124438(0xe4),_0x4ddf74);throw _0x4ddf74;}}async function updatePlayerElo(_0x1b7edf,_0x192365,_0x47b12f){await setDoc(doc(db,'players',_0x1b7edf),{...playerData,'eloRating':_0x47b12f}),await checkAndRecordPromotion(_0x1b7edf,_0x47b12f,_0x192365);}async function updatePlayerStats(_0x26b472,_0x512477,_0x1e337b){const _0x4fcc99=a30_0x5142,_0x9550cf=doc(db,_0x4fcc99(0xeb),_0x26b472),_0x5c3741=await getDoc(_0x9550cf);let _0x310e20=_0x5c3741['exists']()?_0x5c3741[_0x4fcc99(0xd8)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x1e337b?(_0x310e20['wins']++,_0x310e20['totalKills']+=parseInt(_0x512477['winnerScore']||0x0),_0x310e20['totalDeaths']+=parseInt(_0x512477[_0x4fcc99(0xdf)]||0x0)):(_0x310e20['losses']++,_0x310e20[_0x4fcc99(0xe0)]+=parseInt(_0x512477[_0x4fcc99(0xdf)]||0x0),_0x310e20[_0x4fcc99(0xf8)]+=parseInt(_0x512477[_0x4fcc99(0xed)]||0x0));const _0x5e4258=_0x310e20[_0x4fcc99(0xe5)]+_0x310e20['losses'];_0x310e20['winRate']=_0x5e4258>0x0?(_0x310e20['wins']/_0x5e4258*0x64)[_0x4fcc99(0xe9)](0x1):0x0,_0x310e20[_0x4fcc99(0xf0)]=new Date()[_0x4fcc99(0xe7)](),await setDoc(_0x9550cf,_0x310e20,{'merge':!![]});}