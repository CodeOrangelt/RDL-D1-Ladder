const a29_0x59182d=(function(){let _0x5051f8=!![];return function(_0x5ea30b,_0x5cefd4){const _0x1176a1=_0x5051f8?function(){if(_0x5cefd4){const _0x6ff31c=_0x5cefd4['apply'](_0x5ea30b,arguments);return _0x5cefd4=null,_0x6ff31c;}}:function(){};return _0x5051f8=![],_0x1176a1;};}()),a29_0x5976eb=a29_0x59182d(this,function(){const _0x39aa56=a29_0x18e2;let _0x596c68;try{const _0x44d859=Function(_0x39aa56(0xd9)+_0x39aa56(0xd0)+');');_0x596c68=_0x44d859();}catch(_0x10ccd6){_0x596c68=window;}const _0x1a4e7b=_0x596c68['console']=_0x596c68['console']||{},_0x13d89c=['log','warn','info','error','exception',_0x39aa56(0xd7),_0x39aa56(0xd8)];for(let _0x4f5a87=0x0;_0x4f5a87<_0x13d89c[_0x39aa56(0xcf)];_0x4f5a87++){const _0x177a4d=a29_0x59182d['constructor']['prototype']['bind'](a29_0x59182d),_0xc2a5fa=_0x13d89c[_0x4f5a87],_0x53e2d9=_0x1a4e7b[_0xc2a5fa]||_0x177a4d;_0x177a4d[_0x39aa56(0xd1)]=a29_0x59182d['bind'](a29_0x59182d),_0x177a4d['toString']=_0x53e2d9['toString']['bind'](_0x53e2d9),_0x1a4e7b[_0xc2a5fa]=_0x177a4d;}});a29_0x5976eb();function a29_0x3209(){const _0x57850c=['eloRating','playersD3','D3\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions','Only\x20the\x20winner\x20can\x20approve\x20D3\x20matches','currentUser','round','docs','empty','MAX_SAFE_INTEGER','username','length','{}.constructor(\x22return\x20this\x22)(\x20)','__proto__','Current\x20username:','win','createdAt','exists','Current\x20user:','table','trace','return\x20(function()\x20','error','position','D3\x20Report\x20not\x20found\x20with\x20ID:','log','One\x20or\x20both\x20D3\x20players\x20not\x20found'];a29_0x3209=function(){return _0x57850c;};return a29_0x3209();}import{addDoc,updateDoc,serverTimestamp,collection,doc,getDoc,getDocs,query,where,setDoc,deleteDoc,writeBatch}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';function a29_0x18e2(_0x1745e8,_0x11023c){const _0x5976eb=a29_0x3209();return a29_0x18e2=function(_0x59182d,_0x2b003e){_0x59182d=_0x59182d-0xc5;let _0x320913=_0x5976eb[_0x59182d];return _0x320913;},a29_0x18e2(_0x1745e8,_0x11023c);}import{recordEloChangeD3}from'./elo-history-d3.js';export function calculateEloD3(_0x439a77,_0x38a0c8,_0x141921=0x20){const _0x3a8815=a29_0x18e2,_0x58f53b=0x1/(0x1+Math['pow'](0xa,(_0x38a0c8-_0x439a77)/0x190)),_0x4656c3=0x1/(0x1+Math['pow'](0xa,(_0x439a77-_0x38a0c8)/0x190)),_0x46cde5=_0x439a77+_0x141921*(0x1-_0x58f53b),_0x30d287=_0x38a0c8+_0x141921*(0x0-_0x4656c3);return{'newWinnerRating':Math[_0x3a8815(0xca)](_0x46cde5),'newLoserRating':Math['round'](_0x30d287)};}export async function updateEloRatingsD3(_0x27ad11,_0x584b0a,_0x32560c){const _0x337d64=a29_0x18e2;try{const _0x473a4a=writeBatch(db),_0x262f48=doc(db,'playersD3',_0x27ad11),_0x471c23=doc(db,_0x337d64(0xc6),_0x584b0a),[_0x37f464,_0x34af06]=await Promise['all']([getDoc(_0x262f48),getDoc(_0x471c23)]);if(!_0x37f464[_0x337d64(0xd5)]()||!_0x34af06[_0x337d64(0xd5)]())throw new Error(_0x337d64(0xde));const _0x4d2503=_0x37f464['data'](),_0x4a4352=_0x34af06['data'](),_0x3a8115=_0x4d2503['position']||Number[_0x337d64(0xcd)],_0x1ff30f=_0x4a4352['position']||Number[_0x337d64(0xcd)],{newWinnerRating:_0x1faebf,newLoserRating:_0x5a1a0c}=calculateEloD3(_0x4d2503[_0x337d64(0xc5)]||0x4b0,_0x4a4352[_0x337d64(0xc5)]||0x4b0);let _0x32723f=_0x3a8115,_0xd4c6ad=_0x1ff30f;if(_0x3a8115>_0x1ff30f){console['log']('D3\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x32723f=_0x1ff30f,_0xd4c6ad=_0x1ff30f+0x1;const _0x334e59=query(collection(db,'playersD3'),where('position','>',_0x1ff30f),where(_0x337d64(0xdb),'<',_0x3a8115)),_0x4d602c=await getDocs(_0x334e59);for(const _0x3c39d2 of _0x4d602c['docs']){_0x3c39d2['id']!==_0x27ad11&&_0x3c39d2['id']!==_0x584b0a&&_0x473a4a['update'](doc(db,'playersD3',_0x3c39d2['id']),{'position':_0x3c39d2['data']()['position']+0x1});}}else console['log'](_0x337d64(0xc7));return _0x473a4a['update'](_0x262f48,{'eloRating':_0x1faebf,'lastMatchDate':serverTimestamp(),'position':_0x32723f,'lastMatchId':_0x32560c}),_0x473a4a['update'](_0x471c23,{'eloRating':_0x5a1a0c,'lastMatchDate':serverTimestamp(),'position':_0xd4c6ad,'lastMatchId':_0x32560c}),await _0x473a4a['commit'](),console['log']('D3\x20ELO\x20ratings\x20updated\x20successfully'),await Promise['all']([recordEloChangeD3({'playerId':_0x27ad11,'previousElo':_0x4d2503['eloRating']||0x4b0,'newElo':_0x1faebf,'opponentId':_0x584b0a,'matchResult':_0x337d64(0xd3),'previousPosition':_0x3a8115,'newPosition':_0x32723f,'isPromotion':_0x32723f<_0x3a8115,'matchId':_0x32560c,'timestamp':serverTimestamp()}),recordEloChangeD3({'playerId':_0x584b0a,'previousElo':_0x4a4352['eloRating']||0x4b0,'newElo':_0x5a1a0c,'opponentId':_0x27ad11,'matchResult':'loss','previousPosition':_0x1ff30f,'newPosition':_0xd4c6ad,'isDemotion':_0xd4c6ad>_0x1ff30f,'matchId':_0x32560c,'timestamp':serverTimestamp()})]),!![];}catch(_0x5d2402){console[_0x337d64(0xda)]('Error\x20in\x20updateEloRatingsD3:',_0x5d2402);throw _0x5d2402;}}export async function approveReportD3(_0x40be3a,_0x10326f,_0x390d8e,_0xcab1f1){const _0x41476b=a29_0x18e2;try{console['log']('Starting\x20approveReportD3\x20function\x20with:',{'reportId':_0x40be3a,'winnerScore':_0x10326f,'winnerSuicides':_0x390d8e,'winnerComment':_0xcab1f1});const _0x3fa120=auth[_0x41476b(0xc9)];if(!_0x3fa120){console['log']('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D3\x20matches');}console['log'](_0x41476b(0xd6),_0x3fa120['email']);const _0x2e4fc4=await getDoc(doc(db,_0x41476b(0xc6),_0x3fa120['uid'])),_0x1b6895=_0x2e4fc4[_0x41476b(0xd5)]()?_0x2e4fc4['data']()['username']:null;console[_0x41476b(0xdd)](_0x41476b(0xd2),_0x1b6895);const _0x4747e9=doc(db,'pendingMatchesD3',_0x40be3a),_0x50fa2e=await getDoc(_0x4747e9);if(!_0x50fa2e['exists']()){console['log'](_0x41476b(0xdc),_0x40be3a);throw new Error('D3\x20match\x20report\x20not\x20found');}const _0x3c9a58=_0x50fa2e['data']();console['log']('D3\x20Report\x20data:',_0x3c9a58);if(_0x1b6895!==_0x3c9a58['winnerUsername'])throw new Error(_0x41476b(0xc8));const _0x1d2f28={..._0x3c9a58,'winnerScore':_0x10326f,'winnerSuicides':_0x390d8e,'winnerComment':_0xcab1f1,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x1b6895,'createdAt':_0x3c9a58[_0x41476b(0xd4)]||serverTimestamp(),'winnerUsername':_0x3c9a58['winnerUsername'],'loserUsername':_0x3c9a58['loserUsername']};await setDoc(doc(db,'approvedMatchesD3',_0x40be3a),_0x1d2f28),await deleteDoc(_0x4747e9),console[_0x41476b(0xdd)]('D3\x20Match\x20moved\x20to\x20approved\x20collection');const [_0xa8d5e,_0x5bec4c]=await Promise['all']([getDocs(query(collection(db,_0x41476b(0xc6)),where(_0x41476b(0xce),'==',_0x3c9a58['winnerUsername']))),getDocs(query(collection(db,'playersD3'),where(_0x41476b(0xce),'==',_0x3c9a58['loserUsername'])))]);if(_0xa8d5e['empty']||_0x5bec4c[_0x41476b(0xcc)])throw new Error('Could\x20not\x20find\x20D3\x20player\x20documents');const _0x2b1ad6=_0xa8d5e[_0x41476b(0xcb)][0x0]['id'],_0x42abf3=_0x5bec4c['docs'][0x0]['id'];return await updateEloRatingsD3(_0x2b1ad6,_0x42abf3,_0x40be3a),console['log']('D3\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x322575){console['error']('Error\x20in\x20approveReportD3:',_0x322575);throw _0x322575;}}