const a26_0x2275d5=(function(){let _0xf29fb0=!![];return function(_0xbc6ad7,_0xa2552e){const _0x1607ff=_0xf29fb0?function(){const _0x234569=a26_0x14a5;if(_0xa2552e){const _0x165977=_0xa2552e[_0x234569(0x12f)](_0xbc6ad7,arguments);return _0xa2552e=null,_0x165977;}}:function(){};return _0xf29fb0=![],_0x1607ff;};}()),a26_0x29933a=a26_0x2275d5(this,function(){const _0x358e34=a26_0x14a5;let _0x5742c5;try{const _0x370a67=Function('return\x20(function()\x20'+_0x358e34(0x12e)+');');_0x5742c5=_0x370a67();}catch(_0x1e599b){_0x5742c5=window;}const _0x5555d5=_0x5742c5[_0x358e34(0x128)]=_0x5742c5['console']||{},_0x401239=['log','warn','info','error',_0x358e34(0x12a),'table','trace'];for(let _0x15c546=0x0;_0x15c546<_0x401239[_0x358e34(0x123)];_0x15c546++){const _0x404680=a26_0x2275d5['constructor'][_0x358e34(0x126)]['bind'](a26_0x2275d5),_0x20a020=_0x401239[_0x15c546],_0x3200bd=_0x5555d5[_0x20a020]||_0x404680;_0x404680['__proto__']=a26_0x2275d5['bind'](a26_0x2275d5),_0x404680['toString']=_0x3200bd['toString']['bind'](_0x3200bd),_0x5555d5[_0x20a020]=_0x404680;}});function a26_0x222a(){const _0x56c9d4=['loserUsername','D2\x20Report\x20data:','position','match-d2','createdAt','D2\x20Match\x20moved\x20to\x20approved\x20collection','log','length','docs','Could\x20not\x20find\x20D2\x20player\x20documents','prototype','all','console','eloRating','exception','Current\x20user:','MAX_SAFE_INTEGER','playersD2','{}.constructor(\x22return\x20this\x22)(\x20)','apply','Current\x20username:','exists','update','checkAndRecordPromotion','winnerUsername','loss','D2\x20ELO\x20ratings\x20updated\x20successfully','email'];a26_0x222a=function(){return _0x56c9d4;};return a26_0x222a();}a26_0x29933a();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChangeD2}from'./elo-history-d2.js';import{promotionManager}from'./promotions.js';import a26_0x1acd1e from'./firebase-idle-wrapper.js';export function calculateEloD2(_0x1e280e,_0x5bd45e,_0x63a43d=0x20){const _0x1b5c6a=0x1/(0x1+Math['pow'](0xa,(_0x5bd45e-_0x1e280e)/0x190)),_0x4541c0=0x1/(0x1+Math['pow'](0xa,(_0x1e280e-_0x5bd45e)/0x190)),_0x563f62=_0x1e280e+_0x63a43d*(0x1-_0x1b5c6a),_0x273db2=_0x5bd45e+_0x63a43d*(0x0-_0x4541c0);return{'newWinnerRating':Math['round'](_0x563f62),'newLoserRating':Math['round'](_0x273db2)};}function a26_0x14a5(_0x3ec041,_0x1f27c2){const _0x29933a=a26_0x222a();return a26_0x14a5=function(_0x2275d5,_0x2ee264){_0x2275d5=_0x2275d5-0x11c;let _0x222afb=_0x29933a[_0x2275d5];return _0x222afb;},a26_0x14a5(_0x3ec041,_0x1f27c2);}export async function updateEloRatingsD2(_0x12e70a,_0x186a34,_0x2ad855){const _0x366d4b=a26_0x14a5;try{const _0x35918d=writeBatch(db),_0x4bb146=doc(db,_0x366d4b(0x12d),_0x12e70a),_0x53aacf=doc(db,'playersD2',_0x186a34),[_0x559f1b,_0x45c7ed]=await Promise['all']([getDoc(_0x4bb146),getDoc(_0x53aacf)]);if(!_0x559f1b[_0x366d4b(0x131)]()||!_0x45c7ed['exists']())throw new Error('One\x20or\x20both\x20D2\x20players\x20not\x20found');const _0x2bcc64=_0x559f1b['data'](),_0x59918e=_0x45c7ed['data'](),_0x9c01bd=_0x2bcc64['position']||Number['MAX_SAFE_INTEGER'],_0x2cd3fa=_0x59918e['position']||Number[_0x366d4b(0x12c)],{newWinnerRating:_0x3a9e49,newLoserRating:_0x355f04}=calculateEloD2(_0x2bcc64['eloRating']||0x4b0,_0x59918e['eloRating']||0x4b0);let _0x2ce451=_0x9c01bd,_0x5501c5=_0x2cd3fa;if(_0x9c01bd>_0x2cd3fa){console[_0x366d4b(0x122)]('D2\x20Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked'),_0x2ce451=_0x2cd3fa,_0x5501c5=_0x2cd3fa+0x1;const _0xa2ca79=query(collection(db,'playersD2'),where('position','>',_0x2cd3fa),where(_0x366d4b(0x11e),'<',_0x9c01bd)),_0x39c423=await getDocs(_0xa2ca79);for(const _0x30d274 of _0x39c423[_0x366d4b(0x124)]){_0x30d274['id']!==_0x12e70a&&_0x30d274['id']!==_0x186a34&&_0x35918d['update'](doc(db,_0x366d4b(0x12d),_0x30d274['id']),{'position':_0x30d274['data']()[_0x366d4b(0x11e)]+0x1});}}else console[_0x366d4b(0x122)]('D2\x20Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');return _0x35918d[_0x366d4b(0x132)](_0x4bb146,{'eloRating':_0x3a9e49,'lastMatchDate':serverTimestamp(),'position':_0x2ce451,'lastMatchId':_0x2ad855}),_0x35918d['update'](_0x53aacf,{'eloRating':_0x355f04,'lastMatchDate':serverTimestamp(),'position':_0x5501c5,'lastMatchId':_0x2ad855}),await _0x35918d['commit'](),console['log'](_0x366d4b(0x136)),await Promise[_0x366d4b(0x127)]([recordEloChangeD2({'playerId':_0x12e70a,'previousElo':_0x2bcc64['eloRating']||0x4b0,'newElo':_0x3a9e49,'opponentId':_0x186a34,'matchResult':'win','previousPosition':_0x9c01bd,'newPosition':_0x2ce451,'isPromotion':_0x2ce451<_0x9c01bd,'matchId':_0x2ad855,'timestamp':serverTimestamp()}),recordEloChangeD2({'playerId':_0x186a34,'previousElo':_0x59918e[_0x366d4b(0x129)]||0x4b0,'newElo':_0x355f04,'opponentId':_0x12e70a,'matchResult':_0x366d4b(0x135),'previousPosition':_0x2cd3fa,'newPosition':_0x5501c5,'isDemotion':_0x5501c5>_0x2cd3fa,'matchId':_0x2ad855,'timestamp':serverTimestamp()})]),await promotionManager[_0x366d4b(0x133)](_0x12e70a,_0x3a9e49,_0x2bcc64['eloRating'],{'source':_0x366d4b(0x11f),'matchId':_0x2ad855}),await promotionManager['checkAndRecordPromotion'](_0x186a34,_0x355f04,_0x59918e['eloRating'],{'source':'match-d2','matchId':_0x2ad855}),!![];}catch(_0x538d33){console['error']('Error\x20in\x20updateEloRatingsD2:',_0x538d33);throw _0x538d33;}}export async function approveReportD2(_0x1f9305,_0x582b10,_0x4aa48c,_0x3eb309){const _0x568f42=a26_0x14a5;try{console['log']('Starting\x20approveReportD2\x20function\x20with:',{'reportId':_0x1f9305,'winnerScore':_0x582b10,'winnerSuicides':_0x4aa48c,'winnerComment':_0x3eb309});const _0x23b25f=auth['currentUser'];if(!_0x23b25f){console[_0x568f42(0x122)]('No\x20user\x20logged\x20in');throw new Error('You\x20must\x20be\x20logged\x20in\x20to\x20approve\x20D2\x20matches');}console['log'](_0x568f42(0x12b),_0x23b25f[_0x568f42(0x137)]);const _0xfad9be=await getDoc(doc(db,'playersD2',_0x23b25f['uid'])),_0x470c19=_0xfad9be['exists']()?_0xfad9be['data']()['username']:null;console['log'](_0x568f42(0x130),_0x470c19);const _0x3016e2=doc(db,'pendingMatchesD2',_0x1f9305),_0x5d9267=await getDoc(_0x3016e2);if(!_0x5d9267['exists']()){console['log']('D2\x20Report\x20not\x20found\x20with\x20ID:',_0x1f9305);throw new Error('D2\x20match\x20report\x20not\x20found');}const _0x5a4646=_0x5d9267['data']();console['log'](_0x568f42(0x11d),_0x5a4646);if(_0x470c19!==_0x5a4646['winnerUsername'])throw new Error('Only\x20the\x20winner\x20can\x20approve\x20D2\x20matches');const _0x3ba18f={..._0x5a4646,'winnerScore':_0x582b10,'winnerSuicides':_0x4aa48c,'winnerComment':_0x3eb309,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':_0x470c19,'createdAt':_0x5a4646[_0x568f42(0x120)]||serverTimestamp(),'winnerUsername':_0x5a4646['winnerUsername'],'loserUsername':_0x5a4646['loserUsername']};await setDoc(doc(db,'approvedMatchesD2',_0x1f9305),_0x3ba18f),await deleteDoc(_0x3016e2),console[_0x568f42(0x122)](_0x568f42(0x121));const [_0x3fdf43,_0x283114]=await Promise['all']([getDocs(query(collection(db,'playersD2'),where('username','==',_0x5a4646[_0x568f42(0x134)]))),getDocs(query(collection(db,_0x568f42(0x12d)),where('username','==',_0x5a4646[_0x568f42(0x11c)])))]);if(_0x3fdf43['empty']||_0x283114['empty'])throw new Error(_0x568f42(0x125));const _0x5ea6df=_0x3fdf43[_0x568f42(0x124)][0x0]['id'],_0x48a905=_0x283114['docs'][0x0]['id'];return await updateEloRatingsD2(_0x5ea6df,_0x48a905,_0x1f9305),console['log']('D2\x20Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0xaa994d){console['error']('Error\x20in\x20approveReportD2:',_0xaa994d);throw _0xaa994d;}}