const a30_0x2bd8e2=(function(){let _0x20d5f0=!![];return function(_0x5603e0,_0xbc5220){const _0x456e5b=_0x20d5f0?function(){const _0x91e619=a30_0x214c;if(_0xbc5220){const _0x1d82bf=_0xbc5220[_0x91e619(0x134)](_0x5603e0,arguments);return _0xbc5220=null,_0x1d82bf;}}:function(){};return _0x20d5f0=![],_0x456e5b;};}()),a30_0x52f5f7=a30_0x2bd8e2(this,function(){const _0x375c68=a30_0x214c;let _0x596fb8;try{const _0x540acb=Function(_0x375c68(0x124)+_0x375c68(0x139)+');');_0x596fb8=_0x540acb();}catch(_0x234ee2){_0x596fb8=window;}const _0x3ae72d=_0x596fb8[_0x375c68(0x12f)]=_0x596fb8[_0x375c68(0x12f)]||{},_0x2ec258=['log',_0x375c68(0x13b),_0x375c68(0x12c),'error','exception',_0x375c68(0x13e),'trace'];for(let _0x1eda25=0x0;_0x1eda25<_0x2ec258['length'];_0x1eda25++){const _0x3faca1=a30_0x2bd8e2['constructor']['prototype']['bind'](a30_0x2bd8e2),_0x150db3=_0x2ec258[_0x1eda25],_0x41c107=_0x3ae72d[_0x150db3]||_0x3faca1;_0x3faca1['__proto__']=a30_0x2bd8e2['bind'](a30_0x2bd8e2),_0x3faca1['toString']=_0x41c107[_0x375c68(0x122)]['bind'](_0x41c107),_0x3ae72d[_0x150db3]=_0x3faca1;}});function a30_0x214c(_0x4b01da,_0x1be291){const _0x52f5f7=a30_0x4c32();return a30_0x214c=function(_0x2bd8e2,_0x18ccfd){_0x2bd8e2=_0x2bd8e2-0x120;let _0x4c32a7=_0x52f5f7[_0x2bd8e2];return _0x4c32a7;},a30_0x214c(_0x4b01da,_0x1be291);}a30_0x52f5f7();import{collection,doc,getDoc,getDocs,updateDoc,setDoc,deleteDoc,writeBatch,query,where,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';import{db,auth}from'./firebase-config.js';import{recordEloChange}from'./elo-history.js';import{promotionManager,checkAndRecordPromotion}from'./promotions.js';import{isAdmin}from'./admin-check.js';export function calculateElo(_0x2a2bea,_0x5eaea4,_0x4c9296=0x20){const _0x2b0989=a30_0x214c,_0x3226ff=0x1/(0x1+Math[_0x2b0989(0x123)](0xa,(_0x5eaea4-_0x2a2bea)/0x190)),_0x17cf14=0x1/(0x1+Math['pow'](0xa,(_0x2a2bea-_0x5eaea4)/0x190)),_0x57d261=_0x2a2bea+_0x4c9296*(0x1-_0x3226ff),_0xa4618d=_0x5eaea4+_0x4c9296*(0x0-_0x17cf14);return{'newWinnerRating':Math['round'](_0x57d261),'newLoserRating':Math['round'](_0xa4618d)};}function a30_0x4c32(){const _0x14c44a=['players','position','toString','pow','return\x20(function()\x20','Error\x20approving\x20report:','winnerUsername','log','all','error','then','data','info','toISOString','empty','console','win','exists','winnerScore','Error\x20in\x20updateEloRatings:','apply','Error\x20assigning\x20default\x20ELO\x20rating:','docs','match','Match\x20moved\x20to\x20approved\x20collection','{}.constructor(\x22return\x20this\x22)(\x20)','Position\x20swap\x20needed\x20-\x20winner\x20was\x20lower\x20ranked','warn','playerStats','totalDeaths','table','eloRating'];a30_0x4c32=function(){return _0x14c44a;};return a30_0x4c32();}export function assignDefaultEloRating(_0xd6b877,_0x3c40be){const _0x4c5116=a30_0x214c,_0x53343d=0x4b0;!_0x3c40be[_0x4c5116(0x13f)]&&db['collection']('players')['doc'](_0xd6b877)['update']({'eloRating':_0x53343d})[_0x4c5116(0x12a)](()=>{const _0x5e451b=_0x4c5116;console[_0x5e451b(0x127)]('Assigned\x20default\x20ELO\x20rating\x20to\x20player\x20'+_0x3c40be['username']);})['catch'](_0x4e043=>{const _0x21d94e=_0x4c5116;console[_0x21d94e(0x129)](_0x21d94e(0x135),_0x4e043);});}export async function updateEloRatings(_0x1250e0,_0x2f0852,_0x5183e4){const _0x558087=a30_0x214c;try{const _0x118acb=writeBatch(db),_0x4ca7fd=doc(db,_0x558087(0x120),_0x1250e0),_0xc4a9ee=doc(db,'players',_0x2f0852),[_0x34acf3,_0xd17f15]=await Promise['all']([getDoc(_0x4ca7fd),getDoc(_0xc4a9ee)]);if(!_0x34acf3['exists']()||!_0xd17f15['exists']())throw new Error('One\x20or\x20both\x20players\x20not\x20found');const _0x4eb36f=_0x34acf3[_0x558087(0x12b)](),_0x331a16=_0xd17f15[_0x558087(0x12b)](),_0x50db21=_0x4eb36f[_0x558087(0x121)]||Number['MAX_SAFE_INTEGER'],_0x3cdacb=_0x331a16['position']||Number['MAX_SAFE_INTEGER'],{newWinnerRating:_0x54bfb3,newLoserRating:_0x1c83ca}=calculateElo(_0x4eb36f['eloRating']||0x4b0,_0x331a16['eloRating']||0x4b0);let _0x3720b7=_0x50db21,_0x43cf1e=_0x3cdacb;if(_0x50db21>_0x3cdacb){console[_0x558087(0x127)](_0x558087(0x13a)),_0x3720b7=_0x3cdacb,_0x43cf1e=_0x3cdacb+0x1;const _0x6217d0=query(collection(db,'players'),where('position','>',_0x3cdacb),where('position','<',_0x50db21)),_0x4220f4=await getDocs(_0x6217d0);for(const _0x282202 of _0x4220f4[_0x558087(0x136)]){_0x282202['id']!==_0x1250e0&&_0x282202['id']!==_0x2f0852&&_0x118acb['update'](doc(db,_0x558087(0x120),_0x282202['id']),{'position':_0x282202[_0x558087(0x12b)]()['position']+0x1});}}else console['log']('Winner\x20already\x20ranked\x20higher\x20-\x20keeping\x20positions');const _0x39f23d={'eloRating':_0x54bfb3,'lastMatchDate':serverTimestamp(),'position':_0x3720b7,'lastMatchId':_0x5183e4},_0x2e2053={'eloRating':_0x1c83ca,'lastMatchDate':serverTimestamp(),'position':_0x43cf1e,'lastMatchId':_0x5183e4};return _0x118acb['update'](_0x4ca7fd,_0x39f23d),_0x118acb['update'](_0xc4a9ee,_0x2e2053),await _0x118acb['commit'](),console['log']('ELO\x20ratings\x20updated\x20successfully'),await Promise[_0x558087(0x128)]([recordEloChange({'playerId':_0x1250e0,'previousElo':_0x4eb36f['eloRating']||0x4b0,'newElo':_0x54bfb3,'opponentId':_0x2f0852,'matchResult':_0x558087(0x130),'previousPosition':_0x50db21,'newPosition':_0x3720b7,'isPromotion':_0x3720b7<_0x50db21,'matchId':_0x5183e4,'timestamp':serverTimestamp()}),recordEloChange({'playerId':_0x2f0852,'previousElo':_0x331a16['eloRating']||0x4b0,'newElo':_0x1c83ca,'opponentId':_0x1250e0,'matchResult':'loss','previousPosition':_0x3cdacb,'newPosition':_0x43cf1e,'isDemotion':_0x43cf1e>_0x3cdacb,'matchId':_0x5183e4,'timestamp':serverTimestamp()})]),await promotionManager['checkAndRecordPromotion'](_0x1250e0,_0x54bfb3,_0x4eb36f['eloRating'],{'source':'match','matchId':_0x5183e4}),await promotionManager['checkAndRecordPromotion'](_0x2f0852,_0x1c83ca,_0x331a16['eloRating'],{'source':_0x558087(0x137),'matchId':_0x5183e4}),console[_0x558087(0x127)]('ELO\x20ratings\x20and\x20positions\x20updated\x20successfully'),!![];}catch(_0x4b90a0){console[_0x558087(0x129)](_0x558087(0x133),_0x4b90a0);throw _0x4b90a0;}}export async function approveReport(_0x11be8e,_0x435762,_0x59933f,_0x3738a7,_0x5575d6){const _0x5e8035=a30_0x214c;try{const _0x4c6c12=doc(db,'pendingMatches',_0x11be8e),_0x4e0ed3=await getDoc(_0x4c6c12);if(!_0x4e0ed3[_0x5e8035(0x131)]())throw new Error('Report\x20not\x20found');const _0xeb1eaa=_0x4e0ed3['data'](),_0x104537={..._0xeb1eaa,'winnerScore':_0x435762,'winnerSuicides':_0x59933f,'winnerComment':_0x3738a7,'winnerDemoLink':_0x5575d6,'approved':!![],'approvedAt':serverTimestamp(),'approvedBy':auth['currentUser']['uid']};await setDoc(doc(db,'approvedMatches',_0x11be8e),_0x104537),await deleteDoc(_0x4c6c12),console[_0x5e8035(0x127)](_0x5e8035(0x138));const [_0x3ead67,_0x10071b]=await Promise[_0x5e8035(0x128)]([getDocs(query(collection(db,'players'),where('username','==',_0xeb1eaa[_0x5e8035(0x126)]))),getDocs(query(collection(db,'players'),where('username','==',_0xeb1eaa['loserUsername'])))]);if(_0x3ead67[_0x5e8035(0x12e)]||_0x10071b[_0x5e8035(0x12e)])throw new Error('Could\x20not\x20find\x20player\x20documents');const _0x2e469e=_0x3ead67[_0x5e8035(0x136)][0x0]['id'],_0x4ec38c=_0x10071b[_0x5e8035(0x136)][0x0]['id'];await updateEloRatings(_0x2e469e,_0x4ec38c,_0x11be8e);try{await awardMatchPoints(_0x2e469e,_0x4ec38c,_0xeb1eaa['subgameType']);}catch(_0x22d478){console['warn']('Points\x20award\x20failed,\x20but\x20match\x20approval\x20continues:',_0x22d478);}return console['log']('Match\x20successfully\x20approved\x20and\x20ELO\x20updated'),!![];}catch(_0x29b0b9){console[_0x5e8035(0x129)](_0x5e8035(0x125),_0x29b0b9);throw _0x29b0b9;}}async function updatePlayerElo(_0x37a960,_0x17d889,_0x4f889c){const _0x3ce5ff=a30_0x214c;await setDoc(doc(db,_0x3ce5ff(0x120),_0x37a960),{...playerData,'eloRating':_0x4f889c}),await checkAndRecordPromotion(_0x37a960,_0x4f889c,_0x17d889);}async function updatePlayerStats(_0x31aa8c,_0x23f1f7,_0x51ac04){const _0x5bd29c=a30_0x214c,_0x513a57=doc(db,_0x5bd29c(0x13c),_0x31aa8c),_0x3cff0b=await getDoc(_0x513a57);let _0x2b3b5c=_0x3cff0b[_0x5bd29c(0x131)]()?_0x3cff0b[_0x5bd29c(0x12b)]():{'wins':0x0,'losses':0x0,'totalKills':0x0,'totalDeaths':0x0,'winRate':0x0};_0x51ac04?(_0x2b3b5c['wins']++,_0x2b3b5c['totalKills']+=parseInt(_0x23f1f7['winnerScore']||0x0),_0x2b3b5c['totalDeaths']+=parseInt(_0x23f1f7['loserScore']||0x0)):(_0x2b3b5c['losses']++,_0x2b3b5c['totalKills']+=parseInt(_0x23f1f7['loserScore']||0x0),_0x2b3b5c[_0x5bd29c(0x13d)]+=parseInt(_0x23f1f7[_0x5bd29c(0x132)]||0x0));const _0x8513ea=_0x2b3b5c['wins']+_0x2b3b5c['losses'];_0x2b3b5c['winRate']=_0x8513ea>0x0?(_0x2b3b5c['wins']/_0x8513ea*0x64)['toFixed'](0x1):0x0,_0x2b3b5c['lastUpdated']=new Date()[_0x5bd29c(0x12d)](),await setDoc(_0x513a57,_0x2b3b5c,{'merge':!![]});}